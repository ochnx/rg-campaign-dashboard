<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Run & Gun ‚Äî Reporting Dashboard</title>
  <link rel="icon" type="image/png" href="../assets/rg-logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fb;
      --bg-card: #ffffff;
      --bg-card-hover: #f5f6f8;
      --bg-input: #f5f6f8;
      --border: #e8eaed;
      --border-focus: #e7352e;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --text-muted: #9ca3af;
      --accent: #e7352e;
      --accent-light: #ef5350;
      --accent-dark: #c42d27;
      --accent-bg: rgba(231, 53, 46, 0.06);
      --green: #16a34a;
      --green-bg: rgba(22, 163, 74, 0.08);
      --red: #dc2626;
      --red-bg: rgba(220, 38, 38, 0.08);
      --blue: #2563eb;
      --orange: #ea580c;
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.03), 0 1px 3px rgba(0,0,0,0.02);
      --shadow: 0 2px 4px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.06), 0 2px 6px rgba(0,0,0,0.03);
      --shadow-lg: 0 12px 40px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
      --shadow-hover: 0 8px 24px rgba(0,0,0,0.07), 0 2px 8px rgba(0,0,0,0.04);
      --transition: 200ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
      --transition-fast: 150ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    ::selection { background: rgba(231, 53, 46, 0.12); color: inherit; }

    body {
      font-family: 'Inter', -apple-system, system-ui, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* ===== LOGIN SCREEN ===== */
    .login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
      background: #f8f9fb;
      background-image: 
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(231, 53, 46, 0.04), transparent),
        radial-gradient(circle at 20% 80%, rgba(0,0,0,0.015), transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(0,0,0,0.01), transparent 50%);
    }

    .login-card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 52px 44px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.06), 0 8px 20px rgba(0,0,0,0.03), 0 0 0 1px rgba(0,0,0,0.04);
      border: none;
      text-align: center;
      animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .login-logo {
      width: 60px;
      height: 60px;
      border-radius: var(--radius);
      object-fit: cover;
      margin-bottom: 28px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    .login-title {
      font-size: 24px;
      font-weight: 800;
      letter-spacing: -0.04em;
      margin-bottom: 8px;
    }

    .login-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 36px;
      line-height: 1.6;
    }

    .login-input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .login-input {
      width: 100%;
      padding: 15px 18px;
      background: var(--bg-input);
      border: 1.5px solid transparent;
      border-radius: var(--radius);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 15px;
      transition: all var(--transition);
      text-align: center;
      letter-spacing: 0.06em;
    }

    .login-input:hover {
      border-color: var(--border);
    }

    .login-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--bg-card);
      box-shadow: 0 0 0 3px rgba(231, 53, 46, 0.08), 0 1px 2px rgba(0,0,0,0.04);
    }

    .login-input::placeholder { color: var(--text-muted); letter-spacing: normal; }

    .login-btn {
      width: 100%;
      padding: 15px 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all var(--transition);
      box-shadow: 0 1px 3px rgba(231, 53, 46, 0.2), 0 1px 2px rgba(0,0,0,0.06);
    }

    .login-btn:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(231, 53, 46, 0.25), 0 2px 6px rgba(0,0,0,0.06); }
    .login-btn:active { transform: translateY(0) scale(0.98); box-shadow: 0 1px 2px rgba(231, 53, 46, 0.15); }
    .login-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

    .login-error {
      margin-top: 16px;
      padding: 12px 16px;
      background: var(--red-bg);
      color: var(--red);
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      display: none;
      border: 1px solid rgba(220, 38, 38, 0.1);
    }

    .login-error.show { display: block; animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97); }

    .login-footer {
      margin-top: 36px;
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.02em;
    }

    /* ===== DASHBOARD ===== */
    .dashboard { display: none; min-height: 100vh; }
    .dashboard.active { display: block; }

    /* Top Nav */
    .topnav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(16px) saturate(180%);
      -webkit-backdrop-filter: blur(16px) saturate(180%);
      border-bottom: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      padding: 0 32px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 1000;
    }

    .topnav-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .topnav-logo {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      object-fit: cover;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .topnav-divider {
      width: 1px;
      height: 22px;
      background: rgba(0,0,0,0.08);
    }

    .topnav-client {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }

    .topnav-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 9px 16px;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
      border: none;
      text-decoration: none;
      white-space: nowrap;
      user-select: none;
    }

    .btn:active { transform: scale(0.97); }

    .btn-primary { background: var(--accent); color: white; box-shadow: 0 1px 3px rgba(231, 53, 46, 0.2); }
    .btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(231, 53, 46, 0.2); }
    .btn-primary:active { transform: translateY(0) scale(0.97); box-shadow: 0 1px 2px rgba(231, 53, 46, 0.15); }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }
    .btn-secondary:hover { background: var(--bg-card); border-color: #d1d5db; box-shadow: var(--shadow); transform: translateY(-1px); }
    .btn-secondary:active { transform: translateY(0) scale(0.97); box-shadow: none; }

    .btn-ghost { background: transparent; color: var(--text-secondary); }
    .btn-ghost:hover { background: var(--bg-input); color: var(--text-primary); }
    .btn-ghost:active { transform: scale(0.97); background: var(--border); }

    /* Filter bar */
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 32px;
      padding-top: 78px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      background: var(--bg-card);
    }

    .filter-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .filter-select {
      padding: 8px 32px 8px 12px;
      background: var(--bg-input);
      border: 1.5px solid transparent;
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      transition: all var(--transition);
    }

    .filter-select:hover {
      border-color: var(--border);
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(231, 53, 46, 0.06);
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 36px 32px 48px;
    }

    /* KPI Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 16px;
      margin-bottom: 48px;
    }

    .kpi-card {
      background: var(--bg-card);
      border: 1px solid rgba(0,0,0,0.05);
      border-radius: var(--radius);
      padding: 22px 20px;
      transition: all var(--transition);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 3px;
      height: 100%;
      background: var(--accent);
      opacity: 0;
      transition: opacity var(--transition);
      border-radius: 0 2px 2px 0;
    }

    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
      border-color: transparent;
    }

    .kpi-card:hover::before { opacity: 1; }

    .kpi-icon {
      font-size: 18px;
      margin-bottom: 12px;
    }

    .kpi-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.04em;
      line-height: 1;
      font-variant-numeric: tabular-nums;
    }

    .kpi-unit {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-left: 2px;
    }

    /* Section */
    .section { margin-bottom: 64px; }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }

    /* Card */
    .card {
      background: var(--bg-card);
      border: 1px solid rgba(0,0,0,0.05);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: box-shadow var(--transition), transform var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow-md);
    }

    .card-header {
      padding: 24px 24px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0,0,0,0.01);
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }

    .card-body { padding: 24px; }

    /* Chart */
    .chart-container {
      position: relative;
      width: 100%;
      height: 320px;
    }

    /* Campaign Table */
    .campaign-table {
      width: 100%;
      border-collapse: collapse;
    }

    .campaign-table th {
      text-align: left;
      padding: 14px 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(0,0,0,0.06);
      background: var(--bg-secondary);
    }

    .campaign-table th.sortable { cursor: pointer; user-select: none; transition: color var(--transition-fast); }
    .campaign-table th.sortable:hover { color: var(--text-primary); }
    .campaign-table th .sort-icon { margin-left: 4px; opacity: 0.4; transition: opacity var(--transition-fast); }
    .campaign-table th.sort-active .sort-icon { opacity: 1; color: var(--accent); }

    .campaign-table td {
      padding: 18px 20px;
      font-size: 14px;
      border-bottom: 1px solid rgba(0,0,0,0.04);
      vertical-align: middle;
    }

    .campaign-table tbody tr {
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast);
    }

    .campaign-table tbody tr:nth-child(even) { background: rgba(0,0,0,0.01); }
    .campaign-table tbody tr:hover { background: rgba(0,0,0,0.025); }
    .campaign-table tbody tr:active { transform: scale(0.998); }
    .campaign-table tbody tr:last-child td { border-bottom: none; }

    .campaign-name {
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.01em;
    }

    .campaign-address {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 11px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .badge-active { background: var(--green-bg); color: var(--green); }
    .badge-paused { background: rgba(234, 88, 12, 0.08); color: var(--orange); }
    .badge-completed { background: rgba(37, 99, 235, 0.08); color: var(--blue); }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .value-eur { font-variant-numeric: tabular-nums; }

    /* Campaign Detail Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 200;
      justify-content: center;
      align-items: flex-start;
      padding: 48px 24px;
      overflow-y: auto;
    }

    .modal-overlay.show {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    .modal {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 860px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.06), 0 0 0 1px rgba(0,0,0,0.04);
      border: none;
      animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .modal-header {
      padding: 24px 28px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -0.03em;
    }

    .modal-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 3px;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 20px;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .modal-close:hover { background: var(--bg-input); color: var(--text-primary); }
    .modal-close:active { transform: scale(0.92); }

    .modal-body { padding: 28px; }
    .modal-body .card { box-shadow: var(--shadow-sm); }

    /* Property Info Grid */
    .prop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 18px;
      margin-bottom: 28px;
      padding: 22px;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      border: 1px solid rgba(0,0,0,0.03);
    }

    .prop-item {}

    .prop-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .prop-value {
      font-size: 15px;
      font-weight: 600;
    }

    /* Insights */
    .insights {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 24px;
    }

    .insight-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 14px 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
      transition: background var(--transition-fast);
    }

    .insight-item:hover { background: rgba(0,0,0,0.03); }

    .insight-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }

    /* Creative Ranking Table */
    .creative-ranking {
      margin-top: 24px;
    }

    .creative-ranking-table {
      width: 100%;
      border-collapse: collapse;
    }

    .creative-ranking-table th {
      text-align: left;
      padding: 12px 14px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      border-bottom: 2px solid rgba(0,0,0,0.06);
      background: var(--bg-secondary);
    }

    .creative-ranking-table th:last-child,
    .creative-ranking-table td:last-child { text-align: right; }
    .creative-ranking-table th:nth-child(3),
    .creative-ranking-table td:nth-child(3),
    .creative-ranking-table th:nth-child(4),
    .creative-ranking-table td:nth-child(4) { text-align: right; }

    .creative-ranking-table td {
      padding: 14px 14px;
      font-size: 13px;
      border-bottom: 1px solid rgba(0,0,0,0.04);
      vertical-align: middle;
    }

    .creative-ranking-table tbody tr { transition: background var(--transition-fast); }
    .creative-ranking-table tbody tr:hover { background: rgba(0,0,0,0.015); }
    .creative-ranking-table tbody tr:last-child td { border-bottom: none; }

    .creative-rank {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      font-size: 12px;
      font-weight: 800;
    }

    .creative-rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #78350f; }
    .creative-rank-2 { background: linear-gradient(135deg, #d1d5db, #9ca3af); color: #374151; }
    .creative-rank-3 { background: linear-gradient(135deg, #fdba74, #f97316); color: #7c2d12; }
    .creative-rank-default { background: var(--bg-secondary); color: var(--text-muted); border: 1px solid var(--border); }

    .creative-type-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .creative-score-bar {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .creative-score-track {
      flex: 1;
      height: 5px;
      background: rgba(0,0,0,0.04);
      border-radius: 3px;
      overflow: hidden;
      min-width: 60px;
    }

    .creative-score-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .creative-score-value {
      font-size: 13px;
      font-weight: 800;
      min-width: 32px;
      text-align: right;
    }

    /* Benchmark Insights */
    .benchmark-insights {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 24px;
    }

    .benchmark-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px 18px;
      background: linear-gradient(135deg, rgba(22, 163, 74, 0.03), rgba(22, 163, 74, 0.06));
      border-left: 3px solid var(--green);
      border-radius: var(--radius-sm);
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
      transition: all var(--transition-fast);
    }

    .benchmark-item:hover {
      background: linear-gradient(135deg, rgba(22, 163, 74, 0.05), rgba(22, 163, 74, 0.09));
    }

    .benchmark-item-neutral {
      background: var(--bg-secondary);
      border-left-color: var(--border);
    }
    
    .benchmark-item-neutral:hover {
      background: rgba(0,0,0,0.03);
    }

    .benchmark-icon { font-size: 18px; flex-shrink: 0; margin-top: 0px; }

    .benchmark-text strong {
      color: var(--text-primary);
    }

    /* Loading */
    .loading-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      flex-direction: column;
      gap: 16px;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 2.5px solid rgba(0,0,0,0.06);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite;
    }

    .loading-text {
      font-size: 14px;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 24px;
      color: var(--text-muted);
    }

    .empty-state-icon { font-size: 40px; margin-bottom: 16px; }
    .empty-state-title { font-size: 16px; font-weight: 700; color: var(--text-secondary); margin-bottom: 6px; }
    .empty-state-text { font-size: 13px; }

    /* PDF */
    .pdf-only { display: none; }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(24px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes shake { 0%,100% { transform: translateX(0); } 20%,60% { transform: translateX(-5px); } 40%,80% { transform: translateX(5px); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes countUp { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    /* Responsive */
    @media (max-width: 1100px) {
      .kpi-grid { grid-template-columns: repeat(3, 1fr); }
    }

    @media (max-width: 768px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .container { padding: 20px 16px; }
      .topnav { padding: 0 16px; }
      .filter-bar { padding: 12px 16px; flex-wrap: wrap; }
      .campaign-table { font-size: 13px; }
      .campaign-table th, .campaign-table td { padding: 12px; }
      .topnav-client { display: none; }
      .modal { margin: 16px; }
      .modal-body { padding: 20px; }
      .prop-grid { grid-template-columns: repeat(2, 1fr); }
      .btn span.btn-label { display: none; }
    }

    @media (max-width: 480px) {
      .kpi-grid { grid-template-columns: 1fr; }
      .kpi-value { font-size: 24px; }
      .login-card { padding: 36px 28px; }
    }
  </style>
</head>
<body>

<!-- ===== LOGIN SCREEN ===== -->
<div id="loginScreen" class="login-screen">
  <div class="login-card">
    <img src="../assets/rg-logo.png" class="login-logo" alt="Run & Gun">
    <h1 class="login-title">Reporting Dashboard</h1>
    <p class="login-subtitle">Zugang zum Kampagnen-Reporting.<br>Bitte geben Sie Ihren Zugangscode ein.</p>
    <div class="login-input-group">
      <input type="text" id="tokenInput" class="login-input" placeholder="Zugangscode" autocomplete="off" spellcheck="false">
      <button id="loginBtn" class="login-btn" onclick="attemptLogin()">Zugang</button>
    </div>
    <div id="loginError" class="login-error"></div>
    <p class="login-footer">Powered by Run & Gun</p>
  </div>
</div>

<!-- ===== LOADING ===== -->
<div id="loadingScreen" class="loading-screen" style="display:none">
  <div class="spinner"></div>
  <div class="loading-text">Dashboard wird geladen‚Ä¶</div>
</div>

<!-- ===== DASHBOARD ===== -->
<div id="dashboard" class="dashboard">

  <!-- Top Nav -->
  <nav class="topnav">
    <div class="topnav-left">
      <img src="../assets/rg-logo.png" class="topnav-logo" alt="R&G">
      <div class="topnav-divider"></div>
      <span id="navClientName" class="topnav-client"></span>
    </div>
    <div class="topnav-right">
      <button class="btn btn-secondary" onclick="exportPDF()">
        üìÑ <span class="btn-label">Report exportieren</span>
      </button>
      <button class="btn btn-ghost" onclick="logout()" title="Abmelden">
        ‚Ü© <span class="btn-label">Abmelden</span>
      </button>
    </div>
  </nav>

  <!-- Filter Bar -->
  <div class="filter-bar">
    <span class="filter-label">Zeitraum</span>
    <select id="periodFilter" class="filter-select" onchange="applyFilter()">
      <option value="all">Gesamt</option>
    </select>
  </div>

  <!-- Main Content -->
  <div class="container" id="dashboardContent">

    <!-- KPI Row -->
    <div class="kpi-grid" id="kpiGrid">
      <div class="kpi-card">
        <div class="kpi-icon">üí∞</div>
        <div class="kpi-label">Gesamtausgaben</div>
        <div class="kpi-value" id="kpiSpend">‚Äî</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üë•</div>
        <div class="kpi-label">Leads generiert</div>
        <div class="kpi-value" id="kpiLeads">‚Äî</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üìä</div>
        <div class="kpi-label">√ò CPL</div>
        <div class="kpi-value" id="kpiCPL">‚Äî</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üëÅÔ∏è</div>
        <div class="kpi-label">Impressions</div>
        <div class="kpi-value" id="kpiImpressions">‚Äî</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üñ±Ô∏è</div>
        <div class="kpi-label">Klicks</div>
        <div class="kpi-value" id="kpiClicks">‚Äî</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üìà</div>
        <div class="kpi-label">√ò CTR</div>
        <div class="kpi-value" id="kpiCTR">‚Äî</div>
      </div>
    </div>

    <!-- Trend Chart -->
    <div class="section">
      <div class="card">
        <div class="card-header">
          <span class="card-title">W√∂chentlicher Verlauf</span>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Campaigns Table -->
    <div class="section">
      <div class="card">
        <div class="card-header">
          <span class="card-title" id="campaignsTitle">Kampagnen</span>
        </div>
        <div style="overflow-x:auto">
          <table class="campaign-table" id="campaignTable">
            <thead>
              <tr>
                <th class="sortable" data-sort="name" onclick="sortTable('name')">Objekt <span class="sort-icon">‚Üï</span></th>
                <th>Status</th>
                <th class="sortable" data-sort="period" onclick="sortTable('period')">Zeitraum <span class="sort-icon">‚Üï</span></th>
                <th class="sortable" data-sort="spend" onclick="sortTable('spend')">Ausgaben <span class="sort-icon">‚Üï</span></th>
                <th class="sortable" data-sort="leads" onclick="sortTable('leads')">Leads <span class="sort-icon">‚Üï</span></th>
                <th class="sortable" data-sort="cpl" onclick="sortTable('cpl')">CPL <span class="sort-icon">‚Üï</span></th>
              </tr>
            </thead>
            <tbody id="campaignTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Benchmark Insights (main page) -->
    <div class="section" id="mainBenchmarkSection" style="display:none">
      <div class="card">
        <div class="card-header">
          <span class="card-title">üìä Performance Insights</span>
        </div>
        <div class="card-body">
          <div class="benchmark-insights" id="mainBenchmarkInsights"></div>
        </div>
      </div>
    </div>

    <!-- Creative Performance (main page, cross-campaign) -->
    <div class="section" id="mainCreativeSection" style="display:none">
      <div class="card">
        <div class="card-header">
          <span class="card-title">üèÜ Creative Performance</span>
        </div>
        <div class="card-body">
          <div class="creative-ranking" id="mainCreativeRanking"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ===== CAMPAIGN DETAIL MODAL ===== -->
<div id="detailModal" class="modal-overlay" onclick="if(event.target===this)closeDetail()">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="detailTitle"></div>
        <div class="modal-subtitle" id="detailSubtitle"></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button class="btn btn-secondary" id="campaignPdfBtn" onclick="exportCampaignPDF()" style="font-size:12px;padding:7px 14px">üìÑ PDF Export</button>
        <button class="modal-close" onclick="closeDetail()">‚úï</button>
      </div>
    </div>
    <div class="modal-body" id="detailBody">
      <!-- Daily Chart -->
      <div class="card" style="margin-bottom:24px">
        <div class="card-header">
          <span class="card-title">Tagesverlauf</span>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height:260px">
            <canvas id="detailChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Benchmark Insights (campaign detail) -->
      <div id="detailBenchmarkSection" style="display:none">
        <h3 style="font-size:15px;font-weight:700;margin-bottom:12px">üìä Performance Insights</h3>
        <div class="benchmark-insights" id="detailBenchmarkInsights"></div>
      </div>

      <!-- Creative Performance (campaign detail) -->
      <div id="creativeSection" style="margin-top:24px">
        <h3 style="font-size:15px;font-weight:700;margin-bottom:12px">üèÜ Creative Performance</h3>
        <div class="creative-ranking" id="creativeRanking"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================
// CONFIG
// ============================================
const SB_URL = 'https://lvhxabadywdqeepymwdm.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2aHhhYmFkeXdkcWVlcHltd2RtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTUyMjM3NSwiZXhwIjoyMDg1MDk4Mzc1fQ.3BWQG5yeG8nshvukSi3YksxUbg273tJDiZnU9fAlzY0';
const SB_HEADERS = {
  'apikey': SB_KEY,
  'Authorization': `Bearer ${SB_KEY}`,
  'Content-Type': 'application/json'
};

// ============================================
// STATE
// ============================================
let clientData = null;    // { id, name, brand, logo_url, primary_color }
let campaigns = [];       // enriched campaign objects
let allMetrics = [];      // all campaign_daily_metrics
let allCreatives = [];    // creatives with metrics
let trendChart = null;
let detailChartInstance = null;
let currentSort = { field: 'spend', dir: 'desc' };
let currentFilter = 'all'; // 'all' or 'YYYY-MM'
let currentDetailCampaignId = null;
let benchmarkData = null;  // { avgCPL, avgCTR, avgLeads, allCPLs: [] }

// ============================================
// SUPABASE REST
// ============================================
async function sbGet(table, query = '') {
  const res = await fetch(`${SB_URL}/rest/v1/${table}?${query}`, { headers: SB_HEADERS });
  if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.message || `HTTP ${res.status}`); }
  return res.json();
}

async function sbRpc(fn, params = {}) {
  const res = await fetch(`${SB_URL}/rest/v1/rpc/${fn}`, {
    method: 'POST',
    headers: SB_HEADERS,
    body: JSON.stringify(params)
  });
  if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.message || `HTTP ${res.status}`); }
  return res.json();
}

// ============================================
// AUTH
// ============================================
async function attemptLogin() {
  const token = document.getElementById('tokenInput').value.trim();
  if (!token) return;
  
  const btn = document.getElementById('loginBtn');
  const errorEl = document.getElementById('loginError');
  btn.disabled = true;
  btn.textContent = 'Wird gepr√ºft‚Ä¶';
  errorEl.classList.remove('show');

  try {
    // Try RPC first, fallback to direct query
    let rows;
    try {
      rows = await sbRpc('get_client_by_token', { p_token: token });
    } catch (e) {
      // Fallback: direct query
      rows = await sbGet('clients', `access_token=eq.${encodeURIComponent(token)}&active=is.true&select=id,name,brand,logo_url,primary_color`);
    }

    if (!rows || rows.length === 0) {
      errorEl.textContent = 'Ung√ºltiger Zugangscode. Bitte versuchen Sie es erneut.';
      errorEl.classList.add('show');
      btn.disabled = false;
      btn.textContent = 'Zugang';
      return;
    }

    clientData = rows[0];
    sessionStorage.setItem('rg_client_token', token);
    await loadDashboard();
  } catch (e) {
    console.error('Login error:', e);
    errorEl.textContent = 'Verbindungsfehler. Bitte versuchen Sie es sp√§ter erneut.';
    errorEl.classList.add('show');
    btn.disabled = false;
    btn.textContent = 'Zugang';
  }
}

function logout() {
  sessionStorage.removeItem('rg_client_token');
  clientData = null;
  campaigns = [];
  allMetrics = [];
  document.getElementById('dashboard').classList.remove('active');
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('tokenInput').value = '';
}

// Check token on load ‚Äî supports URL ?token=XXX auto-login and session storage
async function checkAutoLogin() {
  const urlParams = new URLSearchParams(window.location.search);

  // Support ?token=XXX for auto-login from URL
  let token = urlParams.get('token') || urlParams.get('t');
  if (token) {
    // Strip token from URL for cleanliness (don't leak in browser history)
    window.history.replaceState({}, '', window.location.pathname);
    sessionStorage.setItem('rg_client_token', token);
  } else {
    token = sessionStorage.getItem('rg_client_token');
  }

  if (token) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('loadingScreen').style.display = 'flex';

    try {
      let rows;
      try {
        rows = await sbRpc('get_client_by_token', { p_token: token });
      } catch (e) {
        rows = await sbGet('clients', `access_token=eq.${encodeURIComponent(token)}&active=is.true&select=id,name,brand,logo_url,primary_color`);
      }

      if (rows && rows.length > 0) {
        clientData = rows[0];
        await loadDashboard();
        return;
      }
    } catch (e) {
      console.error('Auto-login error:', e);
    }

    // Token in session was invalid ‚Äî clear it and show login
    sessionStorage.removeItem('rg_client_token');
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
  }
}

// ============================================
// DASHBOARD LOAD
// ============================================
async function loadDashboard() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('loadingScreen').style.display = 'flex';

  try {
    // Apply client brand color
    const accentColor = clientData.primary_color || '#e7352e';
    document.documentElement.style.setProperty('--accent', accentColor);
    // Compute lighter variant
    const r = parseInt(accentColor.slice(1,3),16), g = parseInt(accentColor.slice(3,5),16), b = parseInt(accentColor.slice(5,7),16);
    const lighter = `rgb(${Math.min(255,r+30)},${Math.min(255,g+30)},${Math.min(255,b+30)})`;
    document.documentElement.style.setProperty('--accent-light', lighter);
    document.documentElement.style.setProperty('--accent-bg', `rgba(${r},${g},${b},0.06)`);

    // Set client name
    document.getElementById('navClientName').textContent = clientData.name || clientData.brand || '';

    // 1. Load properties for this client
    const properties = await sbGet('properties', `client_id=eq.${clientData.id}&select=*`);
    const propIds = properties.map(p => p.id);

    if (propIds.length === 0) {
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');
      showEmpty();
      return;
    }

    // 2. Load campaigns for these properties
    const propFilter = propIds.map(id => `"${id}"`).join(',');
    campaigns = await sbGet('campaigns', `property_id=in.(${propFilter})&select=*`);

    // Enrich campaigns with property data
    const propMap = {};
    properties.forEach(p => propMap[p.id] = p);
    campaigns.forEach(c => {
      c.property = propMap[c.property_id] || {};
    });

    if (campaigns.length === 0) {
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');
      showEmpty();
      return;
    }

    // 3. Load daily metrics for all campaigns
    const campIds = campaigns.map(c => c.id);
    const campFilter = campIds.map(id => `"${id}"`).join(',');
    allMetrics = await sbGet('campaign_daily_metrics', `campaign_id=in.(${campFilter})&select=campaign_id,date,spend,impressions,reach,clicks,leads&order=date.asc`);

    // 4. Load creatives + creative metrics
    try {
      allCreatives = await sbGet('creatives', `campaign_id=in.(${campFilter})&select=*`);
      if (allCreatives.length > 0) {
        const creativeIds = allCreatives.map(c => c.id);
        const crFilter = creativeIds.map(id => `"${id}"`).join(',');
        const creativeDailyMetrics = await sbGet('creative_daily_metrics', `creative_id=in.(${crFilter})&select=creative_id,date,spend,impressions,reach,clicks,leads`);
        
        // Aggregate creative metrics
        const crMetricMap = {};
        creativeDailyMetrics.forEach(m => {
          if (!crMetricMap[m.creative_id]) crMetricMap[m.creative_id] = { spend: 0, impressions: 0, clicks: 0, leads: 0, reach: 0 };
          crMetricMap[m.creative_id].spend += parseFloat(m.spend) || 0;
          crMetricMap[m.creative_id].impressions += parseInt(m.impressions) || 0;
          crMetricMap[m.creative_id].clicks += parseInt(m.clicks) || 0;
          crMetricMap[m.creative_id].leads += parseInt(m.leads) || 0;
          crMetricMap[m.creative_id].reach += parseInt(m.reach) || 0;
        });
        allCreatives.forEach(c => {
          c.metrics = crMetricMap[c.id] || { spend: 0, impressions: 0, clicks: 0, leads: 0, reach: 0 };
        });
      }
    } catch (e) {
      console.warn('Creative data unavailable:', e);
      allCreatives = [];
    }

    // 5. Load benchmark data (all campaigns across all clients)
    try {
      benchmarkData = await loadBenchmarkData();
    } catch (e) {
      console.warn('Benchmark data unavailable:', e);
      benchmarkData = null;
    }

    // 6. Aggregate metrics per campaign
    const metricsMap = {};
    allMetrics.forEach(m => {
      if (!metricsMap[m.campaign_id]) metricsMap[m.campaign_id] = { spend: 0, impressions: 0, clicks: 0, leads: 0, reach: 0 };
      metricsMap[m.campaign_id].spend += parseFloat(m.spend) || 0;
      metricsMap[m.campaign_id].impressions += parseInt(m.impressions) || 0;
      metricsMap[m.campaign_id].clicks += parseInt(m.clicks) || 0;
      metricsMap[m.campaign_id].leads += parseInt(m.leads) || 0;
      metricsMap[m.campaign_id].reach += parseInt(m.reach) || 0;
    });
    campaigns.forEach(c => {
      c.agg = metricsMap[c.id] || { spend: 0, impressions: 0, clicks: 0, leads: 0, reach: 0 };
    });

    // Build period filter
    buildPeriodFilter();

    // Render
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('dashboard').classList.add('active');
    renderDashboard();

  } catch (e) {
    console.error('Dashboard load error:', e);
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    const errorEl = document.getElementById('loginError');
    errorEl.textContent = 'Fehler beim Laden der Daten: ' + e.message;
    errorEl.classList.add('show');
  }
}

function showEmpty() {
  document.getElementById('kpiGrid').style.display = 'none';
  const container = document.getElementById('dashboardContent');
  container.innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">üì≠</div>
      <div class="empty-state-title">Keine Kampagnen vorhanden</div>
      <div class="empty-state-text">F√ºr Ihren Account liegen aktuell keine Kampagnendaten vor.</div>
    </div>
  `;
}

// ============================================
// PERIOD FILTER
// ============================================
function buildPeriodFilter() {
  const select = document.getElementById('periodFilter');
  select.innerHTML = '<option value="all">Gesamt</option>';

  // Collect all months from metrics
  const months = new Set();
  allMetrics.forEach(m => {
    if (m.date) months.add(m.date.substring(0, 7));
  });

  const sortedMonths = Array.from(months).sort().reverse();
  const monthNames = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];

  sortedMonths.forEach(ym => {
    const [y, m] = ym.split('-');
    const opt = document.createElement('option');
    opt.value = ym;
    opt.textContent = `${monthNames[parseInt(m)-1]} ${y}`;
    select.appendChild(opt);
  });
}

function applyFilter() {
  currentFilter = document.getElementById('periodFilter').value;
  renderDashboard();
}

function getFilteredMetrics() {
  if (currentFilter === 'all') return allMetrics;
  return allMetrics.filter(m => m.date && m.date.startsWith(currentFilter));
}

// ============================================
// BENCHMARK DATA
// ============================================
async function loadBenchmarkData() {
  // Query ALL campaigns (across all clients) with their aggregated metrics
  const allCampaignsRaw = await sbGet('campaigns', 'select=id');
  if (!allCampaignsRaw || allCampaignsRaw.length === 0) return null;

  const allCampIds = allCampaignsRaw.map(c => c.id);
  // Fetch in batches of 200 to avoid URL length limits
  let allDailyMetrics = [];
  for (let i = 0; i < allCampIds.length; i += 200) {
    const batch = allCampIds.slice(i, i + 200);
    const batchFilter = batch.map(id => `"${id}"`).join(',');
    const batchMetrics = await sbGet('campaign_daily_metrics', `campaign_id=in.(${batchFilter})&select=campaign_id,spend,impressions,clicks,leads`);
    allDailyMetrics = allDailyMetrics.concat(batchMetrics);
  }

  // Aggregate per campaign
  const campTotals = {};
  allDailyMetrics.forEach(m => {
    if (!campTotals[m.campaign_id]) campTotals[m.campaign_id] = { spend: 0, impressions: 0, clicks: 0, leads: 0 };
    campTotals[m.campaign_id].spend += parseFloat(m.spend) || 0;
    campTotals[m.campaign_id].impressions += parseInt(m.impressions) || 0;
    campTotals[m.campaign_id].clicks += parseInt(m.clicks) || 0;
    campTotals[m.campaign_id].leads += parseInt(m.leads) || 0;
  });

  // Only campaigns with leads > 0
  const validCampaigns = Object.values(campTotals).filter(c => c.leads > 0);
  if (validCampaigns.length === 0) return null;

  const cpls = validCampaigns.map(c => c.spend / c.leads);
  const ctrs = validCampaigns.filter(c => c.impressions > 0).map(c => (c.clicks / c.impressions) * 100);
  const leadsArr = validCampaigns.map(c => c.leads);

  const avgCPL = cpls.reduce((a, b) => a + b, 0) / cpls.length;
  const avgCTR = ctrs.length > 0 ? ctrs.reduce((a, b) => a + b, 0) / ctrs.length : 0;
  const avgLeads = leadsArr.reduce((a, b) => a + b, 0) / leadsArr.length;

  // Collect per-campaign CPLs for percentile calculation (sorted ascending = best first)
  const allCPLs = cpls.slice().sort((a, b) => a - b);

  return { avgCPL, avgCTR, avgLeads, allCPLs, campaignCount: validCampaigns.length };
}

function getCPLPercentile(cpl) {
  if (!benchmarkData || !benchmarkData.allCPLs || benchmarkData.allCPLs.length === 0) return null;
  const sorted = benchmarkData.allCPLs; // already sorted ascending
  // Count how many campaigns have a WORSE (higher) CPL
  const betterThan = sorted.filter(c => c > cpl).length;
  return Math.round((betterThan / sorted.length) * 100);
}

// ============================================
// CREATIVE SCORE CALCULATION
// ============================================
function calculateCreativeScore(data) {
  // Score based on weighted combination: CPL efficiency (60%), lead volume (30%), CTR (10%)
  // Lower CPL = higher score, more leads = higher score, higher CTR = higher score
  // Normalize each metric 0-100 within the dataset, then combine
  return data; // We'll score relative to peers in the rendering function
}

function scoreCreativeTypes(typeMap) {
  const entries = Object.entries(typeMap).map(([type, data]) => ({
    type,
    ...data,
    cpl: data.leads > 0 ? data.spend / data.leads : Infinity,
    ctr: data.impressions > 0 ? (data.clicks / data.impressions) * 100 : 0
  }));

  // Only score types with leads
  const withLeads = entries.filter(e => e.leads > 0);
  const withoutLeads = entries.filter(e => e.leads === 0);

  if (withLeads.length === 0) return entries.map(e => ({ ...e, score: 0 }));

  // Normalize CPL (inverse ‚Äî lower is better)
  const maxCPL = Math.max(...withLeads.map(e => e.cpl));
  const minCPL = Math.min(...withLeads.map(e => e.cpl));
  const cplRange = maxCPL - minCPL || 1;

  // Normalize leads (higher is better)
  const maxLeads = Math.max(...withLeads.map(e => e.leads));
  const minLeads = Math.min(...withLeads.map(e => e.leads));
  const leadsRange = maxLeads - minLeads || 1;

  // Normalize CTR (higher is better)
  const maxCTR = Math.max(...withLeads.map(e => e.ctr));
  const minCTR = Math.min(...withLeads.map(e => e.ctr));
  const ctrRange = maxCTR - minCTR || 1;

  withLeads.forEach(e => {
    const cplScore = withLeads.length === 1 ? 80 : ((maxCPL - e.cpl) / cplRange) * 100;
    const leadsScore = withLeads.length === 1 ? 80 : ((e.leads - minLeads) / leadsRange) * 100;
    const ctrScore = withLeads.length === 1 ? 80 : ((e.ctr - minCTR) / ctrRange) * 100;
    e.score = Math.round(cplScore * 0.5 + leadsScore * 0.35 + ctrScore * 0.15);
  });

  // Types without leads get score 0
  withoutLeads.forEach(e => { e.score = 0; });

  // Sort by score descending
  const all = [...withLeads, ...withoutLeads];
  all.sort((a, b) => b.score - a.score);
  return all;
}

// ============================================
// RENDER CREATIVE RANKING TABLE (reusable)
// ============================================
function renderCreativeRankingHTML(scoredTypes) {
  if (scoredTypes.length === 0) return '<div style="color:var(--text-muted);font-size:13px;padding:16px 0">Keine Creative-Daten verf√ºgbar</div>';

  const maxScore = Math.max(...scoredTypes.map(t => t.score), 1);
  const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#e7352e';

  const rows = scoredTypes.map((t, i) => {
    const rank = i + 1;
    const rankClass = rank === 1 ? 'creative-rank-1' : rank === 2 ? 'creative-rank-2' : rank === 3 ? 'creative-rank-3' : 'creative-rank-default';
    const cplStr = t.leads > 0 ? formatEUR(t.cpl) : '‚Äî';
    const pct = maxScore > 0 ? Math.round((t.score / maxScore) * 100) : 0;

    // Color gradient from green (best) to orange (worst)
    const hue = Math.round(120 * (pct / 100)); // 120=green, 0=red
    const barColor = t.score > 0 ? `hsl(${hue}, 65%, 48%)` : '#e5e7eb';

    return `
      <tr>
        <td><span class="creative-rank ${rankClass}">${rank}</span></td>
        <td><span class="creative-type-name">${formatCreativeType(t.type)}</span></td>
        <td style="font-weight:700">${t.leads}</td>
        <td>${cplStr}</td>
        <td>
          <div class="creative-score-bar">
            <div class="creative-score-track">
              <div class="creative-score-fill" style="width:${pct}%;background:${barColor}"></div>
            </div>
            <span class="creative-score-value">${t.score}</span>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  return `
    <table class="creative-ranking-table">
      <thead>
        <tr>
          <th style="width:50px">#</th>
          <th>Creative</th>
          <th>Leads</th>
          <th>CPL</th>
          <th style="min-width:140px">Score</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

// ============================================
// RENDER BENCHMARK INSIGHTS
// ============================================
function renderMainBenchmarkInsights(metrics) {
  const section = document.getElementById('mainBenchmarkSection');
  const container = document.getElementById('mainBenchmarkInsights');

  if (!benchmarkData) { section.style.display = 'none'; return; }

  let totalSpend = 0, totalLeads = 0, totalImpressions = 0, totalClicks = 0;
  metrics.forEach(m => {
    totalSpend += parseFloat(m.spend) || 0;
    totalLeads += parseInt(m.leads) || 0;
    totalImpressions += parseInt(m.impressions) || 0;
    totalClicks += parseInt(m.clicks) || 0;
  });

  // Calculate this client's averages per campaign
  const clientCampaignMetrics = {};
  metrics.forEach(m => {
    if (!clientCampaignMetrics[m.campaign_id]) clientCampaignMetrics[m.campaign_id] = { spend: 0, leads: 0, impressions: 0, clicks: 0 };
    clientCampaignMetrics[m.campaign_id].spend += parseFloat(m.spend) || 0;
    clientCampaignMetrics[m.campaign_id].leads += parseInt(m.leads) || 0;
    clientCampaignMetrics[m.campaign_id].impressions += parseInt(m.impressions) || 0;
    clientCampaignMetrics[m.campaign_id].clicks += parseInt(m.clicks) || 0;
  });

  const clientCampaignsWithLeads = Object.values(clientCampaignMetrics).filter(c => c.leads > 0);

  const insights = [];

  // CPL comparison
  if (totalLeads > 0 && clientCampaignsWithLeads.length > 0) {
    const clientAvgCPL = totalSpend / totalLeads;
    if (clientAvgCPL < benchmarkData.avgCPL) {
      const pctBetter = ((benchmarkData.avgCPL - clientAvgCPL) / benchmarkData.avgCPL * 100).toFixed(0);
      insights.push({ icon: '‚ú®', text: `Ihr Portfolio performt <strong>${pctBetter}% besser</strong> als der R&G Durchschnitt` });
    }
  }

  // CTR comparison
  if (totalImpressions > 0 && benchmarkData.avgCTR > 0) {
    const clientCTR = (totalClicks / totalImpressions) * 100;
    if (clientCTR > benchmarkData.avgCTR) {
      const pctBetter = ((clientCTR - benchmarkData.avgCTR) / benchmarkData.avgCTR * 100).toFixed(0);
      insights.push({ icon: 'üìà', text: `Ihre durchschnittliche CTR liegt <strong>${pctBetter}% √ºber dem Durchschnitt</strong>` });
    }
  }

  // Leads per campaign comparison
  if (clientCampaignsWithLeads.length > 0 && benchmarkData.avgLeads > 0) {
    const clientAvgLeads = clientCampaignsWithLeads.reduce((sum, c) => sum + c.leads, 0) / clientCampaignsWithLeads.length;
    if (clientAvgLeads > benchmarkData.avgLeads) {
      const pctMore = ((clientAvgLeads - benchmarkData.avgLeads) / benchmarkData.avgLeads * 100).toFixed(0);
      insights.push({ icon: 'üèÜ', text: `<strong>${pctMore}% mehr Leads</strong> pro Kampagne als der Durchschnitt` });
    }
  }

  if (insights.length === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';
  container.innerHTML = insights.map(i => `
    <div class="benchmark-item">
      <span class="benchmark-icon">${i.icon}</span>
      <span class="benchmark-text">${i.text}</span>
    </div>
  `).join('');
}

function renderDetailBenchmarkInsights(campaignId, totalSpend, totalLeads, totalImpressions, totalClicks) {
  const section = document.getElementById('detailBenchmarkSection');
  const container = document.getElementById('detailBenchmarkInsights');

  if (!benchmarkData) { section.style.display = 'none'; return; }

  const insights = [];

  // CPL comparison
  if (totalLeads > 0) {
    const thisCPL = totalSpend / totalLeads;
    if (thisCPL < benchmarkData.avgCPL) {
      const pctBelow = ((benchmarkData.avgCPL - thisCPL) / benchmarkData.avgCPL * 100).toFixed(0);
      insights.push({ icon: '‚ú®', text: `CPL <strong>${formatEUR(thisCPL)}</strong> ‚Äî das sind <strong>${pctBelow}% unter</strong> dem R&G Durchschnitt von ${formatEUR(benchmarkData.avgCPL)}` });
    }

    // Percentile
    const percentile = getCPLPercentile(thisCPL);
    if (percentile !== null && percentile >= 75) {
      insights.push({ icon: 'üèÜ', text: `Diese Kampagne geh√∂rt zu den <strong>Top ${100 - percentile}%</strong> aller R&G Kampagnen` });
    }
  }

  // CTR comparison
  if (totalImpressions > 0 && benchmarkData.avgCTR > 0) {
    const thisCTR = (totalClicks / totalImpressions) * 100;
    if (thisCTR > benchmarkData.avgCTR) {
      const pctAbove = ((thisCTR - benchmarkData.avgCTR) / benchmarkData.avgCTR * 100).toFixed(0);
      insights.push({ icon: 'üìà', text: `CTR von <strong>${thisCTR.toFixed(2)}%</strong> ‚Äî <strong>${pctAbove}% √ºber dem Durchschnitt</strong>` });
    }
  }

  if (insights.length === 0) {
    // Neutral message
    section.style.display = 'block';
    container.innerHTML = `
      <div class="benchmark-item benchmark-item-neutral">
        <span class="benchmark-icon">üìä</span>
        <span class="benchmark-text">Kampagne l√§uft ‚Äî Daten werden gesammelt</span>
      </div>
    `;
    return;
  }

  section.style.display = 'block';
  container.innerHTML = insights.map(i => `
    <div class="benchmark-item">
      <span class="benchmark-icon">${i.icon}</span>
      <span class="benchmark-text">${i.text}</span>
    </div>
  `).join('');
}

// ============================================
// RENDER DASHBOARD
// ============================================
function renderDashboard() {
  const metrics = getFilteredMetrics();
  renderKPIs(metrics);
  renderTrendChart(metrics);
  renderCampaignTable(metrics);
  renderMainBenchmarkInsights(metrics);
  renderMainCreativePerformance(metrics);
}

// ============================================
// MAIN PAGE CREATIVE PERFORMANCE (cross-campaign)
// ============================================
function renderMainCreativePerformance(metrics) {
  const section = document.getElementById('mainCreativeSection');
  const container = document.getElementById('mainCreativeRanking');

  if (allCreatives.length === 0) { section.style.display = 'none'; return; }

  // Group all creatives by type across all campaigns
  const typeMap = {};
  allCreatives.forEach(c => {
    const type = c.creative_type || 'sonstige';
    if (!typeMap[type]) typeMap[type] = { spend: 0, leads: 0, impressions: 0, clicks: 0, count: 0 };
    typeMap[type].spend += c.metrics.spend;
    typeMap[type].leads += c.metrics.leads;
    typeMap[type].impressions += c.metrics.impressions;
    typeMap[type].clicks += c.metrics.clicks;
    typeMap[type].count++;
  });

  const scored = scoreCreativeTypes(typeMap);

  // Only show if there's meaningful data
  if (scored.length === 0 || scored.every(s => s.leads === 0)) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';
  container.innerHTML = renderCreativeRankingHTML(scored);
}

// ============================================
// KPIs
// ============================================
function renderKPIs(metrics) {
  let totalSpend = 0, totalLeads = 0, totalImpressions = 0, totalClicks = 0;

  metrics.forEach(m => {
    totalSpend += parseFloat(m.spend) || 0;
    totalLeads += parseInt(m.leads) || 0;
    totalImpressions += parseInt(m.impressions) || 0;
    totalClicks += parseInt(m.clicks) || 0;
  });

  const avgCPL = totalLeads > 0 ? totalSpend / totalLeads : 0;
  const avgCTR = totalImpressions > 0 ? (totalClicks / totalImpressions) * 100 : 0;

  animateValue('kpiSpend', totalSpend, v => formatEUR(v));
  animateValue('kpiLeads', totalLeads, v => formatNum(v));
  animateValue('kpiCPL', avgCPL, v => formatEUR(v));
  animateValue('kpiImpressions', totalImpressions, v => formatNum(v));
  animateValue('kpiClicks', totalClicks, v => formatNum(v));
  animateValue('kpiCTR', avgCTR, v => v.toFixed(2) + '%');
}

function animateValue(elId, target, formatter) {
  const el = document.getElementById(elId);
  if (!el) return;
  
  const duration = 800;
  const start = performance.now();
  const startVal = 0;

  function tick(now) {
    const elapsed = now - start;
    const progress = Math.min(elapsed / duration, 1);
    // Ease out cubic
    const eased = 1 - Math.pow(1 - progress, 3);
    const current = startVal + (target - startVal) * eased;
    el.textContent = formatter(current);
    if (progress < 1) requestAnimationFrame(tick);
  }

  el.style.animation = 'countUp 0.4s ease';
  requestAnimationFrame(tick);
}

// ============================================
// TREND CHART
// ============================================
function renderTrendChart(metrics) {
  // Group by ISO week
  const weekMap = {};
  metrics.forEach(m => {
    const d = new Date(m.date);
    const week = getISOWeek(d);
    const year = d.getFullYear();
    const key = `${year}-W${String(week).padStart(2, '0')}`;
    if (!weekMap[key]) weekMap[key] = { spend: 0, leads: 0, label: `KW ${week}`, key: key };
    weekMap[key].spend += parseFloat(m.spend) || 0;
    weekMap[key].leads += parseInt(m.leads) || 0;
  });

  const weeks = Object.values(weekMap).sort((a, b) => a.key.localeCompare(b.key));
  const labels = weeks.map(w => w.label);
  const spendData = weeks.map(w => w.spend);
  const leadsData = weeks.map(w => w.leads);

  const ctx = document.getElementById('trendChart').getContext('2d');
  if (trendChart) trendChart.destroy();

  const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#e7352e';

  trendChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Leads',
          data: leadsData,
          backgroundColor: accentColor + '18',
          borderColor: accentColor,
          borderWidth: 1.5,
          borderRadius: 6,
          borderSkipped: false,
          yAxisID: 'y',
          order: 2
        },
        {
          label: 'Ausgaben (‚Ç¨)',
          data: spendData,
          type: 'line',
          borderColor: '#9ca3af',
          backgroundColor: 'transparent',
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 5,
          pointHoverBackgroundColor: '#6b7280',
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 2,
          tension: 0.4,
          yAxisID: 'y1',
          order: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          position: 'top',
          align: 'end',
          labels: {
            usePointStyle: true,
            pointStyle: 'rectRounded',
            padding: 24,
            font: { family: 'Inter', size: 12, weight: '500' },
            color: '#6b7280'
          }
        },
        tooltip: {
          backgroundColor: '#111827',
          titleFont: { family: 'Inter', weight: '600', size: 13 },
          bodyFont: { family: 'Inter', size: 13 },
          padding: 14,
          cornerRadius: 10,
          displayColors: true,
          boxPadding: 4,
          callbacks: {
            label: ctx => {
              if (ctx.dataset.label === 'Ausgaben (‚Ç¨)') return ` Ausgaben: ${formatEUR(ctx.raw)}`;
              return ` Leads: ${ctx.raw}`;
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          border: { display: false },
          ticks: { font: { family: 'Inter', size: 11 }, color: '#b0b5be', padding: 8, autoSkip: false, maxRotation: 0 }
        },
        y: {
          position: 'left',
          title: { display: true, text: 'Leads', font: { family: 'Inter', size: 11, weight: '600' }, color: '#b0b5be', padding: 12 },
          grid: { color: 'rgba(0,0,0,0.04)', drawBorder: false },
          border: { display: false },
          ticks: { font: { family: 'Inter', size: 11 }, color: '#b0b5be', stepSize: 1, padding: 8 },
          beginAtZero: true
        },
        y1: {
          position: 'right',
          title: { display: true, text: 'Ausgaben (‚Ç¨)', font: { family: 'Inter', size: 11, weight: '600' }, color: '#b0b5be', padding: 12 },
          grid: { display: false },
          border: { display: false },
          ticks: {
            font: { family: 'Inter', size: 11 },
            color: '#b0b5be',
            padding: 8,
            callback: v => formatEUR(v)
          },
          beginAtZero: true
        }
      }
    }
  });
}

function getISOWeek(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

// ============================================
// CAMPAIGN TABLE
// ============================================
function renderCampaignTable(metrics) {
  // Recalculate per-campaign metrics for the current filter
  const filteredMetricsMap = {};
  metrics.forEach(m => {
    if (!filteredMetricsMap[m.campaign_id]) filteredMetricsMap[m.campaign_id] = { spend: 0, impressions: 0, clicks: 0, leads: 0 };
    filteredMetricsMap[m.campaign_id].spend += parseFloat(m.spend) || 0;
    filteredMetricsMap[m.campaign_id].impressions += parseInt(m.impressions) || 0;
    filteredMetricsMap[m.campaign_id].clicks += parseInt(m.clicks) || 0;
    filteredMetricsMap[m.campaign_id].leads += parseInt(m.leads) || 0;
  });

  // Enrich campaigns with filtered data
  let displayCampaigns = campaigns.map(c => {
    const fm = filteredMetricsMap[c.id] || { spend: 0, impressions: 0, clicks: 0, leads: 0 };
    return {
      ...c,
      fSpend: fm.spend,
      fLeads: fm.leads,
      fImpressions: fm.impressions,
      fClicks: fm.clicks,
      fCPL: fm.leads > 0 ? fm.spend / fm.leads : Infinity
    };
  });

  // Sort
  displayCampaigns.sort((a, b) => {
    let va, vb;
    switch (currentSort.field) {
      case 'name':
        va = (a.property?.name || a.campaign_name || '').toLowerCase();
        vb = (b.property?.name || b.campaign_name || '').toLowerCase();
        return currentSort.dir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
      case 'period':
        va = a.start_date || '';
        vb = b.start_date || '';
        return currentSort.dir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
      case 'spend':
        return currentSort.dir === 'asc' ? a.fSpend - b.fSpend : b.fSpend - a.fSpend;
      case 'leads':
        return currentSort.dir === 'asc' ? a.fLeads - b.fLeads : b.fLeads - a.fLeads;
      case 'cpl':
        va = a.fCPL === Infinity ? 999999 : a.fCPL;
        vb = b.fCPL === Infinity ? 999999 : b.fCPL;
        return currentSort.dir === 'asc' ? va - vb : vb - va;
      default:
        return 0;
    }
  });

  // Update sort indicators
  document.querySelectorAll('.campaign-table th.sortable').forEach(th => {
    th.classList.toggle('sort-active', th.dataset.sort === currentSort.field);
    const icon = th.querySelector('.sort-icon');
    if (th.dataset.sort === currentSort.field) {
      icon.textContent = currentSort.dir === 'asc' ? '‚Üë' : '‚Üì';
    } else {
      icon.textContent = '‚Üï';
    }
  });

  // Update count
  document.getElementById('campaignsTitle').textContent = `Kampagnen (${displayCampaigns.length})`;

  const tbody = document.getElementById('campaignTableBody');
  tbody.innerHTML = '';

  if (displayCampaigns.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-muted)">Keine Kampagnen im gew√§hlten Zeitraum</td></tr>`;
    return;
  }

  displayCampaigns.forEach(c => {
    const tr = document.createElement('tr');
    tr.onclick = () => openDetail(c.id);

    const name = c.property?.name || c.campaign_name || '‚Äî';
    const address = c.property?.address || '';
    const status = c.status || 'active';
    const statusBadge = status === 'active' ? 'badge-active' : status === 'paused' ? 'badge-paused' : 'badge-completed';
    const statusLabel = status === 'active' ? 'Aktiv' : status === 'paused' ? 'Pausiert' : 'Abgeschlossen';
    const period = formatDateRange(c.start_date, c.end_date);
    const cplStr = c.fLeads > 0 ? formatEUR(c.fCPL) : '‚Äî';

    tr.innerHTML = `
      <td>
        <div class="campaign-name">${escHtml(name)}</div>
        ${address ? `<div class="campaign-address">${escHtml(address)}</div>` : ''}
      </td>
      <td><span class="badge ${statusBadge}"><span class="badge-dot"></span>${statusLabel}</span></td>
      <td style="font-size:13px;color:var(--text-secondary)">${period}</td>
      <td class="value-eur">${formatEUR(c.fSpend)}</td>
      <td><strong>${c.fLeads}</strong></td>
      <td class="value-eur">${cplStr}</td>
    `;
    tbody.appendChild(tr);
  });
}

function sortTable(field) {
  if (currentSort.field === field) {
    currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.field = field;
    currentSort.dir = field === 'name' ? 'asc' : 'desc';
  }
  renderDashboard();
}

// ============================================
// CAMPAIGN DETAIL
// ============================================
function openDetail(campaignId) {
  const campaign = campaigns.find(c => c.id === campaignId);
  if (!campaign) return;

  currentDetailCampaignId = campaignId;
  const prop = campaign.property || {};
  const campaignMetrics = getFilteredMetrics().filter(m => m.campaign_id === campaignId);

  // Title
  document.getElementById('detailTitle').textContent = prop.name || campaign.campaign_name || '‚Äî';
  document.getElementById('detailSubtitle').textContent = [prop.address, prop.city].filter(Boolean).join(', ') || campaign.platform || '';

  // Calculate aggregates for this campaign in filtered period
  let totalSpend = 0, totalLeads = 0, totalImpressions = 0, totalClicks = 0;
  campaignMetrics.forEach(m => {
    totalSpend += parseFloat(m.spend) || 0;
    totalLeads += parseInt(m.leads) || 0;
    totalImpressions += parseInt(m.impressions) || 0;
    totalClicks += parseInt(m.clicks) || 0;
  });

  // Daily chart
  renderDetailChart(campaignMetrics);

  // Creative performance
  renderCreativePerformance(campaignId, totalSpend, totalLeads);

  // Insights
  renderInsights(campaign, totalSpend, totalLeads, totalImpressions, totalClicks, campaignMetrics);

  // Show modal
  document.getElementById('detailModal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeDetail() {
  document.getElementById('detailModal').classList.remove('show');
  document.body.style.overflow = '';
  if (detailChartInstance) { detailChartInstance.destroy(); detailChartInstance = null; }
}

function renderDetailChart(metrics) {
  const sorted = [...metrics].sort((a, b) => a.date.localeCompare(b.date));
  const labels = sorted.map(m => formatDateShort(m.date));
  const spendData = sorted.map(m => parseFloat(m.spend) || 0);
  const leadsData = sorted.map(m => parseInt(m.leads) || 0);

  const ctx = document.getElementById('detailChart').getContext('2d');
  if (detailChartInstance) detailChartInstance.destroy();

  const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#e7352e';

  detailChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Leads',
          data: leadsData,
          backgroundColor: accentColor + '18',
          borderColor: accentColor,
          borderWidth: 1,
          borderRadius: 4,
          borderSkipped: false,
          yAxisID: 'y',
          order: 2
        },
        {
          label: 'Ausgaben (‚Ç¨)',
          data: spendData,
          type: 'line',
          borderColor: '#9ca3af',
          backgroundColor: 'rgba(156,163,175,0.04)',
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 4,
          pointHoverBackgroundColor: '#6b7280',
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 2,
          fill: true,
          tension: 0.4,
          yAxisID: 'y1',
          order: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          position: 'top',
          align: 'end',
          labels: { usePointStyle: true, pointStyle: 'rectRounded', padding: 20, font: { family: 'Inter', size: 11 }, color: '#6b7280' }
        },
        tooltip: {
          backgroundColor: '#111827',
          titleFont: { family: 'Inter', weight: '600', size: 12 },
          bodyFont: { family: 'Inter', size: 12 },
          padding: 12,
          cornerRadius: 10,
          displayColors: true,
          boxPadding: 4,
          callbacks: {
            label: ctx => {
              if (ctx.dataset.label === 'Ausgaben (‚Ç¨)') return ` Ausgaben: ${formatEUR(ctx.raw)}`;
              return ` Leads: ${ctx.raw}`;
            }
          }
        }
      },
      scales: {
        x: { grid: { display: false }, border: { display: false }, ticks: { font: { family: 'Inter', size: 15 }, color: '#b0b5be', maxRotation: 45, padding: 6, autoSkip: false } },
        y: { position: 'left', grid: { color: 'rgba(0,0,0,0.04)', drawBorder: false }, border: { display: false }, ticks: { font: { family: 'Inter', size: 15 }, color: '#b0b5be', stepSize: 1, padding: 6 }, beginAtZero: true },
        y1: { position: 'right', grid: { display: false }, border: { display: false }, ticks: { font: { family: 'Inter', size: 15 }, color: '#b0b5be', padding: 6, callback: v => formatEUR(v) }, beginAtZero: true }
      }
    }
  });
}

function renderCreativePerformance(campaignId, totalSpend, totalLeads) {
  const section = document.getElementById('creativeSection');
  const container = document.getElementById('creativeRanking');

  const campCreatives = allCreatives.filter(c => c.campaign_id === campaignId);

  if (campCreatives.length === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';

  // Group by creative_type
  const typeMap = {};
  campCreatives.forEach(c => {
    const type = c.creative_type || 'sonstige';
    if (!typeMap[type]) typeMap[type] = { spend: 0, leads: 0, impressions: 0, clicks: 0, count: 0 };
    typeMap[type].spend += c.metrics.spend;
    typeMap[type].leads += c.metrics.leads;
    typeMap[type].impressions += c.metrics.impressions;
    typeMap[type].clicks += c.metrics.clicks;
    typeMap[type].count++;
  });

  const scored = scoreCreativeTypes(typeMap);
  container.innerHTML = renderCreativeRankingHTML(scored);
}

function renderInsights(campaign, totalSpend, totalLeads, totalImpressions, totalClicks, metrics) {
  // Now handled by benchmark insights
  renderDetailBenchmarkInsights(campaign.id, totalSpend, totalLeads, totalImpressions, totalClicks);
}

// ============================================
// PDF HELPERS
// ============================================

// Render a Chart.js chart to a data URL image (renders on a visible offscreen canvas)
function renderChartToImage(chartConfig, width, height) {
  return new Promise((resolve) => {
    const wrapper = document.createElement('div');
    wrapper.style.cssText = `position:fixed;top:0;left:0;width:${width}px;height:${height}px;z-index:-1;opacity:0;pointer-events:none;`;
    const canvas = document.createElement('canvas');
    canvas.width = width * 2;
    canvas.height = height * 2;
    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';
    wrapper.appendChild(canvas);
    document.body.appendChild(wrapper);

    const ctx = canvas.getContext('2d');
    ctx.scale(2, 2);
    const cfg = JSON.parse(JSON.stringify(chartConfig));
    cfg.options = cfg.options || {};
    cfg.options.responsive = false;
    cfg.options.animation = false;
    cfg.options.devicePixelRatio = 2;
    const chart = new Chart(ctx, cfg);

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        const dataUrl = canvas.toDataURL('image/png');
        chart.destroy();
        document.body.removeChild(wrapper);
        resolve(dataUrl);
      });
    });
  });
}

// Load an image as base64 data URL (avoids CORS issues with html2canvas)
async function loadLogoBase64() {
  try {
    const resp = await fetch('../assets/rg-logo.png');
    const blob = await resp.blob();
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  } catch (e) {
    console.warn('Could not load logo as base64:', e);
    return '';
  }
}

// Build a standard PDF filename
function buildPdfFilename(type, campaignName) {
  const now = new Date();
  const datePrefix = now.toISOString().slice(0, 10);
  const client = (clientData.name || 'Report').replace(/\s+/g, '_');
  const periodLabel = currentFilter === 'all'
    ? 'Gesamt'
    : document.getElementById('periodFilter').selectedOptions[0].text.replace(/\s+/g, '');

  if (type === 'overview') {
    return `${datePrefix}_R&G_Report_${client}_${periodLabel}.pdf`;
  } else {
    const campSafe = (campaignName || 'Kampagne').replace(/\s+/g, '_');
    return `${datePrefix}_R&G_Report_${client}_${campSafe}_${periodLabel}.pdf`;
  }
}

// Shared KPI card HTML builder for PDF
function pdfKpiCard(label, value) {
  return '<div style="background:#f8f9fb;padding:18px;border-radius:10px;border:1px solid #eef0f3">'
    + '<div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#9ca3af;margin-bottom:8px">' + label + '</div>'
    + '<div style="font-size:24px;font-weight:800;letter-spacing:-0.03em;color:#111827">' + value + '</div>'
    + '</div>';
}

// Shared chart config for PDF
function pdfChartConfig(labels, leadsData, spendData) {
  return {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: 'Leads', data: leadsData, backgroundColor: 'rgba(231,53,46,0.15)', borderColor: '#e7352e', borderWidth: 1.5, borderRadius: 5, borderSkipped: false, yAxisID: 'y', order: 2 },
        { label: 'Ausgaben (‚Ç¨)', data: spendData, type: 'line', borderColor: '#9ca3af', backgroundColor: 'rgba(156,163,175,0.06)', borderWidth: 2, pointRadius: 2, pointBackgroundColor: '#6b7280', fill: true, tension: 0.4, yAxisID: 'y1', order: 1 }
      ]
    },
    options: {
      responsive: false,
      animation: false,
      plugins: {
        legend: { position: 'top', align: 'end', labels: { usePointStyle: true, pointStyle: 'rectRounded', padding: 20, font: { family: 'Inter', size: 16, weight: '500' }, color: '#6b7280' } },
        tooltip: { enabled: false }
      },
      scales: {
        x: { grid: { display: false }, border: { display: false }, ticks: { font: { family: 'Inter', size: 15 }, color: '#b0b5be', padding: 6, maxRotation: 45, autoSkip: false } },
        y: { position: 'left', grid: { color: 'rgba(0,0,0,0.04)', drawBorder: false }, border: { display: false }, ticks: { font: { family: 'Inter', size: 15 }, color: '#b0b5be', stepSize: 1, padding: 6 }, beginAtZero: true },
        y1: { position: 'right', grid: { display: false }, border: { display: false }, ticks: { font: { family: 'Inter', size: 15 }, color: '#b0b5be', padding: 6, callback: function(v) { return '\u20AC' + Math.round(v); } }, beginAtZero: true }
      }
    }
  };
}

// Build benchmark insights HTML for PDF
function pdfBenchmarkInsightsHTML(totalSpend, totalLeads, totalImpressions, totalClicks) {
  if (!benchmarkData || totalLeads === 0) return '';
  var items = [];
  var thisCPL = totalSpend / totalLeads;
  if (thisCPL < benchmarkData.avgCPL) {
    var pct = ((benchmarkData.avgCPL - thisCPL) / benchmarkData.avgCPL * 100).toFixed(0);
    items.push('\u2728 CPL ' + formatEUR(thisCPL) + ' \u2014 ' + pct + '% unter dem R&G Durchschnitt von ' + formatEUR(benchmarkData.avgCPL));
  }
  var percentile = getCPLPercentile(thisCPL);
  if (percentile !== null && percentile >= 75) {
    items.push('\uD83C\uDFC6 Diese Kampagne geh\u00f6rt zu den Top ' + (100 - percentile) + '% aller R&G Kampagnen');
  }
  if (totalImpressions > 0 && benchmarkData.avgCTR > 0) {
    var thisCTR = (totalClicks / totalImpressions) * 100;
    if (thisCTR > benchmarkData.avgCTR) {
      var pctA = ((thisCTR - benchmarkData.avgCTR) / benchmarkData.avgCTR * 100).toFixed(0);
      items.push('\uD83D\uDCC8 CTR von ' + thisCTR.toFixed(2) + '% \u2014 ' + pctA + '% \u00fcber dem Durchschnitt');
    }
  }
  if (items.length === 0) return '';
  var html = '<div style="margin-bottom:28px">';
  html += '<div style="font-size:14px;font-weight:700;margin-bottom:12px;color:#111827">\uD83D\uDCCA Performance Insights</div>';
  items.forEach(function(text) {
    html += '<div style="padding:12px 16px;background:linear-gradient(135deg,rgba(22,163,74,0.03),rgba(22,163,74,0.07));border-left:3px solid #16a34a;border-radius:8px;font-size:12px;line-height:1.6;color:#4b5563;margin-bottom:8px">' + text + '</div>';
  });
  html += '</div>';
  return html;
}

// Build creative ranking HTML for PDF
function pdfCreativeRankingHTML(creativesArr) {
  if (creativesArr.length === 0) return '';
  var typeMap = {};
  creativesArr.forEach(function(c) {
    var type = c.creative_type || 'sonstige';
    if (!typeMap[type]) typeMap[type] = { spend: 0, leads: 0, impressions: 0, clicks: 0, count: 0 };
    typeMap[type].spend += c.metrics.spend;
    typeMap[type].leads += c.metrics.leads;
    typeMap[type].impressions += c.metrics.impressions;
    typeMap[type].clicks += c.metrics.clicks;
    typeMap[type].count++;
  });
  var scored = scoreCreativeTypes(typeMap);
  if (scored.length === 0 || scored.every(function(s) { return s.leads === 0; })) return '';
  var maxScore = Math.max.apply(null, scored.map(function(t) { return t.score; }).concat([1]));

  var rows = '';
  scored.forEach(function(t, i) {
    var cplStr = t.leads > 0 ? formatEUR(t.cpl) : '\u2014';
    var pct = maxScore > 0 ? Math.round((t.score / maxScore) * 100) : 0;
    var hue = Math.round(120 * (pct / 100));
    var barColor = t.score > 0 ? 'hsl(' + hue + ', 65%, 48%)' : '#e5e7eb';
    rows += '<tr>'
      + '<td style="padding:10px 14px;border-bottom:1px solid #f3f4f6;font-weight:800;width:36px;color:#6b7280">' + (i + 1) + '</td>'
      + '<td style="padding:10px 14px;border-bottom:1px solid #f3f4f6;font-weight:600">' + formatCreativeType(t.type) + '</td>'
      + '<td style="padding:10px 14px;border-bottom:1px solid #f3f4f6;text-align:right;font-weight:700">' + t.leads + '</td>'
      + '<td style="padding:10px 14px;border-bottom:1px solid #f3f4f6;text-align:right">' + cplStr + '</td>'
      + '<td style="padding:10px 14px;border-bottom:1px solid #f3f4f6;text-align:right;font-weight:800">' + t.score + '</td>'
      + '</tr>';
  });

  var thStyle = 'text-align:left;padding:10px 14px;font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:0.06em;color:#9ca3af;border-bottom:2px solid #e8eaed';
  return '<div style="margin-bottom:28px">'
    + '<div style="font-size:14px;font-weight:700;margin-bottom:12px;color:#111827">\uD83C\uDFC6 Creative Performance</div>'
    + '<table style="width:100%;border-collapse:collapse;font-size:12px">'
    + '<thead><tr style="background:#f8f9fb">'
    + '<th style="' + thStyle + '">#</th>'
    + '<th style="' + thStyle + '">Creative</th>'
    + '<th style="' + thStyle + ';text-align:right">Leads</th>'
    + '<th style="' + thStyle + ';text-align:right">CPL</th>'
    + '<th style="' + thStyle + ';text-align:right">Score</th>'
    + '</tr></thead>'
    + '<tbody>' + rows + '</tbody>'
    + '</table></div>';
}

// ============================================
// PDF EXPORT ‚Äî jsPDF DIRECT DRAWING (no html2canvas)
// ============================================

// Shared jsPDF helpers
function pdfDrawRoundedRect(doc, x, y, w, h, r, fillColor) {
  doc.setFillColor(fillColor[0], fillColor[1], fillColor[2]);
  doc.roundedRect(x, y, w, h, r, r, 'F');
}

function pdfDrawKpiCard(doc, x, y, w, h, label, value) {
  pdfDrawRoundedRect(doc, x, y, w, h, 3, [248, 249, 251]);
  // Border
  doc.setDrawColor(238, 240, 243);
  doc.setLineWidth(0.3);
  doc.roundedRect(x, y, w, h, 3, 3, 'S');
  // Label
  doc.setFont('Inter', 'bold');
  doc.setFontSize(8.5);
  doc.setTextColor(156, 163, 175);
  doc.text(label.toUpperCase(), x + 6, y + 10);
  // Value
  doc.setFont('Inter', 'bold');
  doc.setFontSize(16);
  doc.setTextColor(17, 24, 39);
  doc.text(value, x + 6, y + 22);
}

function pdfDrawSectionTitle(doc, x, y, text) {
  doc.setFont('Inter', 'bold');
  doc.setFontSize(11);
  doc.setTextColor(17, 24, 39);
  doc.text(text, x, y);
}

function pdfDrawTableRow(doc, x, y, cols, colWidths, opts) {
  var rowH = opts.rowH || 8;
  if (opts.bg) {
    doc.setFillColor(opts.bg[0], opts.bg[1], opts.bg[2]);
    doc.rect(x, y - rowH + 2.5, colWidths.reduce(function(a, b) { return a + b; }, 0), rowH, 'F');
  }
  doc.setFont('Inter', opts.bold ? 'bold' : 'normal');
  doc.setFontSize(opts.fontSize || 8.5);
  doc.setTextColor(opts.color ? opts.color[0] : 17, opts.color ? opts.color[1] : 24, opts.color ? opts.color[2] : 39);
  var cx = x;
  for (var i = 0; i < cols.length; i++) {
    var align = (opts.align && opts.align[i]) || 'left';
    var tx = align === 'right' ? cx + colWidths[i] - 2 : cx + 2;
    var truncated = String(cols[i] || '');
    // Truncate long text to fit column
    if (truncated.length > Math.floor(colWidths[i] / 2)) {
      truncated = truncated.substring(0, Math.floor(colWidths[i] / 2) - 1) + '\u2026';
    }
    doc.text(truncated, tx, y, { align: align });
    cx += colWidths[i];
  }
}

function pdfDrawFooter(doc, margin, dateStr) {
  var pageCount = doc.internal.getNumberOfPages();
  for (var p = 1; p <= pageCount; p++) {
    doc.setPage(p);
    doc.setFont('Inter', 'normal');
    doc.setFontSize(8);
    doc.setTextColor(156, 163, 175);
    doc.text('Erstellt von Run & Gun \u2014 ' + dateStr, margin, 288);
    doc.text('Seite ' + p + ' / ' + pageCount, 210 - margin, 288, { align: 'right' });
    // Separator line
    doc.setDrawColor(232, 234, 237);
    doc.setLineWidth(0.3);
    doc.line(margin, 284, 210 - margin, 284);
  }
}

// Collect benchmark insight strings (reused for both PDF types)
function collectBenchmarkInsights(totalSpend, totalLeads, totalImpressions, totalClicks) {
  if (!benchmarkData || totalLeads === 0) return [];
  var items = [];
  var thisCPL = totalSpend / totalLeads;
  if (thisCPL < benchmarkData.avgCPL) {
    var pct = ((benchmarkData.avgCPL - thisCPL) / benchmarkData.avgCPL * 100).toFixed(0);
    items.push('CPL ' + formatEUR(thisCPL) + ' \u2014 ' + pct + '% unter dem R&G Durchschnitt von ' + formatEUR(benchmarkData.avgCPL));
  }
  var percentile = getCPLPercentile(thisCPL);
  if (percentile !== null && percentile >= 75) {
    items.push('Diese Kampagne geh√∂rt zu den Top ' + (100 - percentile) + '% aller R&G Kampagnen');
  }
  if (totalImpressions > 0 && benchmarkData.avgCTR > 0) {
    var thisCTR = (totalClicks / totalImpressions) * 100;
    if (thisCTR > benchmarkData.avgCTR) {
      var pctA = ((thisCTR - benchmarkData.avgCTR) / benchmarkData.avgCTR * 100).toFixed(0);
      items.push('CTR von ' + thisCTR.toFixed(2) + '% \u2014 ' + pctA + '% √ºber dem Durchschnitt');
    }
  }
  return items;
}

// Collect scored creative types for PDF
function collectScoredCreatives(creativesArr) {
  if (creativesArr.length === 0) return [];
  var typeMap = {};
  creativesArr.forEach(function(c) {
    var type = c.creative_type || 'sonstige';
    if (!typeMap[type]) typeMap[type] = { spend: 0, leads: 0, impressions: 0, clicks: 0, count: 0 };
    typeMap[type].spend += c.metrics.spend;
    typeMap[type].leads += c.metrics.leads;
    typeMap[type].impressions += c.metrics.impressions;
    typeMap[type].clicks += c.metrics.clicks;
    typeMap[type].count++;
  });
  var scored = scoreCreativeTypes(typeMap);
  if (scored.length === 0 || scored.every(function(s) { return s.leads === 0; })) return [];
  return scored;
}

// ============================================
// PDF EXPORT ‚Äî FONT LOADING
// ============================================
async function loadFontBase64(url) {
  const res = await fetch(url);
  const buf = await res.arrayBuffer();
  return btoa(String.fromCharCode(...new Uint8Array(buf)));
}

async function setupPDFFont(doc) {
  try {
    // Load Inter Regular and Bold fonts from Google Fonts CDN
    const interRegularUrl = 'https://fonts.gstatic.com/s/inter/v18/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiJ-Ek-_EeA.woff2';
    const interBoldUrl = 'https://fonts.gstatic.com/s/inter/v18/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuBWwAZ9hiJ-Ek-_EeA.woff2';

    const interRegularBase64 = await loadFontBase64(interRegularUrl);
    const interBoldBase64 = await loadFontBase64(interBoldUrl);

    // Register fonts with jsPDF
    doc.addFileToVFS('Inter-Regular.woff2', interRegularBase64);
    doc.addFont('Inter-Regular.woff2', 'Inter', 'normal');
    doc.addFileToVFS('Inter-Bold.woff2', interBoldBase64);
    doc.addFont('Inter-Bold.woff2', 'Inter', 'bold');

    // Set default font to Inter
    doc.setFont('Inter', 'normal');
    return true;
  } catch (error) {
    console.warn('Failed to load Inter font, falling back to Helvetica:', error);
    doc.setFont('Inter', 'normal');
    return false;
  }
}

// ============================================
// PDF EXPORT ‚Äî OVERVIEW (Gesamt-Report)
// ============================================
async function exportPDF() {
  var btn = document.querySelector('.topnav-right .btn-secondary');
  btn.disabled = true;
  btn.innerHTML = '\u23F3 <span class="btn-label">Wird erstellt\u2026</span>';

  try {
    var { jsPDF } = window.jspdf;
    var doc = new jsPDF('p', 'mm', 'a4');

    // Setup font for umlaut support
    await setupPDFFont(doc);

    var pageWidth = 210;
    var margin = 18;
    var contentWidth = pageWidth - margin * 2;
    var y = margin;

    function checkPage(needed) {
      if (y + needed > 278) { doc.addPage(); y = margin; }
    }

    // Gather data
    var metrics = getFilteredMetrics();
    var totalSpend = 0, totalLeads = 0, totalImpressions = 0, totalClicks = 0;
    metrics.forEach(function(m) {
      totalSpend += parseFloat(m.spend) || 0;
      totalLeads += parseInt(m.leads) || 0;
      totalImpressions += parseInt(m.impressions) || 0;
      totalClicks += parseInt(m.clicks) || 0;
    });
    var avgCPL = totalLeads > 0 ? totalSpend / totalLeads : 0;
    var avgCTR = totalImpressions > 0 ? (totalClicks / totalImpressions) * 100 : 0;

    var periodLabel = currentFilter === 'all' ? 'Gesamt' : document.getElementById('periodFilter').selectedOptions[0].text;
    var dateStr = new Date().toLocaleDateString('de-DE', { day: '2-digit', month: 'long', year: 'numeric' });

    // ---- 1. LOGO ----
    var logoB64 = await loadLogoBase64();
    if (logoB64) {
      try { doc.addImage(logoB64, 'PNG', margin, y, 12, 12); } catch(e) { /* skip logo */ }
    }

    // ---- 2. HEADER ----
    doc.setFont('Inter', 'bold');
    doc.setFontSize(18);
    doc.setTextColor(17, 24, 39);
    doc.text('Kampagnen-Report', margin + (logoB64 ? 16 : 0), y + 5);

    doc.setFont('Inter', 'normal');
    doc.setFontSize(10);
    doc.setTextColor(107, 114, 128);
    doc.text((clientData.name || '') + ' \u2014 ' + periodLabel, margin + (logoB64 ? 16 : 0), y + 11);

    // Date on right
    doc.setFontSize(8);
    doc.setTextColor(156, 163, 175);
    doc.text('Erstellt am', pageWidth - margin, y + 3, { align: 'right' });
    doc.setFontSize(9);
    doc.setTextColor(107, 114, 128);
    doc.setFont('Inter', 'bold');
    doc.text(dateStr, pageWidth - margin, y + 8, { align: 'right' });

    y += 16;

    // Header separator
    doc.setDrawColor(232, 234, 237);
    doc.setLineWidth(0.5);
    doc.line(margin, y, pageWidth - margin, y);
    y += 8;

    // ---- 3. KPI CARDS (3x2 grid) ----
    var kpiData = [
      ['Gesamtausgaben', formatEUR(totalSpend)],
      ['Leads', String(totalLeads)],
      ['\u00D8 CPL', formatEUR(avgCPL)],
      ['Impressions', formatNum(totalImpressions)],
      ['Klicks', formatNum(totalClicks)],
      ['\u00D8 CTR', avgCTR.toFixed(2) + '%']
    ];
    var cardW = (contentWidth - 8) / 3; // 3 columns, 4mm gap each
    var cardH = 28;
    for (var ki = 0; ki < kpiData.length; ki++) {
      var col = ki % 3;
      var row = Math.floor(ki / 3);
      var cx = margin + col * (cardW + 4);
      var cy = y + row * (cardH + 4);
      pdfDrawKpiCard(doc, cx, cy, cardW, cardH, kpiData[ki][0], kpiData[ki][1]);
    }
    y += cardH * 2 + 4 + 10;

    // ---- 4. TREND CHART ----
    checkPage(75);
    pdfDrawSectionTitle(doc, margin, y, 'W√∂chentlicher Verlauf');
    y += 5;

    var weekMap = {};
    metrics.forEach(function(m) {
      var d = new Date(m.date);
      var week = getISOWeek(d);
      var yr = d.getFullYear();
      var key = yr + '-W' + String(week).padStart(2, '0');
      if (!weekMap[key]) weekMap[key] = { spend: 0, leads: 0, label: 'KW ' + week, key: key };
      weekMap[key].spend += parseFloat(m.spend) || 0;
      weekMap[key].leads += parseInt(m.leads) || 0;
    });
    var weeks = Object.values(weekMap).sort(function(a, b) { return a.key.localeCompare(b.key); });

    var chartImg = await renderChartToImage(
      pdfChartConfig(
        weeks.map(function(w) { return w.label; }),
        weeks.map(function(w) { return w.leads; }),
        weeks.map(function(w) { return w.spend; })
      ),
      1400, 560
    );

    // Draw chart border
    doc.setDrawColor(238, 240, 243);
    doc.setLineWidth(0.3);
    doc.roundedRect(margin, y, contentWidth, 62, 3, 3, 'S');
    doc.addImage(chartImg, 'PNG', margin + 2, y + 2, contentWidth - 4, 58);
    y += 68;

    // ---- 5. BENCHMARK INSIGHTS ----
    var insights = collectBenchmarkInsights(totalSpend, totalLeads, totalImpressions, totalClicks);
    if (insights.length > 0) {
      checkPage(10 + insights.length * 9);
      pdfDrawSectionTitle(doc, margin, y, 'Performance Insights');
      y += 5;
      insights.forEach(function(text) {
        checkPage(10);
        // Green left border bar
        doc.setFillColor(22, 163, 74);
        doc.rect(margin, y, 1.2, 7, 'F');
        // Light green background
        pdfDrawRoundedRect(doc, margin + 1.5, y, contentWidth - 1.5, 7, 2, [240, 253, 244]);
        doc.setFont('Inter', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(75, 85, 99);
        doc.text(text, margin + 4, y + 4.5);
        y += 9;
      });
      y += 4;
    }

    // ---- 6. CREATIVE PERFORMANCE ----
    var scoredCreatives = collectScoredCreatives(allCreatives);
    if (scoredCreatives.length > 0) {
      checkPage(14 + scoredCreatives.length * 8);
      pdfDrawSectionTitle(doc, margin, y, 'Creative Performance');
      y += 5;
      var crColWidths = [12, contentWidth - 12 - 22 - 24 - 22, 22, 24, 22];
      var crAlign = ['left', 'left', 'right', 'right', 'right'];
      // Header row
      pdfDrawTableRow(doc, margin, y, ['#', 'Creative', 'Leads', 'CPL', 'Score'], crColWidths, {
        bold: true, fontSize: 9, color: [156, 163, 175], bg: [248, 249, 251], rowH: 8, align: crAlign
      });
      y += 1;
      // Separator
      doc.setDrawColor(232, 234, 237);
      doc.setLineWidth(0.4);
      doc.line(margin, y, margin + contentWidth, y);
      y += 4;
      scoredCreatives.forEach(function(t, i) {
        checkPage(9);
        var cplStr = t.leads > 0 ? formatEUR(t.cpl) : '\u2014';
        if (i % 2 === 1) {
          doc.setFillColor(248, 249, 251);
          doc.rect(margin, y - 4.5, contentWidth, 7, 'F');
        }
        pdfDrawTableRow(doc, margin, y, [String(i + 1), formatCreativeType(t.type), String(t.leads), cplStr, String(t.score)], crColWidths, {
          bold: false, fontSize: 9, align: crAlign
        });
        y += 7;
      });
      y += 6;
    }

    // ---- 7. CAMPAIGN TABLE ----
    checkPage(20);
    pdfDrawSectionTitle(doc, margin, y, 'Kampagnen-√úbersicht');
    y += 5;

    // Compute per-campaign metrics in current filter
    var campMetricsMap = {};
    metrics.forEach(function(m) {
      if (!campMetricsMap[m.campaign_id]) campMetricsMap[m.campaign_id] = { spend: 0, leads: 0, impressions: 0, clicks: 0 };
      campMetricsMap[m.campaign_id].spend += parseFloat(m.spend) || 0;
      campMetricsMap[m.campaign_id].leads += parseInt(m.leads) || 0;
      campMetricsMap[m.campaign_id].impressions += parseInt(m.impressions) || 0;
      campMetricsMap[m.campaign_id].clicks += parseInt(m.clicks) || 0;
    });

    var tblColWidths = [contentWidth * 0.32, contentWidth * 0.14, contentWidth * 0.18, contentWidth * 0.12, contentWidth * 0.12, contentWidth * 0.12];
    var tblAlign = ['left', 'left', 'right', 'right', 'right', 'right'];

    // Table header
    pdfDrawTableRow(doc, margin, y, ['Objekt', 'Status', 'Ausgaben', 'Leads', 'CPL', 'Impressions'], tblColWidths, {
      bold: true, fontSize: 9, color: [156, 163, 175], bg: [248, 249, 251], rowH: 8, align: tblAlign
    });
    y += 1;
    doc.setDrawColor(232, 234, 237);
    doc.setLineWidth(0.4);
    doc.line(margin, y, margin + contentWidth, y);
    y += 4;

    // Sort campaigns by spend descending
    var sortedCampaigns = campaigns.slice().sort(function(a, b) {
      var sa = campMetricsMap[a.id] ? campMetricsMap[a.id].spend : 0;
      var sb = campMetricsMap[b.id] ? campMetricsMap[b.id].spend : 0;
      return sb - sa;
    });

    sortedCampaigns.forEach(function(c, idx) {
      checkPage(9);
      var fm = campMetricsMap[c.id] || { spend: 0, leads: 0, impressions: 0, clicks: 0 };
      var cpl = fm.leads > 0 ? formatEUR(fm.spend / fm.leads) : '\u2014';
      var statusLabel = c.status === 'active' ? 'Aktiv' : c.status === 'paused' ? 'Pausiert' : 'Abgeschl.';
      var name = (c.property && c.property.name) || c.campaign_name || '\u2014';

      if (idx % 2 === 1) {
        doc.setFillColor(248, 249, 251);
        doc.rect(margin, y - 4.5, contentWidth, 7, 'F');
      }
      pdfDrawTableRow(doc, margin, y, [name, statusLabel, formatEUR(fm.spend), String(fm.leads), cpl, formatNum(fm.impressions)], tblColWidths, {
        bold: false, fontSize: 9, align: tblAlign
      });
      y += 7;
    });

    // ---- 8. FOOTER (all pages) ----
    pdfDrawFooter(doc, margin, dateStr);

    // Save
    doc.save(buildPdfFilename('overview'));

  } catch (e) {
    console.error('PDF export error:', e);
    alert('PDF-Export fehlgeschlagen: ' + e.message);
  }

  btn.disabled = false;
  btn.innerHTML = '\uD83D\uDCC4 <span class="btn-label">Report exportieren</span>';
}

// ============================================
// PDF EXPORT ‚Äî SINGLE CAMPAIGN
// ============================================
async function exportCampaignPDF() {
  if (!currentDetailCampaignId) return;
  var campaign = campaigns.find(function(c) { return c.id === currentDetailCampaignId; });
  if (!campaign) return;

  var btn = document.getElementById('campaignPdfBtn');
  btn.disabled = true;
  btn.innerHTML = '\u23F3 Erstellen\u2026';

  try {
    var { jsPDF } = window.jspdf;
    var doc = new jsPDF('p', 'mm', 'a4');

    // Setup font for umlaut support
    await setupPDFFont(doc);

    var pageWidth = 210;
    var margin = 18;
    var contentWidth = pageWidth - margin * 2;
    var y = margin;

    function checkPage(needed) {
      if (y + needed > 278) { doc.addPage(); y = margin; }
    }

    // Gather data
    var prop = campaign.property || {};
    var campMetrics = getFilteredMetrics().filter(function(m) { return m.campaign_id === currentDetailCampaignId; });

    var totalSpend = 0, totalLeads = 0, totalImpressions = 0, totalClicks = 0;
    campMetrics.forEach(function(m) {
      totalSpend += parseFloat(m.spend) || 0;
      totalLeads += parseInt(m.leads) || 0;
      totalImpressions += parseInt(m.impressions) || 0;
      totalClicks += parseInt(m.clicks) || 0;
    });
    var avgCPL = totalLeads > 0 ? totalSpend / totalLeads : 0;
    var avgCTR = totalImpressions > 0 ? (totalClicks / totalImpressions) * 100 : 0;

    var dateStr = new Date().toLocaleDateString('de-DE', { day: '2-digit', month: 'long', year: 'numeric' });
    var campaignName = prop.name || campaign.campaign_name || '\u2014';
    var dateRange = formatDateRange(campaign.start_date, campaign.end_date);

    // ---- 1. LOGO ----
    var logoB64 = await loadLogoBase64();
    if (logoB64) {
      try { doc.addImage(logoB64, 'PNG', margin, y, 12, 12); } catch(e) { /* skip */ }
    }

    // ---- 2. HEADER ----
    doc.setFont('Inter', 'bold');
    doc.setFontSize(18);
    doc.setTextColor(17, 24, 39);
    doc.text(campaignName, margin + (logoB64 ? 16 : 0), y + 5);

    doc.setFont('Inter', 'normal');
    doc.setFontSize(10);
    doc.setTextColor(107, 114, 128);
    doc.text((clientData.name || '') + ' \u2014 ' + dateRange, margin + (logoB64 ? 16 : 0), y + 11);

    // Date on right
    doc.setFontSize(8);
    doc.setTextColor(156, 163, 175);
    doc.text('Erstellt am', pageWidth - margin, y + 3, { align: 'right' });
    doc.setFontSize(9);
    doc.setTextColor(107, 114, 128);
    doc.setFont('Inter', 'bold');
    doc.text(dateStr, pageWidth - margin, y + 8, { align: 'right' });

    y += 16;

    // Header separator
    doc.setDrawColor(232, 234, 237);
    doc.setLineWidth(0.5);
    doc.line(margin, y, pageWidth - margin, y);
    y += 8;

    // ---- 3. PROPERTY DETAILS (if available) ----
    var propFields = [];
    if (prop.property_type) propFields.push(['Objekttyp', formatPropertyType(prop.property_type)]);
    if (prop.rooms) propFields.push(['Zimmer', String(prop.rooms)]);
    if (prop.area_sqm) propFields.push(['Flaeche', prop.area_sqm + ' m\u00b2']);
    if (prop.price) propFields.push(['Preis', formatEUR(prop.price)]);
    if (prop.city) propFields.push(['Stadt', prop.city]);
    if (campaign.platform) propFields.push(['Plattform', campaign.platform]);

    if (propFields.length > 0) {
      checkPage(20);
      pdfDrawRoundedRect(doc, margin, y, contentWidth, 18, 3, [248, 249, 251]);
      doc.setDrawColor(238, 240, 243);
      doc.setLineWidth(0.3);
      doc.roundedRect(margin, y, contentWidth, 18, 3, 3, 'S');

      var pfW = contentWidth / propFields.length;
      propFields.forEach(function(pf, pi) {
        var px = margin + pi * pfW + 6;
        doc.setFont('Inter', 'bold');
        doc.setFontSize(8);
        doc.setTextColor(156, 163, 175);
        doc.text(pf[0].toUpperCase(), px, y + 7);
        doc.setFont('Inter', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(17, 24, 39);
        doc.text(String(pf[1]), px, y + 13);
      });
      y += 24;
    }

    // ---- 4. KPI CARDS (3x2 grid) ----
    var kpiData = [
      ['Ausgaben', formatEUR(totalSpend)],
      ['Leads', String(totalLeads)],
      ['CPL', formatEUR(avgCPL)],
      ['Impressions', formatNum(totalImpressions)],
      ['Klicks', formatNum(totalClicks)],
      ['CTR', avgCTR.toFixed(2) + '%']
    ];
    var cardW = (contentWidth - 8) / 3;
    var cardH = 28;
    for (var ki = 0; ki < kpiData.length; ki++) {
      var col = ki % 3;
      var row = Math.floor(ki / 3);
      var cx = margin + col * (cardW + 4);
      var cy = y + row * (cardH + 4);
      pdfDrawKpiCard(doc, cx, cy, cardW, cardH, kpiData[ki][0], kpiData[ki][1]);
    }
    y += cardH * 2 + 4 + 10;

    // ---- 5. DAILY CHART ----
    checkPage(75);
    pdfDrawSectionTitle(doc, margin, y, 'Tagesverlauf');
    y += 5;

    var sorted = campMetrics.slice().sort(function(a, b) { return a.date.localeCompare(b.date); });
    var chartImg = await renderChartToImage(
      pdfChartConfig(
        sorted.map(function(m) { return formatDateShort(m.date); }),
        sorted.map(function(m) { return parseInt(m.leads) || 0; }),
        sorted.map(function(m) { return parseFloat(m.spend) || 0; })
      ),
      1400, 520
    );

    doc.setDrawColor(238, 240, 243);
    doc.setLineWidth(0.3);
    doc.roundedRect(margin, y, contentWidth, 58, 3, 3, 'S');
    doc.addImage(chartImg, 'PNG', margin + 2, y + 2, contentWidth - 4, 54);
    y += 64;

    // ---- 6. BENCHMARK INSIGHTS ----
    var insights = collectBenchmarkInsights(totalSpend, totalLeads, totalImpressions, totalClicks);
    if (insights.length > 0) {
      checkPage(10 + insights.length * 9);
      pdfDrawSectionTitle(doc, margin, y, 'Performance Insights');
      y += 5;
      insights.forEach(function(text) {
        checkPage(10);
        doc.setFillColor(22, 163, 74);
        doc.rect(margin, y, 1.2, 7, 'F');
        pdfDrawRoundedRect(doc, margin + 1.5, y, contentWidth - 1.5, 7, 2, [240, 253, 244]);
        doc.setFont('Inter', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(75, 85, 99);
        doc.text(text, margin + 4, y + 4.5);
        y += 9;
      });
      y += 4;
    }

    // ---- 7. CREATIVE PERFORMANCE TABLE ----
    var campCreatives = allCreatives.filter(function(c) { return c.campaign_id === currentDetailCampaignId; });
    var scoredCreatives = collectScoredCreatives(campCreatives);
    if (scoredCreatives.length > 0) {
      checkPage(14 + scoredCreatives.length * 8);
      pdfDrawSectionTitle(doc, margin, y, 'Creative Performance');
      y += 5;
      var crColWidths = [12, contentWidth - 12 - 22 - 24 - 22, 22, 24, 22];
      var crAlign = ['left', 'left', 'right', 'right', 'right'];
      pdfDrawTableRow(doc, margin, y, ['#', 'Creative', 'Leads', 'CPL', 'Score'], crColWidths, {
        bold: true, fontSize: 9, color: [156, 163, 175], bg: [248, 249, 251], rowH: 8, align: crAlign
      });
      y += 1;
      doc.setDrawColor(232, 234, 237);
      doc.setLineWidth(0.4);
      doc.line(margin, y, margin + contentWidth, y);
      y += 4;
      scoredCreatives.forEach(function(t, i) {
        checkPage(9);
        var cplStr = t.leads > 0 ? formatEUR(t.cpl) : '\u2014';
        if (i % 2 === 1) {
          doc.setFillColor(248, 249, 251);
          doc.rect(margin, y - 4.5, contentWidth, 7, 'F');
        }
        pdfDrawTableRow(doc, margin, y, [String(i + 1), formatCreativeType(t.type), String(t.leads), cplStr, String(t.score)], crColWidths, {
          bold: false, fontSize: 9, align: crAlign
        });
        y += 7;
      });
      y += 6;
    }

    // ---- 8. FOOTER ----
    pdfDrawFooter(doc, margin, dateStr);

    // Save
    doc.save(buildPdfFilename('campaign', campaignName));

  } catch (e) {
    console.error('Campaign PDF export error:', e);
    alert('PDF-Export fehlgeschlagen: ' + e.message);
  }

  btn.disabled = false;
  btn.innerHTML = '\uD83D\uDCC4 PDF Export';
}

// ============================================
// FORMATTING HELPERS
// ============================================
function formatEUR(value) {
  if (value === null || value === undefined || isNaN(value)) return '‚Äî';
  return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(value);
}

function formatNum(value) {
  if (value === null || value === undefined || isNaN(value)) return '‚Äî';
  return new Intl.NumberFormat('de-DE').format(Math.round(value));
}

function formatDateRange(start, end) {
  if (!start) return '‚Äî';
  const fmt = d => new Date(d).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit' });
  return end ? `${fmt(start)} ‚Äì ${fmt(end)}` : `ab ${fmt(start)}`;
}

function formatDateShort(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
}

function formatPropertyType(type) {
  const map = {
    'wohnung': 'Wohnung',
    'haus': 'Haus',
    'penthouse': 'Penthouse',
    'villa': 'Villa',
    'reihenhaus': 'Reihenhaus',
    'grundstueck': 'Grundst√ºck',
    'gewerbe': 'Gewerbe',
    'sonstige': 'Sonstige'
  };
  return map[type] || type || '‚Äî';
}

const CREATIVE_LABELS = {
  'th_reel': 'Talking Head Reel',
  'scn_reel': 'Szenisches Reel',
  'single_image': 'Einzelbild',
  'carousel': 'Carousel',
  'reel': 'Video Reel',
  'video': 'Video',
  'story': 'Story',
  'sonstige': 'Sonstige'
};

function formatCreativeType(type) {
  return CREATIVE_LABELS[type] || type || '‚Äî';
}

function escHtml(str) {
  if (!str) return '';
  const el = document.createElement('span');
  el.textContent = str;
  return el.innerHTML;
}

// ============================================
// KEYBOARD SHORTCUTS
// ============================================
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeDetail();
  if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') attemptLogin();
});

document.getElementById('tokenInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') attemptLogin();
});

// ============================================
// INIT
// ============================================
checkAutoLogin();
</script>
</body>
</html>
