<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Run & Gun — Command Center</title>
  <link rel="icon" type="image/png" href="assets/rg-logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #fafafa;
      --bg-card: #f5f5f5;
      --bg-card-hover: #efefef;
      --bg-input: #f5f5f5;
      --border: #e5e5e5;
      --border-focus: #e7352e;
      --text-primary: #0a0a0a;
      --text-secondary: #595959;
      --text-muted: #8f8f8f;
      --accent: #e7352e;
      --accent-light: #e05c58;
      --accent-dark: #c42d27;
      --green: #16a34a;
      --green-muted: #dcfce7;
      --red: #dc2626;
      --red-muted: #fee2e2;
      --orange: #ea580c;
      --orange-muted: #fff7ed;
      --blue: #2563eb;
      --cyan: #0891b2;
      --gold: #ca8a04;
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-lg: 0 4px 16px rgba(0,0,0,0.08);
      --transition: 180ms ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Top Nav */
    .topnav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: #ffffff;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .topnav-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .topnav-logo {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      object-fit: cover;
    }

    .topnav-title {
      font-weight: 700;
      font-size: 16px;
      letter-spacing: -0.02em;
    }

    .topnav-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .topnav-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Hamburger button - hidden on desktop */
    .topnav-burger {
      display: none;
      flex-direction: column;
      justify-content: center;
      gap: 5px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      z-index: 102;
    }
    .topnav-burger span {
      display: block;
      width: 22px;
      height: 2px;
      background: var(--text-primary);
      border-radius: 2px;
      transition: all 0.3s ease;
    }
    .topnav-burger.open span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    .topnav-burger.open span:nth-child(2) {
      opacity: 0;
    }
    .topnav-burger.open span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }
    .btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--bg-card-hover); border-color: var(--text-muted); }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
    }
    .btn-ghost:hover { color: var(--text-primary); background: var(--bg-card); }
    .btn-ghost.active { color: var(--accent); background: rgba(231, 53, 46, 0.08); }

    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-icon { padding: 8px; }

    /* Main Content */
    .main {
      padding-top: 64px;
      min-height: 100vh;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 32px;
    }

    /* Page Header */
    .page-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 32px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .page-title {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.03em;
      line-height: 1.2;
    }

    .page-subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin-top: 4px;
    }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .kpi-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: all var(--transition);
    }

    .kpi-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .kpi-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.03em;
      line-height: 1;
    }

    .kpi-unit {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-left: 4px;
    }

    .kpi-change {
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .kpi-change.positive { color: var(--green); }
    .kpi-change.negative { color: var(--red); }
    .kpi-change.neutral { color: var(--text-muted); }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .card-body { padding: 24px; }

    /* Chart containers */
    .chart-container {
      position: relative;
      width: 100%;
      height: 320px;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 32px;
    }

    @media (max-width: 900px) {
      .charts-grid { grid-template-columns: 1fr; }
    }

    /* Campaign List */
    .campaign-table {
      width: 100%;
      border-collapse: collapse;
    }

    .campaign-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
    }

    .campaign-table td {
      padding: 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    .campaign-table tbody tr {
      cursor: pointer;
      transition: background var(--transition);
    }

    .campaign-table tbody tr:hover {
      background: var(--bg-card-hover);
    }

    .campaign-table tbody tr:last-child td {
      border-bottom: none;
    }

    .campaign-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .campaign-property {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    /* Status badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .badge-active {
      background: rgba(34, 197, 94, 0.1);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .badge-paused {
      background: rgba(245, 158, 11, 0.1);
      color: var(--orange);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .badge-completed {
      background: rgba(37, 99, 235, 0.08);
      color: var(--blue);
      border: 1px solid rgba(37, 99, 235, 0.2);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Value formatting */
    .value-eur { font-variant-numeric: tabular-nums; }
    .value-good { color: var(--green); }
    .value-bad { color: var(--red); }
    .value-neutral { color: var(--text-secondary); }

    /* Forms */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group.full-width { grid-column: 1 / -1; }

    .form-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .form-input, .form-select {
      padding: 10px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      transition: border-color var(--transition);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(231, 53, 46, 0.12);
    }

    .form-input::placeholder { color: var(--text-muted); }

    .form-select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .form-section-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      grid-column: 1 / -1;
    }

    .form-actions {
      grid-column: 1 / -1;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 16px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    /* Back button */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 16px;
      cursor: pointer;
      transition: color var(--transition);
    }

    .back-link:hover { color: var(--accent); }

    /* Creative cards */
    .creative-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .creative-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: all var(--transition);
      position: relative;
    }

    .creative-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .creative-card.winner {
      border-color: var(--gold);
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.1);
    }

    .creative-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .creative-card-name {
      font-weight: 600;
      font-size: 14px;
    }

    .creative-card-type {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .creative-card-badge {
      font-size: 20px;
      margin-right: 6px;
    }

    .creative-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .creative-stat-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .creative-stat-value {
      font-size: 18px;
      font-weight: 700;
      margin-top: 2px;
    }

    /* Score display */
    .score-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 700;
      background: rgba(231, 53, 46, 0.08);
      color: var(--accent);
      border: 1px solid rgba(231, 53, 46, 0.2);
    }

    .score-badge.top { 
      background: rgba(251, 191, 36, 0.1); 
      color: var(--gold); 
      border-color: rgba(251, 191, 36, 0.3); 
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 80px 40px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .empty-state-desc {
      font-size: 14px;
      max-width: 400px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* Setup banner */
    .setup-banner {
      background: linear-gradient(135deg, rgba(231,53,46,0.05), rgba(8,145,178,0.05));
      border: 1px solid rgba(231,53,46,0.15);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 32px;
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    .setup-banner-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .setup-banner-content h3 {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .setup-banner-content p {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .setup-banner-content code {
      background: var(--bg-input);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      color: var(--accent);
    }

    /* Loading */
    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Notification toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 20px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      transform: translateY(120%);
      transition: transform 300ms ease;
      z-index: 200;
    }

    .toast.visible { transform: translateY(0); }
    .toast.success { border-color: var(--green); color: var(--green); }
    .toast.error { border-color: var(--red); color: var(--red); }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0;
    }

    .tab {
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all var(--transition);
    }

    .tab:hover { color: var(--text-secondary); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    /* Filter bar */
    .filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-bar .form-select, .filter-bar .form-input {
      padding: 8px 12px;
      font-size: 13px;
    }

    /* Intelligence view */
    .intel-section {
      margin-bottom: 40px;
    }

    .intel-section-title {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .intel-ranking-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .intel-type-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: all var(--transition);
      position: relative;
    }

    .intel-type-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .intel-type-card.winner {
      border-color: var(--gold);
      box-shadow: 0 0 24px rgba(251, 191, 36, 0.12);
    }

    .intel-type-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .intel-type-name {
      font-size: 16px;
      font-weight: 700;
    }

    .intel-type-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }

    .intel-stat-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .intel-stat-value {
      font-size: 18px;
      font-weight: 700;
      margin-top: 2px;
    }

    .ranking-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .ranking-tab {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: var(--bg-card);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      transition: all var(--transition);
    }

    .ranking-tab:hover { border-color: var(--text-muted); }
    .ranking-tab.active {
      background: rgba(231, 53, 46, 0.08);
      color: var(--accent);
      border-color: var(--accent);
    }

    .locked-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 48px;
      text-align: center;
      opacity: 0.7;
    }

    .locked-section .lock-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .locked-section h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .locked-section p {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Horizontal bar chart */
    .hbar-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .hbar-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .hbar-label {
      min-width: 120px;
      font-size: 13px;
      font-weight: 600;
      text-align: right;
      flex-shrink: 0;
    }

    .hbar-track {
      flex: 1;
      height: 32px;
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      overflow: hidden;
      position: relative;
    }

    .hbar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      border-radius: var(--radius-sm);
      transition: width 600ms ease;
      display: flex;
      align-items: center;
      padding-left: 10px;
      font-size: 12px;
      font-weight: 700;
      color: white;
      min-width: fit-content;
    }

    .hbar-fill.winner-bar {
      background: linear-gradient(90deg, var(--gold), #f59e0b);
    }

    .hbar-value {
      min-width: 60px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    /* Table scroll wrapper */
    .table-scroll-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin: 0 -24px;
      padding: 0 24px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 16px; padding-top: 80px; }
      .topnav { padding: 0 16px; }
      .page-title { font-size: 20px; }
      .page-subtitle { font-size: 13px; }
      .page-header { margin-bottom: 20px; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
      .form-grid { grid-template-columns: 1fr !important; }
      .topnav-subtitle { display: none; }
      .intel-ranking-grid { grid-template-columns: 1fr; }
      .hbar-label { min-width: 80px; font-size: 11px; }

      /* Hamburger menu */
      .topnav-burger {
        display: flex;
      }
      .topnav-actions {
        position: fixed;
        top: 64px;
        left: 0;
        right: 0;
        background: #ffffff;
        border-bottom: 1px solid var(--border);
        box-shadow: var(--shadow-lg);
        flex-direction: column;
        padding: 12px 16px;
        gap: 4px;
        transform: translateY(-100%);
        opacity: 0;
        pointer-events: none;
        transition: transform 0.3s ease, opacity 0.3s ease;
        z-index: 99;
      }
      .topnav-actions.open {
        transform: translateY(0);
        opacity: 1;
        pointer-events: all;
      }
      .topnav-actions .btn {
        width: 100%;
        text-align: left;
        justify-content: flex-start;
        padding: 12px 16px;
        font-size: 15px;
        border-radius: var(--radius);
      }
      .topnav-actions .btn:hover,
      .topnav-actions .btn.active {
        background: rgba(231, 53, 46, 0.06);
      }

      /* Table scroll */
      .table-scroll-wrapper {
        margin: 0 -16px;
        padding: 0 16px;
      }
      .campaign-table {
        min-width: 700px;
      }

      /* Cards */
      .card-body { padding: 16px; }
      .card-header { padding: 14px 16px; }

      /* Tabs wrap nicely on mobile */
      .tabs { flex-wrap: wrap; gap: 6px; }
      .tab { font-size: 12px; padding: 6px 12px; flex: 0 0 auto; }

      /* Predictor layout stacks vertically */
      .predictor-layout { grid-template-columns: 1fr !important; }

      /* Detail property info grid */
      #detail-property-info { grid-template-columns: repeat(2, 1fr) !important; gap: 12px !important; }

      /* Chart containers */
      .chart-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Benchmark grid */
      .benchmark-grid { grid-template-columns: repeat(2, 1fr) !important; }

      /* Compare grid */
      .compare-grid { grid-template-columns: 1fr !important; }

      /* Data intelligence */
      .data-intel-grid { grid-template-columns: 1fr !important; }

      /* Modals */
      .modal-content, [style*="max-width: 600px"] {
        width: 95vw !important;
        max-width: 95vw !important;
        margin: 16px auto;
        max-height: 90vh;
        overflow-y: auto;
      }
    }

    @media (max-width: 480px) {
      .kpi-grid { grid-template-columns: 1fr; }
      .kpi-value { font-size: 24px; }
      .tab { font-size: 11px; padding: 5px 10px; }
      #detail-property-info { grid-template-columns: 1fr !important; }
      .benchmark-grid { grid-template-columns: 1fr !important; }
    }

    /* Benchmark card */
    .benchmark-card {
      background: var(--bg-card);
      border: 1px solid transparent;
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 32px;
      background-clip: padding-box;
      position: relative;
    }
    .benchmark-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: var(--radius);
      padding: 1px;
      background: linear-gradient(135deg, var(--accent), var(--cyan), var(--accent-light));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
      opacity: 0.6;
    }
    .benchmark-card .card-header { border-bottom: 1px solid var(--border); }
    .benchmark-card .card-body { padding: 24px; }

    .benchmark-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .benchmark-metric {
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      padding: 14px;
    }
    .benchmark-metric-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .benchmark-metric-value {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .benchmark-metric-compare {
      font-size: 12px;
      font-weight: 600;
    }

    .benchmark-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }
    .benchmark-badge.good {
      background: rgba(34, 197, 94, 0.12);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, 0.25);
    }
    .benchmark-badge.bad {
      background: rgba(239, 68, 68, 0.12);
      color: var(--red);
      border: 1px solid rgba(239, 68, 68, 0.25);
    }
    .benchmark-badge.neutral {
      background: rgba(136, 136, 160, 0.12);
      color: var(--text-secondary);
      border: 1px solid rgba(136, 136, 160, 0.25);
    }

    .benchmark-insights {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .benchmark-insights-title {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--text-secondary);
    }

    .insight-item {
      font-size: 13px;
      color: var(--text-secondary);
      padding: 6px 0;
      line-height: 1.5;
    }
    .insight-item::before {
      content: '•';
      color: var(--accent);
      margin-right: 8px;
      font-weight: 700;
    }

    /* Smart Campaign-Specific Insights */
    .smart-insights {
      margin-top: 20px;
      border-top: 1px solid var(--border);
      padding-top: 16px;
    }
    .smart-insights-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 14px;
      color: var(--text-primary);
    }
    .smart-insight-item {
      display: flex;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .smart-insight-item:last-child {
      border-bottom: none;
    }
    .smart-insight-icon {
      font-size: 18px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .smart-insight-content {
      flex: 1;
    }
    .smart-insight-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .smart-insight-text {
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-secondary);
    }
    .smart-insight-text strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .benchmark-sample-note {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 12px;
      font-style: italic;
    }

    /* Correlation bar */
    .correlation-bar-container {
      margin-bottom: 14px;
    }
    .correlation-bar-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .correlation-bar-track {
      height: 24px;
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      position: relative;
      overflow: hidden;
    }
    .correlation-bar-center {
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--text-muted);
      opacity: 0.4;
    }
    .correlation-bar-fill {
      position: absolute;
      top: 2px;
      bottom: 2px;
      border-radius: 4px;
      transition: all 600ms ease;
    }
    .correlation-bar-fill.positive {
      background: linear-gradient(90deg, rgba(239,68,68,0.3), var(--red));
    }
    .correlation-bar-fill.negative {
      background: linear-gradient(270deg, rgba(34,197,94,0.3), var(--green));
    }
    .correlation-bar-sublabel {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    /* Segment table */
    .segment-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .segment-table th {
      text-align: left;
      padding: 10px 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      background: var(--bg-input);
    }
    .segment-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    .segment-table tbody tr:last-child td { border-bottom: none; }
    .segment-table tbody tr:hover { background: var(--bg-card-hover); }
    .segment-cell-good { color: var(--green); font-weight: 600; }
    .segment-cell-bad { color: var(--red); font-weight: 600; }

    /* Scatter plot container */
    .scatter-container {
      position: relative;
      width: 100%;
      height: 400px;
    }

    /* Data intel sections */
    .data-intel-section {
      margin-bottom: 40px;
    }
    .data-intel-section-title {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .data-intel-warning {
      background: rgba(245, 158, 11, 0.08);
      border: 1px solid rgba(245, 158, 11, 0.25);
      border-radius: var(--radius-sm);
      padding: 10px 16px;
      font-size: 12px;
      color: var(--orange);
      margin-bottom: 20px;
    }
    .data-intel-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .data-intel-grid { grid-template-columns: 1fr; }
    }

    /* Live tracking badge */
    .badge-live {
      background: rgba(34, 197, 94, 0.1);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, 0.2);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .live-banner {
      background: linear-gradient(135deg, rgba(34,197,94,0.08), rgba(8,145,178,0.05));
      border: 1px solid rgba(34,197,94,0.25);
      border-radius: var(--radius);
      padding: 16px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      font-weight: 600;
      color: var(--green);
    }

    /* Meta Import View */
    .meta-campaign-search {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .meta-campaign-search .form-input {
      flex: 1;
    }

    .meta-filter-btns {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
    }
    .meta-filter-btn {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: var(--bg-card);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      transition: all var(--transition);
      font-family: inherit;
    }
    .meta-filter-btn:hover { border-color: var(--text-muted); }
    .meta-filter-btn.active {
      background: rgba(231, 53, 46, 0.08);
      color: var(--accent);
      border-color: var(--accent);
    }

    .meta-campaign-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .meta-campaign-row {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      transition: all var(--transition);
    }
    .meta-campaign-row:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow);
    }
    .meta-campaign-row .meta-camp-info { flex: 1; }
    .meta-campaign-row .meta-camp-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }
    .meta-campaign-row .meta-camp-details {
      font-size: 12px;
      color: var(--text-secondary);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* Link Modal */
    .meta-link-modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(4px);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .meta-link-modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 32px;
      max-width: 700px;
      width: 95vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }
    .meta-link-modal h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
    }
    .meta-link-section {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .meta-link-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .meta-link-section-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-secondary);
    }

    /* Sync progress */
    .meta-sync-progress {
      padding: 24px;
      text-align: center;
    }
    .meta-sync-progress .sync-step {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }
    .meta-sync-progress .sync-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-input);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .meta-sync-progress .sync-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--green));
      border-radius: 4px;
      transition: width 300ms ease;
    }
    .meta-sync-progress .sync-detail {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Success card */
    .meta-sync-success {
      text-align: center;
      padding: 32px 24px;
    }
    .meta-sync-success .success-icon { font-size: 48px; margin-bottom: 16px; }
    .meta-sync-success .success-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--green);
      margin-bottom: 8px;
    }
    .meta-sync-success .success-stats {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    /* View transitions */
    .view { display: none; }
    .view.active { display: block; animation: fadeIn 200ms ease; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Scroll margin for fixed nav */
    .main { scroll-margin-top: 64px; }

    /* CSV Import: Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      padding: 64px 40px;
      text-align: center;
      cursor: pointer;
      transition: all var(--transition);
      position: relative;
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: var(--accent);
      background: rgba(231, 53, 46, 0.03);
    }
    .drop-zone.drag-over {
      background: rgba(231, 53, 46, 0.06);
      transform: scale(1.005);
    }
    .drop-zone-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.7; }
    .drop-zone-text { font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
    .drop-zone-hint { font-size: 13px; color: var(--text-muted); }
    .drop-zone input[type="file"] {
      position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
    }

    /* CSV Preview Card */
    .csv-preview {
      background: linear-gradient(135deg, rgba(231,53,46,0.04), rgba(8,145,178,0.04));
      border: 1px solid rgba(231,53,46,0.2);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
    }
    .csv-preview-title {
      font-size: 15px; font-weight: 700; margin-bottom: 12px;
      display: flex; align-items: center; gap: 8px;
    }
    .csv-preview-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 6px 24px; font-size: 14px;
    }
    .csv-preview-grid dt { color: var(--text-muted); font-weight: 500; }
    .csv-preview-grid dd { color: var(--text-primary); font-weight: 600; margin: 0; }

    /* CSV Import Loading Overlay */
    .csv-import-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.3);
      display: flex; align-items: center; justify-content: center;
      z-index: 300; backdrop-filter: blur(4px);
    }
    .csv-import-overlay-box {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 40px 48px; text-align: center;
      box-shadow: var(--shadow-lg);
    }
    .csv-import-overlay-box .spinner { margin: 0 auto 16px; }
    .csv-import-overlay-text { font-size: 14px; font-weight: 600; color: var(--text-secondary); }

    /* Manual form toggle link */
    .manual-toggle-link {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 13px; color: var(--text-muted); cursor: pointer;
      margin-top: 24px; transition: color var(--transition);
    }
    .manual-toggle-link:hover { color: var(--text-secondary); }

    /* Predictor layout */
    .predictor-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      align-items: start;
    }
    @media (max-width: 900px) {
      .predictor-layout { grid-template-columns: 1fr; }
    }

    .pred-result-card {
      background: var(--bg-card);
      border: 1px solid transparent;
      border-radius: var(--radius);
      overflow: hidden;
      position: relative;
    }
    .pred-result-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: var(--radius);
      padding: 1px;
      background: linear-gradient(135deg, var(--accent), var(--cyan), var(--gold));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }
    .pred-result-card .card-body { padding: 24px; }

    .pred-section { margin-bottom: 20px; }
    .pred-section:last-child { margin-bottom: 0; }
    .pred-section-title {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .pred-cpl-range {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.03em;
      color: var(--text-primary);
      margin-bottom: 6px;
    }
    .pred-cpl-details {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .pred-stars {
      font-size: 24px;
      letter-spacing: 2px;
    }
    .pred-stars .star-active { color: var(--gold); }
    .pred-stars .star-inactive { color: var(--text-muted); opacity: 0.3; }
    .pred-score-label {
      font-size: 13px;
      font-weight: 600;
      margin-top: 4px;
    }
    .pred-score-green { color: var(--green); }
    .pred-score-yellow-green { color: #a3e635; }
    .pred-score-yellow { color: var(--orange); }
    .pred-score-orange { color: #f97316; }
    .pred-score-red { color: var(--red); }

    .pred-similar-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      font-size: 13px;
    }
    .pred-similar-name { font-weight: 600; }
    .pred-similar-detail { color: var(--text-secondary); }

    .pred-confidence {
      font-size: 12px;
      color: var(--text-muted);
      padding: 10px 14px;
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      line-height: 1.5;
    }

    /* Compare grid */
    .compare-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .compare-input-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      position: relative;
    }
    .compare-input-card .form-group { margin-bottom: 12px; }
    .compare-input-card .form-group:last-child { margin-bottom: 0; }
    .compare-card-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 14px;
      color: var(--text-secondary);
    }
    .compare-remove-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      padding: 4px;
      transition: color var(--transition);
    }
    .compare-remove-btn:hover { color: var(--red); }

    .add-property-btn {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      background: transparent;
      color: var(--text-muted);
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      padding: 40px 20px;
      transition: all var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 200px;
    }
    .add-property-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(231, 53, 46, 0.03);
    }

    .comp-ranking {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 24px;
    }
    .comp-ranking-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 18px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      transition: all var(--transition);
    }
    .comp-ranking-item:first-child {
      border-color: var(--gold);
      box-shadow: 0 0 16px rgba(251, 191, 36, 0.08);
    }
    .comp-ranking-medal { font-size: 24px; flex-shrink: 0; }
    .comp-ranking-name { font-weight: 700; font-size: 15px; flex: 1; }
    .comp-ranking-cpl { font-weight: 700; font-size: 15px; }
    .comp-ranking-stars { font-size: 14px; }

    .comp-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-bottom: 24px;
    }
    .comp-table th {
      text-align: left;
      padding: 10px 14px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      background: var(--bg-input);
    }
    .comp-table td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    .comp-table tbody tr:last-child td { border-bottom: none; }
    .comp-table tbody tr:hover { background: var(--bg-card-hover); }

    .comp-recommendation {
      font-size: 14px;
      font-weight: 600;
      color: var(--green);
      padding: 12px 16px;
      background: rgba(34, 197, 94, 0.08);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: var(--radius-sm);
      margin-bottom: 24px;
    }

    .comp-chart-container {
      position: relative;
      width: 100%;
      height: 250px;
      margin-bottom: 16px;
    }

    /* Advanced Prediction Engine Styles */
    .confidence-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-input);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }
    .confidence-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 600ms ease;
      background: linear-gradient(90deg, var(--red), var(--orange), var(--green));
    }
    .similarity-inline-bar {
      display: inline-block;
      width: 60px;
      height: 6px;
      background: var(--bg-input);
      border-radius: 3px;
      overflow: hidden;
      vertical-align: middle;
      margin-left: 6px;
    }
    .similarity-inline-bar-fill {
      height: 100%;
      border-radius: 3px;
      background: var(--accent-light);
      transition: width 400ms ease;
    }
    .feature-importance-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .feature-importance-bar .fi-label {
      min-width: 100px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-align: right;
      flex-shrink: 0;
    }
    .feature-importance-bar .fi-track {
      flex: 1;
      height: 18px;
      background: var(--bg-input);
      border-radius: 4px;
      overflow: hidden;
    }
    .feature-importance-bar .fi-fill {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      transition: width 500ms ease;
      display: flex;
      align-items: center;
      padding-left: 6px;
      font-size: 10px;
      font-weight: 700;
      color: white;
      min-width: fit-content;
    }
    .feature-importance-bar .fi-pct {
      min-width: 36px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-align: right;
      flex-shrink: 0;
    }
    /* Creative Recommendation Styles */
    .creative-rec-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .creative-rec-item:last-of-type {
      border-bottom: none;
    }
    .creative-rec-badge {
      font-size: 20px;
      min-width: 28px;
      text-align: center;
      flex-shrink: 0;
    }
    .creative-rec-info {
      flex: 1;
      min-width: 0;
    }
    .creative-rec-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 2px;
    }
    .creative-rec-stats {
      display: flex;
      gap: 14px;
      font-size: 12px;
      color: var(--text-secondary);
      flex-wrap: wrap;
    }
    .creative-rec-stats span {
      white-space: nowrap;
    }
    .creative-rec-bar-wrap {
      width: 100%;
      margin-top: 4px;
    }
    .creative-rec-bar {
      height: 6px;
      background: var(--bg-input);
      border-radius: 3px;
      overflow: hidden;
    }
    .creative-rec-bar-fill {
      height: 100%;
      border-radius: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      transition: width 600ms ease;
    }
    .creative-rec-tip {
      margin-top: 14px;
      padding: 12px 14px;
      background: rgba(231, 53, 46, 0.04);
      border-left: 3px solid var(--accent);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    .creative-rec-tip strong {
      color: var(--text-primary);
    }
    .creative-rec-empty {
      font-size: 13px;
      color: var(--text-muted);
      padding: 10px 0;
    }

    .prediction-main {
      text-align: center;
      padding: 20px 0;
    }
    .prediction-main .pred-cpl-big {
      font-size: 36px;
      font-weight: 800;
      letter-spacing: -0.03em;
      line-height: 1;
    }
    .prediction-main .pred-cpl-big.cpl-green { color: var(--green); }
    .prediction-main .pred-cpl-big.cpl-yellow { color: var(--orange); }
    .prediction-main .pred-cpl-big.cpl-red { color: var(--red); }
    .prediction-main .pred-range-text {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 6px;
    }
    .prediction-breakdown {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .prediction-breakdown .pb-item {
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
    }
    .prediction-breakdown .pb-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .prediction-breakdown .pb-value {
      font-size: 16px;
      font-weight: 700;
    }
    .prediction-section {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .prediction-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .prediction-section-header {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .pred-method-badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
    }
    .pred-method-badge.early {
      background: rgba(245, 158, 11, 0.1);
      color: var(--orange);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    .pred-method-badge.limited {
      background: rgba(37, 99, 235, 0.08);
      color: var(--blue);
      border: 1px solid rgba(37, 99, 235, 0.2);
    }
    .pred-method-badge.full {
      background: rgba(34, 197, 94, 0.1);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    /* ============================================ */
    /* COMPETITOR WATCH */
    /* ============================================ */
    .comp-watchlist-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .comp-brand-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: all var(--transition);
      position: relative;
    }

    .comp-brand-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .comp-brand-card.inactive {
      opacity: 0.5;
    }

    .comp-brand-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .comp-brand-name {
      font-size: 16px;
      font-weight: 700;
      line-height: 1.3;
    }

    .comp-brand-page {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .comp-brand-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .comp-brand-actions button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      font-size: 14px;
      opacity: 0.6;
      transition: opacity var(--transition);
    }

    .comp-brand-actions button:hover {
      opacity: 1;
    }

    .comp-brand-stats {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .comp-brand-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .comp-brand-stat-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .comp-brand-stat-value {
      font-size: 16px;
      font-weight: 700;
    }

    .comp-brand-notes {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 8px;
      font-style: italic;
    }

    .comp-ads-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }

    .comp-ad-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: all var(--transition);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .comp-ad-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    /* Compact Ad Cards */
    .comp-ad-card-compact {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .comp-ad-card-compact:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .comp-ad-card-compact .compact-thumb {
      width: 56px;
      height: 56px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      background: var(--bg-darker);
    }
    .comp-ad-card-compact .compact-thumb-placeholder {
      width: 56px;
      height: 56px;
      border-radius: 8px;
      flex-shrink: 0;
      background: var(--bg-darker);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--text-muted);
    }
    .comp-ad-card-compact .compact-body {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .comp-ad-card-compact .compact-brand {
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .comp-ad-card-compact .compact-text {
      font-size: 12px;
      color: var(--text-muted);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.4;
    }
    .comp-ad-card-compact .compact-badges {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .comp-ad-card-compact .compact-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .compact-status-dot.active { background: var(--green); }
    .compact-status-dot.stopped { background: #6b7280; }

    /* Detail Modal */
    .ad-detail-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .ad-detail-overlay.visible {
      display: flex;
    }
    .ad-detail-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 28px;
      max-width: 600px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      animation: modalSlideIn 0.2s ease;
    }
    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .ad-detail-stat-card {
      background: var(--bg-darker);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      text-align: center;
    }
    .ad-detail-stat-card .stat-icon {
      font-size: 16px;
      margin-bottom: 2px;
    }
    .ad-detail-stat-card .stat-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
    }
    .ad-detail-stat-card .stat-label {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .comp-ad-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .comp-ad-brand-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      background: rgba(231, 53, 46, 0.06);
      color: var(--accent);
      border: 1px solid rgba(231, 53, 46, 0.15);
    }

    .comp-ad-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .comp-ad-body {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .comp-ad-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .comp-platform-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      background: var(--bg-input);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .comp-days-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
    }

    .comp-days-green {
      background: rgba(34, 197, 94, 0.1);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .comp-days-orange {
      background: rgba(245, 158, 11, 0.1);
      color: var(--orange);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .comp-days-red {
      background: rgba(239, 68, 68, 0.1);
      color: var(--red);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .comp-top-performer {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(239,68,68,0.1));
      color: var(--gold);
      border: 1px solid rgba(251,191,36,0.3);
    }

    .comp-ad-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-muted);
    }

    .comp-ad-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--accent-light);
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
      transition: color var(--transition);
    }

    .comp-ad-link:hover {
      color: var(--accent);
    }

    @media (max-width: 768px) {
      .comp-watchlist-grid { grid-template-columns: 1fr; }
      .comp-ads-grid { grid-template-columns: 1fr; }
    }

    /* Clickable KPI cards for competitor */
    .kpi-card.clickable {
      cursor: pointer;
      user-select: none;
    }
    .kpi-card.clickable:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* Flash highlight animation */
    @keyframes flashHighlight {
      0% { box-shadow: 0 0 0 0 rgba(231,53,46,0.6); }
      25% { box-shadow: 0 0 20px 4px rgba(231,53,46,0.4); border-color: var(--accent); }
      50% { box-shadow: 0 0 10px 2px rgba(231,53,46,0.2); }
      75% { box-shadow: 0 0 20px 4px rgba(231,53,46,0.4); border-color: var(--accent); }
      100% { box-shadow: none; border-color: var(--border); }
    }
    .comp-ad-card.flash-highlight {
      animation: flashHighlight 1.5s ease;
    }

    /* Collapsible section */
    .comp-collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      margin-bottom: 16px;
    }
    .comp-collapsible-header h2 {
      font-size: 18px;
      font-weight: 800;
      margin: 0;
    }
    .comp-collapsible-chevron {
      font-size: 14px;
      color: var(--text-muted);
      transition: transform 0.2s ease;
    }
    .comp-collapsible-body.collapsed {
      display: none;
    }

    /* Longevity Leaderboard */
    .comp-leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .comp-leaderboard-table th {
      text-align: left;
      padding: 10px 14px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      background: var(--bg-input);
    }
    .comp-leaderboard-table td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    .comp-leaderboard-table tbody tr {
      cursor: pointer;
      transition: background var(--transition);
    }
    .comp-leaderboard-table tbody tr:hover {
      background: var(--bg-card-hover);
    }
    .comp-leaderboard-table tbody tr:last-child td {
      border-bottom: none;
    }
    .comp-leaderboard-rank {
      font-weight: 800;
      font-size: 15px;
      min-width: 32px;
      text-align: center;
    }
    .comp-leaderboard-text {
      max-width: 250px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Brand Overview Cards */
    .comp-brand-overview-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    @media (max-width: 900px) {
      .comp-brand-overview-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .comp-brand-overview-grid { grid-template-columns: 1fr; }
    }
    .comp-brand-overview-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      transition: all var(--transition);
    }
    .comp-brand-overview-card:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow);
    }
    .comp-brand-overview-card .brand-name {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    .comp-brand-overview-card .brand-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 12px;
    }
    .comp-brand-overview-card .brand-stat-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .comp-brand-overview-card .brand-stat-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }
    .comp-brand-overview-card .brand-stat-val {
      font-size: 15px;
      font-weight: 700;
    }
    .comp-brand-overview-card .brand-platforms {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 10px;
    }

    /* Brand Overview: compact clickable cards */
    .comp-brand-overview-card {
      cursor: pointer;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .comp-brand-overview-card .brand-standort-count {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
      margin-top: 2px;
    }
    .comp-brand-overview-card.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
      background: rgba(231, 53, 46, 0.03);
    }

    /* Brand Detail Page */
    .brand-detail-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .brand-detail-back {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
      color: var(--text-secondary);
    }
    .brand-detail-back:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .brand-detail-title {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .brand-detail-pageid {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
      background: var(--bg-card);
      padding: 3px 10px;
      border-radius: 20px;
      border: 1px solid var(--border);
    }
    .brand-detail-insights {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }
    @media (max-width: 900px) {
      .brand-detail-insights { grid-template-columns: 1fr; }
    }
    .brand-insight-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .brand-insight-card h3 {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    .brand-insight-subtitle {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    .brand-insight-small-stat {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
      font-weight: 500;
    }
    .brand-timeframe-pills {
      display: flex;
      gap: 4px;
      margin-bottom: 10px;
    }
    .brand-tf-pill {
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      background: var(--bg-input);
      color: var(--text-muted);
      border: 1px solid var(--border);
      transition: all var(--transition);
      font-family: inherit;
    }
    .brand-tf-pill:hover { border-color: var(--text-muted); }
    .brand-tf-pill.active {
      background: rgba(231, 53, 46, 0.08);
      color: var(--accent);
      border-color: var(--accent);
    }
    .brand-sort-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
    }
    .brand-sort-tab {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: var(--bg-card);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      transition: all var(--transition);
      font-family: inherit;
    }
    .brand-sort-tab:hover { border-color: var(--text-muted); }
    .brand-sort-tab.active {
      background: rgba(231, 53, 46, 0.08);
      color: var(--accent);
      border-color: var(--accent);
    }
    .brand-insight-big {
      font-size: 32px;
      font-weight: 800;
      color: var(--orange);
      margin: 8px 0 12px 0;
      line-height: 1;
    }
    .brand-insight-bar-row {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      margin-bottom: 6px;
    }
    .brand-insight-bar-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      width: 30px;
      text-align: right;
      flex-shrink: 0;
    }
    .brand-insight-bar-track {
      flex: 1;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }
    .brand-insight-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.4s ease;
    }
    .brand-insight-bar-pct {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      width: 34px;
      flex-shrink: 0;
    }
    .brand-insight-stat-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .brand-insight-stat-row:last-child { border-bottom: none; }
    .brand-insight-stat-label {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .brand-insight-stat-val {
      font-size: 15px;
      font-weight: 700;
    }
    .brand-insight-mini-bar {
      display: flex;
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
      width: 100%;
      margin-top: 8px;
    }
    .brand-detail-feed-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .brand-detail-feed-header h2 {
      font-size: 18px;
      font-weight: 800;
      margin: 0;
    }
    .brand-detail-rank {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 1px solid var(--border);
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      flex-shrink: 0;
      margin-right: 8px;
    }
    .brand-detail-ad-row {
      display: flex;
      align-items: center;
      padding: 10px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      cursor: pointer;
      transition: all var(--transition);
    }
    .brand-detail-ad-row:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow);
    }
    .brand-detail-ad-body {
      flex: 1;
      min-width: 0;
    }
    .brand-detail-ad-text {
      font-size: 13px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }
    .brand-detail-ad-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }
    .brand-detail-ad-badges span {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
    }

    /* Breadcrumbs */
    .comp-breadcrumb {
      display: none;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .comp-breadcrumb.visible {
      display: flex;
    }
    .comp-breadcrumb .bc-item {
      color: var(--text-muted);
      cursor: pointer;
      transition: color var(--transition);
      font-weight: 500;
    }
    .comp-breadcrumb .bc-item:hover {
      color: var(--accent);
    }
    .comp-breadcrumb .bc-sep {
      color: var(--border);
      font-size: 11px;
    }
    .comp-breadcrumb .bc-current {
      color: var(--text-primary);
      font-weight: 700;
      cursor: default;
    }

    /* Competitor view: no horizontal scroll */
    #view-competitor {
      overflow-x: hidden;
    }

    /* Standort search input in filter bar */
    .comp-search-input {
      padding: 8px 12px;
      font-size: 13px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: inherit;
      min-width: 220px;
      transition: border-color var(--transition);
    }
    .comp-search-input:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(231, 53, 46, 0.12);
    }
    .comp-search-input::placeholder { color: var(--text-muted); }

    /* Load more button */
    .comp-load-more-container {
      text-align: center;
      padding: 24px 0 8px;
    }
    .comp-load-more-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 28px;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
      transition: all var(--transition);
    }
    .comp-load-more-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(231, 53, 46, 0.04);
    }
    .comp-ads-count {
      text-align: center;
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* Standort Filter Chip — removed, using dropdown now */

    /* Ad Preview — opens in popup window (no iframe needed) */

    /* Improved alert type colors */
    .comp-alert-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }
    .comp-alert-item:last-child { border-bottom: none; }
    .comp-alert-icon { font-size: 16px; flex-shrink: 0; }
    .comp-alert-new { color: var(--green); }
    .comp-alert-removed { color: var(--orange); }
    .comp-alert-long-running { color: var(--red); }
    .comp-alert-burst { color: var(--blue); }

    /* Trend section */
    .comp-trend-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .comp-trend-list li {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .comp-trend-list li:last-child { border-bottom: none; }
    .comp-trend-count {
      font-size: 22px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    .comp-trend-sublabel {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Better Ad Cards */
    .comp-ad-body-full {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
    }
    .comp-ad-body-toggle {
      color: var(--accent);
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      margin-left: 4px;
    }
    .comp-ad-body-toggle:hover {
      text-decoration: underline;
    }
    .comp-ad-link-meta {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.4;
      margin-top: 4px;
    }
    .comp-ad-link-meta .link-title {
      font-weight: 600;
      color: var(--text-secondary);
    }
    .comp-ad-copy-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      padding: 4px 8px;
      font-size: 12px;
      color: var(--text-muted);
      transition: all var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .comp-ad-copy-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .comp-ad-preview-btn {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      transition: all var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .comp-ad-preview-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(231,53,46,0.04);
    }

    /* Trends grid responsive */
    @media (max-width: 900px) {
      #comp-trends-content > div {
        grid-template-columns: 1fr !important;
      }
    }

    /* ============================================ */
    /* HOME PAGE / HUB                              */
    /* ============================================ */
    .home-hero {
      text-align: center;
      padding: 48px 20px 32px;
    }
    .home-logo {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      object-fit: cover;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
    }
    .home-title {
      font-size: 32px;
      font-weight: 800;
      letter-spacing: -0.03em;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    .home-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      max-width: 500px;
      margin: 0 auto;
      line-height: 1.6;
    }

    .home-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 40px;
    }
    @media (max-width: 768px) {
      .home-stats { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 480px) {
      .home-stats { grid-template-columns: 1fr; }
    }

    .home-stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
    }
    .home-stat-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .home-stat-value {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.03em;
      color: var(--text-primary);
    }

    .home-nav-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 32px;
    }
    @media (max-width: 768px) {
      .home-nav-grid { grid-template-columns: 1fr; }
    }

    .home-nav-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      cursor: pointer;
      transition: all var(--transition);
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }
    .home-nav-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    .home-nav-icon {
      font-size: 28px;
      flex-shrink: 0;
      line-height: 1;
      margin-top: 2px;
    }
    .home-nav-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    .home-nav-desc {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .home-cta {
      text-align: center;
      padding: 24px 0 16px;
    }
    .home-cta .btn-primary {
      padding: 14px 28px;
      font-size: 15px;
      border-radius: var(--radius);
    }

    /* Breadcrumb / back link for sub-pages */
    .view-breadcrumb {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 16px;
      cursor: pointer;
      transition: color var(--transition);
      text-decoration: none;
    }
    .view-breadcrumb:hover { color: var(--accent); }

    /* Topnav simplified (redesigned) */
    .topnav-brand {
      cursor: pointer;
    }
    .topnav-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .topnav-home-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 6px;
      border-radius: var(--radius-sm);
      transition: background var(--transition);
      color: var(--text-secondary);
    }
    .topnav-home-btn:hover {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    /* ============================================ */
    /* APP NAVIGATION - Restructured                */
    /* ============================================ */
    .topnav-center {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .nav-item {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 8px 14px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: all var(--transition);
      border: none;
      background: none;
      font-family: inherit;
      white-space: nowrap;
    }
    .nav-item:hover {
      color: var(--text-primary);
      background: var(--bg-card);
    }
    .nav-item.active {
      color: var(--accent);
      background: rgba(231, 53, 46, 0.06);
    }
    .nav-item .nav-chevron {
      font-size: 10px;
      transition: transform 0.2s ease;
    }
    .nav-item.open .nav-chevron {
      transform: rotate(180deg);
    }

    /* Dropdown menus */
    .nav-dropdown {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      min-width: 220px;
      z-index: 110;
      padding: 6px;
    }
    .nav-dropdown.open {
      display: block;
    }
    .nav-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: all var(--transition);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: inherit;
    }
    .nav-dropdown-item:hover {
      color: var(--text-primary);
      background: var(--bg-card);
    }
    .nav-dropdown-item.active {
      color: var(--accent);
      background: rgba(231, 53, 46, 0.06);
    }

    /* Sub-navigation bar */
    .sub-nav {
      display: none;
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      height: 44px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      z-index: 99;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .sub-nav.visible {
      display: flex;
    }
    .sub-nav-inner {
      display: flex;
      align-items: center;
      gap: 2px;
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 32px;
      height: 100%;
    }
    .sub-nav-tab {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border: none;
      background: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all var(--transition);
      white-space: nowrap;
      font-family: inherit;
      height: 100%;
    }
    .sub-nav-tab:hover {
      color: var(--text-secondary);
    }
    .sub-nav-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* Breadcrumbs bar */
    .app-breadcrumbs {
      display: none;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .app-breadcrumbs.visible {
      display: flex;
    }
    .app-bc-item {
      color: var(--text-muted);
      cursor: pointer;
      font-weight: 500;
      transition: color var(--transition);
      text-decoration: none;
    }
    .app-bc-item:hover {
      color: var(--accent);
    }
    .app-bc-sep {
      color: var(--border);
      font-size: 11px;
    }
    .app-bc-current {
      color: var(--text-primary);
      font-weight: 700;
    }

    /* Smart Home Page Enhancements */
    .home-chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
    }
    .home-chart-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 16px;
    }
    .home-chart-container {
      position: relative;
      width: 100%;
      height: 280px;
    }

    .home-two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }
    @media (max-width: 768px) {
      .home-two-col { grid-template-columns: 1fr; }
    }

    .home-performer-card,
    .home-activity-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }
    .home-card-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .home-performer-name {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
      cursor: pointer;
      transition: color var(--transition);
    }
    .home-performer-name:hover { color: var(--accent); }
    .home-performer-detail {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .home-performer-cpl {
      font-size: 24px;
      font-weight: 800;
      color: var(--green);
    }

    .home-activity-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      color: var(--text-secondary);
    }
    .home-activity-item:last-child { border-bottom: none; }
    .home-activity-icon { font-size: 16px; flex-shrink: 0; }

    .home-quick-nav {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    @media (max-width: 768px) {
      .home-quick-nav { grid-template-columns: repeat(2, 1fr); }
    }
    .home-quick-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      cursor: pointer;
      transition: all var(--transition);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .home-quick-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    .home-quick-icon { font-size: 22px; }

    /* Adjust main padding when sub-nav visible */
    .main.has-sub-nav {
      padding-top: 108px;
    }

    /* ============================================ */
    /* LIVE-FIRST DASHBOARD STYLES                 */
    /* ============================================ */
    .live-section {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }
    .live-section:last-of-type {
      border-bottom: none;
    }
    .live-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 12px;
    }
    .live-section-title {
      font-size: 18px;
      font-weight: 800;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .live-pulse {
      width: 10px;
      height: 10px;
      background: var(--red);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* Action Alerts */
    .live-alerts-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .live-alert-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
    }
    .live-alert-item:hover {
      transform: translateX(4px);
    }
    .live-alert-warning {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: var(--orange);
    }
    .live-alert-danger {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--red);
    }
    .live-alert-info {
      background: rgba(37, 99, 235, 0.08);
      border: 1px solid rgba(37, 99, 235, 0.2);
      color: var(--blue);
    }
    .live-alert-icon {
      font-size: 18px;
      flex-shrink: 0;
    }
    .live-alert-content {
      flex: 1;
    }
    .live-alert-title {
      font-weight: 700;
      margin-bottom: 2px;
    }
    .live-alert-desc {
      font-size: 12px;
      opacity: 0.8;
    }
    .live-alert-action {
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }

    /* Live Campaigns Grid */
    .live-campaigns-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }
    .live-campaign-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: all var(--transition);
      position: relative;
    }
    .live-campaign-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    .live-campaign-card.has-alert {
      border-left: 4px solid var(--orange);
    }
    .live-campaign-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .live-campaign-name {
      font-size: 15px;
      font-weight: 700;
      line-height: 1.3;
    }
    .live-campaign-property {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .live-campaign-status {
      flex-shrink: 0;
    }
    .live-campaign-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .live-campaign-stat {
      display: flex;
      flex-direction: column;
    }
    .live-campaign-stat-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }
    .live-campaign-stat-value {
      font-size: 16px;
      font-weight: 700;
    }
    .live-campaign-stat-sub {
      font-size: 11px;
      color: var(--text-muted);
    }
    .live-empty-state {
      text-align: center;
      padding: 40px;
      background: var(--bg-card);
      border: 1px dashed var(--border);
      border-radius: var(--radius);
    }

    /* Creative Performance Grid */
    .creative-perf-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 768px) {
      .creative-perf-grid { grid-template-columns: 1fr; }
    }
    .creative-perf-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }
    .creative-perf-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }
    .creative-perf-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }
    .creative-perf-badge.good {
      background: rgba(34, 197, 94, 0.12);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, 0.25);
    }
    .creative-perf-badge.bad {
      background: rgba(239, 68, 68, 0.12);
      color: var(--red);
      border: 1px solid rgba(239, 68, 68, 0.25);
    }
    .creative-perf-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }
    .creative-perf-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .creative-perf-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition);
    }
    .creative-perf-item:hover {
      background: var(--bg-card-hover);
    }
    .creative-perf-thumb {
      width: 44px;
      height: 44px;
      background: var(--border);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    .creative-perf-info {
      flex: 1;
      min-width: 0;
    }
    .creative-perf-name {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .creative-perf-meta {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      gap: 8px;
    }
    .creative-perf-cpl {
      font-size: 14px;
      font-weight: 700;
      flex-shrink: 0;
    }
    .creative-perf-action {
      font-size: 11px;
      color: var(--red);
      font-weight: 600;
      margin-top: 2px;
    }

    /* Creative thumbnails removed - using type icons instead */

    /* Competitor Preview Grid */
    .competitor-preview-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    @media (max-width: 900px) {
      .competitor-preview-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .competitor-preview-grid { grid-template-columns: 1fr; }
    }
    .competitor-preview-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      cursor: pointer;
      transition: all var(--transition);
    }
    .competitor-preview-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    .competitor-preview-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .competitor-preview-thumb {
      width: 40px;
      height: 40px;
      background: var(--border);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    .competitor-preview-brand {
      flex: 1;
      min-width: 0;
    }
    .competitor-preview-name {
      font-size: 13px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .competitor-preview-new {
      font-size: 10px;
      font-weight: 700;
      color: var(--green);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .competitor-preview-body {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .competitor-preview-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
    }

    /* History Section */
    .history-section {
      background: var(--bg-secondary);
      margin-left: -32px;
      margin-right: -32px;
      padding-left: 32px;
      padding-right: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      border-bottom: none;
    }
    @media (max-width: 768px) {
      .history-section {
        margin-left: -16px;
        margin-right: -16px;
        padding-left: 16px;
        padding-right: 16px;
      }
    }

    /* Mobile: App Nav */
    @media (max-width: 768px) {
      .topnav-center { display: none; }
      .topnav-burger { display: flex; }
      .topnav-actions {
        position: fixed;
        top: 64px;
        left: 0;
        right: 0;
        background: #ffffff;
        border-bottom: 1px solid var(--border);
        box-shadow: var(--shadow-lg);
        flex-direction: column;
        padding: 12px 16px;
        gap: 4px;
        transform: translateY(-100%);
        opacity: 0;
        pointer-events: none;
        transition: transform 0.3s ease, opacity 0.3s ease;
        z-index: 99;
      }
      .topnav-actions.open {
        transform: translateY(0);
        opacity: 1;
        pointer-events: all;
      }
      .topnav-actions .btn {
        width: 100%;
        text-align: left;
        justify-content: flex-start;
        padding: 12px 16px;
        font-size: 15px;
        border-radius: var(--radius);
      }
      .mobile-nav-section {
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
      }
      .mobile-nav-section:last-child { border-bottom: none; }
      .mobile-nav-section-title {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        padding: 4px 16px 8px;
      }
      .mobile-nav-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        font-size: 15px;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        border-radius: var(--radius);
        transition: background var(--transition);
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        font-family: inherit;
      }
      .mobile-nav-item:hover, .mobile-nav-item.active {
        background: rgba(231, 53, 46, 0.06);
        color: var(--accent);
      }
      .sub-nav { top: 64px; }
      .sub-nav-inner { padding: 0 16px; }
      .main.has-sub-nav { padding-top: 108px; }
    }

    /* Creative preview modal removed - thumbnails too low-res */

    /* ==========================================
       EXPOSÉS SECTION
       ========================================== */
    .expose-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .expose-header h2 {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    /* Upload Modal */
    .expose-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    .expose-modal-overlay.visible {
      display: flex;
    }
    .expose-modal {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 32px;
      width: 100%;
      max-width: 520px;
      box-shadow: var(--shadow-lg);
    }
    .expose-modal h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
    }
    .expose-dropzone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color var(--transition), background var(--transition);
      margin-bottom: 16px;
      color: var(--text-secondary);
      font-size: 14px;
    }
    .expose-dropzone:hover,
    .expose-dropzone.dragover {
      border-color: var(--accent);
      background: var(--bg-secondary);
    }
    .expose-dropzone .dropzone-icon {
      font-size: 32px;
      display: block;
      margin-bottom: 8px;
    }
    .expose-dropzone .dropzone-file {
      margin-top: 8px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .expose-form-group {
      margin-bottom: 16px;
    }
    .expose-form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }
    .expose-form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
    }
    .expose-upload-status {
      margin-top: 12px;
      font-size: 13px;
      color: var(--text-muted);
      min-height: 20px;
    }
    .expose-modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    /* Job List */
    .expose-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .expose-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
      font-size: 14px;
    }
    .expose-empty .empty-icon {
      font-size: 40px;
      display: block;
      margin-bottom: 12px;
    }
    .expose-card {
      display: grid;
      grid-template-columns: 1fr auto auto auto auto auto;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: background var(--transition), border-color var(--transition);
    }
    .expose-card:hover {
      background: var(--bg-card-hover);
      border-color: var(--accent-light);
    }
    .expose-card-filename {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .expose-card-client {
      font-size: 12px;
      color: var(--text-secondary);
      background: var(--bg-secondary);
      padding: 4px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .expose-card-title {
      font-size: 13px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }
    .expose-card-city {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
    }
    .expose-card-price {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
    }
    .expose-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .expose-badge.uploaded,
    .expose-badge.processing {
      background: var(--orange-muted);
      color: var(--orange);
    }
    .expose-badge.done {
      background: var(--green-muted);
      color: var(--green);
    }
    .expose-badge.error {
      background: var(--red-muted);
      color: var(--red);
    }

    /* Detail View */
    .expose-detail {
      display: none;
      margin-top: 24px;
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      padding: 32px;
      box-shadow: var(--shadow-md);
    }
    .expose-detail.visible {
      display: block;
    }
    .expose-detail-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .expose-detail-header h3 {
      font-size: 20px;
      font-weight: 700;
    }
    .expose-detail-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-muted);
      padding: 4px 8px;
    }
    .expose-detail-close:hover {
      color: var(--text-primary);
    }
    .expose-props {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    .expose-prop {
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      padding: 12px;
    }
    .expose-prop-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }
    .expose-prop-value {
      font-size: 14px;
      font-weight: 600;
    }
    .expose-section-title {
      font-size: 16px;
      font-weight: 700;
      margin: 28px 0 16px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      border-left: 4px solid var(--accent);
    }
    .expose-md-content {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-primary);
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-bottom: 8px;
    }
    .expose-md-content h1 { font-size: 20px; font-weight: 700; margin: 16px 0 8px; }
    .expose-md-content h2 { font-size: 17px; font-weight: 700; margin: 14px 0 6px; }
    .expose-md-content h3 { font-size: 15px; font-weight: 600; margin: 12px 0 6px; }
    .expose-md-content p { margin-bottom: 8px; }
    .expose-md-content ul, .expose-md-content ol { margin: 8px 0 8px 20px; }
    .expose-md-content li { margin-bottom: 4px; }
    .expose-md-content code {
      background: var(--bg-secondary);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
    }
    .expose-md-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 13px;
    }
    .expose-md-content th,
    .expose-md-content td {
      border: 1px solid var(--border);
      padding: 8px 12px;
      text-align: left;
    }
    .expose-md-content th {
      background: var(--bg-secondary);
      font-weight: 600;
    }
    .expose-meta-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-muted);
    }

    @media (max-width: 768px) {
      .expose-card {
        grid-template-columns: 1fr;
        gap: 6px;
      }
      .expose-card-title,
      .expose-card-city,
      .expose-card-price {
        max-width: 100%;
      }
      .expose-props {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* ======== EDITORIAL PLANNER ======== */
    #view-editorial-planner {
      margin: -32px;
    }
    .editorial-layout {
      display: flex;
      gap: 0;
      min-height: calc(100vh - 64px);
    }
    .editorial-sidebar {
      width: 340px;
      min-width: 340px;
      border-right: 1px solid var(--border);
      padding: 28px 24px;
      overflow-y: auto;
      max-height: calc(100vh - 64px);
      position: sticky;
      top: 64px;
      background: var(--bg-primary);
    }
    .editorial-sidebar-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 28px;
    }
    .editorial-sidebar-icon {
      width: 40px;
      height: 40px;
      background: var(--accent);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 800;
      font-size: 18px;
      flex-shrink: 0;
    }
    .editorial-sidebar-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }
    .editorial-sidebar-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .editorial-section-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }
    .editorial-period-row {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
    }
    .editorial-period-row select {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 13px;
      background: var(--bg-primary);
      color: var(--text-primary);
      cursor: pointer;
      appearance: auto;
    }
    .editorial-period-row select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .editorial-new-entry-btn {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 14px 16px;
      background: none;
      border: none;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      margin-bottom: 24px;
      transition: background var(--transition);
    }
    .editorial-new-entry-btn:hover {
      background: var(--bg-card);
    }
    .editorial-new-entry-btn .plus-icon {
      color: var(--accent);
      font-size: 20px;
      font-weight: 400;
    }
    .editorial-form {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 24px;
    }
    .editorial-form .form-group {
      margin-bottom: 14px;
    }
    .editorial-form .form-group:last-child {
      margin-bottom: 0;
    }
    .editorial-form label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 5px;
    }
    .editorial-form input,
    .editorial-form select,
    .editorial-form textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 13px;
      background: var(--bg-primary);
      color: var(--text-primary);
    }
    .editorial-form input:focus,
    .editorial-form select:focus,
    .editorial-form textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .editorial-form textarea {
      resize: vertical;
      min-height: 60px;
    }
    .editorial-form-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    .editorial-entry-list {
      margin-bottom: 24px;
    }
    .editorial-entry-item {
      display: flex;
      align-items: flex-start;
      gap: 0;
      padding: 12px 14px;
      border-left: 3px solid var(--accent);
      background: var(--bg-card);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background var(--transition);
      position: relative;
    }
    .editorial-entry-item:hover {
      background: var(--bg-card-hover);
    }
    .editorial-entry-item-content {
      flex: 1;
      min-width: 0;
    }
    .editorial-entry-item-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .editorial-entry-item-meta {
      font-size: 11px;
      color: var(--text-muted);
    }
    .editorial-entry-delete {
      position: absolute;
      right: 8px;
      top: 8px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
      padding: 2px 6px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity var(--transition);
    }
    .editorial-entry-item:hover .editorial-entry-delete {
      opacity: 1;
    }
    .editorial-entry-delete:hover {
      color: var(--red);
      background: var(--red-muted);
    }
    .editorial-outlook-textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 13px;
      background: var(--bg-primary);
      color: var(--text-primary);
      resize: vertical;
    }
    .editorial-outlook-textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .editorial-outlook-textarea::placeholder {
      color: var(--text-muted);
    }
    .editorial-print-hint {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      text-align: center;
      font-size: 12px;
      color: var(--text-muted);
    }
    .editorial-print-hint kbd {
      display: inline-block;
      padding: 2px 6px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-family: inherit;
      font-size: 11px;
    }

    /* A4 Preview */
    .editorial-preview-area {
      flex: 1;
      padding: 32px;
      background: var(--bg-secondary);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      overflow-y: auto;
      max-height: calc(100vh - 64px);
    }
    .editorial-a4 {
      width: 680px;
      min-height: 900px;
      background: #ffffff;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      padding: 48px 48px 40px 48px;
      position: relative;
    }
    .editorial-a4-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .editorial-a4-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .editorial-a4-horse {
      font-size: 36px;
      line-height: 1;
    }
    .editorial-a4-brand-name {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      line-height: 1.2;
    }
    .editorial-a4-brand-sub {
      font-size: 13px;
      font-weight: 400;
      letter-spacing: 0.06em;
      color: var(--text-secondary);
    }
    .editorial-a4-plan-title {
      text-align: right;
    }
    .editorial-a4-plan-title .rg-label {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }
    .editorial-a4-plan-title .rg-label span {
      color: var(--text-primary);
    }
    .editorial-a4-plan-title .month-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .editorial-a4-separator {
      height: 3px;
      background: var(--accent);
      border-radius: 2px;
      margin-bottom: 28px;
    }
    .editorial-a4-entry {
      display: flex;
      gap: 20px;
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid #f0f0f0;
    }
    .editorial-a4-entry:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    .editorial-a4-date {
      text-align: center;
      min-width: 48px;
      flex-shrink: 0;
    }
    .editorial-a4-day {
      font-size: 28px;
      font-weight: 700;
      line-height: 1;
      color: var(--text-primary);
    }
    .editorial-a4-weekday {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      margin-top: 2px;
      letter-spacing: 0.04em;
    }
    .editorial-a4-content {
      flex: 1;
      min-width: 0;
    }
    .editorial-a4-vehicle {
      display: inline-block;
      background: var(--accent);
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 4px;
      margin-bottom: 6px;
    }
    .editorial-a4-vehicle.unknown {
      background: var(--red);
      color: #fff;
      padding: 3px 6px;
      font-size: 10px;
    }
    .editorial-a4-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--text-primary);
    }
    .editorial-a4-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }
    .editorial-a4-series-tag {
      display: inline-block;
      border: 1px solid var(--border);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-primary);
    }
    .editorial-a4-ref {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
      word-break: break-all;
      line-height: 1.4;
      background: var(--bg-card);
      padding: 6px 10px;
      border-radius: var(--radius-sm);
    }
    .editorial-a4-outlook {
      margin-top: 32px;
      padding-top: 20px;
      border-top: 2px solid var(--border);
    }
    .editorial-a4-outlook-title {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .editorial-a4-outlook-text {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .editorial-a4-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
      font-size: 14px;
    }

    /* Editorial Migration Banner */
    .editorial-migration-banner {
      background: var(--orange-muted);
      border: 1px solid var(--orange);
      border-radius: var(--radius);
      padding: 20px;
      margin: 20px;
      text-align: center;
    }
    .editorial-migration-banner h3 {
      color: var(--orange);
      margin-bottom: 8px;
    }
    .editorial-migration-banner pre {
      background: var(--bg-card);
      padding: 12px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      text-align: left;
      overflow-x: auto;
      margin-top: 12px;
      max-height: 200px;
    }

    /* Print Stylesheet — View-aware (controlled by body.print-editorial / body.print-map) */
    @media print {
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      body { background: #fff !important; }
      .topnav, .sub-nav, .topnav-actions, .app-breadcrumbs,
      #mobile-menu, .toast, #comp-ad-detail-modal { display: none !important; }
      .main { padding-top: 0 !important; }

      /* ── Editorial Planner Print ── */
      body.print-editorial .editorial-sidebar,
      body.print-editorial .editorial-print-hint { display: none !important; }
      body.print-editorial .editorial-layout { display: block !important; }
      body.print-editorial .editorial-preview-area {
        padding: 0 !important;
        background: #fff !important;
        max-height: none !important;
        overflow: visible !important;
      }
      body.print-editorial .editorial-a4 {
        width: 100% !important;
        max-width: none !important;
        box-shadow: none !important;
        border-radius: 0 !important;
        padding: 15mm 15mm 15mm 15mm !important;
        min-height: auto !important;
      }
      body.print-editorial .view { display: none !important; }
      body.print-editorial #view-editorial-planner { display: block !important; }
      @page { size: A4 portrait; margin: 0; }

      /* ── Map Builder Print ── */
      body.print-map .view { display: none !important; }
      body.print-map #view-map-builder { display: block !important; }
      body.print-map #mb-finder { display: none !important; }
      body.print-map #mb-editor-wrapper { display: block !important; }
      body.print-map #mb-editor-topbar { display: none !important; }
      body.print-map .mb-sidebar { display: none !important; }
      body.print-map .mb-layout {
        display: block !important;
      }
      body.print-map .mb-map-area {
        width: 100% !important;
        height: 100vh !important;
        position: relative !important;
      }
      body.print-map .mb-map-inner {
        width: 100% !important;
        height: 100% !important;
        max-height: none !important;
        aspect-ratio: auto !important;
      }
      body.print-map #mb-map {
        width: 100% !important;
        height: 100% !important;
      }
      body.print-map .mb-map-controls { display: none !important; }
      body.print-map .mb-export-bar { display: none !important; }
    }

    /* Responsive editorial */
    @media (max-width: 900px) {
      .editorial-layout {
        flex-direction: column;
      }
      .editorial-sidebar {
        width: 100%;
        min-width: auto;
        max-height: none;
        position: static;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      .editorial-preview-area {
        max-height: none;
        padding: 16px;
      }
      .editorial-a4 {
        width: 100%;
        padding: 24px;
      }
    }

    /* ═══════════════════════════════════════════
       MAP BUILDER VIEW
       ═══════════════════════════════════════════ */
    #view-map-builder.view.active {
      display: block;
    }
    /* ─── Map Finder (Overview) ─── */
    #mb-finder {
      padding: 32px;
      max-width: 900px;
      margin: 0 auto;
    }
    #mb-finder .mb-finder-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    #mb-finder .mb-finder-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
    }
    #mb-finder .mb-finder-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    #mb-finder .mb-finder-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }
    #mb-finder .mb-finder-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    #mb-finder .mb-finder-card:hover {
      border-color: var(--accent);
      background: var(--bg-card-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    #mb-finder .mb-finder-card-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }
    #mb-finder .mb-finder-card-address {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    #mb-finder .mb-finder-card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }
    #mb-finder .mb-finder-card-pois {
      background: var(--bg-main);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    #mb-finder .mb-finder-card-actions {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    #mb-finder .mb-finder-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    #mb-finder .mb-finder-empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    #mb-finder .mb-finder-empty-text {
      font-size: 15px;
      font-weight: 500;
    }
    #mb-finder .mb-finder-empty-hint {
      font-size: 13px;
      margin-top: 6px;
    }
    /* ─── Map Editor Back Bar ─── */
    #mb-editor-topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }
    #mb-editor-topbar .mb-back-btn {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      transition: background 0.15s;
    }
    #mb-editor-topbar .mb-back-btn:hover {
      background: var(--bg-card-hover);
    }
    #mb-editor-topbar .mb-editor-mapname {
      font-weight: 600;
      color: var(--text-primary);
    }
    #mb-editor-topbar .mb-editor-sep {
      color: var(--text-muted);
    }
    #view-map-builder .mb-layout {
      display: flex;
      height: calc(100vh - 64px);
      margin: -32px;
    }
    #view-map-builder .mb-sidebar {
      width: 360px;
      min-width: 360px;
      border-right: 1px solid var(--border);
      overflow-y: auto;
      background: var(--bg-primary);
    }
    #view-map-builder .mb-sidebar-section {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    #view-map-builder .mb-sidebar-section:last-child { border-bottom: none; }
    #view-map-builder .mb-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    #view-map-builder .mb-section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    #view-map-builder .mb-section-icon { font-size: 15px; }
    #view-map-builder .mb-input-group { margin-bottom: 10px; }
    #view-map-builder .mb-input-label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    #view-map-builder .mb-input {
      width: 100%;
      padding: 9px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-family: inherit;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: border-color var(--transition);
    }
    #view-map-builder .mb-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--bg-primary);
    }
    #view-map-builder .mb-input::placeholder { color: var(--text-muted); }
    #view-map-builder .mb-input-row { display: flex; gap: 8px; }
    #view-map-builder .mb-input-row .mb-input-group { flex: 1; }
    #view-map-builder select.mb-input {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238f8f8f' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 30px;
    }
    #view-map-builder .mb-verified-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--green-muted);
      border-radius: var(--radius-sm);
      font-size: 12px;
      color: var(--green);
      font-weight: 500;
      margin-top: 6px;
    }
    #view-map-builder .mb-poi-list { display: flex; flex-direction: column; gap: 8px; }
    #view-map-builder .mb-poi-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      position: relative;
      transition: all var(--transition);
    }
    #view-map-builder .mb-poi-card:hover { border-color: var(--text-muted); }
    #view-map-builder .mb-poi-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    #view-map-builder .mb-poi-card-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 600;
    }
    #view-map-builder .mb-poi-card-category { font-size: 11px; color: var(--text-muted); font-weight: 500; }
    #view-map-builder .mb-poi-card-address {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #view-map-builder .mb-poi-card-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #view-map-builder .mb-poi-distance {
      font-size: 12px;
      font-weight: 600;
      color: var(--cyan);
    }
    #view-map-builder .mb-poi-color-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: var(--shadow);
    }
    #view-map-builder .mb-poi-actions { display: flex; gap: 2px; }
    #view-map-builder .mb-add-form {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-top: 8px;
    }
    #view-map-builder .mb-add-form .mb-input-group { margin-bottom: 8px; }
    #view-map-builder .mb-add-form-actions { display: flex; gap: 8px; margin-top: 10px; }
    #view-map-builder .mb-color-picker-row {
      display: flex; align-items: center; gap: 8px;
    }
    #view-map-builder input[type="color"] {
      -webkit-appearance: none;
      width: 28px; height: 28px;
      border: 2px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      padding: 0;
    }
    #view-map-builder input[type="color"]::-webkit-color-swatch-wrapper { padding: 2px; }
    #view-map-builder input[type="color"]::-webkit-color-swatch { border: none; border-radius: 3px; }
    #view-map-builder .mb-saved-map-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      cursor: pointer;
      transition: all var(--transition);
    }
    #view-map-builder .mb-saved-map-item:hover { border-color: var(--accent); background: var(--bg-card-hover); }
    #view-map-builder .mb-saved-map-name { font-size: 13px; font-weight: 500; }
    #view-map-builder .mb-saved-map-date { font-size: 11px; color: var(--text-muted); }
    #view-map-builder .mb-saved-map-address { font-size: 11px; color: var(--text-secondary); }
    #view-map-builder .mb-map-area {
      flex: 1;
      position: relative;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    #view-map-builder .mb-map-inner {
      position: relative;
      width: 100%;
      aspect-ratio: 4/3;
      max-height: 100%;
    }
    #view-map-builder #mb-map {
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #view-map-builder .mb-map-label {
      position: absolute;
      z-index: 800;
      pointer-events: none;
      white-space: nowrap;
      transition: opacity 0.2s ease;
    }
    #view-map-builder .mb-map-label-inner {
      background: rgba(255,255,255,0.96);
      backdrop-filter: blur(8px);
      padding: 6px 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.04);
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    #view-map-builder .mb-map-label-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
    }
    #view-map-builder .mb-map-label-distance {
      font-size: 11px;
      font-weight: 600;
      color: var(--cyan);
      line-height: 1.3;
    }
    #view-map-builder .mb-map-controls {
      position: absolute;
      top: 12px; left: 12px;
      z-index: 1000;
      display: flex; gap: 6px;
    }
    #view-map-builder .mb-map-controls .btn {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow-lg);
      font-size: 12px;
      border: 1px solid var(--border);
      padding: 6px 12px;
    }
    #view-map-builder .mb-empty-state {
      text-align: center;
      padding: 24px 16px;
      color: var(--text-muted);
    }
    #view-map-builder .mb-empty-state-icon { font-size: 32px; margin-bottom: 8px; }
    #view-map-builder .mb-empty-state-text { font-size: 13px; }
    #view-map-builder .mb-btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      font-size: 13px; font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: all var(--transition);
      white-space: nowrap;
    }
    #view-map-builder .mb-btn:hover { background: var(--bg-card); }
    #view-map-builder .mb-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #view-map-builder .mb-btn-accent {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    #view-map-builder .mb-btn-accent:hover { background: var(--accent-dark); }
    #view-map-builder .mb-btn-sm { padding: 5px 10px; font-size: 12px; }
    #view-map-builder .mb-btn-ghost { border: none; background: transparent; }
    #view-map-builder .mb-btn-ghost:hover { background: var(--bg-card); }
    #view-map-builder .mb-btn-icon { padding: 6px; width: 32px; height: 32px; justify-content: center; }
    #view-map-builder .mb-btn-danger { color: var(--red); }
    #view-map-builder .mb-btn-danger:hover { background: var(--red-muted); }
    #view-map-builder .mb-export-overlay {
      position: fixed; inset: 0;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(4px);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    #view-map-builder .mb-export-overlay .mb-spinner { width: 32px; height: 32px; border-width: 3px; }
    #view-map-builder .mb-export-text { font-size: 15px; font-weight: 600; color: var(--text-primary); }
    #view-map-builder .mb-spinner {
      display: inline-block;
      width: 14px; height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    #view-map-builder .mb-toast-container {
      position: fixed;
      top: 68px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #view-map-builder .mb-toast {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 16px;
      box-shadow: var(--shadow-lg);
      font-size: 13px;
      max-width: 320px;
      animation: slideIn 0.2s ease;
    }
    #view-map-builder .mb-toast.error { border-color: var(--red); color: var(--red); }
    #view-map-builder .mb-toast.success { border-color: var(--green); color: var(--green); }
    @keyframes mb-slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Leaflet overrides scoped to map builder */
    #view-map-builder .leaflet-control-attribution { font-size: 9px !important; opacity: 0.6; }
    #view-map-builder .leaflet-control-zoom { border: 1px solid var(--border) !important; border-radius: var(--radius-sm) !important; overflow: hidden; }
    #view-map-builder .leaflet-control-zoom a {
      width: 32px !important; height: 32px !important;
      line-height: 32px !important;
      font-size: 16px !important;
      color: var(--text-primary) !important;
      background: rgba(255,255,255,0.95) !important;
      border-color: var(--border) !important;
    }
    #view-map-builder .leaflet-control-zoom a:hover { background: var(--bg-card) !important; }
    #view-map-builder .custom-div-icon { background: none !important; border: none !important; }

    @media (max-width: 900px) {
      #view-map-builder .mb-sidebar { width: 300px; min-width: 300px; }
    }
    @media (max-width: 700px) {
      #view-map-builder .mb-layout { flex-direction: column; }
      #view-map-builder .mb-sidebar { width: 100%; min-width: 100%; max-height: 50vh; border-right: none; border-bottom: 1px solid var(--border); }
      #view-map-builder .mb-map-area { min-height: 50vh; }
      #view-map-builder .mb-map-inner { max-height: none; }
    }
    @media print {
      #view-map-builder .mb-sidebar, #view-map-builder .mb-map-controls, .mb-toast-container { display: none !important; }
      #view-map-builder .mb-layout { height: 100vh; }
      #view-map-builder .mb-map-area { position: absolute; inset: 0; }
      #view-map-builder .mb-map-inner { width: 100%; max-height: none; aspect-ratio: auto; }
      #view-map-builder #mb-map { width: 100%; height: 100%; }
    }

  </style>
</head>
<body>

<!-- Top Navigation -->
<nav class="topnav">
  <div class="topnav-brand" onclick="showView('home')">
    <img src="assets/rg-logo.png" alt="R&G" class="topnav-logo">
    <div>
      <div class="topnav-title">Command Center</div>
    </div>
  </div>

  <!-- Desktop Nav -->
  <div class="topnav-center">
    <button class="nav-item" onclick="showView('home')" id="nav-home" title="Home">🏠</button>
    <div style="position:relative;">
      <button class="nav-item" id="nav-analytics" onclick="handleNavClick('analytics')" onmouseenter="openNavDropdown('analytics')" onmouseleave="scheduleCloseDropdown('analytics')">
        📊 Analytics <span class="nav-chevron">▾</span>
      </button>
      <div class="nav-dropdown" id="dropdown-analytics" onmouseenter="cancelCloseDropdown('analytics')" onmouseleave="closeNavDropdown('analytics')">
        <button class="nav-dropdown-item" onclick="showView('analytics','campaigns')">📋 Kampagnen</button>
        <button class="nav-dropdown-item" onclick="showView('analytics','intelligence')">🎨 Creative Intelligence</button>
        <button class="nav-dropdown-item" onclick="showView('analytics','data-intel')">📈 Data Intelligence</button>
        <button class="nav-dropdown-item" onclick="showView('analytics','predictor')">🔮 Prognose</button>
        <button class="nav-dropdown-item" onclick="showView('analytics','compare')">⚖️ Vergleich</button>
        <button class="nav-dropdown-item" onclick="showView('analytics','meta-import')">📡 Live-Tracking</button>
      </div>
    </div>
    <div style="position:relative;">
      <button class="nav-item" id="nav-competitors" onclick="handleNavClick('competitors')" onmouseenter="openNavDropdown('competitors')" onmouseleave="scheduleCloseDropdown('competitors')">
        🔍 Competitors <span class="nav-chevron">▾</span>
      </button>
      <div class="nav-dropdown" id="dropdown-competitors" onmouseenter="cancelCloseDropdown('competitors')" onmouseleave="closeNavDropdown('competitors')">
        <button class="nav-dropdown-item" onclick="showView('competitors','overview')">📊 Overview</button>
        <button class="nav-dropdown-item" onclick="showView('competitors','feed')">📰 Ad Feed</button>
        <button class="nav-dropdown-item" onclick="showView('competitors','leaderboard')">🏆 Leaderboard</button>
        <button class="nav-dropdown-item" onclick="showView('competitors','trends')">📈 Trends</button>
        <button class="nav-dropdown-item" onclick="showView('competitors','insights')">🧠 Insights</button>
      </div>
    </div>
    <div style="position:relative;">
      <button class="nav-item" id="nav-clients" onclick="handleNavClick('clients')" onmouseenter="openNavDropdown('clients')" onmouseleave="scheduleCloseDropdown('clients')">
        👥 Clients <span class="nav-chevron">▾</span>
      </button>
      <div class="nav-dropdown" id="dropdown-clients" onmouseenter="cancelCloseDropdown('clients')" onmouseleave="closeNavDropdown('clients')">
        <button class="nav-dropdown-item" onclick="showView('clients','ferrari-editorial')">🏎️ Ferrari HH — Editorial Plan</button>
      </div>
    </div>
    <button class="nav-item" id="nav-map-builder" onclick="showView('map-builder')">🗺️ Map Builder</button>
    <!-- Exposés: disabled, using Google Drive workflow instead -->
    <!-- <button class="nav-item" id="nav-exposes" onclick="showView('exposes')">📝 Exposés</button> -->
  </div>

  <div class="topnav-right">
    <button class="btn btn-primary btn-sm" onclick="showView('new-campaign')">
      ➕ Neue Kampagne
    </button>
    <!-- Hamburger for mobile -->
    <button class="topnav-burger" id="mobile-burger" onclick="toggleMobileMenu()">
      <span></span><span></span><span></span>
    </button>
  </div>
</nav>

<!-- Mobile Menu -->
<div class="topnav-actions" id="mobile-menu">
  <div class="mobile-nav-section">
    <button class="mobile-nav-item" onclick="showView('home');closeMobileMenu();">🏠 Home</button>
  </div>
  <div class="mobile-nav-section">
    <div class="mobile-nav-section-title">📊 Campaign Analytics</div>
    <button class="mobile-nav-item" onclick="showView('analytics','campaigns');closeMobileMenu();">📋 Kampagnen</button>
    <button class="mobile-nav-item" onclick="showView('analytics','intelligence');closeMobileMenu();">🎨 Creative Intelligence</button>
    <button class="mobile-nav-item" onclick="showView('analytics','data-intel');closeMobileMenu();">📈 Data Intelligence</button>
    <button class="mobile-nav-item" onclick="showView('analytics','predictor');closeMobileMenu();">🔮 Prognose</button>
    <button class="mobile-nav-item" onclick="showView('analytics','compare');closeMobileMenu();">⚖️ Vergleich</button>
    <button class="mobile-nav-item" onclick="showView('analytics','meta-import');closeMobileMenu();">📡 Live-Tracking</button>
  </div>
  <div class="mobile-nav-section">
    <div class="mobile-nav-section-title">🔍 Competitor Watch</div>
    <button class="mobile-nav-item" onclick="showView('competitors','overview');closeMobileMenu();">📊 Overview</button>
    <button class="mobile-nav-item" onclick="showView('competitors','feed');closeMobileMenu();">📰 Ad Feed</button>
    <button class="mobile-nav-item" onclick="showView('competitors','leaderboard');closeMobileMenu();">🏆 Leaderboard</button>
    <button class="mobile-nav-item" onclick="showView('competitors','trends');closeMobileMenu();">📈 Trends</button>
    <button class="mobile-nav-item" onclick="showView('competitors','insights');closeMobileMenu();">🧠 Insights</button>
  </div>
  <div class="mobile-nav-section">
    <div class="mobile-nav-section-title">👥 Clients</div>
    <button class="mobile-nav-item" onclick="showView('clients','ferrari-editorial');closeMobileMenu();">🏎️ Ferrari HH — Editorial Plan</button>
  </div>
  <div class="mobile-nav-section">
    <div class="mobile-nav-section-title">🗺️ Map Builder</div>
    <button class="mobile-nav-item" onclick="showView('map-builder');closeMobileMenu();">🗺️ Map Builder</button>
  </div>
  <div class="mobile-nav-section">
    <!-- Exposés: disabled, using Google Drive workflow instead -->
    <!-- <div class="mobile-nav-section-title">📝 Exposés</div>
    <button class="mobile-nav-item" onclick="showView('exposes');closeMobileMenu();">📝 Exposés</button> -->
  </div>
  <div class="mobile-nav-section">
    <button class="mobile-nav-item" onclick="showView('new-campaign');closeMobileMenu();" style="color:var(--accent);font-weight:600;">➕ Neue Kampagne</button>
  </div>
</div>

<!-- Sub-Navigation: Analytics -->
<div class="sub-nav" id="sub-nav-analytics">
  <div class="sub-nav-inner">
    <button class="sub-nav-tab" data-subtab="campaigns" onclick="showView('analytics','campaigns')">Kampagnen</button>
    <button class="sub-nav-tab" data-subtab="intelligence" onclick="showView('analytics','intelligence')">Creative Intelligence</button>
    <button class="sub-nav-tab" data-subtab="data-intel" onclick="showView('analytics','data-intel')">Data Intelligence</button>
    <button class="sub-nav-tab" data-subtab="predictor" onclick="showView('analytics','predictor')">Prognose</button>
    <button class="sub-nav-tab" data-subtab="compare" onclick="showView('analytics','compare')">Vergleich</button>
    <button class="sub-nav-tab" data-subtab="meta-import" onclick="showView('analytics','meta-import')">📡 Live-Tracking</button>
  </div>
</div>

<!-- Sub-Navigation: Competitors -->
<div class="sub-nav" id="sub-nav-competitors">
  <div class="sub-nav-inner">
    <button class="sub-nav-tab" data-subtab="overview" onclick="showView('competitors','overview')">Overview</button>
    <button class="sub-nav-tab" data-subtab="feed" onclick="showView('competitors','feed')">Ad Feed</button>
    <button class="sub-nav-tab" data-subtab="leaderboard" onclick="showView('competitors','leaderboard')">🏆 Leaderboard</button>
    <button class="sub-nav-tab" data-subtab="trends" onclick="showView('competitors','trends')">📈 Trends</button>
    <button class="sub-nav-tab" data-subtab="insights" onclick="showView('competitors','insights')">🧠 Insights</button>
  </div>
</div>

<!-- Main Content -->
<div class="main" id="app-main">
  <div class="container">

    <!-- App Breadcrumbs -->
    <div class="app-breadcrumbs" id="app-breadcrumbs"></div>

    <!-- SETUP BANNER (shown when DB not ready) -->
    <div id="setup-banner" class="setup-banner" style="display:none;">
      <div class="setup-banner-icon">⚙️</div>
      <div class="setup-banner-content">
        <h3>Datenbank-Setup erforderlich</h3>
        <p>
          Die Tabellen existieren noch nicht. Öffne den
          <a href="https://supabase.com/dashboard/project/lvhxabadywdqeepymwdm/sql" target="_blank" style="color:var(--accent-light)">Supabase SQL Editor</a>
          und führe nacheinander die Dateien <code>migration.sql</code> und <code>seed.sql</code> aus.
        </p>
      </div>
    </div>

    <!-- VIEW: Home / Live-First Dashboard -->
    <div id="view-home" class="view active">
      <div class="home-hero" style="padding-bottom:16px;">
        <img src="assets/rg-logo.png" alt="Run & Gun" class="home-logo">
        <h1 class="home-title">Command Center</h1>
        <p class="home-subtitle">Alles auf einen Blick — Kampagnen, Clients, Intel.</p>
      </div>

      <!-- ============================================ -->
      <!-- SECTION 1: 🔴 LIVE STATUS (TOP) -->
      <!-- ============================================ -->
      <div class="live-section" id="live-section">
        <div class="live-section-header">
          <h2 class="live-section-title">🔴 Live Status</h2>
          <span class="live-pulse"></span>
          <button id="home-sync-all-btn" class="btn btn-sm" onclick="syncAllLiveCampaigns()" style="margin-left:auto;background:var(--primary);color:#fff;border:none;padding:6px 14px;border-radius:6px;font-size:12px;cursor:pointer;">
            🔄 Refresh All
          </button>
        </div>

        <!-- Action Required Alerts -->
        <div id="live-action-alerts" class="live-alerts-container" style="display:none;">
          <!-- Dynamically populated -->
        </div>

        <!-- Active Campaigns Grid -->
        <div id="live-campaigns-grid" class="live-campaigns-grid">
          <div style="color:var(--text-muted);font-size:13px;padding:20px;">Lade aktive Kampagnen...</div>
        </div>

        <!-- Empty state for no live campaigns -->
        <div id="live-campaigns-empty" class="live-empty-state" style="display:none;">
          <div class="empty-state-icon">😴</div>
          <div class="empty-state-title">Keine aktiven Kampagnen</div>
          <div class="empty-state-desc">Starte eine neue Kampagne oder importiere aus Meta.</div>
          <button class="btn btn-primary" style="margin-top:12px;" onclick="showView('new-campaign')">➕ Neue Kampagne</button>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- SECTION: 👥 CLIENTS QUICK ACCESS -->
      <!-- ============================================ -->
      <div class="live-section" id="clients-quick-section">
        <div class="live-section-header">
          <h2 class="live-section-title">👥 Clients</h2>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;">
          <div onclick="showView('clients','ferrari-editorial')" style="background:var(--bg-card);border-radius:var(--radius);padding:16px;cursor:pointer;transition:var(--transition);border:1px solid var(--border);" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
            <div style="display:flex;align-items:center;gap:12px;">
              <img src="assets/ferrari-logo.png" alt="Ferrari" style="width:32px;height:auto;">
              <div>
                <div style="font-weight:600;font-size:14px;">Ferrari Hamburg</div>
                <div style="font-size:12px;color:var(--text-muted);">Editorial Plan</div>
              </div>
            </div>
          </div>
          <!-- More clients will be added here -->
        </div>
      </div>

      <!-- ============================================ -->
      <!-- SECTION 2: 📊 CREATIVE PERFORMANCE (MIDDLE) -->
      <!-- ============================================ -->
      <div class="live-section" id="creative-section">
        <div class="live-section-header">
          <h2 class="live-section-title">📊 Creative Performance (Live-Kampagnen)</h2>
        </div>

        <div class="creative-perf-grid">
          <!-- Top 3 Creatives -->
          <div class="creative-perf-card creative-perf-top">
            <div class="creative-perf-card-header">
              <span class="creative-perf-badge good">🏆 Top 3</span>
              <span class="creative-perf-subtitle">Beste CTR/CPL</span>
            </div>
            <div id="live-top-creatives" class="creative-perf-list">
              <div style="color:var(--text-muted);font-size:13px;padding:12px;">Lade...</div>
            </div>
          </div>

          <!-- Bottom 3 Creatives -->
          <div class="creative-perf-card creative-perf-bottom">
            <div class="creative-perf-card-header">
              <span class="creative-perf-badge bad">⚠️ Underperformer</span>
              <span class="creative-perf-subtitle">Abschalten?</span>
            </div>
            <div id="live-bottom-creatives" class="creative-perf-list">
              <div style="color:var(--text-muted);font-size:13px;padding:12px;">Lade...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- SECTION 3: 🔍 COMPETITOR WATCH -->
      <!-- ============================================ -->
      <div class="live-section" id="competitor-section">
        <div class="live-section-header">
          <h2 class="live-section-title">🔍 Competitor Watch</h2>
          <span class="app-bc-item" style="font-size:12px;color:var(--accent);cursor:pointer;" onclick="showView('competitors','feed')">Alle anzeigen →</span>
        </div>

        <div id="live-competitor-ads" class="competitor-preview-grid">
          <div style="color:var(--text-muted);font-size:13px;padding:20px;grid-column:1/-1;">Lade neueste Competitor-Ads...</div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- SECTION 4: 📈 BENCHMARKS & HISTORY (BOTTOM) -->
      <!-- ============================================ -->
      <div class="live-section history-section" id="history-section">
        <div class="live-section-header">
          <h2 class="live-section-title">📈 Benchmarks & Historie</h2>
        </div>

        <!-- KPI Cards (All-time) -->
        <div class="home-stats" style="margin-bottom:24px;">
          <div class="home-stat-card">
            <div class="home-stat-label">Total Kampagnen</div>
            <div class="home-stat-value" id="home-stat-total">–</div>
          </div>
          <div class="home-stat-card">
            <div class="home-stat-label">Aktive Kampagnen</div>
            <div class="home-stat-value" id="home-stat-active" style="color:var(--green);">–</div>
          </div>
          <div class="home-stat-card">
            <div class="home-stat-label">Ø CPL (gesamt)</div>
            <div class="home-stat-value" id="home-stat-cpl">–</div>
          </div>
          <div class="home-stat-card">
            <div class="home-stat-label">Total Leads</div>
            <div class="home-stat-value" id="home-stat-leads">–</div>
          </div>
        </div>

        <!-- Leads Trend Chart -->
        <div class="home-chart-card" style="margin-bottom:24px;">
          <div class="home-chart-title">📈 Leads-Trend (letzte 30 Tage)</div>
          <div class="home-chart-container">
            <canvas id="homeLeadsChart"></canvas>
          </div>
        </div>

        <!-- Top Performer (All-time) -->
        <div class="home-two-col">
          <div class="home-performer-card">
            <div class="home-card-title">🏆 Top Performer (All-time)</div>
            <div id="home-top-performer">
              <div style="color:var(--text-muted);font-size:13px;">Lade...</div>
            </div>
          </div>
          <div class="home-activity-card">
            <div class="home-card-title">🔔 Letzte Aktivität</div>
            <div id="home-alerts-activity">
              <div style="color:var(--text-muted);font-size:13px;">Lade...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Navigation -->
      <div class="home-quick-nav" style="margin-top:24px;">
        <div class="home-quick-card" onclick="showView('analytics','campaigns')">
          <span class="home-quick-icon">📊</span> Alle Kampagnen
        </div>
        <div class="home-quick-card" onclick="showView('competitors','overview')">
          <span class="home-quick-icon">🔍</span> Competitors
        </div>
        <div class="home-quick-card" onclick="showView('new-campaign')">
          <span class="home-quick-icon">➕</span> Neue Kampagne
        </div>
        <div class="home-quick-card" onclick="showView('analytics','meta-import')">
          <span class="home-quick-icon">📡</span> Meta Import
        </div>
      </div>
    </div>

    <!-- VIEW: Campaign List -->
    <div id="view-campaigns" class="view">
      <a class="view-breadcrumb" style="display:none;">← Home</a>
      <div class="page-header">
        <div>
          <h1 class="page-title">Kampagnen</h1>
          <div class="page-subtitle">Alle aktiven und abgeschlossenen Kampagnen</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button id="sync-all-live-btn" class="btn btn-secondary" onclick="syncAllLiveCampaigns()" title="Sync alle Live-Kampagnen">
            🔄 Sync All Live
          </button>
          <button class="btn btn-secondary" onclick="showView('meta-import')">
            📡 Meta-Kampagnen importieren
          </button>
          <button class="btn btn-primary" onclick="showView('new-campaign')">
            + Neue Kampagne
          </button>
        </div>
      </div>

      <!-- Filters (platform removed — always Meta) -->
      <div class="filter-bar">
        <select class="form-select" id="filter-client" onchange="loadCampaigns()">
          <option value="">Alle Kunden</option>
        </select>
        <select class="form-select" id="filter-status" onchange="loadCampaigns()">
          <option value="">Alle Status</option>
          <option value="active">Aktiv</option>
          <option value="paused">Pausiert</option>
          <option value="completed">Abgeschlossen</option>
        </select>
      </div>

      <!-- Campaign Table -->
      <div class="card">
        <div id="campaigns-loading" class="loading-spinner">
          <div class="spinner"></div>
        </div>
        <div class="table-scroll-wrapper">
          <table class="campaign-table" id="campaigns-table" style="display:none;">
            <thead>
              <tr>
                <th>Kampagne</th>
                <th>Status</th>
                <th>Spend</th>
                <th>Leads</th>
                <th>CPL</th>
                <th>Zeitraum</th>
              </tr>
            </thead>
            <tbody id="campaigns-tbody"></tbody>
          </table>
        </div>
        <div id="campaigns-empty" class="empty-state" style="display:none;">
          <div class="empty-state-icon">📭</div>
          <div class="empty-state-title">Keine Kampagnen gefunden</div>
          <div class="empty-state-desc">Erstelle eine neue Kampagne oder ändere die Filter.</div>
        </div>
      </div>
    </div>

    <!-- VIEW: Campaign Detail -->
    <div id="view-detail" class="view">
      <a class="back-link" onclick="showView('analytics','campaigns')">← Zurück zu Kampagnen</a>

      <div id="detail-live-banner" class="live-banner" style="display:none;">
        <span>🟢 Live-Tracking aktiv — Metriken werden täglich automatisch synchronisiert</span>
        <button id="detail-sync-btn" class="btn btn-sm" style="margin-left:auto;background:#10b981;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;" onclick="syncCurrentCampaign()">🔄 Sync Now</button>
      </div>

      <div class="page-header">
        <div>
          <h1 class="page-title" id="detail-title">—</h1>
          <div class="page-subtitle" id="detail-subtitle">—</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
          <div id="detail-status"></div>
          <button class="btn btn-secondary btn-sm" id="detail-edit-btn" onclick="openEditCampaign()">✏️ Bearbeiten</button>
          <button class="btn btn-secondary btn-sm" onclick="openCSVReimport()">📊 CSV aktualisieren</button>
          <button class="btn btn-sm" style="background:var(--red-muted);color:var(--red);border:1px solid var(--red);" onclick="deleteCampaign()">🗑️ Löschen</button>
          <input type="file" id="reimport-csv-input" accept=".csv" style="display:none" onchange="handleCSVReimport(event)">
        </div>
      </div>

      <!-- Property Details -->
      <div class="card" style="margin-bottom:24px;" id="detail-property-card">
        <div class="card-header">
          <div class="card-title">Objekt-Details</div>
        </div>
        <div class="card-body" id="detail-property-info" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;">
        </div>
      </div>

      <!-- KPI Cards -->
      <div class="kpi-grid" id="detail-kpis"></div>

      <!-- Benchmarks -->
      <div id="detail-benchmarks"></div>

      <!-- Charts -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Spend & Leads — Tagesverlauf</div>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="chart-daily"></canvas>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">CPL — Tagesverlauf</div>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="chart-cpl"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Creative Performance -->
      <div class="card" style="margin-bottom:32px;">
        <div class="card-header">
          <div class="card-title">Creative Performance (nach Score)</div>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height:280px;">
            <canvas id="chart-creatives"></canvas>
          </div>
        </div>
      </div>

      <!-- Creative Cards -->
      <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Creative Details</h3>
      <div class="creative-grid" id="creative-cards"></div>
    </div>

    <!-- VIEW: New Campaign (CSV Import) -->
    <div id="view-new-campaign" class="view">
      <a class="back-link" onclick="showView('analytics','campaigns')">← Zurück zu Kampagnen</a>

      <div class="page-header">
        <div>
          <h1 class="page-title">Neue Kampagne</h1>
          <div class="page-subtitle">Meta Ads CSV importieren oder manuell anlegen</div>
        </div>
      </div>

      <!-- Step 1: CSV Drop Zone -->
      <div id="csv-step-upload">
        <div class="drop-zone" id="drop-zone">
          <input type="file" accept=".csv" id="csv-file-input" onchange="handleCSVFileSelect(event)">
          <div class="drop-zone-icon">📁</div>
          <div class="drop-zone-text">Meta Ads CSV hier ablegen oder klicken</div>
          <div class="drop-zone-hint">CSV-Export aus dem Meta Ads Manager (.csv)</div>
        </div>
      </div>

      <!-- Step 2: CSV Preview + Property Form -->
      <div id="csv-step-preview" style="display:none;">
        <div class="csv-preview" id="csv-preview"></div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Objekt-Daten ergänzen</div>
          </div>
          <div class="card-body">
            <form id="csv-import-form" onsubmit="handleCSVImport(event)">
              <div class="form-grid">

                <div class="form-section-title">Kunde</div>

                <div class="form-group">
                  <label class="form-label">Kunde auswählen</label>
                  <select class="form-select" id="csv-client" onchange="toggleCSVNewClient(this)">
                    <option value="">— Neuen Kunden anlegen —</option>
                  </select>
                </div>

                <div class="form-group" id="csv-new-client-group">
                  <label class="form-label">Kundenname</label>
                  <input class="form-input" id="csv-client-name" placeholder="z.B. Von Poll">
                </div>

                <div class="form-group" id="csv-brand-group">
                  <label class="form-label">Brand / Franchise</label>
                  <input class="form-input" id="csv-client-brand" placeholder="z.B. Von Poll, Engel & Völkers">
                </div>

                <div class="form-section-title">Objekt</div>

                <div class="form-group">
                  <label class="form-label">Objektname *</label>
                  <input class="form-input" id="csv-prop-name" required placeholder="z.B. Bennyweg">
                </div>

                <div class="form-group">
                  <label class="form-label">Adresse</label>
                  <input class="form-input" id="csv-prop-address" placeholder="Straße, Hausnummer">
                </div>

                <div class="form-group">
                  <label class="form-label">PLZ</label>
                  <input class="form-input" id="csv-prop-plz" placeholder="13187">
                </div>

                <div class="form-group">
                  <label class="form-label">Stadtteil</label>
                  <input class="form-input" id="csv-prop-stadtteil" placeholder="Pankow">
                </div>

                <div class="form-group">
                  <label class="form-label">Stadt</label>
                  <input class="form-input" id="csv-prop-city" placeholder="Berlin" oninput="autoFillCityRating('csv-prop-city','csv-prop-location-rating')">
                </div>

                <div class="form-group">
                  <label class="form-label">Standort-Rating</label>
                  <select class="form-select" id="csv-prop-location-rating">
                    <option value="">— Automatisch —</option>
                    <option value="A">A — Top-7-Stadt</option>
                    <option value="B">B — Großstadt</option>
                    <option value="C">C — Mittelstadt / Sonstige</option>
                    <option value="D">D — Ländlich</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Mikrolage</label>
                  <select class="form-select" id="csv-prop-micro-location">
                    <option value="">— Keine Angabe —</option>
                    <option value="premium">Premium</option>
                    <option value="gut">Gut</option>
                    <option value="standard">Standard</option>
                    <option value="randlage">Randlage</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Objektart</label>
                  <select class="form-select" id="csv-prop-type" onchange="toggleNeubauFields('csv')">
                    <option value="wohnung">Wohnung</option>
                    <option value="haus">Haus</option>
                    <option value="penthouse">Penthouse</option>
                    <option value="villa">Villa</option>
                    <option value="reihenhaus">Reihenhaus</option>
                    <option value="grundstueck">Grundstück</option>
                    <option value="gewerbe">Gewerbe</option>
                    <option value="neubauprojekt">Neubauprojekt</option>
                    <option value="zweifamilienhaus">Zweifamilienhaus</option><option value="doppelhaushaelfte">Doppelhaushälfte</option>
                    <option value="sonstige">Sonstige</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Wohnfläche (qm)</label>
                  <input class="form-input" id="csv-prop-size" type="number" step="0.1" placeholder="120">
                </div>

                <div class="form-group">
                  <label class="form-label">Grundstücksgröße (qm)</label>
                  <input class="form-input" id="csv-prop-plot-size" type="number" step="0.1">
                </div>

                <div class="form-group">
                  <label class="form-label">Zimmer</label>
                  <input class="form-input" id="csv-prop-rooms" type="number" step="0.5" placeholder="4">
                </div>

                <div class="form-group">
                  <label class="form-label">Angebotspreis (€)</label>
                  <input class="form-input" id="csv-prop-price" type="number" step="1" placeholder="850000">
                </div>

                <div id="csv-neubau-fields" style="display:none; border-top: 1px solid var(--border); padding-top: 12px; margin-top: 12px;">
                  <div class="form-label" style="font-weight:600; margin-bottom:8px; color: var(--primary);">🏗️ Neubauprojekt-Details</div>
                  <div class="form-group">
                    <label class="form-label">Preis von (€)</label>
                    <input class="form-input" id="csv-prop-price-from" type="number" step="1" placeholder="299000">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Preis bis (€)</label>
                    <input class="form-input" id="csv-prop-price-to" type="number" step="1" placeholder="890000">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Wohnfläche von (qm)</label>
                    <input class="form-input" id="csv-prop-size-from" type="number" step="0.1" placeholder="45">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Wohnfläche bis (qm)</label>
                    <input class="form-input" id="csv-prop-size-to" type="number" step="0.1" placeholder="120">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Anzahl Einheiten</label>
                    <input class="form-input" id="csv-prop-num-units" type="number" step="1" placeholder="24">
                  </div>
                </div>

                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" onclick="resetCSVImport()">Abbrechen</button>
                  <button type="submit" class="btn btn-primary">📥 Kampagne importieren</button>
                </div>

              </div>
            </form>
          </div>
        </div>

        <div style="text-align:center;">
          <span class="manual-toggle-link" onclick="resetCSVImport()">↩ Neue CSV hochladen</span>
        </div>
      </div>

      <!-- Manual form toggle -->
      <div style="text-align:center;margin-top:24px;" id="csv-manual-toggle">
        <span class="manual-toggle-link" onclick="showManualForm()">Oder manuell anlegen →</span>
      </div>

      <!-- Hidden: Original Manual Form -->
      <div id="csv-manual-form" style="display:none;margin-top:24px;">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Kampagne manuell anlegen</div>
          </div>
          <div class="card-body">
            <form id="new-campaign-form" onsubmit="handleCreateCampaign(event)">
              <div class="form-grid">

                <div class="form-section-title">Kunde</div>

                <div class="form-group">
                  <label class="form-label">Kunde auswählen</label>
                  <select class="form-select" id="form-client" onchange="toggleNewClient(this)">
                    <option value="">— Neuen Kunden anlegen —</option>
                  </select>
                </div>

                <div class="form-group" id="form-new-client-group">
                  <label class="form-label">Kundenname</label>
                  <input class="form-input" id="form-client-name" placeholder="z.B. Von Järten & Cie">
                </div>

                <div class="form-group">
                  <label class="form-label">Brand / Franchise</label>
                  <input class="form-input" id="form-brand" placeholder="z.B. Von Poll, Engel & Völkers">
                </div>

                <div class="form-section-title">Objekt</div>

                <div class="form-group">
                  <label class="form-label">Objektname *</label>
                  <input class="form-input" id="form-prop-name" required placeholder="z.B. Falkensteiner Ufer">
                </div>

                <div class="form-group">
                  <label class="form-label">Adresse</label>
                  <input class="form-input" id="form-prop-address" placeholder="Straße, Hausnummer">
                </div>

                <div class="form-group">
                  <label class="form-label">PLZ</label>
                  <input class="form-input" id="form-prop-plz" placeholder="22587">
                </div>

                <div class="form-group">
                  <label class="form-label">Stadtteil</label>
                  <input class="form-input" id="form-prop-stadtteil" placeholder="Blankenese">
                </div>

                <div class="form-group">
                  <label class="form-label">Stadt</label>
                  <input class="form-input" id="form-prop-city" placeholder="Hamburg" oninput="autoFillCityRating('form-prop-city','form-prop-location-rating')">
                </div>

                <div class="form-group">
                  <label class="form-label">Standort-Rating</label>
                  <select class="form-select" id="form-prop-location-rating">
                    <option value="">— Automatisch —</option>
                    <option value="A">A — Top-7-Stadt</option>
                    <option value="B">B — Großstadt</option>
                    <option value="C">C — Mittelstadt / Sonstige</option>
                    <option value="D">D — Ländlich</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Mikrolage</label>
                  <select class="form-select" id="form-prop-micro-location">
                    <option value="">— Keine Angabe —</option>
                    <option value="premium">Premium</option>
                    <option value="gut">Gut</option>
                    <option value="standard">Standard</option>
                    <option value="randlage">Randlage</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Objektart</label>
                  <select class="form-select" id="form-prop-type" onchange="toggleNeubauFields('form')">
                    <option value="wohnung">Wohnung</option>
                    <option value="haus">Haus</option>
                    <option value="penthouse">Penthouse</option>
                    <option value="villa">Villa</option>
                    <option value="reihenhaus">Reihenhaus</option>
                    <option value="grundstueck">Grundstück</option>
                    <option value="gewerbe">Gewerbe</option>
                    <option value="neubauprojekt">Neubauprojekt</option>
                    <option value="zweifamilienhaus">Zweifamilienhaus</option><option value="doppelhaushaelfte">Doppelhaushälfte</option>
                    <option value="sonstige">Sonstige</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Wohnfläche (qm)</label>
                  <input class="form-input" id="form-prop-size" type="number" step="0.1" placeholder="120">
                </div>

                <div class="form-group">
                  <label class="form-label">Grundstücksgröße (qm)</label>
                  <input class="form-input" id="form-prop-plot-size" type="number" step="0.1">
                </div>

                <div class="form-group">
                  <label class="form-label">Zimmer</label>
                  <input class="form-input" id="form-prop-rooms" type="number" step="0.5" placeholder="4">
                </div>

                <div class="form-group">
                  <label class="form-label">Angebotspreis (€)</label>
                  <input class="form-input" id="form-prop-price" type="number" step="1" placeholder="850000">
                </div>

                <div id="form-neubau-fields" style="display:none; border-top: 1px solid var(--border); padding-top: 12px; margin-top: 12px;">
                  <div class="form-label" style="font-weight:600; margin-bottom:8px; color: var(--primary);">🏗️ Neubauprojekt-Details</div>
                  <div class="form-group">
                    <label class="form-label">Preis von (€)</label>
                    <input class="form-input" id="form-prop-price-from" type="number" step="1" placeholder="299000">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Preis bis (€)</label>
                    <input class="form-input" id="form-prop-price-to" type="number" step="1" placeholder="890000">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Wohnfläche von (qm)</label>
                    <input class="form-input" id="form-prop-size-from" type="number" step="0.1" placeholder="45">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Wohnfläche bis (qm)</label>
                    <input class="form-input" id="form-prop-size-to" type="number" step="0.1" placeholder="120">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Anzahl Einheiten</label>
                    <input class="form-input" id="form-prop-num-units" type="number" step="1" placeholder="24">
                  </div>
                </div>

                <div class="form-section-title">Kampagne</div>

                <div class="form-group full-width">
                  <label class="form-label">Kampagnenname *</label>
                  <input class="form-input" id="form-camp-name" required placeholder="z.B. Falkensteiner Ufer // Lead Gen">
                </div>

                <div class="form-group">
                  <label class="form-label">Kampagnentyp</label>
                  <select class="form-select" id="form-camp-type">
                    <option value="lead_gen">Lead-Generierung</option>
                    <option value="awareness">Awareness</option>
                    <option value="traffic">Traffic</option>
                    <option value="engagement">Engagement</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Status</label>
                  <select class="form-select" id="form-camp-status">
                    <option value="active">Aktiv</option>
                    <option value="paused">Pausiert</option>
                    <option value="completed">Abgeschlossen</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Startdatum</label>
                  <input class="form-input" id="form-camp-start" type="date">
                </div>

                <div class="form-group">
                  <label class="form-label">Enddatum</label>
                  <input class="form-input" id="form-camp-end" type="date">
                </div>

                <div class="form-group">
                  <label class="form-label">Gesamtbudget (€)</label>
                  <input class="form-input" id="form-camp-budget" type="number" step="0.01" placeholder="1000">
                </div>

                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" onclick="showView('campaigns')">Abbrechen</button>
                  <button type="submit" class="btn btn-primary">Kampagne erstellen</button>
                </div>

              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: Creative Intelligence -->
    <div id="view-intelligence" class="view">
      <a class="view-breadcrumb" style="display:none;">← Home</a>
      <div class="page-header">
        <div>
          <h1 class="page-title">🎨 Creative Intelligence</h1>
          <div class="page-subtitle">Welche Creative-Art performt am besten — über alle Kampagnen hinweg</div>
        </div>
      </div>

      <!-- Time Filter Tabs -->
      <div class="tabs" style="margin-bottom:24px;">
        <div class="tab active" id="intel-tab-alltime" onclick="switchIntelTimeFilter('alltime')">📊 All-Time</div>
        <div class="tab" id="intel-tab-30d" onclick="switchIntelTimeFilter('30d')">⏱ Aktuell (30 Tage)</div>
      </div>

      <!-- Property Category Filter -->
      <div class="tabs" style="margin-bottom:24px;">
        <div class="tab active" id="intel-cat-all" onclick="switchIntelCategory('all')">📋 Gesamt</div>
        <div class="tab" id="intel-cat-neubau" onclick="switchIntelCategory('neubauprojekt')">🏗️ Neubauprojekt</div>
        <div class="tab" id="intel-cat-einzel" onclick="switchIntelCategory('einzel')">🏠 Einzelobjekte</div>
      </div>

      <div id="intel-loading" class="loading-spinner">
        <div class="spinner"></div>
      </div>

      <div id="intel-content" style="display:none;">
        <!-- Section A: Current Best -->
        <div class="intel-section">
          <div class="intel-section-title">🏆 Aktuell beste Creative-Art</div>
          <div id="intel-current-chart" class="hbar-chart" style="margin-bottom:24px;"></div>
          <div id="intel-current-cards" class="intel-ranking-grid"></div>
        </div>

        <!-- Section B: All-Time Ranking -->
        <div class="intel-section">
          <div class="intel-section-title">📊 All-Time Ranking</div>
          <div class="ranking-tabs" id="ranking-tabs">
            <div class="ranking-tab active" onclick="switchRanking('score')">Nach Score</div>
            <div class="ranking-tab" onclick="switchRanking('cpl')">Nach CPL</div>
            <div class="ranking-tab" onclick="switchRanking('leads')">Nach Leads</div>
          </div>
          <div id="intel-alltime-cards" class="intel-ranking-grid"></div>
        </div>

        <!-- Section C: Nach Objektart (locked) -->
        <div class="intel-section">
          <div class="intel-section-title">🏠 Nach Objektart</div>
          <div class="locked-section">
            <div class="lock-icon">🔒</div>
            <h3>Ab 10+ Kampagnen verfügbar</h3>
            <p>Diese Analyse zeigt, welche Creative-Art für welche Objektart am besten funktioniert. Sobald genügend Daten vorliegen, wird die Auswertung automatisch freigeschaltet.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: Edit Campaign -->
    <div id="view-edit-campaign" class="view">
      <a class="back-link" onclick="showView('detail')">← Zurück zur Kampagne</a>

      <div class="page-header">
        <div>
          <h1 class="page-title">Kampagne bearbeiten</h1>
          <div class="page-subtitle" id="edit-subtitle">—</div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <form id="edit-campaign-form" onsubmit="handleEditCampaign(event)">
            <div class="form-grid">

              <!-- Client Section -->
              <div class="form-section-title">Kunde</div>

              <div class="form-group">
                <label class="form-label">Kunde</label>
                <select class="form-select" id="edit-client">
                </select>
              </div>

              <!-- Property Section -->
              <div class="form-section-title">Objekt</div>

              <div class="form-group">
                <label class="form-label">Objektname *</label>
                <input class="form-input" id="edit-prop-name" required>
              </div>

              <div class="form-group">
                <label class="form-label">Adresse</label>
                <input class="form-input" id="edit-prop-address">
              </div>

              <div class="form-group">
                <label class="form-label">PLZ</label>
                <input class="form-input" id="edit-prop-plz">
              </div>

              <div class="form-group">
                <label class="form-label">Stadtteil</label>
                <input class="form-input" id="edit-prop-stadtteil">
              </div>

              <div class="form-group">
                <label class="form-label">Stadt</label>
                <input class="form-input" id="edit-prop-city" oninput="autoFillCityRating('edit-prop-city','edit-prop-location-rating')">
              </div>

              <div class="form-group">
                <label class="form-label">Standort-Rating</label>
                <select class="form-select" id="edit-prop-location-rating">
                  <option value="">— Automatisch —</option>
                  <option value="A">A — Top-7-Stadt</option>
                  <option value="B">B — Großstadt</option>
                  <option value="C">C — Mittelstadt / Sonstige</option>
                  <option value="D">D — Ländlich</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Mikrolage</label>
                <select class="form-select" id="edit-prop-micro-location">
                  <option value="">— Keine Angabe —</option>
                  <option value="premium">Premium</option>
                  <option value="gut">Gut</option>
                  <option value="standard">Standard</option>
                  <option value="randlage">Randlage</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Objektart</label>
                <select class="form-select" id="edit-prop-type" onchange="toggleNeubauFields('edit')">
                  <option value="wohnung">Wohnung</option>
                  <option value="haus">Haus</option>
                  <option value="penthouse">Penthouse</option>
                  <option value="villa">Villa</option>
                  <option value="reihenhaus">Reihenhaus</option>
                  <option value="grundstueck">Grundstück</option>
                  <option value="gewerbe">Gewerbe</option>
                  <option value="neubauprojekt">Neubauprojekt</option>
                  <option value="zweifamilienhaus">Zweifamilienhaus</option><option value="doppelhaushaelfte">Doppelhaushälfte</option>
                  <option value="sonstige">Sonstige</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Wohnfläche (qm)</label>
                <input class="form-input" id="edit-prop-size" type="number" step="0.1">
              </div>

              <div class="form-group">
                <label class="form-label">Grundstücksgröße (qm)</label>
                <input class="form-input" id="edit-prop-plot-size" type="number" step="0.1">
              </div>

              <div class="form-group">
                <label class="form-label">Zimmer</label>
                <input class="form-input" id="edit-prop-rooms" type="number" step="0.5">
              </div>

              <div class="form-group">
                <label class="form-label">Angebotspreis (€)</label>
                <input class="form-input" id="edit-prop-price" type="number" step="1">
              </div>

              <div id="edit-neubau-fields" style="display:none; border-top: 1px solid var(--border); padding-top: 12px; margin-top: 12px;">
                <div class="form-label" style="font-weight:600; margin-bottom:8px; color: var(--primary);">🏗️ Neubauprojekt-Details</div>
                <div class="form-group">
                  <label class="form-label">Preis von (€)</label>
                  <input class="form-input" id="edit-prop-price-from" type="number" step="1">
                </div>
                <div class="form-group">
                  <label class="form-label">Preis bis (€)</label>
                  <input class="form-input" id="edit-prop-price-to" type="number" step="1">
                </div>
                <div class="form-group">
                  <label class="form-label">Wohnfläche von (qm)</label>
                  <input class="form-input" id="edit-prop-size-from" type="number" step="0.1">
                </div>
                <div class="form-group">
                  <label class="form-label">Wohnfläche bis (qm)</label>
                  <input class="form-input" id="edit-prop-size-to" type="number" step="0.1">
                </div>
                <div class="form-group">
                  <label class="form-label">Anzahl Einheiten</label>
                  <input class="form-input" id="edit-prop-num-units" type="number" step="1">
                </div>
              </div>

              <!-- Campaign Section -->
              <div class="form-section-title">Kampagne</div>

              <div class="form-group full-width">
                <label class="form-label">Kampagnenname *</label>
                <input class="form-input" id="edit-camp-name" required>
              </div>

              <div class="form-group">
                <label class="form-label">Startdatum</label>
                <input class="form-input" id="edit-camp-start" type="date">
              </div>

              <div class="form-group">
                <label class="form-label">Enddatum</label>
                <input class="form-input" id="edit-camp-end" type="date">
              </div>

              <div class="form-group">
                <label class="form-label">Gesamtbudget (€)</label>
                <input class="form-input" id="edit-camp-budget" type="number" step="0.01">
              </div>

              <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select" id="edit-camp-status">
                  <option value="active">Aktiv</option>
                  <option value="paused">Pausiert</option>
                  <option value="completed">Abgeschlossen</option>
                </select>
              </div>

              <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="showView('detail')">Abbrechen</button>
                <button type="submit" class="btn btn-primary">💾 Speichern</button>
              </div>

            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- VIEW: Data Intelligence -->
    <div id="view-data-intel" class="view">
      <a class="view-breadcrumb" style="display:none;">← Home</a>
      <div class="page-header">
        <div>
          <h1 class="page-title">📈 Data Intelligence</h1>
          <div class="page-subtitle">Statistische Analyse aller Kampagnen — Segmente, Korrelationen & Insights</div>
        </div>
      </div>

      <!-- Property Category Filter -->
      <div class="tabs" style="margin-bottom:24px;">
        <div class="tab active" id="di-cat-all" onclick="switchDataIntelCategory('all')">📋 Gesamt</div>
        <div class="tab" id="di-cat-neubau" onclick="switchDataIntelCategory('neubauprojekt')">🏗️ Neubauprojekt</div>
        <div class="tab" id="di-cat-einzel" onclick="switchDataIntelCategory('einzel')">🏠 Einzelobjekte</div>
      </div>

      <div id="data-intel-loading" class="loading-spinner">
        <div class="spinner"></div>
      </div>

      <div id="data-intel-content" style="display:none;">

        <!-- Section A: Segment Performance Matrix -->
        <div class="data-intel-section">
          <div class="data-intel-section-title">📊 Segment-Performance-Matrix</div>
          <div id="data-intel-warning"></div>
          <div class="data-intel-grid" id="data-intel-segments"></div>
        </div>

        <!-- Section B: Korrelations-Analyse -->
        <div class="data-intel-section">
          <div class="data-intel-section-title">🔗 Korrelations-Analyse</div>
          <div class="card">
            <div class="card-body" id="data-intel-correlations"></div>
          </div>
        </div>

        <!-- Section C: Auto-Insights -->
        <div class="data-intel-section">
          <div class="data-intel-section-title">💡 Auto-Insights</div>
          <div class="card">
            <div class="card-body" id="data-intel-insights"></div>
          </div>
        </div>

        <!-- Section D: Scatter Plot -->
        <div class="data-intel-section">
          <div class="data-intel-section-title">🔍 Kampagnen-Vergleich</div>

          <!-- Scatter Mode Selector -->
          <div class="tabs" style="margin-bottom:12px;">
            <div class="tab active" id="scatter-mode-price" onclick="switchScatterMode('price')">Preis vs. CPL</div>
            <div class="tab" id="scatter-mode-pricePerSqm" onclick="switchScatterMode('pricePerSqm')">qm-Preis vs. CPL</div>
            <div class="tab" id="scatter-mode-size" onclick="switchScatterMode('size')">Wohnfläche vs. CPL</div>
            <div class="tab" id="scatter-mode-rooms" onclick="switchScatterMode('rooms')">Zimmer vs. CPL</div>
            <div class="tab" id="scatter-mode-plot" onclick="switchScatterMode('plot')">Grundstück vs. CPL</div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title" id="scatter-chart-title">Preis vs. CPL</div>
            </div>
            <div class="card-body">
              <div class="scatter-container">
                <canvas id="chart-scatter-cpl"></canvas>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- VIEW: Property Predictor -->
    <div id="view-predictor" class="view">
      <a class="view-breadcrumb" style="display:none;">← Home</a>
      <div class="page-header">
        <div>
          <h1 class="page-title">🔮 Performance-Prognose</h1>
          <div class="page-subtitle">Voraussichtliche Kampagnen-Performance für ein Objekt vorhersagen</div>
        </div>
      </div>

      <div class="predictor-layout">
        <!-- Left: Input Form -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Objekt-Daten</div>
          </div>
          <div class="card-body">
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Objektart *</label>
              <select class="form-select" id="pred-type">
                <option value="wohnung">Wohnung</option>
                <option value="haus">Haus</option>
                <option value="penthouse">Penthouse</option>
                <option value="villa">Villa</option>
                <option value="reihenhaus">Reihenhaus</option>
                <option value="grundstueck">Grundstück</option>
                <option value="gewerbe">Gewerbe</option>
                <option value="neubauprojekt">Neubauprojekt</option>
                <option value="zweifamilienhaus">Zweifamilienhaus</option><option value="doppelhaushaelfte">Doppelhaushälfte</option>
                <option value="sonstige">Sonstige</option>
              </select>
            </div>
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Wohnfläche (qm)</label>
              <input class="form-input" id="pred-size" type="number" step="0.1" placeholder="120">
            </div>
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Grundstück (qm, optional)</label>
              <input class="form-input" id="pred-plot" type="number" step="0.1" placeholder="">
            </div>
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Zimmer (optional)</label>
              <input class="form-input" id="pred-rooms" type="number" step="0.5" placeholder="4">
            </div>
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Preis (€) *</label>
              <input class="form-input" id="pred-price" type="number" step="1" placeholder="850000">
            </div>
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Stadt</label>
              <input class="form-input" id="pred-city" placeholder="Berlin" oninput="autoFillCityRating('pred-city','pred-rating')">
            </div>
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Standort-Rating</label>
              <select class="form-select" id="pred-rating">
                <option value="">— Automatisch —</option>
                <option value="A">A — Top-7-Stadt</option>
                <option value="B">B — Großstadt</option>
                <option value="C">C — Mittelstadt / Sonstige</option>
                <option value="D">D — Ländlich</option>
              </select>
            </div>
            <div class="form-group" style="margin-bottom:18px;">
              <label class="form-label">Mikrolage (optional)</label>
              <select class="form-select" id="pred-micro">
                <option value="">— Keine Angabe —</option>
                <option value="premium">Premium</option>
                <option value="gut">Gut</option>
                <option value="standard">Standard</option>
                <option value="randlage">Randlage</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="predictPerformance()" style="width:100%;">🔮 Performance vorhersagen</button>
          </div>
        </div>

        <!-- Right: Results -->
        <div id="pred-results">
          <div class="empty-state" style="padding:60px 30px;">
            <div class="empty-state-icon">🔮</div>
            <div class="empty-state-title">Prognose starten</div>
            <div class="empty-state-desc">Objekt-Daten links eingeben und auf „Performance vorhersagen" klicken.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: Property Comparison -->
    <div id="view-compare" class="view">
      <a class="view-breadcrumb" style="display:none;">← Home</a>
      <div class="page-header">
        <div>
          <h1 class="page-title">⚖️ Objekt-Vergleich</h1>
          <div class="page-subtitle">Bis zu 4 Objekte vergleichen und das beste Performance-Potenzial finden</div>
        </div>
      </div>

      <div class="compare-grid" id="comp-inputs">
        <!-- Property 0 -->
        <div class="compare-input-card" id="comp-card-0">
          <div class="compare-card-title">Objekt 1</div>
          <div class="form-group"><label class="form-label">Name</label><input class="form-input" id="comp-0-name" placeholder="z.B. Bennyweg"></div>
          <div class="form-group"><label class="form-label">Objektart</label><select class="form-select" id="comp-0-type"><option value="wohnung">Wohnung</option><option value="haus">Haus</option><option value="penthouse">Penthouse</option><option value="villa">Villa</option><option value="reihenhaus">Reihenhaus</option><option value="grundstueck">Grundstück</option><option value="gewerbe">Gewerbe</option><option value="neubauprojekt">Neubauprojekt</option><option value="zweifamilienhaus">Zweifamilienhaus</option><option value="doppelhaushaelfte">Doppelhaushälfte</option><option value="sonstige">Sonstige</option></select></div>
          <div class="form-group"><label class="form-label">Wohnfläche (qm)</label><input class="form-input" id="comp-0-size" type="number" step="0.1" placeholder="120"></div>
          <div class="form-group"><label class="form-label">Preis (€)</label><input class="form-input" id="comp-0-price" type="number" step="1" placeholder="850000"></div>
          <div class="form-group"><label class="form-label">Stadt</label><input class="form-input" id="comp-0-city" placeholder="Berlin" oninput="autoFillCityRating('comp-0-city','comp-0-rating')"></div>
          <div class="form-group"><label class="form-label">Standort-Rating</label><select class="form-select" id="comp-0-rating"><option value="">— Auto —</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div>
        </div>
        <!-- Property 1 -->
        <div class="compare-input-card" id="comp-card-1">
          <div class="compare-card-title">Objekt 2</div>
          <div class="form-group"><label class="form-label">Name</label><input class="form-input" id="comp-1-name" placeholder="z.B. Spanische Allee"></div>
          <div class="form-group"><label class="form-label">Objektart</label><select class="form-select" id="comp-1-type"><option value="wohnung">Wohnung</option><option value="haus">Haus</option><option value="penthouse">Penthouse</option><option value="villa">Villa</option><option value="reihenhaus">Reihenhaus</option><option value="grundstueck">Grundstück</option><option value="gewerbe">Gewerbe</option><option value="neubauprojekt">Neubauprojekt</option><option value="zweifamilienhaus">Zweifamilienhaus</option><option value="doppelhaushaelfte">Doppelhaushälfte</option><option value="sonstige">Sonstige</option></select></div>
          <div class="form-group"><label class="form-label">Wohnfläche (qm)</label><input class="form-input" id="comp-1-size" type="number" step="0.1" placeholder="241"></div>
          <div class="form-group"><label class="form-label">Preis (€)</label><input class="form-input" id="comp-1-price" type="number" step="1" placeholder="2100000"></div>
          <div class="form-group"><label class="form-label">Stadt</label><input class="form-input" id="comp-1-city" placeholder="Hamburg" oninput="autoFillCityRating('comp-1-city','comp-1-rating')"></div>
          <div class="form-group"><label class="form-label">Standort-Rating</label><select class="form-select" id="comp-1-rating"><option value="">— Auto —</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div>
        </div>
      </div>

      <div style="display:flex;gap:12px;margin-bottom:32px;">
        <button class="btn btn-secondary" id="comp-add-btn" onclick="addCompareProperty()">➕ Objekt hinzufügen</button>
        <button class="btn btn-primary" onclick="compareProperties()">⚖️ Vergleichen</button>
      </div>

      <div id="comp-results"></div>
    </div>

    <!-- ============================================ -->
    <!-- META IMPORT / LIVE TRACKING VIEW -->
    <!-- ============================================ -->
    <div id="view-meta-import" class="view">
      <a class="view-breadcrumb" style="display:none;">← Home</a>
      <div class="page-header">
        <div>
          <h1 class="page-title">📡 Meta-Kampagnen importieren</h1>
          <div class="page-subtitle">Kampagnen aus dem Meta Ad Account verknüpfen und automatisch synchronisieren</div>
        </div>
      </div>

      <!-- Step 1: Campaign List from Meta API -->
      <div id="meta-import-step-list">
        <!-- Ad Account Selector -->
        <div class="meta-ad-account-selector-container" style="margin-bottom:16px;">
          <label style="display:block;font-size:13px;font-weight:500;margin-bottom:6px;color:var(--text-muted);">Ad Account</label>
          <select id="meta-ad-account-selector" class="form-input" onchange="loadMetaCampaigns()" style="max-width:320px;">
            <option value="act_850524294087986">R&G — Immobilien_main</option>
            <option value="act_763575219714223">E&V — Immobilien_E&V</option>
          </select>
        </div>
        <div class="meta-campaign-search">
          <input class="form-input" id="meta-search" placeholder="Kampagne suchen..." oninput="filterMetaCampaigns()">
        </div>
        <div class="meta-filter-btns">
          <button class="meta-filter-btn active" id="meta-filter-all" onclick="setMetaStatusFilter('all')">Alle</button>
          <button class="meta-filter-btn" id="meta-filter-active" onclick="setMetaStatusFilter('ACTIVE')">Active</button>
          <button class="meta-filter-btn" id="meta-filter-paused" onclick="setMetaStatusFilter('PAUSED')">Paused</button>
        </div>

        <div id="meta-campaigns-loading" class="loading-spinner">
          <div class="spinner"></div>
        </div>
        <div id="meta-campaigns-empty" class="empty-state" style="display:none;">
          <div class="empty-state-icon">📡</div>
          <div class="empty-state-title">Keine Kampagnen geladen</div>
          <div class="empty-state-desc">Stelle sicher, dass der Meta API Token unter Competitor Watch → API Settings gespeichert ist.</div>
        </div>
        <div id="meta-campaigns-list" class="meta-campaign-list" style="display:none;"></div>
      </div>

      <!-- Step 2: Link Modal (dynamic, rendered in JS) -->
      <div id="meta-link-modal-container"></div>

      <!-- Step 3: Sync Progress (inline) -->
      <div id="meta-import-step-sync" style="display:none;">
        <div class="card">
          <div class="card-body">
            <div class="meta-sync-progress" id="meta-sync-progress">
              <div class="spinner" style="margin:0 auto 16px;"></div>
              <div class="sync-step" id="meta-sync-step">Starte Synchronisation...</div>
              <div class="sync-bar"><div class="sync-bar-fill" id="meta-sync-bar" style="width:0%;"></div></div>
              <div class="sync-detail" id="meta-sync-detail"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4: Success -->
      <div id="meta-import-step-success" style="display:none;">
        <div class="card">
          <div class="card-body">
            <div class="meta-sync-success">
              <div class="success-icon">✅</div>
              <div class="success-title" id="meta-success-title">Kampagne verknüpft!</div>
              <div class="success-stats" id="meta-success-stats"></div>
              <button class="btn btn-primary" id="meta-success-open-btn" onclick="">→ Kampagne öffnen</button>
              <button class="btn btn-secondary" style="margin-left:8px;" onclick="resetMetaImport()">Weitere importieren</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- COMPETITOR WATCH VIEW -->
    <!-- ============================================ -->
    <div id="view-competitor" class="view">
      <a class="view-breadcrumb" style="display:none;">← Home</a>
      <div class="page-header">
        <div>
          <h1 class="page-title">🔍 Competitor Watch</h1>
          <div class="page-subtitle">Wettbewerber-Ads aus der Meta Ad Library beobachten und analysieren</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn btn-secondary btn-sm" onclick="toggleCompetitorSettings()" id="comp-settings-toggle">⚙️ API Settings</button>
          <button class="btn btn-primary btn-sm" id="comp-sync-btn" onclick="syncCompetitorAds()" disabled>🔄 Sync Now</button>
        </div>
      </div>

      <!-- Alert Banner -->
      <div id="comp-alert-banner" class="setup-banner" style="display:none;border-color:rgba(245,158,11,0.3);background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(239,68,68,0.05));">
        <div class="setup-banner-icon">🔔</div>
        <div class="setup-banner-content" style="flex:1;">
          <h3 id="comp-alert-title">Neue Alerts</h3>
          <div id="comp-alert-text"></div>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="markAlertsRead()">✓ Gelesen</button>
      </div>

      <!-- API Settings Panel (hidden by default) -->
      <div id="comp-settings-panel" style="display:none;margin-bottom:24px;">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Meta Ad Library API</div>
          </div>
          <div class="card-body">
            <div id="comp-api-status-banner" class="setup-banner" style="margin-bottom:20px;border-color:rgba(245,158,11,0.3);background:linear-gradient(135deg,rgba(245,158,11,0.08),rgba(6,182,212,0.05));">
              <div class="setup-banner-icon">⏳</div>
              <div class="setup-banner-content">
                <h3>Ad Library API Verifizierung läuft</h3>
                <p>Sobald freigeschaltet, werden hier automatisch Competitor-Ads geladen. Du kannst trotzdem schon Brands zur Watchlist hinzufügen.</p>
              </div>
            </div>
            <div class="form-group" style="max-width:600px;">
              <label class="form-label">API Access Token</label>
              <input class="form-input" id="comp-api-token" type="password" placeholder="Meta Ad Library API Token einfügen..." value="">
              <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Token wird lokal im Browser gespeichert (localStorage).</div>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px;">
              <button class="btn btn-primary btn-sm" onclick="saveCompetitorToken()">💾 Token speichern</button>
              <button class="btn btn-ghost btn-sm" onclick="clearCompetitorToken()">🗑️ Token löschen</button>
            </div>
            <div class="form-group" style="max-width:600px;margin-top:16px;">
              <label class="form-label">Eigener CPM-Referenzwert (€)</label>
              <input class="form-input" id="comp-own-cpm" type="number" step="0.01" placeholder="z.B. 8.50" value="">
              <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Wird zur genaueren Spend-Schätzung der Konkurrenz genutzt (Reach × CPM). Wird lokal gespeichert.</div>
              <div id="auto-cpm-info" style="display:none;font-size:11px;color:#8b5cf6;margin-top:4px;font-weight:600;"></div>
            </div>
            <div style="margin-top:8px;">
              <button class="btn btn-primary btn-sm" onclick="saveOwnCpm()">💾 CPM speichern</button>
              <button class="btn btn-ghost btn-sm" onclick="clearOwnCpm()">🗑️ CPM löschen</button>
            </div>
          </div>
        </div>
      </div>

      <!-- === COMPETITOR SUB-TAB: Overview === -->
      <div id="comp-sub-overview" class="comp-sub-tab">
        <!-- Stats Bar -->
        <div class="kpi-grid" id="comp-stats">
          <div class="kpi-card clickable" onclick="onCompStatClick('brands')" title="Beobachtete Accounts">
            <div class="kpi-label">Beobachtete Accounts</div>
            <div class="kpi-value" id="comp-stat-brands">0</div>
          </div>
          <div class="kpi-card clickable" onclick="onCompStatClick('total')" title="Erfasste Ads">
            <div class="kpi-label">Erfasste Ads</div>
            <div class="kpi-value" id="comp-stat-total">0</div>
          </div>
          <div class="kpi-card clickable" onclick="onCompStatClick('active')" title="Aktive Ads filtern">
            <div class="kpi-label">Aktive Ads</div>
            <div class="kpi-value" id="comp-stat-active" style="color:var(--green);">0</div>
          </div>
          <div class="kpi-card clickable" onclick="onCompStatClick('avg-days')" title="Nach Laufzeit sortieren">
            <div class="kpi-label">Ø Laufzeit</div>
            <div class="kpi-value" id="comp-stat-avg-days">–</div>
            <div style="font-size:11px;color:var(--text-muted);">Tage</div>
          </div>
          <div class="kpi-card clickable" onclick="onCompStatClick('longest')" title="Zur längsten Ad scrollen">
            <div class="kpi-label">Längste Ad</div>
            <div class="kpi-value" id="comp-stat-longest" style="color:var(--orange);">–</div>
            <div style="font-size:11px;color:var(--text-muted);">Tage</div>
          </div>
          <div class="kpi-card clickable" onclick="onCompStatClick('total-spend')" title="Gesamt AdSpend">
            <div class="kpi-label">Gesamt AdSpend</div>
            <div class="kpi-value" id="comp-stat-total-spend" style="color:var(--orange);">—</div>
            <div style="font-size:11px;color:var(--text-muted);">€ (geschätzt)</div>
          </div>
          <div class="kpi-card clickable" onclick="onCompStatClick('avg-spend')" title="Ø Spend pro Ad">
            <div class="kpi-label">Ø Spend/Ad</div>
            <div class="kpi-value" id="comp-stat-avg-spend">—</div>
            <div style="font-size:11px;color:var(--text-muted);">€</div>
          </div>
          <div class="kpi-card clickable" onclick="onCompStatClick('avg-cpm')" title="Ø CPM">
            <div class="kpi-label">Ø CPM</div>
            <div class="kpi-value" id="comp-stat-avg-cpm">—</div>
            <div style="font-size:11px;color:var(--text-muted);">€</div>
          </div>
        </div>

        <!-- Brand Overview -->
        <div style="margin-bottom:32px;" id="comp-brand-overview-section">
          <h2 style="font-size:18px;font-weight:800;margin-bottom:16px;">📊 Brand Overview</h2>
          <div id="comp-brand-overview-content" class="comp-brand-overview-grid"></div>
        </div>

        <!-- Watchlist Section -->
        <div style="margin-bottom:32px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <h2 style="font-size:18px;font-weight:800;">📋 Watchlist</h2>
            <button class="btn btn-primary btn-sm" onclick="openWatchlistModal()">+ Account hinzufügen</button>
          </div>

          <div id="comp-watchlist-loading" class="loading-spinner"><div class="spinner"></div></div>
          <div id="comp-watchlist-empty" style="display:none;" class="empty-state">
            <div class="empty-state-icon">👀</div>
            <div class="empty-state-title">Noch keine Brands auf der Watchlist</div>
            <div class="empty-state-desc">Füge Wettbewerber hinzu, um deren Ads zu beobachten.</div>
          </div>
          <div id="comp-watchlist-grid" class="comp-watchlist-grid" style="display:none;"></div>
        </div>
      </div>

      <!-- === COMPETITOR SUB-TAB: Ad Feed === -->
      <div id="comp-sub-feed" class="comp-sub-tab" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
          <h2 style="font-size:18px;font-weight:800;margin:0;">📰 Ad Feed</h2>
          <div class="comp-breadcrumb" id="comp-breadcrumb" style="margin-bottom:0;"></div>
        </div>

        <div class="filter-bar" id="comp-filter-bar">
          <select class="form-select" id="comp-filter-brand" onchange="onBrandFilterChange()">
            <option value="">Alle Brands</option>
          </select>
          <select class="form-select" id="comp-filter-standort" onchange="onStandortFilterChange()" style="display:none;">
            <option value="">📍 Alle Standorte</option>
          </select>
          <select class="form-select" id="comp-sort" onchange="applyCompetitorFilters()">
            <option value="newest">Neueste zuerst</option>
            <option value="longest">Längste Laufzeit</option>
            <option value="spend-desc">💰 Höchster Spend</option>
            <option value="spend-asc">💰 Niedrigster Spend</option>
          </select>
          <input type="text" class="comp-search-input" id="comp-search-input" placeholder="🔍 Standort oder Account suchen..." oninput="onCompSearchInput()">
        </div>

        <div id="comp-ads-loading" class="loading-spinner" style="display:none;"><div class="spinner"></div></div>
        <div id="comp-ads-empty" style="display:none;" class="empty-state">
          <div class="empty-state-icon">📭</div>
          <div class="empty-state-title">Keine Ads gefunden</div>
          <div class="empty-state-desc">Sobald die API verbunden ist und ein Sync durchgeführt wurde, erscheinen hier die Competitor-Ads.</div>
        </div>
        <div id="comp-ads-grid" class="comp-ads-grid" style="display:none;"></div>
        <div id="comp-load-more-container" class="comp-load-more-container" style="display:none;">
          <button class="comp-load-more-btn" id="comp-load-more-btn" onclick="loadMoreAds()">⬇️ Mehr laden</button>
          <div class="comp-ads-count" id="comp-ads-count"></div>
        </div>
      </div>

      <!-- === COMPETITOR SUB-TAB: Leaderboard === -->
      <div id="comp-sub-leaderboard" class="comp-sub-tab" style="display:none;">
        <h2 style="font-size:18px;font-weight:800;margin-bottom:16px;">🏆 Leaderboard</h2>
        <div style="display:flex;gap:8px;margin-bottom:16px;">
          <button class="ranking-tab active" id="lb-tab-longevity" onclick="switchLeaderboard('longevity')">⏱️ Laufzeit</button>
          <button class="ranking-tab" id="lb-tab-spend" onclick="switchLeaderboard('spend')">💰 AdSpend</button>
        </div>
        <div class="card">
          <div class="card-body" style="padding:0;overflow-x:auto;" id="comp-leaderboard-content">
            <div class="empty-state" style="padding:40px;">
              <div class="empty-state-desc">Keine Ads vorhanden</div>
            </div>
          </div>
        </div>
      </div>

      <!-- === COMPETITOR SUB-TAB: Trends === -->
      <div id="comp-sub-trends" class="comp-sub-tab" style="display:none;">
        <h2 style="font-size:18px;font-weight:800;margin-bottom:16px;">📈 Trends</h2>
        <div id="comp-trends-content"></div>
      </div>

      <!-- === COMPETITOR SUB-TAB: Insights === -->
      <div id="comp-sub-insights" class="comp-sub-tab" style="display:none;">
        <h2 style="font-size:18px;font-weight:800;margin-bottom:16px;">🧠 Competitor Intelligence Insights</h2>
        <div id="comp-insights-content">
          <div class="empty-state" style="padding:40px;">
            <div class="empty-state-desc">Lade Insights…</div>
          </div>
        </div>
      </div>

      <!-- === COMPETITOR SUB-TAB: Brand Detail === -->
      <div id="comp-sub-brand-detail" class="comp-sub-tab" style="display:none;">
        <div id="comp-brand-detail-content"></div>
      </div>

    </div>

    <!-- Watchlist Add/Edit Modal -->
    <div id="comp-watchlist-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);backdrop-filter:blur(4px);z-index:150;display:none;align-items:center;justify-content:center;">
      <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:32px;max-width:480px;width:90vw;box-shadow:var(--shadow-lg);">
        <h3 style="font-size:18px;font-weight:700;margin-bottom:20px;" id="comp-modal-title">Account zur Watchlist hinzufügen</h3>
        <input type="hidden" id="comp-modal-edit-id" value="">
        <div class="form-group" style="margin-bottom:16px;">
          <label class="form-label">Page Name *</label>
          <input class="form-input" id="comp-modal-pagename" placeholder="z.B. Engel & Völkers Hamburg">
        </div>
        <div class="form-group" style="margin-bottom:16px;">
          <label class="form-label">Facebook Page ID</label>
          <input class="form-input" id="comp-modal-pageid" placeholder="Optional – wird ggf. automatisch erkannt">
        </div>
        <div class="form-group" style="margin-bottom:20px;">
          <label class="form-label">Notizen</label>
          <input class="form-input" id="comp-modal-notes" placeholder="Optional">
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
          <button class="btn btn-secondary" onclick="closeWatchlistModal()">Abbrechen</button>
          <button class="btn btn-primary" onclick="saveWatchlistItem()">💾 Speichern</button>
        </div>
      </div>
    </div>

    <!-- ======== EXPOSÉS VIEW ======== -->
    <div id="view-exposes" class="view">
      <div class="expose-header">
        <h2>📝 Exposés</h2>
        <button class="btn btn-primary" onclick="openExposeUploadModal()">📤 Neues Exposé</button>
      </div>

      <div id="expose-list-container">
        <div class="expose-empty" id="expose-empty">
          <span class="empty-icon">📄</span>
          Noch keine Exposés hochgeladen.<br>Klicke auf "Neues Exposé" um zu starten.
        </div>
        <div class="expose-list" id="expose-list"></div>
      </div>

      <div class="expose-detail" id="expose-detail"></div>
    </div>

    <!-- Expose Upload Modal -->
    <div class="expose-modal-overlay" id="expose-upload-modal">
      <div class="expose-modal">
        <h3>📤 Neues Exposé hochladen</h3>

        <div class="expose-dropzone" id="expose-dropzone"
             ondragover="event.preventDefault(); this.classList.add('dragover');"
             ondragleave="this.classList.remove('dragover');"
             ondrop="handleExposeDrop(event);"
             onclick="document.getElementById('expose-file-input').click();">
          <span class="dropzone-icon">📁</span>
          PDF hier hineinziehen oder klicken
          <div class="dropzone-file" id="expose-file-name"></div>
          <input type="file" id="expose-file-input" accept=".pdf" style="display:none;" onchange="handleExposeFileSelect(event)">
        </div>

        <div class="expose-form-group">
          <label for="expose-client-select">Kunde</label>
          <select id="expose-client-select">
            <option value="">— Bitte wählen —</option>
            <option value="engel-voelkers">Engel &amp; Völkers</option>
            <option value="von-poll">Von Poll</option>
          </select>
        </div>

        <div class="expose-upload-status" id="expose-upload-status"></div>

        <div class="expose-modal-actions">
          <button class="btn btn-secondary" onclick="closeExposeUploadModal()">Abbrechen</button>
          <button class="btn btn-primary" id="expose-upload-btn" onclick="doExposeUpload()" disabled>📤 Hochladen</button>
        </div>
      </div>
    </div>

    <!-- ======== EDITORIAL PLANNER VIEW ======== -->
    <div id="view-editorial-planner" class="view">
      <div class="editorial-layout">
        <!-- Left Sidebar -->
        <div class="editorial-sidebar" id="editorial-sidebar">
          <div class="editorial-sidebar-header">
            <div class="editorial-sidebar-icon">F</div>
            <div>
              <div class="editorial-sidebar-title">Editorial Planner</div>
              <div class="editorial-sidebar-subtitle">R&G × Ferrari Hamburg</div>
            </div>
          </div>

          <div class="editorial-section-label">PLANUNGSZEITRAUM</div>
          <div class="editorial-period-row">
            <select id="ep-month" onchange="epLoadEntries()">
              <option value="1">Januar</option>
              <option value="2">Februar</option>
              <option value="3">März</option>
              <option value="4">April</option>
              <option value="5">Mai</option>
              <option value="6">Juni</option>
              <option value="7">Juli</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">Oktober</option>
              <option value="11">November</option>
              <option value="12">Dezember</option>
            </select>
            <select id="ep-year" onchange="epLoadEntries()" style="max-width:100px;"></select>
          </div>

          <button class="editorial-new-entry-btn" id="ep-new-btn" onclick="epShowForm()">
            Neuer Eintrag <span class="plus-icon">＋</span>
          </button>

          <!-- Entry Form (hidden by default) -->
          <div class="editorial-form" id="ep-form" style="display:none;">
            <div class="form-group">
              <label>Datum</label>
              <input type="date" id="ep-f-date">
            </div>
            <div class="form-group">
              <label>Uhrzeit</label>
              <input type="time" id="ep-f-time" value="17:00">
            </div>
            <div class="form-group">
              <label>Fahrzeug</label>
              <input type="text" id="ep-f-vehicle" placeholder="z.B. Ferrari 12 Cilindri">
            </div>
            <div class="form-group">
              <label>Titel</label>
              <input type="text" id="ep-f-title" placeholder="z.B. Ferrari History — Ozan">
            </div>
            <div class="form-group">
              <label>Content-Reihe</label>
              <select id="ep-f-series" onchange="epToggleCustomSeries()">
                <option value="">— Bitte wählen —</option>
                <option value="Konfiguration des Monats">Konfiguration des Monats</option>
                <option value="Tech Thursday">Tech Thursday</option>
                <option value="Ferrari History">Ferrari History</option>
                <option value="Neuzugang des Monats">Neuzugang des Monats</option>
                <option value="Event">Event</option>
                <option value="__custom__">Andere...</option>
              </select>
            </div>
            <div class="form-group" id="ep-f-custom-series-group" style="display:none;">
              <label>Eigene Reihe</label>
              <input type="text" id="ep-f-custom-series" placeholder="Name der Reihe">
            </div>
            <div class="form-group">
              <label>Location</label>
              <input type="text" id="ep-f-location" placeholder="z.B. Showroom Neuer Wall">
            </div>
            <div class="form-group">
              <label>Notizen</label>
              <textarea id="ep-f-notes" placeholder="Links, Notizen, Referenzen..."></textarea>
            </div>
            <div class="editorial-form-actions">
              <button class="btn btn-primary btn-sm" onclick="epSaveEntry()">Speichern</button>
              <button class="btn btn-secondary btn-sm" onclick="epCancelForm()">Abbrechen</button>
            </div>
          </div>

          <div class="editorial-section-label" id="ep-entries-label">EINTRÄGE (0)</div>
          <div class="editorial-entry-list" id="ep-entry-list"></div>

          <div class="editorial-section-label">AUSBLICK FOLGEMONAT</div>
          <textarea class="editorial-outlook-textarea" id="ep-outlook" placeholder="Ideen & Planung für den nächsten Monat..." onblur="epSaveOutlook()"></textarea>

          <div class="editorial-print-hint">
            <kbd>Cmd+P</kbd> oder <kbd>Strg+P</kbd> zum Drucken
          </div>
        </div>

        <!-- Right: A4 Preview -->
        <div class="editorial-preview-area">
          <div class="editorial-a4" id="ep-a4-preview">
            <div class="editorial-a4-header">
              <div class="editorial-a4-brand">
                <img src="assets/ferrari-logo.png" alt="Ferrari" style="width:44px;height:auto;">
                <div>
                  <div class="editorial-a4-brand-name">FERRARI</div>
                  <div class="editorial-a4-brand-sub">HAMBURG</div>
                </div>
              </div>
              <div class="editorial-a4-plan-title">
                <div class="rg-label"><span style="color:var(--accent)">R&G</span> Editorial Plan</div>
                <div class="month-label" id="ep-a4-month-label"></div>
              </div>
            </div>
            <div class="editorial-a4-separator"></div>
            <div id="ep-a4-entries">
              <div class="editorial-a4-empty">Noch keine Einträge für diesen Monat.</div>
            </div>
            <div id="ep-a4-outlook-section" style="display:none;">
              <div class="editorial-a4-outlook">
                <div class="editorial-a4-outlook-title">Ausblick Folgemonat</div>
                <div class="editorial-a4-outlook-text" id="ep-a4-outlook-text"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ======== MAP BUILDER VIEW ======== -->
    <div id="view-map-builder" class="view">
      <!-- Map Finder (Overview) -->
      <div id="mb-finder">
        <div class="mb-finder-header">
          <div>
            <div class="mb-finder-title">🗺️ Map Builder</div>
            <div class="mb-finder-subtitle">Erstelle und verwalte Immobilien-Umgebungskarten</div>
          </div>
          <button class="mb-btn mb-btn-accent" onclick="mb_newMap()" style="padding:10px 20px;font-size:14px;">➕ Neue Map erstellen</button>
        </div>
        <div id="mb-finder-list" class="mb-finder-grid">
          <div style="text-align:center;padding:40px"><span class="mb-spinner"></span></div>
        </div>
      </div>
      <!-- Map Editor (hidden initially) -->
      <div id="mb-editor-wrapper" style="display:none">
        <div id="mb-editor-topbar">
          <button class="mb-back-btn" onclick="mb_showFinder()">← Zurück zur Übersicht</button>
          <span class="mb-editor-sep">|</span>
          <span class="mb-editor-mapname" id="mb-editor-title">Neue Karte</span>
        </div>
      <div class="mb-layout">
        <!-- Map Builder Sidebar -->
        <div class="mb-sidebar" id="mb-sidebar">
          <!-- PROPERTY ADDRESS -->
          <div class="mb-sidebar-section">
            <div class="mb-section-header">
              <div class="mb-section-title"><span class="mb-section-icon">🏠</span> Objekt-Adresse</div>
            </div>
            <div class="mb-input-group">
              <input class="mb-input" id="mb-propertyAddress" type="text" placeholder="Adresse eingeben…"
                     onkeydown="if(event.key==='Enter') mb_geocodeProperty()">
            </div>
            <button class="mb-btn mb-btn-sm" onclick="mb_geocodeProperty()" id="mb-btnGeocode" style="width:100%">
              🔍 Adresse suchen
            </button>
            <div id="mb-propertyVerified" style="display:none" class="mb-verified-badge">
              ✓ <span id="mb-propertyCoords"></span>
            </div>
            <!-- Auto-POI Discovery -->
            <div id="mb-autoPoiSection" style="display:none; margin-top:10px;">
              <button class="mb-btn mb-btn-sm" id="mb-btnAutoPoi" onclick="mb_autoDiscoverPOIs()" style="width:100%; background:var(--blue); color:#fff;">
                🔍 POIs automatisch finden
              </button>
              <div id="mb-autoPoiStatus" style="display:none; margin-top:8px; text-align:center; font-size:12px; color:var(--text-muted); padding:8px;">
                <span class="mb-spinner" style="margin-right:6px;"></span> <span id="mb-autoPoiStatusText">Suche POIs in der Umgebung...</span>
              </div>
            </div>
          </div>

          <!-- POI LIST -->
          <div class="mb-sidebar-section">
            <div class="mb-section-header">
              <div class="mb-section-title"><span class="mb-section-icon">📍</span> Umgebung (POIs)</div>
              <button class="mb-btn mb-btn-sm" onclick="mb_showAddPOIForm()">+ Hinzufügen</button>
            </div>

            <!-- Add POI Form -->
            <div class="mb-add-form" id="mb-addPOIForm" style="display:none">
              <div class="mb-input-group">
                <label class="mb-input-label">Name</label>
                <input class="mb-input" id="mb-poiName" placeholder="z.B. Edeka, Grundschule…">
              </div>
              <div class="mb-input-group">
                <label class="mb-input-label">Adresse</label>
                <input class="mb-input" id="mb-poiAddress" placeholder="Straße, Stadt"
                       onkeydown="if(event.key==='Enter') mb_addPOI()">
              </div>
              <div class="mb-input-row">
                <div class="mb-input-group">
                  <label class="mb-input-label">Kategorie</label>
                  <select class="mb-input" id="mb-poiCategory" onchange="mb_updateCategoryDefaults()">
                    <option value="supermarket">Supermarkt</option>
                    <option value="doctor">Arzt / Krankenhaus</option>
                    <option value="school">Schule / Kita</option>
                    <option value="pool">Schwimmbad / Sport</option>
                    <option value="park">Park</option>
                    <option value="transport">ÖPNV / Haltestelle</option>
                    <option value="restaurant">Restaurant</option>
                    <option value="other">Sonstiges</option>
                  </select>
                  <input class="mb-input" id="mb-poiCustomCategory" placeholder="Eigene Kategorie (überschreibt Dropdown)" style="margin-top:6px;font-size:12px" oninput="mb_onCustomCategoryInput()">
                </div>
                <div class="mb-input-group">
                  <label class="mb-input-label">Pin-Größe</label>
                  <select class="mb-input" id="mb-poiSize">
                    <option value="small">Klein</option>
                    <option value="medium" selected>Mittel</option>
                    <option value="large">Groß</option>
                  </select>
                </div>
              </div>
              <div class="mb-input-group">
                <label class="mb-input-label">Pin-Farbe</label>
                <div class="mb-color-picker-row">
                  <input type="color" id="mb-poiColor" value="#525252">
                  <span id="mb-poiColorHex" style="font-size:11px;color:var(--text-muted)">#525252</span>
                </div>
              </div>
              <div class="mb-add-form-actions">
                <button class="mb-btn mb-btn-accent mb-btn-sm" onclick="mb_addPOI()" style="flex:1" id="mb-btnAddPOI">Hinzufügen</button>
                <button class="mb-btn mb-btn-sm" onclick="mb_hideAddPOIForm()">Abbrechen</button>
              </div>
            </div>

            <div class="mb-poi-list" id="mb-poiList">
              <div class="mb-empty-state" id="mb-poiEmpty">
                <div class="mb-empty-state-icon">📍</div>
                <div class="mb-empty-state-text">Noch keine POIs hinzugefügt.<br>Klicke „+ Hinzufügen".</div>
              </div>
            </div>
          </div>

          <!-- MAP STYLE -->
          <div class="mb-sidebar-section">
            <div class="mb-section-header">
              <div class="mb-section-title"><span class="mb-section-icon">🎨</span> Karten-Stil</div>
            </div>
            <div class="mb-input-group">
              <select class="mb-input" id="mb-mapStyle" onchange="mb_changeMapStyle()">
                <option value="clean">Sauber (Voyager, ohne Labels)</option>
                <option value="light">Hell (CartoDB Light)</option>
                <option value="detailed">Detailliert (Voyager)</option>
                <option value="grayscale">Graustufen (Stadia Smooth)</option>
                <option value="satellite">Satellit (Esri)</option>
                <option value="dark">Dunkel (CartoDB Dark)</option>
              </select>
            </div>
            <div class="mb-input-group">
              <label class="mb-input-label">Objekt-Pin Farbe</label>
              <div class="mb-color-picker-row">
                <input type="color" id="mb-mainPinColor" value="#070F59" onchange="mb_updateMainPin()">
                <span style="font-size:11px;color:var(--text-muted)" id="mb-mainPinColorHex">#070F59</span>
              </div>
            </div>
            <div class="mb-input-group">
              <label class="mb-input-label">Objekt-Pin Größe</label>
              <select class="mb-input" id="mb-mainPinSize" onchange="mb_updateMainPin()">
                <option value="small">Klein (32px)</option>
                <option value="medium">Mittel (44px)</option>
                <option value="large" selected>Groß (56px)</option>
              </select>
            </div>
            <div class="mb-input-group" style="display:flex;align-items:center;gap:8px;margin-top:8px">
              <input type="checkbox" id="mb-showLabels" checked onchange="mb_updateLabels()">
              <label for="mb-showLabels" style="font-size:12px;cursor:pointer">Smart Labels anzeigen</label>
            </div>
            <div class="mb-input-group" style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="mb-showConnectors" checked onchange="mb_updateLabels()">
              <label for="mb-showConnectors" style="font-size:12px;cursor:pointer">Verbindungslinien</label>
            </div>
          </div>

          <!-- SAVE / LOAD -->
          <div class="mb-sidebar-section">
            <div class="mb-section-header">
              <div class="mb-section-title"><span class="mb-section-icon">💾</span> Speichern & Laden</div>
            </div>
            <div class="mb-input-group">
              <input class="mb-input" id="mb-mapName" placeholder="Kartenname…">
            </div>
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <button class="mb-btn mb-btn-accent mb-btn-sm" onclick="mb_saveMap()" style="flex:1" id="mb-btnSave">💾 Speichern</button>
              <button class="mb-btn mb-btn-sm" onclick="mb_saveMapAs()" style="flex:1" id="mb-btnSaveAs">💾 Speichern als…</button>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:12px">
              <button class="mb-btn mb-btn-sm" onclick="mb_printMap()" style="flex:1">🖨️ Drucken</button>
              <button class="mb-btn mb-btn-accent mb-btn-sm" onclick="mb_exportPNG()" style="flex:1" id="mb-btnExport">📸 PNG Export</button>
            </div>
          </div>
        </div>

        <!-- Map Area -->
        <div class="mb-map-area" id="mb-mapArea">
          <div class="mb-map-inner" id="mb-mapInner">
            <div id="mb-map"></div>
            <div class="mb-map-controls">
              <button class="btn btn-sm" onclick="mb_fitAllPins()" style="background:rgba(255,255,255,0.95);backdrop-filter:blur(8px);box-shadow:var(--shadow-lg);font-size:12px;border:1px solid var(--border);">⛶ Alle Pins zeigen</button>
              <button class="btn btn-sm" onclick="mb_resetView()" style="background:rgba(255,255,255,0.95);backdrop-filter:blur(8px);box-shadow:var(--shadow-lg);font-size:12px;border:1px solid var(--border);">↺ Reset</button>
            </div>
            <!-- Labels rendered as DOM overlays -->
            <div id="mb-labelLayer" style="position:absolute;inset:0;z-index:800;pointer-events:none;overflow:hidden"></div>
            <!-- SVG for connector lines -->
            <svg id="mb-connectorLayer" style="position:absolute;inset:0;z-index:799;pointer-events:none;overflow:hidden"></svg>
          </div>
        </div>
      </div>
      <!-- Map Builder Toast Container -->
      <div class="mb-toast-container" id="mb-toastContainer"></div>
      </div><!-- /mb-editor-wrapper -->
    </div>

  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ============================================
// SUPABASE REST API (no SDK needed)
// ============================================
const SB_URL = 'https://lvhxabadywdqeepymwdm.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2aHhhYmFkeXdkcWVlcHltd2RtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTUyMjM3NSwiZXhwIjoyMDg1MDk4Mzc1fQ.3BWQG5yeG8nshvukSi3YksxUbg273tJDiZnU9fAlzY0';
const SB_HEADERS = { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

async function sbGet(table, query = '') {
  const res = await fetch(`${SB_URL}/rest/v1/${table}?${query}`, { headers: SB_HEADERS });
  if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.message || `HTTP ${res.status}`); }
  return res.json();
}

async function sbInsert(table, data) {
  const res = await fetch(`${SB_URL}/rest/v1/${table}`, { method: 'POST', headers: SB_HEADERS, body: JSON.stringify(data) });
  if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.message || `HTTP ${res.status}`); }
  return res.json();
}

async function sbPatch(table, id, data) {
  const res = await fetch(`${SB_URL}/rest/v1/${table}?id=eq.${id}`, {
    method: 'PATCH', headers: SB_HEADERS, body: JSON.stringify(data)
  });
  if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.message || `HTTP ${res.status}`); }
  return res.json();
}

async function sbDelete(table, id) {
  const res = await fetch(`${SB_URL}/rest/v1/${table}?id=eq.${id}`, {
    method: 'DELETE', headers: SB_HEADERS
  });
  if (!res.ok) throw new Error(await res.text());
}

// ============================================
// SETTINGS TABLE HELPERS
// ============================================
async function sbGetSetting(key) {
  try {
    const rows = await sbGet('settings', `key=eq.${encodeURIComponent(key)}&select=value`);
    return rows.length > 0 ? rows[0].value : null;
  } catch (e) {
    console.error('sbGetSetting error:', e);
    return null;
  }
}

async function sbSetSetting(key, value) {
  try {
    // Upsert: try update first, if no rows affected, insert
    const patchRes = await fetch(`${SB_URL}/rest/v1/settings?key=eq.${encodeURIComponent(key)}`, {
      method: 'PATCH',
      headers: { ...SB_HEADERS, 'Prefer': 'return=representation' },
      body: JSON.stringify({ value: value, updated_at: new Date().toISOString() })
    });
    const patchData = await patchRes.json().catch(() => []);
    if (patchData.length === 0) {
      // No existing row, insert new
      await sbInsert('settings', { key: key, value: value, updated_at: new Date().toISOString() });
    }
    return true;
  } catch (e) {
    console.error('sbSetSetting error:', e);
    return false;
  }
}

// Load Meta API token from Supabase and cache to localStorage
async function loadMetaApiToken() {
  try {
    const token = await sbGetSetting('meta_api_token');
    if (token) {
      localStorage.setItem('meta_ad_library_token', token);
      console.log('Meta API token loaded from Supabase');
    }
  } catch (e) {
    console.error('Failed to load Meta API token from Supabase:', e);
  }
}

// ============================================
// CITY RATING CLASSIFICATION
// ============================================
const CITY_RATINGS = {
  A: ['berlin','hamburg','münchen','munich','köln','cologne','frankfurt','düsseldorf','stuttgart'],
  B: ['hannover','nürnberg','bremen','dresden','leipzig','dortmund','essen','duisburg','bochum','wuppertal','bielefeld','bonn','münster','mannheim','karlsruhe','augsburg','wiesbaden','mönchengladbach','gelsenkirchen','braunschweig','aachen','kiel','chemnitz','halle','magdeburg','freiburg','krefeld','mainz','lübeck','erfurt','oberhausen','rostock','kassel','saarbrücken','potsdam','leverkusen','oldenburg','heidelberg','darmstadt','wolfsburg','regensburg','würzburg'],
  C: []
};

function getCityRating(city) {
  if (!city) return null;
  const c = city.toLowerCase().trim();
  if (CITY_RATINGS.A.includes(c)) return 'A';
  if (CITY_RATINGS.B.includes(c)) return 'B';
  return 'C';
}

function toggleNeubauFields(prefix) {
  var type = document.getElementById(prefix + '-prop-type').value;
  var fields = document.getElementById(prefix + '-neubau-fields');
  if (fields) {
    fields.style.display = type === 'neubauprojekt' ? 'block' : 'none';
  }
}

function autoFillCityRating(cityInputId, ratingSelectId) {
  const cityVal = document.getElementById(cityInputId).value;
  const ratingSelect = document.getElementById(ratingSelectId);
  const rating = getCityRating(cityVal);
  if (rating) ratingSelect.value = rating;
}

// ============================================
// STATE
// ============================================
let currentView = 'home';
let campaigns = [];
let clients = [];
let chartDaily = null;
let chartCPL = null;
let chartCreatives = null;
let dbReady = false;
let intelData = null;
let currentRanking = 'score';
let intelTimeFilter = 'alltime';
var intelCategoryFilter = 'all'; // 'all', 'neubauprojekt', 'einzel'
var dataIntelCategoryFilter = 'all'; // 'all', 'neubauprojekt', 'einzel'
let editCampaignId = null;
let editPropertyId = null;

// ============================================
// CREATIVE TYPE LABELS
// ============================================
const CREATIVE_TYPE_LABELS = {
  'single_image': 'Single Image',
  'carousel': 'Carousel',
  'scn_reel': 'SCN Reel',
  'th_reel': 'TH Reel',
  'video': 'Video',
  'story': 'Story',
  // Legacy fallbacks
  'reel': 'Reel',
  'image': 'Single Image'
};

function getCreativeTypeLabel(type) {
  return CREATIVE_TYPE_LABELS[type] || type || '—';
}

// ============================================
// CHART DEFAULTS
// ============================================
Chart.defaults.color = '#8f8f8f';
Chart.defaults.borderColor = '#e5e5e5';
Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.font.size = 11;
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.pointStyleWidth = 8;
Chart.defaults.plugins.tooltip.backgroundColor = '#ffffff';
Chart.defaults.plugins.tooltip.titleColor = '#0a0a0a';
Chart.defaults.plugins.tooltip.bodyColor = '#595959';
Chart.defaults.plugins.tooltip.borderColor = '#e5e5e5';
Chart.defaults.plugins.tooltip.borderWidth = 1;
Chart.defaults.plugins.tooltip.padding = 12;
Chart.defaults.plugins.tooltip.cornerRadius = 8;
Chart.defaults.plugins.tooltip.titleFont = { size: 12, weight: '600', family: "'Inter', sans-serif" };
Chart.defaults.plugins.tooltip.bodyFont = { size: 12, family: "'Inter', sans-serif" };

// ============================================
// HELPERS
// ============================================
function formatEur(val) {
  if (val == null || isNaN(val)) return '—';
  return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(val);
}

function formatNum(val) {
  if (val == null || isNaN(val)) return '—';
  return new Intl.NumberFormat('de-DE').format(val);
}

function formatDate(d) {
  if (!d) return '—';
  return new Date(d).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function formatDateShort(d) {
  if (!d) return '—';
  return new Date(d).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
}

function statusBadge(status) {
  const cls = status === 'active' ? 'badge-active' : status === 'paused' ? 'badge-paused' : 'badge-completed';
  const label = status === 'active' ? 'Aktiv' : status === 'paused' ? 'Pausiert' : 'Abgeschlossen';
  return `<span class="badge ${cls}"><span class="badge-dot"></span>${label}</span>`;
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} visible`;
  setTimeout(() => t.classList.remove('visible'), 3000);
}

// Performance Score: Leads × (avgCPL / creativeCPL)
// Rewards both volume AND efficiency
function calcScore(leads, cpl, avgCPL) {
  if (!leads || leads === 0 || !cpl || cpl === 0) return 0;
  return leads * (avgCPL / cpl);
}

// ============================================
// NAVIGATION — App-like with sections/sub-tabs
// ============================================
let _currentSection = 'home'; // 'home', 'analytics', 'competitors'
let _currentSubTab = null;
let _dropdownTimers = {};
let _competitorDataLoaded = false;

// Analytics sub-tab → view ID mapping
const ANALYTICS_TABS = {
  'campaigns': 'view-campaigns',
  'intelligence': 'view-intelligence',
  'data-intel': 'view-data-intel',
  'predictor': 'view-predictor',
  'compare': 'view-compare',
  'meta-import': 'view-meta-import'
};

// Views that belong to analytics section (including deep views)
const ANALYTICS_VIEWS = ['campaigns', 'intelligence', 'data-intel', 'predictor', 'compare', 'meta-import', 'detail', 'new-campaign', 'edit-campaign'];

// Competitor sub-tab → DOM ID mapping
const COMPETITOR_TABS = {
  'overview': 'comp-sub-overview',
  'feed': 'comp-sub-feed',
  'leaderboard': 'comp-sub-leaderboard',
  'trends': 'comp-sub-trends',
  'insights': 'comp-sub-insights'
};

// Clients sub-tab → view ID mapping
const CLIENTS_TABS = {
  'ferrari-editorial': 'view-editorial-planner'
};

function showView(sectionOrView, subTab) {
  // Close dropdowns
  closeAllDropdowns();

  // Determine section + subTab from arguments
  let section, viewId, activeSubTab;

  if (sectionOrView === 'home') {
    section = 'home';
    viewId = 'view-home';
    activeSubTab = null;
  } else if (sectionOrView === 'analytics') {
    section = 'analytics';
    activeSubTab = subTab || 'campaigns';
    viewId = ANALYTICS_TABS[activeSubTab] || 'view-campaigns';
  } else if (sectionOrView === 'competitors') {
    section = 'competitors';
    activeSubTab = subTab || 'overview';
    viewId = 'view-competitor';
  } else if (sectionOrView === 'detail' || sectionOrView === 'new-campaign' || sectionOrView === 'edit-campaign') {
    section = 'analytics';
    viewId = 'view-' + sectionOrView;
    activeSubTab = null; // deep view, no sub-tab highlight
  } else if (ANALYTICS_TABS[sectionOrView]) {
    // Legacy: direct view name that belongs to analytics
    section = 'analytics';
    activeSubTab = sectionOrView;
    viewId = ANALYTICS_TABS[sectionOrView];
  } else if (sectionOrView === 'competitor') {
    // Legacy: old 'competitor' view name
    section = 'competitors';
    activeSubTab = subTab || 'overview';
    viewId = 'view-competitor';
  } else if (sectionOrView === 'clients') {
    section = 'clients';
    activeSubTab = subTab || 'ferrari-editorial';
    viewId = CLIENTS_TABS[activeSubTab] || 'view-editorial-planner';
  } else if (sectionOrView === 'exposes') {
    section = 'exposes';
    viewId = 'view-exposes';
    activeSubTab = null;
  } else if (sectionOrView === 'map-builder') {
    section = 'map-builder';
    viewId = 'view-map-builder';
    activeSubTab = null;
  } else {
    // Fallback
    section = 'home';
    viewId = 'view-home';
    activeSubTab = null;
  }

  _currentSection = section;
  _currentSubTab = activeSubTab;
  currentView = sectionOrView;

  // Hide all views
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

  // Show the target view
  const el = document.getElementById(viewId);
  if (el) el.classList.add('active');

  // Handle competitor sub-tabs
  if (section === 'competitors') {
    document.querySelectorAll('.comp-sub-tab').forEach(t => t.style.display = 'none');
    const subEl = document.getElementById(COMPETITOR_TABS[activeSubTab] || 'comp-sub-overview');
    if (subEl) subEl.style.display = 'block';
  }

  // Update sub-navigation visibility
  updateSubNav(section, activeSubTab);

  // Update top nav active states
  updateNavActiveStates(section);

  // Update breadcrumbs
  updateBreadcrumbs(section, activeSubTab, sectionOrView);

  // Adjust main padding for sub-nav
  const mainEl = document.getElementById('app-main');
  if (section === 'analytics' || section === 'competitors') {
    mainEl.classList.add('has-sub-nav');
  } else {
    mainEl.classList.remove('has-sub-nav');
  }

  // Editorial planner: remove container padding for full-width layout
  if (section === 'clients') {
    mainEl.style.paddingTop = '64px';
  }

  // Map Builder: full-width layout, init map on first visit
  if (section === 'map-builder') {
    mainEl.style.paddingTop = '64px';
    if (!window._mbMapInitialized) {
      setTimeout(() => { mb_initMap(); window._mbMapInitialized = true; mb_showFinder(); }, 100);
    } else if (window._mbMap) {
      setTimeout(() => { window._mbMap.invalidateSize(); mb_updateLabels(); }, 100);
      mb_showFinder();
    }
  }

  // Scroll to top
  window.scrollTo(0, 0);

  // Load data for the view
  if (section === 'home') loadHomeStats();
  if (activeSubTab === 'campaigns' || sectionOrView === 'campaigns') loadCampaigns();
  if (sectionOrView === 'new-campaign') { resetCSVImport(); loadClientsForForm(); }
  if (activeSubTab === 'intelligence' || sectionOrView === 'intelligence') loadIntelligence();
  if (activeSubTab === 'data-intel' || sectionOrView === 'data-intel') loadDataIntelligence();
  if (activeSubTab === 'meta-import' || sectionOrView === 'meta-import') loadMetaCampaigns();
  if (section === 'competitors' && !_competitorDataLoaded) {
    loadCompetitorView();
    _competitorDataLoaded = true;
  } else if (section === 'competitors' && _competitorDataLoaded) {
    // Refresh stats/rendering for the active sub-tab
    if (activeSubTab === 'feed') applyCompetitorFilters();
    if (activeSubTab === 'leaderboard') renderLeaderboard();
    if (activeSubTab === 'trends') renderTrends();
    if (activeSubTab === 'insights') renderCompInsights();
  }
  if (section === 'clients') epInit();
  if (section === 'exposes') loadExposes();
  if (sectionOrView === 'detail' && editCampaignId) openCampaign(editCampaignId);
}

function updateSubNav(section, activeSubTab) {
  // Hide all sub-navs
  document.getElementById('sub-nav-analytics').classList.remove('visible');
  document.getElementById('sub-nav-competitors').classList.remove('visible');

  if (section === 'analytics') {
    const subNav = document.getElementById('sub-nav-analytics');
    subNav.classList.add('visible');
    // Highlight active tab
    subNav.querySelectorAll('.sub-nav-tab').forEach(t => {
      t.classList.toggle('active', t.dataset.subtab === activeSubTab);
    });
  } else if (section === 'competitors') {
    const subNav = document.getElementById('sub-nav-competitors');
    subNav.classList.add('visible');
    subNav.querySelectorAll('.sub-nav-tab').forEach(t => {
      t.classList.toggle('active', t.dataset.subtab === activeSubTab);
    });
  }
}

function updateNavActiveStates(section) {
  document.getElementById('nav-home').classList.toggle('active', section === 'home');
  document.getElementById('nav-analytics').classList.toggle('active', section === 'analytics');
  document.getElementById('nav-competitors').classList.toggle('active', section === 'competitors');
  document.getElementById('nav-clients').classList.toggle('active', section === 'clients');
  const navExposes = document.getElementById('nav-exposes');
  if (navExposes) navExposes.classList.toggle('active', section === 'exposes');
  const navMapBuilder = document.getElementById('nav-map-builder');
  if (navMapBuilder) navMapBuilder.classList.toggle('active', section === 'map-builder');
}

function updateBreadcrumbs(section, subTab, viewName) {
  const bc = document.getElementById('app-breadcrumbs');
  if (section === 'home') {
    bc.classList.remove('visible');
    bc.innerHTML = '';
    return;
  }

  let parts = ['<span class="app-bc-item" onclick="showView(\'home\')">🏠 Home</span>'];

  if (section === 'analytics') {
    if (viewName === 'detail') {
      parts.push('<span class="app-bc-sep">→</span>');
      parts.push('<span class="app-bc-item" onclick="showView(\'analytics\',\'campaigns\')">Analytics</span>');
      parts.push('<span class="app-bc-sep">→</span>');
      parts.push('<span class="app-bc-item" onclick="showView(\'analytics\',\'campaigns\')">Kampagnen</span>');
      const titleEl = document.getElementById('detail-title');
      if (titleEl && titleEl.textContent && titleEl.textContent !== '—') {
        parts.push('<span class="app-bc-sep">→</span>');
        parts.push('<span class="app-bc-current">' + escHtml(titleEl.textContent) + '</span>');
      }
    } else if (viewName === 'new-campaign') {
      parts.push('<span class="app-bc-sep">→</span>');
      parts.push('<span class="app-bc-item" onclick="showView(\'analytics\',\'campaigns\')">Analytics</span>');
      parts.push('<span class="app-bc-sep">→</span>');
      parts.push('<span class="app-bc-current">Neue Kampagne</span>');
    } else if (viewName === 'edit-campaign') {
      parts.push('<span class="app-bc-sep">→</span>');
      parts.push('<span class="app-bc-item" onclick="showView(\'analytics\',\'campaigns\')">Analytics</span>');
      parts.push('<span class="app-bc-sep">→</span>');
      parts.push('<span class="app-bc-current">Bearbeiten</span>');
    } else {
      parts.push('<span class="app-bc-sep">→</span>');
      const tabLabels = {campaigns:'Kampagnen',intelligence:'Creative Intelligence','data-intel':'Data Intelligence',predictor:'Prognose',compare:'Vergleich','meta-import':'Live-Tracking'};
      parts.push('<span class="app-bc-current">Analytics → ' + (tabLabels[subTab] || subTab) + '</span>');
    }
  } else if (section === 'competitors') {
    parts.push('<span class="app-bc-sep">→</span>');
    const tabLabels = {overview:'Overview',feed:'Ad Feed',leaderboard:'Leaderboard',trends:'Trends',insights:'Insights'};
    parts.push('<span class="app-bc-current">Competitors → ' + (tabLabels[subTab] || subTab) + '</span>');
  } else if (section === 'clients') {
    parts.push('<span class="app-bc-sep">→</span>');
    const clientLabels = {'ferrari-editorial':'Ferrari HH — Editorial Plan'};
    parts.push('<span class="app-bc-current">Clients → ' + (clientLabels[subTab] || subTab) + '</span>');
  } else if (section === 'exposes') {
    parts.push('<span class="app-bc-sep">→</span>');
    parts.push('<span class="app-bc-current">Exposés</span>');
  } else if (section === 'map-builder') {
    parts.push('<span class="app-bc-sep">→</span>');
    parts.push('<span class="app-bc-current">🗺️ Map Builder</span>');
  }

  bc.innerHTML = parts.join(' ');
  bc.classList.add('visible');
}

// Dropdown navigation
function handleNavClick(section) {
  closeAllDropdowns();
  showView(section);
}

function openNavDropdown(section) {
  cancelCloseDropdown(section);
  const dd = document.getElementById('dropdown-' + section);
  const btn = document.getElementById('nav-' + section);
  if (dd) dd.classList.add('open');
  if (btn) btn.classList.add('open');
}

function closeNavDropdown(section) {
  const dd = document.getElementById('dropdown-' + section);
  const btn = document.getElementById('nav-' + section);
  if (dd) dd.classList.remove('open');
  if (btn) btn.classList.remove('open');
}

function scheduleCloseDropdown(section) {
  _dropdownTimers[section] = setTimeout(() => closeNavDropdown(section), 200);
}

function cancelCloseDropdown(section) {
  if (_dropdownTimers[section]) {
    clearTimeout(_dropdownTimers[section]);
    _dropdownTimers[section] = null;
  }
}

function closeAllDropdowns() {
  ['analytics', 'competitors', 'clients'].forEach(s => {
    closeNavDropdown(s);
    cancelCloseDropdown(s);
  });
}

// Close dropdowns on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('.nav-item') && !e.target.closest('.nav-dropdown')) {
    closeAllDropdowns();
  }
});

// Mobile menu
function toggleMobileMenu() {
  const menu = document.getElementById('mobile-menu');
  const burger = document.getElementById('mobile-burger');
  menu.classList.toggle('open');
  burger.classList.toggle('open');
}

function closeMobileMenu() {
  const menu = document.getElementById('mobile-menu');
  const burger = document.getElementById('mobile-burger');
  menu.classList.remove('open');
  burger.classList.remove('open');
}

// Legacy compat
function toggleMobileNav() { toggleMobileMenu(); }
function closeMobileNav() { closeMobileMenu(); }

// ============================================
// HOME PAGE — LIVE-FIRST DASHBOARD
// ============================================
let _homeLeadsChart = null;
const BENCHMARK_CPL = 15; // Benchmark CPL in EUR

async function loadHomeStats() {
  if (!dbReady) return;
  try {
    // Load all campaigns with full metrics
    const camps = await sbGet('campaigns', 'select=id,status,campaign_name,start_date,total_budget,properties!inner(id,name,clients(name)),campaign_daily_metrics(date,spend,leads,impressions),creatives(id,creative_name,creative_type,thumbnail_url,creative_daily_metrics(date,spend,leads,impressions))');
    
    const total = camps.length;
    const activeCamps = camps.filter(c => c.status === 'active');
    const active = activeCamps.length;
    let totalLeads = 0;
    let totalSpend = 0;
    camps.forEach(c => {
      if (c.campaign_daily_metrics) {
        c.campaign_daily_metrics.forEach(m => {
          totalLeads += (m.leads || 0);
          totalSpend += (m.spend || 0);
        });
      }
    });
    const avgCPL = totalLeads > 0 ? totalSpend / totalLeads : 0;

    // Update history section KPIs
    document.getElementById('home-stat-total').textContent = formatNum(total);
    document.getElementById('home-stat-active').textContent = formatNum(active);
    document.getElementById('home-stat-cpl').textContent = avgCPL > 0 ? formatEur(avgCPL) : '–';
    document.getElementById('home-stat-leads').textContent = formatNum(totalLeads);

    // === SECTION 1: Live Status ===
    renderLiveCampaigns(activeCamps);
    renderLiveActionAlerts(activeCamps);

    // === SECTION 2: Creative Performance (Live) ===
    renderLiveCreativePerformance(activeCamps, avgCPL);

    // === SECTION 3: Competitor Watch ===
    renderLiveCompetitorAds();

    // === SECTION 4: History ===
    renderHomeLeadsChart(camps);
    renderHomeTopPerformer(camps);
    renderHomeAlertsActivity();

  } catch (e) {
    console.error('Home stats error:', e);
  }
}

// --- Section 1: Live Campaigns ---
function renderLiveCampaigns(activeCamps) {
  const grid = document.getElementById('live-campaigns-grid');
  const empty = document.getElementById('live-campaigns-empty');
  
  if (!activeCamps || activeCamps.length === 0) {
    grid.style.display = 'none';
    empty.style.display = 'block';
    return;
  }
  
  grid.style.display = 'grid';
  empty.style.display = 'none';
  
  const today = new Date().toISOString().slice(0, 10);
  
  grid.innerHTML = activeCamps.map(c => {
    const metrics = c.campaign_daily_metrics || [];
    const todayMetrics = metrics.filter(m => m.date === today);
    const spendToday = todayMetrics.reduce((s, m) => s + (m.spend || 0), 0);
    const leadsToday = todayMetrics.reduce((s, m) => s + (m.leads || 0), 0);
    const totalSpend = metrics.reduce((s, m) => s + (m.spend || 0), 0);
    const totalLeads = metrics.reduce((s, m) => s + (m.leads || 0), 0);
    const cpl = totalLeads > 0 ? totalSpend / totalLeads : null;
    const propName = c.properties ? c.properties.name : '—';
    const clientName = c.properties && c.properties.clients ? c.properties.clients.name : '';
    
    // Check for alerts
    const daysRunning = metrics.length;
    const hasZeroLeadsAlert = daysRunning >= 2 && daysRunning <= 3 && totalLeads === 0;
    const highCPLAlert = cpl && cpl > BENCHMARK_CPL * 2;
    const budgetAlert = c.total_budget && totalSpend > c.total_budget * 0.9;
    const hasAlert = hasZeroLeadsAlert || highCPLAlert || budgetAlert;
    
    return `
      <div class="live-campaign-card ${hasAlert ? 'has-alert' : ''}" onclick="openCampaign('${c.id}')">
        <div class="live-campaign-header">
          <div>
            <div class="live-campaign-name">${escHtml(c.campaign_name)}</div>
            <div class="live-campaign-property">${escHtml(clientName ? clientName + ' · ' : '')}${escHtml(propName)}</div>
          </div>
          <div class="live-campaign-status">
            <span class="badge badge-active"><span class="badge-dot"></span>Live</span>
          </div>
        </div>
        <div class="live-campaign-stats">
          <div class="live-campaign-stat">
            <div class="live-campaign-stat-label">Spend heute</div>
            <div class="live-campaign-stat-value">${formatEur(spendToday)}</div>
            <div class="live-campaign-stat-sub">/ ${formatEur(totalSpend)} gesamt</div>
          </div>
          <div class="live-campaign-stat">
            <div class="live-campaign-stat-label">Leads heute</div>
            <div class="live-campaign-stat-value">${leadsToday}</div>
            <div class="live-campaign-stat-sub">/ ${totalLeads} gesamt</div>
          </div>
          <div class="live-campaign-stat">
            <div class="live-campaign-stat-label">Aktueller CPL</div>
            <div class="live-campaign-stat-value ${cpl && cpl < 10 ? 'value-good' : cpl && cpl > 20 ? 'value-bad' : ''}">${cpl ? formatEur(cpl) : '—'}</div>
          </div>
          <div class="live-campaign-stat">
            <div class="live-campaign-stat-label">Laufzeit</div>
            <div class="live-campaign-stat-value">${daysRunning} Tage</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// --- Section 1: Action Alerts ---
function renderLiveActionAlerts(activeCamps) {
  const container = document.getElementById('live-action-alerts');
  const alerts = [];
  const today = new Date().toISOString().slice(0, 10);
  
  activeCamps.forEach(c => {
    const metrics = c.campaign_daily_metrics || [];
    const daysRunning = metrics.length;
    const totalSpend = metrics.reduce((s, m) => s + (m.spend || 0), 0);
    const totalLeads = metrics.reduce((s, m) => s + (m.leads || 0), 0);
    const cpl = totalLeads > 0 ? totalSpend / totalLeads : null;
    const propName = c.properties ? c.properties.name : c.campaign_name;
    
    // Alert: Day 2-3 with 0 leads
    if (daysRunning >= 2 && daysRunning <= 3 && totalLeads === 0) {
      alerts.push({
        type: 'warning',
        icon: '⚠️',
        title: propName + ': 0 Leads nach ' + daysRunning + ' Tagen',
        desc: 'Prüfe Targeting und Creative-Performance',
        action: 'Analysieren →',
        campaignId: c.id
      });
    }
    
    // Alert: CPL > 2x benchmark
    if (cpl && cpl > BENCHMARK_CPL * 2) {
      alerts.push({
        type: 'danger',
        icon: '🔴',
        title: propName + ': CPL zu hoch (' + formatEur(cpl) + ')',
        desc: 'Benchmark: ' + formatEur(BENCHMARK_CPL) + ' – aktuell ' + Math.round((cpl / BENCHMARK_CPL - 1) * 100) + '% drüber',
        action: 'Optimieren →',
        campaignId: c.id
      });
    }
    
    // Alert: Budget almost exhausted
    if (c.total_budget && totalSpend > c.total_budget * 0.9) {
      const pctUsed = Math.round((totalSpend / c.total_budget) * 100);
      alerts.push({
        type: 'info',
        icon: '💰',
        title: propName + ': Budget fast aufgebraucht',
        desc: pctUsed + '% des Budgets verbraucht (' + formatEur(totalSpend) + ' / ' + formatEur(c.total_budget) + ')',
        action: 'Details →',
        campaignId: c.id
      });
    }
    
    // Alert: Underperforming creatives
    const creatives = c.creatives || [];
    const zeroLeadCreatives = creatives.filter(cr => {
      const crMetrics = cr.creative_daily_metrics || [];
      const crSpend = crMetrics.reduce((s, m) => s + (m.spend || 0), 0);
      const crLeads = crMetrics.reduce((s, m) => s + (m.leads || 0), 0);
      return crSpend > 20 && crLeads === 0; // More than 20€ spent, 0 leads
    });
    if (zeroLeadCreatives.length > 0) {
      alerts.push({
        type: 'warning',
        icon: '🎨',
        title: propName + ': ' + zeroLeadCreatives.length + ' Creative(s) ohne Leads',
        desc: zeroLeadCreatives.map(cr => cr.creative_name).join(', ').substring(0, 50) + (zeroLeadCreatives.length > 1 ? '...' : ''),
        action: 'Abschalten? →',
        campaignId: c.id
      });
    }
  });
  
  if (alerts.length === 0) {
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'flex';
  container.innerHTML = alerts.map(a => `
    <div class="live-alert-item live-alert-${a.type}" onclick="openCampaign('${a.campaignId}')">
      <div class="live-alert-icon">${a.icon}</div>
      <div class="live-alert-content">
        <div class="live-alert-title">${escHtml(a.title)}</div>
        <div class="live-alert-desc">${escHtml(a.desc)}</div>
      </div>
      <div class="live-alert-action">${a.action}</div>
    </div>
  `).join('');
}

// --- Section 2: Live Creative Performance ---
function renderLiveCreativePerformance(activeCamps, globalAvgCPL) {
  const topContainer = document.getElementById('live-top-creatives');
  const bottomContainer = document.getElementById('live-bottom-creatives');
  
  // Collect all creatives from active campaigns
  const allCreatives = [];
  activeCamps.forEach(c => {
    const creatives = c.creatives || [];
    creatives.forEach(cr => {
      const crMetrics = cr.creative_daily_metrics || [];
      const crSpend = crMetrics.reduce((s, m) => s + (m.spend || 0), 0);
      const crLeads = crMetrics.reduce((s, m) => s + (m.leads || 0), 0);
      const crImpr = crMetrics.reduce((s, m) => s + (m.impressions || 0), 0);
      const cpl = crLeads > 0 ? crSpend / crLeads : null;
      const ctr = crImpr > 0 ? (crLeads / crImpr) * 100 : null;
      
      allCreatives.push({
        id: cr.id,
        name: cr.creative_name,
        type: cr.creative_type,
        thumbnailUrl: cr.thumbnail_url,
        campaignId: c.id,
        campaignName: c.campaign_name,
        propName: c.properties ? c.properties.name : '—',
        spend: crSpend,
        leads: crLeads,
        impressions: crImpr,
        cpl: cpl,
        ctr: ctr,
        score: calcScore(crLeads, cpl, globalAvgCPL || BENCHMARK_CPL)
      });
    });
  });
  
  if (allCreatives.length === 0) {
    topContainer.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:12px;">Keine Creatives in aktiven Kampagnen</div>';
    bottomContainer.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:12px;">—</div>';
    return;
  }
  
  // Sort by score for top performers
  const sortedByScore = [...allCreatives].sort((a, b) => b.score - a.score);
  const top3 = sortedByScore.slice(0, 3);
  
  // For bottom performers: creatives with spend but poor CPL or 0 leads
  const bottom3 = [...allCreatives]
    .filter(cr => cr.spend > 10) // Only consider creatives with some spend
    .sort((a, b) => {
      // 0 leads = worst, then sort by highest CPL
      if (a.leads === 0 && b.leads > 0) return -1;
      if (b.leads === 0 && a.leads > 0) return 1;
      if (a.leads === 0 && b.leads === 0) return b.spend - a.spend; // Most wasted spend first
      return (b.cpl || 0) - (a.cpl || 0); // Highest CPL first
    })
    .slice(0, 3);
  
  // Render top 3
  topContainer.innerHTML = top3.length > 0 ? top3.map((cr, idx) => {
    const medal = ['🥇', '🥈', '🥉'][idx] || '';
    const typeIcon = getCreativeTypeIcon(cr.type);
    return `
      <div class="creative-perf-item" onclick="openCampaign('${cr.campaignId}')">
        <div class="creative-perf-thumb">${typeIcon}</div>
        <div class="creative-perf-info">
          <div class="creative-perf-name">${medal} ${escHtml(cr.name)}</div>
          <div class="creative-perf-meta">
            <span>${escHtml(cr.propName)}</span>
            <span>${cr.leads} Leads</span>
          </div>
        </div>
        <div class="creative-perf-cpl value-good">${cr.cpl ? formatEur(cr.cpl) : '—'}</div>
      </div>
    `;
  }).join('') : '<div style="color:var(--text-muted);font-size:13px;padding:12px;">Noch keine Daten</div>';
  
  // Render bottom 3
  bottomContainer.innerHTML = bottom3.length > 0 ? bottom3.map(cr => {
    const typeIcon = getCreativeTypeIcon(cr.type);
    const isZeroLeads = cr.leads === 0;
    return `
      <div class="creative-perf-item" onclick="openCampaign('${cr.campaignId}')">
        <div class="creative-perf-thumb">${typeIcon}</div>
        <div class="creative-perf-info">
          <div class="creative-perf-name">${escHtml(cr.name)}</div>
          <div class="creative-perf-meta">
            <span>${escHtml(cr.propName)}</span>
            <span>${formatEur(cr.spend)} ausgegeben</span>
          </div>
          ${isZeroLeads ? '<div class="creative-perf-action">0 Leads – abschalten?</div>' : ''}
        </div>
        <div class="creative-perf-cpl ${cr.cpl && cr.cpl > BENCHMARK_CPL * 1.5 ? 'value-bad' : ''}">${cr.cpl ? formatEur(cr.cpl) : '0 Leads'}</div>
      </div>
    `;
  }).join('') : '<div style="color:var(--text-muted);font-size:13px;padding:12px;">Alle Creatives performen gut 👍</div>';
}

function getCreativeTypeIcon(type) {
  const icons = {
    'single_image': '🖼️',
    'carousel': '🎠',
    'video': '🎬',
    'reel': '📱',
    'scn_reel': '📱',
    'th_reel': '📱',
    'story': '📖',
    'image': '🖼️'
  };
  return icons[type] || '🎨';
}

// --- Section 3: Live Competitor Ads ---
async function renderLiveCompetitorAds() {
  const container = document.getElementById('live-competitor-ads');
  
  try {
    // Get newest competitor ads (fetch more to allow dedup, then take 3)
    const rawAds = await sbGet('competitor_ads', 'select=*,competitor_watchlist(brand,page_name)&order=ad_delivery_start_time.desc.nullsfirst,created_at.desc&limit=30');
    const ads = deduplicateAds(rawAds || []).slice(0, 3);
    
    if (!ads || ads.length === 0) {
      container.innerHTML = `
        <div style="grid-column:1/-1;text-align:center;padding:24px;color:var(--text-muted);">
          <div style="font-size:24px;margin-bottom:8px;">👀</div>
          <div style="font-size:13px;">Noch keine Competitor-Ads</div>
          <button class="btn btn-secondary btn-sm" style="margin-top:12px;" onclick="showView('competitors','overview')">Watchlist einrichten →</button>
        </div>
      `;
      return;
    }
    
    container.innerHTML = ads.map(a => {
      const brand = a.competitor_watchlist ? (a.competitor_watchlist.brand || a.competitor_watchlist.page_name) : (a.page_name || '—');
      const body = (a.ad_creative_bodies && a.ad_creative_bodies[0]) ? a.ad_creative_bodies[0] : '';
      const snippet = body.length > 80 ? body.substring(0, 80) + '…' : body;
      const startDate = a._earliestStart || (a.ad_delivery_start_time ? new Date(a.ad_delivery_start_time) : null);
      const now = new Date();
      const daysRunning = startDate ? Math.ceil((now - startDate) / 86400000) : null;
      const isNew = startDate && (now - startDate) < 7 * 86400000; // Less than 7 days old
      const adRunning = isAdRunningByDate(a);
      
      return `
        <div class="competitor-preview-card" onclick="showView('competitors','feed')">
          <div class="competitor-preview-header">
            <div class="competitor-preview-thumb">📢</div>
            <div class="competitor-preview-brand">
              <div class="competitor-preview-name">${escHtml(brand)}</div>
              ${isNew ? '<div class="competitor-preview-new">🆕 Neu</div>' : ''}
            </div>
          </div>
          <div class="competitor-preview-body">${escHtml(snippet) || '(Kein Text)'}</div>
          <div class="competitor-preview-footer">
            <span>${daysRunning !== null ? daysRunning + ' Tage' : '—'}</span>
            <span>${adRunning ? '🟢 Laufend' : '⏹ Beendet'}</span>
          </div>
        </div>
      `;
    }).join('');
    
  } catch (e) {
    console.error('Competitor ads load error:', e);
    container.innerHTML = `
      <div style="grid-column:1/-1;text-align:center;padding:24px;color:var(--text-muted);">
        <div style="font-size:13px;">Competitor-Daten werden geladen...</div>
      </div>
    `;
  }
}

function renderHomeLeadsChart(camps) {
  const canvas = document.getElementById('homeLeadsChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  if (_homeLeadsChart) _homeLeadsChart.destroy();

  // Aggregate leads per day across ALL campaigns (last 30 days)
  const now = new Date();
  const thirtyDaysAgo = new Date(now.getTime() - 30 * 86400000);
  const cutoff = thirtyDaysAgo.toISOString().slice(0, 10);

  const dailyMap = {};
  camps.forEach(c => {
    (c.campaign_daily_metrics || []).forEach(m => {
      if (m.date >= cutoff) {
        if (!dailyMap[m.date]) dailyMap[m.date] = 0;
        dailyMap[m.date] += (m.leads || 0);
      }
    });
  });

  // Fill in missing dates
  const labels = [];
  const data = [];
  for (let d = new Date(thirtyDaysAgo); d <= now; d.setDate(d.getDate() + 1)) {
    const key = d.toISOString().slice(0, 10);
    labels.push(formatDateShort(key));
    data.push(dailyMap[key] || 0);
  }

  _homeLeadsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Leads',
        data,
        borderColor: 'rgba(231, 53, 46, 1)',
        backgroundColor: 'rgba(231, 53, 46, 0.08)',
        borderWidth: 2,
        pointRadius: 2,
        pointHoverRadius: 5,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (tooltipCtx) => tooltipCtx.raw + ' Leads'
          }
        }
      },
      scales: {
        x: { grid: { display: false }, ticks: { maxTicksLimit: 10 } },
        y: { beginAtZero: true, grid: { color: '#f0f0f0' }, ticks: { stepSize: 1 } }
      }
    }
  });
}

function renderHomeTopPerformer(camps) {
  const container = document.getElementById('home-top-performer');
  if (!container) return;

  // Find campaign with lowest CPL (best performer)
  let bestCamp = null;
  let bestCPL = Infinity;

  camps.forEach(c => {
    const metrics = c.campaign_daily_metrics || [];
    const spend = metrics.reduce((s, m) => s + (m.spend || 0), 0);
    const leads = metrics.reduce((s, m) => s + (m.leads || 0), 0);
    if (leads > 0) {
      const cpl = spend / leads;
      if (cpl < bestCPL) {
        bestCPL = cpl;
        bestCamp = { ...c, totalSpend: spend, totalLeads: leads, cpl };
      }
    }
  });

  if (!bestCamp) {
    container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;">Noch keine Kampagnen mit Leads</div>';
    return;
  }

  const propName = bestCamp.properties ? bestCamp.properties.name : '—';
  const statusCls = bestCamp.status === 'active' ? 'badge-active' : bestCamp.status === 'paused' ? 'badge-paused' : 'badge-completed';
  const statusLabel = bestCamp.status === 'active' ? 'Aktiv' : bestCamp.status === 'paused' ? 'Pausiert' : 'Abgeschlossen';

  container.innerHTML =
    '<div class="home-performer-name" onclick="openCampaign(\'' + bestCamp.id + '\')">' + escHtml(bestCamp.campaign_name) + '</div>' +
    '<div class="home-performer-detail">' + escHtml(propName) + ' · ' + bestCamp.totalLeads + ' Leads</div>' +
    '<div style="display:flex;align-items:center;gap:12px;">' +
      '<div class="home-performer-cpl">' + formatEur(bestCPL) + ' CPL</div>' +
      '<span class="badge ' + statusCls + '"><span class="badge-dot"></span>' + statusLabel + '</span>' +
    '</div>' +
    '<div style="margin-top:10px;"><span class="app-bc-item" style="font-size:12px;color:var(--accent);" onclick="openCampaign(\'' + bestCamp.id + '\')">Details ansehen →</span></div>';
}

async function renderHomeAlertsActivity() {
  const container = document.getElementById('home-alerts-activity');
  if (!container) return;

  let items = [];

  // Try to load recent competitor alerts
  try {
    const alerts = await sbGet('competitor_alerts', 'select=*&order=created_at.desc&limit=5');
    if (alerts && alerts.length > 0) {
      alerts.forEach(a => {
        const info = getAlertTypeInfo(a.alert_type);
        const msg = a.message || info.label;
        const shortMsg = msg.length > 80 ? msg.substring(0, 80) + '…' : msg;
        items.push({ icon: info.icon, text: shortMsg });
      });
    }
  } catch (e) {
    // No alerts table or error — skip
  }

  if (items.length === 0) {
    items.push({ icon: '📊', text: 'Dashboard bereit — starte mit einer neuen Kampagne' });
  }

  container.innerHTML = items.map(i =>
    '<div class="home-activity-item">' +
      '<span class="home-activity-icon">' + i.icon + '</span>' +
      '<span>' + escHtml(i.text) + '</span>' +
    '</div>'
  ).join('') +
  '<div style="margin-top:10px;"><span class="app-bc-item" style="font-size:12px;color:var(--accent);" onclick="showView(\'competitors\',\'overview\')">Alle anzeigen →</span></div>';
}

// ============================================
// DATA LOADING
// ============================================
async function checkDatabase() {
  try {
    await sbGet('clients', 'select=id&limit=1');
    dbReady = true;
    document.getElementById('setup-banner').style.display = 'none';
    return true;
  } catch (e) {
    console.error('DB-Prüfung fehlgeschlagen:', e);
    document.getElementById('setup-banner').style.display = 'flex';
    document.getElementById('campaigns-loading').style.display = 'none';
    document.getElementById('campaigns-empty').style.display = 'block';
    dbReady = false;
    return false;
  }
}

async function loadCampaigns() {
  if (!dbReady) return;

  const loading = document.getElementById('campaigns-loading');
  const table = document.getElementById('campaigns-table');
  const empty = document.getElementById('campaigns-empty');
  const tbody = document.getElementById('campaigns-tbody');

  loading.style.display = 'flex';
  table.style.display = 'none';
  empty.style.display = 'none';

  try {
    const params = new URLSearchParams();
    params.set('select', '*,properties!inner(*,clients!inner(name,brand)),campaign_daily_metrics(spend,leads,impressions)');
    params.set('order', 'created_at.desc');

    const statusFilter = document.getElementById('filter-status').value;
    const clientFilter = document.getElementById('filter-client').value;

    if (statusFilter) params.set('status', `eq.${statusFilter}`);
    if (clientFilter) params.set('properties.client_id', `eq.${clientFilter}`);

    const data = await sbGet('campaigns', params.toString());
    campaigns = data || [];

    if (campaigns.length === 0) {
      loading.style.display = 'none';
      empty.style.display = 'block';
      return;
    }

    tbody.innerHTML = campaigns.map(c => {
      const metrics = c.campaign_daily_metrics || [];
      const totalSpend = metrics.reduce((s, m) => s + (m.spend || 0), 0);
      const totalLeads = metrics.reduce((s, m) => s + (m.leads || 0), 0);
      const cpl = totalLeads > 0 ? totalSpend / totalLeads : null;
      const property = c.properties;
      const client = property?.clients;
      const cityRating = property?.location_rating || getCityRating(property?.city);
      const cityBadge = property?.city ? `<span style="margin-left:6px;font-size:11px;color:var(--text-muted);background:var(--bg-input);padding:1px 6px;border-radius:4px;">${escHtml(property.city)}${cityRating ? ' ('+cityRating+')' : ''}</span>` : '';

      const liveBadge = c.is_live ? ' <span class="badge-live">🟢 Live</span>' : '';

      return `
        <tr onclick="openCampaign('${c.id}')">
          <td>
            <div class="campaign-name">${escHtml(c.campaign_name)}${liveBadge}</div>
            <div class="campaign-property">${escHtml(client?.name || '—')} · ${escHtml(property?.name || '—')}${cityBadge}</div>
          </td>
          <td>${statusBadge(c.status)}</td>
          <td class="value-eur">${formatEur(totalSpend)}</td>
          <td><strong>${formatNum(totalLeads)}</strong></td>
          <td class="value-eur ${cpl && cpl < 10 ? 'value-good' : cpl && cpl > 15 ? 'value-bad' : ''}">${cpl ? formatEur(cpl) : '—'}</td>
          <td style="color:var(--text-secondary);font-size:13px;">
            ${formatDate(c.start_date)}${c.end_date ? ' – ' + formatDate(c.end_date) : ' – laufend'}
          </td>
        </tr>
      `;
    }).join('');

    loading.style.display = 'none';
    table.style.display = 'table';
  } catch (e) {
    console.error('[Kampagnen] Ladefehler:', e);
    loading.style.display = 'none';
    empty.style.display = 'block';
    empty.innerHTML = `
      <div class="empty-state-icon">⚠️</div>
      <div class="empty-state-title">Fehler beim Laden</div>
      <div class="empty-state-desc" style="color:var(--red);font-family:monospace;font-size:12px;">${escHtml(e?.message || String(e))}</div>
    `;
  }
}

async function loadClients() {
  if (!dbReady) return;
  const data = await sbGet('clients', 'select=*&order=name');
  clients = data || [];

  const filter = document.getElementById('filter-client');
  const current = filter.value;
  filter.innerHTML = '<option value="">Alle Kunden</option>' +
    clients.map(c => `<option value="${c.id}">${escHtml(c.name)}</option>`).join('');
  filter.value = current;
}

async function loadClientsForForm() {
  if (!dbReady) return;
  const data = await sbGet('clients', 'select=*&order=name');
  const clientOptions = (data || []).map(c => `<option value="${c.id}">${escHtml(c.name)}${c.brand ? ' (' + escHtml(c.brand) + ')' : ''}</option>`).join('');

  // Manual form
  const select = document.getElementById('form-client');
  if (select) select.innerHTML = '<option value="">— Neuen Kunden anlegen —</option>' + clientOptions;

  // CSV import form
  const csvSelect = document.getElementById('csv-client');
  if (csvSelect) {
    const prev = csvSelect.value;
    csvSelect.innerHTML = '<option value="">— Neuen Kunden anlegen —</option>' + clientOptions;
    if (prev) csvSelect.value = prev;
  }

  // Edit form
  const editSelect = document.getElementById('edit-client');
  if (editSelect) {
    const prev = editSelect.value;
    editSelect.innerHTML = clientOptions;
    if (prev) editSelect.value = prev;
  }
}

function toggleNewClient(select) {
  const group = document.getElementById('form-new-client-group');
  group.style.display = select.value ? 'none' : 'flex';
}

function toggleCSVNewClient(select) {
  const nameGroup = document.getElementById('csv-new-client-group');
  const brandGroup = document.getElementById('csv-brand-group');
  const hidden = select.value ? true : false;
  nameGroup.style.display = hidden ? 'none' : 'flex';
  brandGroup.style.display = hidden ? 'none' : 'flex';
}

// ============================================
// CAMPAIGN DETAIL
// ============================================
let _openingCampaign = false;
async function openCampaign(id) {
  if (_openingCampaign) return;
  _openingCampaign = true;
  showView('detail');

  try {
    const campaigns = await sbGet('campaigns', `select=*,properties(*,clients(*)),campaign_daily_metrics(*),creatives(*,creative_daily_metrics(*))&id=eq.${id}`);
    const campaign = campaigns[0];
    if (!campaign) throw new Error('Kampagne nicht gefunden');

    const property = campaign.properties;
    const client = property?.clients;
    const metrics = (campaign.campaign_daily_metrics || []).sort((a, b) => a.date.localeCompare(b.date));
    const creatives = campaign.creatives || [];

    // Store for editing
    editCampaignId = campaign.id;
    editPropertyId = property?.id;
    window._editCampaignData = campaign;
    window._editPropertyData = property;

    // Store meta info for sync button
    _currentCampaignMeta = campaign.meta_campaign_id ? {
      id: campaign.id,
      meta_campaign_id: campaign.meta_campaign_id,
      name: campaign.campaign_name
    } : null;

    // Header (no platform badge — always Meta)
    const liveSuffix = campaign.is_live ? ' <span class="badge-live">🟢 Live</span>' : '';
    document.getElementById('detail-title').innerHTML = escHtml(campaign.campaign_name) + liveSuffix;
    document.getElementById('detail-subtitle').innerHTML =
      `${escHtml(client?.name || '—')} · ${escHtml(property?.name || '—')}${property?.stadtteil ? ', ' + escHtml(property.stadtteil) : ''}`;
    document.getElementById('detail-status').innerHTML = statusBadge(campaign.status);

    // Live tracking banner
    const liveBanner = document.getElementById('detail-live-banner');
    if (liveBanner) liveBanner.style.display = campaign.is_live ? 'flex' : 'none';

    // Property details
    const locRating = property?.location_rating || getCityRating(property?.city) || '—';
    const microLoc = property?.micro_location ? ({premium:'Premium',gut:'Gut',standard:'Standard',randlage:'Randlage'}[property.micro_location] || property.micro_location) : '—';
    const propTypeLabel = {wohnung:'Wohnung',haus:'Haus',penthouse:'Penthouse',villa:'Villa',reihenhaus:'Reihenhaus',grundstueck:'Grundstück',gewerbe:'Gewerbe',neubauprojekt:'Neubauprojekt',zweifamilienhaus:'Zweifamilienhaus',doppelhaushaelfte:'Doppelhaushälfte',sonstige:'Sonstige'}[property?.property_type] || property?.property_type || '—';

    document.getElementById('detail-property-info').innerHTML = `
      <div><div class="kpi-label">Adresse</div><div style="font-weight:600;">${escHtml(property?.address || '—')}</div></div>
      <div><div class="kpi-label">PLZ / Stadt</div><div style="font-weight:600;">${escHtml(property?.plz || '')} ${escHtml(property?.city || '—')}</div></div>
      <div><div class="kpi-label">Stadtteil</div><div style="font-weight:600;">${escHtml(property?.stadtteil || '—')}</div></div>
      <div><div class="kpi-label">Objektart</div><div style="font-weight:600;">${escHtml(propTypeLabel)}</div></div>
      <div><div class="kpi-label">Wohnfläche</div><div style="font-weight:600;">${property?.size_sqm ? property.size_sqm + ' qm' : '—'}</div></div>
      <div><div class="kpi-label">Grundstück</div><div style="font-weight:600;">${property?.plot_size ? property.plot_size + ' qm' : '—'}</div></div>
      <div><div class="kpi-label">Zimmer</div><div style="font-weight:600;">${property?.rooms || '—'}</div></div>
      <div><div class="kpi-label">Preis</div><div style="font-weight:600;">${property?.price ? formatEur(property.price) : '—'}</div></div>
      ${property?.property_type === 'neubauprojekt' ? `
      <div><div class="kpi-label">Preis von</div><div style="font-weight:600;">${property?.price_from ? formatEur(property.price_from) : '—'}</div></div>
      <div><div class="kpi-label">Preis bis</div><div style="font-weight:600;">${property?.price_to ? formatEur(property.price_to) : '—'}</div></div>
      <div><div class="kpi-label">Fläche von</div><div style="font-weight:600;">${property?.size_from ? property.size_from + ' qm' : '—'}</div></div>
      <div><div class="kpi-label">Fläche bis</div><div style="font-weight:600;">${property?.size_to ? property.size_to + ' qm' : '—'}</div></div>
      <div><div class="kpi-label">Einheiten</div><div style="font-weight:600;">${property?.num_units || '—'}</div></div>
      ` : ''}
      <div><div class="kpi-label">Standort-Rating</div><div style="font-weight:600;"><span class="badge badge-active" style="font-size:12px;">${locRating}</span></div></div>
      <div><div class="kpi-label">Mikrolage</div><div style="font-weight:600;">${escHtml(microLoc)}</div></div>
    `;

    // KPIs
    const totalSpend = metrics.reduce((s, m) => s + (m.spend || 0), 0);
    const totalLeads = metrics.reduce((s, m) => s + (m.leads || 0), 0);
    const totalImpressions = metrics.reduce((s, m) => s + (m.impressions || 0), 0);
    const totalReach = metrics.reduce((s, m) => s + (m.reach || 0), 0);
    const avgCPL = totalLeads > 0 ? totalSpend / totalLeads : null;
    const avgCPM = totalImpressions > 0 ? (totalSpend / totalImpressions) * 1000 : null;
    const days = metrics.length;
    const avgLeadsDay = days > 0 ? totalLeads / days : 0;

    document.getElementById('detail-kpis').innerHTML = `
      <div class="kpi-card">
        <div class="kpi-label">Gesamtausgaben</div>
        <div class="kpi-value">${formatEur(totalSpend)}</div>
        <div class="kpi-change neutral">${days} Tage · Ø ${formatEur(totalSpend / Math.max(days, 1))}/Tag</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Leads gesamt</div>
        <div class="kpi-value">${totalLeads}</div>
        <div class="kpi-change neutral">Ø ${avgLeadsDay.toFixed(1)} Leads/Tag</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Ø Cost per Lead</div>
        <div class="kpi-value ${avgCPL && avgCPL < 10 ? 'value-good' : avgCPL && avgCPL > 15 ? 'value-bad' : ''}">${avgCPL ? formatEur(avgCPL) : '—'}</div>
        <div class="kpi-change ${avgCPL && avgCPL < 10 ? 'positive' : avgCPL && avgCPL > 15 ? 'negative' : 'neutral'}">${avgCPL && avgCPL < 10 ? '✓ Unter 10 €' : avgCPL && avgCPL > 15 ? '⚠ Über 15 €' : 'Im Zielbereich'}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Impressions</div>
        <div class="kpi-value">${formatNum(totalImpressions)}</div>
        <div class="kpi-change neutral">Reichweite: ${formatNum(totalReach)}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Ø CPM</div>
        <div class="kpi-value">${avgCPM ? formatEur(avgCPM) : '—'}</div>
        <div class="kpi-change neutral">Pro 1.000 Impressions</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Lead-Rate</div>
        <div class="kpi-value">${totalImpressions > 0 ? ((totalLeads / totalImpressions) * 100).toFixed(2) + '%' : '—'}</div>
        <div class="kpi-change neutral">Leads / Impressions</div>
      </div>
    `;

    // === BENCHMARKS ===
    renderBenchmarks(campaign, property, { totalSpend, totalLeads, totalImpressions, totalReach, avgCPL, avgCPM, days, avgLeadsDay });

    // === CHARTS ===
    renderDailyChart(metrics);
    renderCPLChart(metrics);
    renderCreativeChart(creatives, avgCPL);
    renderCreativeCards(creatives, avgCPL);

  } catch (e) {
    console.error('Kampagnendetail-Ladefehler:', e);
    showToast('Fehler beim Laden der Kampagne', 'error');
  } finally {
    _openingCampaign = false;
  }
}

function renderDailyChart(metrics) {
  const ctx = document.getElementById('chart-daily').getContext('2d');
  if (chartDaily) chartDaily.destroy();

  const labels = metrics.map(m => formatDateShort(m.date));
  const spendData = metrics.map(m => m.spend || 0);
  const leadsData = metrics.map(m => m.leads || 0);

  chartDaily = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Leads',
          data: leadsData,
          backgroundColor: 'rgba(231, 53, 46, 0.7)',
          borderColor: 'rgba(231, 53, 46, 1)',
          borderWidth: 1,
          borderRadius: 4,
          yAxisID: 'y1',
          order: 2
        },
        {
          label: 'Spend (€)',
          data: spendData,
          type: 'line',
          borderColor: 'rgba(6, 182, 212, 1)',
          backgroundColor: 'rgba(6, 182, 212, 0.1)',
          borderWidth: 2,
          pointRadius: 2,
          pointHoverRadius: 5,
          fill: true,
          tension: 0.3,
          yAxisID: 'y',
          order: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        tooltip: {
          callbacks: {
            label: (ctx) => {
              if (ctx.dataset.label === 'Spend (€)') return `Spend: ${formatEur(ctx.raw)}`;
              return `Leads: ${ctx.raw}`;
            }
          }
        }
      },
      scales: {
        x: { grid: { display: false } },
        y: {
          position: 'left',
          title: { display: true, text: 'Spend (€)', color: '#06b6d4' },
          grid: { color: 'rgba(38, 38, 54, 0.5)' },
          ticks: { callback: v => v + ' €' }
        },
        y1: {
          position: 'right',
          title: { display: true, text: 'Leads', color: '#e7352e' },
          grid: { display: false },
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });
}

function renderCPLChart(metrics) {
  const ctx = document.getElementById('chart-cpl').getContext('2d');
  if (chartCPL) chartCPL.destroy();

  const filtered = metrics.filter(m => m.leads > 0);
  const labels = filtered.map(m => formatDateShort(m.date));
  const cplData = filtered.map(m => m.cpl || (m.spend / m.leads));
  const avgCPL = cplData.reduce((s, v) => s + v, 0) / Math.max(cplData.length, 1);

  chartCPL = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'CPL (€)',
          data: cplData,
          borderColor: 'rgba(245, 158, 11, 1)',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          borderWidth: 2,
          pointRadius: 3,
          pointHoverRadius: 6,
          pointBackgroundColor: cplData.map(v => v <= avgCPL ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)'),
          fill: true,
          tension: 0.3
        },
        {
          label: 'Ø CPL',
          data: new Array(labels.length).fill(avgCPL),
          borderColor: 'rgba(255, 255, 255, 0.2)',
          borderWidth: 1,
          borderDash: [5, 5],
          pointRadius: 0,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${formatEur(ctx.raw)}`
          }
        }
      },
      scales: {
        x: { grid: { display: false } },
        y: {
          grid: { color: 'rgba(38, 38, 54, 0.5)' },
          ticks: { callback: v => v.toFixed(0) + ' €' },
          beginAtZero: true
        }
      }
    }
  });
}

function renderCreativeChart(creatives, avgCPL) {
  const ctx = document.getElementById('chart-creatives').getContext('2d');
  if (chartCreatives) chartCreatives.destroy();

  // Aggregate metrics per creative with scores
  const creativeData = creatives.map(c => {
    const metrics = c.creative_daily_metrics || [];
    const totalSpend = metrics.reduce((s, m) => s + (m.spend || 0), 0);
    const totalLeads = metrics.reduce((s, m) => s + (m.leads || 0), 0);
    const cpl = totalLeads > 0 ? totalSpend / totalLeads : 0;
    const score = calcScore(totalLeads, cpl, avgCPL || 1);
    return { name: c.creative_name, type: c.creative_type, spend: totalSpend, leads: totalLeads, cpl, score };
  });

  // Sort by score (descending)
  creativeData.sort((a, b) => b.score - a.score);

  // Winner is the first one with score > 0
  const winnerIdx = creativeData.findIndex(c => c.score > 0);

  const labels = creativeData.map((c, i) => {
    if (i === winnerIdx) return `⭐ ${c.name}`;
    return c.name;
  });
  const cplValues = creativeData.map(c => c.cpl);
  const leadsValues = creativeData.map(c => c.leads);

  // Single color for all CPL bars, gold border for winner
  const bgColor = 'rgba(231, 53, 46, 0.7)';
  const borderColors = creativeData.map((c, i) =>
    i === winnerIdx ? 'rgba(251, 191, 36, 1)' : 'rgba(231, 53, 46, 1)'
  );
  const borderWidths = creativeData.map((c, i) => i === winnerIdx ? 3 : 1);

  chartCreatives = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'CPL (€)',
          data: cplValues,
          backgroundColor: bgColor,
          borderColor: borderColors,
          borderWidth: borderWidths,
          borderRadius: 6,
          yAxisID: 'y'
        },
        {
          label: 'Leads',
          data: leadsValues,
          type: 'line',
          borderColor: 'rgba(6, 182, 212, 1)',
          backgroundColor: 'transparent',
          borderWidth: 2,
          pointRadius: 4,
          pointBackgroundColor: 'rgba(6, 182, 212, 1)',
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        tooltip: {
          callbacks: {
            label: (tooltipCtx) => {
              if (tooltipCtx.dataset.label === 'CPL (€)') return `CPL: ${tooltipCtx.raw > 0 ? formatEur(tooltipCtx.raw) : 'Keine Leads'}`;
              return `Leads: ${tooltipCtx.raw}`;
            }
          }
        }
      },
      scales: {
        x: { grid: { display: false } },
        y: {
          position: 'left',
          title: { display: true, text: 'CPL (€)', color: '#e7352e' },
          grid: { color: 'rgba(38, 38, 54, 0.5)' },
          ticks: { callback: v => v + ' €' }
        },
        y1: {
          position: 'right',
          title: { display: true, text: 'Leads', color: '#06b6d4' },
          grid: { display: false },
          beginAtZero: true
        }
      }
    }
  });
}

function renderCreativeCards(creatives, avgCPL) {
  const container = document.getElementById('creative-cards');

  // Calculate scores for all creatives
  const creativeData = creatives.map(c => {
    const metrics = c.creative_daily_metrics || [];
    const totalSpend = metrics.reduce((s, m) => s + (m.spend || 0), 0);
    const totalLeads = metrics.reduce((s, m) => s + (m.leads || 0), 0);
    const totalImpressions = metrics.reduce((s, m) => s + (m.impressions || 0), 0);
    const cpl = totalLeads > 0 ? totalSpend / totalLeads : null;
    const score = calcScore(totalLeads, cpl, avgCPL || 1);
    return { ...c, totalSpend, totalLeads, totalImpressions, cpl, score };
  });

  // Sort by score descending
  creativeData.sort((a, b) => b.score - a.score);

  const medals = ['🥇', '🥈', '🥉'];

  const cards = creativeData.map((c, idx) => {
    const typeLabel = getCreativeTypeLabel(c.creative_type);
    const typeIcon = getCreativeTypeIcon(c.creative_type);
    const medal = idx < 3 && c.score > 0 ? medals[idx] : '';
    const isWinner = idx === 0 && c.score > 0;

    return `
      <div class="creative-card ${isWinner ? 'winner' : ''}">
        <div class="creative-card-header" style="gap:12px;">
          <div class="creative-card-badge" style="font-size:24px;">${typeIcon}</div>
          <div style="flex:1;min-width:0;">
            <div class="creative-card-name">
              ${medal ? `<span class="creative-card-badge">${medal}</span>` : ''}${escHtml(c.creative_name)}
            </div>
            <div class="creative-card-type">${escHtml(typeLabel)}</div>
          </div>
        </div>
        <div class="creative-stats">
          <div>
            <div class="creative-stat-label">Leads</div>
            <div class="creative-stat-value">${c.totalLeads}</div>
          </div>
          <div>
            <div class="creative-stat-label">CPL</div>
            <div class="creative-stat-value ${c.cpl && c.cpl < 10 ? 'value-good' : c.cpl && c.cpl > 15 ? 'value-bad' : ''}">${c.cpl ? formatEur(c.cpl) : '—'}</div>
          </div>
          <div>
            <div class="creative-stat-label">Spend</div>
            <div class="creative-stat-value" style="font-size:14px;">${formatEur(c.totalSpend)}</div>
          </div>
          <div>
            <div class="creative-stat-label">Score</div>
            <div class="creative-stat-value" style="font-size:14px;">
              <span class="score-badge ${isWinner ? 'top' : ''}">${c.score.toFixed(1)}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = cards || '<div class="empty-state"><div class="empty-state-desc">Keine Creatives vorhanden</div></div>';
}

// ============================================
// CREATIVE INTELLIGENCE VIEW
// ============================================
function switchIntelTimeFilter(mode) {
  intelTimeFilter = mode;
  document.getElementById('intel-tab-alltime').classList.toggle('active', mode === 'alltime');
  document.getElementById('intel-tab-30d').classList.toggle('active', mode === '30d');
  loadIntelligence();
}

function switchIntelCategory(cat) {
  intelCategoryFilter = cat;
  document.getElementById('intel-cat-all').classList.toggle('active', cat === 'all');
  document.getElementById('intel-cat-neubau').classList.toggle('active', cat === 'neubauprojekt');
  document.getElementById('intel-cat-einzel').classList.toggle('active', cat === 'einzel');
  loadIntelligence();
}

async function loadIntelligence() {
  if (!dbReady) return;

  const loading = document.getElementById('intel-loading');
  const content = document.getElementById('intel-content');
  loading.style.display = 'flex';
  content.style.display = 'none';

  try {
    // Load all creatives with their metrics AND campaign/property info
    const creatives = await sbGet('creatives', 'select=*,creative_daily_metrics(*),campaigns(id,property_id,properties(property_type))');

    // Time filter: calculate cutoff date for 30-day filter
    let dateCutoff = null;
    if (intelTimeFilter === '30d') {
      const d = new Date();
      d.setDate(d.getDate() - 30);
      dateCutoff = d.toISOString().slice(0, 10); // YYYY-MM-DD
    }

    // ALWAYS calculate globalAvgCPL from ALL creatives (not filtered)
    // This ensures scores are comparable across category tabs
    let globalTotalLeads = 0, globalTotalSpend = 0;
    (creatives || []).forEach(c => {
      let metrics = c.creative_daily_metrics || [];
      if (dateCutoff) metrics = metrics.filter(m => m.date >= dateCutoff);
      globalTotalLeads += metrics.reduce((s, m) => s + (m.leads || 0), 0);
      globalTotalSpend += metrics.reduce((s, m) => s + (m.spend || 0), 0);
    });
    const globalAvgCPL = globalTotalLeads > 0 ? globalTotalSpend / globalTotalLeads : 0;

    // Filter by property category (AFTER computing global benchmark)
    let filteredCreatives = creatives || [];
    if (intelCategoryFilter === 'neubauprojekt') {
      filteredCreatives = filteredCreatives.filter(c => {
        const propType = c.campaigns?.properties?.property_type;
        return propType === 'neubauprojekt';
      });
    } else if (intelCategoryFilter === 'einzel') {
      filteredCreatives = filteredCreatives.filter(c => {
        const propType = c.campaigns?.properties?.property_type;
        return propType !== 'neubauprojekt';
      });
    }

    // Handle empty state after category filter
    if (filteredCreatives.length === 0) {
      loading.style.display = 'none';
      content.style.display = 'block';
      document.getElementById('intel-current-chart').innerHTML = '';
      document.getElementById('intel-current-cards').innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">📭</div><div class="empty-state-title">Keine Daten</div><div class="empty-state-desc">Keine Kampagnen in dieser Kategorie' + (intelTimeFilter === '30d' ? ' (letzte 30 Tage)' : '') + '.</div></div>';
      document.getElementById('intel-alltime-cards').innerHTML = '';
      return;
    }

    // Group by creative_type
    const typeMap = {};
    filteredCreatives.forEach(c => {
      const type = c.creative_type || 'unknown';
      if (!typeMap[type]) typeMap[type] = { type, totalLeads: 0, totalSpend: 0, creativeCount: 0 };
      let metrics = c.creative_daily_metrics || [];
      // Apply time filter
      if (dateCutoff) {
        metrics = metrics.filter(m => m.date >= dateCutoff);
      }
      const leads = metrics.reduce((s, m) => s + (m.leads || 0), 0);
      const spend = metrics.reduce((s, m) => s + (m.spend || 0), 0);
      typeMap[type].totalLeads += leads;
      typeMap[type].totalSpend += spend;
      typeMap[type].creativeCount += 1;
    });

    // Calc per-type metrics (average score per creative, not sum)
    const typeData = Object.values(typeMap).map(t => {
      const avgCPL = t.totalLeads > 0 ? t.totalSpend / t.totalLeads : 0;
      const totalScore = calcScore(t.totalLeads, avgCPL, globalAvgCPL || 1);
      const score = t.creativeCount > 0 ? Math.round((totalScore / t.creativeCount) * 10) / 10 : 0;
      return { ...t, avgCPL, score };
    });

    intelData = { typeData, globalAvgCPL };

    // Sort by score for default view
    typeData.sort((a, b) => b.score - a.score);

    const filterLabel = intelTimeFilter === '30d' ? ' (letzte 30 Tage)' : '';
    renderIntelCurrentBest(typeData, filterLabel);
    renderIntelAllTime(typeData, currentRanking);

    // Update subtitle with active filters
    const catLabels = { all: 'alle Kampagnen', neubauprojekt: 'Neubauprojekte', einzel: 'Einzelobjekte' };
    const subtitle = document.querySelector('#view-intelligence .page-subtitle');
    if (subtitle) {
      subtitle.textContent = 'Welche Creative-Art performt am besten — ' + catLabels[intelCategoryFilter];
    }

    loading.style.display = 'none';
    content.style.display = 'block';

  } catch (e) {
    console.error('Intelligence-Ladefehler:', e);
    loading.style.display = 'none';
    content.style.display = 'block';
    document.getElementById('intel-current-cards').innerHTML = `
      <div class="empty-state" style="grid-column:1/-1;">
        <div class="empty-state-icon">⚠️</div>
        <div class="empty-state-title">Fehler beim Laden</div>
        <div class="empty-state-desc" style="color:var(--red);font-family:monospace;font-size:12px;">${escHtml(e?.message || String(e))}</div>
      </div>
    `;
  }
}

function renderIntelCurrentBest(typeData, filterLabel) {
  filterLabel = filterLabel || '';
  const chartContainer = document.getElementById('intel-current-chart');
  const cardsContainer = document.getElementById('intel-current-cards');

  if (!typeData.length) {
    chartContainer.innerHTML = '';
    cardsContainer.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-desc">Noch keine Creative-Daten vorhanden</div></div>';
    return;
  }

  const maxScore = Math.max(...typeData.map(t => t.score), 1);

  // Horizontal bar chart
  chartContainer.innerHTML = typeData.map((t, i) => {
    const pct = maxScore > 0 ? (t.score / maxScore) * 100 : 0;
    const isWinner = i === 0 && t.score > 0;
    return `
      <div class="hbar-row">
        <div class="hbar-label">${isWinner ? '👑 ' : ''}${getCreativeTypeLabel(t.type)}</div>
        <div class="hbar-track">
          <div class="hbar-fill ${isWinner ? 'winner-bar' : ''}" style="width:${Math.max(pct, 8)}%">
            ${t.score.toFixed(1)}
          </div>
        </div>
        <div class="hbar-value">${t.totalLeads} Leads</div>
      </div>
    `;
  }).join('');

  // Cards
  cardsContainer.innerHTML = typeData.map((t, i) => {
    const isWinner = i === 0 && t.score > 0;
    return `
      <div class="intel-type-card ${isWinner ? 'winner' : ''}">
        <div class="intel-type-header">
          <div class="intel-type-name">${isWinner ? '👑 ' : ''}${getCreativeTypeLabel(t.type)}</div>
          <span class="score-badge ${isWinner ? 'top' : ''}">Score: ${t.score.toFixed(1)}</span>
        </div>
        <div class="intel-type-stats">
          <div>
            <div class="intel-stat-label">Leads gesamt</div>
            <div class="intel-stat-value">${t.totalLeads}</div>
          </div>
          <div>
            <div class="intel-stat-label">Ø CPL</div>
            <div class="intel-stat-value ${t.avgCPL && t.avgCPL < 10 ? 'value-good' : t.avgCPL && t.avgCPL > 15 ? 'value-bad' : ''}">${t.avgCPL ? formatEur(t.avgCPL) : '—'}</div>
          </div>
          <div>
            <div class="intel-stat-label">Creatives</div>
            <div class="intel-stat-value">${t.creativeCount}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function switchRanking(mode) {
  currentRanking = mode;
  // Update tabs
  document.querySelectorAll('.ranking-tab').forEach(tab => tab.classList.remove('active'));
  event.target.classList.add('active');

  if (!intelData) return;

  const sorted = [...intelData.typeData];
  if (mode === 'score') sorted.sort((a, b) => b.score - a.score);
  else if (mode === 'cpl') sorted.sort((a, b) => {
    // Lower CPL is better, 0 means no data (goes last)
    const aCpl = a.avgCPL || Infinity;
    const bCpl = b.avgCPL || Infinity;
    return aCpl - bCpl;
  });
  else if (mode === 'leads') sorted.sort((a, b) => b.totalLeads - a.totalLeads);

  renderIntelAllTime(sorted, mode);
}

function renderIntelAllTime(typeData, mode) {
  const container = document.getElementById('intel-alltime-cards');

  const modeLabel = mode === 'score' ? 'Score' : mode === 'cpl' ? 'CPL' : 'Leads';
  const medals = ['🥇', '🥈', '🥉'];

  container.innerHTML = typeData.map((t, i) => {
    const medal = i < 3 ? medals[i] : '';
    let primaryValue = '';
    if (mode === 'score') primaryValue = t.score.toFixed(1);
    else if (mode === 'cpl') primaryValue = t.avgCPL ? formatEur(t.avgCPL) : '—';
    else if (mode === 'leads') primaryValue = String(t.totalLeads);

    return `
      <div class="intel-type-card ${i === 0 ? 'winner' : ''}">
        <div class="intel-type-header">
          <div class="intel-type-name">${medal} ${getCreativeTypeLabel(t.type)}</div>
          <span class="score-badge ${i === 0 ? 'top' : ''}">${modeLabel}: ${primaryValue}</span>
        </div>
        <div class="intel-type-stats">
          <div>
            <div class="intel-stat-label">Leads</div>
            <div class="intel-stat-value">${t.totalLeads}</div>
          </div>
          <div>
            <div class="intel-stat-label">Ø CPL</div>
            <div class="intel-stat-value">${t.avgCPL ? formatEur(t.avgCPL) : '—'}</div>
          </div>
          <div>
            <div class="intel-stat-label">Score</div>
            <div class="intel-stat-value">${t.score.toFixed(1)}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// ============================================
// EDIT CAMPAIGN
// ============================================
async function openEditCampaign() {
  const campaign = window._editCampaignData;
  const property = window._editPropertyData;
  if (!campaign || !property) { showToast('Keine Daten zum Bearbeiten', 'error'); return; }

  document.getElementById('edit-subtitle').textContent = campaign.campaign_name;

  // Load clients and pre-fill
  await loadClientsForForm();
  const editClientSelect = document.getElementById('edit-client');
  if (editClientSelect && property.client_id) {
    editClientSelect.value = property.client_id;
  }

  // Fill property fields
  document.getElementById('edit-prop-name').value = property.name || '';
  document.getElementById('edit-prop-address').value = property.address || '';
  document.getElementById('edit-prop-plz').value = property.plz || '';
  document.getElementById('edit-prop-stadtteil').value = property.stadtteil || '';
  document.getElementById('edit-prop-city').value = property.city || '';
  document.getElementById('edit-prop-location-rating').value = property.location_rating || '';
  document.getElementById('edit-prop-micro-location').value = property.micro_location || '';
  document.getElementById('edit-prop-type').value = property.property_type || 'wohnung';
  document.getElementById('edit-prop-size').value = property.size_sqm || '';
  document.getElementById('edit-prop-plot-size').value = property.plot_size || '';
  document.getElementById('edit-prop-rooms').value = property.rooms || '';
  document.getElementById('edit-prop-price').value = property.price || '';
  document.getElementById('edit-prop-price-from').value = property.price_from || '';
  document.getElementById('edit-prop-price-to').value = property.price_to || '';
  document.getElementById('edit-prop-size-from').value = property.size_from || '';
  document.getElementById('edit-prop-size-to').value = property.size_to || '';
  document.getElementById('edit-prop-num-units').value = property.num_units || '';
  toggleNeubauFields('edit');

  // Fill campaign fields
  document.getElementById('edit-camp-name').value = campaign.campaign_name || '';
  document.getElementById('edit-camp-start').value = campaign.start_date || '';
  document.getElementById('edit-camp-end').value = campaign.end_date || '';
  document.getElementById('edit-camp-budget').value = campaign.total_budget || '';
  document.getElementById('edit-camp-status').value = campaign.status || 'active';

  // Auto-fill rating if not set
  if (!property.location_rating && property.city) {
    autoFillCityRating('edit-prop-city', 'edit-prop-location-rating');
  }

  showView('edit-campaign');
}

async function handleEditCampaign(event) {
  event.preventDefault();
  if (!editCampaignId || !editPropertyId) { showToast('Keine Kampagne ausgewählt', 'error'); return; }

  try {
    // Update property (including client)
    const selectedClientId = document.getElementById('edit-client').value;
    const locationRating = document.getElementById('edit-prop-location-rating').value || null;
    const propData = {
      client_id: selectedClientId || null,
      name: document.getElementById('edit-prop-name').value,
      address: document.getElementById('edit-prop-address').value || null,
      plz: document.getElementById('edit-prop-plz').value || null,
      stadtteil: document.getElementById('edit-prop-stadtteil').value || null,
      city: document.getElementById('edit-prop-city').value || null,
      location_rating: locationRating,
      micro_location: document.getElementById('edit-prop-micro-location').value || null,
      property_type: document.getElementById('edit-prop-type').value,
      size_sqm: parseFloat(document.getElementById('edit-prop-size').value) || null,
      plot_size: parseFloat(document.getElementById('edit-prop-plot-size').value) || null,
      rooms: parseFloat(document.getElementById('edit-prop-rooms').value) || null,
      price: parseFloat(document.getElementById('edit-prop-price').value) || null,
      price_from: document.getElementById('edit-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('edit-prop-price-from').value) || null) : null,
      price_to: document.getElementById('edit-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('edit-prop-price-to').value) || null) : null,
      size_from: document.getElementById('edit-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('edit-prop-size-from').value) || null) : null,
      size_to: document.getElementById('edit-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('edit-prop-size-to').value) || null) : null,
      num_units: document.getElementById('edit-prop-type').value === 'neubauprojekt' ? (parseInt(document.getElementById('edit-prop-num-units').value) || null) : null
    };

    await sbPatch('properties', editPropertyId, propData);

    // Update campaign
    const campData = {
      campaign_name: document.getElementById('edit-camp-name').value,
      start_date: document.getElementById('edit-camp-start').value || null,
      end_date: document.getElementById('edit-camp-end').value || null,
      total_budget: parseFloat(document.getElementById('edit-camp-budget').value) || null,
      status: document.getElementById('edit-camp-status').value
    };

    await sbPatch('campaigns', editCampaignId, campData);

    showToast('Änderungen gespeichert ✓');
    // Reload the detail view
    openCampaign(editCampaignId);
  } catch (e) {
    console.error('Bearbeitung fehlgeschlagen:', e);
    showToast('Fehler: ' + (e.message || 'Unbekannter Fehler'), 'error');
  }
}

// ============================================
// DELETE CAMPAIGN
// ============================================
async function deleteCampaign() {
  if (!editCampaignId) { showToast('Keine Kampagne ausgewählt', 'error'); return; }
  const campaign = window._editCampaignData;
  const campaignName = campaign?.campaign_name || 'Unbekannt';
  if (!confirm('Kampagne "' + campaignName + '" wirklich löschen? Alle Metriken und Creatives werden ebenfalls gelöscht.')) return;
  try {
    await sbDelete('campaigns', editCampaignId);
    if (editPropertyId) {
      await sbDelete('properties', editPropertyId);
    }
    showToast('Kampagne gelöscht ✓');
    editCampaignId = null;
    editPropertyId = null;
    window._editCampaignData = null;
    window._editPropertyData = null;
    showView('campaigns');
  } catch (e) {
    console.error('Löschen fehlgeschlagen:', e);
    showToast('Fehler beim Löschen: ' + (e.message || 'Unbekannter Fehler'), 'error');
  }
}

// ============================================
// CSV RE-IMPORT FOR EXISTING CAMPAIGNS
// ============================================
function openCSVReimport() {
  document.getElementById('reimport-csv-input').click();
}

async function handleCSVReimport(event) {
  const file = event.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    const rows = parseMetaCSV(text);
    if (!rows || rows.length === 0) {
      showToast('CSV-Datei ist leer oder konnte nicht gelesen werden', 'error');
      return;
    }
    const analysis = analyzeCSV(rows);
    if (!analysis) {
      showToast('CSV konnte nicht analysiert werden', 'error');
      return;
    }
    if (!confirm('CSV importieren? ' + rows.length + ' Zeilen, ' + analysis.totalLeads + ' Leads, ' + analysis.dailyMetrics.length + ' Tage. Bestehende Metriken werden ersetzt.')) {
      event.target.value = '';
      return;
    }
    const campaignId = editCampaignId;

    // 1. Delete existing campaign_daily_metrics
    await fetch(`${SB_URL}/rest/v1/campaign_daily_metrics?campaign_id=eq.${campaignId}`, {
      method: 'DELETE', headers: SB_HEADERS
    });

    // 2. Get existing creative IDs and delete their metrics, then delete creatives
    const existingCreatives = await sbGet('creatives', `campaign_id=eq.${campaignId}&select=id`);
    for (const cr of existingCreatives) {
      await fetch(`${SB_URL}/rest/v1/creative_daily_metrics?creative_id=eq.${cr.id}`, {
        method: 'DELETE', headers: SB_HEADERS
      });
    }
    await fetch(`${SB_URL}/rest/v1/creatives?campaign_id=eq.${campaignId}`, {
      method: 'DELETE', headers: SB_HEADERS
    });

    // 3. Insert new campaign_daily_metrics (NO cpl/cpm/ctr — GENERATED ALWAYS)
    const dailyRows = analysis.dailyMetrics.map(d => ({
      campaign_id: campaignId,
      date: d.date,
      spend: Math.round(d.spend * 100) / 100,
      impressions: Math.round(d.impressions),
      reach: Math.round(d.reach),
      clicks: null,
      leads: Math.round(d.leads)
    }));
    if (dailyRows.length > 0) {
      await sbInsert('campaign_daily_metrics', dailyRows);
    }

    // 4. Insert new creatives
    const creativeIdMap = {};
    for (const cr of analysis.creatives) {
      const [newCreative] = await sbInsert('creatives', {
        campaign_id: campaignId,
        creative_name: cr.name,
        creative_type: ['single_image','carousel','reel','video','story','scn_reel','th_reel'].includes(cr.type) ? cr.type : 'video'
      });
      creativeIdMap[cr.name] = newCreative.id;
    }

    // 5. Insert new creative_daily_metrics (NO cpl/cpm — GENERATED ALWAYS)
    const creativeDailyRows = analysis.creativeDailyMetrics
      .filter(m => creativeIdMap[m.creativeName])
      .map(m => ({
        creative_id: creativeIdMap[m.creativeName],
        date: m.date,
        spend: Math.round(m.spend * 100) / 100,
        impressions: Math.round(m.impressions),
        reach: Math.round(m.reach),
        clicks: null,
        leads: Math.round(m.leads)
      }));
    if (creativeDailyRows.length > 0) {
      await sbInsert('creative_daily_metrics', creativeDailyRows);
    }

    // 6. Update campaign dates and budget
    await sbPatch('campaigns', campaignId, {
      start_date: analysis.startDate || null,
      end_date: analysis.endDate || null,
      total_budget: Math.round(analysis.totalSpend * 100) / 100,
      status: analysis.campaignStatus
    });

    showToast('CSV-Daten aktualisiert ✓ ' + analysis.totalLeads + ' Leads, ' + analysis.creatives.length + ' Creatives, ' + analysis.dailyMetrics.length + ' Tage');
    openCampaign(campaignId);
  } catch (e) {
    console.error('CSV-Reimport fehlgeschlagen:', e);
    showToast('Reimport-Fehler: ' + (e.message || 'Unbekannter Fehler'), 'error');
  } finally {
    event.target.value = '';
  }
}

// ============================================
// CSV IMPORT: PARSING & ANALYSIS
// ============================================
let _csvAnalysis = null; // stores current CSV analysis result

function parseMetaCSV(csvText) {
  // Strip UTF-8 BOM
  if (csvText.charCodeAt(0) === 0xFEFF) csvText = csvText.slice(1);

  const rows = [];
  const lines = csvText.split(/\r?\n/);
  if (lines.length < 2) return rows;

  // Parse a single CSV line handling quoted fields
  function parseLine(line) {
    const fields = [];
    let i = 0;
    while (i <= line.length) {
      if (i === line.length) { fields.push(''); break; }
      if (line[i] === '"') {
        // Quoted field
        let val = '';
        i++; // skip opening quote
        while (i < line.length) {
          if (line[i] === '"') {
            if (i + 1 < line.length && line[i + 1] === '"') {
              val += '"';
              i += 2;
            } else {
              i++; // skip closing quote
              break;
            }
          } else {
            val += line[i];
            i++;
          }
        }
        fields.push(val);
        if (i < line.length && line[i] === ',') i++; // skip delimiter
      } else {
        // Unquoted field
        let j = i;
        while (j < line.length && line[j] !== ',') j++;
        fields.push(line.substring(i, j));
        i = j + 1;
      }
    }
    return fields;
  }

  const headers = parseLine(lines[0]);

  for (let r = 1; r < lines.length; r++) {
    const line = lines[r].trim();
    if (!line) continue;
    const vals = parseLine(line);
    const obj = {};
    for (let c = 0; c < headers.length; c++) {
      obj[headers[c]] = vals[c] !== undefined ? vals[c] : '';
    }
    rows.push(obj);
  }
  return rows;
}

function inferCreativeType(adName) {
  if (!adName) return 'image';
  const lower = adName.toLowerCase();
  if (lower.includes('carousel')) return 'carousel';
  if (lower.includes('scn-reel') || lower.includes('scn reel')) return 'scn_reel';
  if (lower.includes('th-reel') || lower.includes('th reel')) return 'th_reel';
  if (lower.includes('reel') || lower.includes('video')) return 'video';
  if (lower.includes('single image') || lower.includes('bild')) return 'single_image';
  return 'image';
}

function analyzeCSV(rows) {
  if (!rows || rows.length === 0) return null;

  // Extract info from Ad set name
  // Format: "VON POLL Berlin-Pankow // Bennyweg // Voroptimierte Leads // Adv + Anzeigengruppe"
  const firstAdSet = (rows[0]['Ad set name'] || '').trim();
  const adSetParts = firstAdSet.split('//').map(s => s.trim());

  const clientPart = adSetParts[0] || ''; // "VON POLL Berlin-Pankow"
  const propertyName = adSetParts[1] || ''; // "Bennyweg"
  const campaignInfo = adSetParts[2] || ''; // "Voroptimierte Leads"

  // Split client part: first word(s) up to city part
  // Pattern: "VON POLL Berlin-Pankow" → client "VON POLL", location "Berlin-Pankow"
  let clientName = clientPart;
  let clientLocation = '';
  const cityMatch = clientPart.match(/^(.+?)\s+(Berlin|Hamburg|München|Munich|Köln|Cologne|Frankfurt|Düsseldorf|Stuttgart|Hannover|Nürnberg|Bremen|Dresden|Leipzig|Dortmund|Essen|Bonn|Münster|Mannheim|Karlsruhe|Augsburg|Wiesbaden|Freiburg|Mainz|Heidelberg|Darmstadt|Potsdam|Regensburg|Würzburg)[\s-]*(.*)/i);
  if (cityMatch) {
    clientName = cityMatch[1].trim();
    clientLocation = cityMatch[2] + (cityMatch[3] ? '-' + cityMatch[3] : '');
    clientLocation = clientLocation.replace(/-$/, '');
  }

  // Campaign type
  const campaignType = campaignInfo.toLowerCase().includes('lead') ? 'lead_generation' : 'awareness';

  // Campaign name
  const campaignTypeLabel = campaignType === 'lead_generation' ? 'Lead Gen' : 'Awareness';
  const campaignName = propertyName + ' // ' + campaignTypeLabel;

  // Dates
  const dates = rows.map(r => r['Day']).filter(d => d).sort();
  const startDate = dates[0] || '';
  const endDate = dates[dates.length - 1] || '';

  // Numeric parser
  const num = (val) => {
    if (!val || val === '' || val === '-') return 0;
    return parseFloat(String(val).replace(',', '.')) || 0;
  };

  // Totals
  let totalSpend = 0, totalLeads = 0, totalImpressions = 0, totalReach = 0;
  rows.forEach(r => {
    totalSpend += num(r['Amount spent (EUR)']);
    totalLeads += num(r['Results']);
    totalImpressions += num(r['Impressions']);
    totalReach += num(r['Reach']);
  });

  // Unique creatives
  const creativeMap = {};
  rows.forEach(r => {
    const name = (r['Ad name'] || '').trim();
    if (name && !creativeMap[name]) {
      creativeMap[name] = { name, type: inferCreativeType(name) };
    }
  });
  const creatives = Object.values(creativeMap);

  // Daily campaign metrics (aggregated across all ads per day)
  const dailyMap = {};
  rows.forEach(r => {
    const date = r['Day'];
    if (!date) return;
    if (!dailyMap[date]) dailyMap[date] = { date, spend: 0, impressions: 0, reach: 0, leads: 0 };
    dailyMap[date].spend += num(r['Amount spent (EUR)']);
    dailyMap[date].impressions += num(r['Impressions']);
    dailyMap[date].reach += num(r['Reach']);
    dailyMap[date].leads += num(r['Results']);
  });
  const dailyMetrics = Object.values(dailyMap).sort((a, b) => a.date.localeCompare(b.date));

  // Creative daily metrics
  const creativeDailyMap = {};
  rows.forEach(r => {
    const name = (r['Ad name'] || '').trim();
    const date = r['Day'];
    if (!name || !date) return;
    const key = name + '|' + date;
    if (!creativeDailyMap[key]) creativeDailyMap[key] = { creativeName: name, date, spend: 0, impressions: 0, reach: 0, leads: 0 };
    creativeDailyMap[key].spend += num(r['Amount spent (EUR)']);
    creativeDailyMap[key].impressions += num(r['Impressions']);
    creativeDailyMap[key].reach += num(r['Reach']);
    creativeDailyMap[key].leads += num(r['Results']);
  });
  const creativeDailyMetrics = Object.values(creativeDailyMap).map(m => ({
    ...m,
    cpl: m.leads > 0 ? m.spend / m.leads : null,
    cpm: m.impressions > 0 ? (m.spend / m.impressions) * 1000 : null
  }));

  // Detect campaign status from delivery_status
  const statuses = rows.map(r => (r['Delivery status'] || '').toLowerCase());
  const hasActive = statuses.some(s => s === 'active' || s === 'delivering');
  const campaignStatus = hasActive ? 'active' : 'completed';

  return {
    campaignName,
    clientName,
    clientLocation,
    propertyName,
    campaignType,
    campaignStatus,
    startDate,
    endDate,
    totalSpend,
    totalLeads,
    totalImpressions,
    totalReach,
    creatives,
    dailyMetrics,
    creativeDailyMetrics
  };
}

// ============================================
// CSV IMPORT: UI HANDLERS
// ============================================
function initDropZone() {
  const zone = document.getElementById('drop-zone');
  if (!zone) return;

  zone.addEventListener('dragover', (e) => {
    e.preventDefault();
    zone.classList.add('drag-over');
  });
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('drag-over');
  });
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) handleCSVFile(files[0]);
  });
}

function handleCSVFileSelect(event) {
  const files = event.target.files;
  if (files.length > 0) handleCSVFile(files[0]);
}

function handleCSVFile(file) {
  if (!file.name.toLowerCase().endsWith('.csv')) {
    showToast('Bitte eine CSV-Datei auswählen', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const text = e.target.result;
      const rows = parseMetaCSV(text);
      if (!rows || rows.length === 0) {
        showToast('CSV-Datei ist leer oder konnte nicht gelesen werden', 'error');
        return;
      }

      const analysis = analyzeCSV(rows);
      if (!analysis) {
        showToast('CSV konnte nicht analysiert werden', 'error');
        return;
      }

      _csvAnalysis = analysis;
      showCSVPreview(analysis);
    } catch (err) {
      console.error('CSV-Parse-Fehler:', err);
      showToast('Fehler beim Lesen der CSV: ' + (err.message || String(err)), 'error');
    }
  };
  reader.readAsText(file, 'UTF-8');
}

function showCSVPreview(analysis) {
  // Hide upload, show preview
  document.getElementById('csv-step-upload').style.display = 'none';
  document.getElementById('csv-step-preview').style.display = 'block';
  document.getElementById('csv-manual-toggle').style.display = 'none';

  // Render preview card
  const startShort = formatDateShort(analysis.startDate);
  const endShort = formatDateShort(analysis.endDate);
  const spendFormatted = formatEur(analysis.totalSpend);

  document.getElementById('csv-preview').innerHTML = `
    <div class="csv-preview-title">📊 CSV erkannt</div>
    <dl class="csv-preview-grid">
      <dt>Kampagne</dt><dd>${escHtml(analysis.campaignName)}</dd>
      <dt>Kunde</dt><dd>${escHtml(analysis.clientName)}${analysis.clientLocation ? ' · ' + escHtml(analysis.clientLocation) : ''}</dd>
      <dt>Zeitraum</dt><dd>${startShort} – ${endShort}</dd>
      <dt>Ausgaben</dt><dd>${spendFormatted}</dd>
      <dt>Leads</dt><dd>${analysis.totalLeads}</dd>
      <dt>Creatives</dt><dd>${analysis.creatives.length}</dd>
      <dt>Impressions</dt><dd>${formatNum(analysis.totalImpressions)}</dd>
      <dt>Tage</dt><dd>${analysis.dailyMetrics.length}</dd>
    </dl>
  `;

  // Pre-fill property form
  document.getElementById('csv-prop-name').value = analysis.propertyName || '';

  // Try to extract city from clientLocation (e.g. "Berlin-Pankow" → city "Berlin", stadtteil "Pankow")
  if (analysis.clientLocation) {
    const parts = analysis.clientLocation.split('-');
    const city = parts[0] || '';
    const stadtteil = parts.slice(1).join('-') || '';
    document.getElementById('csv-prop-city').value = city;
    if (stadtteil) document.getElementById('csv-prop-stadtteil').value = stadtteil;
    autoFillCityRating('csv-prop-city', 'csv-prop-location-rating');
  }

  // Pre-fill client: try to match existing, otherwise fill name/brand fields
  loadClientsForForm().then(() => {
    const csvClientSelect = document.getElementById('csv-client');
    if (csvClientSelect && analysis.clientName) {
      // Try to find matching client by name
      const match = Array.from(csvClientSelect.options).find(o =>
        o.textContent.toLowerCase().includes(analysis.clientName.toLowerCase())
      );
      if (match) {
        csvClientSelect.value = match.value;
        toggleCSVNewClient(csvClientSelect);
      } else {
        csvClientSelect.value = '';
        document.getElementById('csv-client-name').value = analysis.clientName || '';
        document.getElementById('csv-client-brand').value = analysis.clientName || '';
        toggleCSVNewClient(csvClientSelect);
      }
    }
  });
}

function resetCSVImport() {
  _csvAnalysis = null;
  document.getElementById('csv-step-upload').style.display = 'block';
  document.getElementById('csv-step-preview').style.display = 'none';
  document.getElementById('csv-manual-toggle').style.display = 'block';
  document.getElementById('csv-manual-form').style.display = 'none';
  // Reset file input
  const fi = document.getElementById('csv-file-input');
  if (fi) fi.value = '';
  // Reset form
  const form = document.getElementById('csv-import-form');
  if (form) form.reset();
}

function showManualForm() {
  document.getElementById('csv-manual-form').style.display = 'block';
  document.getElementById('csv-manual-toggle').style.display = 'none';
  loadClientsForForm();
}

function showCSVImportLoading(show) {
  let overlay = document.getElementById('csv-import-overlay');
  if (show) {
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'csv-import-overlay';
      overlay.className = 'csv-import-overlay';
      overlay.innerHTML = `
        <div class="csv-import-overlay-box">
          <div class="spinner"></div>
          <div class="csv-import-overlay-text">Kampagne wird importiert…</div>
        </div>
      `;
      document.body.appendChild(overlay);
    }
    overlay.style.display = 'flex';
  } else {
    if (overlay) overlay.style.display = 'none';
  }
}

// ============================================
// CSV IMPORT: DATABASE LOGIC
// ============================================
async function handleCSVImport(event) {
  event.preventDefault();

  if (!dbReady) {
    showToast('Datenbank nicht bereit. Bitte zuerst migration.sql ausführen.', 'error');
    return;
  }

  if (!_csvAnalysis) {
    showToast('Keine CSV-Daten vorhanden. Bitte zuerst eine CSV hochladen.', 'error');
    return;
  }

  const analysis = _csvAnalysis;
  showCSVImportLoading(true);

  try {
    // 1. Get or create client (from form dropdown)
    let clientId = document.getElementById('csv-client').value || null;
    if (!clientId) {
      // Create new client from form fields or CSV auto-detect
      const clientName = document.getElementById('csv-client-name').value || analysis.clientName;
      const clientBrand = document.getElementById('csv-client-brand').value || clientName;
      if (!clientName) {
        showCSVImportLoading(false);
        showToast('Bitte Kunden auswählen oder Namen eingeben', 'error');
        return;
      }
      const [newClient] = await sbInsert('clients', {
        name: clientName,
        brand: clientBrand
      });
      clientId = newClient.id;
    }

    // 2. Create property
    const locationRating = document.getElementById('csv-prop-location-rating').value ||
      getCityRating(document.getElementById('csv-prop-city').value) || null;
    const propData = {
      client_id: clientId,
      name: document.getElementById('csv-prop-name').value || analysis.propertyName,
      address: document.getElementById('csv-prop-address').value || null,
      plz: document.getElementById('csv-prop-plz').value || null,
      stadtteil: document.getElementById('csv-prop-stadtteil').value || null,
      city: document.getElementById('csv-prop-city').value || null,
      property_type: document.getElementById('csv-prop-type').value,
      size_sqm: parseFloat(document.getElementById('csv-prop-size').value) || null,
      plot_size: parseFloat(document.getElementById('csv-prop-plot-size').value) || null,
      rooms: parseFloat(document.getElementById('csv-prop-rooms').value) || null,
      price: parseFloat(document.getElementById('csv-prop-price').value) || null,
      location_rating: locationRating,
      micro_location: document.getElementById('csv-prop-micro-location').value || null,
      price_from: document.getElementById('csv-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('csv-prop-price-from').value) || null) : null,
      price_to: document.getElementById('csv-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('csv-prop-price-to').value) || null) : null,
      size_from: document.getElementById('csv-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('csv-prop-size-from').value) || null) : null,
      size_to: document.getElementById('csv-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('csv-prop-size-to').value) || null) : null,
      num_units: document.getElementById('csv-prop-type').value === 'neubauprojekt' ? (parseInt(document.getElementById('csv-prop-num-units').value) || null) : null
    };
    const [property] = await sbInsert('properties', propData);

    // 3. Create campaign
    const campData = {
      property_id: property.id,
      platform: 'meta',
      campaign_name: analysis.campaignName,
      campaign_type: analysis.campaignType,
      start_date: analysis.startDate || null,
      end_date: analysis.endDate || null,
      total_budget: Math.round(analysis.totalSpend * 100) / 100,
      status: analysis.campaignStatus
    };
    const [campaign] = await sbInsert('campaigns', campData);

    // 4. Create campaign_daily_metrics
    const dailyRows = analysis.dailyMetrics.map(d => ({
      campaign_id: campaign.id,
      date: d.date,
      spend: Math.round(d.spend * 100) / 100,
      impressions: Math.round(d.impressions),
      reach: Math.round(d.reach),
      clicks: null,
      leads: Math.round(d.leads)
    }));
    if (dailyRows.length > 0) {
      await sbInsert('campaign_daily_metrics', dailyRows);
    }

    // 5. Create creatives
    const creativeIdMap = {};
    for (const cr of analysis.creatives) {
      const [newCreative] = await sbInsert('creatives', {
        campaign_id: campaign.id,
        creative_name: cr.name,
        creative_type: ['single_image','carousel','reel','video','story','scn_reel','th_reel'].includes(cr.type) ? cr.type : 'video'
      });
      creativeIdMap[cr.name] = newCreative.id;
    }

    // 6. Create creative_daily_metrics
    const creativeDailyRows = analysis.creativeDailyMetrics
      .filter(m => creativeIdMap[m.creativeName])
      .map(m => ({
        creative_id: creativeIdMap[m.creativeName],
        date: m.date,
        spend: Math.round(m.spend * 100) / 100,
        impressions: Math.round(m.impressions),
        reach: Math.round(m.reach),
        clicks: null,
        leads: Math.round(m.leads)
      }));
    if (creativeDailyRows.length > 0) {
      await sbInsert('creative_daily_metrics', creativeDailyRows);
    }

    showCSVImportLoading(false);

    // 7. Show success toast
    showToast(
      `✓ Import erfolgreich: ${analysis.totalLeads} Leads, ${analysis.creatives.length} Creatives, ${analysis.dailyMetrics.length} Tage`,
      'success'
    );

    // 8. Reset and navigate to detail
    _csvAnalysis = null;
    resetCSVImport();
    openCampaign(campaign.id);

  } catch (e) {
    showCSVImportLoading(false);
    console.error('CSV-Import fehlgeschlagen:', e);
    showToast('Import-Fehler: ' + (e.message || 'Unbekannter Fehler'), 'error');
  }
}

// ============================================
// CREATE CAMPAIGN
// ============================================
async function handleCreateCampaign(event) {
  event.preventDefault();

  if (!dbReady) {
    showToast('Datenbank nicht bereit. Bitte zuerst migration.sql ausführen.', 'error');
    return;
  }

  try {
    // 1. Get or create client
    let clientId = document.getElementById('form-client').value;

    if (!clientId) {
      const clientName = document.getElementById('form-client-name').value;
      const brand = document.getElementById('form-brand').value;

      if (!clientName) {
        showToast('Bitte Kundennamen eingeben', 'error');
        return;
      }

      const [newClient] = await sbInsert('clients', { name: clientName, brand: brand || null });
      clientId = newClient.id;
    }

    // 2. Create property
    const locationRating = document.getElementById('form-prop-location-rating').value || null;
    const propData = {
      client_id: clientId,
      name: document.getElementById('form-prop-name').value,
      address: document.getElementById('form-prop-address').value || null,
      plz: document.getElementById('form-prop-plz').value || null,
      stadtteil: document.getElementById('form-prop-stadtteil').value || null,
      city: document.getElementById('form-prop-city').value || null,
      property_type: document.getElementById('form-prop-type').value,
      size_sqm: parseFloat(document.getElementById('form-prop-size').value) || null,
      plot_size: parseFloat(document.getElementById('form-prop-plot-size').value) || null,
      rooms: parseFloat(document.getElementById('form-prop-rooms').value) || null,
      price: parseFloat(document.getElementById('form-prop-price').value) || null,
      location_rating: locationRating,
      micro_location: document.getElementById('form-prop-micro-location').value || null,
      price_from: document.getElementById('form-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('form-prop-price-from').value) || null) : null,
      price_to: document.getElementById('form-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('form-prop-price-to').value) || null) : null,
      size_from: document.getElementById('form-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('form-prop-size-from').value) || null) : null,
      size_to: document.getElementById('form-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('form-prop-size-to').value) || null) : null,
      num_units: document.getElementById('form-prop-type').value === 'neubauprojekt' ? (parseInt(document.getElementById('form-prop-num-units').value) || null) : null
    };

    const [property] = await sbInsert('properties', propData);

    // 3. Create campaign (platform always meta)
    const campData = {
      property_id: property.id,
      platform: 'meta',
      campaign_name: document.getElementById('form-camp-name').value,
      campaign_type: document.getElementById('form-camp-type').value,
      start_date: document.getElementById('form-camp-start').value || null,
      end_date: document.getElementById('form-camp-end').value || null,
      total_budget: parseFloat(document.getElementById('form-camp-budget').value) || null,
      status: document.getElementById('form-camp-status').value
    };

    const [campaign] = await sbInsert('campaigns', campData);

    showToast('Kampagne erfolgreich erstellt! ✓');
    document.getElementById('new-campaign-form').reset();
    showView('campaigns');

  } catch (e) {
    console.error('Kampagnenerstellung fehlgeschlagen:', e);
    showToast('Fehler: ' + (e.message || 'Unbekannter Fehler'), 'error');
  }
}

// ============================================
// ESCAPE HTML
// ============================================
function escHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ============================================
// STATISTICAL HELPERS
// ============================================
function pearsonCorrelation(x, y) {
  const n = x.length;
  if (n < 2) return null;
  const avgX = x.reduce((s,v) => s+v, 0) / n;
  const avgY = y.reduce((s,v) => s+v, 0) / n;
  let num = 0, denX = 0, denY = 0;
  for (let i = 0; i < n; i++) {
    const dx = x[i] - avgX, dy = y[i] - avgY;
    num += dx * dy;
    denX += dx * dx;
    denY += dy * dy;
  }
  const den = Math.sqrt(denX * denY);
  return den === 0 ? 0 : num / den;
}

function linearRegression(x, y) {
  const n = x.length;
  if (n < 2) return null;
  const avgX = x.reduce((s,v) => s+v, 0) / n;
  const avgY = y.reduce((s,v) => s+v, 0) / n;
  let num = 0, den = 0;
  for (let i = 0; i < n; i++) {
    num += (x[i] - avgX) * (y[i] - avgY);
    den += (x[i] - avgX) ** 2;
  }
  const slope = den === 0 ? 0 : num / den;
  return { slope, intercept: avgY - slope * avgX };
}

function percentileRank(value, values, lowerIsBetter) {
  if (lowerIsBetter === undefined) lowerIsBetter = true;
  const sorted = [...values].sort((a, b) => lowerIsBetter ? a - b : b - a);
  const rank = sorted.indexOf(value) + 1;
  return Math.round((1 - (rank - 1) / sorted.length) * 100);
}

function groupBy(arr, keyFn) {
  const map = {};
  arr.forEach(function(item) {
    const key = keyFn(item);
    if (!map[key]) map[key] = [];
    map[key].push(item);
  });
  return map;
}

function priceRange(price) {
  if (!price) return 'Unbekannt';
  if (price < 500000) return '< 500k';
  if (price < 1000000) return '500k – 1M';
  if (price < 2000000) return '1M – 2M';
  return '2M+';
}

function correlationLabel(r) {
  var abs = Math.abs(r);
  if (abs < 0.3) return 'schwach';
  if (abs < 0.6) return 'mittel';
  if (abs < 0.8) return 'stark';
  return 'sehr stark';
}

// ============================================
// BENCHMARK RENDERING (Detail View)
// ============================================
let _scatterChart = null;

async function renderBenchmarks(campaign, property, metrics) {
  const container = document.getElementById('detail-benchmarks');
  if (!container) return;
  container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

  try {
    var allCampaignsRaw = await sbGet('campaigns', 'select=*,properties(*),campaign_daily_metrics(spend,leads,impressions,reach)');
    if (!allCampaignsRaw || allCampaignsRaw.length < 2) {
      container.innerHTML = '';
      return;
    }

    // Calc metrics for each campaign
    var allData = allCampaignsRaw.map(function(c) {
      var m = c.campaign_daily_metrics || [];
      var spend = m.reduce(function(s, x) { return s + (x.spend || 0); }, 0);
      var leads = m.reduce(function(s, x) { return s + (x.leads || 0); }, 0);
      var impr = m.reduce(function(s, x) { return s + (x.impressions || 0); }, 0);
      var days = m.length || 1;
      return {
        id: c.id,
        name: c.campaign_name,
        prop: c.properties,
        spend: spend,
        leads: leads,
        impressions: impr,
        days: days,
        cpl: leads > 0 ? spend / leads : null,
        cpm: impr > 0 ? (spend / impr) * 1000 : null,
        leadsPerDay: leads / days
      };
    }).filter(function(d) { return d.leads > 0; });

    var N = allData.length;
    if (N < 2) { container.innerHTML = ''; return; }

    // Global averages
    var totalSpendAll = allData.reduce(function(s,d) { return s + d.spend; }, 0);
    var totalLeadsAll = allData.reduce(function(s,d) { return s + d.leads; }, 0);
    var totalImprAll = allData.reduce(function(s,d) { return s + d.impressions; }, 0);
    var totalDaysAll = allData.reduce(function(s,d) { return s + d.days; }, 0);
    var avgCPL = totalLeadsAll > 0 ? totalSpendAll / totalLeadsAll : 0;
    var avgCPM = totalImprAll > 0 ? (totalSpendAll / totalImprAll) * 1000 : 0;
    var avgLeadsDay = totalDaysAll > 0 ? totalLeadsAll / totalDaysAll : 0;

    // Current campaign
    var thisCPL = metrics.avgCPL;
    var thisCPM = metrics.avgCPM;
    var thisLeadsDay = metrics.avgLeadsDay;

    // Percentile
    var cplValues = allData.map(function(d) { return d.cpl; }).filter(function(v) { return v !== null; });
    var pctRank = thisCPL ? percentileRank(thisCPL, cplValues, true) : null;

    // Comparison helpers
    function compareMetric(val, avg) {
      if (!val || !avg || avg === 0) return { pct: 0, cls: 'neutral', arrow: '' };
      var pct = ((val - avg) / avg) * 100;
      var abs = Math.abs(pct);
      if (abs < 5) return { pct: pct, cls: 'neutral', arrow: '≈' };
      return { pct: pct, cls: pct < 0 ? 'good' : 'bad', arrow: pct < 0 ? '↓' : '↑' };
    }

    function compareMetricInverse(val, avg) {
      if (!val || !avg || avg === 0) return { pct: 0, cls: 'neutral', arrow: '' };
      var pct = ((val - avg) / avg) * 100;
      var abs = Math.abs(pct);
      if (abs < 5) return { pct: pct, cls: 'neutral', arrow: '≈' };
      return { pct: pct, cls: pct > 0 ? 'good' : 'bad', arrow: pct > 0 ? '↑' : '↓' };
    }

    var cplComp = compareMetric(thisCPL, avgCPL);
    var cpmComp = compareMetric(thisCPM, avgCPM);
    var lpdComp = compareMetricInverse(thisLeadsDay, avgLeadsDay);

    function fmtComp(val, avg, comp, unit) {
      if (!val) return '—';
      return formatEur(val) + ' (' + comp.arrow + Math.abs(comp.pct).toFixed(0) + '% vs. Ø ' + formatEur(avg) + ')';
    }

    // ==========================================
    // SMART CAMPAIGN-SPECIFIC INSIGHTS ENGINE
    // ==========================================
    var propTypeLabelsMap = {wohnung:'Wohnung',haus:'Haus',penthouse:'Penthouse',villa:'Villa',reihenhaus:'Reihenhaus',grundstueck:'Grundstück',gewerbe:'Gewerbe',neubauprojekt:'Neubauprojekt',zweifamilienhaus:'Zweifamilienhaus',doppelhaushaelfte:'Doppelhaushälfte',sonstige:'Sonstige'};
    var smartInsights = [];

    // Load additional data for this campaign
    var campaignCreatives = [];
    var campaignDailyMetrics = [];
    try {
      var crRaw = await sbGet('creatives', 'select=*,creative_daily_metrics(*)&campaign_id=eq.' + campaign.id);
      campaignCreatives = crRaw || [];
    } catch(e) { console.warn('Creatives load failed:', e); }
    try {
      var dmRaw = await sbGet('campaign_daily_metrics', 'select=*&campaign_id=eq.' + campaign.id + '&order=date');
      campaignDailyMetrics = dmRaw || [];
    } catch(e) { console.warn('Daily metrics load failed:', e); }

    // --- 1. PERFORMANCE RANKING ---
    if (thisCPL && allData.length >= 2) {
      var ranked = allData.filter(function(d) { return d.cpl !== null; }).slice();
      ranked.sort(function(a,b) { return a.cpl - b.cpl; });
      var myRankIdx = ranked.findIndex(function(d) { return d.id === campaign.id; });
      if (myRankIdx === -1) {
        // Campaign might have 0 leads and not be in allData, try adding it
        ranked.push({ id: campaign.id, cpl: thisCPL, name: campaign.campaign_name });
        ranked.sort(function(a,b) { return a.cpl - b.cpl; });
        myRankIdx = ranked.findIndex(function(d) { return d.id === campaign.id; });
      }
      var myRank = myRankIdx + 1;
      var totalRanked = ranked.length;
      var rankText = '<strong>#' + myRank + ' von ' + totalRanked + '</strong> — ';

      if (myRank === 1) {
        rankText += 'Niedrigster CPL aller Kampagnen.';
      } else if (myRank <= 3) {
        var betterNames = ranked.slice(0, myRankIdx).map(function(d) { return d.name; }).join(', ');
        rankText += 'Unter den Top 3. Nur ' + betterNames + ' günstiger.';
      } else if (myRank > totalRanked - 3) {
        var pctAboveAvg = Math.round(((thisCPL - avgCPL) / avgCPL) * 100);
        rankText += 'Unter den letzten 3. <strong>' + pctAboveAvg + '%</strong> über Durchschnitt.';
      } else {
        var pctVsAvg = Math.round(((thisCPL - avgCPL) / avgCPL) * 100);
        rankText += (pctVsAvg < 0 ? (Math.abs(pctVsAvg) + '% unter') : (pctVsAvg + '% über')) + ' dem Durchschnitt (' + formatEur(avgCPL) + ').';
      }

      // Ranking within same property type
      if (property && property.property_type) {
        var sameTypeData = allData.filter(function(d) { return d.prop && d.prop.property_type === property.property_type && d.cpl !== null; });
        if (sameTypeData.length >= 2) {
          sameTypeData.sort(function(a,b) { return a.cpl - b.cpl; });
          var typeRankIdx = sameTypeData.findIndex(function(d) { return d.id === campaign.id; });
          if (typeRankIdx === -1) {
            sameTypeData.push({ id: campaign.id, cpl: thisCPL });
            sameTypeData.sort(function(a,b) { return a.cpl - b.cpl; });
            typeRankIdx = sameTypeData.findIndex(function(d) { return d.id === campaign.id; });
          }
          var typeLabel = propTypeLabelsMap[property.property_type] || property.property_type;
          rankText += ' Unter allen <strong>' + escHtml(typeLabel) + '</strong>: Platz ' + (typeRankIdx + 1) + ' von ' + sameTypeData.length + '.';
        }
      }

      smartInsights.push({ icon: '🏆', title: 'Performance-Ranking', text: rankText });
    }

    // --- 2. PERFORMANCE DRIVERS (Multi-Factor Attribution) ---
    if (thisCPL && property) {
      var drivers = [];
      var headwinds = [];

      // Property type effect
      if (property.property_type) {
        var byType = groupBy(allData.filter(function(d) { return d.prop && d.prop.property_type; }), function(d) { return d.prop.property_type; });
        var typeGroup = byType[property.property_type];
        if (typeGroup && typeGroup.length >= 2) {
          var typeSpend = typeGroup.reduce(function(s,d) { return s + d.spend; }, 0);
          var typeLeads = typeGroup.reduce(function(s,d) { return s + d.leads; }, 0);
          var typeCPL = typeLeads > 0 ? typeSpend / typeLeads : null;
          if (typeCPL && avgCPL > 0) {
            var typeDiff = Math.round(((typeCPL - avgCPL) / avgCPL) * 100);
            var typeLabel2 = propTypeLabelsMap[property.property_type] || property.property_type;
            if (Math.abs(typeDiff) > 10) {
              if (typeDiff < 0) {
                drivers.push(escHtml(typeLabel2) + ' — <strong>' + Math.abs(typeDiff) + '%</strong> besser als Ø');
              } else {
                headwinds.push(escHtml(typeLabel2) + ' — <strong>' + typeDiff + '%</strong> höherer CPL als Ø');
              }
            }
          }
        }
      }

      // City effect
      if (property.city) {
        var byCityMap = groupBy(allData.filter(function(d) { return d.prop && d.prop.city; }), function(d) { return d.prop.city; });
        var cityGroup = byCityMap[property.city];
        if (cityGroup && cityGroup.length >= 2) {
          var citySpend = cityGroup.reduce(function(s,d) { return s + d.spend; }, 0);
          var cityLeads = cityGroup.reduce(function(s,d) { return s + d.leads; }, 0);
          var cityCPL = cityLeads > 0 ? citySpend / cityLeads : null;
          if (cityCPL && avgCPL > 0) {
            var cityDiff = Math.round(((cityCPL - avgCPL) / avgCPL) * 100);
            if (Math.abs(cityDiff) > 10) {
              if (cityDiff < 0) {
                drivers.push(escHtml(property.city) + ' — <strong>' + Math.abs(cityDiff) + '%</strong> besser als Ø');
              } else {
                headwinds.push(escHtml(property.city) + ' — <strong>' + cityDiff + '%</strong> höherer CPL als Ø');
              }
            }
          }
        }
      }

      // Price bracket effect
      if (property.price) {
        var isExpensive = property.price >= 1000000;
        var bracketItems = allData.filter(function(d) { return d.prop && d.prop.price && (isExpensive ? d.prop.price >= 1000000 : d.prop.price < 1000000); });
        if (bracketItems.length >= 2) {
          var brSpend = bracketItems.reduce(function(s,d) { return s + d.spend; }, 0);
          var brLeads = bracketItems.reduce(function(s,d) { return s + d.leads; }, 0);
          var brCPL = brLeads > 0 ? brSpend / brLeads : null;
          if (brCPL && avgCPL > 0) {
            var brDiff = Math.round(((brCPL - avgCPL) / avgCPL) * 100);
            var brLabel = isExpensive ? 'Preis über 1M€' : 'Preis unter 1M€';
            if (Math.abs(brDiff) > 10) {
              if (brDiff < 0) {
                drivers.push(brLabel + ' — <strong>' + Math.abs(brDiff) + '%</strong> besser als Ø');
              } else {
                headwinds.push(brLabel + ' — <strong>' + brDiff + '%</strong> höherer CPL als Ø');
              }
            }
          }
        }
      }

      var driverText = '';
      if (drivers.length > 0) {
        driverText += 'Performance profitiert von <strong>' + drivers.length + ' Faktor' + (drivers.length > 1 ? 'en' : '') + '</strong>: ' +
          drivers.map(function(d, i) { return '(' + (i + 1) + ') ' + d; }).join(', ') + '.';
      }
      if (headwinds.length > 0) {
        if (driverText) driverText += ' ';
        driverText += 'Gegenwind durch: ' + headwinds.join(', ') + '.';
      }
      if (!driverText && drivers.length === 0 && headwinds.length === 0) {
        driverText = 'Alle Faktoren (Objektart, Stadt, Preis) liegen nah am Durchschnitt — keine starken Treiber identifiziert.';
      }
      if (driverText) {
        smartInsights.push({ icon: '📊', title: 'Performance-Treiber', text: driverText });
      }
    }

    // --- 3. CREATIVE ANALYSIS ---
    if (campaignCreatives.length > 0) {
      var creativeStats = campaignCreatives.map(function(cr) {
        var dm = cr.creative_daily_metrics || [];
        var crSpend = dm.reduce(function(s,x) { return s + (x.spend || 0); }, 0);
        var crLeads = dm.reduce(function(s,x) { return s + (x.leads || 0); }, 0);
        return {
          name: cr.creative_name || 'Unbenannt',
          type: cr.creative_type,
          typeLabel: getCreativeTypeLabel(cr.creative_type),
          spend: crSpend,
          leads: crLeads,
          cpl: crLeads > 0 ? crSpend / crLeads : null
        };
      });

      var totalCreativeLeads = creativeStats.reduce(function(s,c) { return s + c.leads; }, 0);
      var totalCreativeSpend = creativeStats.reduce(function(s,c) { return s + c.spend; }, 0);
      var campaignAvgCPL = totalCreativeLeads > 0 ? totalCreativeSpend / totalCreativeLeads : 0;
      var withLeads = creativeStats.filter(function(c) { return c.leads > 0 && c.cpl !== null; });
      var zeroLeads = creativeStats.filter(function(c) { return c.leads === 0 && c.spend > 0; });

      // Calculate Performance Score for each creative (rewards volume + efficiency)
      withLeads.forEach(function(c) {
        c.score = calcScore(c.leads, c.cpl, campaignAvgCPL > 0 ? campaignAvgCPL : (avgCPL || 1));
      });

      var creativeText = '';

      if (withLeads.length >= 1) {
        withLeads.sort(function(a,b) { return b.score - a.score; });
        var best = withLeads[0];
        var bestPct = totalCreativeLeads > 0 ? Math.round((best.leads / totalCreativeLeads) * 100) : 0;
        creativeText += 'Bestes Creative: <strong>' + escHtml(best.name) + '</strong> (' + escHtml(best.typeLabel) + ') — ' + bestPct + '% der Leads bei <strong>' + formatEur(best.cpl) + ' CPL</strong>.';

        if (withLeads.length >= 2) {
          var worst = withLeads[withLeads.length - 1];
          var worstPct = totalCreativeLeads > 0 ? Math.round((worst.leads / totalCreativeLeads) * 100) : 0;
          var worstPctMore = best.cpl > 0 ? Math.round(((worst.cpl - best.cpl) / best.cpl) * 100) : 0;
          creativeText += ' Schwächstes: <strong>' + escHtml(worst.name) + '</strong> (' + escHtml(worst.typeLabel) + ') — ' + worstPct + '% der Leads bei ' + formatEur(worst.cpl) + ' CPL';
          if (worstPctMore > 0) creativeText += ' (' + worstPctMore + '% teurer)';
          creativeText += '.';
        }
      }

      // Check for zero-lead creatives
      if (zeroLeads.length > 0) {
        zeroLeads.forEach(function(zl) {
          if (creativeText) creativeText += ' ';
          creativeText += '<strong>' + escHtml(zl.name) + '</strong> hat ' + formatEur(zl.spend) + ' verbraucht ohne Leads — pausieren oder ersetzen.';
        });
      }

      // Check for single creative type
      var usedTypes = {};
      creativeStats.forEach(function(c) { if (c.type) usedTypes[c.type] = true; });
      var usedTypeKeys = Object.keys(usedTypes);
      if (usedTypeKeys.length === 1 && creativeStats.length > 0) {
        var onlyType = getCreativeTypeLabel(usedTypeKeys[0]);
        var suggestTypes = { 'single_image': 'Carousel oder Reel', 'carousel': 'Single Image oder Reel', 'video': 'Carousel oder Single Image', 'reel': 'Carousel oder Single Image', 'scn_reel': 'TH-Reel oder Carousel', 'th_reel': 'SCN-Reel oder Carousel', 'story': 'Reel oder Carousel' };
        var suggestion = suggestTypes[usedTypeKeys[0]] || 'andere Formate';
        if (creativeText) creativeText += ' ';
        creativeText += 'Nur <strong>' + escHtml(onlyType) + '</strong> Creatives eingesetzt. Test-Empfehlung: ' + suggestion + '.';
      }

      if (creativeText) {
        smartInsights.push({ icon: '🎨', title: 'Creative-Analyse', text: creativeText });
      }
    }

    // --- 4. TEMPORAL PATTERN ---
    if (campaignDailyMetrics.length >= 4) {
      var sortedDM = campaignDailyMetrics.slice().sort(function(a,b) { return (a.date || '').localeCompare(b.date || ''); });
      var halfIdx = Math.floor(sortedDM.length / 2);
      var firstHalf = sortedDM.slice(0, halfIdx);
      var secondHalf = sortedDM.slice(halfIdx);

      var fhSpend = firstHalf.reduce(function(s,x) { return s + (x.spend || 0); }, 0);
      var fhLeads = firstHalf.reduce(function(s,x) { return s + (x.leads || 0); }, 0);
      var shSpend = secondHalf.reduce(function(s,x) { return s + (x.spend || 0); }, 0);
      var shLeads = secondHalf.reduce(function(s,x) { return s + (x.leads || 0); }, 0);
      var fhCPL = fhLeads > 0 ? fhSpend / fhLeads : null;
      var shCPL = shLeads > 0 ? shSpend / shLeads : null;

      var temporalText = '';
      var totalDays = sortedDM.length;
      var hasFatigue = false;

      if (fhCPL && shCPL && fhCPL > 0) {
        var changePct = Math.round(((shCPL - fhCPL) / fhCPL) * 100);
        if (changePct > 15) {
          temporalText = 'CPL stieg um <strong>' + changePct + '%</strong> in der zweiten Hälfte → mögliche Creative Fatigue. Bei ' + totalDays + '-Tage-Kampagnen: Creative Refresh nach Tag ' + halfIdx + ' einplanen.';
          hasFatigue = true;
        } else if (changePct < -15) {
          temporalText = 'CPL verbesserte sich um <strong>' + Math.abs(changePct) + '%</strong> im Verlauf — Algorithmus-Optimierung funktioniert.';
        } else {
          temporalText = 'Stabiler CPL-Verlauf über <strong>' + totalDays + ' Tage</strong> — gutes Zeichen für die Creative-Qualität.';
        }
      }

      // Best day-of-week analysis
      if (sortedDM.length >= 7) {
        var dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
        var byDow = {};
        sortedDM.forEach(function(dm) {
          if (!dm.date) return;
          var dow = new Date(dm.date).getDay();
          if (!byDow[dow]) byDow[dow] = { spend: 0, leads: 0 };
          byDow[dow].spend += (dm.spend || 0);
          byDow[dow].leads += (dm.leads || 0);
        });
        var dowEntries = Object.keys(byDow).map(function(k) {
          var d = byDow[k];
          return { dow: parseInt(k), name: dayNames[parseInt(k)], cpl: d.leads > 0 ? d.spend / d.leads : null };
        }).filter(function(d) { return d.cpl !== null; });
        if (dowEntries.length >= 3) {
          dowEntries.sort(function(a,b) { return a.cpl - b.cpl; });
          var bestDow = dowEntries[0];
          var worstDow = dowEntries[dowEntries.length - 1];
          if (worstDow.cpl > 0 && bestDow.cpl > 0) {
            var dowDiff = Math.round(((worstDow.cpl - bestDow.cpl) / bestDow.cpl) * 100);
            if (dowDiff > 20) {
              if (temporalText) temporalText += ' ';
              temporalText += 'Beste Tage: <strong>' + bestDow.name + '</strong> (Ø ' + formatEur(bestDow.cpl) + ') vs. ' + worstDow.name + ' (Ø ' + formatEur(worstDow.cpl) + ').';
            }
          }
        }
      }

      if (temporalText) {
        smartInsights.push({ icon: '📈', title: 'Zeitlicher Verlauf', text: temporalText });
      }
    }

    // --- 5. SIMILAR CAMPAIGN COMPARISON ---
    if (thisCPL && property) {
      var similar = null;
      var similarLabel = '';

      // Try same property_type first
      if (property.property_type) {
        var sameType = allData.filter(function(d) { return d.id !== campaign.id && d.prop && d.prop.property_type === property.property_type && d.cpl !== null; });
        if (sameType.length > 0 && property.price) {
          sameType.sort(function(a,b) { return Math.abs((a.prop.price || 0) - property.price) - Math.abs((b.prop.price || 0) - property.price); });
          similar = sameType[0];
          similarLabel = 'gleiche Objektart';
        } else if (sameType.length > 0) {
          sameType.sort(function(a,b) { return Math.abs(a.cpl - thisCPL) - Math.abs(b.cpl - thisCPL); });
          similar = sameType[0];
          similarLabel = 'gleiche Objektart';
        }
      }

      // Fallback: same city
      if (!similar && property.city) {
        var sameCity = allData.filter(function(d) { return d.id !== campaign.id && d.prop && d.prop.city === property.city && d.cpl !== null; });
        if (sameCity.length > 0) {
          if (property.price) {
            sameCity.sort(function(a,b) { return Math.abs((a.prop.price || 0) - property.price) - Math.abs((b.prop.price || 0) - property.price); });
          }
          similar = sameCity[0];
          similarLabel = 'gleiche Stadt';
        }
      }

      // Fallback: closest price
      if (!similar && property.price) {
        var withPrice = allData.filter(function(d) { return d.id !== campaign.id && d.prop && d.prop.price && d.cpl !== null; });
        if (withPrice.length > 0) {
          withPrice.sort(function(a,b) { return Math.abs(a.prop.price - property.price) - Math.abs(b.prop.price - property.price); });
          similar = withPrice[0];
          similarLabel = 'ähnlicher Preis';
        }
      }

      if (similar && similar.cpl) {
        var simCity = (similar.prop && similar.prop.city) ? similar.prop.city : '—';
        var simType = (similar.prop && similar.prop.property_type) ? (propTypeLabelsMap[similar.prop.property_type] || similar.prop.property_type) : '—';
        var simPrice = (similar.prop && similar.prop.price) ? formatEur(similar.prop.price) : '—';
        var simDiffPct = Math.round(((thisCPL - similar.cpl) / similar.cpl) * 100);
        var simText = 'Ähnlichstes Objekt (' + similarLabel + '): <strong>' + escHtml(similar.name) + '</strong> (' + escHtml(simCity) + ', ' + escHtml(simType) + ', ' + simPrice + '). Dein CPL ist <strong>' + Math.abs(simDiffPct) + '%</strong> ' + (simDiffPct < 0 ? 'besser' : 'schlechter') + ' (' + formatEur(thisCPL) + ' vs ' + formatEur(similar.cpl) + ').';
        smartInsights.push({ icon: '🔍', title: 'Ähnlichste Kampagne', text: simText });
      }
    }

    // --- 6. ACTIONABLE RECOMMENDATION ---
    var recommendations = [];
    var hasFatigueFlag = smartInsights.some(function(si) { return si.title === 'Zeitlicher Verlauf' && si.text.indexOf('Creative Fatigue') !== -1; });
    var hasZeroLeadCreative = campaignCreatives.some(function(cr) {
      var dm = cr.creative_daily_metrics || [];
      var sp = dm.reduce(function(s,x) { return s + (x.spend || 0); }, 0);
      var ld = dm.reduce(function(s,x) { return s + (x.leads || 0); }, 0);
      return sp > 0 && ld === 0;
    });

    // Check if one creative dominates
    var creativeWithLeads = campaignCreatives.map(function(cr) {
      var dm = cr.creative_daily_metrics || [];
      return { name: cr.creative_name, type: cr.creative_type, leads: dm.reduce(function(s,x) { return s + (x.leads || 0); }, 0) };
    }).filter(function(c) { return c.leads > 0; });
    var crTotalLeads = creativeWithLeads.reduce(function(s,c) { return s + c.leads; }, 0);
    var dominantCreative = crTotalLeads > 0 ? creativeWithLeads.find(function(c) { return (c.leads / crTotalLeads) > 0.7; }) : null;

    // CPL percentile position
    var isTop30 = pctRank !== null && pctRank >= 70;
    var isBottom30 = pctRank !== null && pctRank <= 30;

    if (hasFatigueFlag) {
      var halfDays = campaignDailyMetrics.length > 0 ? Math.floor(campaignDailyMetrics.length / 2) : 7;
      recommendations.push('Creative Refresh nach Tag ' + halfDays + ' einplanen.');
    }
    if (dominantCreative) {
      recommendations.push('Budget auf <strong>' + escHtml(getCreativeTypeLabel(dominantCreative.type)) + '</strong> konzentrieren — liefert >70% der Leads.');
    }
    if (hasZeroLeadCreative) {
      var zlNames = campaignCreatives.filter(function(cr) {
        var dm = cr.creative_daily_metrics || [];
        var sp = dm.reduce(function(s,x) { return s + (x.spend || 0); }, 0);
        var ld = dm.reduce(function(s,x) { return s + (x.leads || 0); }, 0);
        return sp > 0 && ld === 0;
      }).map(function(cr) { return cr.creative_name || 'Unbenannt'; });
      recommendations.push('<strong>' + escHtml(zlNames.join(', ')) + '</strong> pausieren und Alternative testen.');
    }
    if (isTop30 && recommendations.length === 0) {
      var typeLabel3 = property && property.property_type ? (propTypeLabelsMap[property.property_type] || property.property_type) : '';
      var cityLabel = property && property.city ? property.city : '';
      var contextParts = [typeLabel3, cityLabel].filter(function(p) { return p; });
      recommendations.push('Erfolgreiches Setup — bei ähnlichen Objekten' + (contextParts.length > 0 ? ' (' + contextParts.join(', ') + ')' : '') + ' replizieren.');
    }
    if (isBottom30 && !hasFatigueFlag && !hasZeroLeadCreative) {
      recommendations.push('Optimierungspotential: Creative-Mix diversifizieren und Zielgruppen-Targeting prüfen.');
    }

    // Check for missing high-performing creative types globally
    if (allData.length >= 3 && campaignCreatives.length > 0) {
      // Reload all creatives for global creative type performance
      try {
        var allCreativesRaw = await sbGet('creatives', 'select=creative_type,creative_daily_metrics(spend,leads)');
        if (allCreativesRaw && allCreativesRaw.length > 0) {
          var globalByType = {};
          allCreativesRaw.forEach(function(cr) {
            var t = cr.creative_type || 'unknown';
            if (!globalByType[t]) globalByType[t] = { spend: 0, leads: 0 };
            var dm = cr.creative_daily_metrics || [];
            dm.forEach(function(x) {
              globalByType[t].spend += (x.spend || 0);
              globalByType[t].leads += (x.leads || 0);
            });
          });
          var usedInCampaign = {};
          campaignCreatives.forEach(function(cr) { if (cr.creative_type) usedInCampaign[cr.creative_type] = true; });
          var globalTypePerf = Object.keys(globalByType).map(function(t) {
            var g = globalByType[t];
            return { type: t, cpl: g.leads > 0 ? g.spend / g.leads : null, leads: g.leads };
          }).filter(function(t) { return t.cpl !== null && t.leads >= 3 && !usedInCampaign[t.type] && t.type !== 'unknown'; });
          globalTypePerf.sort(function(a,b) { return a.cpl - b.cpl; });
          if (globalTypePerf.length > 0 && globalTypePerf[0].cpl < (thisCPL || Infinity)) {
            var bestGlobalType = globalTypePerf[0];
            recommendations.push('Test-Empfehlung: <strong>' + escHtml(getCreativeTypeLabel(bestGlobalType.type)) + '</strong> fehlt — performt global mit Ø ' + formatEur(bestGlobalType.cpl) + ' CPL.');
          }
        }
      } catch(e) { /* skip global creative type suggestion */ }
    }

    if (recommendations.length > 0) {
      smartInsights.push({ icon: '🎯', title: 'Empfehlung', text: recommendations.join(' ') });
    }

    // ==========================================
    // RENDER
    // ==========================================
    var pctBadge = '';
    if (pctRank !== null) {
      var pctCls = pctRank >= 66 ? 'good' : pctRank >= 33 ? 'neutral' : 'bad';
      pctBadge = '<span class="benchmark-badge ' + pctCls + '">Top ' + pctRank + '%</span>';
    }

    var sampleNote = 'Basierend auf ' + N + ' Kampagnen';
    if (N < 5) sampleNote += ' (frühe Daten – wird mit mehr Kampagnen genauer)';

    var insightsHtml = '';
    if (smartInsights.length > 0) {
      insightsHtml = '<div class="smart-insights"><div class="smart-insights-title">💡 Kampagnen-Insights</div>' +
        smartInsights.map(function(si) {
          return '<div class="smart-insight-item">' +
            '<div class="smart-insight-icon">' + si.icon + '</div>' +
            '<div class="smart-insight-content">' +
              '<div class="smart-insight-label">' + escHtml(si.title) + '</div>' +
              '<div class="smart-insight-text">' + si.text + '</div>' +
            '</div>' +
          '</div>';
        }).join('') +
        '</div>';
    }

    container.innerHTML =
      '<div class="benchmark-card">' +
        '<div class="card-header"><div class="card-title">📊 Benchmark ' + pctBadge + '</div></div>' +
        '<div class="card-body">' +
          '<div class="benchmark-grid">' +
            '<div class="benchmark-metric">' +
              '<div class="benchmark-metric-label">CPL</div>' +
              '<div class="benchmark-metric-value" style="color:var(--' + (cplComp.cls === 'good' ? 'green' : cplComp.cls === 'bad' ? 'red' : 'text-secondary') + ')">' + (thisCPL ? formatEur(thisCPL) : '—') + '</div>' +
              '<div class="benchmark-metric-compare" style="color:var(--' + (cplComp.cls === 'good' ? 'green' : cplComp.cls === 'bad' ? 'red' : 'text-muted') + ')">' + (thisCPL ? cplComp.arrow + Math.abs(cplComp.pct).toFixed(0) + '% vs. Ø ' + formatEur(avgCPL) : '') + '</div>' +
            '</div>' +
            '<div class="benchmark-metric">' +
              '<div class="benchmark-metric-label">CPM</div>' +
              '<div class="benchmark-metric-value" style="color:var(--' + (cpmComp.cls === 'good' ? 'green' : cpmComp.cls === 'bad' ? 'red' : 'text-secondary') + ')">' + (thisCPM ? formatEur(thisCPM) : '—') + '</div>' +
              '<div class="benchmark-metric-compare" style="color:var(--' + (cpmComp.cls === 'good' ? 'green' : cpmComp.cls === 'bad' ? 'red' : 'text-muted') + ')">' + (thisCPM ? cpmComp.arrow + Math.abs(cpmComp.pct).toFixed(0) + '% vs. Ø ' + formatEur(avgCPM) : '') + '</div>' +
            '</div>' +
            '<div class="benchmark-metric">' +
              '<div class="benchmark-metric-label">Leads/Tag</div>' +
              '<div class="benchmark-metric-value" style="color:var(--' + (lpdComp.cls === 'good' ? 'green' : lpdComp.cls === 'bad' ? 'red' : 'text-secondary') + ')">' + (thisLeadsDay ? thisLeadsDay.toFixed(1) : '—') + '</div>' +
              '<div class="benchmark-metric-compare" style="color:var(--' + (lpdComp.cls === 'good' ? 'green' : lpdComp.cls === 'bad' ? 'red' : 'text-muted') + ')">' + (thisLeadsDay ? lpdComp.arrow + Math.abs(lpdComp.pct).toFixed(0) + '% vs. Ø ' + avgLeadsDay.toFixed(1) : '') + '</div>' +
            '</div>' +
          '</div>' +
          insightsHtml +
          '<div class="benchmark-sample-note">' + escHtml(sampleNote) + '</div>' +
        '</div>' +
      '</div>';

  } catch (e) {
    console.error('Benchmark-Ladefehler:', e);
    container.innerHTML = '';
  }
}

// ============================================
// DATA INTELLIGENCE VIEW
// ============================================
let _diScatterChart = null;
let _scatterMode = 'price';

function switchDataIntelCategory(cat) {
  dataIntelCategoryFilter = cat;
  document.getElementById('di-cat-all').classList.toggle('active', cat === 'all');
  document.getElementById('di-cat-neubau').classList.toggle('active', cat === 'neubauprojekt');
  document.getElementById('di-cat-einzel').classList.toggle('active', cat === 'einzel');
  loadDataIntelligence();
}

function switchScatterMode(mode) {
  _scatterMode = mode;
  document.getElementById('scatter-mode-price').classList.toggle('active', mode === 'price');
  document.getElementById('scatter-mode-pricePerSqm').classList.toggle('active', mode === 'pricePerSqm');
  document.getElementById('scatter-mode-size').classList.toggle('active', mode === 'size');
  document.getElementById('scatter-mode-rooms').classList.toggle('active', mode === 'rooms');
  document.getElementById('scatter-mode-plot').classList.toggle('active', mode === 'plot');

  // Re-render scatter plot with existing data (stored in global after loadDataIntelligence)
  if (window._lastScatterData) {
    renderScatterPlot(window._lastScatterData);
  }
}

// Helpers: effective price/size from property (Neubauprojekte use price_from/size_from)
function getEffectivePrice(prop) {
  if (!prop) return null;
  return prop.price || prop.price_from || null;
}
function getEffectiveSize(prop) {
  if (!prop) return null;
  return prop.size_sqm || prop.size_from || null;
}

async function loadDataIntelligence() {
  if (!dbReady) return;

  var loading = document.getElementById('data-intel-loading');
  var content = document.getElementById('data-intel-content');
  loading.style.display = 'flex';
  content.style.display = 'none';

  try {
    var allCampaignsRaw = await sbGet('campaigns', 'select=*,properties(*),campaign_daily_metrics(spend,leads,impressions,reach),creatives(*,creative_daily_metrics(spend,leads,impressions))');

    // Prepare campaign data with effective price (handles price_from/price_to)
    var allData = (allCampaignsRaw || []).map(function(c) {
      var m = c.campaign_daily_metrics || [];
      var spend = m.reduce(function(s,x) { return s + (x.spend || 0); }, 0);
      var leads = m.reduce(function(s,x) { return s + (x.leads || 0); }, 0);
      var impr = m.reduce(function(s,x) { return s + (x.impressions || 0); }, 0);
      var days = m.length || 1;
      var prop = c.properties;
      // Compute effective price/size (Neubauprojekte use price_from/size_from)
      var effPrice = getEffectivePrice(prop);
      var effSize = getEffectiveSize(prop);
      return {
        id: c.id,
        name: c.campaign_name,
        prop: prop,
        effectivePrice: effPrice,
        effectiveSize: effSize,
        creatives: c.creatives || [],
        spend: spend,
        leads: leads,
        impressions: impr,
        days: days,
        cpl: leads > 0 ? spend / leads : null,
        cpm: impr > 0 ? (spend / impr) * 1000 : null,
        leadsPerDay: leads / days,
        startDate: c.start_date
      };
    }).filter(function(d) { return d.leads > 0; });

    // ALWAYS calculate global averages from ALL campaigns (not filtered by category)
    var totalSpendAll = allData.reduce(function(s,d) { return s + d.spend; }, 0);
    var totalLeadsAll = allData.reduce(function(s,d) { return s + d.leads; }, 0);
    var totalImprAll = allData.reduce(function(s,d) { return s + d.impressions; }, 0);
    var globalAvgCPL = totalLeadsAll > 0 ? totalSpendAll / totalLeadsAll : 0;
    var globalAvgCPM = totalImprAll > 0 ? (totalSpendAll / totalImprAll) * 1000 : 0;

    // Filter by property category (AFTER computing global benchmark)
    var catLabels = { all: 'Gesamt', neubauprojekt: 'Neubauprojekt', einzel: 'Einzelobjekte' };
    var filteredData = allData;
    if (dataIntelCategoryFilter === 'neubauprojekt') {
      filteredData = allData.filter(function(d) {
        return d.prop && d.prop.property_type === 'neubauprojekt';
      });
    } else if (dataIntelCategoryFilter === 'einzel') {
      filteredData = allData.filter(function(d) {
        return !d.prop || d.prop.property_type !== 'neubauprojekt';
      });
    }

    var N = filteredData.length;

    // Warning for small N or empty after filter
    var warningEl = document.getElementById('data-intel-warning');
    if (N === 0) {
      warningEl.innerHTML = '<div class="data-intel-warning">📭 Keine Kampagnen in der Kategorie „' + catLabels[dataIntelCategoryFilter] + '".</div>';
      document.getElementById('data-intel-segments').innerHTML = '';
      document.getElementById('data-intel-correlations').innerHTML = '';
      document.getElementById('data-intel-insights').innerHTML = '';
      if (_diScatterChart) { _diScatterChart.destroy(); _diScatterChart = null; }
      var scatterCont = document.querySelector('.scatter-container');
      if (scatterCont) scatterCont.innerHTML = '<canvas id="chart-scatter-cpl"></canvas>';
      loading.style.display = 'none';
      content.style.display = 'block';
      return;
    } else if (N < 5) {
      warningEl.innerHTML = '<div class="data-intel-warning">⚠️ Noch zu wenig Daten für statistische Signifikanz (' + N + ' Kampagnen in „' + catLabels[dataIntelCategoryFilter] + '"). Die Ergebnisse sind erste Tendenzen.</div>';
    } else {
      warningEl.innerHTML = '';
    }

    // === SECTION A: Segment Performance Matrix ===
    renderSegmentMatrix(filteredData, globalAvgCPL, globalAvgCPM);

    // === SECTION B: Correlation Analysis ===
    renderCorrelationAnalysis(filteredData);

    // === SECTION C: Auto-Insights ===
    renderAutoInsights(filteredData, globalAvgCPL, N);

    // === SECTION D: Scatter Plot ===
    window._lastScatterData = filteredData;
    renderScatterPlot(filteredData);

    loading.style.display = 'none';
    content.style.display = 'block';

  } catch (e) {
    console.error('Data Intelligence Ladefehler:', e);
    loading.style.display = 'none';
    content.style.display = 'block';
    document.getElementById('data-intel-segments').innerHTML = '<div class="empty-state"><div class="empty-state-icon">⚠️</div><div class="empty-state-title">Fehler beim Laden</div><div class="empty-state-desc" style="color:var(--red);font-family:monospace;font-size:12px;">' + escHtml(e.message || String(e)) + '</div></div>';
  }
}

function renderSegmentMatrix(allData, globalAvgCPL, globalAvgCPM) {
  var container = document.getElementById('data-intel-segments');

  function buildTable(title, grouped, labelFn) {
    var keys = Object.keys(grouped).sort();
    if (keys.length === 0) return '';
    var rows = keys.map(function(k) {
      var items = grouped[k];
      var sp = items.reduce(function(s,d) { return s + d.spend; }, 0);
      var ld = items.reduce(function(s,d) { return s + d.leads; }, 0);
      var im = items.reduce(function(s,d) { return s + d.impressions; }, 0);
      var cpl = ld > 0 ? sp / ld : null;
      var cpm = im > 0 ? (sp / im) * 1000 : null;
      var cplCls = cpl !== null ? (cpl < globalAvgCPL * 0.95 ? 'segment-cell-good' : cpl > globalAvgCPL * 1.05 ? 'segment-cell-bad' : '') : '';
      return '<tr>' +
        '<td style="font-weight:600;">' + escHtml(labelFn ? labelFn(k) : k) + '</td>' +
        '<td class="' + cplCls + '">' + (cpl !== null ? formatEur(cpl) : '—') + '</td>' +
        '<td>' + (cpm !== null ? formatEur(cpm) : '—') + '</td>' +
        '<td>' + items.length + '</td>' +
        '</tr>';
    }).join('');

    return '<div class="card">' +
      '<div class="card-header"><div class="card-title">' + escHtml(title) + '</div></div>' +
      '<div class="card-body" style="padding:0;">' +
        '<table class="segment-table"><thead><tr><th>Segment</th><th>Ø CPL</th><th>Ø CPM</th><th>Kampagnen</th></tr></thead>' +
        '<tbody>' + rows + '</tbody></table>' +
      '</div></div>';
  }

  var propTypeLabels = {wohnung:'Wohnung',haus:'Haus',penthouse:'Penthouse',villa:'Villa',reihenhaus:'Reihenhaus',grundstueck:'Grundstück',gewerbe:'Gewerbe',neubauprojekt:'Neubauprojekt',zweifamilienhaus:'Zweifamilienhaus',doppelhaushaelfte:'Doppelhaushälfte',sonstige:'Sonstige'};

  // By City
  var byCity = groupBy(allData.filter(function(d) { return d.prop && d.prop.city; }), function(d) { return d.prop.city; });
  // By Property Type
  var byType = groupBy(allData.filter(function(d) { return d.prop && d.prop.property_type; }), function(d) { return d.prop.property_type; });
  // By Location Rating
  var byRating = groupBy(allData.filter(function(d) { return d.prop && (d.prop.location_rating || d.prop.city); }), function(d) { return d.prop.location_rating || getCityRating(d.prop.city) || '?'; });
  // By Price Range (uses effectivePrice: handles price_from/price_to)
  var byPrice = groupBy(allData.filter(function(d) { return d.effectivePrice; }), function(d) { return priceRange(d.effectivePrice); });

  var html = '';
  html += buildTable('Nach Stadt', byCity);
  html += buildTable('Nach Objektart', byType, function(k) { return propTypeLabels[k] || k; });
  html += buildTable('Nach Standort-Rating', byRating);
  html += buildTable('Nach Preisklasse', byPrice);

  container.innerHTML = html || '<div class="empty-state"><div class="empty-state-desc">Nicht genügend Daten für Segmentierung</div></div>';
}

function renderCorrelationAnalysis(allData) {
  var container = document.getElementById('data-intel-correlations');

  var correlations = [];
  // Use effectivePrice/effectiveSize for correlations (handles Neubauprojekte)
  var withPrice = allData.filter(function(d) { return d.effectivePrice && d.cpl; });
  var withSize = allData.filter(function(d) { return d.effectiveSize && d.cpl; });
  var withPPSQM = allData.filter(function(d) { return d.effectivePrice && d.effectiveSize && d.cpl; });

  if (withPrice.length >= 2) {
    var r = pearsonCorrelation(withPrice.map(function(d) { return d.effectivePrice; }), withPrice.map(function(d) { return d.cpl; }));
    if (r !== null) correlations.push({ label: 'Preis ↔ CPL', r: r, n: withPrice.length });
  }
  if (withSize.length >= 2) {
    var r2 = pearsonCorrelation(withSize.map(function(d) { return d.effectiveSize; }), withSize.map(function(d) { return d.cpl; }));
    if (r2 !== null) correlations.push({ label: 'Wohnfläche ↔ CPL', r: r2, n: withSize.length });
  }
  if (withPPSQM.length >= 2) {
    var ppsqm = withPPSQM.map(function(d) { return d.effectivePrice / d.effectiveSize; });
    var r3 = pearsonCorrelation(ppsqm, withPPSQM.map(function(d) { return d.cpl; }));
    if (r3 !== null) correlations.push({ label: 'qm-Preis ↔ CPL', r: r3, n: withPPSQM.length });
  }

  if (correlations.length === 0) {
    container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;">Nicht genügend numerische Daten für Korrelationsanalyse.</div>';
    return;
  }

  // Sort by absolute r descending
  correlations.sort(function(a,b) { return Math.abs(b.r) - Math.abs(a.r); });

  var html = correlations.map(function(c) {
    var absR = Math.abs(c.r);
    var isPos = c.r >= 0;
    var barWidth = absR * 50; // max 50% of track
    var barLeft = isPos ? 50 : (50 - barWidth);
    var cls = isPos ? 'positive' : 'negative';
    var label = correlationLabel(c.r);
    var dirLabel = isPos ? 'positive' : 'negative';

    return '<div class="correlation-bar-container">' +
      '<div class="correlation-bar-label">' +
        '<span>' + escHtml(c.label) + '</span>' +
        '<span style="color:var(--' + (isPos ? 'red' : 'green') + ');font-weight:700;">r = ' + c.r.toFixed(2) + ' (' + label + ' ' + dirLabel + ')</span>' +
      '</div>' +
      '<div class="correlation-bar-track">' +
        '<div class="correlation-bar-center"></div>' +
        '<div class="correlation-bar-fill ' + cls + '" style="left:' + barLeft + '%;width:' + barWidth + '%;"></div>' +
      '</div>' +
      '<div class="correlation-bar-sublabel">' + (isPos ? 'Höherer Wert → höherer CPL' : 'Höherer Wert → niedrigerer CPL') + ' (n=' + c.n + ')</div>' +
      '</div>';
  }).join('');

  container.innerHTML = html;
}

function renderAutoInsights(allData, globalAvgCPL, N) {
  var container = document.getElementById('data-intel-insights');
  var insights = [];

  // 1. Price segments (uses effectivePrice: handles price_from/price_to)
  var cheap = allData.filter(function(d) { return d.effectivePrice && d.effectivePrice < 1000000; });
  var expensive = allData.filter(function(d) { return d.effectivePrice && d.effectivePrice >= 1000000; });
  if (cheap.length > 0 && expensive.length > 0) {
    var cs = cheap.reduce(function(s,d) { return s + d.spend; }, 0);
    var cl = cheap.reduce(function(s,d) { return s + d.leads; }, 0);
    var es = expensive.reduce(function(s,d) { return s + d.spend; }, 0);
    var el = expensive.reduce(function(s,d) { return s + d.leads; }, 0);
    var cheapCPL = cl > 0 ? cs / cl : null;
    var expCPL = el > 0 ? es / el : null;
    if (cheapCPL && expCPL) {
      var diff = Math.round(Math.abs((expCPL - cheapCPL) / Math.max(expCPL, cheapCPL)) * 100);
      if (diff > 10) {
        var better = cheapCPL < expCPL ? 'unter' : 'über';
        insights.push('Objekte ' + better + ' 1M€ haben Ø ' + diff + '% niedrigeren CPL (' + formatEur(Math.min(cheapCPL, expCPL)) + ' vs ' + formatEur(Math.max(cheapCPL, expCPL)) + ')');
      }
    }
  }

  // 2. Property type comparison
  var byType = groupBy(allData.filter(function(d) { return d.prop && d.prop.property_type; }), function(d) { return d.prop.property_type; });
  var typeKeys = Object.keys(byType);
  if (typeKeys.length > 1) {
    var propTypeLabels = {wohnung:'Wohnungen',haus:'Häuser',penthouse:'Penthouses',villa:'Villen',reihenhaus:'Reihenhäuser',grundstueck:'Grundstücke',gewerbe:'Gewerbe',neubauprojekt:'Neubauprojekte',zweifamilienhaus:'Zweifamilienhäuser',doppelhaushaelfte:'Doppelhaushälften',sonstige:'Sonstige'};
    var typeAvgs = typeKeys.map(function(k) {
      var items = byType[k];
      var ts = items.reduce(function(s,d) { return s + d.spend; }, 0);
      var tl = items.reduce(function(s,d) { return s + d.leads; }, 0);
      return { type: k, label: propTypeLabels[k] || k, cpl: tl > 0 ? ts / tl : null };
    }).filter(function(t) { return t.cpl !== null; }).sort(function(a,b) { return a.cpl - b.cpl; });

    if (typeAvgs.length > 1) {
      var best = typeAvgs[0];
      var worst = typeAvgs[typeAvgs.length - 1];
      if (best.cpl !== worst.cpl) {
        insights.push(best.label + ' performen ' + (best.cpl < worst.cpl * 0.7 ? 'deutlich ' : '') + 'besser als ' + worst.label + ' (CPL ' + formatEur(best.cpl) + ' vs ' + formatEur(worst.cpl) + ')');
      }
    }
  }

  // 3. Strongest correlation (uses effectivePrice/effectiveSize)
  var withPrice2 = allData.filter(function(d) { return d.effectivePrice && d.cpl; });
  var withSize2 = allData.filter(function(d) { return d.effectiveSize && d.cpl; });
  var withPPSQM2 = allData.filter(function(d) { return d.effectivePrice && d.effectiveSize && d.cpl; });
  var corrs = [];
  if (withPrice2.length >= 2) {
    var r1 = pearsonCorrelation(withPrice2.map(function(d) { return d.effectivePrice; }), withPrice2.map(function(d) { return d.cpl; }));
    if (r1 !== null) corrs.push({ label: 'Objektpreis', r: r1 });
  }
  if (withSize2.length >= 2) {
    var r2 = pearsonCorrelation(withSize2.map(function(d) { return d.effectiveSize; }), withSize2.map(function(d) { return d.cpl; }));
    if (r2 !== null) corrs.push({ label: 'Wohnfläche', r: r2 });
  }
  if (withPPSQM2.length >= 2) {
    var ppsqm = withPPSQM2.map(function(d) { return d.effectivePrice / d.effectiveSize; });
    var r3 = pearsonCorrelation(ppsqm, withPPSQM2.map(function(d) { return d.cpl; }));
    if (r3 !== null) corrs.push({ label: 'qm-Preis', r: r3 });
  }
  if (corrs.length > 0) {
    corrs.sort(function(a,b) { return Math.abs(b.r) - Math.abs(a.r); });
    var strongest = corrs[0];
    insights.push('Der ' + strongest.label + ' korreliert am stärksten mit dem CPL (r = ' + strongest.r.toFixed(2) + ', ' + correlationLabel(strongest.r) + ')');
  }

  // 4. City comparison
  var byCity = groupBy(allData.filter(function(d) { return d.prop && d.prop.city; }), function(d) { return d.prop.city; });
  var cityKeys = Object.keys(byCity);
  if (cityKeys.length > 1) {
    var cityData = cityKeys.map(function(k) {
      var items = byCity[k];
      var ts = items.reduce(function(s,d) { return s + d.spend; }, 0);
      var tl = items.reduce(function(s,d) { return s + d.leads; }, 0);
      var td = items.reduce(function(s,d) { return s + d.days; }, 0);
      return { city: k, cpl: tl > 0 ? ts / tl : null, leadsPerDay: td > 0 ? tl / td : 0 };
    }).filter(function(c) { return c.cpl !== null; }).sort(function(a,b) { return a.cpl - b.cpl; });

    if (cityData.length >= 2) {
      var best2 = cityData[0];
      var other = cityData[cityData.length - 1];
      if (best2.city !== other.city) {
        var diffPct = Math.round(Math.abs((other.cpl - best2.cpl) / best2.cpl) * 100);
        var lpdNote = other.leadsPerDay > best2.leadsPerDay ? ', aber höheres Lead-Volumen pro Tag' : '';
        insights.push(other.city + ' hat ' + diffPct + '% höheren CPL als ' + best2.city + lpdNote);
      }
    }
  }

  // 5. Trend detection
  var sorted = allData.filter(function(d) { return d.startDate; }).sort(function(a,b) { return (a.startDate || '').localeCompare(b.startDate || ''); });
  if (sorted.length >= 2) {
    var oldest = sorted[0];
    var newest = sorted[sorted.length - 1];
    if (oldest.cpl && newest.cpl && oldest.id !== newest.id) {
      if (newest.cpl < oldest.cpl * 0.8) {
        insights.push('Trend: Neueste Kampagne (' + escHtml(newest.name) + ') hat deutlich niedrigeren CPL als älteste');
      } else if (newest.cpl > oldest.cpl * 1.2) {
        insights.push('Trend: Neueste Kampagne (' + escHtml(newest.name) + ') hat höheren CPL als älteste – Optimierung prüfen');
      }
    }
  }

  // 6. Creative type insights across campaigns
  var allCreativeTypes = {};
  allData.forEach(function(d) {
    (d.creatives || []).forEach(function(c) {
      var type = c.creative_type || 'unknown';
      var cm = c.creative_daily_metrics || [];
      if (!allCreativeTypes[type]) allCreativeTypes[type] = { leads: 0, spend: 0 };
      allCreativeTypes[type].leads += cm.reduce(function(s,m) { return s + (m.leads || 0); }, 0);
      allCreativeTypes[type].spend += cm.reduce(function(s,m) { return s + (m.spend || 0); }, 0);
    });
  });
  var ctKeys = Object.keys(allCreativeTypes).filter(function(k) { return allCreativeTypes[k].leads > 0; });
  if (ctKeys.length > 1) {
    var ctData = ctKeys.map(function(k) {
      var t = allCreativeTypes[k];
      return { type: k, label: getCreativeTypeLabel(k), cpl: t.leads > 0 ? t.spend / t.leads : null, leads: t.leads };
    }).filter(function(t) { return t.cpl !== null; }).sort(function(a,b) { return a.cpl - b.cpl; });
    if (ctData.length > 1) {
      insights.push(ctData[0].label + ' hat den besten CPL über alle Kampagnen (Ø ' + formatEur(ctData[0].cpl) + ', ' + ctData[0].leads + ' Leads)');
    }
  }

  // Render
  if (insights.length === 0) {
    container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;">Noch nicht genügend Daten für automatische Insights.</div>';
    return;
  }

  container.innerHTML = '<div style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">💡 Insights (basierend auf ' + N + ' Kampagnen)</div>' +
    insights.map(function(i) { return '<div class="insight-item">' + i + '</div>'; }).join('');
}

function renderScatterPlot(allData) {
  // Always reset the scatter container to ensure canvas exists
  var scatterContainer = document.querySelector('.scatter-container');
  if (!scatterContainer) return;
  if (_diScatterChart) { _diScatterChart.destroy(); _diScatterChart = null; }
  scatterContainer.innerHTML = '<canvas id="chart-scatter-cpl"></canvas>';
  var canvas = document.getElementById('chart-scatter-cpl');
  var ctx = canvas.getContext('2d');

  // Define mode configurations
  var modeConfig = {
    price: {
      title: 'Preis vs. CPL',
      xAxisLabel: 'Objektpreis (€)',
      xTickFormat: function(v) { return (v / 1000).toFixed(0) + 'k €'; },
      tooltipXLabel: function(d) {
        var priceLabel = d.prop && d.prop.price ? formatEur(d.effectivePrice) : 'ab ' + formatEur(d.effectivePrice);
        return 'Preis ' + priceLabel;
      },
      filter: function(d) { return d.effectivePrice && d.cpl; },
      getX: function(d) { return d.effectivePrice; }
    },
    pricePerSqm: {
      title: 'qm-Preis vs. CPL',
      xAxisLabel: 'qm-Preis (€/m²)',
      xTickFormat: function(v) { return v.toFixed(0) + ' €/m²'; },
      tooltipXLabel: function(d) {
        var pricePerSqm = d.effectivePrice / d.effectiveSize;
        return 'qm-Preis ' + pricePerSqm.toFixed(0) + ' €/m²';
      },
      filter: function(d) { return d.effectivePrice && d.effectiveSize && d.effectiveSize > 0 && d.cpl; },
      getX: function(d) { return d.effectivePrice / d.effectiveSize; }
    },
    size: {
      title: 'Wohnfläche vs. CPL',
      xAxisLabel: 'Wohnfläche (m²)',
      xTickFormat: function(v) { return v + ' m²'; },
      tooltipXLabel: function(d) { return 'Wohnfläche ' + d.effectiveSize + ' m²'; },
      filter: function(d) { return d.effectiveSize && d.cpl; },
      getX: function(d) { return d.effectiveSize; }
    },
    rooms: {
      title: 'Zimmer vs. CPL',
      xAxisLabel: 'Zimmer',
      xTickFormat: function(v) { return v.toString(); },
      tooltipXLabel: function(d) { return 'Zimmer ' + d.prop.rooms; },
      filter: function(d) { return d.prop && d.prop.rooms && d.cpl; },
      getX: function(d) { return d.prop.rooms; }
    },
    plot: {
      title: 'Grundstück vs. CPL',
      xAxisLabel: 'Grundstück (m²)',
      xTickFormat: function(v) { return v + ' m²'; },
      tooltipXLabel: function(d) { return 'Grundstück ' + d.prop.plot_size + ' m²'; },
      filter: function(d) { return d.prop && d.prop.plot_size && d.cpl; },
      getX: function(d) { return d.prop.plot_size; }
    }
  };

  var mode = modeConfig[_scatterMode] || modeConfig.price;

  // Update card title
  var titleEl = document.getElementById('scatter-chart-title');
  if (titleEl) titleEl.textContent = mode.title;

  // Filter data based on mode
  var filteredData = allData.filter(mode.filter);
  if (filteredData.length < 2) {
    scatterContainer.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:60px;">Mindestens 2 Kampagnen mit passenden Daten nötig.</div>';
    return;
  }

  var xValues = filteredData.map(mode.getX);
  var yValues = filteredData.map(function(d) { return d.cpl; });

  // Trend line (dynamically scaled to actual data)
  var reg = linearRegression(xValues, yValues);
  var minX = Math.min.apply(null, xValues);
  var maxX = Math.max.apply(null, xValues);

  var scatterData = filteredData.map(function(d) {
    return { x: mode.getX(d), y: d.cpl, label: d.name, dataItem: d };
  });

  var trendData = [];
  if (reg) {
    trendData = [
      { x: minX, y: reg.slope * minX + reg.intercept },
      { x: maxX, y: reg.slope * maxX + reg.intercept }
    ];
  }

  _diScatterChart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'Kampagnen',
          data: scatterData,
          backgroundColor: 'rgba(231, 53, 46, 0.8)',
          borderColor: 'rgba(231, 53, 46, 1)',
          borderWidth: 2,
          pointRadius: 8,
          pointHoverRadius: 12
        },
        {
          label: 'Trendlinie',
          data: trendData,
          type: 'line',
          borderColor: 'rgba(245, 158, 11, 0.6)',
          borderWidth: 2,
          borderDash: [6, 4],
          pointRadius: 0,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(tooltipCtx) {
              var item = tooltipCtx.raw;
              if (item.label && item.dataItem) {
                var xLabel = mode.tooltipXLabel(item.dataItem);
                return item.label + ': ' + xLabel + ', CPL ' + formatEur(item.y);
              }
              return 'CPL ' + formatEur(item.y);
            }
          }
        }
      },
      scales: {
        x: {
          title: { display: true, text: mode.xAxisLabel, color: '#8f8f8f' },
          ticks: { callback: mode.xTickFormat },
          grid: { color: 'rgba(38, 38, 54, 0.5)' }
        },
        y: {
          title: { display: true, text: 'CPL (€)', color: '#8f8f8f' },
          ticks: { callback: function(v) { return v.toFixed(0) + ' €'; } },
          grid: { color: 'rgba(38, 38, 54, 0.5)' },
          beginAtZero: true
        }
      }
    }
  });
}

// ============================================
// PROPERTY PREDICTOR
// ============================================
let _compChartInstance = null;

function getPerformanceScore(predictedCPL, avgCPL) {
  if (!predictedCPL || !avgCPL || avgCPL === 0) return { stars: 3, label: 'Durchschnitt', cls: 'pred-score-yellow' };
  const ratio = predictedCPL / avgCPL;
  if (ratio < 0.4) return { stars: 5, label: 'Exzellent', cls: 'pred-score-green' };
  if (ratio < 0.7) return { stars: 4, label: 'Gut', cls: 'pred-score-yellow-green' };
  if (ratio < 1.3) return { stars: 3, label: 'Durchschnitt', cls: 'pred-score-yellow' };
  if (ratio < 1.8) return { stars: 2, label: 'Unterdurchschnittlich', cls: 'pred-score-orange' };
  return { stars: 1, label: 'Schwach', cls: 'pred-score-red' };
}

function renderStars(count) {
  let html = '';
  for (let i = 1; i <= 5; i++) {
    html += '<span class="' + (i <= count ? 'star-active' : 'star-inactive') + '">★</span>';
  }
  return html;
}

// ============================================
// CREATIVE RECOMMENDATIONS
// Weight creative types by similarity to input property
// ============================================
function getCreativeRecommendations(similarCampaigns, allCreatives) {
  const typeScores = {};

  similarCampaigns.forEach(function(camp) {
    const campCreatives = allCreatives.filter(function(c) { return c.campaign_id === camp.campaign_id; });
    if (!campCreatives.length) return;

    // Calculate total campaign spend/leads for avgCPL
    const totalSpend = campCreatives.reduce(function(s, c) {
      return s + (c.creative_daily_metrics || []).reduce(function(ss, m) { return ss + (m.spend || 0); }, 0);
    }, 0);
    const totalLeads = campCreatives.reduce(function(s, c) {
      return s + (c.creative_daily_metrics || []).reduce(function(ss, m) { return ss + (m.leads || 0); }, 0);
    }, 0);
    const avgCPL = totalLeads > 0 ? totalSpend / totalLeads : 0;

    // Score each creative type
    campCreatives.forEach(function(c) {
      const type = c.creative_type || 'unknown';
      const metrics = c.creative_daily_metrics || [];
      const spend = metrics.reduce(function(s, m) { return s + (m.spend || 0); }, 0);
      const leads = metrics.reduce(function(s, m) { return s + (m.leads || 0); }, 0);
      const cpl = leads > 0 ? spend / leads : null;
      const score = calcScore(leads, cpl, avgCPL);

      if (!typeScores[type]) {
        typeScores[type] = { type: type, totalScore: 0, totalWeight: 0, totalLeads: 0, totalSpend: 0, campaigns: 0 };
      }

      const weight = camp.similarity || camp.combinedWeight || 1;
      typeScores[type].totalScore += score * weight;
      typeScores[type].totalWeight += weight;
      typeScores[type].totalLeads += leads;
      typeScores[type].totalSpend += spend;
      typeScores[type].campaigns += 1;
    });
  });

  return Object.values(typeScores)
    .map(function(t) {
      return {
        type: t.type,
        avgScore: t.totalWeight > 0 ? t.totalScore / t.totalWeight : 0,
        avgCPL: t.totalLeads > 0 ? t.totalSpend / t.totalLeads : null,
        totalLeads: t.totalLeads,
        campaigns: t.campaigns
      };
    })
    .filter(function(t) { return t.totalLeads > 0 || t.campaigns > 0; })
    .sort(function(a, b) { return b.avgScore - a.avgScore; });
}

function renderCreativeRecommendations(recommendations) {
  if (!recommendations || recommendations.length === 0) {
    return '<div class="creative-rec-empty">Keine Creative-Daten für ähnliche Kampagnen verfügbar</div>';
  }

  var medals = ['🥇', '🥈', '🥉'];
  var maxScore = recommendations[0].avgScore || 1;
  var totalScore = recommendations.reduce(function(s, r) { return s + r.avgScore; }, 0);

  var html = '';
  recommendations.forEach(function(rec, i) {
    var medal = i < 3 ? medals[i] : (i + 1) + '.';
    var pct = maxScore > 0 ? Math.round((rec.avgScore / maxScore) * 100) : 0;
    var label = getCreativeTypeLabel(rec.type);
    var cplStr = rec.avgCPL !== null ? formatEur(rec.avgCPL) : '—';
    var scoreStr = rec.avgScore.toFixed(1);

    html += '<div class="creative-rec-item">' +
      '<div class="creative-rec-badge">' + medal + '</div>' +
      '<div class="creative-rec-info">' +
        '<div class="creative-rec-name">' + escHtml(label) + '</div>' +
        '<div class="creative-rec-stats">' +
          '<span>Score: <strong>' + scoreStr + '</strong></span>' +
          '<span>Ø CPL: <strong>' + cplStr + '</strong></span>' +
          '<span>' + rec.totalLeads + ' Leads</span>' +
          '<span>' + rec.campaigns + ' Kampagnen</span>' +
        '</div>' +
        '<div class="creative-rec-bar-wrap">' +
          '<div class="creative-rec-bar"><div class="creative-rec-bar-fill" style="width:' + pct + '%;"></div></div>' +
        '</div>' +
      '</div>' +
    '</div>';
  });

  // Auto-generated recommendation text
  var tipText = '';
  if (recommendations.length >= 1) {
    var top = recommendations[0];
    var topLabel = getCreativeTypeLabel(top.type);
    var topScorePct = totalScore > 0 ? (top.avgScore / totalScore) * 100 : 100;

    if (recommendations.length >= 2) {
      var second = recommendations[1];
      var secondLabel = getCreativeTypeLabel(second.type);
      var ratio = second.avgScore > 0 ? top.avgScore / second.avgScore : Infinity;

      if (topScorePct > 70) {
        tipText = 'Setze hauptsächlich auf <strong>' + escHtml(topLabel) + '</strong>.';
      } else if (ratio < 1.3) {
        tipText = 'Kombiniere <strong>' + escHtml(topLabel) + '</strong> und <strong>' + escHtml(secondLabel) + '</strong> für optimale Performance.';
      } else {
        tipText = 'Setze hauptsächlich auf <strong>' + escHtml(topLabel) + '</strong>.';
      }

      // Find low-volume types with good CPL
      var avgCPLAll = recommendations.reduce(function(s, r) { return s + (r.avgCPL || 0); }, 0) / recommendations.length;
      for (var j = 1; j < recommendations.length; j++) {
        var r = recommendations[j];
        if (r.avgCPL !== null && r.avgCPL < avgCPLAll * 0.85 && r.totalLeads < top.totalLeads * 0.3) {
          tipText += ' ' + escHtml(getCreativeTypeLabel(r.type)) + ' hat niedrigen CPL aber wenig Volumen – als Ergänzung testen.';
          break;
        }
      }
    } else {
      tipText = 'Setze auf <strong>' + escHtml(topLabel) + '</strong> — einziger Typ mit Daten.';
    }
  }

  if (tipText) {
    html += '<div class="creative-rec-tip">💡 ' + tipText + '</div>';
  }

  return html;
}

var _predictionCreativesCache = null;

async function loadCampaignDataForPrediction() {
  const allRaw = await sbGet('campaigns', 'select=*,properties(*),campaign_daily_metrics(spend,leads,impressions),creatives(*,creative_daily_metrics(spend,leads,impressions))');
  // Store all creatives for creative recommendation
  _predictionCreativesCache = [];
  (allRaw || []).forEach(function(c) {
    (c.creatives || []).forEach(function(cr) {
      _predictionCreativesCache.push(cr);
    });
  });
  return (allRaw || []).map(function(c) {
    const m = c.campaign_daily_metrics || [];
    const spend = m.reduce(function(s,x) { return s + (x.spend || 0); }, 0);
    const leads = m.reduce(function(s,x) { return s + (x.leads || 0); }, 0);
    const impressions = m.reduce(function(s,x) { return s + (x.impressions || 0); }, 0);
    const days = m.length || 0;
    const prop = c.properties || {};
    return {
      campaign_id: c.id,
      campaign_name: c.campaign_name,
      start_date: c.start_date,
      end_date: c.end_date,
      total_budget: c.total_budget,
      status: c.status,
      id: c.id,
      name: c.campaign_name,
      prop: {
        price: prop.property_type === 'neubauprojekt' && prop.price_from ? prop.price_from : (prop.price || 0),
        size_sqm: prop.size_sqm || 0,
        property_type: prop.property_type || 'unknown',
        city: prop.city || '',
        location_rating: prop.location_rating || (prop.city ? getCityRating(prop.city) : null),
        price_per_sqm: prop.property_type === 'neubauprojekt' && prop.price_from && prop.size_from
          ? prop.price_from / prop.size_from
          : ((prop.price && prop.size_sqm) ? prop.price / prop.size_sqm : null),
        rooms: prop.rooms || null,
        plot_size: prop.plot_size || null,
        price_from: prop.price_from || null,
        price_to: prop.price_to || null,
        size_from: prop.size_from || null,
        size_to: prop.size_to || null,
        num_units: prop.num_units || null
      },
      spend: spend,
      leads: leads,
      impressions: impressions,
      days: days,
      cpl: leads > 0 ? spend / leads : null
    };
  }).filter(function(d) { return d.leads > 0 && d.cpl !== null; });
}

// ============================================
// ADVANCED PREDICTION ENGINE
// k-NN Similarity + Temporal Decay + Bayesian Confidence
// ============================================

// Step 1: Feature Engineering — normalize to 0-1 range
function engineFeatures(prop, allProps) {
  const prices = allProps.map(function(p) { return p.price; }).filter(function(v) { return v > 0; });
  const sizes = allProps.map(function(p) { return p.size_sqm; }).filter(function(v) { return v > 0; });
  const pricePerSqms = allProps.map(function(p) {
    return (p.price && p.size_sqm) ? p.price / p.size_sqm : null;
  }).filter(function(v) { return v !== null; });

  var normalize = function(val, arr) {
    if (val == null || arr.length < 2) return 0.5;
    var min = Math.min.apply(null, arr);
    var max = Math.max.apply(null, arr);
    if (max === min) return 0.5;
    return Math.max(0, Math.min(1, (val - min) / (max - min)));
  };

  return {
    price_norm: normalize(prop.price, prices),
    size_norm: normalize(prop.size_sqm, sizes),
    ppsqm_norm: normalize((prop.price && prop.size_sqm) ? prop.price / prop.size_sqm : null, pricePerSqms),
    type: prop.property_type || 'unknown',
    city: (prop.city || '').toLowerCase().trim(),
    rating: prop.location_rating || 'C'
  };
}

// Step 2: Multi-Dimensional Similarity (k-NN)
function campaignSimilarity(inputFeatures, campaignFeatures) {
  var priceDist = Math.abs(inputFeatures.price_norm - campaignFeatures.price_norm);
  var sizeDist = Math.abs(inputFeatures.size_norm - campaignFeatures.size_norm);
  var ppsqmDist = Math.abs(inputFeatures.ppsqm_norm - campaignFeatures.ppsqm_norm);
  var typeMatch = inputFeatures.type === campaignFeatures.type ? 0 : 1;
  var cityMatch = inputFeatures.city === campaignFeatures.city ? 0 : 1;
  var inputRatingIdx = 'ABCD'.indexOf(inputFeatures.rating);
  var campRatingIdx = 'ABCD'.indexOf(campaignFeatures.rating);
  var ratingDist = (inputRatingIdx >= 0 && campRatingIdx >= 0) ? Math.abs(inputRatingIdx - campRatingIdx) / 3 : 0.5;

  var weights = {
    ppsqm: 0.30,
    price: 0.20,
    type: 0.20,
    size: 0.10,
    city: 0.10,
    rating: 0.10
  };

  var distance = weights.ppsqm * ppsqmDist
               + weights.price * priceDist
               + weights.type * typeMatch
               + weights.size * sizeDist
               + weights.city * cityMatch
               + weights.rating * ratingDist;

  return 1 - distance;
}

// Step 3: Temporal Decay
function temporalWeight(campaignEndDate) {
  var now = new Date();
  var end = new Date(campaignEndDate);
  var daysSince = Math.max(0, (now - end) / (1000 * 60 * 60 * 24));
  var lambda = 0.005; // half-life ~140 days
  return Math.exp(-lambda * daysSince);
}

// Step 4: Bayesian-Style Confidence Band
function bayesianEstimate(predictions, weights) {
  var prior = { mean: 10.0, variance: 25.0 };

  var totalWeight = weights.reduce(function(s, w) { return s + w; }, 0);
  if (totalWeight === 0) {
    return {
      mean: prior.mean,
      low: prior.mean - Math.sqrt(prior.variance) * 1.5,
      high: prior.mean + Math.sqrt(prior.variance) * 1.5,
      confidence: 0,
      priorInfluence: 100,
      dataInfluence: 0
    };
  }

  var dataMean = predictions.reduce(function(s, p, i) { return s + p * weights[i]; }, 0) / totalWeight;
  var dataVariance = predictions.reduce(function(s, p, i) { return s + weights[i] * Math.pow(p - dataMean, 2); }, 0) / totalWeight;

  var n = predictions.length;
  var priorPrecision = 1 / prior.variance;
  var dataPrecision = n / (dataVariance + 0.01);

  var posteriorPrecision = priorPrecision + dataPrecision;
  var posteriorMean = (priorPrecision * prior.mean + dataPrecision * dataMean) / posteriorPrecision;
  var posteriorVariance = 1 / posteriorPrecision;
  var posteriorStd = Math.sqrt(posteriorVariance);

  var confidence = Math.min(100, Math.round((dataPrecision / posteriorPrecision) * 100));

  return {
    mean: posteriorMean,
    low: Math.max(0.5, posteriorMean - 1.5 * posteriorStd),
    high: posteriorMean + 1.5 * posteriorStd,
    confidence: confidence,
    priorInfluence: Math.round((priorPrecision / posteriorPrecision) * 100),
    dataInfluence: Math.round((dataPrecision / posteriorPrecision) * 100)
  };
}

// Step 5: Feature Importance
function calculateFeatureImportance(inputFeatures, scoredCampaigns) {
  var features = ['ppsqm', 'price', 'type', 'size', 'city', 'rating'];
  var labels = {
    ppsqm: '€/qm',
    price: 'Preis',
    type: 'Objektart',
    size: 'Größe',
    city: 'Stadt',
    rating: 'Standort-Rating'
  };

  var allCampProps = scoredCampaigns.map(function(s) { return s.prop; });
  var importance = {};

  features.forEach(function(f) {
    var distances = scoredCampaigns.map(function(c) {
      var cf = engineFeatures(c.prop, allCampProps);
      switch(f) {
        case 'ppsqm': return Math.abs(inputFeatures.ppsqm_norm - cf.ppsqm_norm);
        case 'price': return Math.abs(inputFeatures.price_norm - cf.price_norm);
        case 'type': return inputFeatures.type === cf.type ? 0 : 1;
        case 'size': return Math.abs(inputFeatures.size_norm - cf.size_norm);
        case 'city': return inputFeatures.city === cf.city ? 0 : 1;
        case 'rating':
          var ir = 'ABCD'.indexOf(inputFeatures.rating);
          var cr = 'ABCD'.indexOf(cf.rating);
          return (ir >= 0 && cr >= 0) ? Math.abs(ir - cr) / 3 : 0.5;
        default: return 0;
      }
    });
    var avg = distances.length > 0 ? distances.reduce(function(s,v) { return s + v; }, 0) / distances.length : 0;
    importance[f] = { variance: avg, label: labels[f] };
  });

  var total = Object.keys(importance).reduce(function(s, k) { return s + importance[k].variance; }, 0);
  Object.keys(importance).forEach(function(f) {
    importance[f].pct = total > 0 ? Math.round((importance[f].variance / total) * 100) : 0;
  });

  return importance;
}

// Step 6: Main Prediction Function
function predictCPLAdvanced(inputProp, allData) {
  var N = allData.length;
  if (N === 0) {
    return {
      prediction: { mean: 10, low: 5, high: 15, confidence: 0, priorInfluence: 100, dataInfluence: 0 },
      method: 'prior_only',
      similarities: [],
      featureImportance: {},
      N: 0,
      globalAvgCPL: 10
    };
  }

  var allProps = allData.map(function(d) { return d.prop; }).filter(function(p) { return p; });
  var inputFeatures = engineFeatures(inputProp, allProps);

  var scored = allData.filter(function(d) { return d.cpl > 0; }).map(function(d) {
    var campFeatures = engineFeatures(d.prop, allProps);
    var similarity = campaignSimilarity(inputFeatures, campFeatures);
    var temporal = temporalWeight(d.end_date || new Date().toISOString());
    var combinedWeight = similarity * temporal;
    return {
      campaign_id: d.campaign_id || d.id,
      campaign_name: d.campaign_name || d.name,
      name: d.campaign_name || d.name,
      start_date: d.start_date,
      end_date: d.end_date,
      spend: d.spend,
      leads: d.leads,
      impressions: d.impressions,
      cpl: d.cpl,
      days: d.days,
      prop: d.prop,
      similarity: similarity,
      temporalWeight: temporal,
      combinedWeight: combinedWeight
    };
  });

  scored.sort(function(a, b) { return b.combinedWeight - a.combinedWeight; });

  var cplValues = scored.map(function(s) { return s.cpl; });
  var weights = scored.map(function(s) { return s.combinedWeight; });

  var prediction = bayesianEstimate(cplValues, weights);
  var featureImportance = calculateFeatureImportance(inputFeatures, scored);

  var totalSpendAll = allData.reduce(function(s,d) { return s + d.spend; }, 0);
  var totalLeadsAll = allData.reduce(function(s,d) { return s + d.leads; }, 0);

  return {
    prediction: prediction,
    method: N >= 10 ? 'full_model' : N >= 5 ? 'limited_data' : 'early_stage',
    similarities: scored.slice(0, 5),
    featureImportance: featureImportance,
    N: N,
    globalAvgCPL: totalLeadsAll > 0 ? totalSpendAll / totalLeadsAll : 10
  };
}

// Legacy wrapper for backward compatibility
function predictCPLForProperty(inputPrice, inputType, inputCity, inputRating, allData) {
  var inputProp = {
    price: inputPrice || 0,
    size_sqm: 0,
    property_type: inputType || 'unknown',
    city: inputCity || '',
    location_rating: inputRating || 'C',
    rooms: null,
    plot_size: null
  };
  var result = predictCPLAdvanced(inputProp, allData);
  return {
    minCPL: result.prediction.low,
    maxCPL: result.prediction.high,
    pointEstimate: result.prediction.mean,
    globalAvgCPL: result.globalAvgCPL,
    N: result.N,
    regressionCPL: null,
    segmentAvg: null
  };
}

function findSimilarCampaigns(inputPrice, inputType, inputCity, allData) {
  var inputProp = {
    price: inputPrice || 0,
    size_sqm: 0,
    property_type: inputType || 'unknown',
    city: inputCity || '',
    location_rating: inputCity ? getCityRating(inputCity) : 'C',
    rooms: null,
    plot_size: null
  };
  var result = predictCPLAdvanced(inputProp, allData);
  return result.similarities.slice(0, 3);
}

async function predictPerformance() {
  var resultsEl = document.getElementById('pred-results');
  var inputType = document.getElementById('pred-type').value;
  var inputSize = parseFloat(document.getElementById('pred-size').value) || null;
  var inputPlot = parseFloat(document.getElementById('pred-plot').value) || null;
  var inputRooms = parseFloat(document.getElementById('pred-rooms').value) || null;
  var inputPrice = parseFloat(document.getElementById('pred-price').value) || null;
  var inputCity = document.getElementById('pred-city').value.trim();
  var inputRating = document.getElementById('pred-rating').value || (inputCity ? getCityRating(inputCity) : null);

  if (!inputPrice) {
    showToast('Bitte mindestens den Preis eingeben', 'error');
    return;
  }

  resultsEl.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

  try {
    var allData = await loadCampaignDataForPrediction();
    var N = allData.length;

    if (N === 0) {
      resultsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📭</div><div class="empty-state-title">Keine Daten</div><div class="empty-state-desc">Noch keine Kampagnen mit Leads vorhanden. Bitte zuerst Kampagnen anlegen.</div></div>';
      return;
    }

    var inputProp = {
      price: inputPrice,
      size_sqm: inputSize || 0,
      property_type: inputType,
      city: inputCity,
      location_rating: inputRating || 'C',
      rooms: inputRooms,
      plot_size: inputPlot
    };

    var result = predictCPLAdvanced(inputProp, allData);
    var pred = result.prediction;
    var score = getPerformanceScore(pred.mean, result.globalAvgCPL);

    // Color class for CPL value
    var cplColorCls = pred.mean < 8 ? 'cpl-green' : pred.mean < 12 ? 'cpl-yellow' : 'cpl-red';

    // Method badge
    var methodLabels = {
      'prior_only': { text: 'Nur Prior', cls: 'early' },
      'early_stage': { text: 'Early Stage (' + result.N + ' Kampagnen)', cls: 'early' },
      'limited_data': { text: 'Eingeschränkte Daten (' + result.N + ' Kampagnen)', cls: 'limited' },
      'full_model': { text: 'Vollständiges Modell (' + result.N + ' Kampagnen)', cls: 'full' }
    };
    var methodInfo = methodLabels[result.method] || methodLabels['early_stage'];

    // A) Main Prediction Card
    var mainHtml = '<div class="prediction-section">' +
      '<div class="prediction-section-header">🔮 Erwarteter CPL</div>' +
      '<div class="prediction-main">' +
        '<div class="pred-cpl-big ' + cplColorCls + '">' + formatEur(pred.mean) + '</div>' +
        '<div class="pred-range-text">Spanne: ' + formatEur(pred.low) + ' – ' + formatEur(pred.high) + '</div>' +
        '<div style="margin-top:8px;">' +
          '<span style="font-size:12px;color:var(--text-muted);">Konfidenz: ' + pred.confidence + '%</span>' +
          '<div class="confidence-bar"><div class="confidence-bar-fill" style="width:' + pred.confidence + '%;"></div></div>' +
        '</div>' +
      '</div>' +
    '</div>';

    // B) Confidence Breakdown
    var breakdownHtml = '<div class="prediction-section">' +
      '<div class="prediction-section-header">📊 Datengrundlage</div>' +
      '<div class="prediction-breakdown">' +
        '<div class="pb-item"><div class="pb-label">Eigene Daten</div><div class="pb-value">' + pred.dataInfluence + '%</div></div>' +
        '<div class="pb-item"><div class="pb-label">Industry Prior</div><div class="pb-value">' + pred.priorInfluence + '%</div></div>' +
        '<div class="pb-item"><div class="pb-label">Kampagnen</div><div class="pb-value">' + result.N + '</div></div>' +
        '<div class="pb-item"><div class="pb-label">Modell</div><div class="pb-value"><span class="pred-method-badge ' + methodInfo.cls + '">' + methodInfo.text + '</span></div></div>' +
      '</div>' +
      (result.N < 10 ? '<div style="margin-top:10px;font-size:12px;color:var(--orange);">⚠️ Mehr Kampagnen = genauere Vorhersage</div>' : '') +
    '</div>';

    // C) Performance Score
    var scoreHtml = '<div class="prediction-section">' +
      '<div class="prediction-section-header">⭐ Performance-Score</div>' +
      '<div class="pred-stars" style="font-size:28px;">' + renderStars(score.stars) + '</div>' +
      '<div class="pred-score-label ' + score.cls + '" style="margin-top:6px;">' + score.label + '</div>' +
      '<div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Global Ø CPL: ' + formatEur(result.globalAvgCPL) + '</div>' +
    '</div>';

    // D) Similar Campaigns
    var similarHtml = '<div class="prediction-section">' +
      '<div class="prediction-section-header">🎯 Ähnlichste Kampagnen</div>';
    if (result.similarities.length > 0) {
      similarHtml += result.similarities.map(function(c, i) {
        var simPct = Math.round(c.similarity * 100);
        return '<div class="pred-similar-item">' +
          '<span class="pred-similar-name">' + (i + 1) + '. ' + escHtml(c.name) + '</span>' +
          '<span style="display:flex;align-items:center;gap:8px;">' +
            '<span class="pred-similar-detail">' + simPct + '% ähnlich</span>' +
            '<span class="similarity-inline-bar"><span class="similarity-inline-bar-fill" style="width:' + simPct + '%;"></span></span>' +
            '<span style="font-weight:700;">CPL ' + formatEur(c.cpl) + '</span>' +
          '</span>' +
        '</div>';
      }).join('');
    } else {
      similarHtml += '<div style="font-size:13px;color:var(--text-muted);">Keine ähnlichen Kampagnen gefunden.</div>';
    }
    similarHtml += '</div>';

    // E) Feature Importance
    var featureHtml = '<div class="prediction-section">' +
      '<div class="prediction-section-header">🧠 Was beeinflusst den CPL am meisten?</div>';
    var fi = result.featureImportance;
    var fiKeys = Object.keys(fi);
    // Sort by pct descending
    fiKeys.sort(function(a, b) { return (fi[b].pct || 0) - (fi[a].pct || 0); });
    fiKeys.forEach(function(k) {
      var item = fi[k];
      featureHtml += '<div class="feature-importance-bar">' +
        '<span class="fi-label">' + escHtml(item.label) + '</span>' +
        '<span class="fi-track"><span class="fi-fill" style="width:' + Math.max(2, item.pct) + '%;"></span></span>' +
        '<span class="fi-pct">' + item.pct + '%</span>' +
      '</div>';
    });
    featureHtml += '</div>';

    // F) Creative Recommendations
    var creativeRecHtml = '<div class="prediction-section">' +
      '<div class="prediction-section-header">🎬 Empfohlene Werbemittel</div>';
    var creativeRecs = getCreativeRecommendations(result.similarities, _predictionCreativesCache || []);
    creativeRecHtml += renderCreativeRecommendations(creativeRecs);
    creativeRecHtml += '</div>';

    // Render all
    resultsEl.innerHTML =
      '<div class="pred-result-card">' +
        '<div class="card-body">' +
          mainHtml +
          breakdownHtml +
          scoreHtml +
          similarHtml +
          featureHtml +
          creativeRecHtml +
        '</div>' +
      '</div>';

  } catch (e) {
    console.error('Prediction error:', e);
    resultsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">⚠️</div><div class="empty-state-title">Fehler</div><div class="empty-state-desc" style="color:var(--red);font-family:monospace;font-size:12px;">' + escHtml(e.message || String(e)) + '</div></div>';
  }
}

// ============================================
// PROPERTY COMPARISON
// ============================================
let _compPropertyCount = 2;

function addCompareProperty() {
  if (_compPropertyCount >= 4) {
    showToast('Maximal 4 Objekte möglich', 'error');
    return;
  }
  const n = _compPropertyCount;
  const container = document.getElementById('comp-inputs');
  const card = document.createElement('div');
  card.className = 'compare-input-card';
  card.id = 'comp-card-' + n;
  card.innerHTML =
    '<button class="compare-remove-btn" onclick="removeCompareProperty(' + n + ')" title="Entfernen">✕</button>' +
    '<div class="compare-card-title">Objekt ' + (n + 1) + '</div>' +
    '<div class="form-group"><label class="form-label">Name</label><input class="form-input" id="comp-' + n + '-name" placeholder="Objekt ' + (n + 1) + '"></div>' +
    '<div class="form-group"><label class="form-label">Objektart</label><select class="form-select" id="comp-' + n + '-type"><option value="wohnung">Wohnung</option><option value="haus">Haus</option><option value="penthouse">Penthouse</option><option value="villa">Villa</option><option value="reihenhaus">Reihenhaus</option><option value="grundstueck">Grundstück</option><option value="gewerbe">Gewerbe</option><option value="neubauprojekt">Neubauprojekt</option><option value="zweifamilienhaus">Zweifamilienhaus</option><option value="doppelhaushaelfte">Doppelhaushälfte</option><option value="sonstige">Sonstige</option></select></div>' +
    '<div class="form-group"><label class="form-label">Wohnfläche (qm)</label><input class="form-input" id="comp-' + n + '-size" type="number" step="0.1"></div>' +
    '<div class="form-group"><label class="form-label">Preis (€)</label><input class="form-input" id="comp-' + n + '-price" type="number" step="1"></div>' +
    '<div class="form-group"><label class="form-label">Stadt</label><input class="form-input" id="comp-' + n + '-city" oninput="autoFillCityRating(\'comp-' + n + '-city\',\'comp-' + n + '-rating\')"></div>' +
    '<div class="form-group"><label class="form-label">Standort-Rating</label><select class="form-select" id="comp-' + n + '-rating"><option value="">— Auto —</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div>';
  container.appendChild(card);
  _compPropertyCount++;
  if (_compPropertyCount >= 4) {
    document.getElementById('comp-add-btn').style.display = 'none';
  }
}

function removeCompareProperty(n) {
  const card = document.getElementById('comp-card-' + n);
  if (card) card.remove();
  if (_compPropertyCount > 2) _compPropertyCount--;
  document.getElementById('comp-add-btn').style.display = '';
}

async function compareProperties() {
  var resultsEl = document.getElementById('comp-results');
  resultsEl.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

  try {
    // Collect inputs from all visible cards
    var inputs = [];
    for (var n = 0; n < 4; n++) {
      var card = document.getElementById('comp-card-' + n);
      if (!card) continue;
      var priceEl = document.getElementById('comp-' + n + '-price');
      var price = priceEl ? parseFloat(priceEl.value) || 0 : 0;
      if (price <= 0) continue;

      var nameEl = document.getElementById('comp-' + n + '-name');
      var typeEl = document.getElementById('comp-' + n + '-type');
      var sizeEl = document.getElementById('comp-' + n + '-size');
      var cityEl = document.getElementById('comp-' + n + '-city');
      var ratingEl = document.getElementById('comp-' + n + '-rating');

      var city = cityEl ? cityEl.value.trim() : '';
      var rating = (ratingEl ? ratingEl.value : '') || (city ? getCityRating(city) : null);

      inputs.push({
        index: n,
        name: (nameEl ? nameEl.value.trim() : '') || ('Objekt ' + (n + 1)),
        type: typeEl ? typeEl.value : 'wohnung',
        size: sizeEl ? (parseFloat(sizeEl.value) || null) : null,
        price: price,
        city: city,
        rating: rating
      });
    }

    if (inputs.length < 2) {
      showToast('Bitte mindestens 2 Objekte mit Preis eingeben', 'error');
      resultsEl.innerHTML = '';
      return;
    }

    var allData = await loadCampaignDataForPrediction();
    if (allData.length === 0) {
      resultsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📭</div><div class="empty-state-title">Keine Daten</div><div class="empty-state-desc">Noch keine Kampagnen mit Leads vorhanden.</div></div>';
      return;
    }

    var propTypeLabels = {wohnung:'Wohnung',haus:'Haus',penthouse:'Penthouse',villa:'Villa',reihenhaus:'Reihenhaus',grundstueck:'Grundstück',gewerbe:'Gewerbe',neubauprojekt:'Neubauprojekt',zweifamilienhaus:'Zweifamilienhaus',doppelhaushaelfte:'Doppelhaushälfte',sonstige:'Sonstige'};

    // Predict for each property using advanced engine
    var results = inputs.map(function(inp) {
      var inputProp = {
        price: inp.price,
        size_sqm: inp.size || 0,
        property_type: inp.type,
        city: inp.city,
        location_rating: inp.rating || 'C',
        rooms: null,
        plot_size: null
      };
      var advResult = predictCPLAdvanced(inputProp, allData);
      var pred = advResult.prediction;
      var score = getPerformanceScore(pred.mean, advResult.globalAvgCPL);
      var sqmPrice = (inp.size && inp.size > 0) ? Math.round(inp.price / inp.size) : null;
      return {
        input: inp,
        advResult: advResult,
        prediction: pred,
        score: score,
        sqmPrice: sqmPrice,
        typeLabel: propTypeLabels[inp.type] || inp.type
      };
    });

    // Sort by predicted CPL (best first — Bayesian mean)
    var ranked = results.slice().sort(function(a,b) { return a.prediction.mean - b.prediction.mean; });

    // A) Ranking
    var medals = ['🥇', '🥈', '🥉', '4.'];
    var rankingHtml = '<div class="comp-ranking">';
    ranked.forEach(function(r, i) {
      rankingHtml += '<div class="comp-ranking-item">' +
        '<span class="comp-ranking-medal">' + medals[i] + '</span>' +
        '<span class="comp-ranking-name">' + escHtml(r.input.name) + '</span>' +
        '<span class="comp-ranking-stars pred-stars">' + renderStars(r.score.stars) + '</span>' +
        '<span class="comp-ranking-cpl">~' + formatEur(r.prediction.mean) + '</span>' +
      '</div>';
    });
    rankingHtml += '</div>';

    // Recommendation
    var best = ranked[0];
    var recHtml = '<div class="comp-recommendation">💡 Empfehlung: <strong>' + escHtml(best.input.name) + '</strong> hat das beste Performance-Potenzial (erwarteter CPL ~' + formatEur(best.prediction.mean) + ', Konfidenz: ' + best.prediction.confidence + '%)</div>';

    // B) Comparison table
    var tableHtml = '<div class="card" style="margin-bottom:24px;"><div class="card-header"><div class="card-title">Detail-Vergleich</div></div><div class="card-body" style="padding:0;overflow-x:auto;">';
    tableHtml += '<table class="comp-table"><thead><tr><th>Metrik</th>';
    results.forEach(function(r) { tableHtml += '<th>' + escHtml(r.input.name) + '</th>'; });
    tableHtml += '</tr></thead><tbody>';

    // Rows
    var rowData = [
      { label: 'Objektart', fn: function(r) { return r.typeLabel; } },
      { label: 'Preis', fn: function(r) { return formatEur(r.input.price); } },
      { label: 'qm-Preis', fn: function(r) { return r.sqmPrice ? formatEur(r.sqmPrice) : '—'; } },
      { label: 'Predicted CPL', fn: function(r) { return formatEur(r.prediction.mean); } },
      { label: 'Konfidenz', fn: function(r) { return '<div style="display:flex;align-items:center;gap:6px;"><span>' + r.prediction.confidence + '%</span><span class="similarity-inline-bar" style="width:50px;"><span class="similarity-inline-bar-fill" style="width:' + r.prediction.confidence + '%;"></span></span></div>'; } },
      { label: 'CPL Spanne', fn: function(r) { return formatEur(r.prediction.low) + ' – ' + formatEur(r.prediction.high); } },
      { label: 'Performance-Score', fn: function(r) { return '<span class="pred-stars" style="font-size:14px;">' + renderStars(r.score.stars) + '</span> <span class="' + r.score.cls + '" style="font-size:12px;">' + r.score.label + '</span>'; } },
      { label: 'Ähnlichste Kampagne', fn: function(r) {
        var sims = r.advResult.similarities;
        if (sims.length > 0) {
          var simPct = Math.round(sims[0].similarity * 100);
          return escHtml(sims[0].name) + ' (' + simPct + '%, CPL ' + formatEur(sims[0].cpl) + ')';
        }
        return '—';
      } },
      { label: 'Empfohlenes Creative', fn: function(r) {
        var recs = getCreativeRecommendations(r.advResult.similarities, _predictionCreativesCache || []);
        if (recs.length > 0) {
          var topLabel = getCreativeTypeLabel(recs[0].type);
          var scoreStr = recs[0].avgScore.toFixed(1);
          var cplStr = recs[0].avgCPL !== null ? formatEur(recs[0].avgCPL) : '—';
          return '🎬 <strong>' + escHtml(topLabel) + '</strong><br><span style="font-size:11px;color:var(--text-muted);">Score: ' + scoreStr + ' · CPL: ' + cplStr + '</span>';
        }
        return '—';
      } }
    ];

    rowData.forEach(function(row) {
      tableHtml += '<tr><td style="font-weight:600;color:var(--text-secondary);">' + row.label + '</td>';
      results.forEach(function(r) { tableHtml += '<td>' + row.fn(r) + '</td>'; });
      tableHtml += '</tr>';
    });

    tableHtml += '</tbody></table></div></div>';

    // C) Bar Chart — use Bayesian mean CPL values
    var chartHtml = '<div class="card"><div class="card-header"><div class="card-title">CPL-Vergleich (Bayesian Mean)</div></div><div class="card-body"><div class="comp-chart-container"><canvas id="comp-bar-chart"></canvas></div></div></div>';

    resultsEl.innerHTML = recHtml + rankingHtml + tableHtml + chartHtml;

    // Render Chart.js bar chart
    var chartCanvas = document.getElementById('comp-bar-chart');
    if (chartCanvas) {
      if (_compChartInstance) _compChartInstance.destroy();
      var ctx = chartCanvas.getContext('2d');
      var sortedForChart = results.slice().sort(function(a,b) { return a.prediction.mean - b.prediction.mean; });

      var maxCPL = Math.max.apply(null, sortedForChart.map(function(r) { return r.prediction.mean; }));
      var minCPL = Math.min.apply(null, sortedForChart.map(function(r) { return r.prediction.mean; }));
      var colors = sortedForChart.map(function(r) {
        if (maxCPL === minCPL) return 'rgba(231, 53, 46, 0.8)';
        var ratio = (r.prediction.mean - minCPL) / (maxCPL - minCPL);
        var red = Math.round(50 + ratio * 189);
        var green = Math.round(197 - ratio * 153);
        return 'rgba(' + red + ',' + green + ',50,0.8)';
      });

      _compChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedForChart.map(function(r) { return r.input.name; }),
          datasets: [{
            label: 'Erwarteter CPL (€)',
            data: sortedForChart.map(function(r) { return Math.round(r.prediction.mean * 100) / 100; }),
            backgroundColor: colors,
            borderColor: colors.map(function(c) { return c.replace('0.8', '1'); }),
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(tooltipCtx) { return 'CPL: ' + formatEur(tooltipCtx.raw); }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Erwarteter CPL (€)', color: '#8f8f8f' },
              ticks: { callback: function(v) { return v.toFixed(0) + ' €'; } },
              grid: { color: 'rgba(38, 38, 54, 0.5)' },
              beginAtZero: true
            },
            y: {
              grid: { display: false }
            }
          }
        }
      });
    }

  } catch (e) {
    console.error('Comparison error:', e);
    resultsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">⚠️</div><div class="empty-state-title">Fehler</div><div class="empty-state-desc" style="color:var(--red);font-family:monospace;font-size:12px;">' + escHtml(e.message || String(e)) + '</div></div>';
  }
}

// ============================================
// COMPETITOR WATCH
// ============================================
let competitorWatchlist = [];
let competitorAds = [];
let competitorAlerts = [];
let competitorViewLoaded = false;
var _selectedStandort = null; // page_name filter
var _selectedBrandForDrilldown = null; // brand name for breadcrumb/filter
var _adsPageSize = 50;
var _adsDisplayed = 50;
var _filteredAdsCache = []; // cached filtered ads for pagination
var _compSearchTerm = '';
var _compSearchDebounce = null;
var _autoCpm = null; // auto-calculated CPM from own campaign data
var _autoCpmDatapoints = 0; // number of datapoints used for auto-CPM

// --- Deduplication helper ---
function getCreativeHash(ad) {
  var body = (ad.ad_creative_bodies && ad.ad_creative_bodies.length > 0) ? ad.ad_creative_bodies[0] : '';
  return body.substring(0, 200).trim().toLowerCase();
}

function deduplicateAds(ads) {
  var groups = {};
  ads.forEach(function(ad) {
    var hash = getCreativeHash(ad);
    if (!hash) hash = '__empty__' + (ad.id || Math.random());
    if (!groups[hash]) {
      groups[hash] = { representative: ad, variants: [ad] };
    } else {
      groups[hash].variants.push(ad);
      // Keep the one with most reach as representative
      if ((ad.eu_total_reach || 0) > (groups[hash].representative.eu_total_reach || 0)) {
        groups[hash].representative = ad;
      }
    }
  });
  // Return representatives with _variants attached
  var now = new Date();
  return Object.keys(groups).map(function(hash) {
    var group = groups[hash];
    var rep = Object.assign({}, group.representative);
    rep._variants = group.variants;
    rep._variantCount = group.variants.length;
    // Aggregate reach across variants
    rep._totalReach = group.variants.reduce(function(sum, v) { return sum + (v.eu_total_reach || 0); }, 0);
    // Aggregate dates across variants for accurate status
    var earliestStart = null;
    var latestStop = null;
    var anyRunning = false;
    group.variants.forEach(function(v) {
      if (v.ad_delivery_start_time) {
        var s = new Date(v.ad_delivery_start_time);
        if (!earliestStart || s < earliestStart) earliestStart = s;
      }
      if (!v.ad_delivery_stop_time) {
        anyRunning = true;
        latestStop = null; // null means still running
      } else {
        var e = new Date(v.ad_delivery_stop_time);
        if (e > now) anyRunning = true;
        if (!anyRunning && (!latestStop || e > latestStop)) latestStop = e;
      }
    });
    // If any variant is running, latestStop should be null (open-ended)
    if (anyRunning) latestStop = null;
    rep._earliestStart = earliestStart;
    rep._latestStop = latestStop;
    rep._isRunning = anyRunning;
    var endDate = anyRunning ? now : (latestStop || now);
    rep._totalDays = earliestStart ? Math.max(1, Math.ceil((endDate - earliestStart) / 86400000)) : 0;
    return rep;
  });
}

// --- Auto-CPM from own campaign data ---
async function loadAutoCpm() {
  try {
    var metrics = await sbGet('campaign_daily_metrics', 'select=spend,impressions&impressions=gt.0');
    if (metrics && metrics.length > 0) {
      var totalSpend = 0;
      var totalImpressions = 0;
      metrics.forEach(function(m) {
        totalSpend += parseFloat(m.spend) || 0;
        totalImpressions += parseFloat(m.impressions) || 0;
      });
      if (totalImpressions > 0) {
        _autoCpm = totalSpend / totalImpressions * 1000;
        _autoCpmDatapoints = metrics.length;
        // Auto-fill CPM input if no manual override
        var cpmInput = document.getElementById('comp-own-cpm');
        var savedCpm = localStorage.getItem('comp_own_cpm');
        if (cpmInput && !savedCpm) {
          cpmInput.value = _autoCpm.toFixed(2);
        }
        // Show auto-CPM info
        var infoEl = document.getElementById('auto-cpm-info');
        if (infoEl) {
          infoEl.textContent = 'Ø Eigener CPM: €' + _autoCpm.toFixed(2) + ' (aus ' + _autoCpmDatapoints + ' Datenpunkten)';
          infoEl.style.display = 'block';
        }
      }
    }
  } catch (e) {
    console.error('Auto-CPM laden fehlgeschlagen:', e);
  }
}

async function loadCompetitorView() {
  // Load token from localStorage
  const token = localStorage.getItem('meta_ad_library_token') || '';
  document.getElementById('comp-api-token').value = token;
  updateSyncButton();

  // Reset pagination and search on view load
  _adsDisplayed = _adsPageSize;
  _compSearchTerm = '';
  var searchInput = document.getElementById('comp-search-input');
  if (searchInput) searchInput.value = '';

  if (!competitorViewLoaded) {
    await seedCompetitorWatchlist();
    competitorViewLoaded = true;
  }
  await Promise.all([loadWatchlist(), loadCompetitorAds(), loadAlerts(), loadAutoCpm()]);
  // Re-render watchlist grid now that competitorAds is fully loaded
  if (competitorWatchlist.length > 0) {
    renderWatchlistGrid();
  }
  updateCompetitorStats();
  updateStandortDropdown();
  // Render new sections after data is loaded
  renderLeaderboard();
  renderBrandOverviewCards();
  renderTrends();
  renderCompInsights();
}

// --- Watchlist CRUD ---
async function loadWatchlist() {
  const loadingEl = document.getElementById('comp-watchlist-loading');
  const emptyEl = document.getElementById('comp-watchlist-empty');
  const gridEl = document.getElementById('comp-watchlist-grid');

  loadingEl.style.display = 'flex';
  emptyEl.style.display = 'none';
  gridEl.style.display = 'none';

  try {
    // Fetch watchlist and active ad counts in parallel
    var results = await Promise.all([
      sbGet('competitor_watchlist', 'select=*&order=brand.asc.nullsfirst,page_name.asc'),
      sbGet('competitor_ads', 'select=watchlist_id&is_active=eq.true')
    ]);
    competitorWatchlist = results[0];
    // Build ad count map: { watchlist_id: count }
    _watchlistAdCounts = {};
    results[1].forEach(function(row) {
      _watchlistAdCounts[row.watchlist_id] = (_watchlistAdCounts[row.watchlist_id] || 0) + 1;
    });
  } catch (e) {
    console.error('Watchlist laden fehlgeschlagen:', e);
    competitorWatchlist = [];
    _watchlistAdCounts = {};
  }

  loadingEl.style.display = 'none';

  if (competitorWatchlist.length === 0) {
    emptyEl.style.display = 'block';
    gridEl.style.display = 'none';
  } else {
    emptyEl.style.display = 'none';
    gridEl.style.display = 'grid';
    renderWatchlistGrid();
  }

  // Update stats
  document.getElementById('comp-stat-brands').textContent = competitorWatchlist.filter(function(w) { return w.is_active; }).length;

  // Update brand filter dropdown
  updateBrandFilter();
}

var _watchlistAdCounts = {};

function renderWatchlistGrid() {
  const gridEl = document.getElementById('comp-watchlist-grid');
  gridEl.innerHTML = competitorWatchlist.map(function(w) {
    const adCount = _watchlistAdCounts[w.id] || 0;
    const inactiveClass = w.is_active ? '' : ' inactive';
    const toggleIcon = w.is_active ? '⏸️' : '▶️';
    const toggleTitle = w.is_active ? 'Deaktivieren' : 'Aktivieren';
    const notesHtml = w.notes ? '<div class="comp-brand-notes">' + escHtml(w.notes) + '</div>' : '';

    return '<div class="comp-brand-card' + inactiveClass + '">' +
      '<div class="comp-brand-header">' +
        '<div>' +
          '<div class="comp-brand-name">' + escHtml(w.page_name) + '</div>' +
        '</div>' +
        '<div class="comp-brand-actions">' +
          '<button onclick="toggleWatchlistItem(\'' + w.id + '\',' + !w.is_active + ')" title="' + toggleTitle + '">' + toggleIcon + '</button>' +
          '<button onclick="editWatchlistItem(\'' + w.id + '\')" title="Bearbeiten">✏️</button>' +
          '<button onclick="removeFromWatchlist(\'' + w.id + '\')" title="Löschen">🗑️</button>' +
        '</div>' +
      '</div>' +
      '<div class="comp-brand-stats">' +
        '<div class="comp-brand-stat">' +
          '<div class="comp-brand-stat-label">Aktive Ads</div>' +
          '<div class="comp-brand-stat-value">' + adCount + '</div>' +
        '</div>' +
        '<div class="comp-brand-stat">' +
          '<div class="comp-brand-stat-label">Page ID</div>' +
          '<div class="comp-brand-stat-value" style="font-size:12px;color:var(--text-secondary);">' + (w.page_id ? escHtml(w.page_id) : '–') + '</div>' +
        '</div>' +
        '<div class="comp-brand-stat">' +
          '<div class="comp-brand-stat-label">Status</div>' +
          '<div class="comp-brand-stat-value">' + (w.is_active ? '<span style="color:var(--green);">Aktiv</span>' : '<span style="color:var(--text-muted);">Inaktiv</span>') + '</div>' +
        '</div>' +
      '</div>' +
      notesHtml +
    '</div>';
  }).join('');
}

async function addToWatchlist(pageName, brand, notes, pageId) {
  try {
    var data = { page_name: pageName };
    if (brand) data.brand = brand;
    if (notes) data.notes = notes;
    if (pageId) data.page_id = pageId;
    await sbInsert('competitor_watchlist', data);
    showToast('Brand zur Watchlist hinzugefügt', 'success');
    await loadWatchlist();
  } catch (e) {
    console.error('Watchlist-Eintrag fehlgeschlagen:', e);
    showToast('Fehler: ' + e.message, 'error');
  }
}

async function removeFromWatchlist(id) {
  if (!confirm('Brand wirklich von der Watchlist entfernen? Alle zugehörigen Ads werden ebenfalls gelöscht.')) return;
  try {
    await sbDelete('competitor_watchlist', id);
    showToast('Brand entfernt', 'success');
    await Promise.all([loadWatchlist(), loadCompetitorAds()]);
  } catch (e) {
    console.error('Löschen fehlgeschlagen:', e);
    showToast('Fehler: ' + e.message, 'error');
  }
}

async function toggleWatchlistItem(id, isActive) {
  try {
    await sbPatch('competitor_watchlist', id, { is_active: isActive });
    showToast(isActive ? 'Brand aktiviert' : 'Brand deaktiviert', 'success');
    await loadWatchlist();
  } catch (e) {
    console.error('Toggle fehlgeschlagen:', e);
    showToast('Fehler: ' + e.message, 'error');
  }
}

function editWatchlistItem(id) {
  var item = competitorWatchlist.find(function(w) { return w.id === id; });
  if (!item) return;
  document.getElementById('comp-modal-edit-id').value = id;
  document.getElementById('comp-modal-title').textContent = 'Account bearbeiten';
  document.getElementById('comp-modal-pagename').value = item.page_name || '';
  document.getElementById('comp-modal-pageid').value = item.page_id || '';
  document.getElementById('comp-modal-notes').value = item.notes || '';
  document.getElementById('comp-watchlist-modal').style.display = 'flex';
}

function openWatchlistModal() {
  document.getElementById('comp-modal-edit-id').value = '';
  document.getElementById('comp-modal-title').textContent = 'Account zur Watchlist hinzufügen';
  document.getElementById('comp-modal-pagename').value = '';
  document.getElementById('comp-modal-pageid').value = '';
  document.getElementById('comp-modal-notes').value = '';
  document.getElementById('comp-watchlist-modal').style.display = 'flex';
}

function closeWatchlistModal() {
  document.getElementById('comp-watchlist-modal').style.display = 'none';
}

async function saveWatchlistItem() {
  var pageName = document.getElementById('comp-modal-pagename').value.trim();
  var pageId = document.getElementById('comp-modal-pageid').value.trim();
  var notes = document.getElementById('comp-modal-notes').value.trim();
  var editId = document.getElementById('comp-modal-edit-id').value;

  if (!pageName) {
    showToast('Page Name ist erforderlich', 'error');
    return;
  }

  try {
    if (editId) {
      await sbPatch('competitor_watchlist', editId, {
        page_name: pageName,
        page_id: pageId || null,
        notes: notes || null
      });
      showToast('Account aktualisiert', 'success');
    } else {
      await addToWatchlist(pageName, null, notes, pageId);
    }
    closeWatchlistModal();
    await loadWatchlist();
  } catch (e) {
    showToast('Fehler: ' + e.message, 'error');
  }
}

// --- Ad Display ---
async function loadCompetitorAds(watchlistId) {
  var loadingEl = document.getElementById('comp-ads-loading');
  var emptyEl = document.getElementById('comp-ads-empty');
  var gridEl = document.getElementById('comp-ads-grid');

  loadingEl.style.display = 'flex';
  emptyEl.style.display = 'none';
  gridEl.style.display = 'none';

  try {
    var query = 'select=*,spend_lower,spend_upper,impressions_lower,impressions_upper,eu_total_reach,estimated_spend,estimated_cpm&order=ad_delivery_start_time.desc.nullslast';
    if (watchlistId) query += '&watchlist_id=eq.' + watchlistId;
    competitorAds = await sbGet('competitor_ads', query);
  } catch (e) {
    console.error('Ads laden fehlgeschlagen:', e);
    competitorAds = [];
  }

  loadingEl.style.display = 'none';
  _adsDisplayed = _adsPageSize; // reset pagination on reload
  updateStandortDropdown();
  applyCompetitorFilters();
  updateCompetitorStats();
  // Re-render new sections
  renderLeaderboard();
  renderBrandOverviewCards();
  renderTrends();
  renderCompInsights();
}

function calcDaysRunning(ad) {
  if (ad._totalDays !== undefined) return ad._totalDays;
  if (!ad.ad_delivery_start_time) return 0;
  var start = new Date(ad.ad_delivery_start_time);
  var end = ad.ad_delivery_stop_time ? new Date(ad.ad_delivery_stop_time) : new Date();
  return Math.max(1, Math.ceil((end - start) / 86400000));
}

function isAdRunningByDate(ad) {
  if (ad._isRunning !== undefined) return ad._isRunning;
  if (!ad.ad_delivery_stop_time) return true;
  return new Date(ad.ad_delivery_stop_time) > new Date();
}

// Unique ID for ad cards
var _adCardIdCounter = 0;

function platformBadgeColor(p) {
  switch((p || '').toLowerCase()) {
    case 'facebook': return 'background:rgba(37,99,235,0.08);color:var(--blue);border-color:rgba(37,99,235,0.2);';
    case 'instagram': return 'background:rgba(231,53,46,0.08);color:var(--accent);border-color:rgba(231,53,46,0.2);';
    case 'messenger': return 'background:rgba(8,145,178,0.08);color:var(--cyan);border-color:rgba(8,145,178,0.2);';
    case 'audience_network': return 'background:rgba(202,138,4,0.08);color:var(--gold);border-color:rgba(202,138,4,0.2);';
    case 'threads': return 'background:rgba(0,0,0,0.06);color:var(--text-secondary);border-color:rgba(0,0,0,0.15);';
    default: return '';
  }
}

function platformLabel(p) {
  switch((p || '').toLowerCase()) {
    case 'facebook': return 'FB';
    case 'instagram': return 'IG';
    case 'messenger': return 'MSG';
    case 'audience_network': return 'AN';
    case 'threads': return 'TH';
    default: return p;
  }
}

function toggleAdBodyExpand(id) {
  var el = document.getElementById('ad-body-' + id);
  var btn = document.getElementById('ad-body-toggle-' + id);
  if (!el || !btn) return;
  if (el.dataset.expanded === 'true') {
    el.textContent = el.dataset.short;
    el.dataset.expanded = 'false';
    btn.textContent = 'Mehr anzeigen';
  } else {
    el.textContent = el.dataset.full;
    el.dataset.expanded = 'true';
    btn.textContent = 'Weniger';
  }
}

function copyAdText(text) {
  navigator.clipboard.writeText(text).then(function() {
    showToast('Text kopiert 📋', 'success');
  }).catch(function() {
    showToast('Kopieren fehlgeschlagen', 'error');
  });
}

function copyAdTextFromEl(btn) {
  var text = btn.getAttribute('data-copy-text') || '';
  copyAdText(text);
}

function openAdPreview(adId) {
  var card = document.getElementById('ad-card-' + adId);
  if (!card) return;
  var url = card.dataset.snapshotUrl;
  if (!url) { showToast('Keine Preview-URL verfügbar', 'error'); return; }
  var token = localStorage.getItem('meta_ad_library_token');
  if (token) {
    url += (url.indexOf('?') >= 0 ? '&' : '?') + 'access_token=' + encodeURIComponent(token);
  }
  window.open(url, '_blank', 'width=480,height=720,scrollbars=yes,resizable=yes');
}

function getEffectiveCpm() {
  var manualCpm = parseFloat(localStorage.getItem('comp_own_cpm') || '');
  if (manualCpm > 0) return manualCpm;
  if (_autoCpm && _autoCpm > 0) return _autoCpm;
  return 0;
}

function getAdEffectiveSpend(ad) {
  var cpm = getEffectiveCpm();
  var reach = ad._totalReach || ad.eu_total_reach || 0;
  if (cpm > 0 && reach > 0) {
    return Math.round(reach * cpm / 1000 * 100); // in cents like estimated_spend
  }
  return ad.estimated_spend || 0;
}

function renderAdCard(ad) {
  var cardId = 'ac-' + (++_adCardIdCounter);
  var brand = ad.page_name || '–';
  var bodyText = (ad.ad_creative_bodies && ad.ad_creative_bodies.length > 0) ? ad.ad_creative_bodies[0] : '';
  var running = isAdRunningByDate(ad);
  var platforms = ad.publisher_platforms || [];
  var days = calcDaysRunning(ad);

  // Platform badges
  var platformsHtml = platforms.slice(0, 2).map(function(p) {
    return '<span class="comp-platform-badge" style="' + platformBadgeColor(p) + 'font-size:10px;padding:1px 6px;">' + escHtml(platformLabel(p)) + '</span>';
  }).join('');

  // Spend badge — use CPM-based calc if available
  var effectiveSpend = getAdEffectiveSpend(ad);
  var spendBadge = effectiveSpend > 0
    ? '<span style="background:rgba(245,158,11,0.15);color:#f59e0b;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;">€' + Number((effectiveSpend / 100).toFixed(0)).toLocaleString('de-DE') + '</span>'
    : '';

  // Status dot
  var statusDot = '<span class="compact-status-dot ' + (running ? 'active' : 'stopped') + '"></span>';

  // Truncated body text
  var shortBody = bodyText ? (bodyText.length > 80 ? bodyText.substring(0, 80) + '…' : bodyText) : 'Kein Anzeigentext';

  // Thumbnail placeholder
  var thumbHtml = '<div class="compact-thumb-placeholder">📄</div>';

  // Days badge (small)
  var daysBadge = days > 0 ? '<span style="font-size:10px;color:var(--text-muted);">' + days + 'd</span>' : '';

  // Variant count badge (dedup)
  var variantBadge = (ad._variantCount && ad._variantCount > 1) ? '<span style="background:rgba(139,92,246,0.15);color:#8b5cf6;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;">' + ad._variantCount + ' Varianten</span>' : '';

  return '<div class="comp-ad-card-compact" id="ad-card-' + cardId + '" data-ad-id="' + (ad.id || '') + '" data-snapshot-url="' + escHtml(ad.ad_snapshot_url || '') + '" onclick="openAdDetailModal(\'' + escHtml(ad.id || '') + '\')">' +
    thumbHtml +
    '<div class="compact-body">' +
      '<div class="compact-brand">' + statusDot + ' ' + escHtml(brand) + '</div>' +
      '<div class="compact-text">' + escHtml(shortBody) + '</div>' +
      '<div class="compact-badges">' + platformsHtml + spendBadge + variantBadge + daysBadge + '</div>' +
    '</div>' +
  '</div>';
}

function renderAdFeed(ads, filterBrand, filterStatus, sortBy) {
  var filtered = ads.slice();

  // Filter by brand (filterBrand is now a brand name, not a watchlist_id)
  if (filterBrand) {
    var brandIds = getWatchlistIdsForBrand(filterBrand);
    filtered = filtered.filter(function(a) { return brandIds.indexOf(a.watchlist_id) !== -1; });
  }

  // Sort
  if (sortBy === 'longest') {
    filtered.sort(function(a, b) {
      return (b.days_running || calcDaysRunning(b)) - (a.days_running || calcDaysRunning(a));
    });
  } else if (sortBy === 'spend-desc') {
    filtered.sort(function(a, b) { return getAdEffectiveSpend(b) - getAdEffectiveSpend(a); });
  } else if (sortBy === 'spend-asc') {
    filtered.sort(function(a, b) { return getAdEffectiveSpend(a) - getAdEffectiveSpend(b); });
  } else {
    // newest
    filtered.sort(function(a, b) {
      var da = a.ad_delivery_start_time ? new Date(a.ad_delivery_start_time) : new Date(0);
      var db = b.ad_delivery_start_time ? new Date(b.ad_delivery_start_time) : new Date(0);
      return db - da;
    });
  }

  return filtered;
}

function applyCompetitorFilters() {
  var filterBrand = document.getElementById('comp-filter-brand').value;
  var sortBy = document.getElementById('comp-sort').value;
  var standortFilter = document.getElementById('comp-filter-standort').value;

  // Sync drilldown state with dropdown (ensures "Alle Brands" always clears brand filter)
  _selectedBrandForDrilldown = filterBrand || null;
  _selectedStandort = standortFilter || null;

  // Deduplicate before filtering
  var dedupedAds = deduplicateAds(competitorAds);
  var filtered = renderAdFeed(dedupedAds, filterBrand, '', sortBy);

  // Apply standort sub-filter from dropdown
  if (_selectedStandort) {
    filtered = filtered.filter(function(a) { return a.page_name === _selectedStandort; });
  }

  // Apply search term filter
  if (_compSearchTerm) {
    var term = _compSearchTerm.toLowerCase();
    filtered = filtered.filter(function(a) {
      return (a.page_name && a.page_name.toLowerCase().indexOf(term) !== -1);
    });
  }

  // Cache for pagination
  _filteredAdsCache = filtered;

  // Render with pagination
  renderPaginatedAds();
}

function updateCompetitorStats() {
  var adsPool = competitorAds;

  // Apply standort/brand filter to stats
  if (_selectedStandort) {
    adsPool = adsPool.filter(function(a) { return a.page_name === _selectedStandort; });
  } else if (_selectedBrandForDrilldown) {
    var _brandIds = getWatchlistIdsForBrand(_selectedBrandForDrilldown);
    adsPool = adsPool.filter(function(a) { return _brandIds.indexOf(a.watchlist_id) !== -1; });
  }

  var totalVariants = adsPool.length;
  var dedupedPool = deduplicateAds(adsPool);
  var total = dedupedPool.length;
  var active = dedupedPool.filter(function(a) {
    return isAdRunningByDate(a);
  }).length;
  var daysArr = adsPool.map(function(a) { return a.days_running || calcDaysRunning(a); });
  var avgDays = daysArr.length > 0 ? Math.round(daysArr.reduce(function(s, d) { return s + d; }, 0) / daysArr.length) : 0;
  var longest = daysArr.length > 0 ? Math.max.apply(null, daysArr) : 0;

  document.getElementById('comp-stat-total').textContent = total + (totalVariants > total ? ' (' + totalVariants + ' Var.)' : '');
  document.getElementById('comp-stat-active').textContent = active;
  document.getElementById('comp-stat-avg-days').textContent = avgDays || '–';
  document.getElementById('comp-stat-longest').textContent = longest || '–';

  // AdSpend KPIs — use CPM-based spend with deduped pool (aggregated reach)
  var spendArr = dedupedPool.map(function(a) { return getAdEffectiveSpend(a); }).filter(function(s) { return s > 0; });
  var totalSpend = spendArr.reduce(function(s, v) { return s + v; }, 0);
  var avgSpend = spendArr.length > 0 ? Math.round(totalSpend / spendArr.length) : 0;
  var effectiveCpm = getEffectiveCpm();
  var cpmArr = [];
  if (effectiveCpm > 0) {
    cpmArr = [effectiveCpm * 100]; // use effective CPM (auto or manual) as reference
  } else {
    cpmArr = adsPool.filter(function(a) { return a.estimated_cpm && a.estimated_cpm > 0; }).map(function(a) { return parseFloat(a.estimated_cpm); });
  }
  var avgCpm = cpmArr.length > 0 ? Math.round(cpmArr.reduce(function(s, v) { return s + v; }, 0) / cpmArr.length) : 0;

  document.getElementById('comp-stat-total-spend').textContent = spendArr.length > 0 ? '€' + Math.round(totalSpend / 100).toLocaleString('de-DE') : '—';
  document.getElementById('comp-stat-avg-spend').textContent = spendArr.length > 0 ? '€' + Math.round(avgSpend / 100).toLocaleString('de-DE') : '—';
  document.getElementById('comp-stat-avg-cpm').textContent = cpmArr.length > 0 ? '€' + (avgCpm / 100).toFixed(2) : '—';
}

function updateBrandFilter() {
  var select = document.getElementById('comp-filter-brand');
  var current = select.value;
  select.innerHTML = '<option value="">Alle Brands</option>';
  var seenBrands = {};
  competitorWatchlist.forEach(function(w) {
    var brand = w.brand || w.page_name;
    if (!seenBrands[brand]) {
      seenBrands[brand] = true;
      var opt = document.createElement('option');
      opt.value = brand;
      opt.textContent = brand;
      select.appendChild(opt);
    }
  });
  // Restore selection if still valid
  if (current && seenBrands[current]) {
    select.value = current;
  } else {
    select.value = '';
  }
  // Sync drilldown state with actual dropdown value (fixes "Alle Brands" showing stale brand data)
  _selectedBrandForDrilldown = select.value || null;
}

function getWatchlistIdsForBrand(brandName) {
  return competitorWatchlist
    .filter(function(w) { return (w.brand || w.page_name) === brandName; })
    .map(function(w) { return w.id; });
}

// --- Alerts ---
async function loadAlerts() {
  try {
    competitorAlerts = await sbGet('competitor_alerts', 'select=*&is_read=eq.false&order=created_at.desc&limit=50');
  } catch (e) {
    console.error('Alerts laden fehlgeschlagen:', e);
    competitorAlerts = [];
  }
  renderAlertBanner(competitorAlerts);
}

function getAlertTypeInfo(alertType) {
  switch (alertType) {
    case 'new_ad': return { icon: '🆕', cls: 'comp-alert-new', label: 'Neue Ad' };
    case 'burst': return { icon: '📢', cls: 'comp-alert-burst', label: 'Burst' };
    default: return { icon: '🔔', cls: '', label: alertType || 'Alert' };
  }
}

function renderAlertBanner(alerts) {
  var banner = document.getElementById('comp-alert-banner');
  if (!alerts || alerts.length === 0) {
    banner.style.display = 'none';
    return;
  }
  banner.style.display = 'flex';
  document.getElementById('comp-alert-title').textContent = alerts.length + ' neue Alert' + (alerts.length > 1 ? 's' : '');

  // Render detailed alert items
  var html = alerts.slice(0, 5).map(function(a) {
    var info = getAlertTypeInfo(a.alert_type);
    var msg = a.message || info.label;
    return '<div class="comp-alert-item"><span class="comp-alert-icon ' + info.cls + '">' + info.icon + '</span><span>' + escHtml(msg) + '</span></div>';
  }).join('');
  if (alerts.length > 5) {
    html += '<div style="font-size:12px;color:var(--text-muted);padding-top:6px;">… und ' + (alerts.length - 5) + ' weitere</div>';
  }
  document.getElementById('comp-alert-text').innerHTML = html;
}

async function markAlertsRead() {
  var banner = document.getElementById('comp-alert-banner');
  try {
    // Bulk update: patch all unread alerts at once
    var ids = competitorAlerts.map(function(a) { return a.id; });
    if (ids.length > 0) {
      // Use Supabase bulk PATCH with in filter
      var url = SB_URL + '/rest/v1/competitor_alerts?id=in.(' + ids.join(',') + ')';
      var res = await fetch(url, {
        method: 'PATCH',
        headers: SB_HEADERS,
        body: JSON.stringify({ is_read: true })
      });
      if (!res.ok) {
        // Fallback: individual patches
        for (var i = 0; i < competitorAlerts.length; i++) {
          await sbPatch('competitor_alerts', competitorAlerts[i].id, { is_read: true });
        }
      }
    }
    competitorAlerts = [];
    banner.style.display = 'none';
    showToast('Alerts als gelesen markiert ✓', 'success');
  } catch (e) {
    console.error('markAlertsRead Fehler:', e);
    // Still hide banner on UI even if DB update failed
    competitorAlerts = [];
    banner.style.display = 'none';
    showToast('Alerts ausgeblendet (DB-Update fehlgeschlagen)', 'error');
  }
}

// --- Collapsible Sections ---
function toggleCollapsible(sectionName) {
  var body = document.getElementById('comp-' + sectionName + '-body');
  var chevron = document.getElementById('comp-' + sectionName + '-chevron');
  if (!body || !chevron) return;
  if (body.classList.contains('collapsed')) {
    body.classList.remove('collapsed');
    chevron.textContent = '▼';
  } else {
    body.classList.add('collapsed');
    chevron.textContent = '▶';
  }
}

// --- Clickable Stats ---
function onCompStatClick(stat) {
  switch (stat) {
    case 'active':
      showView('competitors', 'feed');
      setTimeout(function() {
        applyCompetitorFilters();
      }, 100);
      break;
    case 'avg-days':
      showView('competitors', 'feed');
      setTimeout(function() {
        document.getElementById('comp-sort').value = 'longest';
        applyCompetitorFilters();
      }, 100);
      break;
    case 'longest':
      showView('competitors', 'feed');
      setTimeout(scrollToLongestAd, 100);
      break;
    case 'total-spend':
    case 'avg-spend':
      showView('competitors', 'feed');
      setTimeout(function() {
        document.getElementById('comp-sort').value = 'spend-desc';
        applyCompetitorFilters();
      }, 100);
      break;
    case 'avg-cpm':
      showView('competitors', 'leaderboard');
      setTimeout(function() { switchLeaderboard('spend'); }, 100);
      break;
    case 'brands':
    case 'total':
    default:
      showView('competitors', 'feed');
      break;
  }
}

function scrollToLongestAd() {
  if (competitorAds.length === 0) return;
  // Reset filters to show all
  document.getElementById('comp-filter-brand').value = '';
  document.getElementById('comp-sort').value = 'longest';
  applyCompetitorFilters();
  // After rendering, scroll to the first card and flash it
  setTimeout(function() {
    var grid = document.getElementById('comp-ads-grid');
    if (grid && grid.firstElementChild) {
      grid.firstElementChild.scrollIntoView({ behavior: 'smooth', block: 'center' });
      grid.firstElementChild.classList.add('flash-highlight');
      setTimeout(function() {
        grid.firstElementChild.classList.remove('flash-highlight');
      }, 1600);
    }
  }, 100);
}

// --- Leaderboard ---
var _leaderboardMode = 'longevity';

function switchLeaderboard(type) {
  _leaderboardMode = type;
  document.getElementById('lb-tab-longevity').className = type === 'longevity' ? 'ranking-tab active' : 'ranking-tab';
  document.getElementById('lb-tab-spend').className = type === 'spend' ? 'ranking-tab active' : 'ranking-tab';
  renderLeaderboard();
}

function renderLeaderboard() {
  var container = document.getElementById('comp-leaderboard-content');
  if (competitorAds.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding:40px;"><div class="empty-state-desc">Keine Ads vorhanden</div></div>';
    return;
  }
  // Get top 10 (deduplicated)
  var sorted = deduplicateAds(competitorAds).map(function(ad) {
    ad._days = calcDaysRunning(ad);
    return ad;
  });

  if (_leaderboardMode === 'spend') {
    sorted = sorted.filter(function(ad) { return getAdEffectiveSpend(ad) > 0; });
    sorted.sort(function(a, b) { return getAdEffectiveSpend(b) - getAdEffectiveSpend(a); });
  } else {
    sorted.sort(function(a, b) { return b._days - a._days; });
  }
  sorted = sorted.slice(0, 10);

  if (_leaderboardMode === 'spend' && sorted.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding:40px;"><div class="empty-state-desc">Keine Spend-Daten vorhanden — Migration V6 ausführen und Sync starten.</div></div>';
    return;
  }

  var html = '';
  if (_leaderboardMode === 'spend') {
    html = '<table class="comp-leaderboard-table"><thead><tr>' +
      '<th>#</th><th>Account</th><th>Spend (€)</th><th>Impressions</th><th>CPM (€)</th><th>Laufzeit</th>' +
      '</tr></thead><tbody>';
    sorted.forEach(function(ad, i) {
      var rank = i + 1;
      var rankDisplay = rank <= 3 ? ['🥇','🥈','🥉'][i] : rank + '.';
      var brand = ad.page_name || '–';
      var effSpend = getAdEffectiveSpend(ad);
      var spendEur = effSpend > 0 ? '€' + Math.round(effSpend / 100).toLocaleString('de-DE') : '–';
      var impressions = (ad.impressions_lower && ad.impressions_upper) ? Math.round((ad.impressions_lower + ad.impressions_upper) / 2).toLocaleString('de-DE') : '–';
      var effCpmLb = getEffectiveCpm();
      var cpm = effCpmLb > 0 ? '€' + effCpmLb.toFixed(2) : (ad.estimated_cpm ? '€' + (parseFloat(ad.estimated_cpm) / 100).toFixed(2) : '–');
      var days = ad._days;
      var daysClass = days >= 90 ? 'comp-days-red' : days >= 30 ? 'comp-days-orange' : 'comp-days-green';
      html += '<tr onclick="scrollToAdInFeed(\'' + (ad.id || '') + '\')" style="cursor:pointer;">' +
        '<td class="comp-leaderboard-rank">' + rankDisplay + '</td>' +
        '<td style="font-weight:600;">' + escHtml(brand) + '</td>' +
        '<td style="font-weight:700;color:#f59e0b;">' + spendEur + '</td>' +
        '<td>' + impressions + '</td>' +
        '<td>' + cpm + '</td>' +
        '<td><span class="comp-days-badge ' + daysClass + '">' + days + '</span></td>' +
      '</tr>';
    });
  } else {
    html = '<table class="comp-leaderboard-table"><thead><tr>' +
      '<th>#</th><th>Brand / Seite</th><th>Anzeigentext</th><th>Tage</th><th>Plattform</th><th>Status</th>' +
      '</tr></thead><tbody>';
    sorted.forEach(function(ad, i) {
      var rank = i + 1;
      var rankDisplay = rank <= 3 ? ['🥇','🥈','🥉'][i] : rank + '.';
      var brand = ad.page_name || '–';
      var bodyText = (ad.ad_creative_bodies && ad.ad_creative_bodies.length > 0) ? ad.ad_creative_bodies[0] : '–';
      if (bodyText.length > 60) bodyText = bodyText.substring(0, 60) + '…';
      var days = ad._days;
      var daysClass = days >= 90 ? 'comp-days-red' : days >= 30 ? 'comp-days-orange' : 'comp-days-green';
      var daysEmoji = days >= 90 ? ' 🔥' : '';
      var platforms = (ad.publisher_platforms || []).map(function(p) {
        return platformLabel(p);
      }).join(', ');
      var adRunning = isAdRunningByDate(ad);
      var statusBadge = adRunning
        ? '<span class="badge badge-active" style="font-size:10px;padding:2px 8px;"><span class="badge-dot"></span>Laufend</span>'
        : '<span class="badge badge-completed" style="font-size:10px;padding:2px 8px;"><span class="badge-dot"></span>Beendet</span>';
      html += '<tr onclick="scrollToAdInFeed(\'' + (ad.id || '') + '\')" style="cursor:pointer;">' +
        '<td class="comp-leaderboard-rank">' + rankDisplay + '</td>' +
        '<td style="font-weight:600;">' + escHtml(brand) + '</td>' +
        '<td class="comp-leaderboard-text">' + escHtml(bodyText) + '</td>' +
        '<td><span class="comp-days-badge ' + daysClass + '">' + days + daysEmoji + '</span></td>' +
        '<td style="font-size:11px;">' + escHtml(platforms || '–') + '</td>' +
        '<td>' + statusBadge + '</td>' +
      '</tr>';
    });
  }

  html += '</tbody></table>';
  container.innerHTML = html;
}

function scrollToAdInFeed(adId) {
  if (!adId) return;
  // Switch to feed tab first
  showView('competitors', 'feed');
  setTimeout(function() {
    // Reset filters, sort by longest (matches leaderboard context)
    document.getElementById('comp-filter-brand').value = '';
    document.getElementById('comp-sort').value = 'longest';
    applyCompetitorFilters();
    // Expand pagination if the ad is beyond the current page
    var adIndex = -1;
    for (var i = 0; i < _filteredAdsCache.length; i++) {
      if (_filteredAdsCache[i].id === adId) { adIndex = i; break; }
    }
    if (adIndex >= _adsDisplayed) {
      _adsDisplayed = adIndex + _adsPageSize;
      renderPaginatedAds();
    }
    setTimeout(function() {
      var card = document.querySelector('.comp-ad-card[data-ad-id="' + adId + '"]');
      if (!card) {
        // Ad not rendered yet — expand to show all and retry
        _adsDisplayed = _filteredAdsCache.length;
        renderPaginatedAds();
        card = document.querySelector('.comp-ad-card[data-ad-id="' + adId + '"]');
      }
      if (card) {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        card.classList.add('flash-highlight');
        setTimeout(function() { card.classList.remove('flash-highlight'); }, 1600);
      }
    }, 100);
  }, 50);
}

// --- Brand Overview — compact cards, click to filter ---
function renderBrandOverviewCards() {
  var container = document.getElementById('comp-brand-overview-content');
  if (competitorWatchlist.length === 0 || competitorAds.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding:40px;grid-column:1/-1;"><div class="empty-state-desc">Keine Daten vorhanden</div></div>';
    return;
  }

  var html = competitorWatchlist.filter(function(w) { return w.is_active; }).map(function(w) {
    var brandAds = competitorAds.filter(function(a) { return a.watchlist_id === w.id; });
    var activeAds = brandAds.filter(function(a) { return isAdRunningByDate(a); });
    var totalAds = brandAds.length;
    var daysArr = brandAds.map(function(a) { return calcDaysRunning(a); });
    var avgDays = daysArr.length > 0 ? Math.round(daysArr.reduce(function(s,d) { return s + d; }, 0) / daysArr.length) : 0;

    // Unique standorte count
    var standortSet = {};
    brandAds.forEach(function(a) { if (a.page_name) standortSet[a.page_name] = true; });
    var standortCount = Object.keys(standortSet).length;

    var brandName = w.brand || w.page_name;
    var isSelected = _selectedBrandForDrilldown === brandName;
    var selectedClass = isSelected ? ' selected' : '';
    var encodedBrand = encodeURIComponent(brandName);

    return '<div class="comp-brand-overview-card' + selectedClass + '" onclick="showBrandDetail(decodeURIComponent(\'' + encodedBrand + '\'))">' +
      '<div class="brand-name">' + escHtml(w.brand || w.page_name) + '</div>' +
      '<div class="brand-standort-count">📍 ' + standortCount + ' Standort' + (standortCount !== 1 ? 'e' : '') + '</div>' +
      '<div class="brand-stats-grid" style="margin-top:10px;">' +
        '<div class="brand-stat-item"><div class="brand-stat-label">Aktive Ads</div><div class="brand-stat-val" style="color:var(--green);">' + activeAds.length + '</div></div>' +
        '<div class="brand-stat-item"><div class="brand-stat-label">Gesamt</div><div class="brand-stat-val">' + totalAds + '</div></div>' +
        '<div class="brand-stat-item"><div class="brand-stat-label">Ø Tage</div><div class="brand-stat-val">' + avgDays + '</div></div>' +
        '<div class="brand-stat-item"><div class="brand-stat-label">Standorte</div><div class="brand-stat-val">' + standortCount + '</div></div>' +
      '</div>' +
    '</div>';
  }).join('');

  container.innerHTML = html || '<div class="empty-state" style="padding:40px;grid-column:1/-1;"><div class="empty-state-desc">Keine aktiven Brands</div></div>';
}

// --- Brand Detail Page (AdSpend.com style) ---
var _brandDetailChart = null;
var _brandDetailCurrentBrand = null;
var _brandDetailPeriod = 0; // 0 = Gesamt, 30, 90
var _brandDetailSortMode = 'reach'; // reach, duration, spend

function showBrandDetail(brandName, period, sortMode) {
  _brandDetailCurrentBrand = brandName;
  if (typeof period === 'number') _brandDetailPeriod = period;
  if (sortMode) _brandDetailSortMode = sortMode;
  var activePeriod = _brandDetailPeriod;
  var activeSort = _brandDetailSortMode || 'reach';

  // Hide all competitor sub-tabs, show brand detail
  document.querySelectorAll('.comp-sub-tab').forEach(function(t) { t.style.display = 'none'; });
  document.getElementById('comp-sub-brand-detail').style.display = 'block';

  var container = document.getElementById('comp-brand-detail-content');

  // Find watchlist entries for this brand
  var watchlistEntries = competitorWatchlist.filter(function(w) {
    return (w.brand || w.page_name) === brandName;
  });
  var watchlistIds = watchlistEntries.map(function(w) { return w.id; });
  var pageId = watchlistEntries.length > 0 ? (watchlistEntries[0].page_id || '') : '';

  // Get all ads for this brand
  var brandAds = competitorAds.filter(function(a) {
    return watchlistIds.indexOf(a.watchlist_id) !== -1;
  });

  // --- Time period filter ---
  var now = new Date();
  var cutoffDate = null;
  if (activePeriod > 0) {
    cutoffDate = new Date(now.getTime() - activePeriod * 86400000);
  }

  function adInPeriod(ad) {
    if (!cutoffDate) return true; // Gesamt
    var start = ad.ad_delivery_start_time ? new Date(ad.ad_delivery_start_time) : null;
    var stop = ad.ad_delivery_stop_time ? new Date(ad.ad_delivery_stop_time) : null;
    if (start && start >= cutoffDate) return true;
    if (stop && stop >= cutoffDate) return true;
    if (start && !stop) return true;
    return false;
  }

  var filteredAds = brandAds.filter(adInPeriod);
  var dedupedAds = deduplicateAds(filteredAds);

  // --- Sort by active mode ---
  if (activeSort === 'duration') {
    dedupedAds.sort(function(a, b) {
      return calcDaysRunning(b) - calcDaysRunning(a);
    });
  } else if (activeSort === 'spend') {
    dedupedAds.sort(function(a, b) {
      return getAdEffectiveSpend(b) - getAdEffectiveSpend(a);
    });
  } else {
    // Default: reach
    dedupedAds.sort(function(a, b) {
      return (b._totalReach || b.eu_total_reach || 0) - (a._totalReach || a.eu_total_reach || 0);
    });
  }

  // --- Helper: is ad still running ---
  function isAdRunning(ad) {
    return isAdRunningByDate(ad);
  }

  // --- Card 1: Ads Überblick ---
  var totalUnique = dedupedAds.length;
  var totalVariants = 0;
  dedupedAds.forEach(function(ad) { totalVariants += (ad._variantCount || 1); });
  var avgVariants = totalUnique > 0 ? (totalVariants / totalUnique).toFixed(1) : '0';

  // New ads in last 30 days
  var thirtyDaysAgo = new Date(now.getTime() - 30 * 86400000);
  var newAdsCount = 0;
  dedupedAds.forEach(function(ad) {
    var variants = ad._variants || [ad];
    var hasRecent = variants.some(function(v) {
      return v.ad_delivery_start_time && new Date(v.ad_delivery_start_time) >= thirtyDaysAgo;
    });
    if (hasRecent) newAdsCount++;
  });

  // --- Card 2: AdSpend ---
  var totalSpendCents = 0;
  dedupedAds.forEach(function(ad) {
    totalSpendCents += getAdEffectiveSpend(ad);
  });
  var totalSpendEuro = Math.round(totalSpendCents / 100);

  // Platform distribution
  var platformCounts = { FB: 0, IG: 0, AN: 0, MSG: 0, TH: 0 };
  var platformTotal = 0;
  dedupedAds.forEach(function(ad) {
    var pls = ad.publisher_platforms || [];
    pls.forEach(function(p) {
      var key = platformLabel(p);
      if (platformCounts.hasOwnProperty(key)) { platformCounts[key]++; platformTotal++; }
    });
  });

  // --- Card 3: Reach-Analyse ---
  var totalReach = 0;
  var reachArr = [];
  var allDaysArr = [];
  dedupedAds.forEach(function(ad) {
    var r = ad._totalReach || ad.eu_total_reach || 0;
    totalReach += r;
    reachArr.push(r);
    allDaysArr.push(calcDaysRunning(ad));
  });
  var avgReach = totalUnique > 0 ? Math.round(totalReach / totalUnique) : 0;
  var minReach = reachArr.length > 0 ? Math.min.apply(null, reachArr) : 0;
  var maxReach = reachArr.length > 0 ? Math.max.apply(null, reachArr) : 0;
  var avgDays = allDaysArr.length > 0 ? Math.round(allDaysArr.reduce(function(s, d) { return s + d; }, 0) / allDaysArr.length) : 0;

  // --- Period label ---
  var periodLabel = activePeriod === 30 ? 'Letzte 30 Tage' : activePeriod === 90 ? 'Letzte 90 Tage' : 'Gesamt';

  // --- Build HTML ---
  var html = '';

  // Header
  html += '<div class="brand-detail-header">';
  html += '<button class="brand-detail-back" onclick="closeBrandDetail()">← Zurück</button>';
  html += '<span class="brand-detail-title">' + escHtml(brandName) + '</span>';
  if (pageId) html += '<span class="brand-detail-pageid">ID: ' + escHtml(pageId) + '</span>';
  html += '<span class="brand-detail-pageid">' + totalUnique + ' Unique Creatives</span>';
  html += '</div>';

  // Time period filter tabs
  html += '<div style="display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap;">';
  html += '<button class="ranking-tab' + (activePeriod === 30 ? ' active' : '') + '" onclick="showBrandDetail(_brandDetailCurrentBrand, 30)">30 Tage</button>';
  html += '<button class="ranking-tab' + (activePeriod === 90 ? ' active' : '') + '" onclick="showBrandDetail(_brandDetailCurrentBrand, 90)">90 Tage</button>';
  html += '<button class="ranking-tab' + (activePeriod === 0 ? ' active' : '') + '" onclick="showBrandDetail(_brandDetailCurrentBrand, 0)">Gesamt</button>';
  html += '</div>';

  // Three Insight Cards
  html += '<div class="brand-detail-insights">';

  // Card 1: Ads Überblick (clean, no donut)
  html += '<div class="brand-insight-card">';
  html += '<h3>Ads Überblick</h3>';
  html += '<div class="brand-insight-big" style="color:var(--text-primary);font-size:36px;">' + totalUnique + '</div>';
  html += '<div class="brand-insight-subtitle">Unique Creatives</div>';
  html += '<div class="brand-insight-subtitle" style="margin-top:6px;">' + totalVariants + ' Varianten gesamt · Ø ' + avgVariants + ' pro Creative</div>';
  html += '<div class="brand-insight-small-stat">Neue Ads (letzte 30T): ' + newAdsCount + '</div>';
  html += '</div>';

  // Card 2: Geschätzter AdSpend (with timeframe pills)
  html += '<div class="brand-insight-card">';
  html += '<h3>Geschätzter AdSpend</h3>';
  html += '<div class="brand-timeframe-pills">';
  html += '<button class="brand-tf-pill' + (activePeriod === 30 ? ' active' : '') + '" onclick="showBrandDetail(_brandDetailCurrentBrand, 30)">30T</button>';
  html += '<button class="brand-tf-pill' + (activePeriod === 90 ? ' active' : '') + '" onclick="showBrandDetail(_brandDetailCurrentBrand, 90)">90T</button>';
  html += '<button class="brand-tf-pill' + (activePeriod === 0 ? ' active' : '') + '" onclick="showBrandDetail(_brandDetailCurrentBrand, 0)">Gesamt</button>';
  html += '</div>';
  html += '<div class="brand-insight-big">€' + totalSpendEuro.toLocaleString('de-DE') + '</div>';
  html += '<div style="width:100%;text-align:left;">';
  var platformColors = { FB: 'var(--blue)', IG: 'var(--accent)', AN: 'var(--gold)', MSG: 'var(--cyan)', TH: 'var(--text-secondary)' };
  var platformLabelsMap = { FB: 'FB', IG: 'IG', AN: 'AN', MSG: 'MSG', TH: 'TH' };
  ['FB', 'IG', 'AN', 'MSG', 'TH'].forEach(function(key) {
    var pct = platformTotal > 0 ? Math.round(platformCounts[key] / platformTotal * 100) : 0;
    if (pct > 0 || platformCounts[key] > 0) {
      html += '<div class="brand-insight-bar-row">';
      html += '<span class="brand-insight-bar-label">' + platformLabelsMap[key] + '</span>';
      html += '<div class="brand-insight-bar-track"><div class="brand-insight-bar-fill" style="width:' + pct + '%;background:' + platformColors[key] + ';"></div></div>';
      html += '<span class="brand-insight-bar-pct">' + pct + '%</span>';
      html += '</div>';
    }
  });
  html += '</div>';
  html += '</div>';

  // Card 3: Reach-Analyse
  html += '<div class="brand-insight-card">';
  html += '<h3>Reach-Analyse</h3>';
  html += '<div style="width:100%;">';
  html += '<div class="brand-insight-stat-row"><span class="brand-insight-stat-label">Gesamt-Reach</span><span class="brand-insight-stat-val" style="color:var(--cyan);">' + totalReach.toLocaleString('de-DE') + '</span></div>';
  html += '<div class="brand-insight-stat-row"><span class="brand-insight-stat-label">Ø Reach pro Creative</span><span class="brand-insight-stat-val">' + avgReach.toLocaleString('de-DE') + '</span></div>';
  html += '<div class="brand-insight-stat-row"><span class="brand-insight-stat-label">Reach-Spread</span><span class="brand-insight-stat-val" style="font-size:13px;">' + minReach.toLocaleString('de-DE') + ' — ' + maxReach.toLocaleString('de-DE') + '</span></div>';
  html += '<div class="brand-insight-stat-row" style="border-bottom:none;"><span class="brand-insight-stat-label">Ø Laufzeit</span><span class="brand-insight-stat-val">' + avgDays + ' Tage</span></div>';
  html += '</div>';
  html += '</div>';

  html += '</div>'; // close insights row

  // Sort tabs
  var sortLabel = activeSort === 'duration' ? 'Laufzeit' : activeSort === 'spend' ? 'Spend' : 'Reichweite';
  html += '<div class="brand-detail-feed-header">';
  html += '<h2>📰 Ads nach ' + sortLabel + '</h2>';
  html += '<span style="font-size:13px;color:var(--text-muted);">' + dedupedAds.length + ' Ads · ' + escHtml(periodLabel) + '</span>';
  html += '</div>';

  html += '<div class="brand-sort-tabs">';
  html += '<button class="brand-sort-tab' + (activeSort === 'reach' ? ' active' : '') + '" onclick="showBrandDetail(_brandDetailCurrentBrand, undefined, \'reach\')">Reichweite</button>';
  html += '<button class="brand-sort-tab' + (activeSort === 'duration' ? ' active' : '') + '" onclick="showBrandDetail(_brandDetailCurrentBrand, undefined, \'duration\')">Laufzeit</button>';
  html += '<button class="brand-sort-tab' + (activeSort === 'spend' ? ' active' : '') + '" onclick="showBrandDetail(_brandDetailCurrentBrand, undefined, \'spend\')">Spend</button>';
  html += '</div>';

  // Ad Feed
  dedupedAds.forEach(function(ad, idx) {
    var rank = idx + 1;
    var bodyText = (ad.ad_creative_bodies && ad.ad_creative_bodies.length > 0) ? ad.ad_creative_bodies[0] : 'Kein Text';
    var shortBody = bodyText.length > 100 ? bodyText.substring(0, 100) + '…' : bodyText;
    var reach = ad._totalReach || ad.eu_total_reach || 0;
    var spend = getAdEffectiveSpend(ad);
    var spendEuro = Math.round(spend / 100);
    var days = calcDaysRunning(ad);
    var running = isAdRunning(ad);

    html += '<div class="brand-detail-ad-row" onclick="openAdDetailModal(\'' + escHtml(ad.id || '') + '\')">';
    html += '<span class="brand-detail-rank">' + rank + '</span>';
    html += '<div class="brand-detail-ad-body">';
    html += '<div class="brand-detail-ad-text">' + escHtml(shortBody) + '</div>';
    html += '<div class="brand-detail-ad-badges">';
    if (spendEuro > 0) html += '<span style="background:rgba(22,163,74,0.12);color:var(--green);">€' + spendEuro.toLocaleString('de-DE') + '</span>';
    if (reach > 0) html += '<span style="background:rgba(8,145,178,0.12);color:var(--cyan);">' + reach.toLocaleString('de-DE') + ' Reach</span>';
    html += '<span style="background:rgba(0,0,0,0.05);color:var(--text-muted);">' + days + 'd</span>';
    if (running) {
      html += '<span style="background:rgba(22,163,74,0.12);color:var(--green);">● Laufend</span>';
    } else {
      html += '<span style="background:rgba(0,0,0,0.05);color:var(--text-muted);">⏹ Beendet</span>';
    }
    if (ad._variantCount && ad._variantCount > 1) {
      html += '<span style="background:rgba(139,92,246,0.12);color:#8b5cf6;">' + ad._variantCount + ' Var.</span>';
    }
    html += '</div>';
    html += '</div>';
    html += '</div>';
  });

  if (dedupedAds.length === 0) {
    html += '<div class="empty-state" style="padding:40px;"><div class="empty-state-icon">📭</div><div class="empty-state-title">Keine Ads im Zeitraum</div><div class="empty-state-desc">Für ' + escHtml(periodLabel) + ' wurden keine Ads gefunden.</div></div>';
  }

  container.innerHTML = html;

  // No donut chart needed anymore
  if (_brandDetailChart) { _brandDetailChart.destroy(); _brandDetailChart = null; }

  window.scrollTo(0, 0);
}

function closeBrandDetail() {
  _brandDetailPeriod = 0;
  _brandDetailCurrentBrand = null;
  document.getElementById('comp-sub-brand-detail').style.display = 'none';
  document.getElementById('comp-sub-overview').style.display = 'block';
  if (_brandDetailChart) { _brandDetailChart.destroy(); _brandDetailChart = null; }
}

// --- Standort Dropdown Population ---
function updateStandortDropdown() {
  var select = document.getElementById('comp-filter-standort');
  if (!select) return;
  var brandFilter = document.getElementById('comp-filter-brand').value;

  // Hide standort dropdown if no brand selected
  if (!brandFilter) {
    select.style.display = 'none';
    select.value = '';
    return;
  }

  // Count ads per page_name for this brand (use ads, not watchlist — watchlist has 1 entry per brand)
  var brandIds = getWatchlistIdsForBrand(brandFilter);
  var standortMap = {};
  competitorAds.forEach(function(a) {
    if (!a.page_name) return;
    if (brandIds.indexOf(a.watchlist_id) === -1) return;
    if (!standortMap[a.page_name]) standortMap[a.page_name] = { name: a.page_name, active: 0, total: 0 };
    standortMap[a.page_name].total++;
    if (isAdRunningByDate(a)) standortMap[a.page_name].active++;
  });

  // Also include page_names from watchlist entries even if they have 0 ads
  competitorWatchlist.forEach(function(w) {
    if ((w.brand || w.page_name) === brandFilter && !standortMap[w.page_name]) {
      standortMap[w.page_name] = { name: w.page_name, active: 0, total: 0 };
    }
  });

  // Hide if brand has only one unique page_name (no point showing standort)
  var uniquePageNames = Object.keys(standortMap);
  if (uniquePageNames.length < 2) {
    select.style.display = 'none';
    select.value = '';
    return;
  }

  // Show the dropdown
  select.style.display = '';

  var standorte = Object.values(standortMap);

  // Apply search filter to standort list
  var searchTerm = _compSearchTerm.toLowerCase();
  if (searchTerm) {
    standorte = standorte.filter(function(s) {
      return s.name.toLowerCase().indexOf(searchTerm) !== -1;
    });
  }

  // Sort by active desc
  standorte.sort(function(a, b) { return b.active - a.active; });

  var current = select.value;
  select.innerHTML = '<option value="">📍 Alle Standorte (' + standorte.length + ')</option>';
  standorte.forEach(function(s) {
    var opt = document.createElement('option');
    opt.value = s.name;
    opt.textContent = s.name + ' (' + s.active + ')';
    select.appendChild(opt);
  });
  // Restore selection if still valid
  if (current) {
    var exists = standorte.some(function(s) { return s.name === current; });
    if (exists) select.value = current;
    else select.value = '';
  }
}

// --- Search Input with Debounce ---
function onCompSearchInput() {
  clearTimeout(_compSearchDebounce);
  _compSearchDebounce = setTimeout(function() {
    _compSearchTerm = (document.getElementById('comp-search-input').value || '').trim();
    _adsDisplayed = _adsPageSize; // reset pagination
    updateStandortDropdown();
    applyCompetitorFilters();
  }, 300);
}

// --- Brand filter change ---
function onBrandFilterChange() {
  var brandVal = document.getElementById('comp-filter-brand').value;
  _selectedBrandForDrilldown = brandVal || null;
  _selectedStandort = null;
  document.getElementById('comp-filter-standort').value = '';
  _adsDisplayed = _adsPageSize;
  updateStandortDropdown();
  applyCompetitorFilters();
  updateCompetitorStats();
  renderBreadcrumbs();
  renderBrandOverviewCards();
}

// --- Standort filter change ---
function onStandortFilterChange() {
  var standortVal = document.getElementById('comp-filter-standort').value;
  _selectedStandort = standortVal || null;
  _adsDisplayed = _adsPageSize;
  applyCompetitorFilters();
  updateCompetitorStats();
  renderBreadcrumbs();
}

// --- Load More Ads ---
function loadMoreAds() {
  _adsDisplayed += _adsPageSize;
  renderPaginatedAds();
}

function renderPaginatedAds() {
  var gridEl = document.getElementById('comp-ads-grid');
  var emptyEl = document.getElementById('comp-ads-empty');
  var loadMoreContainer = document.getElementById('comp-load-more-container');
  var loadMoreBtn = document.getElementById('comp-load-more-btn');
  var countEl = document.getElementById('comp-ads-count');

  var total = _filteredAdsCache.length;
  var showing = Math.min(_adsDisplayed, total);

  if (total === 0) {
    emptyEl.style.display = 'block';
    gridEl.style.display = 'none';
    loadMoreContainer.style.display = 'none';
    return;
  }

  emptyEl.style.display = 'none';
  gridEl.style.display = 'grid';
  gridEl.innerHTML = _filteredAdsCache.slice(0, showing).map(renderAdCard).join('');

  // Load more / count
  loadMoreContainer.style.display = 'block';
  if (showing < total) {
    loadMoreBtn.style.display = 'inline-flex';
    countEl.textContent = showing + ' von ' + total + ' Ads angezeigt';
  } else {
    loadMoreBtn.style.display = 'none';
    countEl.textContent = 'Alle ' + total + ' Ads angezeigt ✅';
  }
}

function filterFeedByBrand(brandName) {
  _selectedStandort = null;
  _selectedBrandForDrilldown = brandName;
  // Switch to feed sub-tab
  showView('competitors', 'feed');
  setTimeout(function() {
    document.getElementById('comp-filter-brand').value = brandName;
    document.getElementById('comp-filter-standort').value = '';
    document.getElementById('comp-sort').value = 'newest';
    _adsDisplayed = _adsPageSize;
    updateStandortDropdown();
    applyCompetitorFilters();
    updateCompetitorStats();
    renderBreadcrumbs();
  }, 50);
}

function clearAllDrilldown() {
  _selectedStandort = null;
  _selectedBrandForDrilldown = null;
  _compSearchTerm = '';
  document.getElementById('comp-search-input').value = '';
  document.getElementById('comp-filter-brand').value = '';
  document.getElementById('comp-filter-standort').value = '';
  document.getElementById('comp-sort').value = 'newest';
  _adsDisplayed = _adsPageSize;
  updateStandortDropdown();
  applyCompetitorFilters();
  updateCompetitorStats();
  renderBreadcrumbs();
  renderBrandOverviewCards();
}

function renderBreadcrumbs() {
  var el = document.getElementById('comp-breadcrumb');
  if (!el) return;
  if (!_selectedBrandForDrilldown && !_selectedStandort) {
    el.classList.remove('visible');
    el.innerHTML = '';
    return;
  }
  el.classList.add('visible');
  var parts = [];
  parts.push('<span class="bc-item" onclick="clearAllDrilldown()">Alle</span>');

  if (_selectedBrandForDrilldown) {
    var brandLabel = _selectedBrandForDrilldown;
    if (_selectedStandort) {
      parts.push('<span class="bc-sep">→</span>');
      parts.push('<span class="bc-item" onclick="onBrandFilterChange()">' + escHtml(brandLabel) + '</span>');
      parts.push('<span class="bc-sep">→</span>');
      parts.push('<span class="bc-current">' + escHtml(_selectedStandort) + '</span>');
    } else {
      parts.push('<span class="bc-sep">→</span>');
      parts.push('<span class="bc-current">' + escHtml(brandLabel) + '</span>');
    }
  }
  el.innerHTML = parts.join(' ');
}

// --- Trends Section ---
function renderTrends() {
  var container = document.getElementById('comp-trends-content');
  if (competitorAds.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding:40px;"><div class="empty-state-desc">Keine Ads vorhanden</div></div>';
    return;
  }

  var now = new Date();
  var sevenDaysAgo = new Date(now.getTime() - 7 * 86400000);

  // 1. New ads in last 7 days
  var newAds = competitorAds.filter(function(a) {
    if (!a.ad_delivery_start_time) return false;
    return new Date(a.ad_delivery_start_time) >= sevenDaysAgo;
  }).sort(function(a, b) {
    return new Date(b.ad_delivery_start_time) - new Date(a.ad_delivery_start_time);
  });

  // 2. Longest runner (active)
  var activeAds = competitorAds.filter(function(a) { return isAdRunningByDate(a); });
  var longestRunner = null;
  var longestDays = 0;
  activeAds.forEach(function(a) {
    var d = calcDaysRunning(a);
    if (d > longestDays) { longestDays = d; longestRunner = a; }
  });

  var html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">';

  // New ads
  html += '<div class="card"><div class="card-body">' +
    '<div style="font-size:13px;font-weight:700;color:var(--text-muted);margin-bottom:8px;">🆕 Neue Ads (7 Tage)</div>' +
    '<div class="comp-trend-count">' + newAds.length + '</div>';
  if (newAds.length > 0) {
    html += '<ul class="comp-trend-list">';
    newAds.slice(0, 5).forEach(function(a) {
      var brand = a.page_name || '–';
      var date = new Date(a.ad_delivery_start_time).toLocaleDateString('de-DE', {day:'2-digit',month:'2-digit'});
      html += '<li><span style="color:var(--green);">●</span> ' + escHtml(brand) + ' <span style="color:var(--text-muted);font-size:11px;">(' + date + ')</span></li>';
    });
    html += '</ul>';
    if (newAds.length > 5) html += '<div class="comp-trend-sublabel">… und ' + (newAds.length - 5) + ' weitere</div>';
  }
  html += '</div></div>';

  // Longest runner
  html += '<div class="card"><div class="card-body">' +
    '<div style="font-size:13px;font-weight:700;color:var(--text-muted);margin-bottom:8px;">🏃 Längster Läufer</div>';
  if (longestRunner) {
    var lrBrand = longestRunner.page_name || '–';
    var lrBody = (longestRunner.ad_creative_bodies && longestRunner.ad_creative_bodies.length > 0) ? longestRunner.ad_creative_bodies[0] : '';
    if (lrBody.length > 80) lrBody = lrBody.substring(0, 80) + '…';
    var lrStart = longestRunner.ad_delivery_start_time ? new Date(longestRunner.ad_delivery_start_time).toLocaleDateString('de-DE', {day:'2-digit',month:'2-digit',year:'numeric'}) : '–';
    html += '<div class="comp-trend-count" style="color:var(--orange);">' + longestDays + ' <span style="font-size:14px;font-weight:500;">Tage</span></div>' +
      '<div style="font-weight:600;font-size:14px;margin-bottom:4px;">' + escHtml(lrBrand) + '</div>' +
      '<div style="font-size:12px;color:var(--text-secondary);line-height:1.5;">' + escHtml(lrBody) + '</div>' +
      '<div style="font-size:11px;color:var(--text-muted);margin-top:6px;">Seit ' + lrStart + '</div>';
  } else {
    html += '<div style="font-size:12px;color:var(--text-muted);">Keine aktiven Ads</div>';
  }
  html += '</div></div>';

  html += '</div>'; // close grid

  container.innerHTML = html;
}

// --- Competitor Intelligence Insights ---
function renderCompInsights() {
  var container = document.getElementById('comp-insights-content');
  if (!container) return;

  if (competitorAds.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding:40px;"><div class="empty-state-desc">Keine Ads vorhanden — erst Competitor-Daten synchronisieren.</div></div>';
    return;
  }

  var now = new Date();
  var html = '';

  // Build brand map from watchlist
  var brandMap = {};
  competitorWatchlist.forEach(function(w) {
    brandMap[w.id] = w.brand || w.page_name || '–';
  });

  // Helper: get brand name for an ad
  function getBrand(ad) {
    return brandMap[ad.watchlist_id] || ad.page_name || '–';
  }

  // Helper: get first ad body text
  function getBodyText(ad) {
    if (ad.ad_creative_bodies && ad.ad_creative_bodies.length > 0) return ad.ad_creative_bodies[0];
    return '';
  }

  // Helper: compute days running
  function daysRunning(ad) {
    if (!ad.ad_delivery_start_time) return 0;
    var start = new Date(ad.ad_delivery_start_time);
    var end = ad.ad_delivery_stop_time ? new Date(ad.ad_delivery_stop_time) : now;
    return Math.ceil((end - start) / 86400000);
  }

  // ============================================
  // Pre-compute all data for insights + sections
  // ============================================
  var adsWithDays = competitorAds.map(function(a) {
    return { ad: a, days: daysRunning(a), brand: getBrand(a) };
  }).filter(function(x) { return x.days > 0; });

  adsWithDays.sort(function(a, b) { return b.days - a.days; });

  // Pre-compute brand stats for Key Takeaways
  var _kBrandStats = {};
  competitorAds.forEach(function(a) {
    var brand = getBrand(a);
    if (!_kBrandStats[brand]) _kBrandStats[brand] = { active: 0, totalDays: 0, count: 0, longestDays: 0 };
    var d = daysRunning(a);
    _kBrandStats[brand].count++;
    _kBrandStats[brand].totalDays += d;
    _kBrandStats[brand].active++;
    if (d > _kBrandStats[brand].longestDays) _kBrandStats[brand].longestDays = d;
  });

  // Pre-compute copy patterns for Key Takeaways
  var _kWinning = adsWithDays.filter(function(x) { return x.days >= 30; });
  var _kWinTexts = _kWinning.map(function(x) { return getBodyText(x.ad); }).filter(function(t) { return t.length > 0; });
  var _kAllTexts = adsWithDays.map(function(x) { return { text: getBodyText(x.ad), days: x.days }; }).filter(function(x) { return x.text.length > 0; });

  // Pre-compute velocity for Key Takeaways
  var sevenDaysAgo = new Date(now.getTime() - 7 * 86400000);
  var thirtyDaysAgo = new Date(now.getTime() - 30 * 86400000);
  var _kVelocity = {};
  competitorAds.forEach(function(a) {
    var brand = getBrand(a);
    if (!_kVelocity[brand]) _kVelocity[brand] = { last7: 0, last30: 0 };
    if (a.ad_delivery_start_time) {
      var start = new Date(a.ad_delivery_start_time);
      if (start >= sevenDaysAgo) _kVelocity[brand].last7++;
      if (start >= thirtyDaysAgo) _kVelocity[brand].last30++;
    }
  });

  // ============================================
  // 1. 🔑 Key Takeaways (Auto-generated Insights)
  // ============================================
  var insights = [];
  var _kBrandNames = Object.keys(_kBrandStats);

  // Insight: Brand with most active ads vs brand with longest avg runtime
  if (_kBrandNames.length >= 2) {
    var mostActive = _kBrandNames.reduce(function(best, b) {
      return _kBrandStats[b].active > _kBrandStats[best].active ? b : best;
    }, _kBrandNames[0]);
    var longestAvg = _kBrandNames.reduce(function(best, b) {
      var avg = _kBrandStats[b].count > 0 ? _kBrandStats[b].totalDays / _kBrandStats[b].count : 0;
      var bestAvg = _kBrandStats[best].count > 0 ? _kBrandStats[best].totalDays / _kBrandStats[best].count : 0;
      return avg > bestAvg ? b : best;
    }, _kBrandNames[0]);
    var longestAvgDays = Math.round(_kBrandStats[longestAvg].totalDays / (_kBrandStats[longestAvg].count || 1));
    if (mostActive !== longestAvg) {
      insights.push('📊 <strong>' + escHtml(mostActive) + '</strong> hat die meisten aktiven Ads (' + _kBrandStats[mostActive].active + '), aber <strong>' + escHtml(longestAvg) + '</strong> die längste Ø Laufzeit (' + longestAvgDays + ' Tage).');
    } else {
      insights.push('📊 <strong>' + escHtml(mostActive) + '</strong> dominiert mit den meisten aktiven Ads (' + _kBrandStats[mostActive].active + ') und der längsten Ø Laufzeit (' + longestAvgDays + ' Tage).');
    }
  }

  // Insight: Copy patterns from winning ads
  if (_kWinTexts.length >= 3) {
    var winTotal = _kWinTexts.length;
    var winWithPrice = _kWinTexts.filter(function(t) { return /€|\d{3,}[\.,]?\d*|\bab\s+\d/.test(t); }).length;
    var pctPrice = Math.round((winWithPrice / winTotal) * 100);
    if (pctPrice >= 40) {
      insights.push('💰 <strong>' + pctPrice + '%</strong> der Ads mit 30+ Tagen Laufzeit enthalten eine Preisangabe oder konkrete Zahlen — Spezifik zahlt sich aus.');
    }
    var winWithQuestion = _kWinTexts.filter(function(t) { return /\?/.test(t); }).length;
    var pctQ = Math.round((winWithQuestion / winTotal) * 100);
    if (pctQ >= 30) {
      insights.push('❓ <strong>' + pctQ + '%</strong> der Top-Ads stellen eine Frage — Fragen triggern Engagement.');
    }
  }

  // Insight: Launch velocity outlier
  var velBrandNames = Object.keys(_kVelocity);
  if (velBrandNames.length >= 2) {
    var totalLast30 = velBrandNames.reduce(function(s, b) { return s + _kVelocity[b].last30; }, 0);
    var avgLast30 = totalLast30 / velBrandNames.length;
    var fastestLauncher = velBrandNames.reduce(function(best, b) {
      return _kVelocity[b].last30 > _kVelocity[best].last30 ? b : best;
    }, velBrandNames[0]);
    var fl30 = _kVelocity[fastestLauncher].last30;
    if (avgLast30 > 0 && fl30 > avgLast30 * 1.5 && fl30 >= 3) {
      var multiple = (fl30 / avgLast30).toFixed(1);
      insights.push('🚀 <strong>' + escHtml(fastestLauncher) + '</strong> launched ' + fl30 + ' neue Ads in 30 Tagen — <strong>' + multiple + 'x</strong> über dem Durchschnitt (' + Math.round(avgLast30) + ').');
    }
  }

  // Insight: Emoji vs no-emoji longevity comparison
  if (_kAllTexts.length >= 5) {
    var emojiRegex = /[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/u;
    var withEmoji = _kAllTexts.filter(function(x) { return emojiRegex.test(x.text); });
    var noEmoji = _kAllTexts.filter(function(x) { return !emojiRegex.test(x.text); });
    if (withEmoji.length >= 3 && noEmoji.length >= 3) {
      var avgEm = Math.round(withEmoji.reduce(function(s, x) { return s + x.days; }, 0) / withEmoji.length);
      var avgNo = Math.round(noEmoji.reduce(function(s, x) { return s + x.days; }, 0) / noEmoji.length);
      var diff = Math.abs(avgEm - avgNo);
      if (diff >= 3) {
        if (avgEm > avgNo) {
          insights.push('😀 Ads <strong>mit Emoji</strong> laufen im Schnitt <strong>' + diff + ' Tage länger</strong> (' + avgEm + ' vs. ' + avgNo + ' Tage).');
        } else {
          insights.push('✍️ Ads <strong>ohne Emoji</strong> laufen im Schnitt <strong>' + diff + ' Tage länger</strong> (' + avgNo + ' vs. ' + avgEm + ' Tage).');
        }
      }
    }
  }

  // Render Key Takeaways
  html += '<div class="card" style="margin-bottom:24px;border-left:4px solid var(--accent);">';
  html += '<div class="card-body">';
  html += '<h3 style="font-size:16px;font-weight:700;margin-bottom:12px;">🔑 Key Takeaways</h3>';
  html += '<p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Automatisch generierte Insights aus ' + competitorAds.length + ' Ads von ' + _kBrandNames.length + ' Brands.</p>';

  if (insights.length === 0) {
    html += '<div style="font-size:13px;color:var(--text-muted);">Noch nicht genug Daten für aussagekräftige Insights. Mehr Ads synchronisieren!</div>';
  } else {
    html += '<ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:12px;">';
    insights.forEach(function(insight) {
      html += '<li style="font-size:14px;line-height:1.6;padding:12px 16px;background:var(--bg-secondary);border-radius:var(--radius-sm);border:1px solid var(--border);">' + insight + '</li>';
    });
    html += '</ul>';
  }
  html += '</div></div>';

  // ============================================
  // 2. 🎨 Creative Mix by Brand
  // ============================================
  var brandStats = {};
  competitorAds.forEach(function(a) {
    var brand = getBrand(a);
    if (!brandStats[brand]) brandStats[brand] = { active: 0, totalDays: 0, count: 0, longestDays: 0, longestAd: null };
    var d = daysRunning(a);
    brandStats[brand].count++;
    brandStats[brand].totalDays += d;
    brandStats[brand].active++;
    if (d > brandStats[brand].longestDays) {
      brandStats[brand].longestDays = d;
      brandStats[brand].longestAd = a;
    }
  });

  var brandNames = Object.keys(brandStats).sort(function(a, b) {
    return brandStats[b].active - brandStats[a].active;
  });

  html += '<div class="card" style="margin-bottom:24px;">';
  html += '<div class="card-body">';
  html += '<h3 style="font-size:16px;font-weight:700;margin-bottom:12px;">🎨 Brand Performance Übersicht</h3>';
  html += '<p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Aktive Ads, Durchschnittslaufzeit und Top-Ad je Brand.</p>';

  if (brandNames.length === 0) {
    html += '<div style="font-size:13px;color:var(--text-muted);">Keine Brand-Daten vorhanden.</div>';
  } else {
    html += '<div style="overflow-x:auto;"><table class="comp-table" style="width:100%;">';
    html += '<thead><tr><th>Brand</th><th>Aktive Ads</th><th>Ø Laufzeit</th><th>Längste Ad</th></tr></thead><tbody>';
    brandNames.forEach(function(brand) {
      var s = brandStats[brand];
      var avgDays = s.count > 0 ? Math.round(s.totalDays / s.count) : 0;
      html += '<tr>';
      html += '<td style="font-weight:600;">' + escHtml(brand) + '</td>';
      html += '<td style="color:var(--green);font-weight:700;">' + s.active + '</td>';
      html += '<td style="font-weight:600;">' + avgDays + ' Tage</td>';
      html += '<td style="font-weight:700;color:var(--orange);">' + s.longestDays + ' Tage</td>';
      html += '</tr>';
    });
    html += '</tbody></table></div>';
  }
  html += '</div></div>';

  // ============================================
  // 3. 📝 Ad Copy Insights (Winning Copy)
  // ============================================
  var winningAds = adsWithDays.filter(function(x) { return x.days >= 30; });
  var winTexts = winningAds.map(function(x) { return getBodyText(x.ad); }).filter(function(t) { return t.length > 0; });

  html += '<div class="card" style="margin-bottom:24px;">';
  html += '<div class="card-body">';
  html += '<h3 style="font-size:16px;font-weight:700;margin-bottom:12px;">📝 Ad Copy Insights (Ads mit 30+ Tagen Laufzeit)</h3>';
  html += '<p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Muster in langlebigen Ads — was funktioniert in den erfolgreichsten Werbetexten.</p>';

  if (winTexts.length === 0) {
    html += '<div style="font-size:13px;color:var(--text-muted);">Noch keine Ads mit 30+ Tagen Laufzeit vorhanden.</div>';
  } else {
    // Analyze patterns
    var totalWin = winTexts.length;
    var avgLength = Math.round(winTexts.reduce(function(sum, t) { return sum + t.length; }, 0) / totalWin);
    var withPrice = winTexts.filter(function(t) { return /€|\d{3,}[\.,]?\d*|\bab\s+\d/.test(t); }).length;
    var withQuestion = winTexts.filter(function(t) { return /\?/.test(t); }).length;
    var withEmoji = winTexts.filter(function(t) { return /[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]/u.test(t); }).length;
    var withCTA = winTexts.filter(function(t) { return /jetzt|hier|mehr erfahren|kontakt|anfrag|termin|buchen|sichern|entdecken/i.test(t); }).length;

    var pctPrice = Math.round((withPrice / totalWin) * 100);
    var pctQuestion = Math.round((withQuestion / totalWin) * 100);
    var pctEmoji = Math.round((withEmoji / totalWin) * 100);
    var pctCTA = Math.round((withCTA / totalWin) * 100);

    html += '<div style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">Basis: <strong>' + totalWin + ' Ads</strong> mit 30+ Tagen Laufzeit</div>';
    html += '<div class="kpi-grid" style="grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));">';

    // Stat cards
    html += '<div class="kpi-card"><div class="kpi-label">Ø Textlänge</div><div class="kpi-value" style="color:var(--blue);">' + avgLength + '</div><div style="font-size:11px;color:var(--text-muted);">Zeichen</div></div>';
    html += '<div class="kpi-card"><div class="kpi-label">💰 Mit Preis/Zahl</div><div class="kpi-value" style="color:var(--green);">' + pctPrice + '%</div><div style="font-size:11px;color:var(--text-muted);">' + withPrice + ' von ' + totalWin + ' Ads</div></div>';
    html += '<div class="kpi-card"><div class="kpi-label">❓ Mit Frage</div><div class="kpi-value" style="color:var(--orange);">' + pctQuestion + '%</div><div style="font-size:11px;color:var(--text-muted);">' + withQuestion + ' von ' + totalWin + ' Ads</div></div>';
    html += '<div class="kpi-card"><div class="kpi-label">😀 Mit Emoji</div><div class="kpi-value" style="color:var(--cyan);">' + pctEmoji + '%</div><div style="font-size:11px;color:var(--text-muted);">' + withEmoji + ' von ' + totalWin + ' Ads</div></div>';
    html += '<div class="kpi-card"><div class="kpi-label">🎯 Mit CTA</div><div class="kpi-value" style="color:var(--accent);">' + pctCTA + '%</div><div style="font-size:11px;color:var(--text-muted);">' + withCTA + ' von ' + totalWin + ' Ads</div></div>';

    html += '</div>';
  }
  html += '</div></div>';

  // ============================================
  // 4. 📊 Launch Velocity
  // ============================================
  var sevenDaysAgo = new Date(now.getTime() - 7 * 86400000);
  var thirtyDaysAgo = new Date(now.getTime() - 30 * 86400000);

  var velocityMap = {};
  competitorAds.forEach(function(a) {
    var brand = getBrand(a);
    if (!velocityMap[brand]) velocityMap[brand] = { last7: 0, last30: 0, active: 0 };
    if (isAdRunningByDate(a)) velocityMap[brand].active++;
    if (a.ad_delivery_start_time) {
      var start = new Date(a.ad_delivery_start_time);
      if (start >= sevenDaysAgo) velocityMap[brand].last7++;
      if (start >= thirtyDaysAgo) velocityMap[brand].last30++;
    }
  });

  var velBrands = Object.keys(velocityMap).sort(function(a, b) {
    return velocityMap[b].last30 - velocityMap[a].last30;
  });

  html += '<div class="card" style="margin-bottom:24px;">';
  html += '<div class="card-body">';
  html += '<h3 style="font-size:16px;font-weight:700;margin-bottom:12px;">📊 Launch Velocity</h3>';
  html += '<p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">Wie viele neue Ads hat jede Brand in den letzten 7 und 30 Tagen gestartet?</p>';

  if (velBrands.length === 0) {
    html += '<div style="font-size:13px;color:var(--text-muted);">Keine Daten vorhanden.</div>';
  } else {
    html += '<div style="overflow-x:auto;"><table class="comp-table" style="width:100%;">';
    html += '<thead><tr><th>Brand</th><th>Letzte 7 Tage</th><th>Letzte 30 Tage</th><th>Aktive Ads</th></tr></thead><tbody>';
    velBrands.forEach(function(brand) {
      var v = velocityMap[brand];
      var heat7 = v.last7 >= 3 ? 'color:var(--accent);font-weight:800;' : (v.last7 > 0 ? 'color:var(--green);font-weight:700;' : 'color:var(--text-muted);');
      var heat30 = v.last30 >= 5 ? 'color:var(--accent);font-weight:800;' : (v.last30 > 0 ? 'color:var(--green);font-weight:700;' : 'color:var(--text-muted);');
      html += '<tr>';
      html += '<td style="font-weight:600;">' + escHtml(brand) + '</td>';
      html += '<td style="' + heat7 + '">' + v.last7 + (v.last7 >= 3 ? ' 🔥' : '') + '</td>';
      html += '<td style="' + heat30 + '">' + v.last30 + (v.last30 >= 5 ? ' 🔥' : '') + '</td>';
      html += '<td style="font-weight:600;">' + v.active + '</td>';
      html += '</tr>';
    });
    html += '</tbody></table></div>';
  }
  html += '</div></div>';

  // ============================================
  // 💰 Spend Analyse (only if spend data exists)
  // ============================================
  var dedupedForInsights = deduplicateAds(competitorAds);
  var adsWithSpend = dedupedForInsights.filter(function(a) { return getAdEffectiveSpend(a) > 0; });
  if (adsWithSpend.length > 0) {
    html += '<div class="card" style="margin-bottom:24px;border-left:4px solid #f59e0b;">';
    html += '<div class="card-body">';
    html += '<h3 style="font-size:16px;font-weight:700;margin-bottom:12px;">💰 Spend Analyse</h3>';
    html += '<p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;">AdSpend-Verteilung aus ' + adsWithSpend.length + ' Ads mit Spend-Daten.</p>';

    // Top spenders by account
    var spendByAccount = {};
    adsWithSpend.forEach(function(a) {
      var name = a.page_name || '–';
      if (!spendByAccount[name]) spendByAccount[name] = { spend: 0, count: 0 };
      spendByAccount[name].spend += getAdEffectiveSpend(a);
      spendByAccount[name].count++;
    });
    var topAccounts = Object.keys(spendByAccount).sort(function(a, b) { return spendByAccount[b].spend - spendByAccount[a].spend; }).slice(0, 5);

    html += '<h4 style="font-size:14px;font-weight:600;margin-bottom:8px;">🏢 Top Accounts nach Spend</h4>';
    html += '<div style="overflow-x:auto;margin-bottom:16px;"><table class="comp-table" style="width:100%;">';
    html += '<thead><tr><th>#</th><th>Account</th><th>Gesamt Spend</th><th>Ads</th><th>Ø Spend/Ad</th></tr></thead><tbody>';
    topAccounts.forEach(function(name, i) {
      var s = spendByAccount[name];
      var avgPerAd = Math.round(s.spend / s.count / 100);
      html += '<tr>';
      html += '<td>' + (i + 1) + '.</td>';
      html += '<td style="font-weight:600;">' + escHtml(name) + '</td>';
      html += '<td style="color:#f59e0b;font-weight:700;">€' + Math.round(s.spend / 100).toLocaleString('de-DE') + '</td>';
      html += '<td>' + s.count + '</td>';
      html += '<td>€' + avgPerAd.toLocaleString('de-DE') + '</td>';
      html += '</tr>';
    });
    html += '</tbody></table></div>';

    // Top 5 ads by spend
    var topAds = adsWithSpend.slice().sort(function(a, b) { return getAdEffectiveSpend(b) - getAdEffectiveSpend(a); }).slice(0, 5);
    html += '<h4 style="font-size:14px;font-weight:600;margin-bottom:8px;">🔝 Top 5 Ads nach Spend</h4>';
    html += '<div style="overflow-x:auto;"><table class="comp-table" style="width:100%;">';
    html += '<thead><tr><th>#</th><th>Account</th><th>Spend</th><th>Anzeigentext</th><th>Laufzeit</th></tr></thead><tbody>';
    topAds.forEach(function(ad, i) {
      var bodyText = (ad.ad_creative_bodies && ad.ad_creative_bodies.length > 0) ? ad.ad_creative_bodies[0] : '–';
      if (bodyText.length > 50) bodyText = bodyText.substring(0, 50) + '…';
      var days = calcDaysRunning(ad);
      html += '<tr>';
      html += '<td>' + (i + 1) + '.</td>';
      html += '<td style="font-weight:600;">' + escHtml(ad.page_name || '–') + '</td>';
      html += '<td style="color:#f59e0b;font-weight:700;">€' + Math.round(getAdEffectiveSpend(ad) / 100).toLocaleString('de-DE') + '</td>';
      html += '<td>' + escHtml(bodyText) + '</td>';
      html += '<td>' + days + ' Tage</td>';
      html += '</tr>';
    });
    html += '</tbody></table></div>';

    html += '</div></div>';
  }

  container.innerHTML = html;
}

// --- Meta Ad Library API (prepared) ---
async function fetchAdLibrary(searchPageIds, searchTerms, adType) {
  var token = localStorage.getItem('meta_ad_library_token');
  if (!token) throw new Error('Kein API Token konfiguriert');

  var params = new URLSearchParams();
  params.set('access_token', token);
  params.set('ad_reached_countries', '["DE"]');
  params.set('fields', 'id,ad_creative_bodies,ad_creative_link_titles,ad_creative_link_descriptions,ad_snapshot_url,page_name,page_id,ad_delivery_start_time,ad_delivery_stop_time,publisher_platforms');
  params.set('limit', '100');

  if (searchPageIds && searchPageIds.length > 0) {
    params.set('search_page_ids', JSON.stringify(searchPageIds));
  }
  if (searchTerms) {
    params.set('search_terms', searchTerms);
  }
  if (adType) {
    params.set('ad_type', adType);
  } else {
    params.set('ad_type', 'HOUSING_ADS');
  }

  var url = 'https://graph.facebook.com/v24.0/ads_archive?' + params.toString();
  var res = await fetch(url);
  if (!res.ok) {
    var errData = await res.json().catch(function() { return {}; });
    throw new Error((errData.error && errData.error.message) || 'API Fehler ' + res.status);
  }
  var data = await res.json();
  return data.data || [];
}

async function syncCompetitorAds() {
  var token = localStorage.getItem('meta_ad_library_token');
  if (!token) {
    showToast('Kein API Token konfiguriert', 'error');
    return;
  }

  var syncBtn = document.getElementById('comp-sync-btn');
  syncBtn.disabled = true;
  syncBtn.textContent = '⏳ Sync läuft...';

  try {
    var activeWatchlist = competitorWatchlist.filter(function(w) { return w.is_active; });
    var totalNew = 0;

    for (var i = 0; i < activeWatchlist.length; i++) {
      var w = activeWatchlist[i];
      var searchPageIds = w.page_id ? [w.page_id] : null;
      var searchTerms = !w.page_id ? w.page_name : null;

      try {
        var apiAds = await fetchAdLibrary(searchPageIds, searchTerms);
        var apiAdIds = apiAds.map(function(a) { return a.id; });

        // Get existing ads for this watchlist item
        var existingAds = competitorAds.filter(function(a) { return a.watchlist_id === w.id; });
        var existingAdIds = existingAds.map(function(a) { return a.ad_library_id; });

        // Find new ads
        var newAdsThisBrand = 0;
        for (var j = 0; j < apiAds.length; j++) {
          var apiAd = apiAds[j];
          if (existingAdIds.indexOf(apiAd.id) === -1) {
            // New ad — insert
            await sbInsert('competitor_ads', {
              watchlist_id: w.id,
              ad_library_id: apiAd.id,
              page_name: apiAd.page_name,
              page_id: apiAd.page_id,
              ad_creative_bodies: apiAd.ad_creative_bodies || [],
              ad_creative_link_titles: apiAd.ad_creative_link_titles || [],
              ad_creative_link_descriptions: apiAd.ad_creative_link_descriptions || [],
              ad_snapshot_url: apiAd.ad_snapshot_url,
              publisher_platforms: apiAd.publisher_platforms || [],
              ad_delivery_start_time: apiAd.ad_delivery_start_time || null,
              ad_delivery_stop_time: apiAd.ad_delivery_stop_time || null,
              ad_type: 'HOUSING_ADS',
              is_active: true
            });
            // Create alert with ad text snippet
            var adSnippet = (apiAd.ad_creative_bodies && apiAd.ad_creative_bodies[0]) ? apiAd.ad_creative_bodies[0].substring(0, 80) : '';
            await sbInsert('competitor_alerts', {
              watchlist_id: w.id,
              alert_type: 'new_ad',
              message: '🆕 Neue Ad von ' + (apiAd.page_name || w.page_name) + (adSnippet ? ': "' + adSnippet + '…"' : '')
            });
            totalNew++;
            newAdsThisBrand++;
          } else {
            // Existing ad — update last_seen_at
            var existing = existingAds.find(function(a) { return a.ad_library_id === apiAd.id; });
            if (existing) {
              await sbPatch('competitor_ads', existing.id, {
                last_seen_at: new Date().toISOString(),
                is_active: true,
                ad_delivery_stop_time: apiAd.ad_delivery_stop_time || null
              });
            }
          }
        }

        // Burst detection: 3+ new ads from one brand in one sync
        if (newAdsThisBrand >= 3) {
          await sbInsert('competitor_alerts', {
            watchlist_id: w.id,
            alert_type: 'burst',
            message: '📢 ' + (w.brand || w.page_name) + ' hat ' + newAdsThisBrand + ' neue Ads gestartet'
          });
        }

      } catch (apiErr) {
        console.error('Sync fehlgeschlagen für ' + w.page_name + ':', apiErr);
      }
    }

    showToast('Sync abgeschlossen: ' + totalNew + ' neue Ads', 'success');
    await Promise.all([loadCompetitorAds(), loadAlerts(), loadWatchlist()]);
  } catch (e) {
    console.error('Sync fehlgeschlagen:', e);
    showToast('Sync-Fehler: ' + e.message, 'error');
  } finally {
    syncBtn.disabled = !localStorage.getItem('meta_ad_library_token');
    syncBtn.textContent = '🔄 Sync Now';
  }
}

// --- Settings ---
function toggleCompetitorSettings() {
  var panel = document.getElementById('comp-settings-panel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

async function saveCompetitorToken() {
  var token = document.getElementById('comp-api-token').value.trim();
  if (token) {
    // Save to localStorage (session cache)
    localStorage.setItem('meta_ad_library_token', token);
    // Save to Supabase (persistent storage)
    const saved = await sbSetSetting('meta_api_token', token);
    if (saved) {
      showToast('API Token gespeichert (lokal + Cloud)', 'success');
    } else {
      showToast('API Token lokal gespeichert (Cloud-Sync fehlgeschlagen)', 'warning');
    }
  } else {
    showToast('Bitte Token eingeben', 'error');
    return;
  }
  updateSyncButton();
}

async function clearCompetitorToken() {
  localStorage.removeItem('meta_ad_library_token');
  document.getElementById('comp-api-token').value = '';
  // Also clear from Supabase
  await sbSetSetting('meta_api_token', '');
  showToast('API Token gelöscht', 'success');
  updateSyncButton();
}

function updateSyncButton() {
  var token = localStorage.getItem('meta_ad_library_token');
  var btn = document.getElementById('comp-sync-btn');
  btn.disabled = !token;

  var statusBanner = document.getElementById('comp-api-status-banner');
  if (token) {
    statusBanner.innerHTML = '<div class="setup-banner-icon">✅</div><div class="setup-banner-content"><h3>API Token konfiguriert</h3><p>Klicke "Sync Now" um Competitor-Ads zu laden.</p></div>';
    statusBanner.style.borderColor = 'rgba(34,197,94,0.3)';
    statusBanner.style.background = 'linear-gradient(135deg,rgba(34,197,94,0.08),rgba(6,182,212,0.05))';
  } else {
    statusBanner.innerHTML = '<div class="setup-banner-icon">⏳</div><div class="setup-banner-content"><h3>Ad Library API Verifizierung läuft</h3><p>Sobald freigeschaltet, werden hier automatisch Competitor-Ads geladen. Du kannst trotzdem schon Brands zur Watchlist hinzufügen.</p></div>';
    statusBanner.style.borderColor = 'rgba(245,158,11,0.3)';
    statusBanner.style.background = 'linear-gradient(135deg,rgba(245,158,11,0.08),rgba(6,182,212,0.05))';
  }
}

// --- Seed Watchlist ---
async function seedCompetitorWatchlist() {
  try {
    var existing = await sbGet('competitor_watchlist', 'select=id&limit=1');
    if (existing.length > 0) return; // Already has data

    var seeds = [
      { page_name: 'Engel & Völkers', brand: 'Engel & Völkers', notes: 'Internationales Maklernetzwerk' },
      { page_name: 'Von Poll Immobilien', brand: 'Von Poll', notes: 'Premium-Segment Makler' },
      { page_name: 'Dahler & Company', brand: 'Dahler', notes: 'Luxus-Immobilien' },
      { page_name: 'Grossmann & Berger', brand: 'Grossmann & Berger', notes: 'Hamburg & Norddeutschland' },
      { page_name: 'McMakler', brand: 'McMakler', notes: 'Hybrid-Makler / Digital' }
    ];

    for (var i = 0; i < seeds.length; i++) {
      await sbInsert('competitor_watchlist', seeds[i]);
    }
    showToast('Watchlist mit 5 Beispiel-Brands befüllt', 'success');
  } catch (e) {
    console.error('Seed fehlgeschlagen:', e);
  }
}

// ============================================
// META IMPORT / LIVE TRACKING
// ============================================
let _metaCampaigns = []; // raw campaigns from Meta API
let _metaStatusFilter = 'all';
let _metaLinkedIds = {}; // { meta_campaign_id: { campaign_id, property_name } }
let _metaLinkTarget = null; // the Meta campaign being linked

async function loadMetaCampaigns() {
  var loading = document.getElementById('meta-campaigns-loading');
  var empty = document.getElementById('meta-campaigns-empty');
  var list = document.getElementById('meta-campaigns-list');

  // Reset to step 1
  document.getElementById('meta-import-step-list').style.display = 'block';
  document.getElementById('meta-import-step-sync').style.display = 'none';
  document.getElementById('meta-import-step-success').style.display = 'none';
  document.getElementById('meta-link-modal-container').innerHTML = '';

  loading.style.display = 'flex';
  empty.style.display = 'none';
  list.style.display = 'none';

  var token = localStorage.getItem('meta_ad_library_token');
  if (!token) {
    loading.style.display = 'none';
    empty.style.display = 'block';
    empty.querySelector('.empty-state-desc').textContent = 'Kein Meta API Token gefunden. Bitte unter Competitor Watch → API Settings speichern.';
    return;
  }

  try {
    // Fetch campaigns from Meta API
    // Get selected ad account (default to R&G)
    var selectedAdAccount = document.getElementById('meta-ad-account-selector')?.value || 'act_850524294087986';
    var url = 'https://graph.facebook.com/v24.0/' + selectedAdAccount + '/campaigns?fields=name,status,objective,start_time,stop_time,daily_budget,lifetime_budget&limit=100&access_token=' + encodeURIComponent(token);
    var res = await fetch(url);
    if (!res.ok) {
      var errData = await res.json().catch(function() { return {}; });
      throw new Error((errData.error && errData.error.message) || 'API Fehler ' + res.status);
    }
    var data = await res.json();
    _metaCampaigns = data.data || [];

    // Load already-linked campaigns from our DB
    await loadLinkedCampaignIds();

    loading.style.display = 'none';

    if (_metaCampaigns.length === 0) {
      empty.style.display = 'block';
      empty.querySelector('.empty-state-desc').textContent = 'Keine Kampagnen im Ad Account gefunden.';
      return;
    }

    renderMetaCampaignList();

  } catch (e) {
    console.error('Meta campaigns load error:', e);
    loading.style.display = 'none';
    empty.style.display = 'block';
    empty.querySelector('.empty-state-desc').textContent = 'Fehler beim Laden: ' + (e.message || String(e));
  }
}

async function loadLinkedCampaignIds() {
  try {
    var linked = await sbGet('campaigns', 'select=id,meta_campaign_id,properties(name)&meta_campaign_id=not.is.null');
    _metaLinkedIds = {};
    (linked || []).forEach(function(c) {
      if (c.meta_campaign_id) {
        _metaLinkedIds[c.meta_campaign_id] = {
          campaign_id: c.id,
          property_name: c.properties ? c.properties.name : '—'
        };
      }
    });
  } catch (e) {
    console.error('Could not load linked campaigns:', e);
    _metaLinkedIds = {};
  }
}

function filterMetaCampaigns() {
  renderMetaCampaignList();
}

function setMetaStatusFilter(status) {
  _metaStatusFilter = status;
  document.querySelectorAll('.meta-filter-btn').forEach(function(btn) { btn.classList.remove('active'); });
  document.getElementById('meta-filter-' + (status === 'all' ? 'all' : status === 'ACTIVE' ? 'active' : 'paused')).classList.add('active');
  renderMetaCampaignList();
}

function renderMetaCampaignList() {
  var list = document.getElementById('meta-campaigns-list');
  var empty = document.getElementById('meta-campaigns-empty');
  var searchTerm = (document.getElementById('meta-search').value || '').toLowerCase().trim();

  var filtered = _metaCampaigns.filter(function(c) {
    if (_metaStatusFilter !== 'all' && c.status !== _metaStatusFilter) return false;
    if (searchTerm && (c.name || '').toLowerCase().indexOf(searchTerm) === -1) return false;
    return true;
  });

  if (filtered.length === 0) {
    list.style.display = 'none';
    empty.style.display = 'block';
    empty.querySelector('.empty-state-desc').textContent = 'Keine Kampagnen gefunden.';
    return;
  }

  empty.style.display = 'none';
  list.style.display = 'flex';

  list.innerHTML = filtered.map(function(c) {
    var isLinked = _metaLinkedIds[c.id];
    var statusCls = c.status === 'ACTIVE' ? 'badge-active' : c.status === 'PAUSED' ? 'badge-paused' : 'badge-completed';
    var statusLabel = c.status === 'ACTIVE' ? 'Aktiv' : c.status === 'PAUSED' ? 'Pausiert' : c.status || '—';
    var startDate = c.start_time ? new Date(c.start_time).toLocaleDateString('de-DE', {day:'2-digit',month:'2-digit',year:'numeric'}) : '—';
    var budget = '';
    if (c.daily_budget) budget = formatEur(parseInt(c.daily_budget) / 100) + '/Tag';
    else if (c.lifetime_budget) budget = formatEur(parseInt(c.lifetime_budget) / 100) + ' gesamt';
    else budget = '—';

    var actionBtn = '';
    if (isLinked) {
      actionBtn = '<span class="badge-live" style="margin-right:8px;">✅ Verknüpft · ' + escHtml(isLinked.property_name) + '</span>' +
        '<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();triggerLiveSync(\'' + escHtml(c.id) + '\',\'' + escHtml(isLinked.campaign_id) + '\')">🔄 Sync jetzt</button>';
    } else {
      actionBtn = '<button class="btn btn-primary btn-sm" onclick="event.stopPropagation();openLinkModal(\'' + escHtml(c.id) + '\')">📎 Verknüpfen</button>';
    }

    return '<div class="meta-campaign-row">' +
      '<div class="meta-camp-info">' +
        '<div class="meta-camp-name">' + escHtml(c.name) + '</div>' +
        '<div class="meta-camp-details">' +
          '<span class="badge ' + statusCls + '"><span class="badge-dot"></span>' + statusLabel + '</span>' +
          '<span>' + escHtml(c.objective || '—') + '</span>' +
          '<span>Start: ' + startDate + '</span>' +
          '<span>Budget: ' + budget + '</span>' +
        '</div>' +
      '</div>' +
      '<div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">' + actionBtn + '</div>' +
    '</div>';
  }).join('');
}

// ============================================
// LINK MODAL
// ============================================
async function openLinkModal(metaCampaignId) {
  var metaCamp = _metaCampaigns.find(function(c) { return c.id === metaCampaignId; });
  if (!metaCamp) return;
  _metaLinkTarget = metaCamp;

  // Load properties for the dropdown
  var properties = [];
  try {
    properties = await sbGet('properties', 'select=id,name,clients(name)&order=name');
  } catch (e) { /* empty list */ }

  // Load clients for the inline form
  var clientsData = [];
  try {
    clientsData = await sbGet('clients', 'select=*&order=name');
  } catch (e) { /* empty list */ }

  var clientOptions = clientsData.map(function(c) {
    return '<option value="' + c.id + '">' + escHtml(c.name) + (c.brand ? ' (' + escHtml(c.brand) + ')' : '') + '</option>';
  }).join('');

  var propOptions = properties.map(function(p) {
    var clientName = p.clients ? p.clients.name : '';
    return '<option value="' + p.id + '">' + escHtml(p.name) + (clientName ? ' (' + escHtml(clientName) + ')' : '') + '</option>';
  }).join('');

  var container = document.getElementById('meta-link-modal-container');
  container.innerHTML = '<div class="meta-link-modal-overlay" onclick="closeMetaLinkModal(event)">' +
    '<div class="meta-link-modal" onclick="event.stopPropagation()">' +
      '<h3>📎 Kampagne verknüpfen: ' + escHtml(metaCamp.name) + '</h3>' +

      '<div class="meta-link-section">' +
        '<div class="meta-link-section-title">Kampagnentyp</div>' +
        '<select class="form-select" id="meta-link-camp-type">' +
          '<option value="lead_gen">Lead-Gen</option>' +
          '<option value="verkaeufer">Verkäufer</option>' +
          '<option value="suchkunde">Suchkunde</option>' +
          '<option value="awareness">Awareness</option>' +
          '<option value="sonstige">Sonstige</option>' +
        '</select>' +
      '</div>' +

      '<div class="meta-link-section">' +
        '<div class="meta-link-section-title">A) Bestehendes Objekt wählen</div>' +
        '<select class="form-select" id="meta-link-existing-prop" onchange="toggleMetaNewProp()">' +
          '<option value="">— Neues Objekt erstellen (siehe unten) —</option>' +
          propOptions +
        '</select>' +
      '</div>' +

      '<div id="meta-link-new-prop-section">' +
        '<div class="meta-link-section">' +
          '<div class="meta-link-section-title">B) Neues Objekt erstellen</div>' +
          '<div class="form-grid">' +
            '<div class="form-group">' +
              '<label class="form-label">Kunde</label>' +
              '<select class="form-select" id="meta-link-client" onchange="toggleMetaNewClient()">' +
                '<option value="">— Neuen Kunden anlegen —</option>' +
                clientOptions +
              '</select>' +
            '</div>' +
            '<div class="form-group" id="meta-link-new-client-group">' +
              '<label class="form-label">Kundenname</label>' +
              '<input class="form-input" id="meta-link-client-name" placeholder="z.B. Von Poll">' +
            '</div>' +
            '<div class="form-group" id="meta-link-brand-group">' +
              '<label class="form-label">Brand</label>' +
              '<input class="form-input" id="meta-link-client-brand" placeholder="z.B. Von Poll">' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Objektname *</label>' +
              '<input class="form-input" id="meta-link-prop-name" required placeholder="z.B. Falkensteiner Ufer">' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Adresse</label>' +
              '<input class="form-input" id="meta-link-prop-address">' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">PLZ</label>' +
              '<input class="form-input" id="meta-link-prop-plz">' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Stadtteil</label>' +
              '<input class="form-input" id="meta-link-prop-stadtteil">' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Stadt</label>' +
              '<input class="form-input" id="meta-link-prop-city" oninput="autoFillCityRating(\'meta-link-prop-city\',\'meta-link-prop-rating\')">' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Standort-Rating</label>' +
              '<select class="form-select" id="meta-link-prop-rating">' +
                '<option value="">— Automatisch —</option>' +
                '<option value="A">A — Top-7-Stadt</option>' +
                '<option value="B">B — Großstadt</option>' +
                '<option value="C">C — Mittelstadt / Sonstige</option>' +
                '<option value="D">D — Ländlich</option>' +
              '</select>' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Mikrolage</label>' +
              '<select class="form-select" id="meta-link-prop-micro">' +
                '<option value="">— Keine Angabe —</option>' +
                '<option value="premium">Premium</option>' +
                '<option value="gut">Gut</option>' +
                '<option value="standard">Standard</option>' +
                '<option value="randlage">Randlage</option>' +
              '</select>' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Objektart</label>' +
              '<select class="form-select" id="meta-link-prop-type" onchange="toggleMetaNeubauFields()">' +
                '<option value="wohnung">Wohnung</option>' +
                '<option value="haus">Haus</option>' +
                '<option value="penthouse">Penthouse</option>' +
                '<option value="villa">Villa</option>' +
                '<option value="reihenhaus">Reihenhaus</option>' +
                '<option value="grundstueck">Grundstück</option>' +
                '<option value="gewerbe">Gewerbe</option>' +
                '<option value="neubauprojekt">Neubauprojekt</option>' +
                '<option value="zweifamilienhaus">Zweifamilienhaus</option><option value="doppelhaushaelfte">Doppelhaushälfte</option>' +
                '<option value="sonstige">Sonstige</option>' +
              '</select>' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Wohnfläche (qm)</label>' +
              '<input class="form-input" id="meta-link-prop-size" type="number" step="0.1">' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Grundstück (qm)</label>' +
              '<input class="form-input" id="meta-link-prop-plot" type="number" step="0.1">' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Zimmer</label>' +
              '<input class="form-input" id="meta-link-prop-rooms" type="number" step="0.5">' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Preis (€)</label>' +
              '<input class="form-input" id="meta-link-prop-price" type="number" step="1">' +
            '</div>' +
            '<div id="meta-link-neubau-fields" style="display:none;grid-column:1/-1;">' +
              '<div class="form-label" style="font-weight:600;margin-bottom:8px;">🏗️ Neubauprojekt-Details</div>' +
              '<div class="form-grid">' +
                '<div class="form-group"><label class="form-label">Preis von (€)</label><input class="form-input" id="meta-link-prop-price-from" type="number" step="1"></div>' +
                '<div class="form-group"><label class="form-label">Preis bis (€)</label><input class="form-input" id="meta-link-prop-price-to" type="number" step="1"></div>' +
                '<div class="form-group"><label class="form-label">Fläche von (qm)</label><input class="form-input" id="meta-link-prop-size-from" type="number" step="0.1"></div>' +
                '<div class="form-group"><label class="form-label">Fläche bis (qm)</label><input class="form-input" id="meta-link-prop-size-to" type="number" step="0.1"></div>' +
                '<div class="form-group"><label class="form-label">Einheiten</label><input class="form-input" id="meta-link-prop-num-units" type="number" step="1"></div>' +
              '</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
      '</div>' +

      '<div style="display:flex;gap:8px;justify-content:flex-end;padding-top:16px;border-top:1px solid var(--border);">' +
        '<button class="btn btn-secondary" onclick="closeMetaLinkModal()">Abbrechen</button>' +
        '<button class="btn btn-primary" onclick="linkCampaignToProperty()">📎 Verknüpfen & Sync starten</button>' +
      '</div>' +
    '</div>' +
  '</div>';
}

function closeMetaLinkModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('meta-link-modal-container').innerHTML = '';
  _metaLinkTarget = null;
}

function toggleMetaNewProp() {
  var existingProp = document.getElementById('meta-link-existing-prop').value;
  var newSection = document.getElementById('meta-link-new-prop-section');
  if (newSection) newSection.style.display = existingProp ? 'none' : 'block';
}

function toggleMetaNewClient() {
  var clientId = document.getElementById('meta-link-client').value;
  var nameGroup = document.getElementById('meta-link-new-client-group');
  var brandGroup = document.getElementById('meta-link-brand-group');
  if (nameGroup) nameGroup.style.display = clientId ? 'none' : 'flex';
  if (brandGroup) brandGroup.style.display = clientId ? 'none' : 'flex';
}

function toggleMetaNeubauFields() {
  var type = document.getElementById('meta-link-prop-type').value;
  var fields = document.getElementById('meta-link-neubau-fields');
  if (fields) fields.style.display = type === 'neubauprojekt' ? 'block' : 'none';
}

// ============================================
// LINK CAMPAIGN TO PROPERTY
// ============================================
async function linkCampaignToProperty() {
  if (!_metaLinkTarget) return;
  var metaCamp = _metaLinkTarget;

  try {
    var existingPropId = document.getElementById('meta-link-existing-prop').value;
    var propertyId = existingPropId;
    var isNewProperty = false;

    // If no existing property selected, create new one
    if (!propertyId) {
      var propName = document.getElementById('meta-link-prop-name').value.trim();
      if (!propName) {
        showToast('Bitte Objektname eingeben', 'error');
        return;
      }

      // Get or create client
      var clientId = document.getElementById('meta-link-client').value;
      if (!clientId) {
        var clientName = document.getElementById('meta-link-client-name').value.trim();
        var clientBrand = document.getElementById('meta-link-client-brand').value.trim();
        if (clientName) {
          var newClients = await sbInsert('clients', { name: clientName, brand: clientBrand || null });
          clientId = newClients[0].id;
        }
      }

      var propType = document.getElementById('meta-link-prop-type').value;
      var isNeubau = propType === 'neubauprojekt';
      var locationRating = document.getElementById('meta-link-prop-rating').value ||
        getCityRating(document.getElementById('meta-link-prop-city').value) || null;

      var propData = {
        client_id: clientId || null,
        name: propName,
        address: document.getElementById('meta-link-prop-address').value || null,
        plz: document.getElementById('meta-link-prop-plz').value || null,
        stadtteil: document.getElementById('meta-link-prop-stadtteil').value || null,
        city: document.getElementById('meta-link-prop-city').value || null,
        property_type: propType,
        size_sqm: parseFloat(document.getElementById('meta-link-prop-size').value) || null,
        plot_size: parseFloat(document.getElementById('meta-link-prop-plot').value) || null,
        rooms: parseFloat(document.getElementById('meta-link-prop-rooms').value) || null,
        price: parseFloat(document.getElementById('meta-link-prop-price').value) || null,
        location_rating: locationRating,
        micro_location: document.getElementById('meta-link-prop-micro').value || null,
        price_from: isNeubau ? (parseFloat(document.getElementById('meta-link-prop-price-from').value) || null) : null,
        price_to: isNeubau ? (parseFloat(document.getElementById('meta-link-prop-price-to').value) || null) : null,
        size_from: isNeubau ? (parseFloat(document.getElementById('meta-link-prop-size-from').value) || null) : null,
        size_to: isNeubau ? (parseFloat(document.getElementById('meta-link-prop-size-to').value) || null) : null,
        num_units: isNeubau ? (parseInt(document.getElementById('meta-link-prop-num-units').value) || null) : null
      };

      var newProps = await sbInsert('properties', propData);
      propertyId = newProps[0].id;
      isNewProperty = true;
    }

    // Save campaign type for later use in upgrade/create flow
    var campType = document.getElementById('meta-link-camp-type').value;

    // For existing properties, check if they already have campaigns
    if (!isNewProperty) {
      var existingCampaigns = await sbGet('campaigns', 'property_id=eq.' + propertyId + '&select=id,campaign_name,meta_campaign_id');

      if (existingCampaigns && existingCampaigns.length > 0) {
        // Check if any campaign already has THIS meta_campaign_id
        var alreadyLinked = existingCampaigns.find(function(c) { return c.meta_campaign_id === metaCamp.id; });
        if (alreadyLinked) {
          showToast('Diese Kampagne ist bereits verknüpft ✅', 'info');
          closeMetaLinkModal();
          return;
        }

        // Filter campaigns that can be upgraded (no meta_campaign_id yet)
        var upgradeable = existingCampaigns.filter(function(c) { return !c.meta_campaign_id; });

        if (upgradeable.length === 1) {
          // Single upgradeable campaign — show upgrade prompt
          showUpgradePrompt(upgradeable[0], metaCamp, propertyId, campType);
          return;
        } else if (upgradeable.length > 1) {
          // Multiple upgradeable — show selection
          showUpgradeSelection(upgradeable, metaCamp, propertyId, campType);
          return;
        }
        // If upgradeable.length === 0, all existing campaigns already have meta links
        // Fall through to create a new campaign
      }
    }

    // No existing campaigns or all already linked — create new campaign
    await createAndSyncNewCampaign(metaCamp, propertyId, campType);

  } catch (e) {
    console.error('Link campaign error:', e);
    showToast('Fehler: ' + (e.message || 'Unbekannter Fehler'), 'error');
  }
}

// ============================================
// UPGRADE PROMPT — Single existing campaign
// ============================================
function showUpgradePrompt(existingCampaign, metaCamp, propertyId, campType) {
  var container = document.getElementById('meta-link-modal-container');
  container.innerHTML = '<div class="meta-link-modal-overlay" onclick="closeMetaLinkModal(event)">' +
    '<div class="meta-link-modal" onclick="event.stopPropagation()">' +
      '<h3>📎 Bestehende Kampagne gefunden</h3>' +
      '<div style="padding:16px 0;">' +
        '<p style="margin:0 0 12px 0;">Dieses Objekt hat bereits eine Kampagne:</p>' +
        '<div style="background:var(--bg-secondary);padding:12px 16px;border-radius:8px;border:1px solid var(--border);margin-bottom:16px;">' +
          '<strong>' + escHtml(existingCampaign.campaign_name) + '</strong>' +
          '<div style="font-size:12px;color:var(--text-muted);margin-top:4px;">ID: ' + existingCampaign.id.substring(0, 8) + '… · Noch kein Live-Tracking</div>' +
        '</div>' +
        '<p style="margin:0 0 8px 0;">Bestehende Kampagne mit Live-Tracking verbinden?</p>' +
        '<p style="margin:0;font-size:12px;color:var(--text-muted);">Die Meta-Daten werden in die bestehende Kampagne synchronisiert.</p>' +
      '</div>' +
      '<div style="display:flex;gap:8px;justify-content:flex-end;padding-top:16px;border-top:1px solid var(--border);">' +
        '<button class="btn btn-secondary" onclick="closeMetaLinkModal()">Abbrechen</button>' +
        '<button class="btn btn-secondary" onclick="confirmCreateNewCampaign()">Neue Kampagne erstellen</button>' +
        '<button class="btn btn-primary" onclick="confirmUpgradeCampaign(\'' + existingCampaign.id + '\')">✅ Bestehende verbinden</button>' +
      '</div>' +
    '</div>' +
  '</div>';

  // Store context for the confirm handlers
  window._upgradeContext = { metaCamp: metaCamp, propertyId: propertyId, campType: campType };
}

// ============================================
// UPGRADE SELECTION — Multiple existing campaigns
// ============================================
function showUpgradeSelection(upgradeable, metaCamp, propertyId, campType) {
  var radioItems = upgradeable.map(function(c, idx) {
    return '<label style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;border:1px solid var(--border);cursor:pointer;background:var(--bg-secondary);">' +
      '<input type="radio" name="upgrade-campaign" value="' + c.id + '"' + (idx === 0 ? ' checked' : '') + ' style="margin:0;">' +
      '<div>' +
        '<strong>' + escHtml(c.campaign_name) + '</strong>' +
        '<div style="font-size:12px;color:var(--text-muted);">ID: ' + c.id.substring(0, 8) + '…</div>' +
      '</div>' +
    '</label>';
  }).join('');

  var container = document.getElementById('meta-link-modal-container');
  container.innerHTML = '<div class="meta-link-modal-overlay" onclick="closeMetaLinkModal(event)">' +
    '<div class="meta-link-modal" onclick="event.stopPropagation()">' +
      '<h3>📎 Mehrere Kampagnen gefunden</h3>' +
      '<div style="padding:16px 0;">' +
        '<p style="margin:0 0 12px 0;">Welche Kampagne soll mit Live-Tracking verbunden werden?</p>' +
        '<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">' +
          radioItems +
        '</div>' +
        '<p style="margin:0;font-size:12px;color:var(--text-muted);">Die Meta-Daten werden in die gewählte Kampagne synchronisiert.</p>' +
      '</div>' +
      '<div style="display:flex;gap:8px;justify-content:flex-end;padding-top:16px;border-top:1px solid var(--border);">' +
        '<button class="btn btn-secondary" onclick="closeMetaLinkModal()">Abbrechen</button>' +
        '<button class="btn btn-secondary" onclick="confirmCreateNewCampaign()">Neue Kampagne erstellen</button>' +
        '<button class="btn btn-primary" onclick="confirmUpgradeSelected()">✅ Verbinden</button>' +
      '</div>' +
    '</div>' +
  '</div>';

  // Store context for the confirm handlers
  window._upgradeContext = { metaCamp: metaCamp, propertyId: propertyId, campType: campType };
}

// ============================================
// CONFIRM UPGRADE — Patch existing campaign
// ============================================
async function confirmUpgradeCampaign(campaignId) {
  var ctx = window._upgradeContext;
  if (!ctx) return;

  try {
    var metaCamp = ctx.metaCamp;

    // Get selected ad account
    var selectedAdAccount = document.getElementById('meta-ad-account-selector')?.value || 'act_850524294087986';
    var adAccountNames = {
      'act_850524294087986': 'R&G',
      'act_763575219714223': 'E&V'
    };

    // Update the existing campaign with meta_campaign_id and is_live
    await sbPatch('campaigns', campaignId, {
      meta_campaign_id: metaCamp.id,
      is_live: true,
      platform: 'meta',
      status: metaCamp.status === 'ACTIVE' ? 'active' : metaCamp.status === 'PAUSED' ? 'paused' : 'completed',
      ad_account_id: selectedAdAccount,
      ad_account_name: adAccountNames[selectedAdAccount] || 'Unknown'
    });

    // Close modal and sync insights into the existing campaign
    document.getElementById('meta-link-modal-container').innerHTML = '';
    window._upgradeContext = null;

    showToast('Kampagne mit Live-Tracking verbunden ✅', 'success');
    await syncCampaignInsights(metaCamp.id, campaignId, metaCamp.name);

  } catch (e) {
    console.error('Upgrade campaign error:', e);
    showToast('Fehler: ' + (e.message || 'Unbekannter Fehler'), 'error');
  }
}

// ============================================
// CONFIRM UPGRADE — From radio selection
// ============================================
async function confirmUpgradeSelected() {
  var selected = document.querySelector('input[name="upgrade-campaign"]:checked');
  if (!selected) {
    showToast('Bitte eine Kampagne auswählen', 'error');
    return;
  }
  await confirmUpgradeCampaign(selected.value);
}

// ============================================
// CONFIRM CREATE NEW — Skip upgrade, create fresh
// ============================================
async function confirmCreateNewCampaign() {
  var ctx = window._upgradeContext;
  if (!ctx) return;

  try {
    await createAndSyncNewCampaign(ctx.metaCamp, ctx.propertyId, ctx.campType);
    window._upgradeContext = null;
  } catch (e) {
    console.error('Create campaign error:', e);
    showToast('Fehler: ' + (e.message || 'Unbekannter Fehler'), 'error');
  }
}

// ============================================
// CREATE & SYNC NEW CAMPAIGN
// ============================================
async function createAndSyncNewCampaign(metaCamp, propertyId, campType) {
  var metaStatus = metaCamp.status === 'ACTIVE' ? 'active' : metaCamp.status === 'PAUSED' ? 'paused' : 'completed';
  var startDate = metaCamp.start_time ? metaCamp.start_time.substring(0, 10) : null;

  // Get selected ad account
  var selectedAdAccount = document.getElementById('meta-ad-account-selector')?.value || 'act_850524294087986';
  var adAccountNames = {
    'act_850524294087986': 'R&G',
    'act_763575219714223': 'E&V'
  };

  var campData = {
    property_id: propertyId,
    platform: 'meta',
    campaign_name: metaCamp.name,
    campaign_type: campType,
    start_date: startDate,
    status: metaStatus,
    meta_campaign_id: metaCamp.id,
    is_live: true,
    ad_account_id: selectedAdAccount,
    ad_account_name: adAccountNames[selectedAdAccount] || 'Unknown'
  };

  var newCamps = await sbInsert('campaigns', campData);
  var campaignId = newCamps[0].id;

  // Close modal and show sync progress
  document.getElementById('meta-link-modal-container').innerHTML = '';

  // Trigger initial sync
  await syncCampaignInsights(metaCamp.id, campaignId, metaCamp.name);
}

// ============================================
// SYNC CAMPAIGN INSIGHTS
// ============================================
async function syncCampaignInsights(metaCampaignId, campaignId, campaignName) {
  var token = localStorage.getItem('meta_ad_library_token');
  if (!token) {
    showToast('Kein Meta API Token', 'error');
    return;
  }

  // Show sync progress
  document.getElementById('meta-import-step-list').style.display = 'none';
  document.getElementById('meta-import-step-sync').style.display = 'block';
  document.getElementById('meta-import-step-success').style.display = 'none';

  var stepEl = document.getElementById('meta-sync-step');
  var barEl = document.getElementById('meta-sync-bar');
  var detailEl = document.getElementById('meta-sync-detail');

  var totalDays = 0;
  var totalLeads = 0;
  var totalSpend = 0;

  try {
    // Step 1: Fetch campaign insights
    stepEl.textContent = 'Syncing ' + campaignName + '...';
    barEl.style.width = '10%';
    detailEl.textContent = 'Lade Tagesmetriken...';

    var insightsUrl = 'https://graph.facebook.com/v24.0/' + metaCampaignId + '/insights?fields=spend,impressions,reach,actions,cost_per_action_type&time_increment=1&date_preset=maximum&limit=500&access_token=' + encodeURIComponent(token);
    var allInsights = [];
    var nextUrl = insightsUrl;

    while (nextUrl) {
      var res = await fetch(nextUrl);
      if (!res.ok) {
        var errData = await res.json().catch(function() { return {}; });
        throw new Error((errData.error && errData.error.message) || 'API Fehler ' + res.status);
      }
      var data = await res.json();
      if (data.data) allInsights = allInsights.concat(data.data);
      nextUrl = (data.paging && data.paging.next) ? data.paging.next : null;
    }

    barEl.style.width = '30%';
    detailEl.textContent = allInsights.length + ' Tage gefunden';

    // Step 2: Parse and insert campaign daily metrics
    if (allInsights.length > 0) {
      var metricsRows = allInsights.map(function(row) {
        var spend = parseFloat(row.spend) || 0;
        var impressions = parseInt(row.impressions) || 0;
        var reach = parseInt(row.reach) || 0;
        var clicks = 0;
        var leads = 0;
        if (row.actions && Array.isArray(row.actions)) {
          row.actions.forEach(function(a) {
            if (a.action_type === 'link_click') clicks = parseInt(a.value) || 0;
            if (a.action_type === 'lead') leads = parseInt(a.value) || 0;
          });
        }
        totalLeads += leads;
        totalSpend += spend;
        return {
          campaign_id: campaignId,
          date: row.date_start,
          spend: Math.round(spend * 100) / 100,
          impressions: impressions,
          reach: reach,
          clicks: clicks || null,
          leads: leads
          // NO cpl, cpm, ctr — GENERATED ALWAYS
        };
      });
      totalDays = metricsRows.length;

      // Upsert with merge-duplicates
      for (var i = 0; i < metricsRows.length; i += 50) {
        var batch = metricsRows.slice(i, i + 50);
        var pct = 30 + Math.round((i / metricsRows.length) * 20);
        barEl.style.width = pct + '%';
        detailEl.textContent = 'Speichere Tagesmetriken... ' + Math.min(i + 50, metricsRows.length) + '/' + metricsRows.length;

        var upsertRes = await fetch(SB_URL + '/rest/v1/campaign_daily_metrics', {
          method: 'POST',
          headers: { ...SB_HEADERS, 'Prefer': 'resolution=merge-duplicates,return=representation' },
          body: JSON.stringify(batch)
        });
        if (!upsertRes.ok) {
          var errMsg = await upsertRes.text();
          console.error('Upsert error:', errMsg);
        }
      }
    }

    barEl.style.width = '50%';
    stepEl.textContent = 'Lade Ads & Creatives...';

    // Step 3: Fetch ads
    var adsUrl = 'https://graph.facebook.com/v24.0/' + metaCampaignId + '/ads?fields=name,status&limit=100&access_token=' + encodeURIComponent(token);
    var adsRes = await fetch(adsUrl);
    var adsData = adsRes.ok ? await adsRes.json() : { data: [] };
    var ads = adsData.data || [];

    barEl.style.width = '60%';
    detailEl.textContent = ads.length + ' Ads gefunden';

    // Step 4: Create creatives and fetch ad-level insights
    for (var a = 0; a < ads.length; a++) {
      var ad = ads[a];
      var adName = ad.name || 'Ad ' + ad.id;
      var creativeType = inferMetaCreativeType(adName);

      detailEl.textContent = 'Synce "' + adName + '"... (' + (a + 1) + '/' + ads.length + ')';

      // Upsert creative
      var crRes = await fetch(SB_URL + '/rest/v1/creatives', {
        method: 'POST',
        headers: { ...SB_HEADERS, 'Prefer': 'resolution=merge-duplicates,return=representation' },
        body: JSON.stringify([{
          campaign_id: campaignId,
          creative_name: adName,
          creative_type: creativeType,
          meta_ad_id: ad.id
        }])
      });
      var crData = crRes.ok ? await crRes.json() : [];
      if (crData.length === 0) continue;
      var creativeId = crData[0].id;

      // Fetch ad-level insights
      try {
        var adInsightsUrl = 'https://graph.facebook.com/v24.0/' + ad.id + '/insights?fields=spend,impressions,reach,actions&time_increment=1&date_preset=maximum&limit=500&access_token=' + encodeURIComponent(token);
        var adAllInsights = [];
        var adNextUrl = adInsightsUrl;

        while (adNextUrl) {
          var adIRes = await fetch(adNextUrl);
          if (!adIRes.ok) break;
          var adIData = await adIRes.json();
          if (adIData.data) adAllInsights = adAllInsights.concat(adIData.data);
          adNextUrl = (adIData.paging && adIData.paging.next) ? adIData.paging.next : null;
        }

        if (adAllInsights.length > 0) {
          var crMetrics = adAllInsights.map(function(row) {
            var spend = parseFloat(row.spend) || 0;
            var impressions = parseInt(row.impressions) || 0;
            var reach = parseInt(row.reach) || 0;
            var clicks = 0;
            var leads = 0;
            if (row.actions && Array.isArray(row.actions)) {
              row.actions.forEach(function(act) {
                if (act.action_type === 'link_click') clicks = parseInt(act.value) || 0;
                if (act.action_type === 'lead') leads = parseInt(act.value) || 0;
              });
            }
            return {
              creative_id: creativeId,
              date: row.date_start,
              spend: Math.round(spend * 100) / 100,
              impressions: impressions,
              reach: reach,
              clicks: clicks || null,
              leads: leads
              // NO cpl, cpm — GENERATED ALWAYS
            };
          });

          // Upsert
          for (var ci = 0; ci < crMetrics.length; ci += 50) {
            var crBatch = crMetrics.slice(ci, ci + 50);
            await fetch(SB_URL + '/rest/v1/creative_daily_metrics', {
              method: 'POST',
              headers: { ...SB_HEADERS, 'Prefer': 'resolution=merge-duplicates,return=representation' },
              body: JSON.stringify(crBatch)
            });
          }
        }
      } catch (adErr) {
        console.warn('Ad insights error for ' + adName + ':', adErr);
      }

      var adPct = 60 + Math.round(((a + 1) / ads.length) * 35);
      barEl.style.width = adPct + '%';
    }

    barEl.style.width = '100%';
    stepEl.textContent = 'Syncing ' + campaignName + '... ' + totalDays + '/' + totalDays + ' Tage ✅';

    // Show success after a short delay
    setTimeout(function() {
      showMetaSyncSuccess(campaignId, campaignName, totalDays, totalLeads, totalSpend);
    }, 800);

  } catch (e) {
    console.error('Sync error:', e);
    stepEl.textContent = '❌ Fehler beim Sync';
    detailEl.textContent = e.message || 'Unbekannter Fehler';
    showToast('Sync-Fehler: ' + (e.message || 'Unbekannter Fehler'), 'error');
  }
}

function inferMetaCreativeType(adName) {
  if (!adName) return 'video';
  var lower = adName.toLowerCase();
  if (lower.includes('single image')) return 'single_image';
  if (lower.includes('carousel')) return 'carousel';
  if (lower.includes('th-reel') || lower.includes('th reel')) return 'th_reel';
  if (lower.includes('scn-reel') || lower.includes('scn reel')) return 'scn_reel';
  if (lower.includes('reel')) return 'video';
  if (lower.includes('video')) return 'video';
  if (lower.includes('story')) return 'story';
  return 'video';
}

function showMetaSyncSuccess(campaignId, campaignName, days, leads, spend) {
  document.getElementById('meta-import-step-sync').style.display = 'none';
  document.getElementById('meta-import-step-success').style.display = 'block';

  document.getElementById('meta-success-title').textContent = '✅ Kampagne verknüpft!';
  document.getElementById('meta-success-stats').textContent =
    days + ' Tage, ' + leads + ' Leads, ' + formatEur(spend) + ' Spend importiert';
  document.getElementById('meta-success-open-btn').setAttribute('onclick',
    "openCampaign('" + campaignId + "')");
}

function resetMetaImport() {
  _metaLinkTarget = null;
  document.getElementById('meta-import-step-list').style.display = 'block';
  document.getElementById('meta-import-step-sync').style.display = 'none';
  document.getElementById('meta-import-step-success').style.display = 'none';
  document.getElementById('meta-link-modal-container').innerHTML = '';
  // Refresh list
  loadMetaCampaigns();
}

// Trigger sync for already-linked campaign
async function triggerLiveSync(metaCampaignId, campaignId) {
  var metaCamp = _metaCampaigns.find(function(c) { return c.id === metaCampaignId; });
  var name = metaCamp ? metaCamp.name : 'Kampagne';
  await syncCampaignInsights(metaCampaignId, campaignId, name);
}

// Sync current campaign from detail view
var _currentCampaignMeta = null; // {id, meta_campaign_id, name}
async function syncCurrentCampaign() {
  if (!_currentCampaignMeta || !_currentCampaignMeta.meta_campaign_id) {
    showToast('Keine Meta-Kampagne verknüpft', 'error');
    return;
  }
  var btn = document.getElementById('detail-sync-btn');
  if (btn) {
    btn.disabled = true;
    btn.textContent = '⏳ Syncing...';
  }
  try {
    await syncCampaignInsights(
      _currentCampaignMeta.meta_campaign_id,
      _currentCampaignMeta.id,
      _currentCampaignMeta.name
    );
    showToast('✅ Sync abgeschlossen', 'success');
    // Refresh the campaign view
    await openCampaign(_currentCampaignMeta.id);
  } catch (e) {
    showToast('Sync-Fehler: ' + e.message, 'error');
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = '🔄 Sync Now';
    }
  }
}

// Sync all live campaigns
async function syncAllLiveCampaigns() {
  var btn = document.getElementById('sync-all-live-btn');
  var homeBtn = document.getElementById('home-sync-all-btn');
  var allBtns = [btn, homeBtn].filter(Boolean);
  allBtns.forEach(function(b) {
    b.disabled = true;
    b.textContent = '⏳ Syncing...';
  });
  try {
    // Fetch all live campaigns with meta_campaign_id
    var liveCampaigns = await sbGet('campaigns', 'select=id,campaign_name,meta_campaign_id&is_live=eq.true&meta_campaign_id=not.is.null');
    if (liveCampaigns.length === 0) {
      showToast('Keine Live-Kampagnen gefunden', 'info');
      return;
    }
    showToast('Synce ' + liveCampaigns.length + ' Kampagnen...', 'info');
    var synced = 0;
    for (var i = 0; i < liveCampaigns.length; i++) {
      var c = liveCampaigns[i];
      allBtns.forEach(function(b) { b.textContent = '⏳ ' + (i + 1) + '/' + liveCampaigns.length; });
      try {
        await syncCampaignInsights(c.meta_campaign_id, c.id, c.campaign_name);
        synced++;
      } catch (e) {
        console.warn('Sync error for ' + c.campaign_name + ':', e);
      }
      // Small delay between campaigns
      await new Promise(function(r) { setTimeout(r, 1000); });
    }
    showToast('✅ ' + synced + ' Kampagnen synchronisiert', 'success');
    // Refresh home stats and campaign list
    await loadHomeStats();
    await loadCampaigns();
  } catch (e) {
    showToast('Sync-Fehler: ' + e.message, 'error');
  } finally {
    allBtns.forEach(function(b) {
      b.disabled = false;
      b.textContent = '🔄 Refresh All';
    });
  }
}

// ============================================
// INIT
// ============================================
// EXPOSÉS MANAGEMENT
// ============================================
let _exposeSelectedFile = null;
let _exposePollingTimer = null;

function renderMarkdown(md) {
  if (!md) return '';
  let html = md;
  // Escape HTML
  html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  // Headers
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  // Bold + Italic
  html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  // Pipe tables
  html = html.replace(/((?:\|.+\|\n?)+)/g, function(tableBlock) {
    const rows = tableBlock.trim().split('\n').filter(r => r.trim());
    if (rows.length < 2) return tableBlock;
    // Check if second row is separator
    const isSep = /^\|[\s\-:|]+\|$/.test(rows[1].trim());
    let out = '<table>';
    rows.forEach((row, i) => {
      if (isSep && i === 1) return; // skip separator
      const cells = row.split('|').filter((c, ci, arr) => ci > 0 && ci < arr.length - 1);
      const tag = (isSep && i === 0) ? 'th' : 'td';
      out += '<tr>' + cells.map(c => `<${tag}>${c.trim()}</${tag}>`).join('') + '</tr>';
    });
    out += '</table>';
    return out;
  });
  // Unordered lists
  html = html.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
  html = html.replace(/((?:<li>.+<\/li>\n?)+)/g, '<ul>$1</ul>');
  // Paragraphs: double newline
  html = html.replace(/\n\n+/g, '</p><p>');
  // Line breaks
  html = html.replace(/\n/g, '<br>');
  html = '<p>' + html + '</p>';
  // Clean up empty paragraphs
  html = html.replace(/<p>\s*<\/p>/g, '');
  // Clean up p wrapping block elements
  html = html.replace(/<p>(<h[1-3]>)/g, '$1');
  html = html.replace(/(<\/h[1-3]>)<\/p>/g, '$1');
  html = html.replace(/<p>(<table>)/g, '$1');
  html = html.replace(/(<\/table>)<\/p>/g, '$1');
  html = html.replace(/<p>(<ul>)/g, '$1');
  html = html.replace(/(<\/ul>)<\/p>/g, '$1');
  return html;
}

function openExposeUploadModal() {
  _exposeSelectedFile = null;
  document.getElementById('expose-file-name').textContent = '';
  document.getElementById('expose-client-select').value = '';
  document.getElementById('expose-upload-status').textContent = '';
  document.getElementById('expose-upload-btn').disabled = true;
  document.getElementById('expose-upload-modal').classList.add('visible');
}

function closeExposeUploadModal() {
  document.getElementById('expose-upload-modal').classList.remove('visible');
  _exposeSelectedFile = null;
}

function handleExposeDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('dragover');
  const files = e.dataTransfer.files;
  if (files.length && files[0].type === 'application/pdf') {
    _exposeSelectedFile = files[0];
    document.getElementById('expose-file-name').textContent = files[0].name;
    updateExposeUploadBtn();
  } else {
    document.getElementById('expose-upload-status').textContent = '⚠️ Bitte nur PDF-Dateien hochladen.';
  }
}

function handleExposeFileSelect(e) {
  const file = e.target.files[0];
  if (file && file.type === 'application/pdf') {
    _exposeSelectedFile = file;
    document.getElementById('expose-file-name').textContent = file.name;
    updateExposeUploadBtn();
  }
}

function updateExposeUploadBtn() {
  const client = document.getElementById('expose-client-select').value;
  document.getElementById('expose-upload-btn').disabled = !(_exposeSelectedFile && client);
}

// Attach change listener to client select
document.addEventListener('DOMContentLoaded', () => {
  const sel = document.getElementById('expose-client-select');
  if (sel) sel.addEventListener('change', updateExposeUploadBtn);
});

async function doExposeUpload() {
  const file = _exposeSelectedFile;
  const client = document.getElementById('expose-client-select').value;
  if (!file || !client) return;

  const statusEl = document.getElementById('expose-upload-status');
  const uploadBtn = document.getElementById('expose-upload-btn');
  uploadBtn.disabled = true;
  statusEl.textContent = '⏳ Wird hochgeladen...';

  try {
    // 1. Upload PDF to Supabase Storage
    const storagePath = `${client}/${Date.now()}_${file.name}`;
    const uploadRes = await fetch(`${SB_URL}/storage/v1/object/exposes/${storagePath}`, {
      method: 'POST',
      headers: {
        'apikey': SB_KEY,
        'Authorization': `Bearer ${SB_KEY}`,
        'Content-Type': 'application/pdf',
        'x-upsert': 'true'
      },
      body: file
    });
    if (!uploadRes.ok) {
      const err = await uploadRes.json().catch(() => ({}));
      throw new Error(err.message || `Upload fehlgeschlagen (HTTP ${uploadRes.status})`);
    }

    // 2. Create expose_jobs row
    await sbInsert('expose_jobs', {
      client: client,
      filename: file.name,
      status: 'uploaded',
      pdf_storage_path: storagePath
    });

    statusEl.textContent = '✅ Hochgeladen! Wird verarbeitet...';
    showToast('Exposé hochgeladen ✓');
    closeExposeUploadModal();
    loadExposes();
  } catch (err) {
    console.error('Expose upload error:', err);
    statusEl.textContent = '❌ Fehler: ' + err.message;
    uploadBtn.disabled = false;
  }
}

async function loadExposes() {
  try {
    const jobs = await sbGet('expose_jobs', 'order=created_at.desc');
    const listEl = document.getElementById('expose-list');
    const emptyEl = document.getElementById('expose-empty');

    if (!jobs || jobs.length === 0) {
      emptyEl.style.display = 'block';
      listEl.innerHTML = '';
      return;
    }

    emptyEl.style.display = 'none';

    const clientLabels = { 'engel-voelkers': 'Engel & Völkers', 'von-poll': 'Von Poll' };
    const statusLabels = { 'uploaded': '⏳ Hochgeladen', 'processing': '⏳ Wird verarbeitet', 'done': '✅ Fertig', 'error': '❌ Fehler' };

    listEl.innerHTML = jobs.map(j => {
      const price = j.property_price ? new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(j.property_price) : '—';
      const created = j.created_at ? new Date(j.created_at).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
      return `
        <div class="expose-card" onclick="showExposeDetail('${j.id}')">
          <div class="expose-card-filename" title="${escHtml(j.filename)}">${escHtml(j.filename)}</div>
          <span class="expose-card-client">${clientLabels[j.client] || j.client}</span>
          <span class="expose-badge ${j.status}">${statusLabels[j.status] || j.status}</span>
          <span class="expose-card-title" title="${escHtml(j.property_title || '')}">${escHtml(j.property_title || '—')}</span>
          <span class="expose-card-city">${escHtml(j.property_city || '—')}</span>
          <span class="expose-card-price">${price}</span>
        </div>`;
    }).join('');

    // Poll if any jobs are still processing
    const hasPending = jobs.some(j => j.status === 'uploaded' || j.status === 'processing');
    if (hasPending) {
      clearTimeout(_exposePollingTimer);
      _exposePollingTimer = setTimeout(() => {
        if (_currentSection === 'exposes') loadExposes();
      }, 10000);
    }
  } catch (err) {
    console.error('loadExposes error:', err);
    showToast('Fehler beim Laden der Exposés', 'error');
  }
}

async function showExposeDetail(id) {
  try {
    const rows = await sbGet('expose_jobs', `id=eq.${id}`);
    if (!rows || rows.length === 0) return;
    const j = rows[0];

    const clientLabels = { 'engel-voelkers': 'Engel & Völkers', 'von-poll': 'Von Poll' };
    const statusLabels = { 'uploaded': '⏳ Hochgeladen', 'processing': '⏳ Wird verarbeitet', 'done': '✅ Fertig', 'error': '❌ Fehler' };
    const price = j.property_price ? new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(j.property_price) : '—';
    const fmtDate = (d) => d ? new Date(d).toLocaleString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' }) : '—';

    let html = `
      <div class="expose-detail-header">
        <h3>${escHtml(j.property_title || j.filename)}</h3>
        <button class="expose-detail-close" onclick="closeExposeDetail()">✕</button>
      </div>

      <div class="expose-props">
        <div class="expose-prop"><div class="expose-prop-label">Kunde</div><div class="expose-prop-value">${clientLabels[j.client] || j.client}</div></div>
        <div class="expose-prop"><div class="expose-prop-label">Status</div><div class="expose-prop-value"><span class="expose-badge ${j.status}">${statusLabels[j.status]}</span></div></div>
        <div class="expose-prop"><div class="expose-prop-label">Titel</div><div class="expose-prop-value">${escHtml(j.property_title || '—')}</div></div>
        <div class="expose-prop"><div class="expose-prop-label">Adresse</div><div class="expose-prop-value">${escHtml(j.property_address || '—')}</div></div>
        <div class="expose-prop"><div class="expose-prop-label">Stadt</div><div class="expose-prop-value">${escHtml(j.property_city || '—')} ${escHtml(j.property_plz || '')}</div></div>
        <div class="expose-prop"><div class="expose-prop-label">Preis</div><div class="expose-prop-value">${price}</div></div>
        <div class="expose-prop"><div class="expose-prop-label">Fläche</div><div class="expose-prop-value">${j.property_size_sqm ? j.property_size_sqm + ' m²' : '—'}</div></div>
        <div class="expose-prop"><div class="expose-prop-label">Zimmer</div><div class="expose-prop-value">${j.property_rooms || '—'}</div></div>
        <div class="expose-prop"><div class="expose-prop-label">Typ</div><div class="expose-prop-value">${escHtml(j.property_type || '—')}</div></div>
      </div>`;

    if (j.status === 'error' && j.error_message) {
      html += `<div class="expose-section-title" style="border-left-color:var(--red);">❌ Fehler</div>
        <div class="expose-md-content" style="color:var(--red);border-color:var(--red-muted);">${escHtml(j.error_message)}</div>`;
    }

    if (j.status === 'done' && (j.ad_copy_md || j.video_concept_md)) {
      html += `<div style="margin-top:24px;"><h4 style="font-size:16px;font-weight:700;margin-bottom:16px;color:var(--text-primary);">📋 Ergebnisse</h4></div>`;
    }

    if (j.ad_copy_md) {
      html += `<div class="expose-section-title">📝 Ad Copy</div>
        <div class="expose-md-content">${renderMarkdown(j.ad_copy_md)}</div>`;
    }

    if (j.video_concept_md) {
      html += `<div class="expose-section-title">🎬 Video-Konzept</div>
        <div class="expose-md-content">${renderMarkdown(j.video_concept_md)}</div>`;
    }

    if (j.drive_folder_url) {
      html += `<div style="margin-top:16px;">
        <a href="${escHtml(j.drive_folder_url)}" target="_blank" class="btn btn-primary">📁 Google Drive Ordner öffnen</a>
      </div>`;
    }

    html += `<div class="expose-meta-row">
      <span>📄 ${escHtml(j.filename)}</span>
      <span>Erstellt: ${fmtDate(j.created_at)}</span>
      <span>Aktualisiert: ${fmtDate(j.updated_at)}</span>
      ${j.completed_at ? `<span>Fertig: ${fmtDate(j.completed_at)}</span>` : ''}
    </div>`;

    const detailEl = document.getElementById('expose-detail');
    detailEl.innerHTML = html;
    detailEl.classList.add('visible');
    detailEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Auto-refresh if still processing
    if (j.status === 'uploaded' || j.status === 'processing') {
      clearTimeout(_exposePollingTimer);
      _exposePollingTimer = setTimeout(() => {
        if (_currentSection === 'exposes') showExposeDetail(id);
      }, 8000);
    }
  } catch (err) {
    console.error('showExposeDetail error:', err);
    showToast('Fehler beim Laden des Exposés', 'error');
  }
}

function closeExposeDetail() {
  document.getElementById('expose-detail').classList.remove('visible');
}

// ============================================
// INITIALIZATION
// ============================================
async function init() {
  try {
    // Load Meta API token from Supabase first (before any UI depends on it)
    await loadMetaApiToken();
    
    initDropZone();
    const ready = await checkDatabase();
    if (ready) {
      await loadClients();
      await loadHomeStats();
    }
  } catch (e) {
    console.error('Initialisierungsfehler:', e);
  }
}

// --- Ad Detail Modal ---
function openAdDetailModal(adId) {
  // Search in deduped ads first (from filtered cache), then raw
  var ad = _filteredAdsCache.find(function(a) { return a.id === adId; });
  if (!ad) ad = competitorAds.find(function(a) { return a.id === adId; });
  if (!ad) return;

  var brand = ad.page_name || '–';
  var bodyText = (ad.ad_creative_bodies && ad.ad_creative_bodies.length > 0) ? ad.ad_creative_bodies[0] : '';
  var days = calcDaysRunning(ad);
  var platforms = (ad.publisher_platforms || []).map(function(p) {
    return platformLabel(p);
  }).join(', ');
  // Use aggregated dates for deduped ads
  var displayStart = ad._earliestStart || (ad.ad_delivery_start_time ? new Date(ad.ad_delivery_start_time) : null);
  var displayEnd = ad._isRunning === false ? (ad._latestStop || (ad.ad_delivery_stop_time ? new Date(ad.ad_delivery_stop_time) : null)) : null;
  var startDate = displayStart ? displayStart.toLocaleDateString('de-DE', {day:'2-digit',month:'2-digit',year:'numeric'}) : '–';
  var endDate = displayEnd ? displayEnd.toLocaleDateString('de-DE', {day:'2-digit',month:'2-digit',year:'numeric'}) : null;
  var effectiveSpend = getAdEffectiveSpend(ad);
  var spendStr = effectiveSpend > 0 ? '€' + Number((effectiveSpend / 100).toFixed(0)).toLocaleString('de-DE') : '–';

  // Impressions range
  var impressions = '–';
  if (ad.impressions_lower || ad.impressions_upper) {
    impressions = (ad.impressions_lower || 0).toLocaleString('de-DE') + ' – ' + (ad.impressions_upper || 0).toLocaleString('de-DE');
  }

  // EU Reach (use aggregated for deduped)
  var euReach = (ad._totalReach || ad.eu_total_reach) ? Number(ad._totalReach || ad.eu_total_reach).toLocaleString('de-DE') : '–';

  // CPM
  var cpmStr = '–';
  var effCpm = getEffectiveCpm();
  if (effCpm > 0) {
    var cpmSource = parseFloat(localStorage.getItem('comp_own_cpm') || '') > 0 ? 'manuell' : 'auto';
    cpmStr = '€' + effCpm.toFixed(2) + ' (' + cpmSource + ')';
  } else if (ad.estimated_cpm && ad.estimated_cpm > 0) {
    cpmStr = '€' + (parseFloat(ad.estimated_cpm) / 100).toFixed(2);
  }

  // Status — date-based, not is_active
  var adIsRunning = isAdRunningByDate(ad);
  var statusStr = adIsRunning ? '🟢 Laufend' : '⏹ Beendet';
  var dateRange = 'Start: ' + startDate + ' — ' + (endDate ? 'Ende: ' + endDate : 'Heute');

  // Title
  document.getElementById('ad-detail-title').textContent = brand;

  // Preview
  var previewEl = document.getElementById('ad-detail-preview');
  previewEl.innerHTML = '';

  // Stats grid
  var statsHtml = '';
  var stats = [
    { icon: '💰', label: 'Geschätzter Spend', value: spendStr },
    { icon: '📊', label: 'Impressions', value: impressions },
    { icon: '🌍', label: 'EU Reach', value: euReach },
    { icon: '📈', label: 'Geschätzter CPM', value: cpmStr },
    { icon: '⏱️', label: 'Laufzeit', value: days + ' Tage' },
    { icon: '📱', label: 'Plattform(en)', value: platforms || '–' },
    { icon: '📅', label: 'Zeitraum', value: dateRange },
    { icon: statusStr.substring(0,2), label: 'Status', value: statusStr.substring(2).trim() }
  ];
  stats.forEach(function(s) {
    statsHtml += '<div class="ad-detail-stat-card"><div class="stat-icon">' + s.icon + '</div><div class="stat-value">' + escHtml(s.value) + '</div><div class="stat-label">' + escHtml(s.label) + '</div></div>';
  });
  document.getElementById('ad-detail-stats').innerHTML = statsHtml;

  // Ad Text
  document.getElementById('ad-detail-text').textContent = bodyText || 'Kein Anzeigentext verfügbar';

  // Variant info (dedup)
  var variantInfoEl = document.getElementById('ad-detail-variants');
  if (variantInfoEl) {
    if (ad._variants && ad._variants.length > 1) {
      var varHtml = '<div style="background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2);border-radius:8px;padding:12px;margin-bottom:16px;">';
      varHtml += '<div style="font-weight:600;font-size:13px;color:#8b5cf6;margin-bottom:8px;">📦 ' + ad._variants.length + ' Varianten dieser Anzeige</div>';
      varHtml += '<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">Meta schaltet dieselbe Anzeige unter verschiedenen IDs für unterschiedliche Platzierungen.</div>';
      varHtml += '<div style="font-size:11px;color:var(--text-muted);max-height:100px;overflow-y:auto;">';
      ad._variants.forEach(function(v) {
        var platforms = (v.publisher_platforms || []).join(', ');
        varHtml += '<div style="margin-bottom:2px;">• ' + escHtml(v.ad_library_id || v.id || '–') + (platforms ? ' (' + platforms + ')' : '') + '</div>';
      });
      varHtml += '</div>';
      varHtml += '<div style="margin-top:8px;font-size:12px;font-weight:600;">🌍 Gesamtreichweite: ' + (ad._totalReach || 0).toLocaleString('de-DE') + '</div>';
      varHtml += '</div>';
      variantInfoEl.innerHTML = varHtml;
    } else {
      variantInfoEl.innerHTML = '';
    }
  }

  // Snapshot link
  var snapshotLink = document.getElementById('ad-detail-snapshot-link');
  if (ad.ad_snapshot_url) {
    var url = ad.ad_snapshot_url;
    var token = localStorage.getItem('meta_ad_library_token');
    if (token) url += (url.indexOf('?') >= 0 ? '&' : '?') + 'access_token=' + encodeURIComponent(token);
    snapshotLink.href = url;
    snapshotLink.style.display = 'inline-flex';
  } else {
    snapshotLink.style.display = 'none';
  }

  document.getElementById('comp-ad-detail-modal').classList.add('visible');
}

function closeAdDetailModal() {
  document.getElementById('comp-ad-detail-modal').classList.remove('visible');
}

// Close on Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeAdDetailModal();
});

// --- Own CPM Reference ---
function saveOwnCpm() {
  var val = document.getElementById('comp-own-cpm').value.trim();
  if (val && parseFloat(val) > 0) {
    localStorage.setItem('comp_own_cpm', val);
    showToast('CPM-Referenzwert gespeichert: €' + parseFloat(val).toFixed(2), 'success');
    // Re-render to apply new CPM
    applyCompetitorFilters();
    updateCompetitorStats();
    renderLeaderboard();
    renderCompInsights();
  } else {
    showToast('Bitte gültigen CPM eingeben', 'error');
  }
}

function clearOwnCpm() {
  localStorage.removeItem('comp_own_cpm');
  document.getElementById('comp-own-cpm').value = '';
  showToast('CPM-Referenzwert gelöscht', 'success');
  applyCompetitorFilters();
  updateCompetitorStats();
  renderLeaderboard();
  renderCompInsights();
}

// Load saved CPM on init + trigger auto-CPM
(function() {
  var savedCpm = localStorage.getItem('comp_own_cpm');
  if (savedCpm) {
    var el = document.getElementById('comp-own-cpm');
    if (el) el.value = savedCpm;
  }
  // Pre-load auto-CPM for home page competitor preview
  loadAutoCpm();
})();

// ============================================
// EDITORIAL PLANNER (Ferrari HH)
// ============================================
let _epClientId = null;
let _epEntries = [];
let _epEditingId = null;
let _epOutlookId = null;
let _epOutlookTimer = null;
let _epInitialized = false;
const EP_WEEKDAYS = ['SO', 'MO', 'DI', 'MI', 'DO', 'FR', 'SA'];
const EP_MONTHS_DE = ['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];

async function epInit() {
  if (_epInitialized) { epRenderPreview(); return; }
  // Set default month/year
  const now = new Date();
  document.getElementById('ep-month').value = now.getMonth() + 1;
  // Populate year dropdown
  const yearSel = document.getElementById('ep-year');
  yearSel.innerHTML = '';
  for (let y = now.getFullYear() - 1; y <= now.getFullYear() + 2; y++) {
    const opt = document.createElement('option');
    opt.value = y; opt.textContent = y;
    if (y === now.getFullYear()) opt.selected = true;
    yearSel.appendChild(opt);
  }
  // Find Ferrari HH client
  try {
    const clients = await sbGet('clients', 'select=id,name,brand&name=eq.Ferrari Hamburg');
    if (clients.length > 0) {
      _epClientId = clients[0].id;
    } else {
      // Try to insert
      try {
        const ins = await sbInsert('clients', { name: 'Ferrari Hamburg', brand: 'Ferrari' });
        _epClientId = ins[0].id;
      } catch(e2) {
        console.error('Cannot create Ferrari HH client:', e2);
      }
    }
  } catch(e) {
    console.error('Error fetching clients:', e);
  }
  _epInitialized = true;
  epLoadEntries();
}

async function epLoadEntries() {
  const month = parseInt(document.getElementById('ep-month').value);
  const year = parseInt(document.getElementById('ep-year').value);
  // Update A4 header
  document.getElementById('ep-a4-month-label').textContent = EP_MONTHS_DE[month - 1] + ' ' + year;
  if (!_epClientId) { epRenderEntryList(); epRenderPreview(); return; }
  try {
    _epEntries = await sbGet('editorial_entries',
      `client_id=eq.${_epClientId}&year=eq.${year}&month=eq.${month}&order=publish_date.asc,publish_time.asc`);
  } catch(e) {
    console.warn('editorial_entries nicht verfügbar:', e.message);
    _epEntries = [];
  }
  epRenderEntryList();
  epRenderPreview();
  epLoadOutlook();
}

function epRenderEntryList() {
  const list = document.getElementById('ep-entry-list');
  const label = document.getElementById('ep-entries-label');
  label.textContent = `EINTRÄGE (${_epEntries.length})`;
  if (_epEntries.length === 0) {
    list.innerHTML = '<div style="font-size:13px;color:var(--text-muted);padding:8px 0;">Keine Einträge vorhanden.</div>';
    return;
  }
  list.innerHTML = _epEntries.map(e => {
    const d = new Date(e.publish_date + 'T00:00:00');
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const time = e.publish_time ? e.publish_time.substring(0,5) : '';
    const series = e.content_series === '__custom__' ? (e.custom_series || '') : (e.content_series || '');
    return `<div class="editorial-entry-item" onclick="epEditEntry('${e.id}')">
      <div class="editorial-entry-item-content">
        <div class="editorial-entry-item-title">${escHtml(e.title)}</div>
        <div class="editorial-entry-item-meta">${dd}.${mm}., ${time} · ${escHtml(series)}</div>
      </div>
      <button class="editorial-entry-delete" onclick="event.stopPropagation();epDeleteEntry('${e.id}')" title="Löschen">✕</button>
    </div>`;
  }).join('');
}

function epRenderPreview() {
  const month = parseInt(document.getElementById('ep-month').value);
  const year = parseInt(document.getElementById('ep-year').value);
  document.getElementById('ep-a4-month-label').textContent = EP_MONTHS_DE[month - 1] + ' ' + year;
  const container = document.getElementById('ep-a4-entries');
  if (_epEntries.length === 0) {
    container.innerHTML = '<div class="editorial-a4-empty">Noch keine Einträge für diesen Monat.</div>';
    return;
  }
  container.innerHTML = _epEntries.map(e => {
    const d = new Date(e.publish_date + 'T00:00:00');
    const day = d.getDate();
    const wd = EP_WEEKDAYS[d.getDay()];
    const time = e.publish_time ? e.publish_time.substring(0,5) + ' Uhr' : '';
    const series = e.content_series === '__custom__' ? (e.custom_series || '') : (e.content_series || '');
    let vehicleHtml = '';
    if (e.vehicle) {
      vehicleHtml = `<div class="editorial-a4-vehicle">${escHtml(e.vehicle)}</div>`;
    }
    let refHtml = '';
    if (e.notes) {
      const noteText = e.notes.trim();
      const urlMatch = noteText.match(/https?:\/\/\S+/);
      if (urlMatch) {
        refHtml = `<div class="editorial-a4-ref"><a href="${escHtml(urlMatch[0])}" target="_blank" rel="noopener" style="color:inherit;text-decoration:underline;">📎 ${escHtml(noteText)}</a></div>`;
      } else {
        refHtml = `<div class="editorial-a4-ref">${escHtml(noteText)}</div>`;
      }
    }
    let locationHtml = '';
    if (e.location) {
      locationHtml = `<span>📍 ${escHtml(e.location)}</span>`;
    }
    let seriesTag = '';
    if (series) {
      seriesTag = `<span class="editorial-a4-series-tag">${escHtml(series)}</span>`;
    }
    return `<div class="editorial-a4-entry">
      <div class="editorial-a4-date">
        <div class="editorial-a4-day">${day}</div>
        <div class="editorial-a4-weekday">${wd}</div>
      </div>
      <div class="editorial-a4-content">
        ${vehicleHtml}
        <div class="editorial-a4-title">${escHtml(e.title)}</div>
        <div class="editorial-a4-meta">
          <span>🕐 ${time}</span>
          ${seriesTag}
          ${locationHtml}
        </div>
        ${refHtml}
      </div>
    </div>`;
  }).join('');
}

function epShowForm(entry) {
  _epEditingId = entry ? entry.id : null;
  const form = document.getElementById('ep-form');
  form.style.display = 'block';
  document.getElementById('ep-new-btn').style.display = 'none';
  // Set defaults or editing values
  const month = parseInt(document.getElementById('ep-month').value);
  const year = parseInt(document.getElementById('ep-year').value);
  if (entry) {
    document.getElementById('ep-f-date').value = entry.publish_date;
    document.getElementById('ep-f-time').value = entry.publish_time ? entry.publish_time.substring(0,5) : '17:00';
    document.getElementById('ep-f-vehicle').value = entry.vehicle || '';
    document.getElementById('ep-f-title').value = entry.title || '';
    document.getElementById('ep-f-series').value = entry.content_series || '';
    document.getElementById('ep-f-custom-series').value = entry.custom_series || '';
    document.getElementById('ep-f-location').value = entry.location || '';
    document.getElementById('ep-f-notes').value = entry.notes || '';
  } else {
    document.getElementById('ep-f-date').value = `${year}-${String(month).padStart(2,'0')}-01`;
    document.getElementById('ep-f-time').value = '17:00';
    document.getElementById('ep-f-vehicle').value = '';
    document.getElementById('ep-f-title').value = '';
    document.getElementById('ep-f-series').value = '';
    document.getElementById('ep-f-custom-series').value = '';
    document.getElementById('ep-f-location').value = '';
    document.getElementById('ep-f-notes').value = '';
  }
  epToggleCustomSeries();
}

function epCancelForm() {
  document.getElementById('ep-form').style.display = 'none';
  document.getElementById('ep-new-btn').style.display = 'flex';
  _epEditingId = null;
}

function epToggleCustomSeries() {
  const val = document.getElementById('ep-f-series').value;
  document.getElementById('ep-f-custom-series-group').style.display = val === '__custom__' ? 'block' : 'none';
}

async function epSaveEntry() {
  const title = document.getElementById('ep-f-title').value.trim();
  const dateVal = document.getElementById('ep-f-date').value;
  if (!title || !dateVal) { showToast('Bitte Titel und Datum ausfüllen.', 'error'); return; }
  const d = new Date(dateVal + 'T00:00:00');
  const data = {
    client_id: _epClientId,
    year: d.getFullYear(),
    month: d.getMonth() + 1,
    publish_date: dateVal,
    publish_time: document.getElementById('ep-f-time').value || '17:00',
    title: title,
    vehicle: document.getElementById('ep-f-vehicle').value.trim() || null,
    content_series: document.getElementById('ep-f-series').value || null,
    custom_series: document.getElementById('ep-f-custom-series').value.trim() || null,
    location: document.getElementById('ep-f-location').value.trim() || null,
    notes: document.getElementById('ep-f-notes').value.trim() || null
  };
  try {
    if (_epEditingId) {
      await sbPatch('editorial_entries', _epEditingId, data);
      showToast('Eintrag aktualisiert ✓');
    } else {
      await sbInsert('editorial_entries', data);
      showToast('Eintrag erstellt ✓');
    }
    epCancelForm();
    epLoadEntries();
  } catch(e) {
    showToast('Fehler beim Speichern: ' + e.message, 'error');
  }
}

function epEditEntry(id) {
  const entry = _epEntries.find(e => e.id === id);
  if (entry) epShowForm(entry);
}

async function epDeleteEntry(id) {
  if (!confirm('Eintrag wirklich löschen?')) return;
  try {
    await sbDelete('editorial_entries', id);
    showToast('Eintrag gelöscht');
    epLoadEntries();
  } catch(e) {
    showToast('Fehler beim Löschen: ' + e.message, 'error');
  }
}

async function epLoadOutlook() {
  const month = parseInt(document.getElementById('ep-month').value);
  const year = parseInt(document.getElementById('ep-year').value);
  if (!_epClientId) return;
  try {
    const data = await sbGet('editorial_outlook',
      `client_id=eq.${_epClientId}&year=eq.${year}&month=eq.${month}`);
    if (data.length > 0) {
      _epOutlookId = data[0].id;
      document.getElementById('ep-outlook').value = data[0].notes || '';
    } else {
      _epOutlookId = null;
      document.getElementById('ep-outlook').value = '';
    }
    epUpdateOutlookPreview();
  } catch(e) {
    console.warn('editorial_outlook nicht verfügbar:', e.message);
    _epOutlookId = null;
  }
}

function epUpdateOutlookPreview() {
  const text = document.getElementById('ep-outlook').value.trim();
  const section = document.getElementById('ep-a4-outlook-section');
  if (text) {
    document.getElementById('ep-a4-outlook-text').textContent = text;
    section.style.display = 'block';
  } else {
    section.style.display = 'none';
  }
}

async function epSaveOutlook() {
  const month = parseInt(document.getElementById('ep-month').value);
  const year = parseInt(document.getElementById('ep-year').value);
  const notes = document.getElementById('ep-outlook').value.trim();
  epUpdateOutlookPreview();
  if (!_epClientId) return;
  clearTimeout(_epOutlookTimer);
  _epOutlookTimer = setTimeout(async () => {
    try {
      if (_epOutlookId) {
        await sbPatch('editorial_outlook', _epOutlookId, { notes });
      } else if (notes) {
        const res = await sbInsert('editorial_outlook', {
          client_id: _epClientId, year, month, notes
        });
        if (res.length > 0) _epOutlookId = res[0].id;
      }
    } catch(e) {
      console.warn('Outlook speichern fehlgeschlagen:', e.message);
    }
  }, 500);
}

init();

// ============================================
// MAP BUILDER — Integrated from map/index.html
// All functions prefixed with mb_ to avoid conflicts
// Uses existing SB_URL and SB_KEY constants
// ============================================
(function() {
  'use strict';

  const MB_CATEGORIES = {
    supermarket: { emoji: '', label: 'Supermarkt', color: '#525252' },
    doctor:      { emoji: '', label: 'Arzt/Krankenhaus', color: '#525252' },
    school:      { emoji: '', label: 'Schule/Kita', color: '#525252' },
    pool:        { emoji: '', label: 'Schwimmbad/Sport', color: '#525252' },
    park:        { emoji: '', label: 'Park', color: '#525252' },
    transport:   { emoji: '', label: 'ÖPNV/Haltestelle', color: '#525252' },
    restaurant:  { emoji: '', label: 'Restaurant', color: '#525252' },
    other:       { emoji: '', label: 'Sonstiges', color: '#525252' }
  };

  const MB_TILE_URLS = {
    clean:     'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png',
    light:     'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',
    detailed:  'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
    grayscale: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
    satellite: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    dark:      'https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png'
  };

  const MB_PIN_SIZES = { small: 32, medium: 44, large: 56 };

  // State
  window._mbMap = null;
  let _mbTileLayer = null;
  let _mbMainProperty = null;
  let _mbPois = [];
  let _mbCurrentMapId = null;
  let _mbLabelsEnabled = true;
  let _mbConnectorsEnabled = true;

  // ─── INIT ───
  window.mb_initMap = function() {
    if (window._mbMap) return;
    window._mbMap = L.map('mb-map', {
      center: [53.5511, 9.9937],
      zoom: 13,
      zoomControl: true
    });

    _mbTileLayer = L.tileLayer(MB_TILE_URLS.clean, {
      attribution: '© OpenStreetMap © CARTO',
      maxZoom: 19
    }).addTo(window._mbMap);

    window._mbMap.on('moveend zoomend', () => requestAnimationFrame(mb_updateLabels));
    window._mbMap.on('move', () => requestAnimationFrame(mb_updateLabels));

    // Resize observer for 4:3 container — invalidate map when it resizes
    const mapInner = document.getElementById('mb-mapInner');
    if (mapInner && typeof ResizeObserver !== 'undefined') {
      new ResizeObserver(() => {
        if (window._mbMap) {
          window._mbMap.invalidateSize();
          requestAnimationFrame(mb_updateLabels);
        }
      }).observe(mapInner);
    }

    // Color picker event
    const poiColorEl = document.getElementById('mb-poiColor');
    if (poiColorEl) {
      poiColorEl.addEventListener('input', function() {
        document.getElementById('mb-poiColorHex').textContent = this.value;
      });
    }
  };

  // ─── GEOCODING ───
  async function mb_geocodeAddress(address) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&countrycodes=de,at,ch`;
    const res = await fetch(url, { headers: { 'Accept-Language': 'de' } });
    const data = await res.json();
    if (!data || data.length === 0) throw new Error('Adresse nicht gefunden');
    return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), display: data[0].display_name };
  }

  function mb_haversineDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function mb_formatDistance(meters) {
    if (meters >= 1000) return (meters / 1000).toFixed(1) + ' km';
    return Math.round(meters) + ' m';
  }

  function mb_escapeHtml(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
  }

  function mb_hexToRgb(hex) {
    const r = parseInt(hex.slice(1,3), 16);
    const g = parseInt(hex.slice(3,5), 16);
    const b = parseInt(hex.slice(5,7), 16);
    return `${r},${g},${b}`;
  }

  function mb_toast(msg, type) {
    type = type || 'info';
    const container = document.getElementById('mb-toastContainer');
    if (!container) return;
    const el = document.createElement('div');
    el.className = 'mb-toast ' + type;
    el.textContent = msg;
    container.appendChild(el);
    setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity 0.3s'; }, 2500);
    setTimeout(() => el.remove(), 2800);
  }

  function mb_sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  // ─── PROPERTY ADDRESS ───
  window.mb_geocodeProperty = async function() {
    const address = document.getElementById('mb-propertyAddress').value.trim();
    if (!address) return;

    const btn = document.getElementById('mb-btnGeocode');
    btn.innerHTML = '<span class="mb-spinner"></span> Suche…';
    btn.disabled = true;

    try {
      const result = await mb_geocodeAddress(address);

      if (_mbMainProperty && _mbMainProperty.marker) {
        window._mbMap.removeLayer(_mbMainProperty.marker);
      }

      _mbMainProperty = { address, lat: result.lat, lng: result.lng, marker: null };
      _mbMainProperty.marker = mb_createMainMarker(result.lat, result.lng);
      _mbMainProperty.marker.addTo(window._mbMap);

      window._mbMap.setView([result.lat, result.lng], 15);

      document.getElementById('mb-propertyVerified').style.display = 'flex';
      document.getElementById('mb-propertyCoords').textContent = `${result.lat.toFixed(5)}, ${result.lng.toFixed(5)}`;

      // Show auto-POI discovery button
      document.getElementById('mb-autoPoiSection').style.display = 'block';

      mb_recalcDistances();
      mb_updateLabels();

      mb_toast('Adresse gefunden', 'success');
    } catch (e) {
      mb_toast('Adresse nicht gefunden: ' + e.message, 'error');
    } finally {
      btn.innerHTML = '🔍 Adresse suchen';
      btn.disabled = false;
    }
  };

  // ─── MARKERS ───
  function mb_getMainPinSize() {
    return MB_PIN_SIZES[document.getElementById('mb-mainPinSize').value] || 56;
  }

  function mb_createMainMarker(lat, lng) {
    const size = mb_getMainPinSize();
    const color = document.getElementById('mb-mainPinColor').value;
    const icon = L.divIcon({
      html: `<div style="
        width:${size}px;height:${size}px;
        background:${color};
        border:3px solid #fff;
        border-radius:50%;
        display:flex;align-items:center;justify-content:center;
        box-shadow:0 2px 8px rgba(0,0,0,0.25), 0 0 0 4px rgba(${mb_hexToRgb(color)},0.2);
        font-size:${Math.round(size*0.45)}px;
      ">🏠</div>`,
      className: 'custom-div-icon',
      iconSize: [size, size],
      iconAnchor: [size/2, size/2]
    });
    return L.marker([lat, lng], { icon, zIndexOffset: 10000 });
  }

  function mb_getCategoryInfo(poi) {
    if (poi.custom_category_label) {
      return { emoji: '', label: poi.custom_category_label, color: '#525252' };
    }
    return MB_CATEGORIES[poi.category] || MB_CATEGORIES.other;
  }

  function mb_createPOIMarker(poi) {
    const sizeVal = MB_PIN_SIZES[poi.pin_size] || 44;
    const cat = mb_getCategoryInfo(poi);
    const color = poi.pin_color || cat.color;
    const icon = L.divIcon({
      html: `<div style="
        width:${sizeVal}px;height:${sizeVal}px;
        background:${color};
        border:3px solid #fff;
        border-radius:50%;
        display:flex;align-items:center;justify-content:center;
        box-shadow:0 2px 6px rgba(0,0,0,0.2);
        font-size:${Math.round(sizeVal*0.4)}px;
      ">📍</div>`,
      className: 'custom-div-icon',
      iconSize: [sizeVal, sizeVal],
      iconAnchor: [sizeVal/2, sizeVal/2]
    });
    return L.marker([poi.lat, poi.lng], { icon });
  }

  window.mb_updateMainPin = function() {
    document.getElementById('mb-mainPinColorHex').textContent = document.getElementById('mb-mainPinColor').value;
    if (_mbMainProperty && _mbMainProperty.marker) {
      window._mbMap.removeLayer(_mbMainProperty.marker);
      _mbMainProperty.marker = mb_createMainMarker(_mbMainProperty.lat, _mbMainProperty.lng);
      _mbMainProperty.marker.addTo(window._mbMap);
      mb_updateLabels();
    }
  };

  // ─── POI MANAGEMENT ───
  window.mb_showAddPOIForm = function() {
    document.getElementById('mb-addPOIForm').style.display = 'block';
    document.getElementById('mb-poiName').focus();
    mb_updateCategoryDefaults();
  };

  window.mb_hideAddPOIForm = function() {
    document.getElementById('mb-addPOIForm').style.display = 'none';
    document.getElementById('mb-poiName').value = '';
    document.getElementById('mb-poiAddress').value = '';
    document.getElementById('mb-poiCustomCategory').value = '';
  };

  window.mb_updateCategoryDefaults = function() {
    const customCat = document.getElementById('mb-poiCustomCategory').value.trim();
    if (customCat) {
      // Custom category: use default gray
      document.getElementById('mb-poiColor').value = '#525252';
      document.getElementById('mb-poiColorHex').textContent = '#525252';
    } else {
      const cat = document.getElementById('mb-poiCategory').value;
      const info = MB_CATEGORIES[cat] || MB_CATEGORIES.other;
      document.getElementById('mb-poiColor').value = info.color;
      document.getElementById('mb-poiColorHex').textContent = info.color;
    }
  };

  window.mb_onCustomCategoryInput = function() {
    mb_updateCategoryDefaults();
  };

  window.mb_addPOI = async function() {
    const name = document.getElementById('mb-poiName').value.trim();
    const address = document.getElementById('mb-poiAddress').value.trim();
    const customCategoryName = document.getElementById('mb-poiCustomCategory').value.trim();
    const category = customCategoryName ? '_custom' : document.getElementById('mb-poiCategory').value;
    const custom_category_label = customCategoryName || null;
    const pin_color = document.getElementById('mb-poiColor').value;
    const pin_size = document.getElementById('mb-poiSize').value;

    if (!name) return mb_toast('Name eingeben', 'error');
    if (!address) return mb_toast('Adresse eingeben', 'error');

    const btn = document.getElementById('mb-btnAddPOI');
    btn.innerHTML = '<span class="mb-spinner"></span>';
    btn.disabled = true;

    try {
      const result = await mb_geocodeAddress(address);

      let distance_meters = null;
      if (_mbMainProperty) {
        distance_meters = Math.round(mb_haversineDistance(_mbMainProperty.lat, _mbMainProperty.lng, result.lat, result.lng));
      }

      const poi = {
        id: 'poi-' + Date.now() + '-' + Math.random().toString(36).slice(2,6),
        name, address, category,
        custom_category_label,
        lat: result.lat, lng: result.lng,
        pin_color, pin_size,
        distance_meters,
        sort_order: _mbPois.length,
        marker: null
      };

      poi.marker = mb_createPOIMarker(poi);
      poi.marker.addTo(window._mbMap);

      _mbPois.push(poi);
      mb_renderPOIList();
      mb_updateLabels();
      mb_hideAddPOIForm();

      mb_toast(`${name} hinzugefügt`, 'success');
    } catch (e) {
      mb_toast('Fehler: ' + e.message, 'error');
    } finally {
      btn.innerHTML = 'Hinzufügen';
      btn.disabled = false;
    }
  };

  window.mb_removePOI = function(id) {
    const idx = _mbPois.findIndex(p => p.id === id);
    if (idx === -1) return;
    if (_mbPois[idx].marker) window._mbMap.removeLayer(_mbPois[idx].marker);
    _mbPois.splice(idx, 1);
    mb_renderPOIList();
    mb_updateLabels();
  };

  function mb_recalcDistances() {
    if (!_mbMainProperty) return;
    _mbPois.forEach(poi => {
      poi.distance_meters = Math.round(mb_haversineDistance(_mbMainProperty.lat, _mbMainProperty.lng, poi.lat, poi.lng));
    });
    mb_renderPOIList();
  }

  function mb_renderPOIList() {
    const container = document.getElementById('mb-poiList');
    const empty = document.getElementById('mb-poiEmpty');

    if (_mbPois.length === 0) {
      empty.style.display = 'block';
      container.querySelectorAll('.mb-poi-card').forEach(el => el.remove());
      return;
    }

    empty.style.display = 'none';

    const sorted = [..._mbPois].sort((a, b) => (a.distance_meters || 9999999) - (b.distance_meters || 9999999));

    let html = '';
    sorted.forEach(poi => {
      const cat = mb_getCategoryInfo(poi);
      const autoTag = poi._autoDiscovered ? '<span style="font-size:9px;background:var(--blue);color:#fff;padding:1px 5px;border-radius:3px;margin-left:6px;vertical-align:middle;">auto</span>' : '';
      html += `<div class="mb-poi-card" data-id="${poi.id}">
        <div class="mb-poi-card-header">
          <div class="mb-poi-card-title">
            ${mb_escapeHtml(poi.name)}${autoTag}
          </div>
          <div class="mb-poi-actions">
            <button class="mb-btn mb-btn-ghost mb-btn-icon mb-btn-sm mb-btn-danger" onclick="mb_removePOI('${poi.id}')" title="Löschen">✕</button>
          </div>
        </div>
        <div class="mb-poi-card-address">${mb_escapeHtml(poi.address)}</div>
        <div class="mb-poi-card-meta">
          <div class="mb-poi-distance">${poi.distance_meters ? mb_formatDistance(poi.distance_meters) : '—'}</div>
          <div style="display:flex;align-items:center;gap:6px">
            <div class="mb-poi-color-dot" style="background:${poi.pin_color}"></div>
            <span style="font-size:11px;color:var(--text-muted)">${cat.label}</span>
          </div>
        </div>
      </div>`;
    });

    container.querySelectorAll('.mb-poi-card').forEach(el => el.remove());
    container.insertAdjacentHTML('beforeend', html);
  }

  // ─── SMART LABELS ───
  window.mb_updateLabels = function() {
    _mbLabelsEnabled = document.getElementById('mb-showLabels').checked;
    _mbConnectorsEnabled = document.getElementById('mb-showConnectors').checked;

    const labelLayer = document.getElementById('mb-labelLayer');
    const connectorLayer = document.getElementById('mb-connectorLayer');
    labelLayer.innerHTML = '';
    connectorLayer.innerHTML = '';

    if (!_mbLabelsEnabled || !window._mbMap) return;

    const mapContainer = window._mbMap.getContainer();
    const mapRect = mapContainer.getBoundingClientRect();
    const mapAreaEl = document.getElementById('mb-mapInner') || document.getElementById('mb-mapArea');
    const areaRect = mapAreaEl.getBoundingClientRect();

    const offsetX = mapRect.left - areaRect.left;
    const offsetY = mapRect.top - areaRect.top;
    const mapW = mapRect.width;
    const mapH = mapRect.height;

    const allPins = [];

    if (_mbMainProperty) {
      const pt = window._mbMap.latLngToContainerPoint([_mbMainProperty.lat, _mbMainProperty.lng]);
      allPins.push({ x: pt.x + offsetX, y: pt.y + offsetY, size: mb_getMainPinSize(), isMain: true });
    }

    const poiLabels = [];
    _mbPois.forEach(poi => {
      const pt = window._mbMap.latLngToContainerPoint([poi.lat, poi.lng]);
      const px = pt.x + offsetX;
      const py = pt.y + offsetY;
      const sz = MB_PIN_SIZES[poi.pin_size] || 44;

      if (px < -100 || px > mapW + 100 || py < -100 || py > mapH + 100) return;

      allPins.push({ x: px, y: py, size: sz, isMain: false });

      const cat = mb_getCategoryInfo(poi);
      const distText = poi.distance_meters ? mb_formatDistance(poi.distance_meters) : '';

      const textLen = poi.name.length;
      const labelW = Math.max(100, textLen * 7.5 + 24);
      const labelH = distText ? 38 : 26;

      poiLabels.push({
        poi, pinX: px, pinY: py, pinSize: sz,
        labelW, labelH, name: poi.name, distText,
        color: poi.pin_color || cat.color,
        labelX: 0, labelY: 0, anchor: 'right'
      });
    });

    if (poiLabels.length === 0) return;

    const placed = [];
    const obstacles = allPins.map(p => ({
      left: p.x - p.size/2 - 4, top: p.y - p.size/2 - 4,
      right: p.x + p.size/2 + 4, bottom: p.y + p.size/2 + 4
    }));

    poiLabels.forEach(label => {
      const candidates = mb_generateCandidates(label);

      let bestCandidate = candidates[0];
      let bestScore = Infinity;

      candidates.forEach(c => {
        let score = 0;
        const rect = { left: c.x, top: c.y, right: c.x + label.labelW, bottom: c.y + label.labelH };

        placed.forEach(p => {
          const overlap = mb_rectOverlapArea(rect, p);
          if (overlap > 0) score += overlap * 10;
        });

        obstacles.forEach(o => {
          const overlap = mb_rectOverlapArea(rect, o);
          if (overlap > 0) score += overlap * 20;
        });

        score += c.dist * 0.1;

        if (rect.left < 0) score += (-rect.left) * 5;
        if (rect.top < 0) score += (-rect.top) * 5;
        if (rect.right > mapW) score += (rect.right - mapW) * 5;
        if (rect.bottom > mapH) score += (rect.bottom - mapH) * 5;

        if (score < bestScore) { bestScore = score; bestCandidate = c; }
      });

      label.labelX = bestCandidate.x;
      label.labelY = bestCandidate.y;
      label.anchor = bestCandidate.anchor;

      placed.push({
        left: bestCandidate.x, top: bestCandidate.y,
        right: bestCandidate.x + label.labelW, bottom: bestCandidate.y + label.labelH
      });
    });

    let labelsHtml = '';
    let svgHtml = '';

    poiLabels.forEach(label => {
      labelsHtml += `<div class="mb-map-label" style="left:${label.labelX}px;top:${label.labelY}px;">
        <div class="mb-map-label-inner">
          <div class="mb-map-label-name">${mb_escapeHtml(label.name)}</div>
          ${label.distText ? `<div class="mb-map-label-distance">${label.distText}</div>` : ''}
        </div>
      </div>`;

      if (_mbConnectorsEnabled) {
        const connStart = mb_closestPointOnRect(
          { left: label.labelX, top: label.labelY, right: label.labelX + label.labelW, bottom: label.labelY + label.labelH },
          label.pinX, label.pinY
        );
        svgHtml += `<line x1="${connStart.x}" y1="${connStart.y}" x2="${label.pinX}" y2="${label.pinY}"
          stroke="${label.color}" stroke-width="1.5" stroke-opacity="0.35" stroke-dasharray="4,3"/>`;
      }
    });

    labelLayer.innerHTML = labelsHtml;
    connectorLayer.innerHTML = svgHtml;
  };

  function mb_generateCandidates(label) {
    const { pinX, pinY, pinSize, labelW, labelH } = label;
    const gap = 8;
    const r = pinSize / 2 + gap;

    const candidates = [];
    candidates.push({ x: pinX + r, y: pinY - labelH/2, anchor: 'right', dist: r });
    candidates.push({ x: pinX - r - labelW, y: pinY - labelH/2, anchor: 'left', dist: r });
    candidates.push({ x: pinX - labelW/2, y: pinY + r, anchor: 'bottom', dist: r });
    candidates.push({ x: pinX - labelW/2, y: pinY - r - labelH, anchor: 'top', dist: r });
    candidates.push({ x: pinX + r * 0.7, y: pinY + r * 0.7, anchor: 'bottom-right', dist: r * 1.2 });
    candidates.push({ x: pinX - r * 0.7 - labelW, y: pinY + r * 0.7, anchor: 'bottom-left', dist: r * 1.2 });
    candidates.push({ x: pinX + r * 0.7, y: pinY - r * 0.7 - labelH, anchor: 'top-right', dist: r * 1.2 });
    candidates.push({ x: pinX - r * 0.7 - labelW, y: pinY - r * 0.7 - labelH, anchor: 'top-left', dist: r * 1.2 });

    const extDist = [r * 2, r * 3, r * 4];
    extDist.forEach(d => {
      candidates.push({ x: pinX + d, y: pinY - labelH/2, anchor: 'right', dist: d });
      candidates.push({ x: pinX - d - labelW, y: pinY - labelH/2, anchor: 'left', dist: d });
      candidates.push({ x: pinX - labelW/2, y: pinY + d, anchor: 'bottom', dist: d });
      candidates.push({ x: pinX - labelW/2, y: pinY - d - labelH, anchor: 'top', dist: d });
    });

    return candidates;
  }

  function mb_rectOverlapArea(r1, r2) {
    const xOverlap = Math.max(0, Math.min(r1.right, r2.right) - Math.max(r1.left, r2.left));
    const yOverlap = Math.max(0, Math.min(r1.bottom, r2.bottom) - Math.max(r1.top, r2.top));
    return xOverlap * yOverlap;
  }

  function mb_closestPointOnRect(rect, px, py) {
    const x = Math.max(rect.left, Math.min(px, rect.right));
    const y = Math.max(rect.top, Math.min(py, rect.bottom));
    return { x, y };
  }

  // ─── MAP STYLE ───
  window.mb_changeMapStyle = function() {
    const style = document.getElementById('mb-mapStyle').value;
    if (_mbTileLayer) window._mbMap.removeLayer(_mbTileLayer);
    _mbTileLayer = L.tileLayer(MB_TILE_URLS[style] || MB_TILE_URLS.clean, {
      attribution: '© OpenStreetMap © CARTO',
      maxZoom: 19
    }).addTo(window._mbMap);
  };

  // ─── MAP CONTROLS ───
  window.mb_fitAllPins = function() {
    const points = [];
    if (_mbMainProperty) points.push([_mbMainProperty.lat, _mbMainProperty.lng]);
    _mbPois.forEach(p => points.push([p.lat, p.lng]));
    if (points.length === 0) return;
    if (points.length === 1) {
      window._mbMap.setView(points[0], 15);
    } else {
      window._mbMap.fitBounds(L.latLngBounds(points), { padding: [60, 60] });
    }
  };

  window.mb_resetView = function() {
    if (_mbMainProperty) {
      window._mbMap.setView([_mbMainProperty.lat, _mbMainProperty.lng], 15);
    }
  };

  // ─── EXPORT ───
  window.mb_exportPNG = async function() {
    if (!_mbMainProperty && _mbPois.length === 0) {
      return mb_toast('Keine Daten zum Exportieren', 'error');
    }

    const overlay = document.createElement('div');
    overlay.className = 'mb-export-overlay';
    overlay.innerHTML = '<div class="mb-spinner"></div><div class="mb-export-text">Exportiere Karte…</div>';
    document.getElementById('view-map-builder').appendChild(overlay);

    try {
      await mb_waitForTiles();
      await mb_sleep(300);

      const sidebar = document.getElementById('mb-sidebar');
      const controls = document.querySelector('#view-map-builder .mb-map-controls');
      const zoomCtrl = document.querySelector('#view-map-builder .leaflet-control-zoom');
      const attrCtrl = document.querySelector('#view-map-builder .leaflet-control-attribution');

      sidebar.style.display = 'none';
      if (controls) controls.style.display = 'none';
      if (zoomCtrl) zoomCtrl.style.display = 'none';
      if (attrCtrl) attrCtrl.style.display = 'none';

      const mapArea = document.getElementById('mb-mapArea');
      const mapInner = document.getElementById('mb-mapInner');
      const layout = document.querySelector('#view-map-builder .mb-layout');
      layout.style.height = '100vh';
      mapArea.style.position = 'fixed';
      mapArea.style.inset = '0';
      mapArea.style.zIndex = '5000';
      if (mapInner) { mapInner.style.width = '100%'; mapInner.style.height = '100%'; mapInner.style.maxHeight = 'none'; mapInner.style.aspectRatio = 'auto'; }

      window._mbMap.invalidateSize();
      await mb_sleep(400);
      mb_updateLabels();
      await mb_sleep(200);

      const canvas = await html2canvas(mapArea, {
        useCORS: true, allowTaint: true, scale: 2,
        backgroundColor: '#ffffff', logging: false,
        imageTimeout: 15000,
        width: mapArea.offsetWidth, height: mapArea.offsetHeight,
      });

      sidebar.style.display = '';
      if (controls) controls.style.display = '';
      if (zoomCtrl) zoomCtrl.style.display = '';
      if (attrCtrl) attrCtrl.style.display = '';
      layout.style.height = '';
      mapArea.style.position = '';
      mapArea.style.inset = '';
      mapArea.style.zIndex = '';
      if (mapInner) { mapInner.style.width = ''; mapInner.style.height = ''; mapInner.style.maxHeight = ''; mapInner.style.aspectRatio = ''; }

      window._mbMap.invalidateSize();
      await mb_sleep(100);
      mb_updateLabels();

      canvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `immobilien-karte-${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        mb_toast('PNG exportiert!', 'success');
      }, 'image/png', 1.0);

    } catch (e) {
      console.error('MB Export failed:', e);
      mb_toast('Export fehlgeschlagen: ' + e.message, 'error');

      document.getElementById('mb-sidebar').style.display = '';
      const c = document.querySelector('#view-map-builder .mb-map-controls');
      if (c) c.style.display = '';
      const l = document.querySelector('#view-map-builder .mb-layout');
      l.style.height = '';
      const ma = document.getElementById('mb-mapArea');
      ma.style.position = ''; ma.style.inset = ''; ma.style.zIndex = '';
      const mi = document.getElementById('mb-mapInner');
      if (mi) { mi.style.width = ''; mi.style.height = ''; mi.style.maxHeight = ''; mi.style.aspectRatio = ''; }
      window._mbMap.invalidateSize();
      mb_updateLabels();
    } finally {
      overlay.remove();
    }
  };

  window.mb_printMap = function() { window.print(); };

  function mb_waitForTiles() {
    return new Promise(resolve => {
      let checks = 0;
      const check = () => {
        const tiles = document.querySelectorAll('#view-map-builder .leaflet-tile');
        const loading = Array.from(tiles).some(t => !t.complete || t.naturalHeight === 0);
        if (!loading || checks > 30) resolve();
        else { checks++; setTimeout(check, 100); }
      };
      setTimeout(check, 100);
    });
  }

  // ─── SUPABASE PERSISTENCE ───
  async function mb_sbFetch(path, opts) {
    opts = opts || {};
    const res = await fetch(`${SB_URL}/rest/v1/${path}`, {
      ...opts,
      headers: {
        'apikey': SB_KEY,
        'Authorization': `Bearer ${SB_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': opts.prefer || 'return=representation',
        ...opts.headers
      }
    });
    if (!res.ok && opts.method !== 'DELETE') {
      const errBody = await res.text().catch(() => '');
      throw new Error(`Supabase ${opts.method || 'GET'} ${path} failed (${res.status}): ${errBody}`);
    }
    return res;
  }

  // ─── FINDER / OVERVIEW ───
  window.mb_showFinder = function() {
    document.getElementById('mb-finder').style.display = '';
    document.getElementById('mb-editor-wrapper').style.display = 'none';
    mb_loadFinderList();
  };

  window.mb_showEditor = function() {
    document.getElementById('mb-finder').style.display = 'none';
    document.getElementById('mb-editor-wrapper').style.display = '';
    if (window._mbMap) {
      setTimeout(() => { window._mbMap.invalidateSize(); mb_updateLabels(); }, 150);
    }
    mb_updateEditorTitle();
  };

  function mb_updateEditorTitle() {
    const name = document.getElementById('mb-mapName').value.trim();
    document.getElementById('mb-editor-title').textContent = name || 'Neue Karte';
  }

  // Listen for name changes
  setTimeout(() => {
    const nameInput = document.getElementById('mb-mapName');
    if (nameInput) nameInput.addEventListener('input', mb_updateEditorTitle);
  }, 200);

  window.mb_newMap = function() {
    mb_clearAll();
    _mbCurrentMapId = null;
    document.getElementById('mb-mapName').value = '';
    document.getElementById('mb-propertyAddress').value = '';
    mb_showEditor();
  };

  window.mb_loadFinderList = async function() {
    const container = document.getElementById('mb-finder-list');
    container.innerHTML = '<div style="text-align:center;padding:40px"><span class="mb-spinner"></span></div>';

    try {
      const res = await mb_sbFetch('property_maps?order=updated_at.desc&limit=50', { method: 'GET' });
      const maps = await res.json();

      if (!maps || maps.length === 0) {
        container.innerHTML = `<div class="mb-finder-empty" style="grid-column:1/-1">
          <div class="mb-finder-empty-icon">🗺️</div>
          <div class="mb-finder-empty-text">Noch keine Karten erstellt</div>
          <div class="mb-finder-empty-hint">Klicke oben auf "➕ Neue Map erstellen" um loszulegen.</div>
        </div>`;
        return;
      }

      // Fetch POI counts for all maps in one query
      let poiCounts = {};
      try {
        const poiCountRes = await mb_sbFetch('map_pois?select=map_id', { method: 'GET' });
        const allPois = await poiCountRes.json();
        if (Array.isArray(allPois)) {
          allPois.forEach(p => { poiCounts[p.map_id] = (poiCounts[p.map_id] || 0) + 1; });
        }
      } catch(e) { /* ignore count errors */ }

      let html = '';
      maps.forEach(m => {
        const date = new Date(m.updated_at || m.created_at).toLocaleDateString('de-DE', { day: '2-digit', month: 'short', year: 'numeric' });
        const count = poiCounts[m.id] || 0;
        html += `<div class="mb-finder-card" onclick="mb_loadMap('${m.id}')">
          <div class="mb-finder-card-name">${mb_escapeHtml(m.name)}</div>
          <div class="mb-finder-card-address">📍 ${mb_escapeHtml(m.property_address || 'Keine Adresse')}</div>
          <div class="mb-finder-card-meta">
            <span>${date}</span>
            <span class="mb-finder-card-pois">${count} POI${count !== 1 ? 's' : ''}</span>
          </div>
          <div class="mb-finder-card-actions">
            <button class="mb-btn mb-btn-sm" onclick="event.stopPropagation();mb_loadMap('${m.id}')" style="flex:1">📝 Bearbeiten</button>
            <button class="mb-btn mb-btn-sm mb-btn-danger" onclick="event.stopPropagation();mb_deleteMapFromFinder('${m.id}')" title="Löschen">✕</button>
          </div>
        </div>`;
      });
      container.innerHTML = html;
    } catch (e) {
      console.error('Finder load failed:', e);
      container.innerHTML = `<div class="mb-finder-empty" style="grid-column:1/-1">
        <div class="mb-finder-empty-text">Fehler beim Laden: ${mb_escapeHtml(e.message)}</div>
      </div>`;
    }
  };

  window.mb_deleteMapFromFinder = async function(id) {
    if (!confirm('Karte wirklich löschen?')) return;
    try {
      await mb_sbFetch(`map_pois?map_id=eq.${id}`, { method: 'DELETE' });
      await mb_sbFetch(`property_maps?id=eq.${id}`, { method: 'DELETE' });
      if (_mbCurrentMapId === id) {
        mb_clearAll();
        _mbCurrentMapId = null;
      }
      mb_loadFinderList();
      mb_toast('Karte gelöscht', 'success');
    } catch (e) {
      mb_toast('Löschen fehlgeschlagen', 'error');
    }
  };

  // ─── SAVE MAP ───
  window.mb_saveMap = async function() {
    const name = document.getElementById('mb-mapName').value.trim();
    if (!name) return mb_toast('Bitte Kartennamen eingeben', 'error');
    if (!_mbMainProperty) return mb_toast('Bitte zuerst eine Objekt-Adresse eingeben', 'error');

    const btn = document.getElementById('mb-btnSave');
    btn.innerHTML = '<span class="mb-spinner"></span>';
    btn.disabled = true;

    try {
      const mapData = {
        name,
        property_address: _mbMainProperty.address,
        property_lat: _mbMainProperty.lat,
        property_lng: _mbMainProperty.lng,
        zoom_level: window._mbMap.getZoom(),
        map_style: document.getElementById('mb-mapStyle').value,
        updated_at: new Date().toISOString()
      };

      let mapId = _mbCurrentMapId;

      if (_mbCurrentMapId) {
        // Update existing map
        console.log('MB SAVE: Updating existing map', _mbCurrentMapId, mapData);
        await mb_sbFetch(`property_maps?id=eq.${_mbCurrentMapId}`, { method: 'PATCH', body: JSON.stringify(mapData) });
        // Delete old POIs, re-insert all
        await mb_sbFetch(`map_pois?map_id=eq.${_mbCurrentMapId}`, { method: 'DELETE' });
      } else {
        // Create new map
        console.log('MB SAVE: Creating new map', mapData);
        const res = await mb_sbFetch('property_maps', { method: 'POST', body: JSON.stringify(mapData) });
        const data = await res.json();
        console.log('MB SAVE: Create response:', data);
        if (!data || !Array.isArray(data) || data.length === 0 || !data[0].id) {
          throw new Error('Karte erstellt, aber keine ID zurückerhalten. Response: ' + JSON.stringify(data));
        }
        mapId = data[0].id;
        _mbCurrentMapId = mapId;
        console.log('MB SAVE: New map ID:', mapId);
      }

      // Save ALL POIs (including auto-discovered ones)
      console.log(`MB SAVE: Saving ${_mbPois.length} POIs for map ${mapId}`);
      if (_mbPois.length > 0) {
        const poiData = _mbPois.map((poi, i) => ({
          map_id: mapId,
          name: poi.name,
          address: poi.address,
          category: poi.category,
          custom_category_label: poi.custom_category_label || null,
          lat: poi.lat,
          lng: poi.lng,
          pin_color: poi.pin_color || '#525252',
          pin_size: poi.pin_size || 'medium',
          distance_meters: poi.distance_meters || null,
          sort_order: i,
          is_auto_discovered: poi._autoDiscovered ? true : false
        }));
        console.log('MB SAVE: POI data to save:', JSON.stringify(poiData, null, 2));
        try {
          const poiRes = await mb_sbFetch('map_pois', { method: 'POST', body: JSON.stringify(poiData) });
          const savedPois = await poiRes.json();
          console.log(`MB SAVE: Successfully saved ${Array.isArray(savedPois) ? savedPois.length : '?'} POIs`, savedPois);
        } catch (poiErr) {
          console.error('MB SAVE: POI save failed:', poiErr);
          // If is_auto_discovered or custom_category_label column doesn't exist, retry without them
          if (poiErr.message && (poiErr.message.includes('is_auto_discovered') || poiErr.message.includes('custom_category_label'))) {
            console.warn('MB SAVE: Retrying without is_auto_discovered/custom_category_label columns');
            const fallbackData = poiData.map(p => { const { is_auto_discovered, custom_category_label, ...rest } = p; return rest; });
            try {
              await mb_sbFetch('map_pois', { method: 'POST', body: JSON.stringify(fallbackData) });
              console.log('MB SAVE: Fallback POI save succeeded');
            } catch (fallbackErr) {
              console.error('MB SAVE: Fallback POI save also failed:', fallbackErr);
              mb_toast('POIs konnten nicht gespeichert werden: ' + fallbackErr.message, 'error');
              throw fallbackErr;
            }
          } else {
            mb_toast('POIs konnten nicht gespeichert werden: ' + poiErr.message, 'error');
            throw poiErr;
          }
        }
      } else {
        console.log('MB SAVE: No POIs to save');
      }

      mb_updateEditorTitle();
      mb_toast('Karte gespeichert!', 'success');
    } catch (e) {
      console.error('MB Save failed:', e);
      mb_toast('Speichern fehlgeschlagen: ' + e.message, 'error');
    } finally {
      btn.innerHTML = '💾 Speichern';
      btn.disabled = false;
    }
  };

  // ─── SAVE AS (new copy) ───
  window.mb_saveMapAs = async function() {
    const currentName = document.getElementById('mb-mapName').value.trim();
    const newName = prompt('Neuer Kartenname:', currentName ? currentName + ' (Kopie)' : '');
    if (!newName || !newName.trim()) return;

    document.getElementById('mb-mapName').value = newName.trim();
    _mbCurrentMapId = null; // Force create new
    await mb_saveMap();
  };

  // ─── LOAD MAP LIST (legacy, kept for compat) ───
  window.mb_loadMapList = async function() {
    mb_showFinder();
  };

  // ─── LOAD MAP ───
  window.mb_loadMap = async function(id) {
    try {
      console.log(`MB LOAD: Loading map ${id}`);
      const mapRes = await mb_sbFetch(`property_maps?id=eq.${id}`, { method: 'GET' });
      const maps = await mapRes.json();
      console.log('MB LOAD: Map data:', maps);
      if (!maps || !Array.isArray(maps) || maps.length === 0) return mb_toast('Karte nicht gefunden', 'error');
      const mapData = maps[0];

      const poiRes = await mb_sbFetch(`map_pois?map_id=eq.${id}&order=sort_order`, { method: 'GET' });
      const poiData = await poiRes.json();
      console.log(`MB LOAD: Loaded ${Array.isArray(poiData) ? poiData.length : 0} POIs from DB`, poiData);

      mb_clearAll();

      _mbCurrentMapId = id;
      document.getElementById('mb-mapName').value = mapData.name;
      document.getElementById('mb-propertyAddress').value = mapData.property_address;
      document.getElementById('mb-mapStyle').value = mapData.map_style || 'clean';
      mb_changeMapStyle();

      // Restore main property marker
      if (mapData.property_lat && mapData.property_lng) {
        _mbMainProperty = {
          address: mapData.property_address,
          lat: parseFloat(mapData.property_lat),
          lng: parseFloat(mapData.property_lng),
          marker: null
        };
        _mbMainProperty.marker = mb_createMainMarker(_mbMainProperty.lat, _mbMainProperty.lng);
        _mbMainProperty.marker.addTo(window._mbMap);

        document.getElementById('mb-propertyVerified').style.display = 'flex';
        document.getElementById('mb-propertyCoords').textContent = `${_mbMainProperty.lat.toFixed(5)}, ${_mbMainProperty.lng.toFixed(5)}`;
        document.getElementById('mb-autoPoiSection').style.display = 'block';
      }

      // Restore ALL POIs (including auto-discovered)
      if (Array.isArray(poiData) && poiData.length > 0) {
        console.log(`MB: Loading ${poiData.length} POIs for map ${id}`);
        poiData.forEach(p => {
          const poi = {
            id: p.id || ('poi-' + Date.now() + '-' + Math.random().toString(36).slice(2,6)),
            name: p.name,
            address: p.address || '',
            category: p.category || 'other',
            custom_category_label: p.custom_category_label || null,
            lat: parseFloat(p.lat),
            lng: parseFloat(p.lng),
            pin_color: p.pin_color || '#525252',
            pin_size: p.pin_size || 'medium',
            distance_meters: p.distance_meters || null,
            sort_order: p.sort_order || 0,
            _autoDiscovered: p.is_auto_discovered || false,
            marker: null
          };
          poi.marker = mb_createPOIMarker(poi);
          poi.marker.addTo(window._mbMap);
          _mbPois.push(poi);
        });
      }

      mb_renderPOIList();

      // Set correct view
      if (mapData.zoom_level && _mbMainProperty) {
        window._mbMap.setView([_mbMainProperty.lat, _mbMainProperty.lng], mapData.zoom_level);
      } else {
        mb_fitAllPins();
      }

      // Show editor, update labels
      mb_showEditor();
      setTimeout(mb_updateLabels, 300);
      mb_toast(`Karte geladen — ${_mbPois.length} POI${_mbPois.length !== 1 ? 's' : ''}`, 'success');
    } catch (e) {
      console.error('MB Load failed:', e);
      mb_toast('Laden fehlgeschlagen: ' + e.message, 'error');
    }
  };

  window.mb_deleteMap = async function(id) {
    if (!confirm('Karte wirklich löschen?')) return;
    try {
      await mb_sbFetch(`map_pois?map_id=eq.${id}`, { method: 'DELETE' });
      await mb_sbFetch(`property_maps?id=eq.${id}`, { method: 'DELETE' });
      if (_mbCurrentMapId === id) {
        mb_clearAll();
        _mbCurrentMapId = null;
      }
      mb_loadFinderList();
      mb_toast('Karte gelöscht', 'success');
    } catch (e) {
      mb_toast('Löschen fehlgeschlagen', 'error');
    }
  };

  function mb_clearAll() {
    if (_mbMainProperty && _mbMainProperty.marker) window._mbMap.removeLayer(_mbMainProperty.marker);
    _mbPois.forEach(p => { if (p.marker) window._mbMap.removeLayer(p.marker); });

    _mbMainProperty = null;
    _mbPois = [];
    _mbCurrentMapId = null;

    document.getElementById('mb-propertyVerified').style.display = 'none';
    document.getElementById('mb-autoPoiSection').style.display = 'none';
    document.getElementById('mb-propertyAddress').value = '';
    document.getElementById('mb-mapName').value = '';

    mb_renderPOIList();
    mb_updateLabels();
  }

  // ─── AUTO-POI DISCOVERY ───
  const MB_OVERPASS_URL = 'https://overpass-api.de/api/interpreter';

  // Overpass tag definitions for each POI type (only essential categories)
  const MB_OVERPASS_QUERIES = [
    { key: 'supermarket',  category: 'supermarket', label: null,         tags: '[shop=supermarket]',          maxDist: null },
    { key: 'doctor',       category: 'doctor',      label: null,         tags: '[amenity=doctors]',           maxDist: null },
    { key: 'school',       category: 'school',      label: null,         tags: '[amenity=school]',            maxDist: null },
    { key: 'kindergarten', category: 'school',      label: 'Kita',       tags: '[amenity=kindergarten]',      maxDist: null },
    { key: 'bus_stop',     category: 'transport',   label: null,         tags: '[highway=bus_stop]',          maxDist: null },
    { key: 'fitness',      category: 'pool',        label: 'Fitness',    tags: '[leisure=fitness_centre]',    maxDist: null },
    { key: 'park',         category: 'park',        label: null,         tags: '[leisure=park]',              maxDist: null },
  ];

  // Keys that have extended distance thresholds for outlier filtering
  const MB_EXTENDED_DISTANCE_KEYS = new Set([]);

  function mb_buildOverpassQuery(lat, lng, radius) {
    // Build a single combined Overpass query for efficiency
    let nwr = '';
    MB_OVERPASS_QUERIES.forEach(q => {
      if (q.key === 'doctor') {
        // Only Hausärzte: general practitioners or no speciality tag
        nwr += `nwr[amenity=doctors]["healthcare:speciality"="general"](around:${radius},${lat},${lng});`;
        nwr += `nwr[amenity=doctors][!"healthcare:speciality"](around:${radius},${lat},${lng});`;
      } else {
        const r = q.maxDist ? Math.max(radius, q.maxDist) : radius;
        nwr += `nwr${q.tags}(around:${r},${lat},${lng});`;
      }
    });
    // Also query for S-Bahn, U-Bahn specifically (preferred over bus)
    const sBahnR = Math.max(radius, 2000);
    nwr += `nwr[railway=station][station=light_rail](around:${sBahnR},${lat},${lng});`;
    nwr += `nwr[station=subway](around:${sBahnR},${lat},${lng});`;

    return `[out:json][timeout:25];(${nwr});out center;`;
  }

  function mb_classifyOverpassResult(element, propLat, propLng) {
    const tags = element.tags || {};
    const lat = element.lat || (element.center && element.center.lat);
    const lng = element.lon || (element.center && element.center.lon);
    if (!lat || !lng) return null;

    const dist = mb_haversineDistance(propLat, propLng, lat, lng);

    const results = [];

    // Supermarket — always display as "Supermarkt"
    if (tags.shop === 'supermarket') {
      results.push({ key: 'supermarket', category: 'supermarket', label: null, name: 'Supermarkt', lat, lng, dist });
    }
    // Doctor — only Hausärzte (general or no speciality), display as "Arzt"
    if (tags.amenity === 'doctors') {
      const spec = tags['healthcare:speciality'] || '';
      if (!spec || spec === 'general') {
        results.push({ key: 'doctor', category: 'doctor', label: null, name: 'Arzt', lat, lng, dist });
      }
    }
    // School — display as "Schule"
    if (tags.amenity === 'school') {
      results.push({ key: 'school', category: 'school', label: null, name: 'Schule', lat, lng, dist });
    }
    // Kindergarten — display as "Kita"
    if (tags.amenity === 'kindergarten') {
      results.push({ key: 'kindergarten', category: 'school', label: 'Kita', name: 'Kita', lat, lng, dist });
    }
    // S-Bahn — preferred transport, display as "S-Bahn"
    if (tags.railway === 'station' && (tags.station === 'light_rail' || (tags.name && /\bS[\s\-]/.test(tags.name)))) {
      results.push({ key: 'sbahn', category: 'transport', label: 'S-Bahn', name: 'S-Bahn', lat, lng, dist });
    }
    // U-Bahn — preferred transport, display as "U-Bahn"
    if (tags.station === 'subway' || (tags.railway === 'station' && tags.name && /\bU[\s\-]/.test(tags.name))) {
      results.push({ key: 'ubahn', category: 'transport', label: 'U-Bahn', name: 'U-Bahn', lat, lng, dist });
    }
    // Bus stop — fallback transport, display as "Bus"
    if (tags.highway === 'bus_stop') {
      results.push({ key: 'bus_stop', category: 'transport', label: 'Bus', name: 'Bus', lat, lng, dist });
    }
    // Fitness — display as "Fitness"
    if (tags.leisure === 'fitness_centre') {
      results.push({ key: 'fitness', category: 'pool', label: 'Fitness', name: 'Fitness', lat, lng, dist });
    }
    // Park — only named parks, display as "Park"
    if (tags.leisure === 'park' && tags.name) {
      results.push({ key: 'park', category: 'park', label: null, name: 'Park', lat, lng, dist });
    }

    return results.length > 0 ? results : null;
  }

  function mb_medianValue(arr) {
    if (arr.length === 0) return 0;
    const sorted = [...arr].sort((a, b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
  }

  function mb_filterAndLimitPois(classified) {
    if (classified.length === 0) return [];

    // Remove POIs with no meaningful name (shouldn't happen now with category names, but safety)
    let filtered = classified.filter(p => p.name && p.name.trim().length > 0);

    // Enforce minimum 50m distance between POIs of the same key
    const kept = [];
    filtered.forEach(p => {
      const tooClose = kept.some(k => k.key === p.key && mb_haversineDistance(k.lat, k.lng, p.lat, p.lng) < 50);
      if (!tooClose) kept.push(p);
    });
    filtered = kept;

    // Compute median distance for outlier filtering
    const distances = filtered.map(p => p.dist);
    const median = mb_medianValue(distances);
    const outlierThreshold = median * 3;

    filtered = filtered.filter(p => p.dist <= outlierThreshold || p.dist <= 2000);

    // ÖPNV: prefer U-Bahn/S-Bahn over Bus
    const hasUBahn = filtered.some(p => p.key === 'ubahn');
    const hasSBahn = filtered.some(p => p.key === 'sbahn');
    const hasRail = hasUBahn || hasSBahn;

    // Group by key, take closest 1 per key
    const byKey = {};
    filtered.forEach(p => {
      if (!byKey[p.key]) byKey[p.key] = [];
      byKey[p.key].push(p);
    });

    let result = [];
    Object.keys(byKey).forEach(key => {
      // Skip bus if we already have U-Bahn or S-Bahn
      if (key === 'bus_stop' && hasRail) return;
      const sorted = byKey[key].sort((a, b) => a.dist - b.dist);
      result.push(sorted[0]); // Only the closest 1 per key
    });

    // Deduplicate: no two POIs with same name AND same category
    const seenNameCat = new Set();
    result = result.filter(p => {
      const uid = p.name + '|' + p.category;
      if (seenNameCat.has(uid)) return false;
      seenNameCat.add(uid);
      return true;
    });

    // Sort by distance, limit to 7
    result.sort((a, b) => a.dist - b.dist);
    if (result.length > 7) result = result.slice(0, 7);

    return result;
  }

  window.mb_autoDiscoverPOIs = async function() {
    if (!_mbMainProperty) {
      return mb_toast('Bitte zuerst eine Adresse eingeben', 'error');
    }

    const btn = document.getElementById('mb-btnAutoPoi');
    const statusDiv = document.getElementById('mb-autoPoiStatus');
    const statusText = document.getElementById('mb-autoPoiStatusText');

    btn.disabled = true;
    btn.innerHTML = '<span class="mb-spinner" style="margin-right:6px;"></span> Suche läuft...';
    statusDiv.style.display = 'flex';
    statusDiv.style.alignItems = 'center';
    statusDiv.style.justifyContent = 'center';
    statusText.textContent = 'Suche POIs in der Umgebung...';

    const lat = _mbMainProperty.lat;
    const lng = _mbMainProperty.lng;

    try {
      // First try with 1000m radius
      let radius = 1000;
      let query = mb_buildOverpassQuery(lat, lng, radius);

      statusText.textContent = 'Suche POIs im Umkreis von 1 km...';
      let response = await fetch(MB_OVERPASS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'data=' + encodeURIComponent(query)
      });

      if (!response.ok) throw new Error('Overpass API Fehler: ' + response.status);
      let data = await response.json();
      let elements = data.elements || [];

      // Classify all results
      let classified = [];
      elements.forEach(el => {
        const results = mb_classifyOverpassResult(el, lat, lng);
        if (results) classified.push(...results);
      });

      // Deduplicate by name+key (same POI can appear as node and way)
      const seen = new Set();
      classified = classified.filter(p => {
        const uid = p.key + '|' + p.name + '|' + p.lat.toFixed(4) + '|' + p.lng.toFixed(4);
        if (seen.has(uid)) return false;
        seen.add(uid);
        return true;
      });

      // If too few results, expand radius
      if (classified.length < 4) {
        statusText.textContent = 'Wenige Ergebnisse — erweitere Suche auf 2 km...';
        radius = 2000;
        query = mb_buildOverpassQuery(lat, lng, radius);

        response = await fetch(MB_OVERPASS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'data=' + encodeURIComponent(query)
        });

        if (!response.ok) throw new Error('Overpass API Fehler: ' + response.status);
        data = await response.json();
        elements = data.elements || [];

        classified = [];
        elements.forEach(el => {
          const results = mb_classifyOverpassResult(el, lat, lng);
          if (results) classified.push(...results);
        });

        const seen2 = new Set();
        classified = classified.filter(p => {
          const uid = p.key + '|' + p.name + '|' + p.lat.toFixed(4) + '|' + p.lng.toFixed(4);
          if (seen2.has(uid)) return false;
          seen2.add(uid);
          return true;
        });
      }

      // Apply smart filtering and limits
      const finalPois = mb_filterAndLimitPois(classified);

      if (finalPois.length === 0) {
        mb_toast('Keine POIs in der Umgebung gefunden', 'error');
        statusDiv.style.display = 'none';
        btn.innerHTML = '🔍 POIs automatisch finden';
        btn.disabled = false;
        return;
      }

      // Remove previous auto-discovered POIs (keep manual ones)
      _mbPois = _mbPois.filter(p => {
        if (p._autoDiscovered) {
          if (p.marker) window._mbMap.removeLayer(p.marker);
          return false;
        }
        return true;
      });

      // Add new auto-discovered POIs
      statusText.textContent = `${finalPois.length} POIs gefunden — füge hinzu...`;

      finalPois.forEach(p => {
        const catInfo = MB_CATEGORIES[p.category] || MB_CATEGORIES.other;
        const poi = {
          id: 'poi-auto-' + Date.now() + '-' + Math.random().toString(36).slice(2, 6),
          name: p.name,
          address: `${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}`,
          category: p.category,
          custom_category_label: p.label,
          lat: p.lat,
          lng: p.lng,
          pin_color: catInfo.color,
          pin_size: 'medium',
          distance_meters: Math.round(p.dist),
          sort_order: _mbPois.length,
          marker: null,
          _autoDiscovered: true
        };

        poi.marker = mb_createPOIMarker(poi);
        poi.marker.addTo(window._mbMap);
        _mbPois.push(poi);
      });

      mb_renderPOIList();
      mb_updateLabels();
      mb_fitAllPins();

      // Update button to show re-search option
      btn.innerHTML = '🔄 Neu suchen';
      btn.style.background = 'var(--bg-card)';
      btn.style.color = 'var(--text-primary)';
      btn.style.border = '1px solid var(--border)';

      statusDiv.style.display = 'none';
      mb_toast(`${finalPois.length} POIs automatisch gefunden!`, 'success');

    } catch (e) {
      console.error('Auto-POI Discovery failed:', e);
      mb_toast('Fehler bei POI-Suche: ' + e.message, 'error');
      statusDiv.style.display = 'none';
      btn.innerHTML = '🔍 POIs automatisch finden';
    } finally {
      btn.disabled = false;
    }
  };

})();

// ============================================
// VIEW-AWARE PRINT (beforeprint / afterprint)
// ============================================
(function() {
  function getPrintClass() {
    // currentView is the global state variable set by showView()
    if (typeof currentView !== 'undefined') {
      if (currentView === 'clients') {
        // Check if editorial planner sub-view is active
        var epView = document.getElementById('view-editorial-planner');
        if (epView && (epView.classList.contains('active') || getComputedStyle(epView).display !== 'none')) {
          return 'print-editorial';
        }
      }
      if (currentView === 'map-builder') {
        return 'print-map';
      }
    }
    // Fallback: check which view is actually visible
    var epEl = document.getElementById('view-editorial-planner');
    if (epEl && epEl.classList.contains('active')) return 'print-editorial';
    var mapEl = document.getElementById('view-map-builder');
    if (mapEl && mapEl.classList.contains('active')) return 'print-map';
    // Default: editorial (preserves legacy behavior)
    return 'print-editorial';
  }

  window.addEventListener('beforeprint', function() {
    var cls = getPrintClass();
    document.body.classList.add(cls);
    document.body.dataset.printMode = cls;
  });

  window.addEventListener('afterprint', function() {
    var cls = document.body.dataset.printMode;
    if (cls) {
      document.body.classList.remove(cls);
      delete document.body.dataset.printMode;
    }
  });
})();
</script>

<!-- Creative preview modal removed - thumbnails too low-res, click goes to campaign instead -->

<!-- Ad Detail Modal -->
<div id="comp-ad-detail-modal" class="ad-detail-overlay" onclick="if(event.target===this)closeAdDetailModal()">
  <div class="ad-detail-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <h3 id="ad-detail-title" style="font-size:16px;font-weight:700;margin:0;"></h3>
      <button onclick="closeAdDetailModal()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer;padding:4px 8px;">✕</button>
    </div>
    <div id="ad-detail-preview" style="margin-bottom:20px;border-radius:8px;overflow:hidden;"></div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;" id="ad-detail-stats"></div>
    <div id="ad-detail-text" style="margin-bottom:20px;font-size:13px;line-height:1.6;color:var(--text-muted);white-space:pre-wrap;"></div>
    <div id="ad-detail-variants"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;">
      <a id="ad-detail-snapshot-link" href="#" target="_blank" class="btn btn-primary btn-sm">🔍 Ad in Meta Library ansehen</a>
    </div>
  </div>
</div>

</body>
</html>
