<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Run & Gun ‚Äî Campaign Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: #16161f;
      --bg-card-hover: #1c1c28;
      --bg-input: #1a1a26;
      --border: #262636;
      --border-focus: #4f46e5;
      --text-primary: #f0f0f5;
      --text-secondary: #8888a0;
      --text-muted: #555570;
      --accent: #6366f1;
      --accent-light: #818cf8;
      --accent-dark: #4f46e5;
      --green: #22c55e;
      --green-muted: #166534;
      --red: #ef4444;
      --red-muted: #7f1d1d;
      --orange: #f59e0b;
      --orange-muted: #78350f;
      --blue: #3b82f6;
      --cyan: #06b6d4;
      --gold: #fbbf24;
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --shadow: 0 4px 24px rgba(0,0,0,0.3);
      --shadow-lg: 0 8px 48px rgba(0,0,0,0.5);
      --transition: 180ms ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Top Nav */
    .topnav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: rgba(10, 10, 15, 0.85);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      z-index: 100;
    }

    .topnav-brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .topnav-logo {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      object-fit: cover;
    }

    .topnav-title {
      font-weight: 700;
      font-size: 16px;
      letter-spacing: -0.02em;
    }

    .topnav-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 400;
    }

    .topnav-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }
    .btn-primary:hover { background: var(--accent-light); transform: translateY(-1px); }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--bg-card-hover); border-color: var(--text-muted); }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
    }
    .btn-ghost:hover { color: var(--text-primary); background: var(--bg-card); }
    .btn-ghost.active { color: var(--accent-light); background: rgba(99, 102, 241, 0.1); }

    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-icon { padding: 8px; }

    /* Main Content */
    .main {
      padding-top: 64px;
      min-height: 100vh;
    }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 32px;
    }

    /* Page Header */
    .page-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 32px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .page-title {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.03em;
      line-height: 1.2;
    }

    .page-subtitle {
      color: var(--text-secondary);
      font-size: 14px;
      margin-top: 4px;
    }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .kpi-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: all var(--transition);
    }

    .kpi-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .kpi-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.03em;
      line-height: 1;
    }

    .kpi-unit {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-left: 4px;
    }

    .kpi-change {
      font-size: 12px;
      font-weight: 600;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .kpi-change.positive { color: var(--green); }
    .kpi-change.negative { color: var(--red); }
    .kpi-change.neutral { color: var(--text-muted); }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .card-body { padding: 24px; }

    /* Chart containers */
    .chart-container {
      position: relative;
      width: 100%;
      height: 320px;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 32px;
    }

    @media (max-width: 900px) {
      .charts-grid { grid-template-columns: 1fr; }
    }

    /* Campaign List */
    .campaign-table {
      width: 100%;
      border-collapse: collapse;
    }

    .campaign-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
    }

    .campaign-table td {
      padding: 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    .campaign-table tbody tr {
      cursor: pointer;
      transition: background var(--transition);
    }

    .campaign-table tbody tr:hover {
      background: var(--bg-card-hover);
    }

    .campaign-table tbody tr:last-child td {
      border-bottom: none;
    }

    .campaign-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .campaign-property {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    /* Status badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .badge-active {
      background: rgba(34, 197, 94, 0.1);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .badge-paused {
      background: rgba(245, 158, 11, 0.1);
      color: var(--orange);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .badge-completed {
      background: rgba(99, 102, 241, 0.1);
      color: var(--accent-light);
      border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Value formatting */
    .value-eur { font-variant-numeric: tabular-nums; }
    .value-good { color: var(--green); }
    .value-bad { color: var(--red); }
    .value-neutral { color: var(--text-secondary); }

    /* Forms */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group.full-width { grid-column: 1 / -1; }

    .form-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .form-input, .form-select {
      padding: 10px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      transition: border-color var(--transition);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .form-input::placeholder { color: var(--text-muted); }

    .form-select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .form-section-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      grid-column: 1 / -1;
    }

    .form-actions {
      grid-column: 1 / -1;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 16px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    /* Back button */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 16px;
      cursor: pointer;
      transition: color var(--transition);
    }

    .back-link:hover { color: var(--text-primary); }

    /* Creative cards */
    .creative-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .creative-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: all var(--transition);
      position: relative;
    }

    .creative-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .creative-card.winner {
      border-color: var(--gold);
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.1);
    }

    .creative-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .creative-card-name {
      font-weight: 600;
      font-size: 14px;
    }

    .creative-card-type {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .creative-card-badge {
      font-size: 20px;
      margin-right: 6px;
    }

    .creative-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .creative-stat-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .creative-stat-value {
      font-size: 18px;
      font-weight: 700;
      margin-top: 2px;
    }

    /* Score display */
    .score-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 700;
      background: rgba(99, 102, 241, 0.1);
      color: var(--accent-light);
      border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .score-badge.top { 
      background: rgba(251, 191, 36, 0.1); 
      color: var(--gold); 
      border-color: rgba(251, 191, 36, 0.3); 
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 80px 40px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .empty-state-desc {
      font-size: 14px;
      max-width: 400px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* Setup banner */
    .setup-banner {
      background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(6,182,212,0.1));
      border: 1px solid rgba(99,102,241,0.2);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 32px;
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    .setup-banner-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .setup-banner-content h3 {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .setup-banner-content p {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .setup-banner-content code {
      background: var(--bg-input);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      color: var(--accent-light);
    }

    /* Loading */
    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Notification toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 20px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      transform: translateY(120%);
      transition: transform 300ms ease;
      z-index: 200;
    }

    .toast.visible { transform: translateY(0); }
    .toast.success { border-color: var(--green); color: var(--green); }
    .toast.error { border-color: var(--red); color: var(--red); }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0;
    }

    .tab {
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all var(--transition);
    }

    .tab:hover { color: var(--text-secondary); }
    .tab.active { color: var(--accent-light); border-bottom-color: var(--accent); }

    /* Filter bar */
    .filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-bar .form-select, .filter-bar .form-input {
      padding: 8px 12px;
      font-size: 13px;
    }

    /* Intelligence view */
    .intel-section {
      margin-bottom: 40px;
    }

    .intel-section-title {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .intel-ranking-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .intel-type-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      transition: all var(--transition);
      position: relative;
    }

    .intel-type-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .intel-type-card.winner {
      border-color: var(--gold);
      box-shadow: 0 0 24px rgba(251, 191, 36, 0.12);
    }

    .intel-type-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .intel-type-name {
      font-size: 16px;
      font-weight: 700;
    }

    .intel-type-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }

    .intel-stat-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .intel-stat-value {
      font-size: 18px;
      font-weight: 700;
      margin-top: 2px;
    }

    .ranking-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .ranking-tab {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: var(--bg-card);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      transition: all var(--transition);
    }

    .ranking-tab:hover { border-color: var(--text-muted); }
    .ranking-tab.active {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent-light);
      border-color: var(--accent);
    }

    .locked-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 48px;
      text-align: center;
      opacity: 0.7;
    }

    .locked-section .lock-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .locked-section h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text-secondary);
    }

    .locked-section p {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Horizontal bar chart */
    .hbar-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .hbar-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .hbar-label {
      min-width: 120px;
      font-size: 13px;
      font-weight: 600;
      text-align: right;
      flex-shrink: 0;
    }

    .hbar-track {
      flex: 1;
      height: 32px;
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      overflow: hidden;
      position: relative;
    }

    .hbar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      border-radius: var(--radius-sm);
      transition: width 600ms ease;
      display: flex;
      align-items: center;
      padding-left: 10px;
      font-size: 12px;
      font-weight: 700;
      color: white;
      min-width: fit-content;
    }

    .hbar-fill.winner-bar {
      background: linear-gradient(90deg, var(--gold), #f59e0b);
    }

    .hbar-value {
      min-width: 60px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 16px; }
      .topnav { padding: 0 16px; }
      .page-title { font-size: 22px; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .form-grid { grid-template-columns: 1fr; }
      .campaign-table th:nth-child(n+4),
      .campaign-table td:nth-child(n+4) { display: none; }
      .topnav-subtitle { display: none; }
      .intel-ranking-grid { grid-template-columns: 1fr; }
      .hbar-label { min-width: 80px; font-size: 11px; }
    }

    @media (max-width: 480px) {
      .kpi-grid { grid-template-columns: 1fr; }
      .kpi-value { font-size: 24px; }
    }

    /* Benchmark card */
    .benchmark-card {
      background: var(--bg-card);
      border: 1px solid transparent;
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 32px;
      background-clip: padding-box;
      position: relative;
    }
    .benchmark-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: var(--radius);
      padding: 1px;
      background: linear-gradient(135deg, var(--accent), var(--cyan), var(--accent-light));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }
    .benchmark-card .card-header { border-bottom: 1px solid var(--border); }
    .benchmark-card .card-body { padding: 24px; }

    .benchmark-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .benchmark-metric {
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      padding: 14px;
    }
    .benchmark-metric-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .benchmark-metric-value {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .benchmark-metric-compare {
      font-size: 12px;
      font-weight: 600;
    }

    .benchmark-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }
    .benchmark-badge.good {
      background: rgba(34, 197, 94, 0.12);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, 0.25);
    }
    .benchmark-badge.bad {
      background: rgba(239, 68, 68, 0.12);
      color: var(--red);
      border: 1px solid rgba(239, 68, 68, 0.25);
    }
    .benchmark-badge.neutral {
      background: rgba(136, 136, 160, 0.12);
      color: var(--text-secondary);
      border: 1px solid rgba(136, 136, 160, 0.25);
    }

    .benchmark-insights {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .benchmark-insights-title {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--text-secondary);
    }

    .insight-item {
      font-size: 13px;
      color: var(--text-secondary);
      padding: 6px 0;
      line-height: 1.5;
    }
    .insight-item::before {
      content: '‚Ä¢';
      color: var(--accent-light);
      margin-right: 8px;
      font-weight: 700;
    }

    .benchmark-sample-note {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 12px;
      font-style: italic;
    }

    /* Correlation bar */
    .correlation-bar-container {
      margin-bottom: 14px;
    }
    .correlation-bar-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .correlation-bar-track {
      height: 24px;
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      position: relative;
      overflow: hidden;
    }
    .correlation-bar-center {
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--text-muted);
      opacity: 0.4;
    }
    .correlation-bar-fill {
      position: absolute;
      top: 2px;
      bottom: 2px;
      border-radius: 4px;
      transition: all 600ms ease;
    }
    .correlation-bar-fill.positive {
      background: linear-gradient(90deg, rgba(239,68,68,0.3), var(--red));
    }
    .correlation-bar-fill.negative {
      background: linear-gradient(270deg, rgba(34,197,94,0.3), var(--green));
    }
    .correlation-bar-sublabel {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    /* Segment table */
    .segment-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .segment-table th {
      text-align: left;
      padding: 10px 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      background: var(--bg-input);
    }
    .segment-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    .segment-table tbody tr:last-child td { border-bottom: none; }
    .segment-table tbody tr:hover { background: var(--bg-card-hover); }
    .segment-cell-good { color: var(--green); font-weight: 600; }
    .segment-cell-bad { color: var(--red); font-weight: 600; }

    /* Scatter plot container */
    .scatter-container {
      position: relative;
      width: 100%;
      height: 400px;
    }

    /* Data intel sections */
    .data-intel-section {
      margin-bottom: 40px;
    }
    .data-intel-section-title {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .data-intel-warning {
      background: rgba(245, 158, 11, 0.08);
      border: 1px solid rgba(245, 158, 11, 0.25);
      border-radius: var(--radius-sm);
      padding: 10px 16px;
      font-size: 12px;
      color: var(--orange);
      margin-bottom: 20px;
    }
    .data-intel-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .data-intel-grid { grid-template-columns: 1fr; }
    }

    /* View transitions */
    .view { display: none; }
    .view.active { display: block; animation: fadeIn 200ms ease; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Scroll margin for fixed nav */
    .main { scroll-margin-top: 64px; }

    /* CSV Import: Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius-lg);
      background: var(--bg-card);
      padding: 64px 40px;
      text-align: center;
      cursor: pointer;
      transition: all var(--transition);
      position: relative;
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.04);
    }
    .drop-zone.drag-over {
      background: rgba(99, 102, 241, 0.08);
      transform: scale(1.005);
    }
    .drop-zone-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.7; }
    .drop-zone-text { font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
    .drop-zone-hint { font-size: 13px; color: var(--text-muted); }
    .drop-zone input[type="file"] {
      position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
    }

    /* CSV Preview Card */
    .csv-preview {
      background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(6,182,212,0.06));
      border: 1px solid rgba(99,102,241,0.25);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
    }
    .csv-preview-title {
      font-size: 15px; font-weight: 700; margin-bottom: 12px;
      display: flex; align-items: center; gap: 8px;
    }
    .csv-preview-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 6px 24px; font-size: 14px;
    }
    .csv-preview-grid dt { color: var(--text-muted); font-weight: 500; }
    .csv-preview-grid dd { color: var(--text-primary); font-weight: 600; margin: 0; }

    /* CSV Import Loading Overlay */
    .csv-import-overlay {
      position: fixed; inset: 0; background: rgba(10,10,15,0.7);
      display: flex; align-items: center; justify-content: center;
      z-index: 300; backdrop-filter: blur(4px);
    }
    .csv-import-overlay-box {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 40px 48px; text-align: center;
      box-shadow: var(--shadow-lg);
    }
    .csv-import-overlay-box .spinner { margin: 0 auto 16px; }
    .csv-import-overlay-text { font-size: 14px; font-weight: 600; color: var(--text-secondary); }

    /* Manual form toggle link */
    .manual-toggle-link {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 13px; color: var(--text-muted); cursor: pointer;
      margin-top: 24px; transition: color var(--transition);
    }
    .manual-toggle-link:hover { color: var(--text-secondary); }

    /* Predictor layout */
    .predictor-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      align-items: start;
    }
    @media (max-width: 900px) {
      .predictor-layout { grid-template-columns: 1fr; }
    }

    .pred-result-card {
      background: var(--bg-card);
      border: 1px solid transparent;
      border-radius: var(--radius);
      overflow: hidden;
      position: relative;
    }
    .pred-result-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: var(--radius);
      padding: 1px;
      background: linear-gradient(135deg, var(--accent), var(--cyan), var(--gold));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }
    .pred-result-card .card-body { padding: 24px; }

    .pred-section { margin-bottom: 20px; }
    .pred-section:last-child { margin-bottom: 0; }
    .pred-section-title {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .pred-cpl-range {
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -0.03em;
      color: var(--text-primary);
      margin-bottom: 6px;
    }
    .pred-cpl-details {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .pred-stars {
      font-size: 24px;
      letter-spacing: 2px;
    }
    .pred-stars .star-active { color: var(--gold); }
    .pred-stars .star-inactive { color: var(--text-muted); opacity: 0.3; }
    .pred-score-label {
      font-size: 13px;
      font-weight: 600;
      margin-top: 4px;
    }
    .pred-score-green { color: var(--green); }
    .pred-score-yellow-green { color: #a3e635; }
    .pred-score-yellow { color: var(--orange); }
    .pred-score-orange { color: #f97316; }
    .pred-score-red { color: var(--red); }

    .pred-similar-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      font-size: 13px;
    }
    .pred-similar-name { font-weight: 600; }
    .pred-similar-detail { color: var(--text-secondary); }

    .pred-confidence {
      font-size: 12px;
      color: var(--text-muted);
      padding: 10px 14px;
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      line-height: 1.5;
    }

    /* Compare grid */
    .compare-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    @media (max-width: 768px) {
      .compare-grid { grid-template-columns: 1fr; }
    }

    .compare-input-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      position: relative;
    }
    .compare-input-card .form-group { margin-bottom: 12px; }
    .compare-input-card .form-group:last-child { margin-bottom: 0; }
    .compare-card-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 14px;
      color: var(--text-secondary);
    }
    .compare-remove-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      padding: 4px;
      transition: color var(--transition);
    }
    .compare-remove-btn:hover { color: var(--red); }

    .add-property-btn {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      background: transparent;
      color: var(--text-muted);
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      padding: 40px 20px;
      transition: all var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-height: 200px;
    }
    .add-property-btn:hover {
      border-color: var(--accent);
      color: var(--accent-light);
      background: rgba(99, 102, 241, 0.04);
    }

    .comp-ranking {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 24px;
    }
    .comp-ranking-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 18px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      transition: all var(--transition);
    }
    .comp-ranking-item:first-child {
      border-color: var(--gold);
      box-shadow: 0 0 16px rgba(251, 191, 36, 0.08);
    }
    .comp-ranking-medal { font-size: 24px; flex-shrink: 0; }
    .comp-ranking-name { font-weight: 700; font-size: 15px; flex: 1; }
    .comp-ranking-cpl { font-weight: 700; font-size: 15px; }
    .comp-ranking-stars { font-size: 14px; }

    .comp-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-bottom: 24px;
    }
    .comp-table th {
      text-align: left;
      padding: 10px 14px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      background: var(--bg-input);
    }
    .comp-table td {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    .comp-table tbody tr:last-child td { border-bottom: none; }
    .comp-table tbody tr:hover { background: var(--bg-card-hover); }

    .comp-recommendation {
      font-size: 14px;
      font-weight: 600;
      color: var(--green);
      padding: 12px 16px;
      background: rgba(34, 197, 94, 0.08);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: var(--radius-sm);
      margin-bottom: 24px;
    }

    .comp-chart-container {
      position: relative;
      width: 100%;
      height: 250px;
      margin-bottom: 16px;
    }

    /* Advanced Prediction Engine Styles */
    .confidence-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-input);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }
    .confidence-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 600ms ease;
      background: linear-gradient(90deg, var(--red), var(--orange), var(--green));
    }
    .similarity-inline-bar {
      display: inline-block;
      width: 60px;
      height: 6px;
      background: var(--bg-input);
      border-radius: 3px;
      overflow: hidden;
      vertical-align: middle;
      margin-left: 6px;
    }
    .similarity-inline-bar-fill {
      height: 100%;
      border-radius: 3px;
      background: var(--accent-light);
      transition: width 400ms ease;
    }
    .feature-importance-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .feature-importance-bar .fi-label {
      min-width: 100px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-align: right;
      flex-shrink: 0;
    }
    .feature-importance-bar .fi-track {
      flex: 1;
      height: 18px;
      background: var(--bg-input);
      border-radius: 4px;
      overflow: hidden;
    }
    .feature-importance-bar .fi-fill {
      height: 100%;
      border-radius: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      transition: width 500ms ease;
      display: flex;
      align-items: center;
      padding-left: 6px;
      font-size: 10px;
      font-weight: 700;
      color: white;
      min-width: fit-content;
    }
    .feature-importance-bar .fi-pct {
      min-width: 36px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-align: right;
      flex-shrink: 0;
    }
    /* Creative Recommendation Styles */
    .creative-rec-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(38, 38, 54, 0.5);
    }
    .creative-rec-item:last-of-type {
      border-bottom: none;
    }
    .creative-rec-badge {
      font-size: 20px;
      min-width: 28px;
      text-align: center;
      flex-shrink: 0;
    }
    .creative-rec-info {
      flex: 1;
      min-width: 0;
    }
    .creative-rec-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 2px;
    }
    .creative-rec-stats {
      display: flex;
      gap: 14px;
      font-size: 12px;
      color: var(--text-secondary);
      flex-wrap: wrap;
    }
    .creative-rec-stats span {
      white-space: nowrap;
    }
    .creative-rec-bar-wrap {
      width: 100%;
      margin-top: 4px;
    }
    .creative-rec-bar {
      height: 6px;
      background: var(--bg-input);
      border-radius: 3px;
      overflow: hidden;
    }
    .creative-rec-bar-fill {
      height: 100%;
      border-radius: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      transition: width 600ms ease;
    }
    .creative-rec-tip {
      margin-top: 14px;
      padding: 12px 14px;
      background: rgba(99, 102, 241, 0.08);
      border-left: 3px solid var(--accent);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    .creative-rec-tip strong {
      color: var(--text-primary);
    }
    .creative-rec-empty {
      font-size: 13px;
      color: var(--text-muted);
      padding: 10px 0;
    }

    .prediction-main {
      text-align: center;
      padding: 20px 0;
    }
    .prediction-main .pred-cpl-big {
      font-size: 36px;
      font-weight: 800;
      letter-spacing: -0.03em;
      line-height: 1;
    }
    .prediction-main .pred-cpl-big.cpl-green { color: var(--green); }
    .prediction-main .pred-cpl-big.cpl-yellow { color: var(--orange); }
    .prediction-main .pred-cpl-big.cpl-red { color: var(--red); }
    .prediction-main .pred-range-text {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 6px;
    }
    .prediction-breakdown {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .prediction-breakdown .pb-item {
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
    }
    .prediction-breakdown .pb-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .prediction-breakdown .pb-value {
      font-size: 16px;
      font-weight: 700;
    }
    .prediction-section {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .prediction-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .prediction-section-header {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .pred-method-badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
    }
    .pred-method-badge.early {
      background: rgba(245, 158, 11, 0.1);
      color: var(--orange);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    .pred-method-badge.limited {
      background: rgba(99, 102, 241, 0.1);
      color: var(--accent-light);
      border: 1px solid rgba(99, 102, 241, 0.2);
    }
    .pred-method-badge.full {
      background: rgba(34, 197, 94, 0.1);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }
  </style>
</head>
<body>

<!-- Top Navigation -->
<nav class="topnav">
  <div class="topnav-brand">
    <img src="assets/rg-logo.png" alt="R&G" class="topnav-logo">
    <div>
      <div class="topnav-title">Run & Gun</div>
      <div class="topnav-subtitle">Campaign Dashboard</div>
    </div>
  </div>
  <div class="topnav-actions">
    <button class="btn btn-ghost btn-sm" id="nav-campaigns" onclick="showView('campaigns')">
      üìä Kampagnen
    </button>
    <button class="btn btn-ghost btn-sm" id="nav-intelligence" onclick="showView('intelligence')">
      üß† Creative Intelligence
    </button>
    <button class="btn btn-ghost btn-sm" id="nav-data-intel" onclick="showView('data-intel')">üìà Data Intelligence</button>
    <button class="btn btn-ghost btn-sm" id="nav-predictor" onclick="showView('predictor')">üîÆ Prognose</button>
    <button class="btn btn-ghost btn-sm" id="nav-compare" onclick="showView('compare')">‚öñÔ∏è Vergleich</button>
    <button class="btn btn-primary btn-sm" onclick="showView('new-campaign')">
      + Neue Kampagne
    </button>
  </div>
</nav>

<!-- Main Content -->
<div class="main">
  <div class="container">

    <!-- SETUP BANNER (shown when DB not ready) -->
    <div id="setup-banner" class="setup-banner" style="display:none;">
      <div class="setup-banner-icon">‚öôÔ∏è</div>
      <div class="setup-banner-content">
        <h3>Datenbank-Setup erforderlich</h3>
        <p>
          Die Tabellen existieren noch nicht. √ñffne den
          <a href="https://supabase.com/dashboard/project/lvhxabadywdqeepymwdm/sql" target="_blank" style="color:var(--accent-light)">Supabase SQL Editor</a>
          und f√ºhre nacheinander die Dateien <code>migration.sql</code> und <code>seed.sql</code> aus.
        </p>
      </div>
    </div>

    <!-- VIEW: Campaign List -->
    <div id="view-campaigns" class="view active">
      <div class="page-header">
        <div>
          <h1 class="page-title">Kampagnen</h1>
          <div class="page-subtitle">Alle aktiven und abgeschlossenen Kampagnen</div>
        </div>
        <button class="btn btn-primary" onclick="showView('new-campaign')">
          + Neue Kampagne
        </button>
      </div>

      <!-- Filters (platform removed ‚Äî always Meta) -->
      <div class="filter-bar">
        <select class="form-select" id="filter-client" onchange="loadCampaigns()">
          <option value="">Alle Kunden</option>
        </select>
        <select class="form-select" id="filter-status" onchange="loadCampaigns()">
          <option value="">Alle Status</option>
          <option value="active">Aktiv</option>
          <option value="paused">Pausiert</option>
          <option value="completed">Abgeschlossen</option>
        </select>
      </div>

      <!-- Campaign Table -->
      <div class="card">
        <div id="campaigns-loading" class="loading-spinner">
          <div class="spinner"></div>
        </div>
        <table class="campaign-table" id="campaigns-table" style="display:none;">
          <thead>
            <tr>
              <th>Kampagne</th>
              <th>Status</th>
              <th>Spend</th>
              <th>Leads</th>
              <th>CPL</th>
              <th>Zeitraum</th>
            </tr>
          </thead>
          <tbody id="campaigns-tbody"></tbody>
        </table>
        <div id="campaigns-empty" class="empty-state" style="display:none;">
          <div class="empty-state-icon">üì≠</div>
          <div class="empty-state-title">Keine Kampagnen gefunden</div>
          <div class="empty-state-desc">Erstelle eine neue Kampagne oder √§ndere die Filter.</div>
        </div>
      </div>
    </div>

    <!-- VIEW: Campaign Detail -->
    <div id="view-detail" class="view">
      <a class="back-link" onclick="showView('campaigns')">‚Üê Zur√ºck zu Kampagnen</a>

      <div class="page-header">
        <div>
          <h1 class="page-title" id="detail-title">‚Äî</h1>
          <div class="page-subtitle" id="detail-subtitle">‚Äî</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
          <div id="detail-status"></div>
          <button class="btn btn-secondary btn-sm" id="detail-edit-btn" onclick="openEditCampaign()">‚úèÔ∏è Bearbeiten</button>
          <button class="btn btn-secondary btn-sm" onclick="openCSVReimport()">üìä CSV aktualisieren</button>
          <button class="btn btn-sm" style="background:var(--red-muted);color:var(--red);border:1px solid var(--red);" onclick="deleteCampaign()">üóëÔ∏è L√∂schen</button>
          <input type="file" id="reimport-csv-input" accept=".csv" style="display:none" onchange="handleCSVReimport(event)">
        </div>
      </div>

      <!-- Property Details -->
      <div class="card" style="margin-bottom:24px;" id="detail-property-card">
        <div class="card-header">
          <div class="card-title">Objekt-Details</div>
        </div>
        <div class="card-body" id="detail-property-info" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;">
        </div>
      </div>

      <!-- KPI Cards -->
      <div class="kpi-grid" id="detail-kpis"></div>

      <!-- Benchmarks -->
      <div id="detail-benchmarks"></div>

      <!-- Charts -->
      <div class="charts-grid">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Spend & Leads ‚Äî Tagesverlauf</div>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="chart-daily"></canvas>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">CPL ‚Äî Tagesverlauf</div>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="chart-cpl"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Creative Performance -->
      <div class="card" style="margin-bottom:32px;">
        <div class="card-header">
          <div class="card-title">Creative Performance (nach Score)</div>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height:280px;">
            <canvas id="chart-creatives"></canvas>
          </div>
        </div>
      </div>

      <!-- Creative Cards -->
      <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">Creative Details</h3>
      <div class="creative-grid" id="creative-cards"></div>
    </div>

    <!-- VIEW: New Campaign (CSV Import) -->
    <div id="view-new-campaign" class="view">
      <a class="back-link" onclick="showView('campaigns')">‚Üê Zur√ºck zu Kampagnen</a>

      <div class="page-header">
        <div>
          <h1 class="page-title">Neue Kampagne</h1>
          <div class="page-subtitle">Meta Ads CSV importieren oder manuell anlegen</div>
        </div>
      </div>

      <!-- Step 1: CSV Drop Zone -->
      <div id="csv-step-upload">
        <div class="drop-zone" id="drop-zone">
          <input type="file" accept=".csv" id="csv-file-input" onchange="handleCSVFileSelect(event)">
          <div class="drop-zone-icon">üìÅ</div>
          <div class="drop-zone-text">Meta Ads CSV hier ablegen oder klicken</div>
          <div class="drop-zone-hint">CSV-Export aus dem Meta Ads Manager (.csv)</div>
        </div>
      </div>

      <!-- Step 2: CSV Preview + Property Form -->
      <div id="csv-step-preview" style="display:none;">
        <div class="csv-preview" id="csv-preview"></div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Objekt-Daten erg√§nzen</div>
          </div>
          <div class="card-body">
            <form id="csv-import-form" onsubmit="handleCSVImport(event)">
              <div class="form-grid">

                <div class="form-section-title">Kunde</div>

                <div class="form-group">
                  <label class="form-label">Kunde ausw√§hlen</label>
                  <select class="form-select" id="csv-client" onchange="toggleCSVNewClient(this)">
                    <option value="">‚Äî Neuen Kunden anlegen ‚Äî</option>
                  </select>
                </div>

                <div class="form-group" id="csv-new-client-group">
                  <label class="form-label">Kundenname</label>
                  <input class="form-input" id="csv-client-name" placeholder="z.B. Von Poll">
                </div>

                <div class="form-group" id="csv-brand-group">
                  <label class="form-label">Brand / Franchise</label>
                  <input class="form-input" id="csv-client-brand" placeholder="z.B. Von Poll, Engel & V√∂lkers">
                </div>

                <div class="form-section-title">Objekt</div>

                <div class="form-group">
                  <label class="form-label">Objektname *</label>
                  <input class="form-input" id="csv-prop-name" required placeholder="z.B. Bennyweg">
                </div>

                <div class="form-group">
                  <label class="form-label">Adresse</label>
                  <input class="form-input" id="csv-prop-address" placeholder="Stra√üe, Hausnummer">
                </div>

                <div class="form-group">
                  <label class="form-label">PLZ</label>
                  <input class="form-input" id="csv-prop-plz" placeholder="13187">
                </div>

                <div class="form-group">
                  <label class="form-label">Stadtteil</label>
                  <input class="form-input" id="csv-prop-stadtteil" placeholder="Pankow">
                </div>

                <div class="form-group">
                  <label class="form-label">Stadt</label>
                  <input class="form-input" id="csv-prop-city" placeholder="Berlin" oninput="autoFillCityRating('csv-prop-city','csv-prop-location-rating')">
                </div>

                <div class="form-group">
                  <label class="form-label">Standort-Rating</label>
                  <select class="form-select" id="csv-prop-location-rating">
                    <option value="">‚Äî Automatisch ‚Äî</option>
                    <option value="A">A ‚Äî Top-7-Stadt</option>
                    <option value="B">B ‚Äî Gro√üstadt</option>
                    <option value="C">C ‚Äî Mittelstadt / Sonstige</option>
                    <option value="D">D ‚Äî L√§ndlich</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Mikrolage</label>
                  <select class="form-select" id="csv-prop-micro-location">
                    <option value="">‚Äî Keine Angabe ‚Äî</option>
                    <option value="premium">Premium</option>
                    <option value="gut">Gut</option>
                    <option value="standard">Standard</option>
                    <option value="randlage">Randlage</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Objektart</label>
                  <select class="form-select" id="csv-prop-type" onchange="toggleNeubauFields('csv')">
                    <option value="wohnung">Wohnung</option>
                    <option value="haus">Haus</option>
                    <option value="penthouse">Penthouse</option>
                    <option value="villa">Villa</option>
                    <option value="reihenhaus">Reihenhaus</option>
                    <option value="grundstueck">Grundst√ºck</option>
                    <option value="gewerbe">Gewerbe</option>
                    <option value="neubauprojekt">Neubauprojekt</option>
                    <option value="zweifamilienhaus">Zweifamilienhaus</option>
                    <option value="sonstige">Sonstige</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Wohnfl√§che (qm)</label>
                  <input class="form-input" id="csv-prop-size" type="number" step="0.1" placeholder="120">
                </div>

                <div class="form-group">
                  <label class="form-label">Grundst√ºcksgr√∂√üe (qm)</label>
                  <input class="form-input" id="csv-prop-plot-size" type="number" step="0.1">
                </div>

                <div class="form-group">
                  <label class="form-label">Zimmer</label>
                  <input class="form-input" id="csv-prop-rooms" type="number" step="0.5" placeholder="4">
                </div>

                <div class="form-group">
                  <label class="form-label">Angebotspreis (‚Ç¨)</label>
                  <input class="form-input" id="csv-prop-price" type="number" step="1" placeholder="850000">
                </div>

                <div id="csv-neubau-fields" style="display:none; border-top: 1px solid var(--border); padding-top: 12px; margin-top: 12px;">
                  <div class="form-label" style="font-weight:600; margin-bottom:8px; color: var(--primary);">üèóÔ∏è Neubauprojekt-Details</div>
                  <div class="form-group">
                    <label class="form-label">Preis von (‚Ç¨)</label>
                    <input class="form-input" id="csv-prop-price-from" type="number" step="1" placeholder="299000">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Preis bis (‚Ç¨)</label>
                    <input class="form-input" id="csv-prop-price-to" type="number" step="1" placeholder="890000">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Wohnfl√§che von (qm)</label>
                    <input class="form-input" id="csv-prop-size-from" type="number" step="0.1" placeholder="45">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Wohnfl√§che bis (qm)</label>
                    <input class="form-input" id="csv-prop-size-to" type="number" step="0.1" placeholder="120">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Anzahl Einheiten</label>
                    <input class="form-input" id="csv-prop-num-units" type="number" step="1" placeholder="24">
                  </div>
                </div>

                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" onclick="resetCSVImport()">Abbrechen</button>
                  <button type="submit" class="btn btn-primary">üì• Kampagne importieren</button>
                </div>

              </div>
            </form>
          </div>
        </div>

        <div style="text-align:center;">
          <span class="manual-toggle-link" onclick="resetCSVImport()">‚Ü© Neue CSV hochladen</span>
        </div>
      </div>

      <!-- Manual form toggle -->
      <div style="text-align:center;margin-top:24px;" id="csv-manual-toggle">
        <span class="manual-toggle-link" onclick="showManualForm()">Oder manuell anlegen ‚Üí</span>
      </div>

      <!-- Hidden: Original Manual Form -->
      <div id="csv-manual-form" style="display:none;margin-top:24px;">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Kampagne manuell anlegen</div>
          </div>
          <div class="card-body">
            <form id="new-campaign-form" onsubmit="handleCreateCampaign(event)">
              <div class="form-grid">

                <div class="form-section-title">Kunde</div>

                <div class="form-group">
                  <label class="form-label">Kunde ausw√§hlen</label>
                  <select class="form-select" id="form-client" onchange="toggleNewClient(this)">
                    <option value="">‚Äî Neuen Kunden anlegen ‚Äî</option>
                  </select>
                </div>

                <div class="form-group" id="form-new-client-group">
                  <label class="form-label">Kundenname</label>
                  <input class="form-input" id="form-client-name" placeholder="z.B. Von J√§rten & Cie">
                </div>

                <div class="form-group">
                  <label class="form-label">Brand / Franchise</label>
                  <input class="form-input" id="form-brand" placeholder="z.B. Von Poll, Engel & V√∂lkers">
                </div>

                <div class="form-section-title">Objekt</div>

                <div class="form-group">
                  <label class="form-label">Objektname *</label>
                  <input class="form-input" id="form-prop-name" required placeholder="z.B. Falkensteiner Ufer">
                </div>

                <div class="form-group">
                  <label class="form-label">Adresse</label>
                  <input class="form-input" id="form-prop-address" placeholder="Stra√üe, Hausnummer">
                </div>

                <div class="form-group">
                  <label class="form-label">PLZ</label>
                  <input class="form-input" id="form-prop-plz" placeholder="22587">
                </div>

                <div class="form-group">
                  <label class="form-label">Stadtteil</label>
                  <input class="form-input" id="form-prop-stadtteil" placeholder="Blankenese">
                </div>

                <div class="form-group">
                  <label class="form-label">Stadt</label>
                  <input class="form-input" id="form-prop-city" placeholder="Hamburg" oninput="autoFillCityRating('form-prop-city','form-prop-location-rating')">
                </div>

                <div class="form-group">
                  <label class="form-label">Standort-Rating</label>
                  <select class="form-select" id="form-prop-location-rating">
                    <option value="">‚Äî Automatisch ‚Äî</option>
                    <option value="A">A ‚Äî Top-7-Stadt</option>
                    <option value="B">B ‚Äî Gro√üstadt</option>
                    <option value="C">C ‚Äî Mittelstadt / Sonstige</option>
                    <option value="D">D ‚Äî L√§ndlich</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Mikrolage</label>
                  <select class="form-select" id="form-prop-micro-location">
                    <option value="">‚Äî Keine Angabe ‚Äî</option>
                    <option value="premium">Premium</option>
                    <option value="gut">Gut</option>
                    <option value="standard">Standard</option>
                    <option value="randlage">Randlage</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Objektart</label>
                  <select class="form-select" id="form-prop-type" onchange="toggleNeubauFields('form')">
                    <option value="wohnung">Wohnung</option>
                    <option value="haus">Haus</option>
                    <option value="penthouse">Penthouse</option>
                    <option value="villa">Villa</option>
                    <option value="reihenhaus">Reihenhaus</option>
                    <option value="grundstueck">Grundst√ºck</option>
                    <option value="gewerbe">Gewerbe</option>
                    <option value="neubauprojekt">Neubauprojekt</option>
                    <option value="zweifamilienhaus">Zweifamilienhaus</option>
                    <option value="sonstige">Sonstige</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Wohnfl√§che (qm)</label>
                  <input class="form-input" id="form-prop-size" type="number" step="0.1" placeholder="120">
                </div>

                <div class="form-group">
                  <label class="form-label">Grundst√ºcksgr√∂√üe (qm)</label>
                  <input class="form-input" id="form-prop-plot-size" type="number" step="0.1">
                </div>

                <div class="form-group">
                  <label class="form-label">Zimmer</label>
                  <input class="form-input" id="form-prop-rooms" type="number" step="0.5" placeholder="4">
                </div>

                <div class="form-group">
                  <label class="form-label">Angebotspreis (‚Ç¨)</label>
                  <input class="form-input" id="form-prop-price" type="number" step="1" placeholder="850000">
                </div>

                <div id="form-neubau-fields" style="display:none; border-top: 1px solid var(--border); padding-top: 12px; margin-top: 12px;">
                  <div class="form-label" style="font-weight:600; margin-bottom:8px; color: var(--primary);">üèóÔ∏è Neubauprojekt-Details</div>
                  <div class="form-group">
                    <label class="form-label">Preis von (‚Ç¨)</label>
                    <input class="form-input" id="form-prop-price-from" type="number" step="1" placeholder="299000">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Preis bis (‚Ç¨)</label>
                    <input class="form-input" id="form-prop-price-to" type="number" step="1" placeholder="890000">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Wohnfl√§che von (qm)</label>
                    <input class="form-input" id="form-prop-size-from" type="number" step="0.1" placeholder="45">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Wohnfl√§che bis (qm)</label>
                    <input class="form-input" id="form-prop-size-to" type="number" step="0.1" placeholder="120">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Anzahl Einheiten</label>
                    <input class="form-input" id="form-prop-num-units" type="number" step="1" placeholder="24">
                  </div>
                </div>

                <div class="form-section-title">Kampagne</div>

                <div class="form-group full-width">
                  <label class="form-label">Kampagnenname *</label>
                  <input class="form-input" id="form-camp-name" required placeholder="z.B. Falkensteiner Ufer // Lead Gen">
                </div>

                <div class="form-group">
                  <label class="form-label">Kampagnentyp</label>
                  <select class="form-select" id="form-camp-type">
                    <option value="lead_gen">Lead-Generierung</option>
                    <option value="awareness">Awareness</option>
                    <option value="traffic">Traffic</option>
                    <option value="engagement">Engagement</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Status</label>
                  <select class="form-select" id="form-camp-status">
                    <option value="active">Aktiv</option>
                    <option value="paused">Pausiert</option>
                    <option value="completed">Abgeschlossen</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">Startdatum</label>
                  <input class="form-input" id="form-camp-start" type="date">
                </div>

                <div class="form-group">
                  <label class="form-label">Enddatum</label>
                  <input class="form-input" id="form-camp-end" type="date">
                </div>

                <div class="form-group">
                  <label class="form-label">Gesamtbudget (‚Ç¨)</label>
                  <input class="form-input" id="form-camp-budget" type="number" step="0.01" placeholder="1000">
                </div>

                <div class="form-actions">
                  <button type="button" class="btn btn-secondary" onclick="showView('campaigns')">Abbrechen</button>
                  <button type="submit" class="btn btn-primary">Kampagne erstellen</button>
                </div>

              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: Creative Intelligence -->
    <div id="view-intelligence" class="view">
      <div class="page-header">
        <div>
          <h1 class="page-title">üß† Creative Intelligence</h1>
          <div class="page-subtitle">Welche Creative-Art performt am besten ‚Äî √ºber alle Kampagnen hinweg</div>
        </div>
      </div>

      <!-- Time Filter Tabs -->
      <div class="tabs" style="margin-bottom:24px;">
        <div class="tab active" id="intel-tab-alltime" onclick="switchIntelTimeFilter('alltime')">üìä All-Time</div>
        <div class="tab" id="intel-tab-30d" onclick="switchIntelTimeFilter('30d')">‚è± Aktuell (30 Tage)</div>
      </div>

      <div id="intel-loading" class="loading-spinner">
        <div class="spinner"></div>
      </div>

      <div id="intel-content" style="display:none;">
        <!-- Section A: Current Best -->
        <div class="intel-section">
          <div class="intel-section-title">üèÜ Aktuell beste Creative-Art</div>
          <div id="intel-current-chart" class="hbar-chart" style="margin-bottom:24px;"></div>
          <div id="intel-current-cards" class="intel-ranking-grid"></div>
        </div>

        <!-- Section B: All-Time Ranking -->
        <div class="intel-section">
          <div class="intel-section-title">üìä All-Time Ranking</div>
          <div class="ranking-tabs" id="ranking-tabs">
            <div class="ranking-tab active" onclick="switchRanking('score')">Nach Score</div>
            <div class="ranking-tab" onclick="switchRanking('cpl')">Nach CPL</div>
            <div class="ranking-tab" onclick="switchRanking('leads')">Nach Leads</div>
          </div>
          <div id="intel-alltime-cards" class="intel-ranking-grid"></div>
        </div>

        <!-- Section C: Nach Objektart (locked) -->
        <div class="intel-section">
          <div class="intel-section-title">üè† Nach Objektart</div>
          <div class="locked-section">
            <div class="lock-icon">üîí</div>
            <h3>Ab 10+ Kampagnen verf√ºgbar</h3>
            <p>Diese Analyse zeigt, welche Creative-Art f√ºr welche Objektart am besten funktioniert. Sobald gen√ºgend Daten vorliegen, wird die Auswertung automatisch freigeschaltet.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: Edit Campaign -->
    <div id="view-edit-campaign" class="view">
      <a class="back-link" onclick="showView('detail')">‚Üê Zur√ºck zur Kampagne</a>

      <div class="page-header">
        <div>
          <h1 class="page-title">Kampagne bearbeiten</h1>
          <div class="page-subtitle" id="edit-subtitle">‚Äî</div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <form id="edit-campaign-form" onsubmit="handleEditCampaign(event)">
            <div class="form-grid">

              <!-- Client Section -->
              <div class="form-section-title">Kunde</div>

              <div class="form-group">
                <label class="form-label">Kunde</label>
                <select class="form-select" id="edit-client">
                </select>
              </div>

              <!-- Property Section -->
              <div class="form-section-title">Objekt</div>

              <div class="form-group">
                <label class="form-label">Objektname *</label>
                <input class="form-input" id="edit-prop-name" required>
              </div>

              <div class="form-group">
                <label class="form-label">Adresse</label>
                <input class="form-input" id="edit-prop-address">
              </div>

              <div class="form-group">
                <label class="form-label">PLZ</label>
                <input class="form-input" id="edit-prop-plz">
              </div>

              <div class="form-group">
                <label class="form-label">Stadtteil</label>
                <input class="form-input" id="edit-prop-stadtteil">
              </div>

              <div class="form-group">
                <label class="form-label">Stadt</label>
                <input class="form-input" id="edit-prop-city" oninput="autoFillCityRating('edit-prop-city','edit-prop-location-rating')">
              </div>

              <div class="form-group">
                <label class="form-label">Standort-Rating</label>
                <select class="form-select" id="edit-prop-location-rating">
                  <option value="">‚Äî Automatisch ‚Äî</option>
                  <option value="A">A ‚Äî Top-7-Stadt</option>
                  <option value="B">B ‚Äî Gro√üstadt</option>
                  <option value="C">C ‚Äî Mittelstadt / Sonstige</option>
                  <option value="D">D ‚Äî L√§ndlich</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Mikrolage</label>
                <select class="form-select" id="edit-prop-micro-location">
                  <option value="">‚Äî Keine Angabe ‚Äî</option>
                  <option value="premium">Premium</option>
                  <option value="gut">Gut</option>
                  <option value="standard">Standard</option>
                  <option value="randlage">Randlage</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Objektart</label>
                <select class="form-select" id="edit-prop-type" onchange="toggleNeubauFields('edit')">
                  <option value="wohnung">Wohnung</option>
                  <option value="haus">Haus</option>
                  <option value="penthouse">Penthouse</option>
                  <option value="villa">Villa</option>
                  <option value="reihenhaus">Reihenhaus</option>
                  <option value="grundstueck">Grundst√ºck</option>
                  <option value="gewerbe">Gewerbe</option>
                  <option value="neubauprojekt">Neubauprojekt</option>
                  <option value="zweifamilienhaus">Zweifamilienhaus</option>
                  <option value="sonstige">Sonstige</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">Wohnfl√§che (qm)</label>
                <input class="form-input" id="edit-prop-size" type="number" step="0.1">
              </div>

              <div class="form-group">
                <label class="form-label">Grundst√ºcksgr√∂√üe (qm)</label>
                <input class="form-input" id="edit-prop-plot-size" type="number" step="0.1">
              </div>

              <div class="form-group">
                <label class="form-label">Zimmer</label>
                <input class="form-input" id="edit-prop-rooms" type="number" step="0.5">
              </div>

              <div class="form-group">
                <label class="form-label">Angebotspreis (‚Ç¨)</label>
                <input class="form-input" id="edit-prop-price" type="number" step="1">
              </div>

              <div id="edit-neubau-fields" style="display:none; border-top: 1px solid var(--border); padding-top: 12px; margin-top: 12px;">
                <div class="form-label" style="font-weight:600; margin-bottom:8px; color: var(--primary);">üèóÔ∏è Neubauprojekt-Details</div>
                <div class="form-group">
                  <label class="form-label">Preis von (‚Ç¨)</label>
                  <input class="form-input" id="edit-prop-price-from" type="number" step="1">
                </div>
                <div class="form-group">
                  <label class="form-label">Preis bis (‚Ç¨)</label>
                  <input class="form-input" id="edit-prop-price-to" type="number" step="1">
                </div>
                <div class="form-group">
                  <label class="form-label">Wohnfl√§che von (qm)</label>
                  <input class="form-input" id="edit-prop-size-from" type="number" step="0.1">
                </div>
                <div class="form-group">
                  <label class="form-label">Wohnfl√§che bis (qm)</label>
                  <input class="form-input" id="edit-prop-size-to" type="number" step="0.1">
                </div>
                <div class="form-group">
                  <label class="form-label">Anzahl Einheiten</label>
                  <input class="form-input" id="edit-prop-num-units" type="number" step="1">
                </div>
              </div>

              <!-- Campaign Section -->
              <div class="form-section-title">Kampagne</div>

              <div class="form-group full-width">
                <label class="form-label">Kampagnenname *</label>
                <input class="form-input" id="edit-camp-name" required>
              </div>

              <div class="form-group">
                <label class="form-label">Startdatum</label>
                <input class="form-input" id="edit-camp-start" type="date">
              </div>

              <div class="form-group">
                <label class="form-label">Enddatum</label>
                <input class="form-input" id="edit-camp-end" type="date">
              </div>

              <div class="form-group">
                <label class="form-label">Gesamtbudget (‚Ç¨)</label>
                <input class="form-input" id="edit-camp-budget" type="number" step="0.01">
              </div>

              <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select" id="edit-camp-status">
                  <option value="active">Aktiv</option>
                  <option value="paused">Pausiert</option>
                  <option value="completed">Abgeschlossen</option>
                </select>
              </div>

              <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="showView('detail')">Abbrechen</button>
                <button type="submit" class="btn btn-primary">üíæ Speichern</button>
              </div>

            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- VIEW: Data Intelligence -->
    <div id="view-data-intel" class="view">
      <div class="page-header">
        <div>
          <h1 class="page-title">üìà Data Intelligence</h1>
          <div class="page-subtitle">Statistische Analyse aller Kampagnen ‚Äî Segmente, Korrelationen & Insights</div>
        </div>
      </div>

      <div id="data-intel-loading" class="loading-spinner">
        <div class="spinner"></div>
      </div>

      <div id="data-intel-content" style="display:none;">

        <!-- Section A: Segment Performance Matrix -->
        <div class="data-intel-section">
          <div class="data-intel-section-title">üìä Segment-Performance-Matrix</div>
          <div id="data-intel-warning"></div>
          <div class="data-intel-grid" id="data-intel-segments"></div>
        </div>

        <!-- Section B: Korrelations-Analyse -->
        <div class="data-intel-section">
          <div class="data-intel-section-title">üîó Korrelations-Analyse</div>
          <div class="card">
            <div class="card-body" id="data-intel-correlations"></div>
          </div>
        </div>

        <!-- Section C: Auto-Insights -->
        <div class="data-intel-section">
          <div class="data-intel-section-title">üí° Auto-Insights</div>
          <div class="card">
            <div class="card-body" id="data-intel-insights"></div>
          </div>
        </div>

        <!-- Section D: Scatter Plot -->
        <div class="data-intel-section">
          <div class="data-intel-section-title">üîç Kampagnen-Vergleich</div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Preis vs. CPL</div>
            </div>
            <div class="card-body">
              <div class="scatter-container">
                <canvas id="chart-scatter-cpl"></canvas>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- VIEW: Property Predictor -->
    <div id="view-predictor" class="view">
      <div class="page-header">
        <div>
          <h1 class="page-title">üîÆ Performance-Prognose</h1>
          <div class="page-subtitle">Voraussichtliche Kampagnen-Performance f√ºr ein Objekt vorhersagen</div>
        </div>
      </div>

      <div class="predictor-layout">
        <!-- Left: Input Form -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Objekt-Daten</div>
          </div>
          <div class="card-body">
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Objektart *</label>
              <select class="form-select" id="pred-type">
                <option value="wohnung">Wohnung</option>
                <option value="haus">Haus</option>
                <option value="penthouse">Penthouse</option>
                <option value="villa">Villa</option>
                <option value="reihenhaus">Reihenhaus</option>
                <option value="grundstueck">Grundst√ºck</option>
                <option value="gewerbe">Gewerbe</option>
                <option value="neubauprojekt">Neubauprojekt</option>
                <option value="zweifamilienhaus">Zweifamilienhaus</option>
                <option value="sonstige">Sonstige</option>
              </select>
            </div>
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Wohnfl√§che (qm)</label>
              <input class="form-input" id="pred-size" type="number" step="0.1" placeholder="120">
            </div>
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Grundst√ºck (qm, optional)</label>
              <input class="form-input" id="pred-plot" type="number" step="0.1" placeholder="">
            </div>
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Zimmer (optional)</label>
              <input class="form-input" id="pred-rooms" type="number" step="0.5" placeholder="4">
            </div>
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Preis (‚Ç¨) *</label>
              <input class="form-input" id="pred-price" type="number" step="1" placeholder="850000">
            </div>
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Stadt</label>
              <input class="form-input" id="pred-city" placeholder="Berlin" oninput="autoFillCityRating('pred-city','pred-rating')">
            </div>
            <div class="form-group" style="margin-bottom:14px;">
              <label class="form-label">Standort-Rating</label>
              <select class="form-select" id="pred-rating">
                <option value="">‚Äî Automatisch ‚Äî</option>
                <option value="A">A ‚Äî Top-7-Stadt</option>
                <option value="B">B ‚Äî Gro√üstadt</option>
                <option value="C">C ‚Äî Mittelstadt / Sonstige</option>
                <option value="D">D ‚Äî L√§ndlich</option>
              </select>
            </div>
            <div class="form-group" style="margin-bottom:18px;">
              <label class="form-label">Mikrolage (optional)</label>
              <select class="form-select" id="pred-micro">
                <option value="">‚Äî Keine Angabe ‚Äî</option>
                <option value="premium">Premium</option>
                <option value="gut">Gut</option>
                <option value="standard">Standard</option>
                <option value="randlage">Randlage</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="predictPerformance()" style="width:100%;">üîÆ Performance vorhersagen</button>
          </div>
        </div>

        <!-- Right: Results -->
        <div id="pred-results">
          <div class="empty-state" style="padding:60px 30px;">
            <div class="empty-state-icon">üîÆ</div>
            <div class="empty-state-title">Prognose starten</div>
            <div class="empty-state-desc">Objekt-Daten links eingeben und auf ‚ÄûPerformance vorhersagen" klicken.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: Property Comparison -->
    <div id="view-compare" class="view">
      <div class="page-header">
        <div>
          <h1 class="page-title">‚öñÔ∏è Objekt-Vergleich</h1>
          <div class="page-subtitle">Bis zu 4 Objekte vergleichen und das beste Performance-Potenzial finden</div>
        </div>
      </div>

      <div class="compare-grid" id="comp-inputs">
        <!-- Property 0 -->
        <div class="compare-input-card" id="comp-card-0">
          <div class="compare-card-title">Objekt 1</div>
          <div class="form-group"><label class="form-label">Name</label><input class="form-input" id="comp-0-name" placeholder="z.B. Bennyweg"></div>
          <div class="form-group"><label class="form-label">Objektart</label><select class="form-select" id="comp-0-type"><option value="wohnung">Wohnung</option><option value="haus">Haus</option><option value="penthouse">Penthouse</option><option value="villa">Villa</option><option value="reihenhaus">Reihenhaus</option><option value="grundstueck">Grundst√ºck</option><option value="gewerbe">Gewerbe</option><option value="neubauprojekt">Neubauprojekt</option><option value="zweifamilienhaus">Zweifamilienhaus</option><option value="sonstige">Sonstige</option></select></div>
          <div class="form-group"><label class="form-label">Wohnfl√§che (qm)</label><input class="form-input" id="comp-0-size" type="number" step="0.1" placeholder="120"></div>
          <div class="form-group"><label class="form-label">Preis (‚Ç¨)</label><input class="form-input" id="comp-0-price" type="number" step="1" placeholder="850000"></div>
          <div class="form-group"><label class="form-label">Stadt</label><input class="form-input" id="comp-0-city" placeholder="Berlin" oninput="autoFillCityRating('comp-0-city','comp-0-rating')"></div>
          <div class="form-group"><label class="form-label">Standort-Rating</label><select class="form-select" id="comp-0-rating"><option value="">‚Äî Auto ‚Äî</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div>
        </div>
        <!-- Property 1 -->
        <div class="compare-input-card" id="comp-card-1">
          <div class="compare-card-title">Objekt 2</div>
          <div class="form-group"><label class="form-label">Name</label><input class="form-input" id="comp-1-name" placeholder="z.B. Spanische Allee"></div>
          <div class="form-group"><label class="form-label">Objektart</label><select class="form-select" id="comp-1-type"><option value="wohnung">Wohnung</option><option value="haus">Haus</option><option value="penthouse">Penthouse</option><option value="villa">Villa</option><option value="reihenhaus">Reihenhaus</option><option value="grundstueck">Grundst√ºck</option><option value="gewerbe">Gewerbe</option><option value="neubauprojekt">Neubauprojekt</option><option value="zweifamilienhaus">Zweifamilienhaus</option><option value="sonstige">Sonstige</option></select></div>
          <div class="form-group"><label class="form-label">Wohnfl√§che (qm)</label><input class="form-input" id="comp-1-size" type="number" step="0.1" placeholder="241"></div>
          <div class="form-group"><label class="form-label">Preis (‚Ç¨)</label><input class="form-input" id="comp-1-price" type="number" step="1" placeholder="2100000"></div>
          <div class="form-group"><label class="form-label">Stadt</label><input class="form-input" id="comp-1-city" placeholder="Hamburg" oninput="autoFillCityRating('comp-1-city','comp-1-rating')"></div>
          <div class="form-group"><label class="form-label">Standort-Rating</label><select class="form-select" id="comp-1-rating"><option value="">‚Äî Auto ‚Äî</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div>
        </div>
      </div>

      <div style="display:flex;gap:12px;margin-bottom:32px;">
        <button class="btn btn-secondary" id="comp-add-btn" onclick="addCompareProperty()">‚ûï Objekt hinzuf√ºgen</button>
        <button class="btn btn-primary" onclick="compareProperties()">‚öñÔ∏è Vergleichen</button>
      </div>

      <div id="comp-results"></div>
    </div>

  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ============================================
// SUPABASE REST API (no SDK needed)
// ============================================
const SB_URL = 'https://lvhxabadywdqeepymwdm.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2aHhhYmFkeXdkcWVlcHltd2RtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2OTUyMjM3NSwiZXhwIjoyMDg1MDk4Mzc1fQ.3BWQG5yeG8nshvukSi3YksxUbg273tJDiZnU9fAlzY0';
const SB_HEADERS = { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' };

async function sbGet(table, query = '') {
  const res = await fetch(`${SB_URL}/rest/v1/${table}?${query}`, { headers: SB_HEADERS });
  if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.message || `HTTP ${res.status}`); }
  return res.json();
}

async function sbInsert(table, data) {
  const res = await fetch(`${SB_URL}/rest/v1/${table}`, { method: 'POST', headers: SB_HEADERS, body: JSON.stringify(data) });
  if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.message || `HTTP ${res.status}`); }
  return res.json();
}

async function sbPatch(table, id, data) {
  const res = await fetch(`${SB_URL}/rest/v1/${table}?id=eq.${id}`, {
    method: 'PATCH', headers: SB_HEADERS, body: JSON.stringify(data)
  });
  if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.message || `HTTP ${res.status}`); }
  return res.json();
}

async function sbDelete(table, id) {
  const res = await fetch(`${SB_URL}/rest/v1/${table}?id=eq.${id}`, {
    method: 'DELETE', headers: SB_HEADERS
  });
  if (!res.ok) throw new Error(await res.text());
}

// ============================================
// CITY RATING CLASSIFICATION
// ============================================
const CITY_RATINGS = {
  A: ['berlin','hamburg','m√ºnchen','munich','k√∂ln','cologne','frankfurt','d√ºsseldorf','stuttgart'],
  B: ['hannover','n√ºrnberg','bremen','dresden','leipzig','dortmund','essen','duisburg','bochum','wuppertal','bielefeld','bonn','m√ºnster','mannheim','karlsruhe','augsburg','wiesbaden','m√∂nchengladbach','gelsenkirchen','braunschweig','aachen','kiel','chemnitz','halle','magdeburg','freiburg','krefeld','mainz','l√ºbeck','erfurt','oberhausen','rostock','kassel','saarbr√ºcken','potsdam','leverkusen','oldenburg','heidelberg','darmstadt','wolfsburg','regensburg','w√ºrzburg'],
  C: []
};

function getCityRating(city) {
  if (!city) return null;
  const c = city.toLowerCase().trim();
  if (CITY_RATINGS.A.includes(c)) return 'A';
  if (CITY_RATINGS.B.includes(c)) return 'B';
  return 'C';
}

function toggleNeubauFields(prefix) {
  var type = document.getElementById(prefix + '-prop-type').value;
  var fields = document.getElementById(prefix + '-neubau-fields');
  if (fields) {
    fields.style.display = type === 'neubauprojekt' ? 'block' : 'none';
  }
}

function autoFillCityRating(cityInputId, ratingSelectId) {
  const cityVal = document.getElementById(cityInputId).value;
  const ratingSelect = document.getElementById(ratingSelectId);
  const rating = getCityRating(cityVal);
  if (rating) ratingSelect.value = rating;
}

// ============================================
// STATE
// ============================================
let currentView = 'campaigns';
let campaigns = [];
let clients = [];
let chartDaily = null;
let chartCPL = null;
let chartCreatives = null;
let dbReady = false;
let intelData = null;
let currentRanking = 'score';
let intelTimeFilter = 'alltime';
let editCampaignId = null;
let editPropertyId = null;

// ============================================
// CREATIVE TYPE LABELS
// ============================================
const CREATIVE_TYPE_LABELS = {
  'single_image': 'Single Image',
  'carousel': 'Carousel',
  'scn_reel': 'SCN Reel',
  'th_reel': 'TH Reel',
  'video': 'Video',
  'story': 'Story',
  // Legacy fallbacks
  'reel': 'Reel',
  'image': 'Single Image'
};

function getCreativeTypeLabel(type) {
  return CREATIVE_TYPE_LABELS[type] || type || '‚Äî';
}

// ============================================
// CHART DEFAULTS
// ============================================
Chart.defaults.color = '#8888a0';
Chart.defaults.borderColor = '#262636';
Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.font.size = 11;
Chart.defaults.plugins.legend.labels.usePointStyle = true;
Chart.defaults.plugins.legend.labels.pointStyleWidth = 8;
Chart.defaults.plugins.tooltip.backgroundColor = '#16161f';
Chart.defaults.plugins.tooltip.borderColor = '#262636';
Chart.defaults.plugins.tooltip.borderWidth = 1;
Chart.defaults.plugins.tooltip.padding = 12;
Chart.defaults.plugins.tooltip.cornerRadius = 8;
Chart.defaults.plugins.tooltip.titleFont = { size: 12, weight: '600', family: "'Inter', sans-serif" };
Chart.defaults.plugins.tooltip.bodyFont = { size: 12, family: "'Inter', sans-serif" };

// ============================================
// HELPERS
// ============================================
function formatEur(val) {
  if (val == null || isNaN(val)) return '‚Äî';
  return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(val);
}

function formatNum(val) {
  if (val == null || isNaN(val)) return '‚Äî';
  return new Intl.NumberFormat('de-DE').format(val);
}

function formatDate(d) {
  if (!d) return '‚Äî';
  return new Date(d).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function formatDateShort(d) {
  if (!d) return '‚Äî';
  return new Date(d).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
}

function statusBadge(status) {
  const cls = status === 'active' ? 'badge-active' : status === 'paused' ? 'badge-paused' : 'badge-completed';
  const label = status === 'active' ? 'Aktiv' : status === 'paused' ? 'Pausiert' : 'Abgeschlossen';
  return `<span class="badge ${cls}"><span class="badge-dot"></span>${label}</span>`;
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} visible`;
  setTimeout(() => t.classList.remove('visible'), 3000);
}

// Performance Score: Leads √ó (avgCPL / creativeCPL)
// Rewards both volume AND efficiency
function calcScore(leads, cpl, avgCPL) {
  if (!leads || leads === 0 || !cpl || cpl === 0) return 0;
  return leads * (avgCPL / cpl);
}

// ============================================
// NAVIGATION
// ============================================
function showView(view) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const el = document.getElementById(`view-${view}`);
  if (el) el.classList.add('active');
  currentView = view;

  // Update nav active states
  document.querySelectorAll('.topnav-actions .btn-ghost').forEach(b => b.classList.remove('active'));
  const navBtn = document.getElementById(`nav-${view}`);
  if (navBtn) navBtn.classList.add('active');

  if (view === 'campaigns') loadCampaigns();
  if (view === 'new-campaign') { resetCSVImport(); loadClientsForForm(); }
  if (view === 'intelligence') loadIntelligence();
  if (view === 'data-intel') loadDataIntelligence();
  if (view === 'predictor') { /* nothing to preload */ }
  if (view === 'compare') { /* nothing to preload */ }
  if (view === 'detail' && editCampaignId) openCampaign(editCampaignId);
}

// ============================================
// DATA LOADING
// ============================================
async function checkDatabase() {
  try {
    await sbGet('clients', 'select=id&limit=1');
    dbReady = true;
    document.getElementById('setup-banner').style.display = 'none';
    return true;
  } catch (e) {
    console.error('DB-Pr√ºfung fehlgeschlagen:', e);
    document.getElementById('setup-banner').style.display = 'flex';
    document.getElementById('campaigns-loading').style.display = 'none';
    document.getElementById('campaigns-empty').style.display = 'block';
    dbReady = false;
    return false;
  }
}

async function loadCampaigns() {
  if (!dbReady) return;

  const loading = document.getElementById('campaigns-loading');
  const table = document.getElementById('campaigns-table');
  const empty = document.getElementById('campaigns-empty');
  const tbody = document.getElementById('campaigns-tbody');

  loading.style.display = 'flex';
  table.style.display = 'none';
  empty.style.display = 'none';

  try {
    const params = new URLSearchParams();
    params.set('select', '*,properties!inner(*,clients!inner(name,brand)),campaign_daily_metrics(spend,leads,impressions)');
    params.set('order', 'created_at.desc');

    const statusFilter = document.getElementById('filter-status').value;
    const clientFilter = document.getElementById('filter-client').value;

    if (statusFilter) params.set('status', `eq.${statusFilter}`);
    if (clientFilter) params.set('properties.client_id', `eq.${clientFilter}`);

    const data = await sbGet('campaigns', params.toString());
    campaigns = data || [];

    if (campaigns.length === 0) {
      loading.style.display = 'none';
      empty.style.display = 'block';
      return;
    }

    tbody.innerHTML = campaigns.map(c => {
      const metrics = c.campaign_daily_metrics || [];
      const totalSpend = metrics.reduce((s, m) => s + (m.spend || 0), 0);
      const totalLeads = metrics.reduce((s, m) => s + (m.leads || 0), 0);
      const cpl = totalLeads > 0 ? totalSpend / totalLeads : null;
      const property = c.properties;
      const client = property?.clients;
      const cityRating = property?.location_rating || getCityRating(property?.city);
      const cityBadge = property?.city ? `<span style="margin-left:6px;font-size:11px;color:var(--text-muted);background:var(--bg-input);padding:1px 6px;border-radius:4px;">${escHtml(property.city)}${cityRating ? ' ('+cityRating+')' : ''}</span>` : '';

      return `
        <tr onclick="openCampaign('${c.id}')">
          <td>
            <div class="campaign-name">${escHtml(c.campaign_name)}</div>
            <div class="campaign-property">${escHtml(client?.name || '‚Äî')} ¬∑ ${escHtml(property?.name || '‚Äî')}${cityBadge}</div>
          </td>
          <td>${statusBadge(c.status)}</td>
          <td class="value-eur">${formatEur(totalSpend)}</td>
          <td><strong>${formatNum(totalLeads)}</strong></td>
          <td class="value-eur ${cpl && cpl < 10 ? 'value-good' : cpl && cpl > 15 ? 'value-bad' : ''}">${cpl ? formatEur(cpl) : '‚Äî'}</td>
          <td style="color:var(--text-secondary);font-size:13px;">
            ${formatDate(c.start_date)}${c.end_date ? ' ‚Äì ' + formatDate(c.end_date) : ' ‚Äì laufend'}
          </td>
        </tr>
      `;
    }).join('');

    loading.style.display = 'none';
    table.style.display = 'table';
  } catch (e) {
    console.error('[Kampagnen] Ladefehler:', e);
    loading.style.display = 'none';
    empty.style.display = 'block';
    empty.innerHTML = `
      <div class="empty-state-icon">‚ö†Ô∏è</div>
      <div class="empty-state-title">Fehler beim Laden</div>
      <div class="empty-state-desc" style="color:var(--red);font-family:monospace;font-size:12px;">${escHtml(e?.message || String(e))}</div>
    `;
  }
}

async function loadClients() {
  if (!dbReady) return;
  const data = await sbGet('clients', 'select=*&order=name');
  clients = data || [];

  const filter = document.getElementById('filter-client');
  const current = filter.value;
  filter.innerHTML = '<option value="">Alle Kunden</option>' +
    clients.map(c => `<option value="${c.id}">${escHtml(c.name)}</option>`).join('');
  filter.value = current;
}

async function loadClientsForForm() {
  if (!dbReady) return;
  const data = await sbGet('clients', 'select=*&order=name');
  const clientOptions = (data || []).map(c => `<option value="${c.id}">${escHtml(c.name)}${c.brand ? ' (' + escHtml(c.brand) + ')' : ''}</option>`).join('');

  // Manual form
  const select = document.getElementById('form-client');
  if (select) select.innerHTML = '<option value="">‚Äî Neuen Kunden anlegen ‚Äî</option>' + clientOptions;

  // CSV import form
  const csvSelect = document.getElementById('csv-client');
  if (csvSelect) {
    const prev = csvSelect.value;
    csvSelect.innerHTML = '<option value="">‚Äî Neuen Kunden anlegen ‚Äî</option>' + clientOptions;
    if (prev) csvSelect.value = prev;
  }

  // Edit form
  const editSelect = document.getElementById('edit-client');
  if (editSelect) {
    const prev = editSelect.value;
    editSelect.innerHTML = clientOptions;
    if (prev) editSelect.value = prev;
  }
}

function toggleNewClient(select) {
  const group = document.getElementById('form-new-client-group');
  group.style.display = select.value ? 'none' : 'flex';
}

function toggleCSVNewClient(select) {
  const nameGroup = document.getElementById('csv-new-client-group');
  const brandGroup = document.getElementById('csv-brand-group');
  const hidden = select.value ? true : false;
  nameGroup.style.display = hidden ? 'none' : 'flex';
  brandGroup.style.display = hidden ? 'none' : 'flex';
}

// ============================================
// CAMPAIGN DETAIL
// ============================================
let _openingCampaign = false;
async function openCampaign(id) {
  if (_openingCampaign) return;
  _openingCampaign = true;
  showView('detail');

  try {
    const campaigns = await sbGet('campaigns', `select=*,properties(*,clients(*)),campaign_daily_metrics(*),creatives(*,creative_daily_metrics(*))&id=eq.${id}`);
    const campaign = campaigns[0];
    if (!campaign) throw new Error('Kampagne nicht gefunden');

    const property = campaign.properties;
    const client = property?.clients;
    const metrics = (campaign.campaign_daily_metrics || []).sort((a, b) => a.date.localeCompare(b.date));
    const creatives = campaign.creatives || [];

    // Store for editing
    editCampaignId = campaign.id;
    editPropertyId = property?.id;
    window._editCampaignData = campaign;
    window._editPropertyData = property;

    // Header (no platform badge ‚Äî always Meta)
    document.getElementById('detail-title').textContent = campaign.campaign_name;
    document.getElementById('detail-subtitle').innerHTML =
      `${escHtml(client?.name || '‚Äî')} ¬∑ ${escHtml(property?.name || '‚Äî')}${property?.stadtteil ? ', ' + escHtml(property.stadtteil) : ''}`;
    document.getElementById('detail-status').innerHTML = statusBadge(campaign.status);

    // Property details
    const locRating = property?.location_rating || getCityRating(property?.city) || '‚Äî';
    const microLoc = property?.micro_location ? ({premium:'Premium',gut:'Gut',standard:'Standard',randlage:'Randlage'}[property.micro_location] || property.micro_location) : '‚Äî';
    const propTypeLabel = {wohnung:'Wohnung',haus:'Haus',penthouse:'Penthouse',villa:'Villa',reihenhaus:'Reihenhaus',grundstueck:'Grundst√ºck',gewerbe:'Gewerbe',neubauprojekt:'Neubauprojekt',zweifamilienhaus:'Zweifamilienhaus',sonstige:'Sonstige'}[property?.property_type] || property?.property_type || '‚Äî';

    document.getElementById('detail-property-info').innerHTML = `
      <div><div class="kpi-label">Adresse</div><div style="font-weight:600;">${escHtml(property?.address || '‚Äî')}</div></div>
      <div><div class="kpi-label">PLZ / Stadt</div><div style="font-weight:600;">${escHtml(property?.plz || '')} ${escHtml(property?.city || '‚Äî')}</div></div>
      <div><div class="kpi-label">Stadtteil</div><div style="font-weight:600;">${escHtml(property?.stadtteil || '‚Äî')}</div></div>
      <div><div class="kpi-label">Objektart</div><div style="font-weight:600;">${escHtml(propTypeLabel)}</div></div>
      <div><div class="kpi-label">Wohnfl√§che</div><div style="font-weight:600;">${property?.size_sqm ? property.size_sqm + ' qm' : '‚Äî'}</div></div>
      <div><div class="kpi-label">Grundst√ºck</div><div style="font-weight:600;">${property?.plot_size ? property.plot_size + ' qm' : '‚Äî'}</div></div>
      <div><div class="kpi-label">Zimmer</div><div style="font-weight:600;">${property?.rooms || '‚Äî'}</div></div>
      <div><div class="kpi-label">Preis</div><div style="font-weight:600;">${property?.price ? formatEur(property.price) : '‚Äî'}</div></div>
      ${property?.property_type === 'neubauprojekt' ? `
      <div><div class="kpi-label">Preis von</div><div style="font-weight:600;">${property?.price_from ? formatEur(property.price_from) : '‚Äî'}</div></div>
      <div><div class="kpi-label">Preis bis</div><div style="font-weight:600;">${property?.price_to ? formatEur(property.price_to) : '‚Äî'}</div></div>
      <div><div class="kpi-label">Fl√§che von</div><div style="font-weight:600;">${property?.size_from ? property.size_from + ' qm' : '‚Äî'}</div></div>
      <div><div class="kpi-label">Fl√§che bis</div><div style="font-weight:600;">${property?.size_to ? property.size_to + ' qm' : '‚Äî'}</div></div>
      <div><div class="kpi-label">Einheiten</div><div style="font-weight:600;">${property?.num_units || '‚Äî'}</div></div>
      ` : ''}
      <div><div class="kpi-label">Standort-Rating</div><div style="font-weight:600;"><span class="badge badge-active" style="font-size:12px;">${locRating}</span></div></div>
      <div><div class="kpi-label">Mikrolage</div><div style="font-weight:600;">${escHtml(microLoc)}</div></div>
    `;

    // KPIs
    const totalSpend = metrics.reduce((s, m) => s + (m.spend || 0), 0);
    const totalLeads = metrics.reduce((s, m) => s + (m.leads || 0), 0);
    const totalImpressions = metrics.reduce((s, m) => s + (m.impressions || 0), 0);
    const totalReach = metrics.reduce((s, m) => s + (m.reach || 0), 0);
    const avgCPL = totalLeads > 0 ? totalSpend / totalLeads : null;
    const avgCPM = totalImpressions > 0 ? (totalSpend / totalImpressions) * 1000 : null;
    const days = metrics.length;
    const avgLeadsDay = days > 0 ? totalLeads / days : 0;

    document.getElementById('detail-kpis').innerHTML = `
      <div class="kpi-card">
        <div class="kpi-label">Gesamtausgaben</div>
        <div class="kpi-value">${formatEur(totalSpend)}</div>
        <div class="kpi-change neutral">${days} Tage ¬∑ √ò ${formatEur(totalSpend / Math.max(days, 1))}/Tag</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Leads gesamt</div>
        <div class="kpi-value">${totalLeads}</div>
        <div class="kpi-change neutral">√ò ${avgLeadsDay.toFixed(1)} Leads/Tag</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">√ò Cost per Lead</div>
        <div class="kpi-value ${avgCPL && avgCPL < 10 ? 'value-good' : avgCPL && avgCPL > 15 ? 'value-bad' : ''}">${avgCPL ? formatEur(avgCPL) : '‚Äî'}</div>
        <div class="kpi-change ${avgCPL && avgCPL < 10 ? 'positive' : avgCPL && avgCPL > 15 ? 'negative' : 'neutral'}">${avgCPL && avgCPL < 10 ? '‚úì Unter 10 ‚Ç¨' : avgCPL && avgCPL > 15 ? '‚ö† √úber 15 ‚Ç¨' : 'Im Zielbereich'}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Impressions</div>
        <div class="kpi-value">${formatNum(totalImpressions)}</div>
        <div class="kpi-change neutral">Reichweite: ${formatNum(totalReach)}</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">√ò CPM</div>
        <div class="kpi-value">${avgCPM ? formatEur(avgCPM) : '‚Äî'}</div>
        <div class="kpi-change neutral">Pro 1.000 Impressions</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Lead-Rate</div>
        <div class="kpi-value">${totalImpressions > 0 ? ((totalLeads / totalImpressions) * 100).toFixed(2) + '%' : '‚Äî'}</div>
        <div class="kpi-change neutral">Leads / Impressions</div>
      </div>
    `;

    // === BENCHMARKS ===
    renderBenchmarks(campaign, property, { totalSpend, totalLeads, totalImpressions, totalReach, avgCPL, avgCPM, days, avgLeadsDay });

    // === CHARTS ===
    renderDailyChart(metrics);
    renderCPLChart(metrics);
    renderCreativeChart(creatives, avgCPL);
    renderCreativeCards(creatives, avgCPL);

  } catch (e) {
    console.error('Kampagnendetail-Ladefehler:', e);
    showToast('Fehler beim Laden der Kampagne', 'error');
  } finally {
    _openingCampaign = false;
  }
}

function renderDailyChart(metrics) {
  const ctx = document.getElementById('chart-daily').getContext('2d');
  if (chartDaily) chartDaily.destroy();

  const labels = metrics.map(m => formatDateShort(m.date));
  const spendData = metrics.map(m => m.spend || 0);
  const leadsData = metrics.map(m => m.leads || 0);

  chartDaily = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Leads',
          data: leadsData,
          backgroundColor: 'rgba(99, 102, 241, 0.7)',
          borderColor: 'rgba(99, 102, 241, 1)',
          borderWidth: 1,
          borderRadius: 4,
          yAxisID: 'y1',
          order: 2
        },
        {
          label: 'Spend (‚Ç¨)',
          data: spendData,
          type: 'line',
          borderColor: 'rgba(6, 182, 212, 1)',
          backgroundColor: 'rgba(6, 182, 212, 0.1)',
          borderWidth: 2,
          pointRadius: 2,
          pointHoverRadius: 5,
          fill: true,
          tension: 0.3,
          yAxisID: 'y',
          order: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        tooltip: {
          callbacks: {
            label: (ctx) => {
              if (ctx.dataset.label === 'Spend (‚Ç¨)') return `Spend: ${formatEur(ctx.raw)}`;
              return `Leads: ${ctx.raw}`;
            }
          }
        }
      },
      scales: {
        x: { grid: { display: false } },
        y: {
          position: 'left',
          title: { display: true, text: 'Spend (‚Ç¨)', color: '#06b6d4' },
          grid: { color: 'rgba(38, 38, 54, 0.5)' },
          ticks: { callback: v => v + ' ‚Ç¨' }
        },
        y1: {
          position: 'right',
          title: { display: true, text: 'Leads', color: '#6366f1' },
          grid: { display: false },
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });
}

function renderCPLChart(metrics) {
  const ctx = document.getElementById('chart-cpl').getContext('2d');
  if (chartCPL) chartCPL.destroy();

  const filtered = metrics.filter(m => m.leads > 0);
  const labels = filtered.map(m => formatDateShort(m.date));
  const cplData = filtered.map(m => m.cpl || (m.spend / m.leads));
  const avgCPL = cplData.reduce((s, v) => s + v, 0) / Math.max(cplData.length, 1);

  chartCPL = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'CPL (‚Ç¨)',
          data: cplData,
          borderColor: 'rgba(245, 158, 11, 1)',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          borderWidth: 2,
          pointRadius: 3,
          pointHoverRadius: 6,
          pointBackgroundColor: cplData.map(v => v <= avgCPL ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)'),
          fill: true,
          tension: 0.3
        },
        {
          label: '√ò CPL',
          data: new Array(labels.length).fill(avgCPL),
          borderColor: 'rgba(255, 255, 255, 0.2)',
          borderWidth: 1,
          borderDash: [5, 5],
          pointRadius: 0,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${formatEur(ctx.raw)}`
          }
        }
      },
      scales: {
        x: { grid: { display: false } },
        y: {
          grid: { color: 'rgba(38, 38, 54, 0.5)' },
          ticks: { callback: v => v.toFixed(0) + ' ‚Ç¨' },
          beginAtZero: true
        }
      }
    }
  });
}

function renderCreativeChart(creatives, avgCPL) {
  const ctx = document.getElementById('chart-creatives').getContext('2d');
  if (chartCreatives) chartCreatives.destroy();

  // Aggregate metrics per creative with scores
  const creativeData = creatives.map(c => {
    const metrics = c.creative_daily_metrics || [];
    const totalSpend = metrics.reduce((s, m) => s + (m.spend || 0), 0);
    const totalLeads = metrics.reduce((s, m) => s + (m.leads || 0), 0);
    const cpl = totalLeads > 0 ? totalSpend / totalLeads : 0;
    const score = calcScore(totalLeads, cpl, avgCPL || 1);
    return { name: c.creative_name, type: c.creative_type, spend: totalSpend, leads: totalLeads, cpl, score };
  });

  // Sort by score (descending)
  creativeData.sort((a, b) => b.score - a.score);

  // Winner is the first one with score > 0
  const winnerIdx = creativeData.findIndex(c => c.score > 0);

  const labels = creativeData.map((c, i) => {
    if (i === winnerIdx) return `‚≠ê ${c.name}`;
    return c.name;
  });
  const cplValues = creativeData.map(c => c.cpl);
  const leadsValues = creativeData.map(c => c.leads);

  // Single color for all CPL bars, gold border for winner
  const bgColor = 'rgba(99, 102, 241, 0.7)';
  const borderColors = creativeData.map((c, i) =>
    i === winnerIdx ? 'rgba(251, 191, 36, 1)' : 'rgba(99, 102, 241, 1)'
  );
  const borderWidths = creativeData.map((c, i) => i === winnerIdx ? 3 : 1);

  chartCreatives = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'CPL (‚Ç¨)',
          data: cplValues,
          backgroundColor: bgColor,
          borderColor: borderColors,
          borderWidth: borderWidths,
          borderRadius: 6,
          yAxisID: 'y'
        },
        {
          label: 'Leads',
          data: leadsValues,
          type: 'line',
          borderColor: 'rgba(6, 182, 212, 1)',
          backgroundColor: 'transparent',
          borderWidth: 2,
          pointRadius: 4,
          pointBackgroundColor: 'rgba(6, 182, 212, 1)',
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        tooltip: {
          callbacks: {
            label: (tooltipCtx) => {
              if (tooltipCtx.dataset.label === 'CPL (‚Ç¨)') return `CPL: ${tooltipCtx.raw > 0 ? formatEur(tooltipCtx.raw) : 'Keine Leads'}`;
              return `Leads: ${tooltipCtx.raw}`;
            }
          }
        }
      },
      scales: {
        x: { grid: { display: false } },
        y: {
          position: 'left',
          title: { display: true, text: 'CPL (‚Ç¨)', color: '#6366f1' },
          grid: { color: 'rgba(38, 38, 54, 0.5)' },
          ticks: { callback: v => v + ' ‚Ç¨' }
        },
        y1: {
          position: 'right',
          title: { display: true, text: 'Leads', color: '#06b6d4' },
          grid: { display: false },
          beginAtZero: true
        }
      }
    }
  });
}

function renderCreativeCards(creatives, avgCPL) {
  const container = document.getElementById('creative-cards');

  // Calculate scores for all creatives
  const creativeData = creatives.map(c => {
    const metrics = c.creative_daily_metrics || [];
    const totalSpend = metrics.reduce((s, m) => s + (m.spend || 0), 0);
    const totalLeads = metrics.reduce((s, m) => s + (m.leads || 0), 0);
    const totalImpressions = metrics.reduce((s, m) => s + (m.impressions || 0), 0);
    const cpl = totalLeads > 0 ? totalSpend / totalLeads : null;
    const score = calcScore(totalLeads, cpl, avgCPL || 1);
    return { ...c, totalSpend, totalLeads, totalImpressions, cpl, score };
  });

  // Sort by score descending
  creativeData.sort((a, b) => b.score - a.score);

  const medals = ['ü•á', 'ü•à', 'ü•â'];

  const cards = creativeData.map((c, idx) => {
    const typeLabel = getCreativeTypeLabel(c.creative_type);
    const medal = idx < 3 && c.score > 0 ? medals[idx] : '';
    const isWinner = idx === 0 && c.score > 0;

    return `
      <div class="creative-card ${isWinner ? 'winner' : ''}">
        <div class="creative-card-header">
          <div class="creative-card-name">
            ${medal ? `<span class="creative-card-badge">${medal}</span>` : ''}${escHtml(c.creative_name)}
          </div>
          <div class="creative-card-type">${escHtml(typeLabel)}</div>
        </div>
        <div class="creative-stats">
          <div>
            <div class="creative-stat-label">Leads</div>
            <div class="creative-stat-value">${c.totalLeads}</div>
          </div>
          <div>
            <div class="creative-stat-label">CPL</div>
            <div class="creative-stat-value ${c.cpl && c.cpl < 10 ? 'value-good' : c.cpl && c.cpl > 15 ? 'value-bad' : ''}">${c.cpl ? formatEur(c.cpl) : '‚Äî'}</div>
          </div>
          <div>
            <div class="creative-stat-label">Spend</div>
            <div class="creative-stat-value" style="font-size:14px;">${formatEur(c.totalSpend)}</div>
          </div>
          <div>
            <div class="creative-stat-label">Score</div>
            <div class="creative-stat-value" style="font-size:14px;">
              <span class="score-badge ${isWinner ? 'top' : ''}">${c.score.toFixed(1)}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = cards || '<div class="empty-state"><div class="empty-state-desc">Keine Creatives vorhanden</div></div>';
}

// ============================================
// CREATIVE INTELLIGENCE VIEW
// ============================================
function switchIntelTimeFilter(mode) {
  intelTimeFilter = mode;
  document.getElementById('intel-tab-alltime').classList.toggle('active', mode === 'alltime');
  document.getElementById('intel-tab-30d').classList.toggle('active', mode === '30d');
  loadIntelligence();
}

async function loadIntelligence() {
  if (!dbReady) return;

  const loading = document.getElementById('intel-loading');
  const content = document.getElementById('intel-content');
  loading.style.display = 'flex';
  content.style.display = 'none';

  try {
    // Load all creatives with their metrics
    const creatives = await sbGet('creatives', 'select=*,creative_daily_metrics(*)');

    // Time filter: calculate cutoff date for 30-day filter
    let dateCutoff = null;
    if (intelTimeFilter === '30d') {
      const d = new Date();
      d.setDate(d.getDate() - 30);
      dateCutoff = d.toISOString().slice(0, 10); // YYYY-MM-DD
    }

    // Group by creative_type
    const typeMap = {};
    (creatives || []).forEach(c => {
      const type = c.creative_type || 'unknown';
      if (!typeMap[type]) typeMap[type] = { type, totalLeads: 0, totalSpend: 0, creativeCount: 0 };
      let metrics = c.creative_daily_metrics || [];
      // Apply time filter
      if (dateCutoff) {
        metrics = metrics.filter(m => m.date >= dateCutoff);
      }
      const leads = metrics.reduce((s, m) => s + (m.leads || 0), 0);
      const spend = metrics.reduce((s, m) => s + (m.spend || 0), 0);
      typeMap[type].totalLeads += leads;
      typeMap[type].totalSpend += spend;
      typeMap[type].creativeCount += 1;
    });

    // Calculate avgCPL across all types
    const allLeads = Object.values(typeMap).reduce((s, t) => s + t.totalLeads, 0);
    const allSpend = Object.values(typeMap).reduce((s, t) => s + t.totalSpend, 0);
    const globalAvgCPL = allLeads > 0 ? allSpend / allLeads : 0;

    // Calc per-type metrics (average score per creative, not sum)
    const typeData = Object.values(typeMap).map(t => {
      const avgCPL = t.totalLeads > 0 ? t.totalSpend / t.totalLeads : 0;
      const totalScore = calcScore(t.totalLeads, avgCPL, globalAvgCPL || 1);
      const score = t.creativeCount > 0 ? Math.round((totalScore / t.creativeCount) * 10) / 10 : 0;
      return { ...t, avgCPL, score };
    });

    intelData = { typeData, globalAvgCPL };

    // Sort by score for default view
    typeData.sort((a, b) => b.score - a.score);

    const filterLabel = intelTimeFilter === '30d' ? ' (letzte 30 Tage)' : '';
    renderIntelCurrentBest(typeData, filterLabel);
    renderIntelAllTime(typeData, currentRanking);

    loading.style.display = 'none';
    content.style.display = 'block';

  } catch (e) {
    console.error('Intelligence-Ladefehler:', e);
    loading.style.display = 'none';
    content.style.display = 'block';
    document.getElementById('intel-current-cards').innerHTML = `
      <div class="empty-state" style="grid-column:1/-1;">
        <div class="empty-state-icon">‚ö†Ô∏è</div>
        <div class="empty-state-title">Fehler beim Laden</div>
        <div class="empty-state-desc" style="color:var(--red);font-family:monospace;font-size:12px;">${escHtml(e?.message || String(e))}</div>
      </div>
    `;
  }
}

function renderIntelCurrentBest(typeData, filterLabel) {
  filterLabel = filterLabel || '';
  const chartContainer = document.getElementById('intel-current-chart');
  const cardsContainer = document.getElementById('intel-current-cards');

  if (!typeData.length) {
    chartContainer.innerHTML = '';
    cardsContainer.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-desc">Noch keine Creative-Daten vorhanden</div></div>';
    return;
  }

  const maxScore = Math.max(...typeData.map(t => t.score), 1);

  // Horizontal bar chart
  chartContainer.innerHTML = typeData.map((t, i) => {
    const pct = maxScore > 0 ? (t.score / maxScore) * 100 : 0;
    const isWinner = i === 0 && t.score > 0;
    return `
      <div class="hbar-row">
        <div class="hbar-label">${isWinner ? 'üëë ' : ''}${getCreativeTypeLabel(t.type)}</div>
        <div class="hbar-track">
          <div class="hbar-fill ${isWinner ? 'winner-bar' : ''}" style="width:${Math.max(pct, 8)}%">
            ${t.score.toFixed(1)}
          </div>
        </div>
        <div class="hbar-value">${t.totalLeads} Leads</div>
      </div>
    `;
  }).join('');

  // Cards
  cardsContainer.innerHTML = typeData.map((t, i) => {
    const isWinner = i === 0 && t.score > 0;
    return `
      <div class="intel-type-card ${isWinner ? 'winner' : ''}">
        <div class="intel-type-header">
          <div class="intel-type-name">${isWinner ? 'üëë ' : ''}${getCreativeTypeLabel(t.type)}</div>
          <span class="score-badge ${isWinner ? 'top' : ''}">Score: ${t.score.toFixed(1)}</span>
        </div>
        <div class="intel-type-stats">
          <div>
            <div class="intel-stat-label">Leads gesamt</div>
            <div class="intel-stat-value">${t.totalLeads}</div>
          </div>
          <div>
            <div class="intel-stat-label">√ò CPL</div>
            <div class="intel-stat-value ${t.avgCPL && t.avgCPL < 10 ? 'value-good' : t.avgCPL && t.avgCPL > 15 ? 'value-bad' : ''}">${t.avgCPL ? formatEur(t.avgCPL) : '‚Äî'}</div>
          </div>
          <div>
            <div class="intel-stat-label">Creatives</div>
            <div class="intel-stat-value">${t.creativeCount}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function switchRanking(mode) {
  currentRanking = mode;
  // Update tabs
  document.querySelectorAll('.ranking-tab').forEach(tab => tab.classList.remove('active'));
  event.target.classList.add('active');

  if (!intelData) return;

  const sorted = [...intelData.typeData];
  if (mode === 'score') sorted.sort((a, b) => b.score - a.score);
  else if (mode === 'cpl') sorted.sort((a, b) => {
    // Lower CPL is better, 0 means no data (goes last)
    const aCpl = a.avgCPL || Infinity;
    const bCpl = b.avgCPL || Infinity;
    return aCpl - bCpl;
  });
  else if (mode === 'leads') sorted.sort((a, b) => b.totalLeads - a.totalLeads);

  renderIntelAllTime(sorted, mode);
}

function renderIntelAllTime(typeData, mode) {
  const container = document.getElementById('intel-alltime-cards');

  const modeLabel = mode === 'score' ? 'Score' : mode === 'cpl' ? 'CPL' : 'Leads';
  const medals = ['ü•á', 'ü•à', 'ü•â'];

  container.innerHTML = typeData.map((t, i) => {
    const medal = i < 3 ? medals[i] : '';
    let primaryValue = '';
    if (mode === 'score') primaryValue = t.score.toFixed(1);
    else if (mode === 'cpl') primaryValue = t.avgCPL ? formatEur(t.avgCPL) : '‚Äî';
    else if (mode === 'leads') primaryValue = String(t.totalLeads);

    return `
      <div class="intel-type-card ${i === 0 ? 'winner' : ''}">
        <div class="intel-type-header">
          <div class="intel-type-name">${medal} ${getCreativeTypeLabel(t.type)}</div>
          <span class="score-badge ${i === 0 ? 'top' : ''}">${modeLabel}: ${primaryValue}</span>
        </div>
        <div class="intel-type-stats">
          <div>
            <div class="intel-stat-label">Leads</div>
            <div class="intel-stat-value">${t.totalLeads}</div>
          </div>
          <div>
            <div class="intel-stat-label">√ò CPL</div>
            <div class="intel-stat-value">${t.avgCPL ? formatEur(t.avgCPL) : '‚Äî'}</div>
          </div>
          <div>
            <div class="intel-stat-label">Score</div>
            <div class="intel-stat-value">${t.score.toFixed(1)}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// ============================================
// EDIT CAMPAIGN
// ============================================
async function openEditCampaign() {
  const campaign = window._editCampaignData;
  const property = window._editPropertyData;
  if (!campaign || !property) { showToast('Keine Daten zum Bearbeiten', 'error'); return; }

  document.getElementById('edit-subtitle').textContent = campaign.campaign_name;

  // Load clients and pre-fill
  await loadClientsForForm();
  const editClientSelect = document.getElementById('edit-client');
  if (editClientSelect && property.client_id) {
    editClientSelect.value = property.client_id;
  }

  // Fill property fields
  document.getElementById('edit-prop-name').value = property.name || '';
  document.getElementById('edit-prop-address').value = property.address || '';
  document.getElementById('edit-prop-plz').value = property.plz || '';
  document.getElementById('edit-prop-stadtteil').value = property.stadtteil || '';
  document.getElementById('edit-prop-city').value = property.city || '';
  document.getElementById('edit-prop-location-rating').value = property.location_rating || '';
  document.getElementById('edit-prop-micro-location').value = property.micro_location || '';
  document.getElementById('edit-prop-type').value = property.property_type || 'wohnung';
  document.getElementById('edit-prop-size').value = property.size_sqm || '';
  document.getElementById('edit-prop-plot-size').value = property.plot_size || '';
  document.getElementById('edit-prop-rooms').value = property.rooms || '';
  document.getElementById('edit-prop-price').value = property.price || '';
  document.getElementById('edit-prop-price-from').value = property.price_from || '';
  document.getElementById('edit-prop-price-to').value = property.price_to || '';
  document.getElementById('edit-prop-size-from').value = property.size_from || '';
  document.getElementById('edit-prop-size-to').value = property.size_to || '';
  document.getElementById('edit-prop-num-units').value = property.num_units || '';
  toggleNeubauFields('edit');

  // Fill campaign fields
  document.getElementById('edit-camp-name').value = campaign.campaign_name || '';
  document.getElementById('edit-camp-start').value = campaign.start_date || '';
  document.getElementById('edit-camp-end').value = campaign.end_date || '';
  document.getElementById('edit-camp-budget').value = campaign.total_budget || '';
  document.getElementById('edit-camp-status').value = campaign.status || 'active';

  // Auto-fill rating if not set
  if (!property.location_rating && property.city) {
    autoFillCityRating('edit-prop-city', 'edit-prop-location-rating');
  }

  showView('edit-campaign');
}

async function handleEditCampaign(event) {
  event.preventDefault();
  if (!editCampaignId || !editPropertyId) { showToast('Keine Kampagne ausgew√§hlt', 'error'); return; }

  try {
    // Update property (including client)
    const selectedClientId = document.getElementById('edit-client').value;
    const locationRating = document.getElementById('edit-prop-location-rating').value || null;
    const propData = {
      client_id: selectedClientId || null,
      name: document.getElementById('edit-prop-name').value,
      address: document.getElementById('edit-prop-address').value || null,
      plz: document.getElementById('edit-prop-plz').value || null,
      stadtteil: document.getElementById('edit-prop-stadtteil').value || null,
      city: document.getElementById('edit-prop-city').value || null,
      location_rating: locationRating,
      micro_location: document.getElementById('edit-prop-micro-location').value || null,
      property_type: document.getElementById('edit-prop-type').value,
      size_sqm: parseFloat(document.getElementById('edit-prop-size').value) || null,
      plot_size: parseFloat(document.getElementById('edit-prop-plot-size').value) || null,
      rooms: parseFloat(document.getElementById('edit-prop-rooms').value) || null,
      price: parseFloat(document.getElementById('edit-prop-price').value) || null,
      price_from: document.getElementById('edit-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('edit-prop-price-from').value) || null) : null,
      price_to: document.getElementById('edit-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('edit-prop-price-to').value) || null) : null,
      size_from: document.getElementById('edit-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('edit-prop-size-from').value) || null) : null,
      size_to: document.getElementById('edit-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('edit-prop-size-to').value) || null) : null,
      num_units: document.getElementById('edit-prop-type').value === 'neubauprojekt' ? (parseInt(document.getElementById('edit-prop-num-units').value) || null) : null
    };

    await sbPatch('properties', editPropertyId, propData);

    // Update campaign
    const campData = {
      campaign_name: document.getElementById('edit-camp-name').value,
      start_date: document.getElementById('edit-camp-start').value || null,
      end_date: document.getElementById('edit-camp-end').value || null,
      total_budget: parseFloat(document.getElementById('edit-camp-budget').value) || null,
      status: document.getElementById('edit-camp-status').value
    };

    await sbPatch('campaigns', editCampaignId, campData);

    showToast('√Ñnderungen gespeichert ‚úì');
    // Reload the detail view
    openCampaign(editCampaignId);
  } catch (e) {
    console.error('Bearbeitung fehlgeschlagen:', e);
    showToast('Fehler: ' + (e.message || 'Unbekannter Fehler'), 'error');
  }
}

// ============================================
// DELETE CAMPAIGN
// ============================================
async function deleteCampaign() {
  if (!editCampaignId) { showToast('Keine Kampagne ausgew√§hlt', 'error'); return; }
  const campaign = window._editCampaignData;
  const campaignName = campaign?.campaign_name || 'Unbekannt';
  if (!confirm('Kampagne "' + campaignName + '" wirklich l√∂schen? Alle Metriken und Creatives werden ebenfalls gel√∂scht.')) return;
  try {
    await sbDelete('campaigns', editCampaignId);
    if (editPropertyId) {
      await sbDelete('properties', editPropertyId);
    }
    showToast('Kampagne gel√∂scht ‚úì');
    editCampaignId = null;
    editPropertyId = null;
    window._editCampaignData = null;
    window._editPropertyData = null;
    showView('campaigns');
  } catch (e) {
    console.error('L√∂schen fehlgeschlagen:', e);
    showToast('Fehler beim L√∂schen: ' + (e.message || 'Unbekannter Fehler'), 'error');
  }
}

// ============================================
// CSV RE-IMPORT FOR EXISTING CAMPAIGNS
// ============================================
function openCSVReimport() {
  document.getElementById('reimport-csv-input').click();
}

async function handleCSVReimport(event) {
  const file = event.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    const rows = parseMetaCSV(text);
    if (!rows || rows.length === 0) {
      showToast('CSV-Datei ist leer oder konnte nicht gelesen werden', 'error');
      return;
    }
    const analysis = analyzeCSV(rows);
    if (!analysis) {
      showToast('CSV konnte nicht analysiert werden', 'error');
      return;
    }
    if (!confirm('CSV importieren? ' + rows.length + ' Zeilen, ' + analysis.totalLeads + ' Leads, ' + analysis.dailyMetrics.length + ' Tage. Bestehende Metriken werden ersetzt.')) {
      event.target.value = '';
      return;
    }
    const campaignId = editCampaignId;

    // 1. Delete existing campaign_daily_metrics
    await fetch(`${SB_URL}/rest/v1/campaign_daily_metrics?campaign_id=eq.${campaignId}`, {
      method: 'DELETE', headers: SB_HEADERS
    });

    // 2. Get existing creative IDs and delete their metrics, then delete creatives
    const existingCreatives = await sbGet('creatives', `campaign_id=eq.${campaignId}&select=id`);
    for (const cr of existingCreatives) {
      await fetch(`${SB_URL}/rest/v1/creative_daily_metrics?creative_id=eq.${cr.id}`, {
        method: 'DELETE', headers: SB_HEADERS
      });
    }
    await fetch(`${SB_URL}/rest/v1/creatives?campaign_id=eq.${campaignId}`, {
      method: 'DELETE', headers: SB_HEADERS
    });

    // 3. Insert new campaign_daily_metrics (NO cpl/cpm/ctr ‚Äî GENERATED ALWAYS)
    const dailyRows = analysis.dailyMetrics.map(d => ({
      campaign_id: campaignId,
      date: d.date,
      spend: Math.round(d.spend * 100) / 100,
      impressions: Math.round(d.impressions),
      reach: Math.round(d.reach),
      clicks: null,
      leads: Math.round(d.leads)
    }));
    if (dailyRows.length > 0) {
      await sbInsert('campaign_daily_metrics', dailyRows);
    }

    // 4. Insert new creatives
    const creativeIdMap = {};
    for (const cr of analysis.creatives) {
      const [newCreative] = await sbInsert('creatives', {
        campaign_id: campaignId,
        creative_name: cr.name,
        creative_type: ['single_image','carousel','reel','video','story','scn_reel','th_reel'].includes(cr.type) ? cr.type : 'video'
      });
      creativeIdMap[cr.name] = newCreative.id;
    }

    // 5. Insert new creative_daily_metrics (NO cpl/cpm ‚Äî GENERATED ALWAYS)
    const creativeDailyRows = analysis.creativeDailyMetrics
      .filter(m => creativeIdMap[m.creativeName])
      .map(m => ({
        creative_id: creativeIdMap[m.creativeName],
        date: m.date,
        spend: Math.round(m.spend * 100) / 100,
        impressions: Math.round(m.impressions),
        reach: Math.round(m.reach),
        clicks: null,
        leads: Math.round(m.leads)
      }));
    if (creativeDailyRows.length > 0) {
      await sbInsert('creative_daily_metrics', creativeDailyRows);
    }

    // 6. Update campaign dates and budget
    await sbPatch('campaigns', campaignId, {
      start_date: analysis.startDate || null,
      end_date: analysis.endDate || null,
      total_budget: Math.round(analysis.totalSpend * 100) / 100,
      status: analysis.campaignStatus
    });

    showToast('CSV-Daten aktualisiert ‚úì ' + analysis.totalLeads + ' Leads, ' + analysis.creatives.length + ' Creatives, ' + analysis.dailyMetrics.length + ' Tage');
    openCampaign(campaignId);
  } catch (e) {
    console.error('CSV-Reimport fehlgeschlagen:', e);
    showToast('Reimport-Fehler: ' + (e.message || 'Unbekannter Fehler'), 'error');
  } finally {
    event.target.value = '';
  }
}

// ============================================
// CSV IMPORT: PARSING & ANALYSIS
// ============================================
let _csvAnalysis = null; // stores current CSV analysis result

function parseMetaCSV(csvText) {
  // Strip UTF-8 BOM
  if (csvText.charCodeAt(0) === 0xFEFF) csvText = csvText.slice(1);

  const rows = [];
  const lines = csvText.split(/\r?\n/);
  if (lines.length < 2) return rows;

  // Parse a single CSV line handling quoted fields
  function parseLine(line) {
    const fields = [];
    let i = 0;
    while (i <= line.length) {
      if (i === line.length) { fields.push(''); break; }
      if (line[i] === '"') {
        // Quoted field
        let val = '';
        i++; // skip opening quote
        while (i < line.length) {
          if (line[i] === '"') {
            if (i + 1 < line.length && line[i + 1] === '"') {
              val += '"';
              i += 2;
            } else {
              i++; // skip closing quote
              break;
            }
          } else {
            val += line[i];
            i++;
          }
        }
        fields.push(val);
        if (i < line.length && line[i] === ',') i++; // skip delimiter
      } else {
        // Unquoted field
        let j = i;
        while (j < line.length && line[j] !== ',') j++;
        fields.push(line.substring(i, j));
        i = j + 1;
      }
    }
    return fields;
  }

  const headers = parseLine(lines[0]);

  for (let r = 1; r < lines.length; r++) {
    const line = lines[r].trim();
    if (!line) continue;
    const vals = parseLine(line);
    const obj = {};
    for (let c = 0; c < headers.length; c++) {
      obj[headers[c]] = vals[c] !== undefined ? vals[c] : '';
    }
    rows.push(obj);
  }
  return rows;
}

function inferCreativeType(adName) {
  if (!adName) return 'image';
  const lower = adName.toLowerCase();
  if (lower.includes('carousel')) return 'carousel';
  if (lower.includes('scn-reel') || lower.includes('scn reel')) return 'scn_reel';
  if (lower.includes('th-reel') || lower.includes('th reel')) return 'th_reel';
  if (lower.includes('reel') || lower.includes('video')) return 'video';
  if (lower.includes('single image') || lower.includes('bild')) return 'single_image';
  return 'image';
}

function analyzeCSV(rows) {
  if (!rows || rows.length === 0) return null;

  // Extract info from Ad set name
  // Format: "VON POLL Berlin-Pankow // Bennyweg // Voroptimierte Leads // Adv + Anzeigengruppe"
  const firstAdSet = (rows[0]['Ad set name'] || '').trim();
  const adSetParts = firstAdSet.split('//').map(s => s.trim());

  const clientPart = adSetParts[0] || ''; // "VON POLL Berlin-Pankow"
  const propertyName = adSetParts[1] || ''; // "Bennyweg"
  const campaignInfo = adSetParts[2] || ''; // "Voroptimierte Leads"

  // Split client part: first word(s) up to city part
  // Pattern: "VON POLL Berlin-Pankow" ‚Üí client "VON POLL", location "Berlin-Pankow"
  let clientName = clientPart;
  let clientLocation = '';
  const cityMatch = clientPart.match(/^(.+?)\s+(Berlin|Hamburg|M√ºnchen|Munich|K√∂ln|Cologne|Frankfurt|D√ºsseldorf|Stuttgart|Hannover|N√ºrnberg|Bremen|Dresden|Leipzig|Dortmund|Essen|Bonn|M√ºnster|Mannheim|Karlsruhe|Augsburg|Wiesbaden|Freiburg|Mainz|Heidelberg|Darmstadt|Potsdam|Regensburg|W√ºrzburg)[\s-]*(.*)/i);
  if (cityMatch) {
    clientName = cityMatch[1].trim();
    clientLocation = cityMatch[2] + (cityMatch[3] ? '-' + cityMatch[3] : '');
    clientLocation = clientLocation.replace(/-$/, '');
  }

  // Campaign type
  const campaignType = campaignInfo.toLowerCase().includes('lead') ? 'lead_generation' : 'awareness';

  // Campaign name
  const campaignTypeLabel = campaignType === 'lead_generation' ? 'Lead Gen' : 'Awareness';
  const campaignName = propertyName + ' // ' + campaignTypeLabel;

  // Dates
  const dates = rows.map(r => r['Day']).filter(d => d).sort();
  const startDate = dates[0] || '';
  const endDate = dates[dates.length - 1] || '';

  // Numeric parser
  const num = (val) => {
    if (!val || val === '' || val === '-') return 0;
    return parseFloat(String(val).replace(',', '.')) || 0;
  };

  // Totals
  let totalSpend = 0, totalLeads = 0, totalImpressions = 0, totalReach = 0;
  rows.forEach(r => {
    totalSpend += num(r['Amount spent (EUR)']);
    totalLeads += num(r['Results']);
    totalImpressions += num(r['Impressions']);
    totalReach += num(r['Reach']);
  });

  // Unique creatives
  const creativeMap = {};
  rows.forEach(r => {
    const name = (r['Ad name'] || '').trim();
    if (name && !creativeMap[name]) {
      creativeMap[name] = { name, type: inferCreativeType(name) };
    }
  });
  const creatives = Object.values(creativeMap);

  // Daily campaign metrics (aggregated across all ads per day)
  const dailyMap = {};
  rows.forEach(r => {
    const date = r['Day'];
    if (!date) return;
    if (!dailyMap[date]) dailyMap[date] = { date, spend: 0, impressions: 0, reach: 0, leads: 0 };
    dailyMap[date].spend += num(r['Amount spent (EUR)']);
    dailyMap[date].impressions += num(r['Impressions']);
    dailyMap[date].reach += num(r['Reach']);
    dailyMap[date].leads += num(r['Results']);
  });
  const dailyMetrics = Object.values(dailyMap).sort((a, b) => a.date.localeCompare(b.date));

  // Creative daily metrics
  const creativeDailyMap = {};
  rows.forEach(r => {
    const name = (r['Ad name'] || '').trim();
    const date = r['Day'];
    if (!name || !date) return;
    const key = name + '|' + date;
    if (!creativeDailyMap[key]) creativeDailyMap[key] = { creativeName: name, date, spend: 0, impressions: 0, reach: 0, leads: 0 };
    creativeDailyMap[key].spend += num(r['Amount spent (EUR)']);
    creativeDailyMap[key].impressions += num(r['Impressions']);
    creativeDailyMap[key].reach += num(r['Reach']);
    creativeDailyMap[key].leads += num(r['Results']);
  });
  const creativeDailyMetrics = Object.values(creativeDailyMap).map(m => ({
    ...m,
    cpl: m.leads > 0 ? m.spend / m.leads : null,
    cpm: m.impressions > 0 ? (m.spend / m.impressions) * 1000 : null
  }));

  // Detect campaign status from delivery_status
  const statuses = rows.map(r => (r['Delivery status'] || '').toLowerCase());
  const hasActive = statuses.some(s => s === 'active' || s === 'delivering');
  const campaignStatus = hasActive ? 'active' : 'completed';

  return {
    campaignName,
    clientName,
    clientLocation,
    propertyName,
    campaignType,
    campaignStatus,
    startDate,
    endDate,
    totalSpend,
    totalLeads,
    totalImpressions,
    totalReach,
    creatives,
    dailyMetrics,
    creativeDailyMetrics
  };
}

// ============================================
// CSV IMPORT: UI HANDLERS
// ============================================
function initDropZone() {
  const zone = document.getElementById('drop-zone');
  if (!zone) return;

  zone.addEventListener('dragover', (e) => {
    e.preventDefault();
    zone.classList.add('drag-over');
  });
  zone.addEventListener('dragleave', () => {
    zone.classList.remove('drag-over');
  });
  zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) handleCSVFile(files[0]);
  });
}

function handleCSVFileSelect(event) {
  const files = event.target.files;
  if (files.length > 0) handleCSVFile(files[0]);
}

function handleCSVFile(file) {
  if (!file.name.toLowerCase().endsWith('.csv')) {
    showToast('Bitte eine CSV-Datei ausw√§hlen', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const text = e.target.result;
      const rows = parseMetaCSV(text);
      if (!rows || rows.length === 0) {
        showToast('CSV-Datei ist leer oder konnte nicht gelesen werden', 'error');
        return;
      }

      const analysis = analyzeCSV(rows);
      if (!analysis) {
        showToast('CSV konnte nicht analysiert werden', 'error');
        return;
      }

      _csvAnalysis = analysis;
      showCSVPreview(analysis);
    } catch (err) {
      console.error('CSV-Parse-Fehler:', err);
      showToast('Fehler beim Lesen der CSV: ' + (err.message || String(err)), 'error');
    }
  };
  reader.readAsText(file, 'UTF-8');
}

function showCSVPreview(analysis) {
  // Hide upload, show preview
  document.getElementById('csv-step-upload').style.display = 'none';
  document.getElementById('csv-step-preview').style.display = 'block';
  document.getElementById('csv-manual-toggle').style.display = 'none';

  // Render preview card
  const startShort = formatDateShort(analysis.startDate);
  const endShort = formatDateShort(analysis.endDate);
  const spendFormatted = formatEur(analysis.totalSpend);

  document.getElementById('csv-preview').innerHTML = `
    <div class="csv-preview-title">üìä CSV erkannt</div>
    <dl class="csv-preview-grid">
      <dt>Kampagne</dt><dd>${escHtml(analysis.campaignName)}</dd>
      <dt>Kunde</dt><dd>${escHtml(analysis.clientName)}${analysis.clientLocation ? ' ¬∑ ' + escHtml(analysis.clientLocation) : ''}</dd>
      <dt>Zeitraum</dt><dd>${startShort} ‚Äì ${endShort}</dd>
      <dt>Ausgaben</dt><dd>${spendFormatted}</dd>
      <dt>Leads</dt><dd>${analysis.totalLeads}</dd>
      <dt>Creatives</dt><dd>${analysis.creatives.length}</dd>
      <dt>Impressions</dt><dd>${formatNum(analysis.totalImpressions)}</dd>
      <dt>Tage</dt><dd>${analysis.dailyMetrics.length}</dd>
    </dl>
  `;

  // Pre-fill property form
  document.getElementById('csv-prop-name').value = analysis.propertyName || '';

  // Try to extract city from clientLocation (e.g. "Berlin-Pankow" ‚Üí city "Berlin", stadtteil "Pankow")
  if (analysis.clientLocation) {
    const parts = analysis.clientLocation.split('-');
    const city = parts[0] || '';
    const stadtteil = parts.slice(1).join('-') || '';
    document.getElementById('csv-prop-city').value = city;
    if (stadtteil) document.getElementById('csv-prop-stadtteil').value = stadtteil;
    autoFillCityRating('csv-prop-city', 'csv-prop-location-rating');
  }

  // Pre-fill client: try to match existing, otherwise fill name/brand fields
  loadClientsForForm().then(() => {
    const csvClientSelect = document.getElementById('csv-client');
    if (csvClientSelect && analysis.clientName) {
      // Try to find matching client by name
      const match = Array.from(csvClientSelect.options).find(o =>
        o.textContent.toLowerCase().includes(analysis.clientName.toLowerCase())
      );
      if (match) {
        csvClientSelect.value = match.value;
        toggleCSVNewClient(csvClientSelect);
      } else {
        csvClientSelect.value = '';
        document.getElementById('csv-client-name').value = analysis.clientName || '';
        document.getElementById('csv-client-brand').value = analysis.clientName || '';
        toggleCSVNewClient(csvClientSelect);
      }
    }
  });
}

function resetCSVImport() {
  _csvAnalysis = null;
  document.getElementById('csv-step-upload').style.display = 'block';
  document.getElementById('csv-step-preview').style.display = 'none';
  document.getElementById('csv-manual-toggle').style.display = 'block';
  document.getElementById('csv-manual-form').style.display = 'none';
  // Reset file input
  const fi = document.getElementById('csv-file-input');
  if (fi) fi.value = '';
  // Reset form
  const form = document.getElementById('csv-import-form');
  if (form) form.reset();
}

function showManualForm() {
  document.getElementById('csv-manual-form').style.display = 'block';
  document.getElementById('csv-manual-toggle').style.display = 'none';
  loadClientsForForm();
}

function showCSVImportLoading(show) {
  let overlay = document.getElementById('csv-import-overlay');
  if (show) {
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'csv-import-overlay';
      overlay.className = 'csv-import-overlay';
      overlay.innerHTML = `
        <div class="csv-import-overlay-box">
          <div class="spinner"></div>
          <div class="csv-import-overlay-text">Kampagne wird importiert‚Ä¶</div>
        </div>
      `;
      document.body.appendChild(overlay);
    }
    overlay.style.display = 'flex';
  } else {
    if (overlay) overlay.style.display = 'none';
  }
}

// ============================================
// CSV IMPORT: DATABASE LOGIC
// ============================================
async function handleCSVImport(event) {
  event.preventDefault();

  if (!dbReady) {
    showToast('Datenbank nicht bereit. Bitte zuerst migration.sql ausf√ºhren.', 'error');
    return;
  }

  if (!_csvAnalysis) {
    showToast('Keine CSV-Daten vorhanden. Bitte zuerst eine CSV hochladen.', 'error');
    return;
  }

  const analysis = _csvAnalysis;
  showCSVImportLoading(true);

  try {
    // 1. Get or create client (from form dropdown)
    let clientId = document.getElementById('csv-client').value || null;
    if (!clientId) {
      // Create new client from form fields or CSV auto-detect
      const clientName = document.getElementById('csv-client-name').value || analysis.clientName;
      const clientBrand = document.getElementById('csv-client-brand').value || clientName;
      if (!clientName) {
        showCSVImportLoading(false);
        showToast('Bitte Kunden ausw√§hlen oder Namen eingeben', 'error');
        return;
      }
      const [newClient] = await sbInsert('clients', {
        name: clientName,
        brand: clientBrand
      });
      clientId = newClient.id;
    }

    // 2. Create property
    const locationRating = document.getElementById('csv-prop-location-rating').value ||
      getCityRating(document.getElementById('csv-prop-city').value) || null;
    const propData = {
      client_id: clientId,
      name: document.getElementById('csv-prop-name').value || analysis.propertyName,
      address: document.getElementById('csv-prop-address').value || null,
      plz: document.getElementById('csv-prop-plz').value || null,
      stadtteil: document.getElementById('csv-prop-stadtteil').value || null,
      city: document.getElementById('csv-prop-city').value || null,
      property_type: document.getElementById('csv-prop-type').value,
      size_sqm: parseFloat(document.getElementById('csv-prop-size').value) || null,
      plot_size: parseFloat(document.getElementById('csv-prop-plot-size').value) || null,
      rooms: parseFloat(document.getElementById('csv-prop-rooms').value) || null,
      price: parseFloat(document.getElementById('csv-prop-price').value) || null,
      location_rating: locationRating,
      micro_location: document.getElementById('csv-prop-micro-location').value || null,
      price_from: document.getElementById('csv-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('csv-prop-price-from').value) || null) : null,
      price_to: document.getElementById('csv-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('csv-prop-price-to').value) || null) : null,
      size_from: document.getElementById('csv-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('csv-prop-size-from').value) || null) : null,
      size_to: document.getElementById('csv-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('csv-prop-size-to').value) || null) : null,
      num_units: document.getElementById('csv-prop-type').value === 'neubauprojekt' ? (parseInt(document.getElementById('csv-prop-num-units').value) || null) : null
    };
    const [property] = await sbInsert('properties', propData);

    // 3. Create campaign
    const campData = {
      property_id: property.id,
      platform: 'meta',
      campaign_name: analysis.campaignName,
      campaign_type: analysis.campaignType,
      start_date: analysis.startDate || null,
      end_date: analysis.endDate || null,
      total_budget: Math.round(analysis.totalSpend * 100) / 100,
      status: analysis.campaignStatus
    };
    const [campaign] = await sbInsert('campaigns', campData);

    // 4. Create campaign_daily_metrics
    const dailyRows = analysis.dailyMetrics.map(d => ({
      campaign_id: campaign.id,
      date: d.date,
      spend: Math.round(d.spend * 100) / 100,
      impressions: Math.round(d.impressions),
      reach: Math.round(d.reach),
      clicks: null,
      leads: Math.round(d.leads)
    }));
    if (dailyRows.length > 0) {
      await sbInsert('campaign_daily_metrics', dailyRows);
    }

    // 5. Create creatives
    const creativeIdMap = {};
    for (const cr of analysis.creatives) {
      const [newCreative] = await sbInsert('creatives', {
        campaign_id: campaign.id,
        creative_name: cr.name,
        creative_type: ['single_image','carousel','reel','video','story','scn_reel','th_reel'].includes(cr.type) ? cr.type : 'video'
      });
      creativeIdMap[cr.name] = newCreative.id;
    }

    // 6. Create creative_daily_metrics
    const creativeDailyRows = analysis.creativeDailyMetrics
      .filter(m => creativeIdMap[m.creativeName])
      .map(m => ({
        creative_id: creativeIdMap[m.creativeName],
        date: m.date,
        spend: Math.round(m.spend * 100) / 100,
        impressions: Math.round(m.impressions),
        reach: Math.round(m.reach),
        clicks: null,
        leads: Math.round(m.leads)
      }));
    if (creativeDailyRows.length > 0) {
      await sbInsert('creative_daily_metrics', creativeDailyRows);
    }

    showCSVImportLoading(false);

    // 7. Show success toast
    showToast(
      `‚úì Import erfolgreich: ${analysis.totalLeads} Leads, ${analysis.creatives.length} Creatives, ${analysis.dailyMetrics.length} Tage`,
      'success'
    );

    // 8. Reset and navigate to detail
    _csvAnalysis = null;
    resetCSVImport();
    openCampaign(campaign.id);

  } catch (e) {
    showCSVImportLoading(false);
    console.error('CSV-Import fehlgeschlagen:', e);
    showToast('Import-Fehler: ' + (e.message || 'Unbekannter Fehler'), 'error');
  }
}

// ============================================
// CREATE CAMPAIGN
// ============================================
async function handleCreateCampaign(event) {
  event.preventDefault();

  if (!dbReady) {
    showToast('Datenbank nicht bereit. Bitte zuerst migration.sql ausf√ºhren.', 'error');
    return;
  }

  try {
    // 1. Get or create client
    let clientId = document.getElementById('form-client').value;

    if (!clientId) {
      const clientName = document.getElementById('form-client-name').value;
      const brand = document.getElementById('form-brand').value;

      if (!clientName) {
        showToast('Bitte Kundennamen eingeben', 'error');
        return;
      }

      const [newClient] = await sbInsert('clients', { name: clientName, brand: brand || null });
      clientId = newClient.id;
    }

    // 2. Create property
    const locationRating = document.getElementById('form-prop-location-rating').value || null;
    const propData = {
      client_id: clientId,
      name: document.getElementById('form-prop-name').value,
      address: document.getElementById('form-prop-address').value || null,
      plz: document.getElementById('form-prop-plz').value || null,
      stadtteil: document.getElementById('form-prop-stadtteil').value || null,
      city: document.getElementById('form-prop-city').value || null,
      property_type: document.getElementById('form-prop-type').value,
      size_sqm: parseFloat(document.getElementById('form-prop-size').value) || null,
      plot_size: parseFloat(document.getElementById('form-prop-plot-size').value) || null,
      rooms: parseFloat(document.getElementById('form-prop-rooms').value) || null,
      price: parseFloat(document.getElementById('form-prop-price').value) || null,
      location_rating: locationRating,
      micro_location: document.getElementById('form-prop-micro-location').value || null,
      price_from: document.getElementById('form-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('form-prop-price-from').value) || null) : null,
      price_to: document.getElementById('form-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('form-prop-price-to').value) || null) : null,
      size_from: document.getElementById('form-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('form-prop-size-from').value) || null) : null,
      size_to: document.getElementById('form-prop-type').value === 'neubauprojekt' ? (parseFloat(document.getElementById('form-prop-size-to').value) || null) : null,
      num_units: document.getElementById('form-prop-type').value === 'neubauprojekt' ? (parseInt(document.getElementById('form-prop-num-units').value) || null) : null
    };

    const [property] = await sbInsert('properties', propData);

    // 3. Create campaign (platform always meta)
    const campData = {
      property_id: property.id,
      platform: 'meta',
      campaign_name: document.getElementById('form-camp-name').value,
      campaign_type: document.getElementById('form-camp-type').value,
      start_date: document.getElementById('form-camp-start').value || null,
      end_date: document.getElementById('form-camp-end').value || null,
      total_budget: parseFloat(document.getElementById('form-camp-budget').value) || null,
      status: document.getElementById('form-camp-status').value
    };

    const [campaign] = await sbInsert('campaigns', campData);

    showToast('Kampagne erfolgreich erstellt! ‚úì');
    document.getElementById('new-campaign-form').reset();
    showView('campaigns');

  } catch (e) {
    console.error('Kampagnenerstellung fehlgeschlagen:', e);
    showToast('Fehler: ' + (e.message || 'Unbekannter Fehler'), 'error');
  }
}

// ============================================
// ESCAPE HTML
// ============================================
function escHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ============================================
// STATISTICAL HELPERS
// ============================================
function pearsonCorrelation(x, y) {
  const n = x.length;
  if (n < 2) return null;
  const avgX = x.reduce((s,v) => s+v, 0) / n;
  const avgY = y.reduce((s,v) => s+v, 0) / n;
  let num = 0, denX = 0, denY = 0;
  for (let i = 0; i < n; i++) {
    const dx = x[i] - avgX, dy = y[i] - avgY;
    num += dx * dy;
    denX += dx * dx;
    denY += dy * dy;
  }
  const den = Math.sqrt(denX * denY);
  return den === 0 ? 0 : num / den;
}

function linearRegression(x, y) {
  const n = x.length;
  if (n < 2) return null;
  const avgX = x.reduce((s,v) => s+v, 0) / n;
  const avgY = y.reduce((s,v) => s+v, 0) / n;
  let num = 0, den = 0;
  for (let i = 0; i < n; i++) {
    num += (x[i] - avgX) * (y[i] - avgY);
    den += (x[i] - avgX) ** 2;
  }
  const slope = den === 0 ? 0 : num / den;
  return { slope, intercept: avgY - slope * avgX };
}

function percentileRank(value, values, lowerIsBetter) {
  if (lowerIsBetter === undefined) lowerIsBetter = true;
  const sorted = [...values].sort((a, b) => lowerIsBetter ? a - b : b - a);
  const rank = sorted.indexOf(value) + 1;
  return Math.round((1 - (rank - 1) / sorted.length) * 100);
}

function groupBy(arr, keyFn) {
  const map = {};
  arr.forEach(function(item) {
    const key = keyFn(item);
    if (!map[key]) map[key] = [];
    map[key].push(item);
  });
  return map;
}

function priceRange(price) {
  if (!price) return 'Unbekannt';
  if (price < 500000) return '< 500k';
  if (price < 1000000) return '500k ‚Äì 1M';
  if (price < 2000000) return '1M ‚Äì 2M';
  return '2M+';
}

function correlationLabel(r) {
  var abs = Math.abs(r);
  if (abs < 0.3) return 'schwach';
  if (abs < 0.6) return 'mittel';
  if (abs < 0.8) return 'stark';
  return 'sehr stark';
}

// ============================================
// BENCHMARK RENDERING (Detail View)
// ============================================
let _scatterChart = null;

async function renderBenchmarks(campaign, property, metrics) {
  const container = document.getElementById('detail-benchmarks');
  if (!container) return;
  container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

  try {
    var allCampaignsRaw = await sbGet('campaigns', 'select=*,properties(*),campaign_daily_metrics(spend,leads,impressions,reach)');
    if (!allCampaignsRaw || allCampaignsRaw.length < 2) {
      container.innerHTML = '';
      return;
    }

    // Calc metrics for each campaign
    var allData = allCampaignsRaw.map(function(c) {
      var m = c.campaign_daily_metrics || [];
      var spend = m.reduce(function(s, x) { return s + (x.spend || 0); }, 0);
      var leads = m.reduce(function(s, x) { return s + (x.leads || 0); }, 0);
      var impr = m.reduce(function(s, x) { return s + (x.impressions || 0); }, 0);
      var days = m.length || 1;
      return {
        id: c.id,
        name: c.campaign_name,
        prop: c.properties,
        spend: spend,
        leads: leads,
        impressions: impr,
        days: days,
        cpl: leads > 0 ? spend / leads : null,
        cpm: impr > 0 ? (spend / impr) * 1000 : null,
        leadsPerDay: leads / days
      };
    }).filter(function(d) { return d.leads > 0; });

    var N = allData.length;
    if (N < 2) { container.innerHTML = ''; return; }

    // Global averages
    var totalSpendAll = allData.reduce(function(s,d) { return s + d.spend; }, 0);
    var totalLeadsAll = allData.reduce(function(s,d) { return s + d.leads; }, 0);
    var totalImprAll = allData.reduce(function(s,d) { return s + d.impressions; }, 0);
    var totalDaysAll = allData.reduce(function(s,d) { return s + d.days; }, 0);
    var avgCPL = totalLeadsAll > 0 ? totalSpendAll / totalLeadsAll : 0;
    var avgCPM = totalImprAll > 0 ? (totalSpendAll / totalImprAll) * 1000 : 0;
    var avgLeadsDay = totalDaysAll > 0 ? totalLeadsAll / totalDaysAll : 0;

    // Current campaign
    var thisCPL = metrics.avgCPL;
    var thisCPM = metrics.avgCPM;
    var thisLeadsDay = metrics.avgLeadsDay;

    // Percentile
    var cplValues = allData.map(function(d) { return d.cpl; }).filter(function(v) { return v !== null; });
    var pctRank = thisCPL ? percentileRank(thisCPL, cplValues, true) : null;

    // Comparison helpers
    function compareMetric(val, avg) {
      if (!val || !avg || avg === 0) return { pct: 0, cls: 'neutral', arrow: '' };
      var pct = ((val - avg) / avg) * 100;
      var abs = Math.abs(pct);
      if (abs < 5) return { pct: pct, cls: 'neutral', arrow: '‚âà' };
      return { pct: pct, cls: pct < 0 ? 'good' : 'bad', arrow: pct < 0 ? '‚Üì' : '‚Üë' };
    }

    function compareMetricInverse(val, avg) {
      if (!val || !avg || avg === 0) return { pct: 0, cls: 'neutral', arrow: '' };
      var pct = ((val - avg) / avg) * 100;
      var abs = Math.abs(pct);
      if (abs < 5) return { pct: pct, cls: 'neutral', arrow: '‚âà' };
      return { pct: pct, cls: pct > 0 ? 'good' : 'bad', arrow: pct > 0 ? '‚Üë' : '‚Üì' };
    }

    var cplComp = compareMetric(thisCPL, avgCPL);
    var cpmComp = compareMetric(thisCPM, avgCPM);
    var lpdComp = compareMetricInverse(thisLeadsDay, avgLeadsDay);

    function fmtComp(val, avg, comp, unit) {
      if (!val) return '‚Äî';
      return formatEur(val) + ' (' + comp.arrow + Math.abs(comp.pct).toFixed(0) + '% vs. √ò ' + formatEur(avg) + ')';
    }

    // Property Insights
    var insights = [];
    // Group by property type
    var byType = groupBy(allData.filter(function(d) { return d.prop && d.prop.property_type; }), function(d) { return d.prop.property_type; });
    var typeKeys = Object.keys(byType);
    if (typeKeys.length > 1) {
      var typeAvgs = typeKeys.map(function(k) {
        var items = byType[k];
        var ts = items.reduce(function(s,d) { return s + d.spend; }, 0);
        var tl = items.reduce(function(s,d) { return s + d.leads; }, 0);
        var propLabel = {wohnung:'Wohnungen',haus:'H√§user',penthouse:'Penthouses',villa:'Villen',reihenhaus:'Reihenh√§user',grundstueck:'Grundst√ºcke',gewerbe:'Gewerbe',neubauprojekt:'Neubauprojekte',zweifamilienhaus:'Zweifamilienh√§user',sonstige:'Sonstige'}[k] || k;
        return { type: k, label: propLabel, cpl: tl > 0 ? ts / tl : null, count: items.length };
      }).filter(function(t) { return t.cpl !== null; });
      if (typeAvgs.length > 1) {
        typeAvgs.sort(function(a,b) { return a.cpl - b.cpl; });
        var parts = typeAvgs.map(function(t) { return t.label + ': √ò CPL ' + formatEur(t.cpl); });
        insights.push(parts.join(' | '));
      }
    }

    // Group by city
    var byCity = groupBy(allData.filter(function(d) { return d.prop && d.prop.city; }), function(d) { return d.prop.city; });
    var cityKeys = Object.keys(byCity);
    if (cityKeys.length > 1) {
      var cityAvgs = cityKeys.map(function(k) {
        var items = byCity[k];
        var ts = items.reduce(function(s,d) { return s + d.spend; }, 0);
        var tl = items.reduce(function(s,d) { return s + d.leads; }, 0);
        return { city: k, cpl: tl > 0 ? ts / tl : null, count: items.length };
      }).filter(function(c) { return c.cpl !== null; });
      if (cityAvgs.length > 1) {
        var parts2 = cityAvgs.map(function(c) { return c.city + ': √ò CPL ' + formatEur(c.cpl); });
        insights.push(parts2.join(' | '));
      }
    }

    // Group by price range
    var cheap = allData.filter(function(d) { return d.prop && d.prop.price && d.prop.price < 1000000; });
    var expensive = allData.filter(function(d) { return d.prop && d.prop.price && d.prop.price >= 1000000; });
    if (cheap.length > 0 && expensive.length > 0) {
      var cheapSpend = cheap.reduce(function(s,d) { return s + d.spend; }, 0);
      var cheapLeads = cheap.reduce(function(s,d) { return s + d.leads; }, 0);
      var expSpend = expensive.reduce(function(s,d) { return s + d.spend; }, 0);
      var expLeads = expensive.reduce(function(s,d) { return s + d.leads; }, 0);
      var cheapCPL = cheapLeads > 0 ? cheapSpend / cheapLeads : null;
      var expCPL = expLeads > 0 ? expSpend / expLeads : null;
      if (cheapCPL && expCPL && expCPL > 0) {
        var diffPct = Math.round(((expCPL - cheapCPL) / expCPL) * 100);
        if (Math.abs(diffPct) > 10) {
          insights.push('G√ºnstigere Objekte (< 1M‚Ç¨) haben √ò ' + Math.abs(diffPct) + '% ' + (diffPct > 0 ? 'niedrigeren' : 'h√∂heren') + ' CPL (' + formatEur(cheapCPL) + ' vs ' + formatEur(expCPL) + ')');
        }
      }
    }

    // Render
    var pctBadge = '';
    if (pctRank !== null) {
      var pctCls = pctRank >= 66 ? 'good' : pctRank >= 33 ? 'neutral' : 'bad';
      pctBadge = '<span class="benchmark-badge ' + pctCls + '">Top ' + pctRank + '%</span>';
    }

    var sampleNote = 'Basierend auf ' + N + ' Kampagnen';
    if (N < 5) sampleNote += ' (fr√ºhe Daten ‚Äì wird mit mehr Kampagnen genauer)';

    var insightsHtml = '';
    if (insights.length > 0) {
      insightsHtml = '<div class="benchmark-insights"><div class="benchmark-insights-title">üè† Objekt-Insights</div>' +
        insights.map(function(i) { return '<div class="insight-item">' + escHtml(i) + '</div>'; }).join('') +
        '</div>';
    }

    container.innerHTML =
      '<div class="benchmark-card">' +
        '<div class="card-header"><div class="card-title">üìä Benchmark ' + pctBadge + '</div></div>' +
        '<div class="card-body">' +
          '<div class="benchmark-grid">' +
            '<div class="benchmark-metric">' +
              '<div class="benchmark-metric-label">CPL</div>' +
              '<div class="benchmark-metric-value" style="color:var(--' + (cplComp.cls === 'good' ? 'green' : cplComp.cls === 'bad' ? 'red' : 'text-secondary') + ')">' + (thisCPL ? formatEur(thisCPL) : '‚Äî') + '</div>' +
              '<div class="benchmark-metric-compare" style="color:var(--' + (cplComp.cls === 'good' ? 'green' : cplComp.cls === 'bad' ? 'red' : 'text-muted') + ')">' + (thisCPL ? cplComp.arrow + Math.abs(cplComp.pct).toFixed(0) + '% vs. √ò ' + formatEur(avgCPL) : '') + '</div>' +
            '</div>' +
            '<div class="benchmark-metric">' +
              '<div class="benchmark-metric-label">CPM</div>' +
              '<div class="benchmark-metric-value" style="color:var(--' + (cpmComp.cls === 'good' ? 'green' : cpmComp.cls === 'bad' ? 'red' : 'text-secondary') + ')">' + (thisCPM ? formatEur(thisCPM) : '‚Äî') + '</div>' +
              '<div class="benchmark-metric-compare" style="color:var(--' + (cpmComp.cls === 'good' ? 'green' : cpmComp.cls === 'bad' ? 'red' : 'text-muted') + ')">' + (thisCPM ? cpmComp.arrow + Math.abs(cpmComp.pct).toFixed(0) + '% vs. √ò ' + formatEur(avgCPM) : '') + '</div>' +
            '</div>' +
            '<div class="benchmark-metric">' +
              '<div class="benchmark-metric-label">Leads/Tag</div>' +
              '<div class="benchmark-metric-value" style="color:var(--' + (lpdComp.cls === 'good' ? 'green' : lpdComp.cls === 'bad' ? 'red' : 'text-secondary') + ')">' + (thisLeadsDay ? thisLeadsDay.toFixed(1) : '‚Äî') + '</div>' +
              '<div class="benchmark-metric-compare" style="color:var(--' + (lpdComp.cls === 'good' ? 'green' : lpdComp.cls === 'bad' ? 'red' : 'text-muted') + ')">' + (thisLeadsDay ? lpdComp.arrow + Math.abs(lpdComp.pct).toFixed(0) + '% vs. √ò ' + avgLeadsDay.toFixed(1) : '') + '</div>' +
            '</div>' +
          '</div>' +
          insightsHtml +
          '<div class="benchmark-sample-note">' + escHtml(sampleNote) + '</div>' +
        '</div>' +
      '</div>';

  } catch (e) {
    console.error('Benchmark-Ladefehler:', e);
    container.innerHTML = '';
  }
}

// ============================================
// DATA INTELLIGENCE VIEW
// ============================================
let _diScatterChart = null;

async function loadDataIntelligence() {
  if (!dbReady) return;

  var loading = document.getElementById('data-intel-loading');
  var content = document.getElementById('data-intel-content');
  loading.style.display = 'flex';
  content.style.display = 'none';

  try {
    var allCampaignsRaw = await sbGet('campaigns', 'select=*,properties(*),campaign_daily_metrics(spend,leads,impressions,reach),creatives(*,creative_daily_metrics(spend,leads,impressions))');

    // Prepare campaign data
    var allData = (allCampaignsRaw || []).map(function(c) {
      var m = c.campaign_daily_metrics || [];
      var spend = m.reduce(function(s,x) { return s + (x.spend || 0); }, 0);
      var leads = m.reduce(function(s,x) { return s + (x.leads || 0); }, 0);
      var impr = m.reduce(function(s,x) { return s + (x.impressions || 0); }, 0);
      var days = m.length || 1;
      return {
        id: c.id,
        name: c.campaign_name,
        prop: c.properties,
        creatives: c.creatives || [],
        spend: spend,
        leads: leads,
        impressions: impr,
        days: days,
        cpl: leads > 0 ? spend / leads : null,
        cpm: impr > 0 ? (spend / impr) * 1000 : null,
        leadsPerDay: leads / days,
        startDate: c.start_date
      };
    }).filter(function(d) { return d.leads > 0; });

    var N = allData.length;

    // Global averages
    var totalSpendAll = allData.reduce(function(s,d) { return s + d.spend; }, 0);
    var totalLeadsAll = allData.reduce(function(s,d) { return s + d.leads; }, 0);
    var totalImprAll = allData.reduce(function(s,d) { return s + d.impressions; }, 0);
    var globalAvgCPL = totalLeadsAll > 0 ? totalSpendAll / totalLeadsAll : 0;
    var globalAvgCPM = totalImprAll > 0 ? (totalSpendAll / totalImprAll) * 1000 : 0;

    // Warning for small N
    var warningEl = document.getElementById('data-intel-warning');
    if (N < 5) {
      warningEl.innerHTML = '<div class="data-intel-warning">‚ö†Ô∏è Noch zu wenig Daten f√ºr statistische Signifikanz (' + N + ' Kampagnen). Die Ergebnisse sind erste Tendenzen.</div>';
    } else {
      warningEl.innerHTML = '';
    }

    // === SECTION A: Segment Performance Matrix ===
    renderSegmentMatrix(allData, globalAvgCPL, globalAvgCPM);

    // === SECTION B: Correlation Analysis ===
    renderCorrelationAnalysis(allData);

    // === SECTION C: Auto-Insights ===
    renderAutoInsights(allData, globalAvgCPL, N);

    // === SECTION D: Scatter Plot ===
    renderScatterPlot(allData);

    loading.style.display = 'none';
    content.style.display = 'block';

  } catch (e) {
    console.error('Data Intelligence Ladefehler:', e);
    loading.style.display = 'none';
    content.style.display = 'block';
    document.getElementById('data-intel-segments').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div class="empty-state-title">Fehler beim Laden</div><div class="empty-state-desc" style="color:var(--red);font-family:monospace;font-size:12px;">' + escHtml(e.message || String(e)) + '</div></div>';
  }
}

function renderSegmentMatrix(allData, globalAvgCPL, globalAvgCPM) {
  var container = document.getElementById('data-intel-segments');

  function buildTable(title, grouped, labelFn) {
    var keys = Object.keys(grouped).sort();
    if (keys.length === 0) return '';
    var rows = keys.map(function(k) {
      var items = grouped[k];
      var sp = items.reduce(function(s,d) { return s + d.spend; }, 0);
      var ld = items.reduce(function(s,d) { return s + d.leads; }, 0);
      var im = items.reduce(function(s,d) { return s + d.impressions; }, 0);
      var cpl = ld > 0 ? sp / ld : null;
      var cpm = im > 0 ? (sp / im) * 1000 : null;
      var cplCls = cpl !== null ? (cpl < globalAvgCPL * 0.95 ? 'segment-cell-good' : cpl > globalAvgCPL * 1.05 ? 'segment-cell-bad' : '') : '';
      return '<tr>' +
        '<td style="font-weight:600;">' + escHtml(labelFn ? labelFn(k) : k) + '</td>' +
        '<td class="' + cplCls + '">' + (cpl !== null ? formatEur(cpl) : '‚Äî') + '</td>' +
        '<td>' + (cpm !== null ? formatEur(cpm) : '‚Äî') + '</td>' +
        '<td>' + items.length + '</td>' +
        '</tr>';
    }).join('');

    return '<div class="card">' +
      '<div class="card-header"><div class="card-title">' + escHtml(title) + '</div></div>' +
      '<div class="card-body" style="padding:0;">' +
        '<table class="segment-table"><thead><tr><th>Segment</th><th>√ò CPL</th><th>√ò CPM</th><th>Kampagnen</th></tr></thead>' +
        '<tbody>' + rows + '</tbody></table>' +
      '</div></div>';
  }

  var propTypeLabels = {wohnung:'Wohnung',haus:'Haus',penthouse:'Penthouse',villa:'Villa',reihenhaus:'Reihenhaus',grundstueck:'Grundst√ºck',gewerbe:'Gewerbe',neubauprojekt:'Neubauprojekt',zweifamilienhaus:'Zweifamilienhaus',sonstige:'Sonstige'};

  // By City
  var byCity = groupBy(allData.filter(function(d) { return d.prop && d.prop.city; }), function(d) { return d.prop.city; });
  // By Property Type
  var byType = groupBy(allData.filter(function(d) { return d.prop && d.prop.property_type; }), function(d) { return d.prop.property_type; });
  // By Location Rating
  var byRating = groupBy(allData.filter(function(d) { return d.prop && (d.prop.location_rating || d.prop.city); }), function(d) { return d.prop.location_rating || getCityRating(d.prop.city) || '?'; });
  // By Price Range
  var byPrice = groupBy(allData.filter(function(d) { return d.prop && d.prop.price; }), function(d) { return priceRange(d.prop.price); });

  var html = '';
  html += buildTable('Nach Stadt', byCity);
  html += buildTable('Nach Objektart', byType, function(k) { return propTypeLabels[k] || k; });
  html += buildTable('Nach Standort-Rating', byRating);
  html += buildTable('Nach Preisklasse', byPrice);

  container.innerHTML = html || '<div class="empty-state"><div class="empty-state-desc">Nicht gen√ºgend Daten f√ºr Segmentierung</div></div>';
}

function renderCorrelationAnalysis(allData) {
  var container = document.getElementById('data-intel-correlations');

  var correlations = [];
  var withPrice = allData.filter(function(d) { return d.prop && d.prop.price && d.cpl; });
  var withSize = allData.filter(function(d) { return d.prop && d.prop.size_sqm && d.cpl; });
  var withPPSQM = allData.filter(function(d) { return d.prop && d.prop.price && d.prop.size_sqm && d.cpl; });

  if (withPrice.length >= 2) {
    var r = pearsonCorrelation(withPrice.map(function(d) { return d.prop.price; }), withPrice.map(function(d) { return d.cpl; }));
    if (r !== null) correlations.push({ label: 'Preis ‚Üî CPL', r: r, n: withPrice.length });
  }
  if (withSize.length >= 2) {
    var r2 = pearsonCorrelation(withSize.map(function(d) { return d.prop.size_sqm; }), withSize.map(function(d) { return d.cpl; }));
    if (r2 !== null) correlations.push({ label: 'Wohnfl√§che ‚Üî CPL', r: r2, n: withSize.length });
  }
  if (withPPSQM.length >= 2) {
    var ppsqm = withPPSQM.map(function(d) { return d.prop.price / d.prop.size_sqm; });
    var r3 = pearsonCorrelation(ppsqm, withPPSQM.map(function(d) { return d.cpl; }));
    if (r3 !== null) correlations.push({ label: 'qm-Preis ‚Üî CPL', r: r3, n: withPPSQM.length });
  }

  if (correlations.length === 0) {
    container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;">Nicht gen√ºgend numerische Daten f√ºr Korrelationsanalyse.</div>';
    return;
  }

  // Sort by absolute r descending
  correlations.sort(function(a,b) { return Math.abs(b.r) - Math.abs(a.r); });

  var html = correlations.map(function(c) {
    var absR = Math.abs(c.r);
    var isPos = c.r >= 0;
    var barWidth = absR * 50; // max 50% of track
    var barLeft = isPos ? 50 : (50 - barWidth);
    var cls = isPos ? 'positive' : 'negative';
    var label = correlationLabel(c.r);
    var dirLabel = isPos ? 'positive' : 'negative';

    return '<div class="correlation-bar-container">' +
      '<div class="correlation-bar-label">' +
        '<span>' + escHtml(c.label) + '</span>' +
        '<span style="color:var(--' + (isPos ? 'red' : 'green') + ');font-weight:700;">r = ' + c.r.toFixed(2) + ' (' + label + ' ' + dirLabel + ')</span>' +
      '</div>' +
      '<div class="correlation-bar-track">' +
        '<div class="correlation-bar-center"></div>' +
        '<div class="correlation-bar-fill ' + cls + '" style="left:' + barLeft + '%;width:' + barWidth + '%;"></div>' +
      '</div>' +
      '<div class="correlation-bar-sublabel">' + (isPos ? 'H√∂herer Wert ‚Üí h√∂herer CPL' : 'H√∂herer Wert ‚Üí niedrigerer CPL') + ' (n=' + c.n + ')</div>' +
      '</div>';
  }).join('');

  container.innerHTML = html;
}

function renderAutoInsights(allData, globalAvgCPL, N) {
  var container = document.getElementById('data-intel-insights');
  var insights = [];

  // 1. Price segments
  var cheap = allData.filter(function(d) { return d.prop && d.prop.price && d.prop.price < 1000000; });
  var expensive = allData.filter(function(d) { return d.prop && d.prop.price && d.prop.price >= 1000000; });
  if (cheap.length > 0 && expensive.length > 0) {
    var cs = cheap.reduce(function(s,d) { return s + d.spend; }, 0);
    var cl = cheap.reduce(function(s,d) { return s + d.leads; }, 0);
    var es = expensive.reduce(function(s,d) { return s + d.spend; }, 0);
    var el = expensive.reduce(function(s,d) { return s + d.leads; }, 0);
    var cheapCPL = cl > 0 ? cs / cl : null;
    var expCPL = el > 0 ? es / el : null;
    if (cheapCPL && expCPL) {
      var diff = Math.round(Math.abs((expCPL - cheapCPL) / Math.max(expCPL, cheapCPL)) * 100);
      if (diff > 10) {
        var better = cheapCPL < expCPL ? 'unter' : '√ºber';
        insights.push('Objekte ' + better + ' 1M‚Ç¨ haben √ò ' + diff + '% niedrigeren CPL (' + formatEur(Math.min(cheapCPL, expCPL)) + ' vs ' + formatEur(Math.max(cheapCPL, expCPL)) + ')');
      }
    }
  }

  // 2. Property type comparison
  var byType = groupBy(allData.filter(function(d) { return d.prop && d.prop.property_type; }), function(d) { return d.prop.property_type; });
  var typeKeys = Object.keys(byType);
  if (typeKeys.length > 1) {
    var propTypeLabels = {wohnung:'Wohnungen',haus:'H√§user',penthouse:'Penthouses',villa:'Villen',reihenhaus:'Reihenh√§user',grundstueck:'Grundst√ºcke',gewerbe:'Gewerbe',neubauprojekt:'Neubauprojekte',zweifamilienhaus:'Zweifamilienh√§user',sonstige:'Sonstige'};
    var typeAvgs = typeKeys.map(function(k) {
      var items = byType[k];
      var ts = items.reduce(function(s,d) { return s + d.spend; }, 0);
      var tl = items.reduce(function(s,d) { return s + d.leads; }, 0);
      return { type: k, label: propTypeLabels[k] || k, cpl: tl > 0 ? ts / tl : null };
    }).filter(function(t) { return t.cpl !== null; }).sort(function(a,b) { return a.cpl - b.cpl; });

    if (typeAvgs.length > 1) {
      var best = typeAvgs[0];
      var worst = typeAvgs[typeAvgs.length - 1];
      if (best.cpl !== worst.cpl) {
        insights.push(best.label + ' performen ' + (best.cpl < worst.cpl * 0.7 ? 'deutlich ' : '') + 'besser als ' + worst.label + ' (CPL ' + formatEur(best.cpl) + ' vs ' + formatEur(worst.cpl) + ')');
      }
    }
  }

  // 3. Strongest correlation
  var withPrice = allData.filter(function(d) { return d.prop && d.prop.price && d.cpl; });
  var withSize = allData.filter(function(d) { return d.prop && d.prop.size_sqm && d.cpl; });
  var withPPSQM = allData.filter(function(d) { return d.prop && d.prop.price && d.prop.size_sqm && d.cpl; });
  var corrs = [];
  if (withPrice.length >= 2) {
    var r1 = pearsonCorrelation(withPrice.map(function(d) { return d.prop.price; }), withPrice.map(function(d) { return d.cpl; }));
    if (r1 !== null) corrs.push({ label: 'Objektpreis', r: r1 });
  }
  if (withSize.length >= 2) {
    var r2 = pearsonCorrelation(withSize.map(function(d) { return d.prop.size_sqm; }), withSize.map(function(d) { return d.cpl; }));
    if (r2 !== null) corrs.push({ label: 'Wohnfl√§che', r: r2 });
  }
  if (withPPSQM.length >= 2) {
    var ppsqm = withPPSQM.map(function(d) { return d.prop.price / d.prop.size_sqm; });
    var r3 = pearsonCorrelation(ppsqm, withPPSQM.map(function(d) { return d.cpl; }));
    if (r3 !== null) corrs.push({ label: 'qm-Preis', r: r3 });
  }
  if (corrs.length > 0) {
    corrs.sort(function(a,b) { return Math.abs(b.r) - Math.abs(a.r); });
    var strongest = corrs[0];
    insights.push('Der ' + strongest.label + ' korreliert am st√§rksten mit dem CPL (r = ' + strongest.r.toFixed(2) + ', ' + correlationLabel(strongest.r) + ')');
  }

  // 4. City comparison
  var byCity = groupBy(allData.filter(function(d) { return d.prop && d.prop.city; }), function(d) { return d.prop.city; });
  var cityKeys = Object.keys(byCity);
  if (cityKeys.length > 1) {
    var cityData = cityKeys.map(function(k) {
      var items = byCity[k];
      var ts = items.reduce(function(s,d) { return s + d.spend; }, 0);
      var tl = items.reduce(function(s,d) { return s + d.leads; }, 0);
      var td = items.reduce(function(s,d) { return s + d.days; }, 0);
      return { city: k, cpl: tl > 0 ? ts / tl : null, leadsPerDay: td > 0 ? tl / td : 0 };
    }).filter(function(c) { return c.cpl !== null; }).sort(function(a,b) { return a.cpl - b.cpl; });

    if (cityData.length >= 2) {
      var best2 = cityData[0];
      var other = cityData[cityData.length - 1];
      if (best2.city !== other.city) {
        var diffPct = Math.round(Math.abs((other.cpl - best2.cpl) / best2.cpl) * 100);
        var lpdNote = other.leadsPerDay > best2.leadsPerDay ? ', aber h√∂heres Lead-Volumen pro Tag' : '';
        insights.push(other.city + ' hat ' + diffPct + '% h√∂heren CPL als ' + best2.city + lpdNote);
      }
    }
  }

  // 5. Trend detection
  var sorted = allData.filter(function(d) { return d.startDate; }).sort(function(a,b) { return (a.startDate || '').localeCompare(b.startDate || ''); });
  if (sorted.length >= 2) {
    var oldest = sorted[0];
    var newest = sorted[sorted.length - 1];
    if (oldest.cpl && newest.cpl && oldest.id !== newest.id) {
      if (newest.cpl < oldest.cpl * 0.8) {
        insights.push('Trend: Neueste Kampagne (' + escHtml(newest.name) + ') hat deutlich niedrigeren CPL als √§lteste');
      } else if (newest.cpl > oldest.cpl * 1.2) {
        insights.push('Trend: Neueste Kampagne (' + escHtml(newest.name) + ') hat h√∂heren CPL als √§lteste ‚Äì Optimierung pr√ºfen');
      }
    }
  }

  // 6. Creative type insights across campaigns
  var allCreativeTypes = {};
  allData.forEach(function(d) {
    (d.creatives || []).forEach(function(c) {
      var type = c.creative_type || 'unknown';
      var cm = c.creative_daily_metrics || [];
      if (!allCreativeTypes[type]) allCreativeTypes[type] = { leads: 0, spend: 0 };
      allCreativeTypes[type].leads += cm.reduce(function(s,m) { return s + (m.leads || 0); }, 0);
      allCreativeTypes[type].spend += cm.reduce(function(s,m) { return s + (m.spend || 0); }, 0);
    });
  });
  var ctKeys = Object.keys(allCreativeTypes).filter(function(k) { return allCreativeTypes[k].leads > 0; });
  if (ctKeys.length > 1) {
    var ctData = ctKeys.map(function(k) {
      var t = allCreativeTypes[k];
      return { type: k, label: getCreativeTypeLabel(k), cpl: t.leads > 0 ? t.spend / t.leads : null, leads: t.leads };
    }).filter(function(t) { return t.cpl !== null; }).sort(function(a,b) { return a.cpl - b.cpl; });
    if (ctData.length > 1) {
      insights.push(ctData[0].label + ' hat den besten CPL √ºber alle Kampagnen (√ò ' + formatEur(ctData[0].cpl) + ', ' + ctData[0].leads + ' Leads)');
    }
  }

  // Render
  if (insights.length === 0) {
    container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;">Noch nicht gen√ºgend Daten f√ºr automatische Insights.</div>';
    return;
  }

  container.innerHTML = '<div style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">üí° Insights (basierend auf ' + N + ' Kampagnen)</div>' +
    insights.map(function(i) { return '<div class="insight-item">' + i + '</div>'; }).join('');
}

function renderScatterPlot(allData) {
  var canvas = document.getElementById('chart-scatter-cpl');
  if (!canvas) return;
  var ctx = canvas.getContext('2d');
  if (_diScatterChart) _diScatterChart.destroy();

  var withPrice = allData.filter(function(d) { return d.prop && d.prop.price && d.cpl; });
  if (withPrice.length < 2) {
    var parent = canvas.parentElement;
    parent.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:60px;">Mindestens 2 Kampagnen mit Preisdaten n√∂tig.</div>';
    return;
  }

  var prices = withPrice.map(function(d) { return d.prop.price; });
  var cpls = withPrice.map(function(d) { return d.cpl; });

  // Trend line
  var reg = linearRegression(prices, cpls);
  var minPrice = Math.min.apply(null, prices);
  var maxPrice = Math.max.apply(null, prices);

  var scatterData = withPrice.map(function(d) {
    return { x: d.prop.price, y: d.cpl, label: d.name };
  });

  var trendData = [];
  if (reg) {
    trendData = [
      { x: minPrice, y: reg.slope * minPrice + reg.intercept },
      { x: maxPrice, y: reg.slope * maxPrice + reg.intercept }
    ];
  }

  _diScatterChart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'Kampagnen',
          data: scatterData,
          backgroundColor: 'rgba(99, 102, 241, 0.8)',
          borderColor: 'rgba(99, 102, 241, 1)',
          borderWidth: 2,
          pointRadius: 8,
          pointHoverRadius: 12
        },
        {
          label: 'Trendlinie',
          data: trendData,
          type: 'line',
          borderColor: 'rgba(245, 158, 11, 0.6)',
          borderWidth: 2,
          borderDash: [6, 4],
          pointRadius: 0,
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(tooltipCtx) {
              var item = tooltipCtx.raw;
              if (item.label) return item.label + ': Preis ' + formatEur(item.x) + ', CPL ' + formatEur(item.y);
              return 'Preis ' + formatEur(item.x) + ', CPL ' + formatEur(item.y);
            }
          }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'Objektpreis (‚Ç¨)', color: '#8888a0' },
          ticks: { callback: function(v) { return (v / 1000).toFixed(0) + 'k ‚Ç¨'; } },
          grid: { color: 'rgba(38, 38, 54, 0.5)' }
        },
        y: {
          title: { display: true, text: 'CPL (‚Ç¨)', color: '#8888a0' },
          ticks: { callback: function(v) { return v.toFixed(0) + ' ‚Ç¨'; } },
          grid: { color: 'rgba(38, 38, 54, 0.5)' },
          beginAtZero: true
        }
      }
    }
  });
}

// ============================================
// PROPERTY PREDICTOR
// ============================================
let _compChartInstance = null;

function getPerformanceScore(predictedCPL, avgCPL) {
  if (!predictedCPL || !avgCPL || avgCPL === 0) return { stars: 3, label: 'Durchschnitt', cls: 'pred-score-yellow' };
  const ratio = predictedCPL / avgCPL;
  if (ratio < 0.4) return { stars: 5, label: 'Exzellent', cls: 'pred-score-green' };
  if (ratio < 0.7) return { stars: 4, label: 'Gut', cls: 'pred-score-yellow-green' };
  if (ratio < 1.3) return { stars: 3, label: 'Durchschnitt', cls: 'pred-score-yellow' };
  if (ratio < 1.8) return { stars: 2, label: 'Unterdurchschnittlich', cls: 'pred-score-orange' };
  return { stars: 1, label: 'Schwach', cls: 'pred-score-red' };
}

function renderStars(count) {
  let html = '';
  for (let i = 1; i <= 5; i++) {
    html += '<span class="' + (i <= count ? 'star-active' : 'star-inactive') + '">‚òÖ</span>';
  }
  return html;
}

// ============================================
// CREATIVE RECOMMENDATIONS
// Weight creative types by similarity to input property
// ============================================
function getCreativeRecommendations(similarCampaigns, allCreatives) {
  const typeScores = {};

  similarCampaigns.forEach(function(camp) {
    const campCreatives = allCreatives.filter(function(c) { return c.campaign_id === camp.campaign_id; });
    if (!campCreatives.length) return;

    // Calculate total campaign spend/leads for avgCPL
    const totalSpend = campCreatives.reduce(function(s, c) {
      return s + (c.creative_daily_metrics || []).reduce(function(ss, m) { return ss + (m.spend || 0); }, 0);
    }, 0);
    const totalLeads = campCreatives.reduce(function(s, c) {
      return s + (c.creative_daily_metrics || []).reduce(function(ss, m) { return ss + (m.leads || 0); }, 0);
    }, 0);
    const avgCPL = totalLeads > 0 ? totalSpend / totalLeads : 0;

    // Score each creative type
    campCreatives.forEach(function(c) {
      const type = c.creative_type || 'unknown';
      const metrics = c.creative_daily_metrics || [];
      const spend = metrics.reduce(function(s, m) { return s + (m.spend || 0); }, 0);
      const leads = metrics.reduce(function(s, m) { return s + (m.leads || 0); }, 0);
      const cpl = leads > 0 ? spend / leads : null;
      const score = calcScore(leads, cpl, avgCPL);

      if (!typeScores[type]) {
        typeScores[type] = { type: type, totalScore: 0, totalWeight: 0, totalLeads: 0, totalSpend: 0, campaigns: 0 };
      }

      const weight = camp.similarity || camp.combinedWeight || 1;
      typeScores[type].totalScore += score * weight;
      typeScores[type].totalWeight += weight;
      typeScores[type].totalLeads += leads;
      typeScores[type].totalSpend += spend;
      typeScores[type].campaigns += 1;
    });
  });

  return Object.values(typeScores)
    .map(function(t) {
      return {
        type: t.type,
        avgScore: t.totalWeight > 0 ? t.totalScore / t.totalWeight : 0,
        avgCPL: t.totalLeads > 0 ? t.totalSpend / t.totalLeads : null,
        totalLeads: t.totalLeads,
        campaigns: t.campaigns
      };
    })
    .filter(function(t) { return t.totalLeads > 0 || t.campaigns > 0; })
    .sort(function(a, b) { return b.avgScore - a.avgScore; });
}

function renderCreativeRecommendations(recommendations) {
  if (!recommendations || recommendations.length === 0) {
    return '<div class="creative-rec-empty">Keine Creative-Daten f√ºr √§hnliche Kampagnen verf√ºgbar</div>';
  }

  var medals = ['ü•á', 'ü•à', 'ü•â'];
  var maxScore = recommendations[0].avgScore || 1;
  var totalScore = recommendations.reduce(function(s, r) { return s + r.avgScore; }, 0);

  var html = '';
  recommendations.forEach(function(rec, i) {
    var medal = i < 3 ? medals[i] : (i + 1) + '.';
    var pct = maxScore > 0 ? Math.round((rec.avgScore / maxScore) * 100) : 0;
    var label = getCreativeTypeLabel(rec.type);
    var cplStr = rec.avgCPL !== null ? formatEur(rec.avgCPL) : '‚Äî';
    var scoreStr = rec.avgScore.toFixed(1);

    html += '<div class="creative-rec-item">' +
      '<div class="creative-rec-badge">' + medal + '</div>' +
      '<div class="creative-rec-info">' +
        '<div class="creative-rec-name">' + escHtml(label) + '</div>' +
        '<div class="creative-rec-stats">' +
          '<span>Score: <strong>' + scoreStr + '</strong></span>' +
          '<span>√ò CPL: <strong>' + cplStr + '</strong></span>' +
          '<span>' + rec.totalLeads + ' Leads</span>' +
          '<span>' + rec.campaigns + ' Kampagnen</span>' +
        '</div>' +
        '<div class="creative-rec-bar-wrap">' +
          '<div class="creative-rec-bar"><div class="creative-rec-bar-fill" style="width:' + pct + '%;"></div></div>' +
        '</div>' +
      '</div>' +
    '</div>';
  });

  // Auto-generated recommendation text
  var tipText = '';
  if (recommendations.length >= 1) {
    var top = recommendations[0];
    var topLabel = getCreativeTypeLabel(top.type);
    var topScorePct = totalScore > 0 ? (top.avgScore / totalScore) * 100 : 100;

    if (recommendations.length >= 2) {
      var second = recommendations[1];
      var secondLabel = getCreativeTypeLabel(second.type);
      var ratio = second.avgScore > 0 ? top.avgScore / second.avgScore : Infinity;

      if (topScorePct > 70) {
        tipText = 'Setze haupts√§chlich auf <strong>' + escHtml(topLabel) + '</strong>.';
      } else if (ratio < 1.3) {
        tipText = 'Kombiniere <strong>' + escHtml(topLabel) + '</strong> und <strong>' + escHtml(secondLabel) + '</strong> f√ºr optimale Performance.';
      } else {
        tipText = 'Setze haupts√§chlich auf <strong>' + escHtml(topLabel) + '</strong>.';
      }

      // Find low-volume types with good CPL
      var avgCPLAll = recommendations.reduce(function(s, r) { return s + (r.avgCPL || 0); }, 0) / recommendations.length;
      for (var j = 1; j < recommendations.length; j++) {
        var r = recommendations[j];
        if (r.avgCPL !== null && r.avgCPL < avgCPLAll * 0.85 && r.totalLeads < top.totalLeads * 0.3) {
          tipText += ' ' + escHtml(getCreativeTypeLabel(r.type)) + ' hat niedrigen CPL aber wenig Volumen ‚Äì als Erg√§nzung testen.';
          break;
        }
      }
    } else {
      tipText = 'Setze auf <strong>' + escHtml(topLabel) + '</strong> ‚Äî einziger Typ mit Daten.';
    }
  }

  if (tipText) {
    html += '<div class="creative-rec-tip">üí° ' + tipText + '</div>';
  }

  return html;
}

var _predictionCreativesCache = null;

async function loadCampaignDataForPrediction() {
  const allRaw = await sbGet('campaigns', 'select=*,properties(*),campaign_daily_metrics(spend,leads,impressions),creatives(*,creative_daily_metrics(spend,leads,impressions))');
  // Store all creatives for creative recommendation
  _predictionCreativesCache = [];
  (allRaw || []).forEach(function(c) {
    (c.creatives || []).forEach(function(cr) {
      _predictionCreativesCache.push(cr);
    });
  });
  return (allRaw || []).map(function(c) {
    const m = c.campaign_daily_metrics || [];
    const spend = m.reduce(function(s,x) { return s + (x.spend || 0); }, 0);
    const leads = m.reduce(function(s,x) { return s + (x.leads || 0); }, 0);
    const impressions = m.reduce(function(s,x) { return s + (x.impressions || 0); }, 0);
    const days = m.length || 0;
    const prop = c.properties || {};
    return {
      campaign_id: c.id,
      campaign_name: c.campaign_name,
      start_date: c.start_date,
      end_date: c.end_date,
      total_budget: c.total_budget,
      status: c.status,
      id: c.id,
      name: c.campaign_name,
      prop: {
        price: prop.property_type === 'neubauprojekt' && prop.price_from ? prop.price_from : (prop.price || 0),
        size_sqm: prop.size_sqm || 0,
        property_type: prop.property_type || 'unknown',
        city: prop.city || '',
        location_rating: prop.location_rating || (prop.city ? getCityRating(prop.city) : null),
        price_per_sqm: prop.property_type === 'neubauprojekt' && prop.price_from && prop.size_from
          ? prop.price_from / prop.size_from
          : ((prop.price && prop.size_sqm) ? prop.price / prop.size_sqm : null),
        rooms: prop.rooms || null,
        plot_size: prop.plot_size || null,
        price_from: prop.price_from || null,
        price_to: prop.price_to || null,
        size_from: prop.size_from || null,
        size_to: prop.size_to || null,
        num_units: prop.num_units || null
      },
      spend: spend,
      leads: leads,
      impressions: impressions,
      days: days,
      cpl: leads > 0 ? spend / leads : null
    };
  }).filter(function(d) { return d.leads > 0 && d.cpl !== null; });
}

// ============================================
// ADVANCED PREDICTION ENGINE
// k-NN Similarity + Temporal Decay + Bayesian Confidence
// ============================================

// Step 1: Feature Engineering ‚Äî normalize to 0-1 range
function engineFeatures(prop, allProps) {
  const prices = allProps.map(function(p) { return p.price; }).filter(function(v) { return v > 0; });
  const sizes = allProps.map(function(p) { return p.size_sqm; }).filter(function(v) { return v > 0; });
  const pricePerSqms = allProps.map(function(p) {
    return (p.price && p.size_sqm) ? p.price / p.size_sqm : null;
  }).filter(function(v) { return v !== null; });

  var normalize = function(val, arr) {
    if (val == null || arr.length < 2) return 0.5;
    var min = Math.min.apply(null, arr);
    var max = Math.max.apply(null, arr);
    if (max === min) return 0.5;
    return Math.max(0, Math.min(1, (val - min) / (max - min)));
  };

  return {
    price_norm: normalize(prop.price, prices),
    size_norm: normalize(prop.size_sqm, sizes),
    ppsqm_norm: normalize((prop.price && prop.size_sqm) ? prop.price / prop.size_sqm : null, pricePerSqms),
    type: prop.property_type || 'unknown',
    city: (prop.city || '').toLowerCase().trim(),
    rating: prop.location_rating || 'C'
  };
}

// Step 2: Multi-Dimensional Similarity (k-NN)
function campaignSimilarity(inputFeatures, campaignFeatures) {
  var priceDist = Math.abs(inputFeatures.price_norm - campaignFeatures.price_norm);
  var sizeDist = Math.abs(inputFeatures.size_norm - campaignFeatures.size_norm);
  var ppsqmDist = Math.abs(inputFeatures.ppsqm_norm - campaignFeatures.ppsqm_norm);
  var typeMatch = inputFeatures.type === campaignFeatures.type ? 0 : 1;
  var cityMatch = inputFeatures.city === campaignFeatures.city ? 0 : 1;
  var inputRatingIdx = 'ABCD'.indexOf(inputFeatures.rating);
  var campRatingIdx = 'ABCD'.indexOf(campaignFeatures.rating);
  var ratingDist = (inputRatingIdx >= 0 && campRatingIdx >= 0) ? Math.abs(inputRatingIdx - campRatingIdx) / 3 : 0.5;

  var weights = {
    ppsqm: 0.30,
    price: 0.20,
    type: 0.20,
    size: 0.10,
    city: 0.10,
    rating: 0.10
  };

  var distance = weights.ppsqm * ppsqmDist
               + weights.price * priceDist
               + weights.type * typeMatch
               + weights.size * sizeDist
               + weights.city * cityMatch
               + weights.rating * ratingDist;

  return 1 - distance;
}

// Step 3: Temporal Decay
function temporalWeight(campaignEndDate) {
  var now = new Date();
  var end = new Date(campaignEndDate);
  var daysSince = Math.max(0, (now - end) / (1000 * 60 * 60 * 24));
  var lambda = 0.005; // half-life ~140 days
  return Math.exp(-lambda * daysSince);
}

// Step 4: Bayesian-Style Confidence Band
function bayesianEstimate(predictions, weights) {
  var prior = { mean: 10.0, variance: 25.0 };

  var totalWeight = weights.reduce(function(s, w) { return s + w; }, 0);
  if (totalWeight === 0) {
    return {
      mean: prior.mean,
      low: prior.mean - Math.sqrt(prior.variance) * 1.5,
      high: prior.mean + Math.sqrt(prior.variance) * 1.5,
      confidence: 0,
      priorInfluence: 100,
      dataInfluence: 0
    };
  }

  var dataMean = predictions.reduce(function(s, p, i) { return s + p * weights[i]; }, 0) / totalWeight;
  var dataVariance = predictions.reduce(function(s, p, i) { return s + weights[i] * Math.pow(p - dataMean, 2); }, 0) / totalWeight;

  var n = predictions.length;
  var priorPrecision = 1 / prior.variance;
  var dataPrecision = n / (dataVariance + 0.01);

  var posteriorPrecision = priorPrecision + dataPrecision;
  var posteriorMean = (priorPrecision * prior.mean + dataPrecision * dataMean) / posteriorPrecision;
  var posteriorVariance = 1 / posteriorPrecision;
  var posteriorStd = Math.sqrt(posteriorVariance);

  var confidence = Math.min(100, Math.round((dataPrecision / posteriorPrecision) * 100));

  return {
    mean: posteriorMean,
    low: Math.max(0.5, posteriorMean - 1.5 * posteriorStd),
    high: posteriorMean + 1.5 * posteriorStd,
    confidence: confidence,
    priorInfluence: Math.round((priorPrecision / posteriorPrecision) * 100),
    dataInfluence: Math.round((dataPrecision / posteriorPrecision) * 100)
  };
}

// Step 5: Feature Importance
function calculateFeatureImportance(inputFeatures, scoredCampaigns) {
  var features = ['ppsqm', 'price', 'type', 'size', 'city', 'rating'];
  var labels = {
    ppsqm: '‚Ç¨/qm',
    price: 'Preis',
    type: 'Objektart',
    size: 'Gr√∂√üe',
    city: 'Stadt',
    rating: 'Standort-Rating'
  };

  var allCampProps = scoredCampaigns.map(function(s) { return s.prop; });
  var importance = {};

  features.forEach(function(f) {
    var distances = scoredCampaigns.map(function(c) {
      var cf = engineFeatures(c.prop, allCampProps);
      switch(f) {
        case 'ppsqm': return Math.abs(inputFeatures.ppsqm_norm - cf.ppsqm_norm);
        case 'price': return Math.abs(inputFeatures.price_norm - cf.price_norm);
        case 'type': return inputFeatures.type === cf.type ? 0 : 1;
        case 'size': return Math.abs(inputFeatures.size_norm - cf.size_norm);
        case 'city': return inputFeatures.city === cf.city ? 0 : 1;
        case 'rating':
          var ir = 'ABCD'.indexOf(inputFeatures.rating);
          var cr = 'ABCD'.indexOf(cf.rating);
          return (ir >= 0 && cr >= 0) ? Math.abs(ir - cr) / 3 : 0.5;
        default: return 0;
      }
    });
    var avg = distances.length > 0 ? distances.reduce(function(s,v) { return s + v; }, 0) / distances.length : 0;
    importance[f] = { variance: avg, label: labels[f] };
  });

  var total = Object.keys(importance).reduce(function(s, k) { return s + importance[k].variance; }, 0);
  Object.keys(importance).forEach(function(f) {
    importance[f].pct = total > 0 ? Math.round((importance[f].variance / total) * 100) : 0;
  });

  return importance;
}

// Step 6: Main Prediction Function
function predictCPLAdvanced(inputProp, allData) {
  var N = allData.length;
  if (N === 0) {
    return {
      prediction: { mean: 10, low: 5, high: 15, confidence: 0, priorInfluence: 100, dataInfluence: 0 },
      method: 'prior_only',
      similarities: [],
      featureImportance: {},
      N: 0,
      globalAvgCPL: 10
    };
  }

  var allProps = allData.map(function(d) { return d.prop; }).filter(function(p) { return p; });
  var inputFeatures = engineFeatures(inputProp, allProps);

  var scored = allData.filter(function(d) { return d.cpl > 0; }).map(function(d) {
    var campFeatures = engineFeatures(d.prop, allProps);
    var similarity = campaignSimilarity(inputFeatures, campFeatures);
    var temporal = temporalWeight(d.end_date || new Date().toISOString());
    var combinedWeight = similarity * temporal;
    return {
      campaign_id: d.campaign_id || d.id,
      campaign_name: d.campaign_name || d.name,
      name: d.campaign_name || d.name,
      start_date: d.start_date,
      end_date: d.end_date,
      spend: d.spend,
      leads: d.leads,
      impressions: d.impressions,
      cpl: d.cpl,
      days: d.days,
      prop: d.prop,
      similarity: similarity,
      temporalWeight: temporal,
      combinedWeight: combinedWeight
    };
  });

  scored.sort(function(a, b) { return b.combinedWeight - a.combinedWeight; });

  var cplValues = scored.map(function(s) { return s.cpl; });
  var weights = scored.map(function(s) { return s.combinedWeight; });

  var prediction = bayesianEstimate(cplValues, weights);
  var featureImportance = calculateFeatureImportance(inputFeatures, scored);

  var totalSpendAll = allData.reduce(function(s,d) { return s + d.spend; }, 0);
  var totalLeadsAll = allData.reduce(function(s,d) { return s + d.leads; }, 0);

  return {
    prediction: prediction,
    method: N >= 10 ? 'full_model' : N >= 5 ? 'limited_data' : 'early_stage',
    similarities: scored.slice(0, 5),
    featureImportance: featureImportance,
    N: N,
    globalAvgCPL: totalLeadsAll > 0 ? totalSpendAll / totalLeadsAll : 10
  };
}

// Legacy wrapper for backward compatibility
function predictCPLForProperty(inputPrice, inputType, inputCity, inputRating, allData) {
  var inputProp = {
    price: inputPrice || 0,
    size_sqm: 0,
    property_type: inputType || 'unknown',
    city: inputCity || '',
    location_rating: inputRating || 'C',
    rooms: null,
    plot_size: null
  };
  var result = predictCPLAdvanced(inputProp, allData);
  return {
    minCPL: result.prediction.low,
    maxCPL: result.prediction.high,
    pointEstimate: result.prediction.mean,
    globalAvgCPL: result.globalAvgCPL,
    N: result.N,
    regressionCPL: null,
    segmentAvg: null
  };
}

function findSimilarCampaigns(inputPrice, inputType, inputCity, allData) {
  var inputProp = {
    price: inputPrice || 0,
    size_sqm: 0,
    property_type: inputType || 'unknown',
    city: inputCity || '',
    location_rating: inputCity ? getCityRating(inputCity) : 'C',
    rooms: null,
    plot_size: null
  };
  var result = predictCPLAdvanced(inputProp, allData);
  return result.similarities.slice(0, 3);
}

async function predictPerformance() {
  var resultsEl = document.getElementById('pred-results');
  var inputType = document.getElementById('pred-type').value;
  var inputSize = parseFloat(document.getElementById('pred-size').value) || null;
  var inputPlot = parseFloat(document.getElementById('pred-plot').value) || null;
  var inputRooms = parseFloat(document.getElementById('pred-rooms').value) || null;
  var inputPrice = parseFloat(document.getElementById('pred-price').value) || null;
  var inputCity = document.getElementById('pred-city').value.trim();
  var inputRating = document.getElementById('pred-rating').value || (inputCity ? getCityRating(inputCity) : null);

  if (!inputPrice) {
    showToast('Bitte mindestens den Preis eingeben', 'error');
    return;
  }

  resultsEl.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

  try {
    var allData = await loadCampaignDataForPrediction();
    var N = allData.length;

    if (N === 0) {
      resultsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-title">Keine Daten</div><div class="empty-state-desc">Noch keine Kampagnen mit Leads vorhanden. Bitte zuerst Kampagnen anlegen.</div></div>';
      return;
    }

    var inputProp = {
      price: inputPrice,
      size_sqm: inputSize || 0,
      property_type: inputType,
      city: inputCity,
      location_rating: inputRating || 'C',
      rooms: inputRooms,
      plot_size: inputPlot
    };

    var result = predictCPLAdvanced(inputProp, allData);
    var pred = result.prediction;
    var score = getPerformanceScore(pred.mean, result.globalAvgCPL);

    // Color class for CPL value
    var cplColorCls = pred.mean < 8 ? 'cpl-green' : pred.mean < 12 ? 'cpl-yellow' : 'cpl-red';

    // Method badge
    var methodLabels = {
      'prior_only': { text: 'Nur Prior', cls: 'early' },
      'early_stage': { text: 'Early Stage (' + result.N + ' Kampagnen)', cls: 'early' },
      'limited_data': { text: 'Eingeschr√§nkte Daten (' + result.N + ' Kampagnen)', cls: 'limited' },
      'full_model': { text: 'Vollst√§ndiges Modell (' + result.N + ' Kampagnen)', cls: 'full' }
    };
    var methodInfo = methodLabels[result.method] || methodLabels['early_stage'];

    // A) Main Prediction Card
    var mainHtml = '<div class="prediction-section">' +
      '<div class="prediction-section-header">üîÆ Erwarteter CPL</div>' +
      '<div class="prediction-main">' +
        '<div class="pred-cpl-big ' + cplColorCls + '">' + formatEur(pred.mean) + '</div>' +
        '<div class="pred-range-text">Spanne: ' + formatEur(pred.low) + ' ‚Äì ' + formatEur(pred.high) + '</div>' +
        '<div style="margin-top:8px;">' +
          '<span style="font-size:12px;color:var(--text-muted);">Konfidenz: ' + pred.confidence + '%</span>' +
          '<div class="confidence-bar"><div class="confidence-bar-fill" style="width:' + pred.confidence + '%;"></div></div>' +
        '</div>' +
      '</div>' +
    '</div>';

    // B) Confidence Breakdown
    var breakdownHtml = '<div class="prediction-section">' +
      '<div class="prediction-section-header">üìä Datengrundlage</div>' +
      '<div class="prediction-breakdown">' +
        '<div class="pb-item"><div class="pb-label">Eigene Daten</div><div class="pb-value">' + pred.dataInfluence + '%</div></div>' +
        '<div class="pb-item"><div class="pb-label">Industry Prior</div><div class="pb-value">' + pred.priorInfluence + '%</div></div>' +
        '<div class="pb-item"><div class="pb-label">Kampagnen</div><div class="pb-value">' + result.N + '</div></div>' +
        '<div class="pb-item"><div class="pb-label">Modell</div><div class="pb-value"><span class="pred-method-badge ' + methodInfo.cls + '">' + methodInfo.text + '</span></div></div>' +
      '</div>' +
      (result.N < 10 ? '<div style="margin-top:10px;font-size:12px;color:var(--orange);">‚ö†Ô∏è Mehr Kampagnen = genauere Vorhersage</div>' : '') +
    '</div>';

    // C) Performance Score
    var scoreHtml = '<div class="prediction-section">' +
      '<div class="prediction-section-header">‚≠ê Performance-Score</div>' +
      '<div class="pred-stars" style="font-size:28px;">' + renderStars(score.stars) + '</div>' +
      '<div class="pred-score-label ' + score.cls + '" style="margin-top:6px;">' + score.label + '</div>' +
      '<div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Global √ò CPL: ' + formatEur(result.globalAvgCPL) + '</div>' +
    '</div>';

    // D) Similar Campaigns
    var similarHtml = '<div class="prediction-section">' +
      '<div class="prediction-section-header">üéØ √Ñhnlichste Kampagnen</div>';
    if (result.similarities.length > 0) {
      similarHtml += result.similarities.map(function(c, i) {
        var simPct = Math.round(c.similarity * 100);
        return '<div class="pred-similar-item">' +
          '<span class="pred-similar-name">' + (i + 1) + '. ' + escHtml(c.name) + '</span>' +
          '<span style="display:flex;align-items:center;gap:8px;">' +
            '<span class="pred-similar-detail">' + simPct + '% √§hnlich</span>' +
            '<span class="similarity-inline-bar"><span class="similarity-inline-bar-fill" style="width:' + simPct + '%;"></span></span>' +
            '<span style="font-weight:700;">CPL ' + formatEur(c.cpl) + '</span>' +
          '</span>' +
        '</div>';
      }).join('');
    } else {
      similarHtml += '<div style="font-size:13px;color:var(--text-muted);">Keine √§hnlichen Kampagnen gefunden.</div>';
    }
    similarHtml += '</div>';

    // E) Feature Importance
    var featureHtml = '<div class="prediction-section">' +
      '<div class="prediction-section-header">üß† Was beeinflusst den CPL am meisten?</div>';
    var fi = result.featureImportance;
    var fiKeys = Object.keys(fi);
    // Sort by pct descending
    fiKeys.sort(function(a, b) { return (fi[b].pct || 0) - (fi[a].pct || 0); });
    fiKeys.forEach(function(k) {
      var item = fi[k];
      featureHtml += '<div class="feature-importance-bar">' +
        '<span class="fi-label">' + escHtml(item.label) + '</span>' +
        '<span class="fi-track"><span class="fi-fill" style="width:' + Math.max(2, item.pct) + '%;"></span></span>' +
        '<span class="fi-pct">' + item.pct + '%</span>' +
      '</div>';
    });
    featureHtml += '</div>';

    // F) Creative Recommendations
    var creativeRecHtml = '<div class="prediction-section">' +
      '<div class="prediction-section-header">üé¨ Empfohlene Werbemittel</div>';
    var creativeRecs = getCreativeRecommendations(result.similarities, _predictionCreativesCache || []);
    creativeRecHtml += renderCreativeRecommendations(creativeRecs);
    creativeRecHtml += '</div>';

    // Render all
    resultsEl.innerHTML =
      '<div class="pred-result-card">' +
        '<div class="card-body">' +
          mainHtml +
          breakdownHtml +
          scoreHtml +
          similarHtml +
          featureHtml +
          creativeRecHtml +
        '</div>' +
      '</div>';

  } catch (e) {
    console.error('Prediction error:', e);
    resultsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div class="empty-state-title">Fehler</div><div class="empty-state-desc" style="color:var(--red);font-family:monospace;font-size:12px;">' + escHtml(e.message || String(e)) + '</div></div>';
  }
}

// ============================================
// PROPERTY COMPARISON
// ============================================
let _compPropertyCount = 2;

function addCompareProperty() {
  if (_compPropertyCount >= 4) {
    showToast('Maximal 4 Objekte m√∂glich', 'error');
    return;
  }
  const n = _compPropertyCount;
  const container = document.getElementById('comp-inputs');
  const card = document.createElement('div');
  card.className = 'compare-input-card';
  card.id = 'comp-card-' + n;
  card.innerHTML =
    '<button class="compare-remove-btn" onclick="removeCompareProperty(' + n + ')" title="Entfernen">‚úï</button>' +
    '<div class="compare-card-title">Objekt ' + (n + 1) + '</div>' +
    '<div class="form-group"><label class="form-label">Name</label><input class="form-input" id="comp-' + n + '-name" placeholder="Objekt ' + (n + 1) + '"></div>' +
    '<div class="form-group"><label class="form-label">Objektart</label><select class="form-select" id="comp-' + n + '-type"><option value="wohnung">Wohnung</option><option value="haus">Haus</option><option value="penthouse">Penthouse</option><option value="villa">Villa</option><option value="reihenhaus">Reihenhaus</option><option value="grundstueck">Grundst√ºck</option><option value="gewerbe">Gewerbe</option><option value="neubauprojekt">Neubauprojekt</option><option value="zweifamilienhaus">Zweifamilienhaus</option><option value="sonstige">Sonstige</option></select></div>' +
    '<div class="form-group"><label class="form-label">Wohnfl√§che (qm)</label><input class="form-input" id="comp-' + n + '-size" type="number" step="0.1"></div>' +
    '<div class="form-group"><label class="form-label">Preis (‚Ç¨)</label><input class="form-input" id="comp-' + n + '-price" type="number" step="1"></div>' +
    '<div class="form-group"><label class="form-label">Stadt</label><input class="form-input" id="comp-' + n + '-city" oninput="autoFillCityRating(\'comp-' + n + '-city\',\'comp-' + n + '-rating\')"></div>' +
    '<div class="form-group"><label class="form-label">Standort-Rating</label><select class="form-select" id="comp-' + n + '-rating"><option value="">‚Äî Auto ‚Äî</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div>';
  container.appendChild(card);
  _compPropertyCount++;
  if (_compPropertyCount >= 4) {
    document.getElementById('comp-add-btn').style.display = 'none';
  }
}

function removeCompareProperty(n) {
  const card = document.getElementById('comp-card-' + n);
  if (card) card.remove();
  if (_compPropertyCount > 2) _compPropertyCount--;
  document.getElementById('comp-add-btn').style.display = '';
}

async function compareProperties() {
  var resultsEl = document.getElementById('comp-results');
  resultsEl.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

  try {
    // Collect inputs from all visible cards
    var inputs = [];
    for (var n = 0; n < 4; n++) {
      var card = document.getElementById('comp-card-' + n);
      if (!card) continue;
      var priceEl = document.getElementById('comp-' + n + '-price');
      var price = priceEl ? parseFloat(priceEl.value) || 0 : 0;
      if (price <= 0) continue;

      var nameEl = document.getElementById('comp-' + n + '-name');
      var typeEl = document.getElementById('comp-' + n + '-type');
      var sizeEl = document.getElementById('comp-' + n + '-size');
      var cityEl = document.getElementById('comp-' + n + '-city');
      var ratingEl = document.getElementById('comp-' + n + '-rating');

      var city = cityEl ? cityEl.value.trim() : '';
      var rating = (ratingEl ? ratingEl.value : '') || (city ? getCityRating(city) : null);

      inputs.push({
        index: n,
        name: (nameEl ? nameEl.value.trim() : '') || ('Objekt ' + (n + 1)),
        type: typeEl ? typeEl.value : 'wohnung',
        size: sizeEl ? (parseFloat(sizeEl.value) || null) : null,
        price: price,
        city: city,
        rating: rating
      });
    }

    if (inputs.length < 2) {
      showToast('Bitte mindestens 2 Objekte mit Preis eingeben', 'error');
      resultsEl.innerHTML = '';
      return;
    }

    var allData = await loadCampaignDataForPrediction();
    if (allData.length === 0) {
      resultsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-title">Keine Daten</div><div class="empty-state-desc">Noch keine Kampagnen mit Leads vorhanden.</div></div>';
      return;
    }

    var propTypeLabels = {wohnung:'Wohnung',haus:'Haus',penthouse:'Penthouse',villa:'Villa',reihenhaus:'Reihenhaus',grundstueck:'Grundst√ºck',gewerbe:'Gewerbe',neubauprojekt:'Neubauprojekt',zweifamilienhaus:'Zweifamilienhaus',sonstige:'Sonstige'};

    // Predict for each property using advanced engine
    var results = inputs.map(function(inp) {
      var inputProp = {
        price: inp.price,
        size_sqm: inp.size || 0,
        property_type: inp.type,
        city: inp.city,
        location_rating: inp.rating || 'C',
        rooms: null,
        plot_size: null
      };
      var advResult = predictCPLAdvanced(inputProp, allData);
      var pred = advResult.prediction;
      var score = getPerformanceScore(pred.mean, advResult.globalAvgCPL);
      var sqmPrice = (inp.size && inp.size > 0) ? Math.round(inp.price / inp.size) : null;
      return {
        input: inp,
        advResult: advResult,
        prediction: pred,
        score: score,
        sqmPrice: sqmPrice,
        typeLabel: propTypeLabels[inp.type] || inp.type
      };
    });

    // Sort by predicted CPL (best first ‚Äî Bayesian mean)
    var ranked = results.slice().sort(function(a,b) { return a.prediction.mean - b.prediction.mean; });

    // A) Ranking
    var medals = ['ü•á', 'ü•à', 'ü•â', '4.'];
    var rankingHtml = '<div class="comp-ranking">';
    ranked.forEach(function(r, i) {
      rankingHtml += '<div class="comp-ranking-item">' +
        '<span class="comp-ranking-medal">' + medals[i] + '</span>' +
        '<span class="comp-ranking-name">' + escHtml(r.input.name) + '</span>' +
        '<span class="comp-ranking-stars pred-stars">' + renderStars(r.score.stars) + '</span>' +
        '<span class="comp-ranking-cpl">~' + formatEur(r.prediction.mean) + '</span>' +
      '</div>';
    });
    rankingHtml += '</div>';

    // Recommendation
    var best = ranked[0];
    var recHtml = '<div class="comp-recommendation">üí° Empfehlung: <strong>' + escHtml(best.input.name) + '</strong> hat das beste Performance-Potenzial (erwarteter CPL ~' + formatEur(best.prediction.mean) + ', Konfidenz: ' + best.prediction.confidence + '%)</div>';

    // B) Comparison table
    var tableHtml = '<div class="card" style="margin-bottom:24px;"><div class="card-header"><div class="card-title">Detail-Vergleich</div></div><div class="card-body" style="padding:0;overflow-x:auto;">';
    tableHtml += '<table class="comp-table"><thead><tr><th>Metrik</th>';
    results.forEach(function(r) { tableHtml += '<th>' + escHtml(r.input.name) + '</th>'; });
    tableHtml += '</tr></thead><tbody>';

    // Rows
    var rowData = [
      { label: 'Objektart', fn: function(r) { return r.typeLabel; } },
      { label: 'Preis', fn: function(r) { return formatEur(r.input.price); } },
      { label: 'qm-Preis', fn: function(r) { return r.sqmPrice ? formatEur(r.sqmPrice) : '‚Äî'; } },
      { label: 'Predicted CPL', fn: function(r) { return formatEur(r.prediction.mean); } },
      { label: 'Konfidenz', fn: function(r) { return '<div style="display:flex;align-items:center;gap:6px;"><span>' + r.prediction.confidence + '%</span><span class="similarity-inline-bar" style="width:50px;"><span class="similarity-inline-bar-fill" style="width:' + r.prediction.confidence + '%;"></span></span></div>'; } },
      { label: 'CPL Spanne', fn: function(r) { return formatEur(r.prediction.low) + ' ‚Äì ' + formatEur(r.prediction.high); } },
      { label: 'Performance-Score', fn: function(r) { return '<span class="pred-stars" style="font-size:14px;">' + renderStars(r.score.stars) + '</span> <span class="' + r.score.cls + '" style="font-size:12px;">' + r.score.label + '</span>'; } },
      { label: '√Ñhnlichste Kampagne', fn: function(r) {
        var sims = r.advResult.similarities;
        if (sims.length > 0) {
          var simPct = Math.round(sims[0].similarity * 100);
          return escHtml(sims[0].name) + ' (' + simPct + '%, CPL ' + formatEur(sims[0].cpl) + ')';
        }
        return '‚Äî';
      } },
      { label: 'Empfohlenes Creative', fn: function(r) {
        var recs = getCreativeRecommendations(r.advResult.similarities, _predictionCreativesCache || []);
        if (recs.length > 0) {
          var topLabel = getCreativeTypeLabel(recs[0].type);
          var scoreStr = recs[0].avgScore.toFixed(1);
          var cplStr = recs[0].avgCPL !== null ? formatEur(recs[0].avgCPL) : '‚Äî';
          return 'üé¨ <strong>' + escHtml(topLabel) + '</strong><br><span style="font-size:11px;color:var(--text-muted);">Score: ' + scoreStr + ' ¬∑ CPL: ' + cplStr + '</span>';
        }
        return '‚Äî';
      } }
    ];

    rowData.forEach(function(row) {
      tableHtml += '<tr><td style="font-weight:600;color:var(--text-secondary);">' + row.label + '</td>';
      results.forEach(function(r) { tableHtml += '<td>' + row.fn(r) + '</td>'; });
      tableHtml += '</tr>';
    });

    tableHtml += '</tbody></table></div></div>';

    // C) Bar Chart ‚Äî use Bayesian mean CPL values
    var chartHtml = '<div class="card"><div class="card-header"><div class="card-title">CPL-Vergleich (Bayesian Mean)</div></div><div class="card-body"><div class="comp-chart-container"><canvas id="comp-bar-chart"></canvas></div></div></div>';

    resultsEl.innerHTML = recHtml + rankingHtml + tableHtml + chartHtml;

    // Render Chart.js bar chart
    var chartCanvas = document.getElementById('comp-bar-chart');
    if (chartCanvas) {
      if (_compChartInstance) _compChartInstance.destroy();
      var ctx = chartCanvas.getContext('2d');
      var sortedForChart = results.slice().sort(function(a,b) { return a.prediction.mean - b.prediction.mean; });

      var maxCPL = Math.max.apply(null, sortedForChart.map(function(r) { return r.prediction.mean; }));
      var minCPL = Math.min.apply(null, sortedForChart.map(function(r) { return r.prediction.mean; }));
      var colors = sortedForChart.map(function(r) {
        if (maxCPL === minCPL) return 'rgba(99, 102, 241, 0.8)';
        var ratio = (r.prediction.mean - minCPL) / (maxCPL - minCPL);
        var red = Math.round(50 + ratio * 189);
        var green = Math.round(197 - ratio * 153);
        return 'rgba(' + red + ',' + green + ',50,0.8)';
      });

      _compChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedForChart.map(function(r) { return r.input.name; }),
          datasets: [{
            label: 'Erwarteter CPL (‚Ç¨)',
            data: sortedForChart.map(function(r) { return Math.round(r.prediction.mean * 100) / 100; }),
            backgroundColor: colors,
            borderColor: colors.map(function(c) { return c.replace('0.8', '1'); }),
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(tooltipCtx) { return 'CPL: ' + formatEur(tooltipCtx.raw); }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Erwarteter CPL (‚Ç¨)', color: '#8888a0' },
              ticks: { callback: function(v) { return v.toFixed(0) + ' ‚Ç¨'; } },
              grid: { color: 'rgba(38, 38, 54, 0.5)' },
              beginAtZero: true
            },
            y: {
              grid: { display: false }
            }
          }
        }
      });
    }

  } catch (e) {
    console.error('Comparison error:', e);
    resultsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div class="empty-state-title">Fehler</div><div class="empty-state-desc" style="color:var(--red);font-family:monospace;font-size:12px;">' + escHtml(e.message || String(e)) + '</div></div>';
  }
}

// ============================================
// INIT
// ============================================
async function init() {
  try {
    initDropZone();
    const ready = await checkDatabase();
    if (ready) {
      await loadClients();
      await loadCampaigns();
    }
  } catch (e) {
    console.error('Initialisierungsfehler:', e);
    document.getElementById('campaigns-loading').style.display = 'none';
    const empty = document.getElementById('campaigns-empty');
    empty.style.display = 'block';
    empty.innerHTML = `
      <div class="empty-state-icon">‚ö†Ô∏è</div>
      <div class="empty-state-title">Fehler beim Laden</div>
      <div class="empty-state-desc" style="color:var(--red);font-family:monospace;font-size:12px;">${escHtml(e.message || String(e))}</div>
    `;
  }
}

init();
</script>
</body>
</html>
